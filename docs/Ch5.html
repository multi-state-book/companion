<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Models for Multi-State Survival Data - 5&nbsp; Marginal models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Ch6.html" rel="next">
<link href="./Ch4.html" rel="prev">
<link href="./corvos.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Marginal models</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./MSBfrontbirds.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./"></a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/multi-state-book/companion" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction and data sets</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Intuition for intensity models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Intensity models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch4.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Intuition for marginal models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch5.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Marginal models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch6.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Pseudo-values</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch7.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Further topics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./errata.html" class="sidebar-item-text sidebar-link">Errata</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#pbc3-trial-in-liver-cirrhosis" id="toc-pbc3-trial-in-liver-cirrhosis" class="nav-link active" data-scroll-target="#pbc3-trial-in-liver-cirrhosis">PBC3 trial in liver cirrhosis</a>
  <ul>
  <li><a href="#read-data" id="toc-read-data" class="nav-link" data-scroll-target="#read-data">Read data</a></li>
  <li><a href="#table-5.6" id="toc-table-5.6" class="nav-link" data-scroll-target="#table-5.6">Table 5.6</a></li>
  <li><a href="#figure-5.12" id="toc-figure-5.12" class="nav-link" data-scroll-target="#figure-5.12">Figure 5.12</a></li>
  <li><a href="#figure-5.13" id="toc-figure-5.13" class="nav-link" data-scroll-target="#figure-5.13">Figure 5.13</a></li>
  <li><a href="#figure-5.14" id="toc-figure-5.14" class="nav-link" data-scroll-target="#figure-5.14">Figure 5.14</a></li>
  <li><a href="#figure-5.15" id="toc-figure-5.15" class="nav-link" data-scroll-target="#figure-5.15">Figure 5.15</a></li>
  <li><a href="#figure-5.16" id="toc-figure-5.16" class="nav-link" data-scroll-target="#figure-5.16">Figure 5.16</a></li>
  <li><a href="#figure-5.17" id="toc-figure-5.17" class="nav-link" data-scroll-target="#figure-5.17">Figure 5.17</a></li>
  </ul></li>
  <li><a href="#prova-trial-in-liver-cirrhosis" id="toc-prova-trial-in-liver-cirrhosis" class="nav-link" data-scroll-target="#prova-trial-in-liver-cirrhosis">PROVA trial in liver cirrhosis</a>
  <ul>
  <li><a href="#table-5.4" id="toc-table-5.4" class="nav-link" data-scroll-target="#table-5.4">Table 5.4</a></li>
  <li><a href="#figure-5.5" id="toc-figure-5.5" class="nav-link" data-scroll-target="#figure-5.5">Figure 5.5</a></li>
  <li><a href="#figure-5.6" id="toc-figure-5.6" class="nav-link" data-scroll-target="#figure-5.6">Figure 5.6</a></li>
  <li><a href="#figure-5.7" id="toc-figure-5.7" class="nav-link" data-scroll-target="#figure-5.7">Figure 5.7</a></li>
  <li><a href="#figure-5.8" id="toc-figure-5.8" class="nav-link" data-scroll-target="#figure-5.8">Figure 5.8</a></li>
  <li><a href="#figure-5.9" id="toc-figure-5.9" class="nav-link" data-scroll-target="#figure-5.9">Figure 5.9</a></li>
  </ul></li>
  <li><a href="#leader-cardiovascular-trial-in-type-2-diabetes" id="toc-leader-cardiovascular-trial-in-type-2-diabetes" class="nav-link" data-scroll-target="#leader-cardiovascular-trial-in-type-2-diabetes">LEADER cardiovascular trial in type 2 diabetes</a>
  <ul>
  <li><a href="#section-5.8.3-p.-213-mao-lin-models" id="toc-section-5.8.3-p.-213-mao-lin-models" class="nav-link" data-scroll-target="#section-5.8.3-p.-213-mao-lin-models">Section 5.8.3, p.&nbsp;213: Mao-Lin models</a></li>
  </ul></li>
  <li><a href="#bone-marrow-transplantation-in-acute-leukemia" id="toc-bone-marrow-transplantation-in-acute-leukemia" class="nav-link" data-scroll-target="#bone-marrow-transplantation-in-acute-leukemia">Bone marrow transplantation in acute leukemia</a>
  <ul>
  <li><a href="#read-data-1" id="toc-read-data-1" class="nav-link" data-scroll-target="#read-data-1">Read data</a></li>
  <li><a href="#table-5.1" id="toc-table-5.1" class="nav-link" data-scroll-target="#table-5.1">Table 5.1</a></li>
  <li><a href="#table-5.2" id="toc-table-5.2" class="nav-link" data-scroll-target="#table-5.2">Table 5.2</a></li>
  <li><a href="#figure-5.1" id="toc-figure-5.1" class="nav-link" data-scroll-target="#figure-5.1">Figure 5.1</a></li>
  <li><a href="#table-5.3" id="toc-table-5.3" class="nav-link" data-scroll-target="#table-5.3">Table 5.3</a></li>
  <li><a href="#figure-5.2" id="toc-figure-5.2" class="nav-link" data-scroll-target="#figure-5.2">Figure 5.2</a></li>
  <li><a href="#figure-5.3" id="toc-figure-5.3" class="nav-link" data-scroll-target="#figure-5.3">Figure 5.3</a></li>
  <li><a href="#table-5.5" id="toc-table-5.5" class="nav-link" data-scroll-target="#table-5.5">Table 5.5</a></li>
  <li><a href="#figure-5.10" id="toc-figure-5.10" class="nav-link" data-scroll-target="#figure-5.10">Figure 5.10</a></li>
  <li><a href="#figure-5.11" id="toc-figure-5.11" class="nav-link" data-scroll-target="#figure-5.11">Figure 5.11</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul>
  <li><a href="#exercise-5.1" id="toc-exercise-5.1" class="nav-link" data-scroll-target="#exercise-5.1">Exercise 5.1 (*)</a></li>
  <li><a href="#exercise-5.2" id="toc-exercise-5.2" class="nav-link" data-scroll-target="#exercise-5.2">Exercise 5.2 (*)</a></li>
  <li><a href="#exercise-5.3" id="toc-exercise-5.3" class="nav-link" data-scroll-target="#exercise-5.3">Exercise 5.3 (*)</a>
  <ul>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section">1.</a></li>
  <li><a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1">2.</a></li>
  </ul></li>
  <li><a href="#exercise-5.4" id="toc-exercise-5.4" class="nav-link" data-scroll-target="#exercise-5.4">Exercise 5.4 (*)</a></li>
  <li><a href="#exercise-5.5" id="toc-exercise-5.5" class="nav-link" data-scroll-target="#exercise-5.5">Exercise 5.5 (*)</a></li>
  <li><a href="#exercise-5.6" id="toc-exercise-5.6" class="nav-link" data-scroll-target="#exercise-5.6">Exercise 5.6</a></li>
  <li><a href="#exercise-5.7" id="toc-exercise-5.7" class="nav-link" data-scroll-target="#exercise-5.7">Exercise 5.7</a>
  <ul>
  <li><a href="#section-2" id="toc-section-2" class="nav-link" data-scroll-target="#section-2">1.</a></li>
  <li><a href="#section-3" id="toc-section-3" class="nav-link" data-scroll-target="#section-3">2.</a></li>
  <li><a href="#section-4" id="toc-section-4" class="nav-link" data-scroll-target="#section-4">3.</a></li>
  </ul></li>
  <li><a href="#exercise-5.8" id="toc-exercise-5.8" class="nav-link" data-scroll-target="#exercise-5.8">Exercise 5.8</a></li>
  <li><a href="#exercise-5.9" id="toc-exercise-5.9" class="nav-link" data-scroll-target="#exercise-5.9">Exercise 5.9</a>
  <ul>
  <li><a href="#section-5" id="toc-section-5" class="nav-link" data-scroll-target="#section-5">1.</a></li>
  <li><a href="#section-6" id="toc-section-6" class="nav-link" data-scroll-target="#section-6">2.</a></li>
  </ul></li>
  <li><a href="#exercise-5.10" id="toc-exercise-5.10" class="nav-link" data-scroll-target="#exercise-5.10">Exercise 5.10</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/multi-state-book/companion/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Marginal models</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Show/hide all code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- {{< include R/chapter5_figure_5_4.qmd >}} -->
<section id="pbc3-trial-in-liver-cirrhosis" class="level2">
<h2 class="anchored" data-anchor-id="pbc3-trial-in-liver-cirrhosis">PBC3 trial in liver cirrhosis</h2>
<section id="read-data" class="level3">
<h3 class="anchored" data-anchor-id="read-data">Read data</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell" data-hash="Ch5_cache/html/read-pbc3-r_004893fcbf76bd8aa4b1c368defdeedf">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pbc3 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/pbc3.csv"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>log2bili <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, <span class="fu">log2</span>(bili))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell" data-hash="Ch5_cache/html/read-pbc3-sas_0620e04b800f78ea0be7f09b1c812096">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> import out=pbc3</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    datafile=<span class="st">"data/pbc3.csv"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    dbms=csv <span class="kw">replace</span>;</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> pbc3; </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> pbc3;</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    log2bili=<span class="fu">log2</span>(bili);</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    years=days/<span class="dv">365.25</span>;</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-5.6" class="level3">
<h3 class="anchored" data-anchor-id="table-5.6">Table 5.6</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">SAS-NA</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell" data-hash="Ch5_cache/html/table-5.6-r_9e011b62d8189d51aaf43bd1af17b599">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>pbcny <span class="ot">&lt;-</span> <span class="fu">subset</span>(pbc3, <span class="sc">!</span><span class="fu">is.na</span>(alb))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># COLUMN 1: t0 = 2</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>dirbin2tment <span class="ot">&lt;-</span> <span class="fu">binreg</span>(<span class="fu">Event</span>(days, status) <span class="sc">~</span> tment,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> pbc3, <span class="at">cause =</span> <span class="dv">2</span>, <span class="at">time =</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">cens.code =</span> <span class="dv">0</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dirbin2tment)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 349     33

 349 clusters
coeffients:
             Estimate   Std.Err      2.5%     97.5% P-value
(Intercept) -2.209708  0.264482 -2.728083 -1.691333   0.000
tment        0.093432  0.370632 -0.632994  0.819858   0.801

exp(coeffients):
            Estimate     2.5%  97.5%
(Intercept) 0.109733 0.065344 0.1843
tment       1.097936 0.530999 2.2702</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>dirbin2 <span class="ot">&lt;-</span> <span class="fu">binreg</span>(<span class="fu">Event</span>(days, status) <span class="sc">~</span> tment <span class="sc">+</span> <span class="fu">I</span>(alb <span class="sc">-</span> <span class="dv">40</span>) <span class="sc">+</span> <span class="fu">I</span>(<span class="fu">log2</span>(bili) <span class="sc">-</span> <span class="fl">4.6</span>), </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> pbcny, <span class="at">cause =</span> <span class="dv">2</span>, <span class="at">time =</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">cens.code =</span> <span class="dv">0</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dirbin2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 343     33

 343 clusters
coeffients:
                     Estimate   Std.Err      2.5%     97.5% P-value
(Intercept)         -2.931782  0.353853 -3.625322 -2.238242  0.0000
tment               -0.462652  0.438797 -1.322677  0.397374  0.2917
I(alb - 40)         -0.147338  0.036961 -0.219780 -0.074897  0.0001
I(log2(bili) - 4.6)  0.639318  0.151149  0.343071  0.935564  0.0000

exp(coeffients):
                    Estimate     2.5%  97.5%
(Intercept)         0.053302 0.026641 0.1066
tment               0.629612 0.266421 1.4879
I(alb - 40)         0.863002 0.802695 0.9278
I(log2(bili) - 4.6) 1.895187 1.409269 2.5487</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(timereg)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># COLUMN 2: t1,t2,t3 = 1,2,3</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>timereg3 <span class="ot">&lt;-</span> <span class="fu">comp.risk</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Event</span>(days, status) <span class="sc">~</span> <span class="fu">const</span>(tment),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pbc3, <span class="at">cause =</span> <span class="dv">2</span>, <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">*</span> <span class="fl">365.25</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="st">"logistic"</span>, <span class="at">resample.iid =</span> <span class="dv">1</span>, <span class="at">n.sim =</span> <span class="dv">100</span>, <span class="at">monotone =</span> <span class="dv">1</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(timereg3)<span class="sc">$</span>coef</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Competing risks Model 

Test for nonparametric terms 

Test for non-significant effects 
            Supremum-test of significance p-value H_0: B(t)=0
(Intercept)                          8.96                   0

Test for time invariant effects 
                  Kolmogorov-Smirnov test p-value H_0:constant effect
(Intercept)                         0.505                           0
                    Cramer von Mises test p-value H_0:constant effect
(Intercept)                          94.3                           0

Parametric terms : 
               Coef.    SE Robust SE       z P-val lower2.5% upper97.5%
const(tment) -0.0304 0.323     0.323 -0.0941 0.925    -0.663      0.603
   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>timereg3 <span class="ot">&lt;-</span> <span class="fu">comp.risk</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Event</span>(days, status) <span class="sc">~</span> <span class="fu">const</span>(tment) <span class="sc">+</span> <span class="fu">const</span>(<span class="fu">I</span>(alb <span class="sc">-</span> <span class="dv">40</span>)) <span class="sc">+</span>  <span class="fu">const</span>(<span class="fu">I</span>(<span class="fu">log2</span>(bili) <span class="sc">-</span> <span class="fl">4.6</span>)),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pbcny, <span class="at">cause =</span> <span class="dv">2</span>, <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>) <span class="sc">*</span> <span class="fl">365.25</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="st">"logistic"</span>, <span class="at">resample.iid =</span> <span class="dv">1</span>, <span class="at">n.sim =</span> <span class="dv">100</span>, <span class="at">monotone =</span> <span class="dv">1</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(timereg3)<span class="sc">$</span>coef</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Competing risks Model 

Test for nonparametric terms 

Test for non-significant effects 
            Supremum-test of significance p-value H_0: B(t)=0
(Intercept)                          9.49                   0

Test for time invariant effects 
                  Kolmogorov-Smirnov test p-value H_0:constant effect
(Intercept)                         0.651                           0
                    Cramer von Mises test p-value H_0:constant effect
(Intercept)                           156                           0

Parametric terms : 
                            Coef.     SE Robust SE     z    P-val lower2.5%
const(tment)               -0.520 0.3730    0.3730 -1.39 1.63e-01    -1.250
const(I(alb - 40))         -0.125 0.0349    0.0349 -3.58 3.45e-04    -0.193
const(I(log2(bili) - 4.6))  0.579 0.1280    0.1280  4.54 5.74e-06     0.328
                           upper97.5%
const(tment)                   0.2110
const(I(alb - 40))            -0.0566
const(I(log2(bili) - 4.6))     0.8300
   </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<p>There is currently no implementation of direct binomial regression in SAS.</p>
</div>
</div>
</div>
</section>
<section id="figure-5.12" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.12">Figure 5.12</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.12-r_26828bcfd3a5932710f0b7e164c2fc44">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(timereg)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Make Cox model fit</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>years <span class="ot">&lt;-</span> pbc3<span class="sc">$</span>days<span class="sc">/</span><span class="fl">365.25</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">cox.aalen</span>(<span class="fu">Surv</span>(years, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="fu">prop</span>(tment) <span class="sc">+</span> <span class="fu">prop</span>(alb) <span class="sc">+</span> <span class="fu">prop</span>(bili),</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> pbc3, <span class="at">n.sim =</span> <span class="dv">0</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">residuals =</span> <span class="dv">1</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative martingale residuals</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">061166</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>cum_res <span class="ot">&lt;-</span> <span class="fu">cum.residuals</span>(fit, pbc3, <span class="at">cum.resid=</span><span class="dv">1</span>, <span class="at">max.point.func =</span> <span class="dv">50</span>, <span class="at">n.sim =</span> <span class="dv">1000</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>cumresdata_alb <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">alb =</span> <span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">1</span>]][,<span class="dv">1</span>]),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">cum_mg_res =</span> <span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">1</span>]][,<span class="dv">2</span>])</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>cumresdata_albsim <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">alb =</span> <span class="fu">rep</span>(<span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">1</span>]][,<span class="dv">1</span>]),<span class="at">times =</span> <span class="dv">50</span>),</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">cum_mg_res =</span> <span class="fu">c</span>(cum_res<span class="sc">$</span>sim.test.proccumz[[<span class="dv">1</span>]]),</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>,<span class="at">each =</span> <span class="fu">length</span>(<span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">1</span>]][,<span class="dv">1</span>])))</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.12</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> alb, <span class="at">y =</span> cum_mg_res), <span class="at">data =</span> cumresdata_alb) <span class="sc">+</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> alb, <span class="at">y =</span> cum_mg_res, <span class="at">group =</span> sim), </span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> cumresdata_albsim) <span class="sc">+</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Albumin"</span>) <span class="sc">+</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative martingale residuals"</span>) <span class="sc">+</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.12</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.12-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># p-value</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>cum_res<span class="sc">$</span>pval.test[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>prop(alb) 
    0.459 </code></pre>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.12-sas_b491af0b1bc53ba00fef8e635b20c0be">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ods graphis <span class="kw">on</span>; </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    class tment (ref=<span class="st">'0'</span>);</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> years*status(<span class="dv">0</span>)=tment alb bili / rl;</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    assess <span class="fu">var</span>=(alb) / resample=<span class="dv">1000</span> npaths=<span class="dv">50</span>;</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.13" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.13">Figure 5.13</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.13-r_0940e32b1d1607e335333ba8c46b674f">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Figure bili</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>cumresdata_bili <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">bili =</span> <span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">2</span>]][,<span class="dv">1</span>]),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cum_mg_res =</span> <span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">2</span>]][,<span class="dv">2</span>])</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>cumresdata_bilisim <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bili=</span> <span class="fu">rep</span>(<span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">2</span>]][,<span class="dv">1</span>]), <span class="at">times =</span> <span class="dv">50</span>),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">cum_mg_res =</span> <span class="fu">c</span>(cum_res<span class="sc">$</span>sim.test.proccumz[[<span class="dv">2</span>]]),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>,<span class="at">each =</span> <span class="fu">length</span>(<span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">2</span>]][,<span class="dv">1</span>])))</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.13</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> bili, <span class="at">y =</span> cum_mg_res), <span class="at">data =</span> cumresdata_bili) <span class="sc">+</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> bili, <span class="at">y =</span> cum_mg_res, <span class="at">group =</span> sim),</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> cumresdata_bilisim) <span class="sc">+</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Bilirubin"</span>) <span class="sc">+</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative martingale residuals"</span>) <span class="sc">+</span> </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.13</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.13-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># p-value</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>cum_res<span class="sc">$</span>pval.test[<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>prop(bili) 
         0 </code></pre>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.13-sas_5e01b44f2d17b0a0177ae69017aaca6d">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ods graphis <span class="kw">on</span>; </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    class tment (ref=<span class="st">'0'</span>);</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> years*status(<span class="dv">0</span>)=tment alb bili / rl;</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    assess <span class="fu">var</span>=(bili) / resample=<span class="dv">1000</span> npaths=<span class="dv">50</span>;</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.14" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.14">Figure 5.14</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.14-r_def8d48bbd1e9467c0a955885e094457">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make Cox model fit with log2bili</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">cox.aalen</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(years, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="fu">prop</span>(tment) <span class="sc">+</span> <span class="fu">prop</span>(alb) <span class="sc">+</span> <span class="fu">prop</span>(log2bili),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pbc3, <span class="at">n.sim =</span> <span class="dv">0</span>, <span class="at">residuals =</span> <span class="dv">1</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative martingale residuals</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">061166</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>cum_res <span class="ot">&lt;-</span> <span class="fu">cum.residuals</span>(fit2, pbc3, <span class="at">cum.resid=</span><span class="dv">1</span>, <span class="at">max.point.func =</span> <span class="dv">50</span>, <span class="at">n.sim =</span> <span class="dv">1000</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>cumresdata_log2bili <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">log2bili =</span> <span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">2</span>]][,<span class="dv">1</span>]),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">cum_mg_res =</span> <span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">2</span>]][,<span class="dv">2</span>])</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>cumresdata_log2bilisim <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">log2bili =</span> <span class="fu">rep</span>(<span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">2</span>]][,<span class="dv">1</span>]),<span class="at">times =</span> <span class="dv">50</span>),</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">cum_mg_res =</span> <span class="fu">c</span>(cum_res<span class="sc">$</span>sim.test.proccumz[[<span class="dv">2</span>]]),</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">each =</span> <span class="fu">length</span>(<span class="fu">unname</span>(cum_res<span class="sc">$</span>proc.cumz[[<span class="dv">2</span>]][,<span class="dv">1</span>])))</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.14</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> log2bili, <span class="at">y =</span> cum_mg_res), </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> cumresdata_log2bili) <span class="sc">+</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> log2bili, <span class="at">y =</span> cum_mg_res, <span class="at">group =</span> sim), </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> cumresdata_log2bilisim) <span class="sc">+</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="st">"log"</span> [<span class="dv">2</span>] <span class="sc">*</span> <span class="st">"(bilirubin)"</span>))<span class="sc">+</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative martingale residuals"</span>) <span class="sc">+</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.14</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.14-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>cum_res<span class="sc">$</span>pval.test[<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>prop(log2bili) 
         0.481 </code></pre>
</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.14-sas_6e6896e01eab123980b6f06272e8be04">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ods graphis <span class="kw">on</span>; </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    class tment (ref=<span class="st">'0'</span>);</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> years*status(<span class="dv">0</span>)=tment alb log2bili /rl;</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    assess <span class="fu">var</span>=(log2bili) / resample=<span class="dv">1000</span> npaths=<span class="dv">50</span>;</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.15" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.15">Figure 5.15</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.15-r_1483e63d8e4cdd4dfc9ec6a4c4a9f244">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute Schoenfeld residuals (standardized)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">130966</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">cox.aalen</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(years, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="fu">prop</span>(tment) <span class="sc">+</span> <span class="fu">prop</span>(alb) <span class="sc">+</span> <span class="fu">prop</span>(log2bili),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pbc3, <span class="at">n.sim =</span> <span class="dv">1000</span>, <span class="at">residuals =</span> <span class="dv">1</span>, <span class="at">weighted.test =</span> <span class="dv">1</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Cox-Aalen Model 

Test for Aalen terms 
Test not computed, sim=0 

Proportional Cox terms :  
                 Coef.     SE Robust SE D2log(L)^-1     z    P-val lower2.5%
prop(tment)    -0.5750 0.2250    0.2240      0.2240 -2.57 1.02e-02    -1.020
prop(alb)      -0.0909 0.0208    0.0211      0.0216 -4.31 1.62e-05    -0.132
prop(log2bili)  0.6650 0.0728    0.0696      0.0744  9.56 0.00e+00     0.522
               upper97.5%
prop(tment)       -0.1340
prop(alb)         -0.0501
prop(log2bili)     0.8080
Test of Proportionality 
               sup|  hat U(t) | p-value H_0 
prop(tment)                1.33        0.919
prop(alb)                  2.04        0.418
prop(log2bili)             1.89        0.568</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">#plot(fit3, score = T)</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> fit3<span class="sc">$</span>residuals<span class="sc">$</span>time</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> fit3<span class="sc">$</span>sim.test.procProp</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> fit3<span class="sc">$</span>test.procProp</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>data_tment_obs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time,<span class="at">res =</span> obs[,<span class="dv">2</span>])</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>data_tment_sim <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">res =</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, sim)[,<span class="dv">1</span>],</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>                             <span class="at">time =</span> <span class="fu">rep</span>(time, <span class="at">times =</span> <span class="dv">50</span>), </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>                             <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">each =</span> <span class="fu">length</span>(time)))</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.15</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res), <span class="at">data =</span> data_tment_obs) <span class="sc">+</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res, <span class="at">group =</span> sim), </span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> data_tment_sim) <span class="sc">+</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="st">"Time since randomization (years)"</span>))<span class="sc">+</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Standardized score process"</span>) <span class="sc">+</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.15</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.15-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>fit3<span class="sc">$</span>pval.Prop[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>prop(tment) 
      0.919 </code></pre>
</div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.15-sas_8d55ecef25fa7c625ca60bd8bbe53896">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>pods graphis <span class="kw">on</span>; </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    class tment (ref=<span class="st">'0'</span>);</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> years*status(<span class="dv">0</span>)=tment alb log2bili /rl;</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    assess ph / resample=<span class="dv">1000</span> npaths=<span class="dv">50</span>;</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.16" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.16">Figure 5.16</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" role="tab" aria-controls="tabset-7-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" role="tab" aria-controls="tabset-7-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-7-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-7-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.16-r_34ba78cbfa8eb3acb097c1c6f5a35158">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same but for albumin</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>data_alb_obs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time, </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">res =</span> obs[,<span class="dv">3</span>])</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>data_alb_sim <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">res =</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, sim)[,<span class="dv">2</span>],</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">time =</span> <span class="fu">rep</span>(time, <span class="at">times =</span> <span class="dv">50</span>), </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">each =</span> <span class="fu">length</span>(time)))</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.16</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res), <span class="at">data =</span> data_alb_obs) <span class="sc">+</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res, <span class="at">group =</span> sim), </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> data_alb_sim) <span class="sc">+</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="st">"Time since randomization (years)"</span>))<span class="sc">+</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Standardized score process"</span>) <span class="sc">+</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.16-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>fit3<span class="sc">$</span>pval.Prop[<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>prop(alb) 
    0.418 </code></pre>
</div>
</div>
</div>
<div id="tabset-7-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-7-2-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.16-sas_e327750dd58ab11cfc9962fd1cec3551">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>ods graphis <span class="kw">on</span>; </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    class tment (ref=<span class="st">'0'</span>);</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> years*status(<span class="dv">0</span>)=tment alb log2bili /rl;</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    assess ph / resample=<span class="dv">1000</span> npaths=<span class="dv">50</span>;</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.17" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.17">Figure 5.17</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-8-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-1" role="tab" aria-controls="tabset-8-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-2" role="tab" aria-controls="tabset-8-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-8-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-8-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.17-r_9dc7fa0cd1c03ca940edfd14605e3e47">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same but for log2bili</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>data_log2bili_obs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time, </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">res =</span> obs[,<span class="dv">4</span>])</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>data_log2bili_sim <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">res =</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, sim)[,<span class="dv">3</span>],</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                                <span class="at">time =</span> <span class="fu">rep</span>(time, <span class="at">times =</span> <span class="dv">50</span>), </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                                <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">each =</span> <span class="fu">length</span>(time)))</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.17</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res), <span class="at">data =</span> data_log2bili_obs) <span class="sc">+</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res, <span class="at">group =</span> sim), </span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> data_log2bili_sim) <span class="sc">+</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="st">"Time since randomization (years)"</span>))<span class="sc">+</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Standardized score process"</span>) <span class="sc">+</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.03</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.17</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.17-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fit3<span class="sc">$</span>pval.Prop[<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>prop(log2bili) 
         0.568 </code></pre>
</div>
</div>
</div>
<div id="tabset-8-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-2-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.17-sas_8d37d85dd7c9895e87bd53a8b377d4b9">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>ods graphis <span class="kw">on</span>; </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    class tment (ref=<span class="st">'0'</span>);</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> years*status(<span class="dv">0</span>)=tment alb log2bili /rl;</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    assess ph / resample=<span class="dv">1000</span> npaths=<span class="dv">50</span>;</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="prova-trial-in-liver-cirrhosis" class="level2">
<h2 class="anchored" data-anchor-id="prova-trial-in-liver-cirrhosis">PROVA trial in liver cirrhosis</h2>
<!-- using Eva's saved data in temp for speed -->
<p>Only R code available.</p>
<section id="table-5.4" class="level3">
<h3 class="anchored" data-anchor-id="table-5.4">Table 5.4</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-9-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-1" role="tab" aria-controls="tabset-9-1" aria-selected="true">R</a></li></ul>
<div class="tab-content">
<div id="tabset-9-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-9-1-tab">
<div class="cell" data-hash="Ch5_cache/html/table-5.4-r_476f806689ab5b76bf85cf7117921e76">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival) <span class="co">#Cox models, Kaplan-Meier, ect. </span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co">#Plots</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table) <span class="co">#Faster aggregation of data</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Epi) <span class="co">#Lexis</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra) <span class="co">#Combine multiple plots </span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr) <span class="co">#Multiple plots, ggarrange</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mstate) <span class="co">#probtrans, LMAJ, ELOS</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xtable)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(timereg)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co"># read prova data</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>prova <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/prova.csv"</span>, <span class="at">na.strings =</span> <span class="fu">c</span>(<span class="st">"."</span>))</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>prova <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(prova)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>prova <span class="ot">&lt;-</span> prova <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">timebleed =</span> <span class="fu">ifelse</span>(bleed <span class="sc">==</span> <span class="dv">1</span>, timebleed, timedeath),</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">outof0 =</span> <span class="fu">ifelse</span>(bleed <span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span>, death),</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>                          <span class="at">wait =</span> <span class="fu">ifelse</span>(bleed <span class="sc">==</span><span class="dv">1</span>, timedeath <span class="sc">-</span> timebleed, <span class="cn">NA</span>))</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>prova <span class="ot">&lt;-</span> <span class="fu">setDT</span>(prova)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting start times, s = 1 year and s = 2 years</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>s1 <span class="ot">=</span> <span class="fl">365.25</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>s2 <span class="ot">=</span> <span class="dv">2</span><span class="sc">*</span><span class="fl">365.25</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="co">#Censoring times</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>cens_outof0 <span class="ot">&lt;-</span> <span class="dv">1509</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>cens_wait <span class="ot">&lt;-</span> <span class="dv">1363</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="co"># AALEN-JOHANSEN ESTIMATOR #####################################################</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Transition matrix for irreversible illness-death model</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>tmat <span class="ot">&lt;-</span> <span class="fu">trans.illdeath</span>(<span class="at">names =</span> <span class="fu">c</span>(<span class="st">"Non-bleeding"</span>, <span class="st">"Bleeding"</span>, <span class="st">"Dead"</span>))</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Converting data to long format</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>long_format <span class="ot">&lt;-</span> <span class="fu">msprep</span>(<span class="at">time =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="st">"timebleed"</span>, <span class="st">"timedeath"</span>),<span class="at">status =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="st">"bleed"</span>, <span class="st">"death"</span>), <span class="at">data =</span> <span class="fu">as.data.frame</span>(prova), <span class="at">trans =</span> tmat)</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Tstart,Tstop,status) <span class="sc">~</span> <span class="fu">strata</span>(trans), <span class="at">data =</span>long_format, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative transition hazards </span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>msfit <span class="ot">&lt;-</span> <span class="fu">msfit</span>(cox, <span class="at">trans =</span> tmat)</span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a><span class="co">#Expected length of stay in state 1, \epsilon_1(\tau) = \int_0^{\tau} P_01(0,t)dt</span></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>AaJ_ELOS_function <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> <span class="fu">ELOS</span>(<span class="at">pt =</span><span class="fu">probtrans</span>(msfit, <span class="at">predt =</span> <span class="dv">0</span>), t)</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mat[<span class="dv">1</span>,<span class="dv">2</span>])}</span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a><span class="co"># MICROSIMULATION WITHOUT COVARIATES ###########################################</span></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a><span class="co">#Setting up data with Epi packages</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a><span class="co">#One time  scale: tsr (time since randomization), two states: No bleeding - dead</span></span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>Lexis2state <span class="ot">&lt;-</span>  <span class="fu">Lexis</span>(<span class="at">exit =</span> <span class="fu">list</span>(<span class="at">tsr =</span> timedeath),<span class="at">exit.status =</span> <span class="fu">factor</span>(death, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"NoBleeding"</span>, <span class="st">"Dead"</span>)) , <span class="at">data =</span> prova)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>NOTE: entry.status has been set to "NoBleeding" for all.
NOTE: entry is assumed to be 0 on the tsr timescale.</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Adding bleeding state and new time scale: tsb (time since bleeding).</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>LexisProva <span class="ot">&lt;-</span> <span class="fu">cutLexis</span>(Lexis2state, <span class="at">cut =</span> Lexis2state<span class="sc">$</span>timebleed, <span class="at">precursor.states =</span> <span class="st">"NoBleeding"</span>, <span class="at">new.state =</span> <span class="st">"Bleeding"</span>, <span class="at">new.scale =</span> <span class="st">"tsb"</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Splitting state 2 into 0-&gt;2 and 1-&gt;2</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>LexisProva <span class="ot">&lt;-</span> <span class="fu">cutLexis</span>(Lexis2state, <span class="at">cut =</span> Lexis2state<span class="sc">$</span>timebleed, <span class="at">precursor.states =</span> <span class="st">"NoBleeding"</span>, <span class="at">new.state =</span> <span class="st">"Bleeding"</span>, <span class="at">new.scale =</span> <span class="st">"tsb"</span>, <span class="at">split.states =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 -&gt; 1 (time since randomization as time scale)</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>nk_bleed <span class="ot">&lt;-</span> <span class="dv">17</span> <span class="co">#Number of intervals, corresponds to 2-3 events in each interval</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>intervals01 <span class="ot">&lt;-</span> <span class="fu">with</span>( <span class="fu">subset</span>(LexisProva,lex.Xst<span class="sc">==</span><span class="st">"Bleeding"</span> <span class="sc">&amp;</span> lex.Cst <span class="sc">==</span><span class="st">"NoBleeding"</span>),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">quantile</span>(tsr <span class="sc">+</span>lex.dur, <span class="at">probs=</span>(<span class="dv">1</span><span class="sc">:</span>(nk_bleed<span class="dv">-1</span>))<span class="sc">/</span>nk_bleed ) )) </span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>SplitLexis01 <span class="ot">&lt;-</span> <span class="fu">splitLexis</span>(<span class="at">lex =</span> LexisProva, <span class="at">time.scale =</span> <span class="st">"tsr"</span>, <span class="at">breaks =</span> intervals01)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co">#Adding intervals as columns to data</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>SplitLexis01<span class="sc">$</span>tsr.cat <span class="ot">&lt;-</span> <span class="fu">timeBand</span>(SplitLexis01, <span class="st">"tsr"</span>, <span class="at">type =</span> <span class="st">"factor"</span>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Adding status of 0-&gt;1 transitions</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>SplitLexis01<span class="sc">$</span>case.bleed <span class="ot">&lt;-</span> <span class="fu">status</span>(SplitLexis01) <span class="sc">==</span> <span class="st">"Bleeding"</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Person years at risk</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>SplitLexis01<span class="sc">$</span>pyar <span class="ot">&lt;-</span> <span class="fu">dur</span>(SplitLexis01) </span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="co">#Poisson model for alpha01</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>poisson01 <span class="ot">&lt;-</span> <span class="fu">glm</span>(case.bleed <span class="sc">~</span> tsr.cat <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(pyar)) , <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> <span class="fu">subset</span>(SplitLexis01, lex.Cst <span class="sc">==</span> <span class="st">"NoBleeding"</span>))</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 0 -&gt; 2 (time since randomization as time scale)</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>nk_dead0 <span class="ot">&lt;-</span> <span class="dv">16</span> <span class="co">#Number of intervals, corresponds to 2-3 events in each interval</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>intervals02 <span class="ot">&lt;-</span> <span class="fu">with</span>( <span class="fu">subset</span>(LexisProva,lex.Xst<span class="sc">==</span><span class="st">"Dead"</span>),</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">quantile</span>(tsr <span class="sc">+</span>lex.dur, <span class="at">probs=</span>(<span class="dv">1</span><span class="sc">:</span>(nk_dead0<span class="dv">-1</span>))<span class="sc">/</span>nk_dead0 ) )) </span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>SplitLexis02 <span class="ot">&lt;-</span> <span class="fu">splitLexis</span>(<span class="at">lex =</span> LexisProva, <span class="at">time.scale =</span> <span class="st">"tsr"</span>, <span class="at">breaks =</span> intervals02)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="co">#Adding intervals as columns to data</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>SplitLexis02<span class="sc">$</span>tsr.cat <span class="ot">&lt;-</span> <span class="fu">timeBand</span>(SplitLexis02, <span class="st">"tsr"</span>, <span class="at">type =</span> <span class="st">"factor"</span>)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a><span class="co">#Adding status of 0-&gt;2 transitions</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>SplitLexis02<span class="sc">$</span>case.dead <span class="ot">&lt;-</span> <span class="fu">status</span>(SplitLexis02) <span class="sc">==</span> <span class="st">"Dead"</span></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="co">#Person years at risk</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>SplitLexis02<span class="sc">$</span>pyar <span class="ot">&lt;-</span> <span class="fu">dur</span>(SplitLexis02) </span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="co">#Poisson model for alpha02</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>poisson02 <span class="ot">&lt;-</span> <span class="fu">glm</span>(case.dead <span class="sc">~</span> tsr.cat <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(pyar)) , <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> <span class="fu">subset</span>(SplitLexis02, lex.Cst <span class="sc">==</span> <span class="st">"NoBleeding"</span>))</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 -&gt; 2 (duration in state 1 as time scale)</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>nk_deadb <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co">#Number of intervals, corresponds to 2-3 events in each interval</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>intervals12 <span class="ot">&lt;-</span> <span class="fu">with</span>(<span class="fu">subset</span>(LexisProva,lex.Xst<span class="sc">==</span><span class="st">"Dead(Bleeding)"</span>),</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">quantile</span>(tsb <span class="sc">+</span> lex.dur, <span class="at">probs=</span>(<span class="dv">1</span><span class="sc">:</span>(nk_deadb<span class="dv">-1</span>))<span class="sc">/</span>nk_deadb ) )) </span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>SplitLexis12 <span class="ot">&lt;-</span> <span class="fu">splitLexis</span>(<span class="at">lex =</span> <span class="fu">subset</span>(LexisProva, lex.Cst <span class="sc">==</span> <span class="st">"Bleeding"</span>), <span class="at">time.scale =</span> <span class="st">"tsb"</span>, <span class="at">breaks =</span> intervals12)</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a><span class="co">#Adding intervals as columns to data</span></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>SplitLexis12<span class="sc">$</span>tsb.cat <span class="ot">&lt;-</span> <span class="fu">timeBand</span>(SplitLexis12, <span class="st">"tsb"</span>, <span class="at">type =</span> <span class="st">"factor"</span>)</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding status of 1-&gt;2 transitions</span></span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>SplitLexis12<span class="sc">$</span>case.deadb <span class="ot">&lt;-</span> <span class="fu">status</span>(SplitLexis12) <span class="sc">==</span> <span class="st">"Dead(Bleeding)"</span></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a><span class="co">#Person years at risk</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>SplitLexis12<span class="sc">$</span>pyar <span class="ot">&lt;-</span> <span class="fu">dur</span>(SplitLexis12) </span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a><span class="co">#Poisson model for alpha12</span></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>poisson12 <span class="ot">&lt;-</span> <span class="fu">glm</span>(case.deadb <span class="sc">~</span> tsb.cat <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(pyar)) , <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> <span class="fu">subset</span>(SplitLexis12, lex.Cst <span class="sc">==</span> <span class="st">"Bleeding"</span>))</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a><span class="co">#Cumulative hazard function, A01(t) = \int_0^t alpha01(u)du based on Poisson model, model01</span></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a><span class="co">#Time since randomization as time axis</span></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>cumhaz01 <span class="ot">&lt;-</span> <span class="cf">function</span>(model01,t){</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>  times <span class="ot">&lt;-</span> intervals01[intervals01 <span class="sc">&lt;</span> t] <span class="co">#time intervals up to time t where A01 is constant</span></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(times)</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">&lt;=</span> <span class="dv">1</span>){ <span class="co">#If 0 or 1 interval</span></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>    chz <span class="ot">&lt;-</span> <span class="fu">exp</span>(model01[<span class="dv">1</span>])<span class="sc">*</span>t}</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{ <span class="co">#If 2 or more intervals</span></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>    length_int <span class="ot">&lt;-</span> <span class="fu">diff</span>(times) <span class="co">#length of intervals</span></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>    chz <span class="ot">&lt;-</span> <span class="fu">sum</span>(length_int<span class="sc">*</span><span class="fu">exp</span>(model01[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)])) <span class="sc">+</span> <span class="fu">exp</span>(model01[n])<span class="sc">*</span>(t <span class="sc">-</span> <span class="fu">sum</span>(length_int))} <span class="co">#sum(alpha01*len_int)</span></span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.numeric</span>(chz))}</span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a><span class="co">#Cumulative hazard function, A02(t) = \int_0^t alpha02(u)du based on Poisson model, model02</span></span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a><span class="co">#Time since randomization as time axis</span></span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a>cumhaz02 <span class="ot">&lt;-</span> <span class="cf">function</span>(model02, t){</span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a>  times <span class="ot">&lt;-</span> intervals02[intervals02 <span class="sc">&lt;</span> t] <span class="co">#time intervals up to time t where A02 is constant</span></span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(times)</span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">&lt;=</span> <span class="dv">1</span>){ <span class="co">#If 0 or 1 interval</span></span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>    chz <span class="ot">&lt;-</span> <span class="fu">exp</span>(model02[<span class="dv">1</span>])<span class="sc">*</span>t}</span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{ <span class="co">#If 2 or more intervals</span></span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a>    length_int <span class="ot">&lt;-</span> <span class="fu">diff</span>(times) <span class="co">#Length of intervals</span></span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a>    chz <span class="ot">&lt;-</span> <span class="fu">sum</span>(length_int<span class="sc">*</span><span class="fu">exp</span>(model02[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)])) <span class="sc">+</span> <span class="fu">exp</span>(model02[n])<span class="sc">*</span>(t <span class="sc">-</span> <span class="fu">sum</span>(length_int))}  <span class="co">#sum(alpha02*len_int)</span></span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.numeric</span>(chz))}</span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a><span class="co">#Cumulative hazard function, A12(t) = \int_0^t alpha12(u)du based on Poisson model, model12,</span></span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a><span class="co">#Duration in state 1 as time axis</span></span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>cumhaz12 <span class="ot">&lt;-</span> <span class="cf">function</span>(model12, t){</span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a>  times <span class="ot">&lt;-</span> intervals12[intervals12 <span class="sc">&lt;</span> t] <span class="co">#time intervals up to time t where A12 is constant</span></span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(times)</span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">&lt;=</span> <span class="dv">1</span>){ <span class="co">#If 0 or 1 interval</span></span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true" tabindex="-1"></a>    chz <span class="ot">&lt;-</span> <span class="fu">exp</span>(model12[<span class="dv">1</span>])<span class="sc">*</span>t}</span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{ <span class="co">#If 2 or more intervals</span></span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true" tabindex="-1"></a>    length_int <span class="ot">&lt;-</span> <span class="fu">diff</span>(times) <span class="co">#Length of intervals</span></span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true" tabindex="-1"></a>    chz <span class="ot">&lt;-</span> <span class="fu">sum</span>(length_int<span class="sc">*</span><span class="fu">exp</span>(model12[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)])) <span class="sc">+</span> <span class="fu">exp</span>(model12[n])<span class="sc">*</span>(t <span class="sc">-</span> <span class="fu">sum</span>(length_int))} <span class="co">#sum(alpha12*len_int)</span></span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.numeric</span>(chz))}</span>
<span id="cb41-89"><a href="#cb41-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-90"><a href="#cb41-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimates and covariance matrix for alpha01 </span></span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true" tabindex="-1"></a>beta01 <span class="ot">&lt;-</span> <span class="fu">summary</span>(poisson01)<span class="sc">$</span>coefficients[,<span class="dv">1</span>]</span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true" tabindex="-1"></a>sigma01 <span class="ot">&lt;-</span> <span class="fu">vcov</span>(poisson01)</span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimates and covariance matrix for alpha02 </span></span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true" tabindex="-1"></a>beta02 <span class="ot">&lt;-</span> <span class="fu">summary</span>(poisson02)<span class="sc">$</span>coefficients[,<span class="dv">1</span>]</span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true" tabindex="-1"></a>sigma02 <span class="ot">&lt;-</span> <span class="fu">vcov</span>(poisson02)</span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimates and covariance matrix for alpha12 </span></span>
<span id="cb41-100"><a href="#cb41-100" aria-hidden="true" tabindex="-1"></a>beta12 <span class="ot">&lt;-</span> <span class="fu">summary</span>(poisson12)<span class="sc">$</span>coefficients[,<span class="dv">1</span>]</span>
<span id="cb41-101"><a href="#cb41-101" aria-hidden="true" tabindex="-1"></a>sigma12 <span class="ot">&lt;-</span> <span class="fu">vcov</span>(poisson12)</span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true" tabindex="-1"></a><span class="co">#Time intervals for 0-&gt;1 and 0-&gt;2 transitions (censoring at 1509 days)</span></span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true" tabindex="-1"></a>time0h_int <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(intervals01, intervals02, cens_outof0))</span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true" tabindex="-1"></a><span class="co">#Time intervals for 1-&gt;2 transitions (censoring duration in state 1 after 1363)</span></span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true" tabindex="-1"></a>time12_int <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(intervals12, cens_wait))</span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Microsimulation function. 'N' is number of subjects to simulate, 'seed' is</span></span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true" tabindex="-1"></a><span class="co"># random seed and # if 'sample = TRUE' new parameters for the Poisson models </span></span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true" tabindex="-1"></a><span class="co"># are drawn from  multivariate normal distributions</span></span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true" tabindex="-1"></a>microsim_fct <span class="ot">&lt;-</span> <span class="cf">function</span>(N, seed, <span class="at">sample =</span> <span class="cn">FALSE</span>){</span>
<span id="cb41-113"><a href="#cb41-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed) <span class="co">#Setting the random seed </span></span>
<span id="cb41-114"><a href="#cb41-114" aria-hidden="true" tabindex="-1"></a>  glm01 <span class="ot">&lt;-</span> beta01 <span class="co">#Original alpha01 hazard</span></span>
<span id="cb41-115"><a href="#cb41-115" aria-hidden="true" tabindex="-1"></a>  glm02 <span class="ot">&lt;-</span> beta02 <span class="co">#Original alpha02 hazard</span></span>
<span id="cb41-116"><a href="#cb41-116" aria-hidden="true" tabindex="-1"></a>  glm12 <span class="ot">&lt;-</span> beta12 <span class="co">#Original alpha12 hazard</span></span>
<span id="cb41-117"><a href="#cb41-117" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Drawing new parameter values</span></span>
<span id="cb41-118"><a href="#cb41-118" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sample <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb41-119"><a href="#cb41-119" aria-hidden="true" tabindex="-1"></a>    glm01 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> beta01, <span class="at">Sigma =</span> sigma01))</span>
<span id="cb41-120"><a href="#cb41-120" aria-hidden="true" tabindex="-1"></a>    glm02 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> beta02, <span class="at">Sigma =</span> sigma02))</span>
<span id="cb41-121"><a href="#cb41-121" aria-hidden="true" tabindex="-1"></a>    glm12 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> beta12, <span class="at">Sigma =</span> sigma12))}</span>
<span id="cb41-122"><a href="#cb41-122" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Setting up the hazard functions</span></span>
<span id="cb41-123"><a href="#cb41-123" aria-hidden="true" tabindex="-1"></a>  ch01 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time0h_int, cumhaz01, <span class="at">model01 =</span> glm01) <span class="co">#A01 for Poisson model with parameter values glm01</span></span>
<span id="cb41-124"><a href="#cb41-124" aria-hidden="true" tabindex="-1"></a>  ch02 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time0h_int, cumhaz02, <span class="at">model02 =</span> glm02) <span class="co">#A02 for Poisson model with parameter values glm02</span></span>
<span id="cb41-125"><a href="#cb41-125" aria-hidden="true" tabindex="-1"></a>  cum0h_inv <span class="ot">&lt;-</span> <span class="fu">approxfun</span>(time0h_int <span class="sc">~</span> (ch01 <span class="sc">+</span> ch02)) <span class="co">#Inverse function of A01 + A02</span></span>
<span id="cb41-126"><a href="#cb41-126" aria-hidden="true" tabindex="-1"></a>  ch12 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time12_int, cumhaz12, <span class="at">model12 =</span> glm12) <span class="co">#A12(t) for model with parameter values glm12</span></span>
<span id="cb41-127"><a href="#cb41-127" aria-hidden="true" tabindex="-1"></a>  cum12_inv <span class="ot">&lt;-</span> <span class="fu">approxfun</span>(time12_int <span class="sc">~</span> ch12) <span class="co">#Inverse function of A12</span></span>
<span id="cb41-128"><a href="#cb41-128" aria-hidden="true" tabindex="-1"></a>  alpha01 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){<span class="fu">as.numeric</span>(<span class="fu">exp</span>(glm01[<span class="fu">length</span>(intervals01[intervals01 <span class="sc">&lt;</span> t])]))} <span class="co">#alpha01 for Poisson model with parameter values glm01 </span></span>
<span id="cb41-129"><a href="#cb41-129" aria-hidden="true" tabindex="-1"></a>  alpha02 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){<span class="fu">as.numeric</span>(<span class="fu">exp</span>(glm02[<span class="fu">length</span>(intervals02[intervals02 <span class="sc">&lt;</span> t])]))} <span class="co">#alpha02 for Poisson model with parameter values glm02</span></span>
<span id="cb41-130"><a href="#cb41-130" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Initializing the data frame </span></span>
<span id="cb41-131"><a href="#cb41-131" aria-hidden="true" tabindex="-1"></a>  sim_prova <span class="ot">&lt;-</span>  prova[<span class="dv">1</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>]</span>
<span id="cb41-132"><a href="#cb41-132" aria-hidden="true" tabindex="-1"></a>  sim_prova[<span class="dv">1</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb41-133"><a href="#cb41-133" aria-hidden="true" tabindex="-1"></a>  sim_prova <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(sim_prova, id, bleed,death, outof0, timebleed, timedeath, wait)</span>
<span id="cb41-134"><a href="#cb41-134" aria-hidden="true" tabindex="-1"></a>  sim_prova <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, <span class="fu">replicate</span>(N, sim_prova, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb41-135"><a href="#cb41-135" aria-hidden="true" tabindex="-1"></a>  sim_prova<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>N</span>
<span id="cb41-136"><a href="#cb41-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(sim_prova) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>,<span class="st">"bleed"</span>,<span class="st">"death"</span>, <span class="st">"cens"</span>, <span class="st">"time0h"</span>, <span class="st">"time12"</span>, <span class="st">"dur1"</span>)</span>
<span id="cb41-137"><a href="#cb41-137" aria-hidden="true" tabindex="-1"></a>  <span class="co">#The actual simulation</span></span>
<span id="cb41-138"><a href="#cb41-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb41-139"><a href="#cb41-139" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1</span>,<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span><span class="dv">1</span>)) <span class="co">#-log(S(t))</span></span>
<span id="cb41-140"><a href="#cb41-140" aria-hidden="true" tabindex="-1"></a>    sim_prova<span class="sc">$</span>time0h[i] <span class="ot">&lt;-</span> <span class="fu">cum0h_inv</span>(u) <span class="co">#t, time of transition out of state 0 for subject i</span></span>
<span id="cb41-141"><a href="#cb41-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(sim_prova<span class="sc">$</span>time0h[i])){ <span class="co">#In case time0h &gt; 4.13 (censoring time)</span></span>
<span id="cb41-142"><a href="#cb41-142" aria-hidden="true" tabindex="-1"></a>      sim_prova<span class="sc">$</span>time0h[i] <span class="ot">&lt;-</span> cens_outof0</span>
<span id="cb41-143"><a href="#cb41-143" aria-hidden="true" tabindex="-1"></a>      sim_prova<span class="sc">$</span>cens[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb41-144"><a href="#cb41-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb41-145"><a href="#cb41-145" aria-hidden="true" tabindex="-1"></a>      hazard01 <span class="ot">&lt;-</span> <span class="fu">alpha01</span>(<span class="fu">cum0h_inv</span>(u)) <span class="co">#alpha01(t)</span></span>
<span id="cb41-146"><a href="#cb41-146" aria-hidden="true" tabindex="-1"></a>      hazard02 <span class="ot">&lt;-</span> <span class="fu">alpha02</span>(<span class="fu">cum0h_inv</span>(u)) <span class="co">#alpha02(t)</span></span>
<span id="cb41-147"><a href="#cb41-147" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (hazard02<span class="sc">/</span>(hazard01 <span class="sc">+</span> hazard02) <span class="sc">&gt;=</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)) <span class="co">#Choosing 0-&gt;2 with probability alpha_02(t)/(alpha_01(t) + alpha_02(t))</span></span>
<span id="cb41-148"><a href="#cb41-148" aria-hidden="true" tabindex="-1"></a>      {sim_prova<span class="sc">$</span>death[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb41-149"><a href="#cb41-149" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{</span>
<span id="cb41-150"><a href="#cb41-150" aria-hidden="true" tabindex="-1"></a>        sim_prova<span class="sc">$</span>bleed[i] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb41-151"><a href="#cb41-151" aria-hidden="true" tabindex="-1"></a>        u2 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">runif</span>(<span class="at">n =</span><span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)) <span class="co">#-log(S(t))</span></span>
<span id="cb41-152"><a href="#cb41-152" aria-hidden="true" tabindex="-1"></a>        sim_prova<span class="sc">$</span>dur1[i] <span class="ot">&lt;-</span> <span class="fu">cum12_inv</span>(u2) <span class="co">#t2, length of stay in state 1 for subject i.</span></span>
<span id="cb41-153"><a href="#cb41-153" aria-hidden="true" tabindex="-1"></a>        sim_prova<span class="sc">$</span>time12[i] <span class="ot">&lt;-</span> sim_prova<span class="sc">$</span>dur1[i] <span class="sc">+</span>sim_prova<span class="sc">$</span>time0h[i] <span class="co">#time of 1-&gt;2 (since randomization)</span></span>
<span id="cb41-154"><a href="#cb41-154" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.na</span>(sim_prova<span class="sc">$</span>dur1[i])){ <span class="co">#If duration in state 1 &gt; 3.73 (censoring time)</span></span>
<span id="cb41-155"><a href="#cb41-155" aria-hidden="true" tabindex="-1"></a>          sim_prova<span class="sc">$</span>dur1[i] <span class="ot">&lt;-</span> cens_wait</span>
<span id="cb41-156"><a href="#cb41-156" aria-hidden="true" tabindex="-1"></a>          sim_prova<span class="sc">$</span>time12[i] <span class="ot">&lt;-</span> <span class="fu">min</span>((sim_prova<span class="sc">$</span>time0h[i] <span class="sc">+</span> cens_wait), cens_outof0) <span class="co">#If time12 &gt; 4.13, time12 = 4.13 (censoring)</span></span>
<span id="cb41-157"><a href="#cb41-157" aria-hidden="true" tabindex="-1"></a>          sim_prova<span class="sc">$</span>cens[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb41-158"><a href="#cb41-158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{ </span>
<span id="cb41-159"><a href="#cb41-159" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (sim_prova<span class="sc">$</span>time12[i] <span class="sc">&gt;</span> cens_outof0){</span>
<span id="cb41-160"><a href="#cb41-160" aria-hidden="true" tabindex="-1"></a>            sim_prova<span class="sc">$</span>time12[i] <span class="ot">&lt;-</span> cens_outof0 <span class="co">#Censoring if time12 &gt; 4.13</span></span>
<span id="cb41-161"><a href="#cb41-161" aria-hidden="true" tabindex="-1"></a>            sim_prova<span class="sc">$</span>cens[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb41-162"><a href="#cb41-162" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>{</span>
<span id="cb41-163"><a href="#cb41-163" aria-hidden="true" tabindex="-1"></a>            sim_prova<span class="sc">$</span>death[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}}}}}</span>
<span id="cb41-164"><a href="#cb41-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sim_prova)}</span>
<span id="cb41-165"><a href="#cb41-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-166"><a href="#cb41-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-167"><a href="#cb41-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Double generation procedure for variance estimate of Q1(t) (described in section 5.4).</span></span>
<span id="cb41-168"><a href="#cb41-168" aria-hidden="true" tabindex="-1"></a>Q1_sd <span class="ot">&lt;-</span> <span class="cf">function</span>(N,B,t, <span class="at">sd =</span> <span class="cn">FALSE</span>){ <span class="co">#Default is to return variance, not SD estimate</span></span>
<span id="cb41-169"><a href="#cb41-169" aria-hidden="true" tabindex="-1"></a>  Q1b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="at">nrow =</span>B, <span class="at">ncol =</span> <span class="fu">length</span>(t))</span>
<span id="cb41-170"><a href="#cb41-170" aria-hidden="true" tabindex="-1"></a>  SD1b <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,<span class="at">nrow =</span>B, <span class="at">ncol =</span> <span class="fu">length</span>(t))</span>
<span id="cb41-171"><a href="#cb41-171" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="fu">length</span>(t))</span>
<span id="cb41-172"><a href="#cb41-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(res) <span class="ot">&lt;-</span> t</span>
<span id="cb41-173"><a href="#cb41-173" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb41-174"><a href="#cb41-174" aria-hidden="true" tabindex="-1"></a>    sim <span class="ot">&lt;-</span> <span class="fu">microsim_fct</span>(N,i, <span class="at">sample =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-175"><a href="#cb41-175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(t)){</span>
<span id="cb41-176"><a href="#cb41-176" aria-hidden="true" tabindex="-1"></a>      Y1 <span class="ot">&lt;-</span>  <span class="fu">nrow</span>(<span class="fu">subset</span>(<span class="fu">subset</span>(<span class="fu">subset</span>(sim, bleed <span class="sc">==</span><span class="dv">1</span>), time0h <span class="sc">&lt;</span> t[j]), time12<span class="sc">&gt;</span>t[j]))</span>
<span id="cb41-177"><a href="#cb41-177" aria-hidden="true" tabindex="-1"></a>      Q1b[i,j] <span class="ot">&lt;-</span> Y1<span class="sc">/</span>N</span>
<span id="cb41-178"><a href="#cb41-178" aria-hidden="true" tabindex="-1"></a>      SD1b[i,j] <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>(N<span class="sc">*</span>(N<span class="dv">-1</span>)))<span class="sc">*</span>(Y1<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Q1b[i,j])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (N<span class="sc">-</span>Y1)<span class="sc">*</span>Q1b[i,j]<span class="sc">^</span><span class="dv">2</span>)}}</span>
<span id="cb41-179"><a href="#cb41-179" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(t)){</span>
<span id="cb41-180"><a href="#cb41-180" aria-hidden="true" tabindex="-1"></a>    Q1hat <span class="ot">&lt;-</span> <span class="fu">mean</span>(Q1b[,j])</span>
<span id="cb41-181"><a href="#cb41-181" aria-hidden="true" tabindex="-1"></a>    SD1 <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>(B<span class="sc">*</span>(B<span class="dv">-1</span>)))<span class="sc">*</span><span class="fu">sum</span>((Q1b[,j] <span class="sc">-</span> Q1hat)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb41-182"><a href="#cb41-182" aria-hidden="true" tabindex="-1"></a>    var_Q1hat <span class="ot">&lt;-</span> SD1 <span class="sc">+</span> (<span class="dv">1</span><span class="sc">/</span>B)<span class="sc">*</span><span class="fu">sum</span>(SD1b[,j])</span>
<span id="cb41-183"><a href="#cb41-183" aria-hidden="true" tabindex="-1"></a>    res[j,] <span class="ot">&lt;-</span> <span class="fu">c</span>(Q1hat, var_Q1hat)</span>
<span id="cb41-184"><a href="#cb41-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(res) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Qhat"</span>, <span class="st">"Var"</span>)</span>
<span id="cb41-185"><a href="#cb41-185" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (sd <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb41-186"><a href="#cb41-186" aria-hidden="true" tabindex="-1"></a>      res[j,] <span class="ot">&lt;-</span> <span class="fu">c</span>(Q1hat, <span class="fu">sqrt</span>(var_Q1hat))</span>
<span id="cb41-187"><a href="#cb41-187" aria-hidden="true" tabindex="-1"></a>      <span class="fu">colnames</span>(res) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Qhat"</span>, <span class="st">"SD"</span>)}}</span>
<span id="cb41-188"><a href="#cb41-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)}</span>
<span id="cb41-189"><a href="#cb41-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-190"><a href="#cb41-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Table 5.4 </span></span>
<span id="cb41-191"><a href="#cb41-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-192"><a href="#cb41-192" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimation of transition probabilities (Q_1(t)) under Markov assumption</span></span>
<span id="cb41-193"><a href="#cb41-193" aria-hidden="true" tabindex="-1"></a>AaJ_Q1_data <span class="ot">&lt;-</span> <span class="fu">probtrans</span>(msfit, <span class="at">predt =</span> <span class="dv">0</span>)[[<span class="dv">1</span>]] <span class="co">#P(V(t) = 1 | V(1) = 0)</span></span>
<span id="cb41-194"><a href="#cb41-194" aria-hidden="true" tabindex="-1"></a>AaJ_Q1_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(AaJ_Q1_data<span class="sc">$</span>time, AaJ_Q1_data<span class="sc">$</span>pstate2, AaJ_Q1_data<span class="sc">$</span>se2, <span class="st">"AaJ"</span>))</span>
<span id="cb41-195"><a href="#cb41-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-196"><a href="#cb41-196" aria-hidden="true" tabindex="-1"></a><span class="co">#Function returning Q1(t) and SD based on the Aalen Johansen estimator</span></span>
<span id="cb41-197"><a href="#cb41-197" aria-hidden="true" tabindex="-1"></a>AaJ_Q1_function <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb41-198"><a href="#cb41-198" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">tail</span>(AaJ_Q1_data[<span class="fu">which</span>(<span class="fu">as.numeric</span>(AaJ_Q1_data<span class="sc">$</span>V1) <span class="sc">&lt;=</span> t), ]<span class="sc">$</span>V2, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb41-199"><a href="#cb41-199" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">tail</span>(AaJ_Q1_data[<span class="fu">which</span>(<span class="fu">as.numeric</span>(AaJ_Q1_data<span class="sc">$</span>V1) <span class="sc">&lt;=</span> t), ]<span class="sc">$</span>V3, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb41-200"><a href="#cb41-200" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(x,y))}</span>
<span id="cb41-201"><a href="#cb41-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-202"><a href="#cb41-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Q1(t) for t \in {0.5,1,...,4}</span></span>
<span id="cb41-203"><a href="#cb41-203" aria-hidden="true" tabindex="-1"></a>time_s1 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.5</span>,<span class="fl">4.</span>,<span class="fl">0.5</span>)<span class="sc">*</span><span class="fl">365.25</span></span>
<span id="cb41-204"><a href="#cb41-204" aria-hidden="true" tabindex="-1"></a>AaJ_Q1 <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(time_s1, AaJ_Q1_function))</span>
<span id="cb41-205"><a href="#cb41-205" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(AaJ_Q1) <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">0.5</span>,<span class="fl">4.</span>,<span class="fl">0.5</span>)</span>
<span id="cb41-206"><a href="#cb41-206" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(AaJ_Q1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Q1(t) estimate"</span>, <span class="st">"SD"</span>)</span>
<span id="cb41-207"><a href="#cb41-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-208"><a href="#cb41-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-209"><a href="#cb41-209" aria-hidden="true" tabindex="-1"></a><span class="co"># SD estimate for Q1(t) based on micro-simulation for t \in {0.5,1,...,4}. </span></span>
<span id="cb41-210"><a href="#cb41-210" aria-hidden="true" tabindex="-1"></a><span class="co"># Takes approximately 5 min</span></span>
<span id="cb41-211"><a href="#cb41-211" aria-hidden="true" tabindex="-1"></a>MS_Q1_est <span class="ot">&lt;-</span> <span class="fu">Q1_sd</span>(<span class="at">N =</span> <span class="dv">1000</span>,<span class="at">B =</span> <span class="dv">1000</span>,<span class="at">t =</span> time_s1, <span class="at">sd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-212"><a href="#cb41-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-213"><a href="#cb41-213" aria-hidden="true" tabindex="-1"></a><span class="co">#Making table in LaTeX format of SD estimates of Q1(t)</span></span>
<span id="cb41-214"><a href="#cb41-214" aria-hidden="true" tabindex="-1"></a>tab54 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(AaJ_Q1, MS_Q1_est)</span>
<span id="cb41-215"><a href="#cb41-215" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tab54) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"AaJ_est"</span>, <span class="st">"AaJ_SD"</span>, <span class="st">"MS_est"</span>, <span class="st">"MS_SD"</span>)</span>
<span id="cb41-216"><a href="#cb41-216" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(tab54) <span class="ot">&lt;-</span> <span class="st">"numeric"</span></span>
<span id="cb41-217"><a href="#cb41-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-218"><a href="#cb41-218" aria-hidden="true" tabindex="-1"></a><span class="co">#Table for LaTeX</span></span>
<span id="cb41-219"><a href="#cb41-219" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">xtable</span>(tab54, <span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">4</span>), <span class="at">caption =</span> <span class="st">"Q_{1}(t), t &gt; 0"</span>), <span class="at">include.rownames =</span> <span class="cn">TRUE</span>) <span class="co">#output for LaTeX</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>% latex table generated in R 4.3.1 by xtable 1.8-4 package
% Sun Oct 15 11:07:30 2023
\begin{table}[ht]
\centering
\begin{tabular}{rrrrr}
  \hline
 &amp; AaJ\_est &amp; AaJ\_SD &amp; MS\_est &amp; MS\_SD \\ 
  \hline
0.5 &amp; 0.050 &amp; 0.013 &amp; 0.050 &amp; 0.0069 \\ 
  1 &amp; 0.081 &amp; 0.016 &amp; 0.079 &amp; 0.0085 \\ 
  1.5 &amp; 0.091 &amp; 0.018 &amp; 0.092 &amp; 0.0091 \\ 
  2 &amp; 0.093 &amp; 0.019 &amp; 0.088 &amp; 0.0089 \\ 
  2.5 &amp; 0.089 &amp; 0.019 &amp; 0.084 &amp; 0.0088 \\ 
  3 &amp; 0.089 &amp; 0.019 &amp; 0.080 &amp; 0.0086 \\ 
  3.5 &amp; 0.079 &amp; 0.019 &amp; 0.076 &amp; 0.0084 \\ 
  4 &amp; 0.063 &amp; 0.020 &amp; 0.051 &amp; 0.0070 \\ 
   \hline
\end{tabular}
\caption{Q_{1}(t), t &gt; 0} 
\end{table}</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.5" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.5">Figure 5.5</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-10-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-1" role="tab" aria-controls="tabset-10-1" aria-selected="true">R</a></li></ul>
<div class="tab-content">
<div id="tabset-10-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-10-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.5-r_7b1a50e64c698ec8f57dff10ba825498">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Function returning list of B estimates of Q1(2) each based on simulation of N subjects </span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>Q1_hist2 <span class="ot">&lt;-</span> <span class="cf">function</span>(N,B){</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  Q1b <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(B))</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    sim <span class="ot">&lt;-</span> <span class="fu">microsim_fct</span>(N,i, <span class="at">sample =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    Y1 <span class="ot">&lt;-</span>  <span class="fu">nrow</span>(<span class="fu">subset</span>(<span class="fu">subset</span>(<span class="fu">subset</span>(sim, bleed <span class="sc">==</span><span class="dv">1</span>), time0h <span class="sc">&lt;</span> s2), time12<span class="sc">&gt;</span> s2))</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    Q1b[i] <span class="ot">&lt;-</span> Y1<span class="sc">/</span>N}</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(Q1b)}</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co"># N=B=1000 </span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="co">#hist_Q1 &lt;- Q1_hist2(1000,1000) </span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="co">#hist_Q1 &lt;- as.data.frame(hist_Q1)</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>hist_Q1 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/datafig55.csv"</span>)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram of Q1(2) with ggplot</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> hist_Q1<span class="sc">$</span>hist_Q1,<span class="at">y =</span> <span class="fu">stat</span>(count) <span class="sc">/</span> <span class="fu">sum</span>(count)),</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">"grey"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">bins =</span> <span class="dv">30</span>) <span class="sc">+</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(hist_Q1<span class="sc">$</span>hist_Q1), <span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Density"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="fu">expression</span>(Q[<span class="dv">1</span>]<span class="sc">*</span>(<span class="dv">2</span>))) <span class="sc">+</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.5-r-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.6" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.6">Figure 5.6</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-11-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-1" role="tab" aria-controls="tabset-11-1" aria-selected="true">R</a></li></ul>
<div class="tab-content">
<div id="tabset-11-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-11-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.6-r_2fb0605e09e2d60cc11bdd81fd4d13ee">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Expected length of stay in state 1, epsilon1(tau)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>sim_prova <span class="ot">&lt;-</span> <span class="fu">microsim_fct</span>(<span class="at">N =</span> <span class="dv">10000</span>, <span class="at">seed =</span> <span class="dv">1</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>MS_ELOS <span class="ot">&lt;-</span> <span class="cf">function</span>(tau,N, seed){</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  bleed_sub <span class="ot">&lt;-</span> <span class="fu">subset</span>(<span class="fu">subset</span>(sim_prova, bleed <span class="sc">==</span><span class="dv">1</span>), time0h <span class="sc">&lt;</span> tau)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  t12 <span class="ot">&lt;-</span> <span class="fu">pmin</span>(tau, bleed_sub<span class="sc">$</span>time12) <span class="co">#returns minimum of tau and time12 for each simulated subject</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  t01 <span class="ot">&lt;-</span> bleed_sub<span class="sc">$</span>time0h</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>((<span class="dv">1</span><span class="sc">/</span><span class="fu">nrow</span>(sim_prova))<span class="sc">*</span><span class="fu">sum</span>(t12 <span class="sc">-</span> t01))}</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating data</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>time_elos <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">4</span><span class="sc">*</span><span class="fl">365.25</span>,<span class="dv">1</span>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="co">#elos_aj &lt;- as.data.frame(cbind(time_elos, sapply(time_elos, AaJ_ELOS_function)))</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="co">#elos_ms &lt;- as.data.frame(cbind(time_elos, sapply(time_elos, MS_ELOS, seed = 1, N = 10000))) </span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Plot comparing epsilon1(tau) based on AaJ and micro-simulation (based on N = 10.000)</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>elos_aj <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/datafig56a.csv"</span>)</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>elos_ms <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/datafig56b.csv"</span>)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data =</span> elos_aj, <span class="fu">aes</span>(<span class="at">x =</span>time_elos<span class="sc">/</span><span class="fl">365.25</span>, <span class="at">y =</span> V2<span class="sc">/</span><span class="fl">365.25</span>, <span class="at">linetype =</span> <span class="st">"Aalen-Johansen"</span>), <span class="at">size =</span><span class="fl">0.9</span>) <span class="sc">+</span> </span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span>elos_ms, <span class="fu">aes</span>(<span class="at">x =</span> time_elos<span class="sc">/</span><span class="fl">365.25</span>, <span class="at">y =</span> V2<span class="sc">/</span><span class="fl">365.25</span>, <span class="at">linetype =</span> <span class="st">"Micro-simulation"</span>), <span class="at">size =</span><span class="fl">0.9</span>)<span class="sc">+</span> </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()  <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">expression</span>(epsilon[<span class="dv">1</span>] <span class="sc">*</span> (t))) <span class="sc">+</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="st">"Estimator"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"dashed"</span>)) <span class="sc">+</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title=</span><span class="fu">element_blank</span>(),</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>))</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.6-r-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.7" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.7">Figure 5.7</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-12-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-1" role="tab" aria-controls="tabset-12-1" aria-selected="true">R</a></li></ul>
<div class="tab-content">
<div id="tabset-12-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-12-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.7-r_c635bb582d7a517e19d9fb860418c71c">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MICROSIMULATION INCLUDING SCLEROTHERAPY AS COVARIATE #########################</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Poisson model for alpha01</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>poisson01_scle <span class="ot">&lt;-</span> <span class="fu">glm</span>(case.bleed <span class="sc">~</span> tsr.cat <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(pyar)) <span class="sc">+</span>  <span class="fu">factor</span>(scle) <span class="sc">-</span><span class="dv">1</span> , <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> <span class="fu">subset</span>(SplitLexis01, lex.Cst <span class="sc">==</span> <span class="st">"NoBleeding"</span>))</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co">#Poisson model for alpha02</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>poisson02_scle <span class="ot">&lt;-</span> <span class="fu">glm</span>(case.dead <span class="sc">~</span> tsr.cat <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(pyar)) <span class="sc">+</span> <span class="fu">factor</span>(scle) , <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> <span class="fu">subset</span>(SplitLexis02, lex.Cst <span class="sc">==</span> <span class="st">"NoBleeding"</span>))</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Poisson model for alpha12</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>poisson12_scle <span class="ot">&lt;-</span> <span class="fu">glm</span>(case.deadb <span class="sc">~</span> tsb.cat <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(pyar)) <span class="sc">+</span> <span class="fu">factor</span>(scle), <span class="at">family =</span> <span class="fu">poisson</span>(), <span class="at">data =</span> <span class="fu">subset</span>(SplitLexis12, lex.Cst <span class="sc">==</span> <span class="st">"Bleeding"</span>))</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="co">#Cumulative hazard function, A01(t) = \int_0^t alpha01(u)du for Poisson model of 0-&gt;1 </span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="co">#transition, model01, with  covariate scle \in {0,1}.</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Time since randomization as time axis</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>cumhaz01_scle <span class="ot">&lt;-</span> <span class="cf">function</span>(model01 ,t, scle){</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  times <span class="ot">&lt;-</span> intervals01[intervals01 <span class="sc">&lt;</span> t] <span class="co">#time intervals up to time t where A01 is constant</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(times)</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">&lt;=</span> <span class="dv">1</span>){ <span class="co">#If 0 or 1 interval</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (scle <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>      chz <span class="ot">&lt;-</span> <span class="fu">exp</span>(model01[<span class="dv">1</span>])<span class="sc">*</span>t}</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {chz <span class="ot">&lt;-</span> <span class="fu">exp</span>(model01[<span class="dv">1</span>])<span class="sc">*</span>t<span class="sc">*</span><span class="fu">exp</span>(model01[<span class="dv">18</span>])}}</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{ <span class="co">#If two or more intervals</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    length_int <span class="ot">&lt;-</span> <span class="fu">diff</span>(times) <span class="co">#length of intervals</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (scle <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>      chz <span class="ot">&lt;-</span> <span class="fu">sum</span>(length_int<span class="sc">*</span><span class="fu">exp</span>(model01[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)])) <span class="sc">+</span> <span class="fu">exp</span>(model01[n])<span class="sc">*</span>(t <span class="sc">-</span> <span class="fu">sum</span>(length_int))} <span class="co">#sum(alpha01*len_int), scle = 0 </span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{chz <span class="ot">&lt;-</span> <span class="fu">sum</span>(length_int<span class="sc">*</span><span class="fu">exp</span>(model01[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)])<span class="sc">*</span><span class="fu">exp</span>(model01[<span class="dv">18</span>])) <span class="sc">+</span> <span class="fu">exp</span>(model01[n])<span class="sc">*</span><span class="fu">exp</span>(model01[<span class="dv">18</span>])<span class="sc">*</span>(t <span class="sc">-</span> <span class="fu">sum</span>(length_int))}} <span class="co">#sum(alpha01*len_int), scle =1</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.numeric</span>(chz))}</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a><span class="co">#Cumulative hazard function, A02(t) = \int_0^t alpha02(u)du for Poisson model of 0-&gt;2 </span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a><span class="co">#transition, model02, with  covariate scle \in {0,1}. </span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Time since randomization as time axis</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>cumhaz02_scle <span class="ot">&lt;-</span> <span class="cf">function</span>(model02, t, scle){</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>  times <span class="ot">&lt;-</span> intervals02[intervals02 <span class="sc">&lt;</span> t] <span class="co">#time intervals up to time t where A02 is constant</span></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(times)</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">&lt;=</span> <span class="dv">1</span>){ <span class="co">#If 0 or 1 interval</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (scle <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>      chz <span class="ot">&lt;-</span> <span class="fu">exp</span>(model02[<span class="dv">1</span>])<span class="sc">*</span>t}</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {chz <span class="ot">&lt;-</span> <span class="fu">exp</span>(model02[<span class="dv">1</span>])<span class="sc">*</span>t<span class="sc">*</span><span class="fu">exp</span>(model02[<span class="dv">17</span>])}}</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{ <span class="co">#If two or more intervals</span></span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>    length_int <span class="ot">&lt;-</span> <span class="fu">diff</span>(times) <span class="co">#length of intervals</span></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (scle <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>      chz <span class="ot">&lt;-</span> <span class="fu">sum</span>(length_int<span class="sc">*</span><span class="fu">exp</span>(model02[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)])) <span class="sc">+</span> <span class="fu">exp</span>(model02[n])<span class="sc">*</span>(t <span class="sc">-</span> <span class="fu">sum</span>(length_int))} <span class="co">#sum(alpha02*len_int), scle = 0</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{chz <span class="ot">&lt;-</span> <span class="fu">sum</span>(length_int<span class="sc">*</span><span class="fu">exp</span>(model02[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)])<span class="sc">*</span><span class="fu">exp</span>(model02[<span class="dv">17</span>])) <span class="sc">+</span> <span class="fu">exp</span>(model02[n])<span class="sc">*</span><span class="fu">exp</span>(model02[<span class="dv">17</span>])<span class="sc">*</span>(t <span class="sc">-</span> <span class="fu">sum</span>(length_int))}} <span class="co">#sum(alpha02*len_int), scle = 1</span></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.numeric</span>(chz))}</span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a><span class="co">#Cumulative hazard function, A12(t) = \int_0^t alpha12(u)du for Poisson model of 1-&gt;2 </span></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a><span class="co">#transition, model12, with  covariate scle \in {0,1}</span></span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Duration in state 1 as time axis</span></span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>cumhaz12_scle <span class="ot">&lt;-</span> <span class="cf">function</span>(model12, t, scle){</span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>  times <span class="ot">&lt;-</span> intervals12[intervals12 <span class="sc">&lt;</span> t] <span class="co">#time intervals up to time t where A12 is constant</span></span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(times)</span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">&lt;=</span> <span class="dv">1</span>){</span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (scle <span class="sc">==</span> <span class="dv">0</span>){ <span class="co">#If 0 or 1 interval</span></span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>      chz <span class="ot">&lt;-</span> <span class="fu">exp</span>(model12[<span class="dv">1</span>])<span class="sc">*</span>t}</span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {chz <span class="ot">&lt;-</span> <span class="fu">exp</span>(model12[<span class="dv">1</span>])<span class="sc">*</span>t<span class="sc">*</span><span class="fu">exp</span>(model12[<span class="dv">11</span>])}}</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{ <span class="co">#If two or more intervals</span></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>    length_int <span class="ot">&lt;-</span> <span class="fu">diff</span>(times) <span class="co">#length of intervals</span></span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (scle <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>      chz <span class="ot">&lt;-</span> <span class="fu">sum</span>(length_int<span class="sc">*</span><span class="fu">exp</span>(model12[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)])) <span class="sc">+</span> <span class="fu">exp</span>(model12[n])<span class="sc">*</span>(t <span class="sc">-</span> <span class="fu">sum</span>(length_int))} <span class="co">#sum(alpha12*len_int), scle = 0</span></span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{chz <span class="ot">&lt;-</span> <span class="fu">sum</span>(length_int<span class="sc">*</span><span class="fu">exp</span>(model12[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)])<span class="sc">*</span><span class="fu">exp</span>(model12[<span class="dv">11</span>])) <span class="sc">+</span> <span class="fu">exp</span>(model12[n])<span class="sc">*</span><span class="fu">exp</span>(model12[<span class="dv">11</span>])<span class="sc">*</span>(t <span class="sc">-</span> <span class="fu">sum</span>(length_int))}} <span class="co">#sum(alpha12*len_int), scle = 1</span></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.numeric</span>(chz))}</span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimates and covariance matrix for alpha01 </span></span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>beta01_scle <span class="ot">&lt;-</span> <span class="fu">summary</span>(poisson01_scle)<span class="sc">$</span>coefficients[,<span class="dv">1</span>]</span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>sigma01_scle <span class="ot">&lt;-</span> <span class="fu">vcov</span>(poisson01_scle)</span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimates and covariance matrix for alpha02 </span></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a>beta02_scle <span class="ot">&lt;-</span> <span class="fu">summary</span>(poisson02_scle)<span class="sc">$</span>coefficients[,<span class="dv">1</span>]</span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>sigma02_scle <span class="ot">&lt;-</span> <span class="fu">vcov</span>(poisson02_scle)</span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimates and covariance matrix for alpha12 </span></span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a>beta12_scle <span class="ot">&lt;-</span> <span class="fu">summary</span>(poisson12_scle)<span class="sc">$</span>coefficients[,<span class="dv">1</span>]</span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a>sigma12_scle <span class="ot">&lt;-</span> <span class="fu">vcov</span>(poisson12_scle)</span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a><span class="co">#Microsimulation function. 'N' is number of subjects to simulate, 'seed' is random seed and </span></span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a><span class="co">#if 'sample = TRUE' new parameters for the Poisson models are drawn from </span></span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a><span class="co"># multivariate normal distributions. 'scle' is binary covariate indicating treatment with (1)</span></span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a><span class="co"># or without (0) sclerotherapy</span></span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a>microsim_fct_scle <span class="ot">&lt;-</span> <span class="cf">function</span>(N, seed, scle,<span class="at">sample =</span> <span class="cn">FALSE</span>){</span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed) <span class="co">#Setting the random seed</span></span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a>  glm01 <span class="ot">&lt;-</span> beta01_scle <span class="co">#Original alpha01 hazard</span></span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a>  glm02 <span class="ot">&lt;-</span> beta02_scle <span class="co">#Original alpha02 hazard</span></span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a>  glm12 <span class="ot">&lt;-</span> beta12_scle <span class="co">#Original alpha12 hazard</span></span>
<span id="cb45-84"><a href="#cb45-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Drawing new parameter values</span></span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sample <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a>    glm01 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> beta01_scle, <span class="at">Sigma =</span> sigma01_scle)) </span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a>    glm02 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> beta02_scle, <span class="at">Sigma =</span> sigma02_scle))</span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a>    glm12 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> beta12_scle, <span class="at">Sigma =</span> sigma12_scle))}</span>
<span id="cb45-89"><a href="#cb45-89" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Setting up the hazard functions</span></span>
<span id="cb45-90"><a href="#cb45-90" aria-hidden="true" tabindex="-1"></a>  ch01 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time0h_int, cumhaz01_scle, <span class="at">model01 =</span> glm01, <span class="at">scle =</span> scle) <span class="co">#A01 for Poisson model with parameter values glm01</span></span>
<span id="cb45-91"><a href="#cb45-91" aria-hidden="true" tabindex="-1"></a>  ch02 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time0h_int, cumhaz02_scle, <span class="at">model02 =</span> glm02, <span class="at">scle =</span> scle) <span class="co">#A02 for Poisson model with parameter values glm02</span></span>
<span id="cb45-92"><a href="#cb45-92" aria-hidden="true" tabindex="-1"></a>  cum0h_inv <span class="ot">&lt;-</span> <span class="fu">approxfun</span>(time0h_int <span class="sc">~</span> (ch01 <span class="sc">+</span> ch02)) <span class="co">#Inverse function of A01 + A02</span></span>
<span id="cb45-93"><a href="#cb45-93" aria-hidden="true" tabindex="-1"></a>  ch12 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time12_int, cumhaz12_scle, <span class="at">model12 =</span> glm12, <span class="at">scle =</span> scle) <span class="co">#A12 for Poisson model with parameter values glm12</span></span>
<span id="cb45-94"><a href="#cb45-94" aria-hidden="true" tabindex="-1"></a>  cum12_inv <span class="ot">&lt;-</span> <span class="fu">approxfun</span>(time12_int <span class="sc">~</span> ch12) <span class="co">#Inverse function of A12</span></span>
<span id="cb45-95"><a href="#cb45-95" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scle <span class="sc">==</span> <span class="dv">0</span>){ <span class="co">#Subjects not given sclerotherapy </span></span>
<span id="cb45-96"><a href="#cb45-96" aria-hidden="true" tabindex="-1"></a>    alpha01 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){<span class="fu">as.numeric</span>(<span class="fu">exp</span>(glm01[<span class="fu">length</span>(intervals01[intervals01 <span class="sc">&lt;</span> t])]))} <span class="co">#alpha01 for Poisson model with parameter values glm01 </span></span>
<span id="cb45-97"><a href="#cb45-97" aria-hidden="true" tabindex="-1"></a>    alpha02 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){<span class="fu">as.numeric</span>(<span class="fu">exp</span>(glm02[<span class="fu">length</span>(intervals02[intervals02 <span class="sc">&lt;</span> t])]))}} <span class="co">#alpha02 for Poisson model with parameter values glm02</span></span>
<span id="cb45-98"><a href="#cb45-98" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> { <span class="co">#Subjects given sclerotherapy</span></span>
<span id="cb45-99"><a href="#cb45-99" aria-hidden="true" tabindex="-1"></a>    alpha01 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){<span class="fu">as.numeric</span>(<span class="fu">exp</span>(glm01[<span class="fu">length</span>(intervals01[intervals01 <span class="sc">&lt;</span> t])])<span class="sc">*</span><span class="fu">exp</span>(glm01[<span class="dv">18</span>]))} <span class="co">#alpha01 for Poisson model with parameter values glm01 </span></span>
<span id="cb45-100"><a href="#cb45-100" aria-hidden="true" tabindex="-1"></a>    alpha02 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){<span class="fu">as.numeric</span>(<span class="fu">exp</span>(glm02[<span class="fu">length</span>(intervals02[intervals02 <span class="sc">&lt;</span> t])])<span class="sc">*</span><span class="fu">exp</span>(glm02[<span class="dv">17</span>]))}} <span class="co">#alpha02 for Poisson model with parameter values glm02 </span></span>
<span id="cb45-101"><a href="#cb45-101" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Making the data frame</span></span>
<span id="cb45-102"><a href="#cb45-102" aria-hidden="true" tabindex="-1"></a>  sim_prova <span class="ot">&lt;-</span>  prova[<span class="dv">1</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>]</span>
<span id="cb45-103"><a href="#cb45-103" aria-hidden="true" tabindex="-1"></a>  sim_prova[<span class="dv">1</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb45-104"><a href="#cb45-104" aria-hidden="true" tabindex="-1"></a>  sim_prova <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(sim_prova, id, bleed, death, outof0, timebleed, timedeath, wait)</span>
<span id="cb45-105"><a href="#cb45-105" aria-hidden="true" tabindex="-1"></a>  sim_prova <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, <span class="fu">replicate</span>(N, sim_prova, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb45-106"><a href="#cb45-106" aria-hidden="true" tabindex="-1"></a>  sim_prova<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>N</span>
<span id="cb45-107"><a href="#cb45-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(sim_prova) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>,<span class="st">"bleed"</span>,<span class="st">"death"</span>, <span class="st">"cens"</span>, <span class="st">"time0h"</span>, <span class="st">"time12"</span>, <span class="st">"dur1"</span>)</span>
<span id="cb45-108"><a href="#cb45-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">#The actual simulation</span></span>
<span id="cb45-109"><a href="#cb45-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb45-110"><a href="#cb45-110" aria-hidden="true" tabindex="-1"></a>    u <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1</span>,<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span><span class="dv">1</span>)) <span class="co">#-log(S(t))</span></span>
<span id="cb45-111"><a href="#cb45-111" aria-hidden="true" tabindex="-1"></a>    sim_prova<span class="sc">$</span>time0h[i] <span class="ot">&lt;-</span> <span class="fu">cum0h_inv</span>(u) <span class="co">#t, time of transition out of state 0</span></span>
<span id="cb45-112"><a href="#cb45-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.na</span>(sim_prova<span class="sc">$</span>time0h[i])){ <span class="co">#In case time0h &gt; 4.13 (censoring time)</span></span>
<span id="cb45-113"><a href="#cb45-113" aria-hidden="true" tabindex="-1"></a>      sim_prova<span class="sc">$</span>time0h[i] <span class="ot">&lt;-</span> cens_outof0</span>
<span id="cb45-114"><a href="#cb45-114" aria-hidden="true" tabindex="-1"></a>      sim_prova<span class="sc">$</span>cens[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb45-115"><a href="#cb45-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{</span>
<span id="cb45-116"><a href="#cb45-116" aria-hidden="true" tabindex="-1"></a>      hazard01 <span class="ot">&lt;-</span> <span class="fu">alpha01</span>(<span class="fu">cum0h_inv</span>(u)) <span class="co">#alpha01(t)</span></span>
<span id="cb45-117"><a href="#cb45-117" aria-hidden="true" tabindex="-1"></a>      hazard02 <span class="ot">&lt;-</span> <span class="fu">alpha02</span>(<span class="fu">cum0h_inv</span>(u)) <span class="co">#alpha02(t)</span></span>
<span id="cb45-118"><a href="#cb45-118" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (hazard02<span class="sc">/</span>(hazard01 <span class="sc">+</span> hazard02) <span class="sc">&gt;=</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)) <span class="co">#Choosing 0-&gt;2 with probability alpha_02(t)/(alpha_01(t) + alpha_02(t))</span></span>
<span id="cb45-119"><a href="#cb45-119" aria-hidden="true" tabindex="-1"></a>      {sim_prova<span class="sc">$</span>death[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb45-120"><a href="#cb45-120" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{</span>
<span id="cb45-121"><a href="#cb45-121" aria-hidden="true" tabindex="-1"></a>        sim_prova<span class="sc">$</span>bleed[i] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb45-122"><a href="#cb45-122" aria-hidden="true" tabindex="-1"></a>        u2 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log</span>(<span class="fu">runif</span>(<span class="at">n =</span><span class="dv">1</span>, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">1</span>)) <span class="co">#-log(S(t))</span></span>
<span id="cb45-123"><a href="#cb45-123" aria-hidden="true" tabindex="-1"></a>        sim_prova<span class="sc">$</span>dur1[i] <span class="ot">&lt;-</span> <span class="fu">cum12_inv</span>(u2) <span class="co">#t2, length of stay in state 1 for subject i.</span></span>
<span id="cb45-124"><a href="#cb45-124" aria-hidden="true" tabindex="-1"></a>        sim_prova<span class="sc">$</span>time12[i] <span class="ot">&lt;-</span> sim_prova<span class="sc">$</span>dur1[i] <span class="sc">+</span>sim_prova<span class="sc">$</span>time0h[i] <span class="co">#time of 1-&gt;2 (since randomization)</span></span>
<span id="cb45-125"><a href="#cb45-125" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.na</span>(sim_prova<span class="sc">$</span>dur1[i])){</span>
<span id="cb45-126"><a href="#cb45-126" aria-hidden="true" tabindex="-1"></a>          sim_prova<span class="sc">$</span>dur1[i] <span class="ot">&lt;-</span> cens_wait <span class="co">#If duration in state 1 &gt; 3.73 (censoring time)</span></span>
<span id="cb45-127"><a href="#cb45-127" aria-hidden="true" tabindex="-1"></a>          sim_prova<span class="sc">$</span>time12[i] <span class="ot">&lt;-</span> <span class="fu">min</span>((sim_prova<span class="sc">$</span>time0h[i] <span class="sc">+</span> cens_wait), cens_outof0)  <span class="co">#If time12 &gt; 4.13, time12 = 4.13 (censoring)</span></span>
<span id="cb45-128"><a href="#cb45-128" aria-hidden="true" tabindex="-1"></a>          sim_prova<span class="sc">$</span>cens[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb45-129"><a href="#cb45-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>{ </span>
<span id="cb45-130"><a href="#cb45-130" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (sim_prova<span class="sc">$</span>time12[i] <span class="sc">&gt;</span> cens_outof0){</span>
<span id="cb45-131"><a href="#cb45-131" aria-hidden="true" tabindex="-1"></a>            sim_prova<span class="sc">$</span>time12[i] <span class="ot">&lt;-</span> cens_outof0 <span class="co">#Censoring if time12 &gt; 4.13</span></span>
<span id="cb45-132"><a href="#cb45-132" aria-hidden="true" tabindex="-1"></a>            sim_prova<span class="sc">$</span>cens[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb45-133"><a href="#cb45-133" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span>{</span>
<span id="cb45-134"><a href="#cb45-134" aria-hidden="true" tabindex="-1"></a>            sim_prova<span class="sc">$</span>death[i] <span class="ot">&lt;-</span> <span class="dv">1</span>}}}}}</span>
<span id="cb45-135"><a href="#cb45-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sim_prova)}</span>
<span id="cb45-136"><a href="#cb45-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-137"><a href="#cb45-137" aria-hidden="true" tabindex="-1"></a><span class="co">#Function calculation the value of Q1(t) for B micro-simulation data sets each </span></span>
<span id="cb45-138"><a href="#cb45-138" aria-hidden="true" tabindex="-1"></a><span class="co">#containing N path, and the covariate value of scle \in {0,1}.</span></span>
<span id="cb45-139"><a href="#cb45-139" aria-hidden="true" tabindex="-1"></a>Q1_hist2_scle <span class="ot">&lt;-</span> <span class="cf">function</span>(N,B, scle){</span>
<span id="cb45-140"><a href="#cb45-140" aria-hidden="true" tabindex="-1"></a>  Q1b <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(B))</span>
<span id="cb45-141"><a href="#cb45-141" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb45-142"><a href="#cb45-142" aria-hidden="true" tabindex="-1"></a>    sim <span class="ot">&lt;-</span> <span class="fu">microsim_fct_scle</span>(N,i, <span class="at">sample =</span> <span class="cn">TRUE</span>, <span class="at">scle =</span> scle)</span>
<span id="cb45-143"><a href="#cb45-143" aria-hidden="true" tabindex="-1"></a>    Y1 <span class="ot">&lt;-</span>  <span class="fu">nrow</span>(<span class="fu">subset</span>(<span class="fu">subset</span>(<span class="fu">subset</span>(sim, bleed <span class="sc">==</span><span class="dv">1</span>), time0h <span class="sc">&lt;</span> s2), time12<span class="sc">&gt;</span>s2))</span>
<span id="cb45-144"><a href="#cb45-144" aria-hidden="true" tabindex="-1"></a>    Q1b[i] <span class="ot">&lt;-</span> Y1<span class="sc">/</span>N}</span>
<span id="cb45-145"><a href="#cb45-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(Q1b)}</span>
<span id="cb45-146"><a href="#cb45-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-147"><a href="#cb45-147" aria-hidden="true" tabindex="-1"></a><span class="co"># Data for histogram. </span></span>
<span id="cb45-148"><a href="#cb45-148" aria-hidden="true" tabindex="-1"></a><span class="co"># Takes approx. 10 min</span></span>
<span id="cb45-149"><a href="#cb45-149" aria-hidden="true" tabindex="-1"></a><span class="co">#hist_Q1_scle0 &lt;- Q1_hist2_scle(1000,1000, 0)</span></span>
<span id="cb45-150"><a href="#cb45-150" aria-hidden="true" tabindex="-1"></a><span class="co">#hist_Q1_scle1 &lt;- Q1_hist2_scle(1000,1000, 1)</span></span>
<span id="cb45-151"><a href="#cb45-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-152"><a href="#cb45-152" aria-hidden="true" tabindex="-1"></a>hist_Q1_scle0 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/datafig57a.csv"</span>)<span class="sc">$</span>x</span>
<span id="cb45-153"><a href="#cb45-153" aria-hidden="true" tabindex="-1"></a>hist_Q1_scle1 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/datafig57b.csv"</span>)<span class="sc">$</span>x</span>
<span id="cb45-154"><a href="#cb45-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-155"><a href="#cb45-155" aria-hidden="true" tabindex="-1"></a>fills <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> <span class="st">"lightgrey"</span>, <span class="st">"1"</span> <span class="ot">=</span> <span class="st">"darkgrey"</span>)</span>
<span id="cb45-156"><a href="#cb45-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-157"><a href="#cb45-157" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb45-158"><a href="#cb45-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.numeric</span>(hist_Q1_scle1), <span class="at">y =</span> <span class="fu">stat</span>(count) <span class="sc">/</span> <span class="fu">sum</span>(count), <span class="at">fill =</span> <span class="st">"1"</span>), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">bins =</span> <span class="dv">40</span>) <span class="sc">+</span></span>
<span id="cb45-159"><a href="#cb45-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(hist_Q1_scle1), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb45-160"><a href="#cb45-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">as.numeric</span>(hist_Q1_scle0), <span class="at">y =</span> <span class="fu">stat</span>(count) <span class="sc">/</span> <span class="fu">sum</span>(count), <span class="at">fill =</span> <span class="st">"0"</span>), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">bins =</span> <span class="dv">40</span>) <span class="sc">+</span></span>
<span id="cb45-161"><a href="#cb45-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(hist_Q1_scle0), <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb45-162"><a href="#cb45-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Density"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="fu">expression</span>(Q[<span class="dv">1</span>]<span class="sc">*</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="st">" | "</span> <span class="sc">*</span> Z))) <span class="sc">+</span> <span class="fu">scale_fill_manual</span>(<span class="st">"Z"</span>, <span class="at">values =</span> fills) <span class="sc">+</span> </span>
<span id="cb45-163"><a href="#cb45-163" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb45-164"><a href="#cb45-164" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.7-r-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.8" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.8">Figure 5.8</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-13-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-1" role="tab" aria-controls="tabset-13-1" aria-selected="true">R</a></li></ul>
<div class="tab-content">
<div id="tabset-13-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-13-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.8-r_33d3c9dd27e48481cfe2a0dfe2fc7c75">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># P01(1,t) LANDMARK PEPE #######################################################</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co">#S_01, Kaplan-Meier for being in state 0 or 1 among patients in state 0 at time 1 year</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>S01_s1 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(timedeath, death) <span class="sc">~</span><span class="dv">1</span>, <span class="at">data =</span> prova[timebleed <span class="sc">&gt;</span> s1]) </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>S01_s1_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(S01_s1<span class="sc">$</span>time, S01_s1<span class="sc">$</span>surv))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co">#S_0, Kaplen-Meier for being in state 0 among patients in state 0 at time 1 year</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>S0_s1 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(timebleed, outof0)<span class="sc">~</span><span class="dv">1</span>, <span class="at">data =</span> prova[timebleed <span class="sc">&gt;</span> s1]) </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>S0_s1_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(S0_s1<span class="sc">$</span>time, S0_s1<span class="sc">$</span>surv))</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co">#S_01(t) - S_0(t) among subjects in state 0 at time 1 year</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>pepe01_s1 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){ </span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  S01t <span class="ot">&lt;-</span> S01_s1_table<span class="sc">$</span>V2[<span class="fu">nrow</span>(S01_s1_table[V1 <span class="sc">&lt;=</span> t])]</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  S0t <span class="ot">&lt;-</span> S0_s1_table<span class="sc">$</span>V2[<span class="fu">nrow</span>(S0_s1_table[V1 <span class="sc">&lt;=</span> t])]</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(S01t) <span class="sc">==</span> <span class="dv">0</span>){S01t <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(S0t) <span class="sc">==</span> <span class="dv">0</span>){S0t <span class="ot">&lt;-</span><span class="dv">1</span>}</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>  Pepe_est <span class="ot">&lt;-</span> S01t <span class="sc">-</span> S0t</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(Pepe_est)}</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="co"># P01(1,t) LANDMARK TITMAN #####################################################</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="co">#P(X(t) =1 | Z_s(1) = 0, X(1) = 0)</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>little_p_hat_s1 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>  numerator <span class="ot">&lt;-</span> prova[bleed <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> timebleed <span class="sc">&gt;</span> s1 <span class="sc">&amp;</span> timebleed <span class="sc">&lt;</span> t <span class="sc">&amp;</span> timedeath <span class="sc">&gt;</span> t] <span class="co">#patients in state 1 at time t among patients in state 0 at time 1</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>  denominator <span class="ot">&lt;-</span> prova[timebleed <span class="sc">&gt;</span> s1 <span class="sc">&amp;</span> timedeath <span class="sc">&gt;</span> t] <span class="co">#patients under observation in state 0 or 1 at time t among patients at state 0 at time 1</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>  frac <span class="ot">&lt;-</span> <span class="fu">nrow</span>(numerator)<span class="sc">/</span><span class="fu">nrow</span>(denominator)</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(frac)}</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a><span class="co">#Titman P_01(1,t)</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>titman01_s1 <span class="ot">&lt;-</span> <span class="cf">function</span>(end){</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>  S01t <span class="ot">&lt;-</span> S01_s1_table<span class="sc">$</span>V2[<span class="fu">nrow</span>(S01_s1_table[V1 <span class="sc">&lt;=</span> end])]</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(S01t) <span class="sc">==</span> <span class="dv">0</span>){S01t <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>  titman <span class="ot">&lt;-</span> S01t<span class="sc">*</span><span class="fu">little_p_hat_s1</span>(end)</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(titman)}</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a><span class="co"># P_00(1,u -)*alpha_01(u) ######################################################</span></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Y0, patients in state 0 at time t-</span></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>patients_in_0 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">nrow</span>(prova[timebleed <span class="sc">&gt;</span> (t <span class="sc">-</span> <span class="fl">0.0000001</span>)]))}</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a><span class="co">#P_00(s,u-) = S0(u-)/S0(s), where S0(x) is Kaplan-Meier estimator for being in state 0 at time x</span></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>p00 <span class="ot">&lt;-</span> <span class="cf">function</span>(start, end){</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>  exits <span class="ot">&lt;-</span> prova[outof0 <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> timebleed <span class="sc">&gt;</span> start <span class="sc">&amp;</span> timebleed <span class="sc">&lt;=</span>(end <span class="sc">-</span> <span class="fl">0.000001</span>)]<span class="sc">$</span>timebleed <span class="co">#Event times where patients leave state 0</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(exits) <span class="sc">==</span> <span class="dv">0</span>){prob <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>    exits_unique <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="fu">table</span>(exits)) <span class="co">#Table with unique event times and number of patients leaving</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>    Y0 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(exits_unique<span class="sc">$</span>exits)), patients_in_0)</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>    frac <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> exits_unique<span class="sc">$</span>N<span class="sc">/</span>Y0)</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>    prob <span class="ot">&lt;-</span> <span class="fu">prod</span>(frac)}</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob)}</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a><span class="co"># alpha01(u) = dN01(u)/Y0(u)</span></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>alpha01 <span class="ot">&lt;-</span> <span class="cf">function</span>(u){ </span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>  dN01 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(prova[timebleed <span class="sc">==</span> u <span class="sc">&amp;</span> bleed <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">patients_in_0</span>(u)</span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dN01<span class="sc">/</span>Y0)}</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Time of 0 -&gt; 1 transitions after 1 year</span></span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a>time01 <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(prova[timebleed <span class="sc">&gt;</span> s1 <span class="sc">&amp;</span> bleed <span class="sc">==</span> <span class="dv">1</span>]<span class="sc">$</span>timebleed))</span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Matrix where 1st column is times for 0 -&gt; 1 transition, u,</span></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a><span class="co"># and 4th column is P00(1,u -)*alpha01(u)</span></span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a>p00alpha01 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">length</span>(time01), <span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>p00alpha01[, <span class="dv">1</span>] <span class="ot">&lt;-</span> time01 <span class="co">#u, times of 0-&gt;1 transitions after 1 year</span></span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a>p00alpha01[, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(p00alpha01[,<span class="dv">1</span>], p00, <span class="at">start =</span> s1) <span class="co">#P00(1,u -)</span></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>p00alpha01[, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(p00alpha01[,<span class="dv">1</span>], alpha01) <span class="co">#alpha01(u)</span></span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a>p00alpha01[, <span class="dv">4</span>] <span class="ot">&lt;-</span> p00alpha01[,<span class="dv">2</span>]<span class="sc">*</span>p00alpha01[,<span class="dv">3</span>] <span class="co">#P00(1,u -)*alpha01(u)</span></span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a><span class="co"># P01(1,t) SEMI-MARKOV ESTIMATOR ###############################################</span></span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Y*1(d), patients with duration in state 1 longer than d-</span></span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a>patients_in_1_dur <span class="ot">&lt;-</span> <span class="cf">function</span>(d){</span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">nrow</span>(prova[bleed <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> wait <span class="sc">&gt;</span> d <span class="sc">-</span> <span class="fl">0.000001</span>]))}</span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a><span class="co"># P_11(u,t) under semi-Markov assumption, i.e. Kaplan-Meier estimator with duration</span></span>
<span id="cb46-77"><a href="#cb46-77" aria-hidden="true" tabindex="-1"></a><span class="co"># in state 1 as time</span></span>
<span id="cb46-78"><a href="#cb46-78" aria-hidden="true" tabindex="-1"></a>p11_semi <span class="ot">&lt;-</span> <span class="cf">function</span>(d){ <span class="co">#d represents duration in state 1</span></span>
<span id="cb46-79"><a href="#cb46-79" aria-hidden="true" tabindex="-1"></a>  exits <span class="ot">&lt;-</span> prova[bleed <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> death <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> wait <span class="sc">&lt;=</span>d]<span class="sc">$</span>wait <span class="co">#d | dN_12(d) &gt; 0</span></span>
<span id="cb46-80"><a href="#cb46-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(exits) <span class="sc">==</span> <span class="dv">0</span>) {prob <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb46-81"><a href="#cb46-81" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb46-82"><a href="#cb46-82" aria-hidden="true" tabindex="-1"></a>    exits_unique <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="fu">table</span>(exits)) <span class="co">#table with d and dN_12(d) &gt; 0</span></span>
<span id="cb46-83"><a href="#cb46-83" aria-hidden="true" tabindex="-1"></a>    Y1 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(exits_unique<span class="sc">$</span>exits)), patients_in_1_dur) <span class="co">#Y*1(d-)</span></span>
<span id="cb46-84"><a href="#cb46-84" aria-hidden="true" tabindex="-1"></a>    frac <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> exits_unique<span class="sc">$</span>N<span class="sc">/</span>Y1)</span>
<span id="cb46-85"><a href="#cb46-85" aria-hidden="true" tabindex="-1"></a>    prob <span class="ot">&lt;-</span> <span class="fu">prod</span>(frac)}</span>
<span id="cb46-86"><a href="#cb46-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob)}</span>
<span id="cb46-87"><a href="#cb46-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-88"><a href="#cb46-88" aria-hidden="true" tabindex="-1"></a><span class="co">#P_01(1,t) under semi-Markov assumption</span></span>
<span id="cb46-89"><a href="#cb46-89" aria-hidden="true" tabindex="-1"></a>semi01 <span class="ot">&lt;-</span> <span class="cf">function</span>(end){</span>
<span id="cb46-90"><a href="#cb46-90" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> p00alpha01[, <span class="dv">1</span>][p00alpha01[, <span class="dv">1</span>] <span class="sc">&lt;=</span> end] <span class="co">#Times in (1,t] where alpha01 &gt; 0</span></span>
<span id="cb46-91"><a href="#cb46-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(u) <span class="sc">==</span> <span class="dv">0</span>){prob01 <span class="ot">&lt;-</span> <span class="dv">0</span>} <span class="co">#In case no one bleeds in interval (1,end]</span></span>
<span id="cb46-92"><a href="#cb46-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb46-93"><a href="#cb46-93" aria-hidden="true" tabindex="-1"></a>    p01 <span class="ot">&lt;-</span> p00alpha01[, <span class="dv">4</span>][p00alpha01[, <span class="dv">1</span>] <span class="sc">&lt;=</span> end] <span class="co">#Vector with P_00(1,u-)alpha(u)</span></span>
<span id="cb46-94"><a href="#cb46-94" aria-hidden="true" tabindex="-1"></a>    duration <span class="ot">&lt;-</span> (end <span class="sc">-</span> u) <span class="co">#Vector with duration in state 1</span></span>
<span id="cb46-95"><a href="#cb46-95" aria-hidden="true" tabindex="-1"></a>    p11 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(duration, p11_semi) <span class="co">#Vector with P_11(u,t)</span></span>
<span id="cb46-96"><a href="#cb46-96" aria-hidden="true" tabindex="-1"></a>    prob01 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p01<span class="sc">*</span>p11)} <span class="co"># P_00(1,u-)alpha(u)*P_11(u,t)</span></span>
<span id="cb46-97"><a href="#cb46-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob01)}</span>
<span id="cb46-98"><a href="#cb46-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-99"><a href="#cb46-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-100"><a href="#cb46-100" aria-hidden="true" tabindex="-1"></a><span class="co"># P01(1,t) WITH A PIECEWISE CONSTANT EFFECT OF WAIT (0-5 days, 5-10 days, +10 days) </span></span>
<span id="cb46-101"><a href="#cb46-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-102"><a href="#cb46-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating new data for estimation with piecewise constant effect of duration in state 1</span></span>
<span id="cb46-103"><a href="#cb46-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Splitting data set at wait &lt; 5 days, wait \in [5,10) days and wait &lt;=10 days</span></span>
<span id="cb46-104"><a href="#cb46-104" aria-hidden="true" tabindex="-1"></a>data_pcw <span class="ot">&lt;-</span> <span class="fu">survSplit</span>(<span class="fu">Surv</span>(wait, death) <span class="sc">~</span> ., <span class="at">data =</span> prova[bleed <span class="sc">==</span><span class="dv">1</span>], <span class="at">episode =</span> <span class="st">"time_interval"</span>, <span class="at">cut =</span> <span class="fu">c</span>((<span class="dv">5</span><span class="fl">-0.00001</span>),(<span class="dv">10</span><span class="fl">-0.00001</span>)))</span>
<span id="cb46-105"><a href="#cb46-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Making +10days reference</span></span>
<span id="cb46-106"><a href="#cb46-106" aria-hidden="true" tabindex="-1"></a>data_pcw<span class="sc">$</span>time_interval[data_pcw<span class="sc">$</span>time_interval <span class="sc">==</span> <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb46-107"><a href="#cb46-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Resetting start and end points of interval</span></span>
<span id="cb46-108"><a href="#cb46-108" aria-hidden="true" tabindex="-1"></a>data_pcw<span class="sc">$</span>bleed_time <span class="ot">&lt;-</span> data_pcw<span class="sc">$</span>tstart <span class="sc">+</span> data_pcw<span class="sc">$</span>timebleed</span>
<span id="cb46-109"><a href="#cb46-109" aria-hidden="true" tabindex="-1"></a>data_pcw<span class="sc">$</span>death_time <span class="ot">&lt;-</span> data_pcw<span class="sc">$</span>wait <span class="sc">+</span> data_pcw<span class="sc">$</span>timebleed</span>
<span id="cb46-110"><a href="#cb46-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-111"><a href="#cb46-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model</span></span>
<span id="cb46-112"><a href="#cb46-112" aria-hidden="true" tabindex="-1"></a>cox_pcw <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(bleed_time, death_time, death) <span class="sc">~</span> <span class="fu">factor</span>(time_interval), <span class="at">data=</span> data_pcw, <span class="at">ties =</span> <span class="st">"breslow"</span>) </span>
<span id="cb46-113"><a href="#cb46-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-114"><a href="#cb46-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated betas</span></span>
<span id="cb46-115"><a href="#cb46-115" aria-hidden="true" tabindex="-1"></a>beta_before5 <span class="ot">&lt;-</span> <span class="fu">summary</span>(cox_pcw)<span class="sc">$</span>coefficients[<span class="dv">1</span>] <span class="co"># &lt;5 days</span></span>
<span id="cb46-116"><a href="#cb46-116" aria-hidden="true" tabindex="-1"></a>beta_5to10 <span class="ot">&lt;-</span> <span class="fu">summary</span>(cox_pcw)<span class="sc">$</span>coefficients[<span class="dv">2</span>] <span class="co"># [5,10) days</span></span>
<span id="cb46-117"><a href="#cb46-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-118"><a href="#cb46-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline cumulative hazard, i.e. for +10 days</span></span>
<span id="cb46-119"><a href="#cb46-119" aria-hidden="true" tabindex="-1"></a>cumhaz_pcw_table <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),<span class="fu">basehaz</span>(cox_pcw, <span class="at">centered =</span> <span class="cn">FALSE</span>)) </span>
<span id="cb46-120"><a href="#cb46-120" aria-hidden="true" tabindex="-1"></a>cumhaz_pcw <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb46-121"><a href="#cb46-121" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">tail</span>(cumhaz_pcw_table[<span class="fu">which</span>(cumhaz_pcw_table<span class="sc">$</span>time <span class="sc">&lt;=</span> t), ]<span class="sc">$</span>hazard, <span class="at">n =</span> <span class="dv">1</span>)</span>
<span id="cb46-122"><a href="#cb46-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x)}</span>
<span id="cb46-123"><a href="#cb46-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-124"><a href="#cb46-124" aria-hidden="true" tabindex="-1"></a><span class="co"># P_11(s,t) for Cox model with piecewise constant effect of wait</span></span>
<span id="cb46-125"><a href="#cb46-125" aria-hidden="true" tabindex="-1"></a>prob11_pcw <span class="ot">&lt;-</span> <span class="cf">function</span>(start,end){</span>
<span id="cb46-126"><a href="#cb46-126" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (end <span class="sc">-</span> start <span class="sc">&lt;</span> <span class="dv">5</span>){ <span class="co">#duration in state 1 for (0,5) days</span></span>
<span id="cb46-127"><a href="#cb46-127" aria-hidden="true" tabindex="-1"></a>    haz <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta_before5)<span class="sc">*</span>(<span class="fu">cumhaz_pcw</span>(end) <span class="sc">-</span> <span class="fu">cumhaz_pcw</span>(start))}</span>
<span id="cb46-128"><a href="#cb46-128" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span> ((end <span class="sc">-</span> start <span class="sc">&gt;=</span> <span class="dv">5</span>) <span class="sc">&amp;</span> (end <span class="sc">-</span> start  <span class="sc">&lt;</span> <span class="dv">10</span>)){ <span class="co">#duration in state 1 for [5,10) days</span></span>
<span id="cb46-129"><a href="#cb46-129" aria-hidden="true" tabindex="-1"></a>    haz_to5 <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta_before5)<span class="sc">*</span>(<span class="fu">cumhaz_pcw</span>(start <span class="sc">+</span> <span class="dv">5</span> <span class="sc">-</span> <span class="fl">0.000001</span>) <span class="sc">-</span> <span class="fu">cumhaz_pcw</span>(start))</span>
<span id="cb46-130"><a href="#cb46-130" aria-hidden="true" tabindex="-1"></a>    haz_5to_end <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta_5to10)<span class="sc">*</span>(<span class="fu">cumhaz_pcw</span>(end) <span class="sc">-</span> <span class="fu">cumhaz_pcw</span>(start <span class="sc">+</span> <span class="dv">5</span>))</span>
<span id="cb46-131"><a href="#cb46-131" aria-hidden="true" tabindex="-1"></a>    haz <span class="ot">&lt;-</span> haz_to5 <span class="sc">+</span> haz_5to_end}</span>
<span id="cb46-132"><a href="#cb46-132" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> { <span class="co">#duration in state 1 longer than 10 days</span></span>
<span id="cb46-133"><a href="#cb46-133" aria-hidden="true" tabindex="-1"></a>    haz_to5 <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta_before5)<span class="sc">*</span>(<span class="fu">cumhaz_pcw</span>(start <span class="sc">+</span> <span class="dv">5</span> <span class="sc">-</span> <span class="fl">0.000001</span>) <span class="sc">-</span> <span class="fu">cumhaz_pcw</span>(start))</span>
<span id="cb46-134"><a href="#cb46-134" aria-hidden="true" tabindex="-1"></a>    haz_5to10 <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta_5to10)<span class="sc">*</span>(<span class="fu">cumhaz_pcw</span>(start <span class="sc">+</span> <span class="dv">10</span> <span class="sc">-</span> <span class="fl">0.000001</span>) <span class="sc">-</span> <span class="fu">cumhaz_pcw</span>(start <span class="sc">+</span> <span class="dv">5</span>))</span>
<span id="cb46-135"><a href="#cb46-135" aria-hidden="true" tabindex="-1"></a>    haz_plus10 <span class="ot">&lt;-</span> (<span class="fu">cumhaz_pcw</span>(end) <span class="sc">-</span> <span class="fu">cumhaz_pcw</span>(start <span class="sc">+</span> <span class="dv">10</span>))</span>
<span id="cb46-136"><a href="#cb46-136" aria-hidden="true" tabindex="-1"></a>    haz <span class="ot">&lt;-</span> haz_to5 <span class="sc">+</span> haz_5to10 <span class="sc">+</span> haz_plus10}</span>
<span id="cb46-137"><a href="#cb46-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">exp</span>(<span class="sc">-</span>haz))}</span>
<span id="cb46-138"><a href="#cb46-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-139"><a href="#cb46-139" aria-hidden="true" tabindex="-1"></a><span class="co">#P_01(1,t) with t as baseline and piece-wise constant effect of wait</span></span>
<span id="cb46-140"><a href="#cb46-140" aria-hidden="true" tabindex="-1"></a>pcw01 <span class="ot">&lt;-</span> <span class="cf">function</span>(end){</span>
<span id="cb46-141"><a href="#cb46-141" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> p00alpha01[, <span class="dv">1</span>][p00alpha01[, <span class="dv">1</span>] <span class="sc">&lt;=</span> end] <span class="co">#Times in (1,t] where alpha01 &gt; 0</span></span>
<span id="cb46-142"><a href="#cb46-142" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(u) <span class="sc">==</span> <span class="dv">0</span>){prob01 <span class="ot">&lt;-</span> <span class="dv">0</span>} <span class="co">#In case no one bleeds in interval (start,end]</span></span>
<span id="cb46-143"><a href="#cb46-143" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb46-144"><a href="#cb46-144" aria-hidden="true" tabindex="-1"></a>    p01 <span class="ot">&lt;-</span> p00alpha01[, <span class="dv">4</span>][p00alpha01[, <span class="dv">1</span>] <span class="sc">&lt;=</span> end] <span class="co"># P_00(s,u-)alpha01(u)</span></span>
<span id="cb46-145"><a href="#cb46-145" aria-hidden="true" tabindex="-1"></a>    p11 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(u, prob11_pcw, <span class="at">end =</span> end) <span class="co">#P_11(u,t)</span></span>
<span id="cb46-146"><a href="#cb46-146" aria-hidden="true" tabindex="-1"></a>    prob01 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p01<span class="sc">*</span>p11)} <span class="co"># P_00(s,u-)alpha01(u)*P_11(u,t)</span></span>
<span id="cb46-147"><a href="#cb46-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob01)}</span>
<span id="cb46-148"><a href="#cb46-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-149"><a href="#cb46-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-150"><a href="#cb46-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-151"><a href="#cb46-151" aria-hidden="true" tabindex="-1"></a><span class="co"># P01(1,t) LINEAR EFFECT OF WAIT ###############################################</span></span>
<span id="cb46-152"><a href="#cb46-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-153"><a href="#cb46-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model with linear effect of duration in state 1 as time-dependent covariat</span></span>
<span id="cb46-154"><a href="#cb46-154" aria-hidden="true" tabindex="-1"></a>cox_lwe <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(timebleed, timedeath, death) <span class="sc">~</span> <span class="fu">tt</span>(timebleed), <span class="at">tt =</span> <span class="cf">function</span>(x,t, ...) t <span class="sc">-</span> x, <span class="at">data =</span> prova[bleed <span class="sc">==</span><span class="dv">1</span>], <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb46-155"><a href="#cb46-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-156"><a href="#cb46-156" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimated value of beta</span></span>
<span id="cb46-157"><a href="#cb46-157" aria-hidden="true" tabindex="-1"></a>beta_lwe <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(cox_lwe)[<span class="dv">1</span>]</span>
<span id="cb46-158"><a href="#cb46-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-159"><a href="#cb46-159" aria-hidden="true" tabindex="-1"></a><span class="co">#Breslow estimator</span></span>
<span id="cb46-160"><a href="#cb46-160" aria-hidden="true" tabindex="-1"></a>deaths_after_bleeding <span class="ot">&lt;-</span> prova[bleed <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> death <span class="sc">==</span><span class="dv">1</span>] <span class="co"># Subset of data only containing subjects with 1-&gt;2 transition</span></span>
<span id="cb46-161"><a href="#cb46-161" aria-hidden="true" tabindex="-1"></a>times12 <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(deaths_after_bleeding<span class="sc">$</span>timedeath)) <span class="co"># Time of 1-&gt;2 transition</span></span>
<span id="cb46-162"><a href="#cb46-162" aria-hidden="true" tabindex="-1"></a>haz_lw <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">length</span>(times12)) <span class="co"># Initializing vector for elements dN12(u)/sum(Y_i1(u)*exp(beta_hat*(u - T_01i)))</span></span>
<span id="cb46-163"><a href="#cb46-163" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(times12)){</span>
<span id="cb46-164"><a href="#cb46-164" aria-hidden="true" tabindex="-1"></a>  dN12 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">subset</span>(deaths_after_bleeding, timedeath <span class="sc">==</span> times12[i]))</span>
<span id="cb46-165"><a href="#cb46-165" aria-hidden="true" tabindex="-1"></a>  at_risk <span class="ot">&lt;-</span> prova[bleed <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> timebleed <span class="sc">&lt;</span> times12[i] <span class="sc">&amp;</span> timedeath <span class="sc">&gt;</span> (times12[i] <span class="sc">-</span> <span class="fl">0.000001</span>)]</span>
<span id="cb46-166"><a href="#cb46-166" aria-hidden="true" tabindex="-1"></a>  weighted_risk <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">exp</span>(beta_lwe<span class="sc">*</span>(times12[i] <span class="sc">-</span> at_risk<span class="sc">$</span>timebleed)))</span>
<span id="cb46-167"><a href="#cb46-167" aria-hidden="true" tabindex="-1"></a>  haz_lw[i] <span class="ot">&lt;-</span> dN12<span class="sc">/</span>weighted_risk}</span>
<span id="cb46-168"><a href="#cb46-168" aria-hidden="true" tabindex="-1"></a>breslow_table_lwe <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(times12, haz_lw))</span>
<span id="cb46-169"><a href="#cb46-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-170"><a href="#cb46-170" aria-hidden="true" tabindex="-1"></a><span class="co">#P_11(u,t|u) with linear effect of wait</span></span>
<span id="cb46-171"><a href="#cb46-171" aria-hidden="true" tabindex="-1"></a>prob11_lwe <span class="ot">&lt;-</span> <span class="cf">function</span>(start,end){</span>
<span id="cb46-172"><a href="#cb46-172" aria-hidden="true" tabindex="-1"></a>  alphas <span class="ot">&lt;-</span> breslow_table_lwe[<span class="fu">which</span>(breslow_table_lwe<span class="sc">$</span>times12 <span class="sc">&gt;</span> start <span class="sc">&amp;</span> breslow_table_lwe<span class="sc">$</span>times12 <span class="sc">&lt;=</span> end), ] <span class="co">#alpha12(x) &gt; 0 for x in (start,end]</span></span>
<span id="cb46-173"><a href="#cb46-173" aria-hidden="true" tabindex="-1"></a>  covariates <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta_lwe<span class="sc">*</span>(alphas<span class="sc">$</span>times12 <span class="sc">-</span> start)) <span class="co">#exp(beta_hat*(x - start))</span></span>
<span id="cb46-174"><a href="#cb46-174" aria-hidden="true" tabindex="-1"></a>  p11 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="fu">sum</span>(alphas<span class="sc">$</span>haz_lw<span class="sc">*</span>covariates)))</span>
<span id="cb46-175"><a href="#cb46-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p11)}</span>
<span id="cb46-176"><a href="#cb46-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-177"><a href="#cb46-177" aria-hidden="true" tabindex="-1"></a><span class="co">#P_01(1,t) with linear effect of wait</span></span>
<span id="cb46-178"><a href="#cb46-178" aria-hidden="true" tabindex="-1"></a>lw01 <span class="ot">&lt;-</span> <span class="cf">function</span>(end){</span>
<span id="cb46-179"><a href="#cb46-179" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> p00alpha01[, <span class="dv">1</span>][p00alpha01[, <span class="dv">1</span>] <span class="sc">&lt;=</span> end] <span class="co">#Times in (1,t] where alpha01 &gt; 0</span></span>
<span id="cb46-180"><a href="#cb46-180" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(u) <span class="sc">==</span> <span class="dv">0</span>){prob01 <span class="ot">&lt;-</span> <span class="dv">0</span>} <span class="co"># In case no one bleeds in interval (start,end]</span></span>
<span id="cb46-181"><a href="#cb46-181" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb46-182"><a href="#cb46-182" aria-hidden="true" tabindex="-1"></a>    p01 <span class="ot">&lt;-</span> p00alpha01[, <span class="dv">4</span>][p00alpha01[, <span class="dv">1</span>] <span class="sc">&lt;=</span> end] <span class="co"># P_00(s,u-)alpha01(u)</span></span>
<span id="cb46-183"><a href="#cb46-183" aria-hidden="true" tabindex="-1"></a>    p11 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(u, prob11_lwe, <span class="at">end =</span> end) <span class="co"># P_11(u,t)</span></span>
<span id="cb46-184"><a href="#cb46-184" aria-hidden="true" tabindex="-1"></a>    prob01 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p01<span class="sc">*</span>p11)} <span class="co"># P_00(s,u-)alpha01(u)*P_11(u,t)</span></span>
<span id="cb46-185"><a href="#cb46-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob01)}</span>
<span id="cb46-186"><a href="#cb46-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-187"><a href="#cb46-187" aria-hidden="true" tabindex="-1"></a><span class="co"># P01(1,t) DETAILED EFFECT OF WAIT #############################################</span></span>
<span id="cb46-188"><a href="#cb46-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-189"><a href="#cb46-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model with detailed effect of duration in state 1 (d) as covariate (d + d^2 + d^3 + log(d))</span></span>
<span id="cb46-190"><a href="#cb46-190" aria-hidden="true" tabindex="-1"></a>cox_dwe <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(timebleed, timedeath, death) <span class="sc">~</span> <span class="fu">tt</span>(timebleed), <span class="at">tt =</span> <span class="cf">function</span>(x,t, ...){</span>
<span id="cb46-191"><a href="#cb46-191" aria-hidden="true" tabindex="-1"></a>  dur <span class="ot">&lt;-</span> t <span class="sc">-</span> x</span>
<span id="cb46-192"><a href="#cb46-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">dur =</span> dur, <span class="at">dur2 =</span> dur<span class="sc">^</span><span class="dv">2</span>, <span class="at">dur3 =</span> dur<span class="sc">^</span><span class="dv">3</span>, <span class="at">logdur =</span> <span class="fu">log</span>(dur))}, <span class="at">data =</span> prova[bleed <span class="sc">==</span><span class="dv">1</span>], <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb46-193"><a href="#cb46-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-194"><a href="#cb46-194" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated values of beta</span></span>
<span id="cb46-195"><a href="#cb46-195" aria-hidden="true" tabindex="-1"></a>beta_wait <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">coefficients</span>(cox_dwe)[<span class="dv">1</span>])</span>
<span id="cb46-196"><a href="#cb46-196" aria-hidden="true" tabindex="-1"></a>beta_wait2 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">coefficients</span>(cox_dwe)[<span class="dv">2</span>])</span>
<span id="cb46-197"><a href="#cb46-197" aria-hidden="true" tabindex="-1"></a>beta_wait3 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">coefficients</span>(cox_dwe)[<span class="dv">3</span>])</span>
<span id="cb46-198"><a href="#cb46-198" aria-hidden="true" tabindex="-1"></a>beta_logwait <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">coefficients</span>(cox_dwe)[<span class="dv">4</span>])</span>
<span id="cb46-199"><a href="#cb46-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-200"><a href="#cb46-200" aria-hidden="true" tabindex="-1"></a><span class="co">#Breslow estimator, table</span></span>
<span id="cb46-201"><a href="#cb46-201" aria-hidden="true" tabindex="-1"></a>haz_dw <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">length</span>(times12)) <span class="co">#initializing vector for elements dN12(u)/sum(Y_i1(u)*exp(beta_wait*(u - T_01i) + beta_wait2*(u - T_01i)^2 + beta_wait3*(u - T_01i)^3 + beta_logwait*log(u-T_01i)))</span></span>
<span id="cb46-202"><a href="#cb46-202" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(times12)){</span>
<span id="cb46-203"><a href="#cb46-203" aria-hidden="true" tabindex="-1"></a>  dN12 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">subset</span>(deaths_after_bleeding, timedeath <span class="sc">==</span> times12[i])) <span class="co">#number of 1-&gt;2 at times12[i]</span></span>
<span id="cb46-204"><a href="#cb46-204" aria-hidden="true" tabindex="-1"></a>  at_risk <span class="ot">&lt;-</span> prova[bleed <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> timebleed <span class="sc">&lt;</span> times12[i] <span class="sc">&amp;</span> timedeath <span class="sc">&gt;</span> (times12[i] <span class="sc">-</span> <span class="fl">0.00001</span>)] <span class="co">#patients at risk of dying in state 1 at times12[i]-</span></span>
<span id="cb46-205"><a href="#cb46-205" aria-hidden="true" tabindex="-1"></a>  weighted_risk <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">exp</span>(beta_wait<span class="sc">*</span>(times12[i] <span class="sc">-</span> at_risk<span class="sc">$</span>timebleed) <span class="sc">+</span> beta_wait2<span class="sc">*</span>(times12[i] <span class="sc">-</span> at_risk<span class="sc">$</span>timebleed)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> beta_wait3<span class="sc">*</span>(times12[i] <span class="sc">-</span> at_risk<span class="sc">$</span>timebleed)<span class="sc">^</span><span class="dv">3</span> <span class="sc">+</span> beta_logwait<span class="sc">*</span><span class="fu">log</span>(times12[i] <span class="sc">-</span> at_risk<span class="sc">$</span>timebleed)))</span>
<span id="cb46-206"><a href="#cb46-206" aria-hidden="true" tabindex="-1"></a>  haz_dw[i] <span class="ot">&lt;-</span> dN12<span class="sc">/</span>weighted_risk}</span>
<span id="cb46-207"><a href="#cb46-207" aria-hidden="true" tabindex="-1"></a>breslow_table_dwe <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(times12, haz_dw))</span>
<span id="cb46-208"><a href="#cb46-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-209"><a href="#cb46-209" aria-hidden="true" tabindex="-1"></a><span class="co">#P_11(s,t|s) with wait effect for person bleeding at time s</span></span>
<span id="cb46-210"><a href="#cb46-210" aria-hidden="true" tabindex="-1"></a>prob11_dwe <span class="ot">&lt;-</span> <span class="cf">function</span>(start,end){</span>
<span id="cb46-211"><a href="#cb46-211" aria-hidden="true" tabindex="-1"></a>  alphas <span class="ot">&lt;-</span> breslow_table_dwe[<span class="fu">which</span>(breslow_table_dwe<span class="sc">$</span>times12 <span class="sc">&lt;=</span> end <span class="sc">&amp;</span> breslow_table_dwe<span class="sc">$</span>times12 <span class="sc">&gt;</span> start), ] <span class="co">#alpha12(u) &gt; 0 for x in (start, end)</span></span>
<span id="cb46-212"><a href="#cb46-212" aria-hidden="true" tabindex="-1"></a>  covariates <span class="ot">&lt;-</span> <span class="fu">exp</span>(beta_wait<span class="sc">*</span>(alphas<span class="sc">$</span>times12 <span class="sc">-</span> start) <span class="sc">+</span> beta_wait2<span class="sc">*</span>((alphas<span class="sc">$</span>times12 <span class="sc">-</span> start)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> beta_wait3<span class="sc">*</span>((alphas<span class="sc">$</span>times12 <span class="sc">-</span> start)<span class="sc">^</span><span class="dv">3</span>) <span class="sc">+</span> beta_logwait<span class="sc">*</span><span class="fu">log</span>(alphas<span class="sc">$</span>times12 <span class="sc">-</span> start)) <span class="co">#exp(beta_wait*(x - start) + beta_wait2(x-start)^2 + beta_wait3(x-start)^3 + beta_logwait*log(x - start))</span></span>
<span id="cb46-213"><a href="#cb46-213" aria-hidden="true" tabindex="-1"></a>  p11 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>(<span class="fu">sum</span>(alphas<span class="sc">$</span>haz_dw<span class="sc">*</span>covariates)))</span>
<span id="cb46-214"><a href="#cb46-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p11)}</span>
<span id="cb46-215"><a href="#cb46-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-216"><a href="#cb46-216" aria-hidden="true" tabindex="-1"></a><span class="co">#P_01(s,t) with detailed effect of wait</span></span>
<span id="cb46-217"><a href="#cb46-217" aria-hidden="true" tabindex="-1"></a>dw01 <span class="ot">&lt;-</span> <span class="cf">function</span>(end){</span>
<span id="cb46-218"><a href="#cb46-218" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> p00alpha01[, <span class="dv">1</span>][p00alpha01[, <span class="dv">1</span>] <span class="sc">&lt;=</span> end]</span>
<span id="cb46-219"><a href="#cb46-219" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(u) <span class="sc">==</span> <span class="dv">0</span>){prob01 <span class="ot">&lt;-</span> <span class="dv">0</span>} <span class="co">#In case no one bleeds in interval (start,end]</span></span>
<span id="cb46-220"><a href="#cb46-220" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb46-221"><a href="#cb46-221" aria-hidden="true" tabindex="-1"></a>    p01 <span class="ot">&lt;-</span> p00alpha01[, <span class="dv">4</span>][p00alpha01[, <span class="dv">1</span>] <span class="sc">&lt;=</span> end] <span class="co">#P_00(s,u-)alpha01(u)</span></span>
<span id="cb46-222"><a href="#cb46-222" aria-hidden="true" tabindex="-1"></a>    p11 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(u, prob11_dwe, <span class="at">end =</span> end) <span class="co">#P_11(u,t)</span></span>
<span id="cb46-223"><a href="#cb46-223" aria-hidden="true" tabindex="-1"></a>    prob01 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p01<span class="sc">*</span>p11)}</span>
<span id="cb46-224"><a href="#cb46-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob01)}</span>
<span id="cb46-225"><a href="#cb46-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-226"><a href="#cb46-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimation of transition probabilities under Markov assumption</span></span>
<span id="cb46-227"><a href="#cb46-227" aria-hidden="true" tabindex="-1"></a><span class="co"># (AaJ1 &lt;- probtrans(msfit, predt = s1)[[1]]) #P(V(t) = 1 | V(1) = 0)</span></span>
<span id="cb46-228"><a href="#cb46-228" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb46-229"><a href="#cb46-229" aria-hidden="true" tabindex="-1"></a><span class="co"># # Estimation of transition probabilities with the Landmark Aalen-Johansen estimator</span></span>
<span id="cb46-230"><a href="#cb46-230" aria-hidden="true" tabindex="-1"></a><span class="co"># # Warning is not related to the estimate of pstate2</span></span>
<span id="cb46-231"><a href="#cb46-231" aria-hidden="true" tabindex="-1"></a><span class="co"># (LMAaJ1 &lt;- LMAJ(long_format, s = s1, from = 1)) #P(V(t) = 1 | V(1) = 0)</span></span>
<span id="cb46-232"><a href="#cb46-232" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb46-233"><a href="#cb46-233" aria-hidden="true" tabindex="-1"></a><span class="co"># # Data for estimation of transition probabilities, from s =1</span></span>
<span id="cb46-234"><a href="#cb46-234" aria-hidden="true" tabindex="-1"></a><span class="co"># time_in_days &lt;- seq(from = s1, to = 1508, by = 0.8)</span></span>
<span id="cb46-235"><a href="#cb46-235" aria-hidden="true" tabindex="-1"></a><span class="co"># pstate2_pepe &lt;- sapply(time_in_days, pepe01_s1)</span></span>
<span id="cb46-236"><a href="#cb46-236" aria-hidden="true" tabindex="-1"></a><span class="co"># pstate2_titman &lt;- sapply(time_in_days, titman01_s1)</span></span>
<span id="cb46-237"><a href="#cb46-237" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb46-238"><a href="#cb46-238" aria-hidden="true" tabindex="-1"></a><span class="co"># # Making a data frame</span></span>
<span id="cb46-239"><a href="#cb46-239" aria-hidden="true" tabindex="-1"></a><span class="co"># pepe_data &lt;- as.data.frame(cbind(time_in_days, pstate2_pepe, "LM Pepe"))</span></span>
<span id="cb46-240"><a href="#cb46-240" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(pepe_data) &lt;- c("time", "p01", "estimator")</span></span>
<span id="cb46-241"><a href="#cb46-241" aria-hidden="true" tabindex="-1"></a><span class="co"># titman_data &lt;- as.data.frame(cbind(time_in_days, pstate2_titman, "LM Titman"))</span></span>
<span id="cb46-242"><a href="#cb46-242" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(titman_data) &lt;- c("time", "p01", "estimator")</span></span>
<span id="cb46-243"><a href="#cb46-243" aria-hidden="true" tabindex="-1"></a><span class="co"># AaJ_data &lt;- as.data.frame(cbind(AaJ1$time, AaJ1$pstate2, "AaJ"))</span></span>
<span id="cb46-244"><a href="#cb46-244" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(AaJ_data) &lt;- c("time", "p01", "estimator")</span></span>
<span id="cb46-245"><a href="#cb46-245" aria-hidden="true" tabindex="-1"></a><span class="co"># LMAaJ_data &lt;- as.data.frame(cbind(LMAaJ1$time, LMAaJ1$pstate2, "LM AaJ"))</span></span>
<span id="cb46-246"><a href="#cb46-246" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(LMAaJ_data) &lt;- c("time", "p01", "estimator")</span></span>
<span id="cb46-247"><a href="#cb46-247" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb46-248"><a href="#cb46-248" aria-hidden="true" tabindex="-1"></a><span class="co"># data_LMs1 &lt;- as.data.frame(rbind(AaJ_data, LMAaJ_data, pepe_data, titman_data))</span></span>
<span id="cb46-249"><a href="#cb46-249" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(data_LMs1) &lt;- c("time","p01","estimator")</span></span>
<span id="cb46-250"><a href="#cb46-250" aria-hidden="true" tabindex="-1"></a><span class="co"># data_LMs1$time &lt;- as.numeric(data_LMs1$time)</span></span>
<span id="cb46-251"><a href="#cb46-251" aria-hidden="true" tabindex="-1"></a><span class="co"># data_LMs1$p01 &lt;- as.numeric(data_LMs1$p01)</span></span>
<span id="cb46-252"><a href="#cb46-252" aria-hidden="true" tabindex="-1"></a><span class="co"># data_LMs1$estimator &lt;- factor(data_LMs1$estimator, levels = c("AaJ", "LM AaJ", "LM Pepe", "LM Titman"))</span></span>
<span id="cb46-253"><a href="#cb46-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-254"><a href="#cb46-254" aria-hidden="true" tabindex="-1"></a>data_LMs1 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/datafig58.csv"</span>)</span>
<span id="cb46-255"><a href="#cb46-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-256"><a href="#cb46-256" aria-hidden="true" tabindex="-1"></a><span class="do">### Figure 5.8 </span></span>
<span id="cb46-257"><a href="#cb46-257" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.8</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data_LMs1,<span class="fu">aes</span>(<span class="at">x =</span> time<span class="sc">/</span><span class="fl">365.25</span>, <span class="at">y =</span> p01, <span class="at">linetype =</span> estimator)) <span class="sc">+</span> </span>
<span id="cb46-258"><a href="#cb46-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb46-259"><a href="#cb46-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span></span>
<span id="cb46-260"><a href="#cb46-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability"</span>) <span class="sc">+</span> </span>
<span id="cb46-261"><a href="#cb46-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> <span class="fu">border</span>(<span class="at">size =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb46-262"><a href="#cb46-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(),<span class="at">limits =</span> <span class="fu">c</span>(<span class="fl">0.94</span>,<span class="fl">4.2</span>)) <span class="sc">+</span>  </span>
<span id="cb46-263"><a href="#cb46-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">linetype=</span>estimator) <span class="sc">+</span> </span>
<span id="cb46-264"><a href="#cb46-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"dashed"</span>, <span class="st">"dotted"</span>, <span class="st">"dotdash"</span>)) <span class="sc">+</span></span>
<span id="cb46-265"><a href="#cb46-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">linetype=</span><span class="st">"Estimator"</span>) <span class="sc">+</span></span>
<span id="cb46-266"><a href="#cb46-266" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb46-267"><a href="#cb46-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">2</span>,<span class="st">"cm"</span>),</span>
<span id="cb46-268"><a href="#cb46-268" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title=</span><span class="fu">element_blank</span>(),</span>
<span id="cb46-269"><a href="#cb46-269" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) <span class="sc">+</span> </span>
<span id="cb46-270"><a href="#cb46-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>))</span>
<span id="cb46-271"><a href="#cb46-271" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.8-r-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.9" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.9">Figure 5.9</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-14-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-1" role="tab" aria-controls="tabset-14-1" aria-selected="true">R</a></li></ul>
<div class="tab-content">
<div id="tabset-14-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-14-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.9-r_490e8cfaa6af085632f0d509f267e5b7">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating data frame</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># pstate2_semi &lt;- sapply(time_in_days, semi01)</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># pstate2_tbase_pcwe &lt;- sapply(time_in_days, pcw01)</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># pstate2_tbase_lwe &lt;- sapply(time_in_days, lw01)</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co"># pstate2_tbase_dwe &lt;- sapply(time_in_days, dw01)</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co"># semi_data &lt;- as.data.frame(cbind(time_in_days, pstate2_semi, "Semi"))</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(semi_data) &lt;- c("time", "p01", "estimator")</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co"># tbase_pcwe_data &lt;- as.data.frame(cbind(time_in_days,pstate2_tbase_pcwe, "PWCD"))</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(tbase_pcwe_data) &lt;- c("time", "p01", "estimator")</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co"># tbase_lwe_data &lt;- as.data.frame(cbind(time_in_days, pstate2_tbase_lwe, "LD"))</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(tbase_lwe_data) &lt;- c("time", "p01", "estimator")</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="co"># tbase_dwe_data &lt;- as.data.frame(cbind(time_in_days, pstate2_tbase_dwe, "FPD"))</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(tbase_dwe_data) &lt;- c("time", "p01", "estimator")</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co"># data_dur1 &lt;- as.data.frame(rbind(AaJ_data, LMAaJ_data, semi_data, tbase_pcwe_data, tbase_lwe_data, tbase_dwe_data))</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="co"># colnames(data_dur1) &lt;- c("time","p01","estimator")</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co"># data_dur1$time &lt;- as.numeric(data_dur1$time)</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="co"># data_dur1$p01 &lt;- as.numeric(data_dur1$p01)</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="co"># data_dur1$estimator &lt;- factor(data_dur1$estimator, levels = c("AaJ", "LM AaJ", "Semi", "PWCD", "LD", "FPD"))</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>data_dur1 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/datafig59.csv"</span>)</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.9</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data_dur1,<span class="fu">aes</span>(<span class="at">x =</span> time<span class="sc">/</span><span class="fl">365.25</span>, <span class="at">y =</span> p01, <span class="at">linetype =</span> estimator)) <span class="sc">+</span> </span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability"</span>) <span class="sc">+</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(),<span class="at">limits =</span> <span class="fu">c</span>(<span class="fl">0.94</span>,<span class="fl">4.2</span>)) <span class="sc">+</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">linetype=</span>estimator) <span class="sc">+</span> </span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"twodash"</span>, <span class="st">"dotted"</span>, <span class="st">"longdash"</span>, <span class="st">"dotdash"</span>, <span class="st">"dashed"</span>)) <span class="sc">+</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">linetype=</span><span class="st">"Estimator"</span>) <span class="sc">+</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">3</span>,<span class="st">"cm"</span>),</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title=</span><span class="fu">element_blank</span>(),</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) <span class="sc">+</span> </span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>))</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.9</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.9-r-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="leader-cardiovascular-trial-in-type-2-diabetes" class="level2">
<h2 class="anchored" data-anchor-id="leader-cardiovascular-trial-in-type-2-diabetes">LEADER cardiovascular trial in type 2 diabetes</h2>
<section id="section-5.8.3-p.-213-mao-lin-models" class="level3">
<h3 class="anchored" data-anchor-id="section-5.8.3-p.-213-mao-lin-models">Section 5.8.3, p.&nbsp;213: Mao-Lin models</h3>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-22_e2da9d663d0b8c4f4d6e52ba5841165f">

</div>
<p>Assume that the LEADER data sets are loaded.</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-15-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-1" role="tab" aria-controls="tabset-15-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-15-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-2" role="tab" aria-controls="tabset-15-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-15-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-15-1-tab">
<div class="cell" data-hash="Ch5_cache/html/leader-r_0efb7d3862712dae65ab387fcce1179d">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">contrasts=</span><span class="fu">c</span>(<span class="st">"contr.treatment"</span>, <span class="st">"contr.poly"</span>))</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Mao-Lin model for recurrent MI+death </span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>fitML_mi <span class="ot">&lt;-</span> <span class="fu">recreg</span>(<span class="fu">Event</span>(start, stop, status) <span class="sc">~</span> <span class="fu">factor</span>(treat) <span class="sc">+</span> <span class="fu">cluster</span>(id),</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> leader_mi, <span class="at">cause =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">cens.code =</span> <span class="dv">0</span>, <span class="at">death.code =</span> <span class="dv">2</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fitML_mi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
     n events
 10120   1608

 9340 clusters
coeffients:
                Estimate      S.E.   dU^-1/2 P-value
factor(treat)1 -0.159017  0.057101  0.050035  0.0054

exp(coeffients):
               Estimate    2.5% 97.5%
factor(treat)1  0.85298 0.76267 0.954</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mao-Lin model and non-CV deaths incorrectly treated as censoring </span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>fit_3pCENS <span class="ot">&lt;-</span> <span class="fu">recreg</span>(<span class="fu">Event</span>(start, stop, status) <span class="sc">~</span> treat <span class="sc">+</span> <span class="fu">cluster</span>(id),</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> leader_3p, <span class="at">cause =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">cens.code =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">4</span>), <span class="at">death.code =</span> <span class="dv">3</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_3pCENS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
     n events
 10534   1691

 9340 clusters
coeffients:
       Estimate      S.E.   dU^-1/2 P-value
treat -0.182635  0.059023  0.048842   0.002

exp(coeffients):
      Estimate    2.5%  97.5%
treat  0.83307 0.74207 0.9352</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mao-Lin model for 3p-MACE and non-CV deaths treated as competing risks</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>fit_3pCR <span class="ot">&lt;-</span> <span class="fu">recreg</span>(<span class="fu">Event</span>(start, stop, status) <span class="sc">~</span> treat <span class="sc">+</span> <span class="fu">cluster</span>(id),</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> leader_3p, <span class="at">cause =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">cens.code =</span> <span class="dv">0</span>, <span class="at">death.code =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>))</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_3pCR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
     n events
 10534   1691

 9340 clusters
coeffients:
       Estimate      S.E.   dU^-1/2 P-value
treat -0.183390  0.058979  0.048842  0.0019

exp(coeffients):
      Estimate    2.5%  97.5%
treat  0.83244 0.74157 0.9345</code></pre>
</div>
</div>
</div>
<div id="tabset-15-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-15-2-tab">
<div class="cell" data-hash="Ch5_cache/html/leader-sas_67e3e306af2d7ea25e5d9f12e9c56cbe">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">* recurrent MI+death;</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> mi; </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> leader_mi;</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    event=status <span class="kw">in</span> (<span class="dv">1</span> <span class="dv">2</span>);</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">output</span>;</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> status=<span class="dv">2</span> <span class="kw">then do</span>;</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>        event=<span class="dv">2</span>;</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    start=<span class="kw">stop</span>;</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">stop</span>=<span class="kw">stop</span><span class="dv">+0.5</span>;</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">output</span>;</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co">* Mao-Lin model for recurrent MI+death ;</span> </span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=mi covs(aggregate);</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> (start, <span class="kw">stop</span>)*event(<span class="dv">0</span>) = treat / eventcode=<span class="dv">1</span> rl  convergelike=<span class="dv">1E-9</span>; </span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  id id;</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="co">* recurrent 3p-MACE non-CV deaths incorrectly treated as censoring;</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> macecens; </span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> leader_3p;</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    event=status <span class="kw">in</span> (<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>);</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> status=<span class="dv">4</span> <span class="kw">then</span> event=<span class="dv">0</span>;</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">output</span>;</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> status=<span class="dv">3</span> <span class="kw">then do</span>;</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>        event=<span class="dv">2</span>;</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    start=<span class="kw">stop</span>;</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">stop</span>=<span class="kw">stop</span><span class="dv">+0.5</span>;</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">output</span>;</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="co">* Mao-Lin model and non-CV deaths incorrectly treated as censoring;</span> </span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=macecens covs(aggregate);</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> (start, <span class="kw">stop</span>)*event(<span class="dv">0</span>) = treat / eventcode=<span class="dv">1</span> rl  convergelike=<span class="dv">1E-9</span>; </span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>  id id;</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a><span class="co">* recurrent 3p-MACE;</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> mace; </span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> leader_3p;</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>    event=status <span class="kw">in</span> (<span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>);</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> status=<span class="dv">4</span> <span class="kw">then</span> event=<span class="dv">2</span>;</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">output</span>;</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> status=<span class="dv">3</span> <span class="kw">then do</span>;</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>        event=<span class="dv">2</span>;</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>    start=<span class="kw">stop</span>;</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">stop</span>=<span class="kw">stop</span><span class="dv">+0.5</span>;</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">output</span>;</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a><span class="co">* Mao-Lin model for 3p-MACE and non-CV deaths treated as competing risks;</span> </span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=mace covs(aggregate);</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> (start, <span class="kw">stop</span>)*event(<span class="dv">0</span>) = treat / eventcode=<span class="dv">1</span> rl convergelike=<span class="dv">1E-9</span>;</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>  id id;</span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="bone-marrow-transplantation-in-acute-leukemia" class="level2">
<h2 class="anchored" data-anchor-id="bone-marrow-transplantation-in-acute-leukemia">Bone marrow transplantation in acute leukemia</h2>
<!-- using Eva's saved data in temp for speed -->
<section id="read-data-1" class="level3">
<h3 class="anchored" data-anchor-id="read-data-1">Read data</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-16-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-1" role="tab" aria-controls="tabset-16-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-16-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-2" role="tab" aria-controls="tabset-16-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-16-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-16-1-tab">
<div class="cell" data-hash="Ch5_cache/html/read-bmt-r_c516e57ec66ff57398fe0d228cfc445d">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>bmt <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/bmt.csv"</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>intxsurv<span class="ot">&lt;-</span> bmt<span class="sc">$</span>timedeath</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>dead <span class="ot">&lt;-</span> bmt<span class="sc">$</span>death</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>intxrel <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>rel <span class="sc">==</span> <span class="dv">1</span>, bmt<span class="sc">$</span>timerel, bmt<span class="sc">$</span>timedeath)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>trm     <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>rel <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> bmt<span class="sc">$</span>death <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>tgvhd   <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>gvhd <span class="sc">==</span> <span class="dv">1</span>, bmt<span class="sc">$</span>timegvhd, bmt<span class="sc">$</span>intxrel)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>tanc500 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>anc500 <span class="sc">==</span> <span class="dv">1</span>, bmt<span class="sc">$</span>timeanc500, bmt<span class="sc">$</span>intxrel)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>state0  <span class="ot">&lt;-</span> bmt<span class="sc">$</span>rel <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>bmt<span class="sc">$</span>trm</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>dytxanc5 <span class="ot">&lt;-</span> bmt<span class="sc">$</span>timeanc500 <span class="sc">*</span> <span class="dv">30</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-16-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-16-2-tab">
<div class="cell" data-hash="Ch5_cache/html/read-bmt-sas_38a2715713e46822bf2f9f63722cb2a2">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> import out=bmt</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    datafile=<span class="st">"data/bmt.csv"</span> </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    dbms=csv <span class="kw">replace</span>;</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> bmt; </span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> bmt;</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    intxsurv=timedeath;</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    dead=death;</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> rel=<span class="dv">1</span> <span class="kw">then</span> intxrel=timerel;</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> rel=<span class="dv">0</span> <span class="kw">then</span> intxrel=timedeath;</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    trm=<span class="dv">0</span>;</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> rel=<span class="dv">0</span> <span class="kw">and</span> death=<span class="dv">1</span> <span class="kw">then</span> trm=<span class="dv">1</span>;</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    state0=rel+<span class="dv">2</span>*trm;</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> gvhd=<span class="dv">1</span> <span class="kw">then</span> tgvhd=timegvhd;</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> gvhd=<span class="dv">0</span> <span class="kw">then</span> tgvhd=intxrel;</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    dytxanc5=timeanc500*<span class="dv">30</span>; </span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-5.1" class="level3">
<h3 class="anchored" data-anchor-id="table-5.1">Table 5.1</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-17-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-1" role="tab" aria-controls="tabset-17-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-17-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-2" role="tab" aria-controls="tabset-17-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-17-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-17-1-tab">
<div class="cell" data-hash="Ch5_cache/html/table-5.1-r_4097f14d477c6f3da19fa2c9fefb4d77">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make landmark data at 0.5, 1, 1.5, 2, 2.5</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(dplyr)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>dat05 <span class="ot">&lt;-</span> bmt</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>dat05 <span class="ot">&lt;-</span> <span class="fu">subset</span>(bmt, intxrel <span class="sc">&gt;=</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">pmin</span>(intxrel, <span class="fl">6.5</span>),</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">status =</span> <span class="fu">ifelse</span>(time <span class="sc">&lt;</span> <span class="fl">6.5</span>, state0, <span class="dv">0</span>),</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">landmark =</span> <span class="fl">0.5</span>,</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">entry =</span> <span class="fl">0.5</span>,</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">anc =</span> <span class="fu">ifelse</span>(anc500 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timeanc500 <span class="sc">&lt;=</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvh =</span> <span class="fu">ifelse</span>(gvhd <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> tgvhd <span class="sc">&lt;=</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co"># dat05</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>dat10 <span class="ot">&lt;-</span> bmt</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>dat10 <span class="ot">&lt;-</span> <span class="fu">subset</span>(bmt, intxrel <span class="sc">&gt;=</span> <span class="fl">1.0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">pmin</span>(intxrel, <span class="dv">7</span>),</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">status =</span> <span class="fu">ifelse</span>(time <span class="sc">&lt;</span> <span class="dv">7</span>, state0, <span class="dv">0</span>),</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">landmark =</span> <span class="fl">1.0</span>,</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">entry =</span> <span class="fl">1.0</span>,</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">anc =</span> <span class="fu">ifelse</span>(anc500 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timeanc500 <span class="sc">&lt;=</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvh =</span> <span class="fu">ifelse</span>(gvhd <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> tgvhd <span class="sc">&lt;=</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>dat15 <span class="ot">&lt;-</span> bmt</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>dat15 <span class="ot">&lt;-</span> <span class="fu">subset</span>(bmt, intxrel <span class="sc">&gt;=</span> <span class="fl">1.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">pmin</span>(intxrel, <span class="fl">7.5</span>),</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">status =</span> <span class="fu">ifelse</span>(time <span class="sc">&lt;</span> <span class="fl">7.5</span>, state0, <span class="dv">0</span>),</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">landmark =</span> <span class="fl">1.5</span>,</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">entry =</span> <span class="fl">1.5</span>,</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">anc =</span> <span class="fu">ifelse</span>(anc500 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timeanc500 <span class="sc">&lt;=</span> <span class="fl">1.5</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvh =</span> <span class="fu">ifelse</span>(gvhd <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> tgvhd <span class="sc">&lt;=</span> <span class="fl">1.5</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>dat20 <span class="ot">&lt;-</span> bmt</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>dat20 <span class="ot">&lt;-</span> <span class="fu">subset</span>(bmt, intxrel <span class="sc">&gt;=</span> <span class="fl">2.0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">pmin</span>(intxrel, <span class="dv">8</span>),</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>         <span class="at">status =</span> <span class="fu">ifelse</span>(time <span class="sc">&lt;</span> <span class="dv">8</span>, state0, <span class="dv">0</span>),</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">landmark =</span> <span class="dv">2</span>,</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>         <span class="at">entry =</span> <span class="dv">2</span>,</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>         <span class="at">anc =</span> <span class="fu">ifelse</span>(anc500 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timeanc500 <span class="sc">&lt;=</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvh =</span> <span class="fu">ifelse</span>(gvhd <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> tgvhd <span class="sc">&lt;=</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>dat25 <span class="ot">&lt;-</span> bmt</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>dat25 <span class="ot">&lt;-</span> <span class="fu">subset</span>(bmt, intxrel <span class="sc">&gt;=</span> <span class="fl">2.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">pmin</span>(intxrel, <span class="fl">8.5</span>),</span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>         <span class="at">status =</span> <span class="fu">ifelse</span>(time <span class="sc">&lt;</span> <span class="fl">8.5</span>, state0, <span class="dv">0</span>),</span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">landmark =</span> <span class="fl">2.5</span>,</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>         <span class="at">entry =</span> <span class="fl">2.5</span>,</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">anc =</span> <span class="fu">ifelse</span>(anc500 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timeanc500 <span class="sc">&lt;=</span> <span class="fl">2.5</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvh =</span> <span class="fu">ifelse</span>(gvhd <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> tgvhd <span class="sc">&lt;=</span> <span class="fl">2.5</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>landmark <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat05, dat10, dat15, dat20, dat25)</span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Table 5.1 output</span></span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a><span class="fu">rowSums</span>(<span class="fu">with</span>(landmark, <span class="fu">table</span>(landmark, anc <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">|</span> gvh <span class="sc">&gt;</span> <span class="dv">0</span>))) <span class="co"># at risk</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> 0.5    1  1.5    2  2.5 
1988 1949 1905 1876 1829 </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(landmark, <span class="fu">table</span>(landmark, anc)) <span class="co"># anc</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        anc
landmark    0    1
     0.5 1082  906
     1     37 1912
     1.5    6 1899
     2      2 1874
     2.5    1 1828</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(landmark, <span class="fu">table</span>(landmark, gvh)) <span class="co"># gvhd</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        gvh
landmark    0    1
     0.5 1808  180
     1   1558  391
     1.5 1424  481
     2   1377  499
     2.5 1334  495</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop observations with stoptime = starttime</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>landmark <span class="ot">&lt;-</span> <span class="fu">subset</span>(landmark, time <span class="sc">&gt;</span> entry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-17-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-17-2-tab">
<div class="cell" data-hash="Ch5_cache/html/table-5.1-sas_61e73344cf44c14da715056d9d9d7c1b">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">* landmarks at 0.5 ...  2.5 mo. horizon 6 mo. ahead;</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> landmark; <span class="kw">set</span> bmt;</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> intxrel&gt;=<span class="dv">0.5</span> <span class="kw">then do</span>;</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">time</span>=<span class="fu">min</span>(intxrel,<span class="dv">6.5</span>); <span class="kw">if</span> <span class="fu">time</span>&lt;<span class="dv">6.5</span> <span class="kw">then</span> status=state0; </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="fu">time</span>&gt;=<span class="dv">6.5</span> <span class="kw">then</span> status=<span class="dv">0</span>;</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>        landmark=<span class="dv">0.5</span>; entry=<span class="dv">0.5</span>;</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>        anc=<span class="dv">0</span>; <span class="kw">if</span> anc500=<span class="dv">1</span> <span class="kw">and</span> timeanc500&lt;=<span class="dv">0.5</span> <span class="kw">then</span> anc=<span class="dv">1</span>;</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>        gvh=<span class="dv">0</span>; <span class="kw">if</span> gvhd=<span class="dv">1</span> <span class="kw">and</span> tgvhd&lt;=<span class="dv">0.5</span> <span class="kw">then</span> gvh=<span class="dv">1</span>;</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output; end</span>;</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> intxrel&gt;=<span class="dv">1</span> <span class="kw">then do</span>;</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">time</span>=<span class="fu">min</span>(intxrel,<span class="dv">7</span>); <span class="kw">if</span> <span class="fu">time</span>&lt;<span class="dv">7</span> <span class="kw">then</span> status=state0; </span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="fu">time</span>&gt;=<span class="dv">7</span> <span class="kw">then</span> status=<span class="dv">0</span>;</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>        landmark=<span class="dv">1</span>; entry=<span class="dv">1</span>;</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>        anc=<span class="dv">0</span>; <span class="kw">if</span> anc500=<span class="dv">1</span> <span class="kw">and</span> timeanc500&lt;=<span class="dv">1</span> <span class="kw">then</span> anc=<span class="dv">1</span>;</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>        gvh=<span class="dv">0</span>; <span class="kw">if</span> gvhd=<span class="dv">1</span> <span class="kw">and</span> tgvhd&lt;=<span class="dv">1</span> <span class="kw">then</span> gvh=<span class="dv">1</span>;</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output; end</span>;</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> intxrel&gt;=<span class="dv">1.5</span> <span class="kw">then do</span>;</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">time</span>=<span class="fu">min</span>(intxrel,<span class="dv">7.5</span>); <span class="kw">if</span> <span class="fu">time</span>&lt;<span class="dv">7.5</span> <span class="kw">then</span> status=state0; </span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="fu">time</span>&gt;=<span class="dv">7.5</span> <span class="kw">then</span> status=<span class="dv">0</span>;</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>        landmark=<span class="dv">1.5</span>; entry=<span class="dv">1.5</span>;</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>        anc=<span class="dv">0</span>; <span class="kw">if</span> anc500=<span class="dv">1</span> <span class="kw">and</span> timeanc500&lt;=<span class="dv">1.5</span> <span class="kw">then</span> anc=<span class="dv">1</span>;</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>        gvh=<span class="dv">0</span>; <span class="kw">if</span> gvhd=<span class="dv">1</span> <span class="kw">and</span> tgvhd&lt;=<span class="dv">1.5</span> <span class="kw">then</span> gvh=<span class="dv">1</span>;</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output; end</span>;</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> intxrel&gt;=<span class="dv">2</span> <span class="kw">then do</span>;</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">time</span>=<span class="fu">min</span>(intxrel,<span class="dv">8</span>); <span class="kw">if</span> <span class="fu">time</span>&lt;<span class="dv">8</span> <span class="kw">then</span> status=state0; </span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="fu">time</span>&gt;=<span class="dv">8</span> <span class="kw">then</span> status=<span class="dv">0</span>;</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>        landmark=<span class="dv">2</span>; entry=<span class="dv">2</span>;</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>        anc=<span class="dv">0</span>; <span class="kw">if</span> anc500=<span class="dv">1</span> <span class="kw">and</span> timeanc500&lt;=<span class="dv">2</span> <span class="kw">then</span> anc=<span class="dv">1</span>;</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>        gvh=<span class="dv">0</span>; <span class="kw">if</span> gvhd=<span class="dv">1</span> <span class="kw">and</span> tgvhd&lt;=<span class="dv">2</span> <span class="kw">then</span> gvh=<span class="dv">1</span>;</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output; end</span>;</span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> intxrel&gt;=<span class="dv">2.5</span> <span class="kw">then do</span>;</span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">time</span>=<span class="fu">min</span>(intxrel,<span class="dv">8.5</span>); <span class="kw">if</span> <span class="fu">time</span>&lt;<span class="dv">8.5</span> <span class="kw">then</span> status=state0; </span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="fu">time</span>&gt;=<span class="dv">8.5</span> <span class="kw">then</span> status=<span class="dv">0</span>;</span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>        landmark=<span class="dv">2.5</span>; entry=<span class="dv">2.5</span>;</span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>        anc=<span class="dv">0</span>; <span class="kw">if</span> anc500=<span class="dv">1</span> <span class="kw">and</span> timeanc500&lt;=<span class="dv">2.5</span> <span class="kw">then</span> anc=<span class="dv">1</span>;</span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>        gvh=<span class="dv">0</span>; <span class="kw">if</span> gvhd=<span class="dv">1</span> <span class="kw">and</span> tgvhd&lt;=<span class="dv">2.5</span> <span class="kw">then</span> gvh=<span class="dv">1</span>;</span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output; end</span>;</span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> freq<span class="kw"> data</span>=landmark; </span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a>    tables anc*landmark gvh*landmark/ nocol norow nopercent; </span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-5.2" class="level3">
<h3 class="anchored" data-anchor-id="table-5.2">Table 5.2</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-18-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-1" role="tab" aria-controls="tabset-18-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-18-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-2" role="tab" aria-controls="tabset-18-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-18-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-18-1-tab">
<p>Note, small differences in decimals as estimates in book is from SAS.</p>
<div class="cell" data-hash="Ch5_cache/html/table-5.2-r_b183dac356e99d798ef93a2c5ac77a3f">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add time-varying covariates from previous object</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>landmarkw <span class="ot">&lt;-</span> landmark <span class="sc">%&gt;%</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">anc05 =</span> (landmark <span class="sc">==</span> <span class="fl">0.5</span>) <span class="sc">*</span> anc,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvh05 =</span> (landmark <span class="sc">==</span> <span class="fl">0.5</span>) <span class="sc">*</span> gvh,</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">anc10 =</span> (landmark <span class="sc">==</span> <span class="fl">1.0</span>) <span class="sc">*</span> anc,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvh10 =</span> (landmark <span class="sc">==</span> <span class="fl">1.0</span>) <span class="sc">*</span> gvh,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">anc15 =</span> (landmark <span class="sc">==</span> <span class="fl">1.5</span>) <span class="sc">*</span> anc,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvh15 =</span> (landmark <span class="sc">==</span> <span class="fl">1.5</span>) <span class="sc">*</span> gvh,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">anc20 =</span> (landmark <span class="sc">==</span> <span class="fl">2.0</span>) <span class="sc">*</span> anc,</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvh20 =</span> (landmark <span class="sc">==</span> <span class="fl">2.0</span>) <span class="sc">*</span> gvh,</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">anc25 =</span> (landmark <span class="sc">==</span> <span class="fl">2.5</span>) <span class="sc">*</span> anc,</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvh25 =</span> (landmark <span class="sc">==</span> <span class="fl">2.5</span>) <span class="sc">*</span> gvh</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="co"># with(landmarkw, table(landmark, status))</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>cox_land <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(entry, time, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="fu">cluster</span>(id) <span class="sc">+</span> <span class="fu">strata</span>(landmark) <span class="sc">+</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>                    anc05 <span class="sc">+</span> anc10 <span class="sc">+</span> anc15 <span class="sc">+</span> anc20 <span class="sc">+</span> anc25 <span class="sc">+</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>                    gvh05 <span class="sc">+</span> gvh10 <span class="sc">+</span> gvh15 <span class="sc">+</span> gvh20 <span class="sc">+</span> gvh25 ,</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> landmarkw, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>cox_land</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(entry, time, status != 0) ~ strata(landmark) + 
    anc05 + anc10 + anc15 + anc20 + anc25 + gvh05 + gvh10 + gvh15 + 
    gvh20 + gvh25, data = landmarkw, method = "breslow", cluster = id)

          coef exp(coef) se(coef) robust se       z        p
anc05 -0.33460   0.71563  0.10680   0.10680  -3.133  0.00173
anc10 -0.60851   0.54416  0.30635   0.31981  -1.903  0.05708
anc15 -1.68452   0.18553  0.50439   0.61065  -2.759  0.00581
anc20 -2.96384   0.05162  0.71909   0.40406  -7.335 2.21e-13
anc25 -3.35202   0.03501  1.01558   0.17840 -18.789  &lt; 2e-16
gvh05  0.70277   2.01934  0.14751   0.14894   4.718 2.38e-06
gvh10  0.67945   1.97280  0.11489   0.11523   5.897 3.71e-09
gvh15  0.86339   2.37119  0.11246   0.11254   7.672 1.69e-14
gvh20  0.80243   2.23095  0.11514   0.11511   6.971 3.15e-12
gvh25  0.83065   2.29481  0.12151   0.12129   6.848 7.47e-12

Likelihood ratio test=230.2  on 10 df, p=&lt; 2.2e-16
n= 9542, number of events= 1643 </code></pre>
</div>
</div>
</div>
<div id="tabset-18-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-18-2-tab">
<div class="cell" data-hash="Ch5_cache/html/table-5.23-sas_954fc098d35ffb8417228ce2088ae2a5">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov1;</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    anc05=<span class="dv">0</span>; anc1=<span class="dv">0</span>; anc15=<span class="dv">0</span>; anc2=<span class="dv">0</span>; anc25=<span class="dv">0</span>; </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    gvh05=<span class="dv">0</span>; gvh1=<span class="dv">0</span>; gvh15=<span class="dv">0</span>; gvh2=<span class="dv">0</span>; gvh25=<span class="dv">0</span>;</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=landmark covs(aggregate);</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    class landmark;</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*status(<span class="dv">0</span>)=anc05 anc1 anc15 anc2 anc25 </span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>                         gvh05 gvh1 gvh15 gvh2 gvh25/entry=entry;</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    anc05=anc*(landmark=<span class="dv">0.5</span>); gvh05=gvh*(landmark=<span class="dv">0.5</span>);</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    anc1=anc*(landmark=<span class="dv">1</span>); gvh1=gvh*(landmark=<span class="dv">1</span>);</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    anc15=anc*(landmark=<span class="dv">1.5</span>); gvh15=gvh*(landmark=<span class="dv">1.5</span>);</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    anc2=anc*(landmark=<span class="dv">2</span>); gvh2=gvh*(landmark=<span class="dv">2</span>);</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    anc25=anc*(landmark=<span class="dv">2.5</span>); gvh25=gvh*(landmark=<span class="dv">2.5</span>);</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>    strata landmark;</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    baseline out=base1 covariates=cov1 survival=km0;</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>                                      The PHREG Procedure</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>                              Analysis of Maximum Likelihood Estimates</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>                        Parameter      Standard    <span class="fu">StdErr</span>                                  Hazard</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>    Parameter    DF      Estimate         <span class="kw">Error</span>     Ratio    Chi-Square    Pr &gt; ChiSq       Ratio</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>    anc05         <span class="dv">1</span>      -<span class="dv">0.33460</span>       <span class="dv">0.10680</span>     <span class="dv">1.000</span>        <span class="dv">9.8154</span>        <span class="dv">0.0017</span>       <span class="dv">0.716</span></span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>    anc1          <span class="dv">1</span>      -<span class="dv">0.60851</span>       <span class="dv">0.31981</span>     <span class="dv">1.044</span>        <span class="dv">3.6202</span>        <span class="dv">0.0571</span>       <span class="dv">0.544</span></span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>    anc15         <span class="dv">1</span>      -<span class="dv">1.68550</span>       <span class="dv">0.61040</span>     <span class="dv">1.211</span>        <span class="dv">7.6249</span>        <span class="dv">0.0058</span>       <span class="dv">0.185</span></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>    anc2          <span class="dv">1</span>      -<span class="dv">2.96384</span>       <span class="dv">0.40406</span>     <span class="dv">0.562</span>       <span class="dv">53.8052</span>        &lt;.<span class="dv">0001</span>       <span class="dv">0.052</span></span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>    anc25         <span class="dv">1</span>      -<span class="dv">3.35448</span>       <span class="dv">0.17843</span>     <span class="dv">0.176</span>      <span class="dv">353.4208</span>        &lt;.<span class="dv">0001</span>       <span class="dv">0.035</span></span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>    gvh05         <span class="dv">1</span>       <span class="dv">0.70277</span>       <span class="dv">0.14894</span>     <span class="dv">1.010</span>       <span class="dv">22.2637</span>        &lt;.<span class="dv">0001</span>       <span class="dv">2.019</span></span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a>    gvh1          <span class="dv">1</span>       <span class="dv">0.67945</span>       <span class="dv">0.11523</span>     <span class="dv">1.003</span>       <span class="dv">34.7695</span>        &lt;.<span class="dv">0001</span>       <span class="dv">1.973</span></span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>    gvh15         <span class="dv">1</span>       <span class="dv">0.86339</span>       <span class="dv">0.11254</span>     <span class="dv">1.001</span>       <span class="dv">58.8574</span>        &lt;.<span class="dv">0001</span>       <span class="dv">2.371</span></span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a>    gvh2          <span class="dv">1</span>       <span class="dv">0.80243</span>       <span class="dv">0.11511</span>     <span class="dv">1.000</span>       <span class="dv">48.5926</span>        &lt;.<span class="dv">0001</span>       <span class="dv">2.231</span></span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a>    gvh25         <span class="dv">1</span>       <span class="dv">0.83065</span>       <span class="dv">0.12129</span>     <span class="dv">0.998</span>       <span class="dv">46.8981</span>        &lt;.<span class="dv">0001</span>       <span class="dv">2.295</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.1" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.1">Figure 5.1</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-19-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-19-1" role="tab" aria-controls="tabset-19-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-19-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-19-2" role="tab" aria-controls="tabset-19-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-19-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-19-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.1-r_80fe11e34fbfa80f416c8a015a575e0b">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># General theme</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">26</span>),</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">26</span>),</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">26</span>),</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">26</span>))</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract estimated survival probabilities</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>surv <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_land,</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">anc05 =</span> <span class="dv">0</span>, <span class="at">anc10 =</span> <span class="dv">0</span>, <span class="at">anc15 =</span> <span class="dv">0</span>, <span class="at">anc20 =</span> <span class="dv">0</span>, <span class="at">anc25 =</span> <span class="dv">0</span>,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">gvh05 =</span> <span class="dv">0</span>, <span class="at">gvh10 =</span> <span class="dv">0</span>, <span class="at">gvh15 =</span> <span class="dv">0</span>, <span class="at">gvh20 =</span> <span class="dv">0</span>, <span class="at">gvh25 =</span> <span class="dv">0</span>))</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Order data for plotting</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>pdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">surv =</span> surv<span class="sc">$</span>surv,</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>                    <span class="at">time =</span> surv<span class="sc">$</span>time,</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">landmark =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"0.5"</span>, surv<span class="sc">$</span>strata[[<span class="dv">1</span>]]),</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"1.0"</span>, surv<span class="sc">$</span>strata[[<span class="dv">2</span>]]),</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"1.5"</span>, surv<span class="sc">$</span>strata[[<span class="dv">3</span>]]),</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"2.0"</span>, surv<span class="sc">$</span>strata[[<span class="dv">4</span>]]),</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"2.5"</span>, surv<span class="sc">$</span>strata[[<span class="dv">5</span>]]))</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Add prob 1 in beginning for all</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>pdata2 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(pdata <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(landmark) <span class="sc">%&gt;%</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">add_row</span>(.x, <span class="at">surv =</span> <span class="dv">1</span>, <span class="at">time =</span> <span class="dv">0</span>, <span class="at">.before=</span><span class="dv">0</span>)))</span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure (a)</span></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.1</span>a <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> surv, <span class="at">linetype =</span> landmark), <span class="at">data =</span> pdata2) <span class="sc">+</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Landmark"</span>) <span class="sc">+</span></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since bone marrow transplantation (months)"</span>) <span class="sc">+</span></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Conditional survival probability"</span>) <span class="sc">+</span></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">9</span>),</span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">9</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>)) <span class="sc">+</span></span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>))</span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.1</span>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.1-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For anc = gvh = 1</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Add LP to data</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>pdata2<span class="sc">$</span>lp <span class="ot">&lt;-</span> <span class="fu">with</span>(pdata2,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">ifelse</span>(landmark <span class="sc">==</span> <span class="st">'0.5'</span>, <span class="fu">coef</span>(cox_land)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>(cox_land)[<span class="dv">6</span>],</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">ifelse</span>(landmark <span class="sc">==</span> <span class="st">'1.0'</span>, <span class="fu">coef</span>(cox_land)[<span class="dv">2</span>] <span class="sc">+</span> <span class="fu">coef</span>(cox_land)[<span class="dv">7</span>],</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">ifelse</span>(landmark <span class="sc">==</span> <span class="st">'1.5'</span>, <span class="fu">coef</span>(cox_land)[<span class="dv">3</span>] <span class="sc">+</span> <span class="fu">coef</span>(cox_land)[<span class="dv">8</span>],</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">ifelse</span>(landmark <span class="sc">==</span> <span class="st">'2.0'</span>, <span class="fu">coef</span>(cox_land)[<span class="dv">4</span>] <span class="sc">+</span> <span class="fu">coef</span>(cox_land)[<span class="dv">9</span>],</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">ifelse</span>(landmark <span class="sc">==</span> <span class="st">'2.5'</span>, <span class="fu">coef</span>(cox_land)[<span class="dv">5</span>] <span class="sc">+</span> <span class="fu">coef</span>(cox_land)[<span class="dv">10</span>],</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">0</span>))))))</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>pdata2_wc <span class="ot">&lt;-</span> pdata2</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>pdata2_wc<span class="sc">$</span>survlp <span class="ot">&lt;-</span> <span class="fu">with</span>(pdata2, surv <span class="sc">^</span> <span class="fu">exp</span>(lp))</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure 5.1 (b)</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.1</span>b <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> survlp, <span class="at">linetype =</span> landmark), <span class="at">data =</span> pdata2_wc) <span class="sc">+</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Landmark"</span>) <span class="sc">+</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since bone marrow transplantation (months)"</span>) <span class="sc">+</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Conditional survival probability"</span>) <span class="sc">+</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">9</span>),</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">9</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>)) <span class="sc">+</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>))</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.1</span>b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.1-r-2.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-19-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-19-2-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.1-sas_9cb477ddf688e4826d94186254e187f6">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'Figure 5.1 (a)'</span>;</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=base1;</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    plot km0*<span class="fu">time</span>=landmark/haxis=axis1 vaxis=axis2;</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">9</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Months'</span>);</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none </span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Conditional survival probability'</span>);</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    symbol3  v=none i=stepjl c=black;</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    symbol4 v=none i=stepjl c=green;</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    symbol5 v=none i=stepjl c=orange;</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> base1; <span class="kw">set</span> base1;</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> landmark=<span class="dv">0.5</span> <span class="kw">then</span> km1=km0**<span class="fu">exp</span>(-<span class="dv">0.33460+0.70277</span>);</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> landmark=<span class="dv">1</span> <span class="kw">then</span> km1=km0**<span class="fu">exp</span>(-<span class="dv">0.60851+0.67945</span>);</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> landmark=<span class="dv">1.5</span> <span class="kw">then</span> km1=km0**<span class="fu">exp</span>(-<span class="dv">1.68550+0.86339</span>);</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> landmark=<span class="dv">2</span> <span class="kw">then</span> km1=km0**<span class="fu">exp</span>(-<span class="dv">2.96384+0.80243</span>);</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> landmark=<span class="dv">2.5</span> <span class="kw">then</span> km1=km0**<span class="fu">exp</span>(-<span class="dv">3.35448+0.83065</span>);</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'Figure 5.1 (b)'</span>;</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=base1;</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>    plot km1*<span class="fu">time</span>=landmark/haxis=axis1 vaxis=axis2;</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">9</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Months'</span>);</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none </span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Conditional survival probability'</span>);</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>    symbol3  v=none i=stepjl c=black;</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>    symbol4 v=none i=stepjl c=green;</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>    symbol5 v=none i=stepjl c=orange;</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-5.3" class="level3">
<h3 class="anchored" data-anchor-id="table-5.3">Table 5.3</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-20-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-20-1" role="tab" aria-controls="tabset-20-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-20-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-20-2" role="tab" aria-controls="tabset-20-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-20-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-20-1-tab">
<div class="cell" data-hash="Ch5_cache/html/table-5.3-r_4f91136138d4721dfb3c256041b19420">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="do">## COLUMN 1 </span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Add extra variables</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>landmarkw2 <span class="ot">&lt;-</span> landmark <span class="sc">%&gt;%</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">anctime  =</span> anc <span class="sc">*</span> (landmark <span class="sc">-</span> <span class="fl">0.5</span>)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">anctime2 =</span> anc <span class="sc">*</span> ((landmark <span class="sc">-</span> <span class="fl">0.5</span>)<span class="sc">/</span><span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvhtime  =</span> gvh <span class="sc">*</span> (landmark <span class="sc">-</span> <span class="fl">0.5</span>)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">gvhtime2 =</span> gvh <span class="sc">*</span> ((landmark <span class="sc">-</span> <span class="fl">0.5</span>)<span class="sc">/</span><span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>cox_land2 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(entry, time, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="fu">cluster</span>(id) <span class="sc">+</span> <span class="fu">strata</span>(landmark) <span class="sc">+</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>                    anc <span class="sc">+</span> anctime <span class="sc">+</span> anctime2 <span class="sc">+</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>                    gvh <span class="sc">+</span> gvhtime <span class="sc">+</span> gvhtime2,</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> landmarkw2,</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"breslow"</span>, <span class="at">timefix =</span> <span class="cn">FALSE</span>, <span class="at">eps =</span> <span class="fl">1e-9</span>)</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_land2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(entry, time, status != 0) ~ strata(landmark) + 
    anc + anctime + anctime2 + gvh + gvhtime + gvhtime2, data = landmarkw2, 
    method = "breslow", timefix = FALSE, eps = 1e-09, cluster = id)

  n= 9542, number of events= 1643 

            coef exp(coef) se(coef) robust se      z Pr(&gt;|z|)    
anc      -0.3220    0.7247   0.1061    0.1057 -3.046  0.00232 ** 
anctime  -1.1908    0.3040   1.4081    1.6699 -0.713  0.47581    
anctime2 -2.2570    0.1047   1.8161    1.7911 -1.260  0.20762    
gvh       0.6626    1.9398   0.1352    0.1429  4.636 3.55e-06 ***
gvhtime   0.3913    1.4790   0.5865    0.4304  0.909  0.36323    
gvhtime2 -0.2264    0.7974   0.5398    0.3421 -0.662  0.50808    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

         exp(coef) exp(-coef) lower .95 upper .95
anc         0.7247     1.3799  0.589072    0.8915
anctime     0.3040     3.2896  0.011519    8.0225
anctime2    0.1047     9.5548  0.003127    3.5025
gvh         1.9398     0.5155  1.465873    2.5668
gvhtime     1.4790     0.6762  0.636204    3.4380
gvhtime2    0.7974     1.2541  0.407813    1.5591

Concordance= 0.581  (se = 0.01 )
Likelihood ratio test= 228.4  on 6 df,   p=&lt;2e-16
Wald test            = 212.6  on 6 df,   p=&lt;2e-16
Score (logrank) test = 349.6  on 6 df,   p=&lt;2e-16,   Robust = 56.74  p=2e-10

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="do">## COLUMN 2</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add extra variables</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>landmarkw3 <span class="ot">&lt;-</span> landmarkw2 <span class="sc">%&gt;%</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">strtime =</span> (landmark <span class="sc">-</span> <span class="fl">0.5</span>)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">strtime2 =</span> strtime<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>cox_land3 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(entry, time, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="fu">cluster</span>(id) <span class="sc">+</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>                     anc <span class="sc">+</span> anctime <span class="sc">+</span> anctime2 <span class="sc">+</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>                     gvh <span class="sc">+</span> gvhtime <span class="sc">+</span> gvhtime2 <span class="sc">+</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>                     strtime <span class="sc">+</span> strtime2,</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> landmarkw3,</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>                   <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_land3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(entry, time, status != 0) ~ anc + anctime + 
    anctime2 + gvh + gvhtime + gvhtime2 + strtime + strtime2, 
    data = landmarkw3, method = "breslow", cluster = id)

  n= 9542, number of events= 1643 

             coef exp(coef) se(coef) robust se      z Pr(&gt;|z|)    
anc      -0.29798   0.74232  0.09953   0.09402 -3.169  0.00153 ** 
anctime  -1.39312   0.24830  1.38042   1.62961 -0.855  0.39262    
anctime2 -2.03744   0.13036  1.79663   1.76544 -1.154  0.24847    
gvh       0.67374   1.96156  0.13323   0.14048  4.796 1.62e-06 ***
gvhtime   0.33291   1.39502  0.57606   0.41695  0.798  0.42462    
gvhtime2 -0.17548   0.83906  0.53237   0.33324 -0.527  0.59849    
strtime   1.41388   4.11189  1.35613   1.60559  0.881  0.37853    
strtime2  1.94032   6.96098  1.78860   1.75102  1.108  0.26781    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

         exp(coef) exp(-coef) lower .95 upper .95
anc         0.7423     1.3471  0.617386    0.8925
anctime     0.2483     4.0274  0.010182    6.0548
anctime2    0.1304     7.6709  0.004096    4.1485
gvh         1.9616     0.5098  1.489437    2.5833
gvhtime     1.3950     0.7168  0.616125    3.1586
gvhtime2    0.8391     1.1918  0.436650    1.6123
strtime     4.1119     0.2432  0.176752   95.6575
strtime2    6.9610     0.1437  0.225010  215.3469

Concordance= 0.587  (se = 0.012 )
Likelihood ratio test= 227.9  on 8 df,   p=&lt;2e-16
Wald test            = 233.2  on 8 df,   p=&lt;2e-16
Score (logrank) test = 348.8  on 8 df,   p=&lt;2e-16,   Robust = 56.74  p=2e-09

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
</div>
</div>
<div id="tabset-20-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-20-2-tab">
<div class="cell" data-hash="Ch5_cache/html/table-5.3-sas_6cc18885220fb2f9fe506dfa1f870a4f">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov2;</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    anc=<span class="dv">0</span>; anctime=<span class="dv">0</span>; anctime2=<span class="dv">0</span>;  </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    gvh=<span class="dv">0</span>; gvhtime=<span class="dv">0</span>; gvhtime2=<span class="dv">0</span>; </span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=landmark covs(aggregate);</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*status(<span class="dv">0</span>)=anc anctime anctime2 </span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>                         gvh gvhtime gvhtime2/entry=entry;</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    anctime=anc*(landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>; anctime2=anc*((landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>)**<span class="dv">2</span>;</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    gvhtime=gvh*(landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>; gvhtime2=gvh*((landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>)**<span class="dv">2</span>;</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    strata landmark;</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>    baseline out=base2 covariates=cov2 survival=km0;</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>                       </span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a><span class="co">* Column 2;</span> </span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov3;</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>    anc=<span class="dv">0</span>; anctime=<span class="dv">0</span>; anctime2=<span class="dv">0</span>; </span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>    gvh=<span class="dv">0</span>; gvhtime=<span class="dv">0</span>; gvhtime2=<span class="dv">0</span>;</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    strtime=<span class="dv">0</span>; strtime2=<span class="dv">0</span>;</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=landmark covs(aggregate);</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*status(<span class="dv">0</span>)=anc anctime anctime2 </span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>                         gvh gvhtime gvhtime2</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>                         strtime strtime2/entry=entry;</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>    anctime=anc*(landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>; anctime2=anc*((landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>)**<span class="dv">2</span>;</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>    gvhtime=gvh*(landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>; gvhtime2=gvh*((landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>)**<span class="dv">2</span>;</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>    strtime=(landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>; strtime2=strtime**<span class="dv">2</span>;</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>    baseline out=base3 covariates=cov3 survival=km;</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.2" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.2">Figure 5.2</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-21-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-21-1" role="tab" aria-controls="tabset-21-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-21-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-21-2" role="tab" aria-controls="tabset-21-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-21-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-21-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.2-r_a44da536a2fb9154923c46f77db9e412">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract estimated survival probabilities</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>surv <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_land2,</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">anc =</span> <span class="dv">0</span>, <span class="at">anctime =</span> <span class="dv">0</span>, <span class="at">anctime2 =</span> <span class="dv">0</span>,</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">gvh =</span> <span class="dv">0</span>, <span class="at">gvhtime =</span> <span class="dv">0</span>, <span class="at">gvhtime2 =</span> <span class="dv">0</span>))</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Order data for plotting</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>pdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">surv =</span> surv<span class="sc">$</span>surv,</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">time =</span> surv<span class="sc">$</span>time,</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">landmark =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"0.5"</span>, surv<span class="sc">$</span>strata[[<span class="dv">1</span>]]),</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"1.0"</span>, surv<span class="sc">$</span>strata[[<span class="dv">2</span>]]),</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"1.5"</span>, surv<span class="sc">$</span>strata[[<span class="dv">3</span>]]),</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"2.0"</span>, surv<span class="sc">$</span>strata[[<span class="dv">4</span>]]),</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"2.5"</span>, surv<span class="sc">$</span>strata[[<span class="dv">5</span>]]))</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Add prob 1 in beginning for all</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>pdata2 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(pdata <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(landmark) <span class="sc">%&gt;%</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">add_row</span>(.x, <span class="at">surv =</span> <span class="dv">1</span>, <span class="at">time =</span> <span class="dv">0</span>, <span class="at">.before=</span><span class="dv">0</span>)))</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure (a)</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.2</span>a <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> surv, <span class="at">linetype =</span> landmark), <span class="at">data =</span> pdata2) <span class="sc">+</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Landmark"</span>) <span class="sc">+</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since bone marrow transplantation (months)"</span>) <span class="sc">+</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Conditional survival probability"</span>) <span class="sc">+</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">9</span>),</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">9</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span></span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>)) <span class="sc">+</span></span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>))</span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.2</span>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.2-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For anc = gvh = 1</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Add LP to data</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>pdata2<span class="sc">$</span>landmarknum <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pdata2<span class="sc">$</span>landmark)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>pdata2<span class="sc">$</span>lp <span class="ot">&lt;-</span> <span class="fu">with</span>(pdata2,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">coef</span>(cox_land2)[<span class="dv">1</span>] <span class="sc">+</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">coef</span>(cox_land2)[<span class="dv">2</span>] <span class="sc">*</span> (landmarknum <span class="sc">-</span> <span class="fl">0.5</span>) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">coef</span>(cox_land2)[<span class="dv">3</span>] <span class="sc">*</span> ((landmarknum <span class="sc">-</span> <span class="fl">0.5</span>) <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">coef</span>(cox_land2)[<span class="dv">4</span>] <span class="sc">+</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">coef</span>(cox_land2)[<span class="dv">5</span>] <span class="sc">*</span> (landmarknum <span class="sc">-</span> <span class="fl">0.5</span>) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">coef</span>(cox_land2)[<span class="dv">6</span>] <span class="sc">*</span> ((landmarknum <span class="sc">-</span> <span class="fl">0.5</span>) <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>pdata2_wc <span class="ot">&lt;-</span> pdata2</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>pdata2_wc<span class="sc">$</span>survlp <span class="ot">&lt;-</span> <span class="fu">with</span>(pdata2, surv <span class="sc">^</span> <span class="fu">exp</span>(lp))</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure (b)</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.2</span>b <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> survlp, <span class="at">linetype =</span> landmark), <span class="at">data =</span> pdata2_wc) <span class="sc">+</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Landmark"</span>) <span class="sc">+</span></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since bone marrow transplantation (months)"</span>) <span class="sc">+</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Conditional survival probability"</span>) <span class="sc">+</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">9</span>),</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">9</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>)) <span class="sc">+</span></span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>))</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.2</span>b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.2-r-2.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-21-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-21-2-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.2-sas_faa357c9b353fa7bc80fcdcc268693bc">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=base2;</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    plot km0*<span class="fu">time</span>=landmark/haxis=axis1 vaxis=axis2;</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">9</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Months'</span>);</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Conditional survival probability'</span>);</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    symbol3  v=none i=stepjl c=black;</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    symbol4 v=none i=stepjl c=green;</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    symbol5 v=none i=stepjl c=orange;</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> base2;</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> base2;</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    lp=-<span class="dv">0.32202</span>+(-<span class="dv">1.19065</span>)*(landmark<span class="dv">-0.5</span>)/<span class="dv">2</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>    +(-<span class="dv">2.25731</span>)*((landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>)**<span class="dv">2</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>    +<span class="dv">0.66257+0.39131</span>*(landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>+(-<span class="dv">0.22640</span>)*((landmark<span class="dv">-0.5</span>)/<span class="dv">2</span>)**<span class="dv">2</span>;</span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>    km1=km0**<span class="fu">exp</span>(lp);</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=base2;</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>    plot km1*<span class="fu">time</span>=landmark/haxis=axis1 vaxis=axis2;</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">9</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Months'</span>);</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none </span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Conditional survival probability'</span>);</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>    symbol3  v=none i=stepjl c=black;</span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>    symbol4 v=none i=stepjl c=green;</span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>    symbol5 v=none i=stepjl c=orange;</span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-5.3" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.3">Figure 5.3</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-22-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-22-1" role="tab" aria-controls="tabset-22-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-22-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-22-2" role="tab" aria-controls="tabset-22-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-22-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-22-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.3-r_aa89cb161a8f4f2a700781279aba286f">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract estimated survival probabilities</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>surv <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_land3,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">anc =</span> <span class="dv">0</span>, <span class="at">anctime =</span> <span class="dv">0</span>, <span class="at">anctime2 =</span> <span class="dv">0</span>,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">gvh =</span> <span class="dv">0</span>, <span class="at">gvhtime =</span> <span class="dv">0</span>, <span class="at">gvhtime2 =</span> <span class="dv">0</span> ,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">strtime =</span> <span class="dv">0</span>, <span class="at">strtime2 =</span> <span class="dv">0</span>))</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Order data for plotting</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>pdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">surv =</span> surv<span class="sc">$</span>surv,</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">time =</span> surv<span class="sc">$</span>time)</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(dplyr)</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>base305 <span class="ot">&lt;-</span> pdata <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time <span class="sc">&lt;</span> <span class="fl">6.5</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">landmark =</span> <span class="fl">0.5</span>,</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">km0 =</span> surv, </span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">lpt =</span> <span class="dv">0</span>,</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">lpz =</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">4</span>],</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">km1 =</span> km0<span class="sc">^</span><span class="fu">exp</span>(lpz))</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>base310 <span class="ot">&lt;-</span> pdata <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="dv">7</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">landmark =</span> <span class="dv">1</span>,</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">lpt =</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">7</span>] <span class="sc">*</span> <span class="fl">0.5</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">8</span>] <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">km0 =</span> (surv <span class="sc">/</span> <span class="fl">0.9784098</span>)<span class="sc">^</span><span class="fu">exp</span>(lpt), </span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">lpz =</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">4</span>] <span class="sc">+</span> </span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">2</span>] <span class="sc">*</span> <span class="fl">0.5</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">5</span>] <span class="sc">*</span> <span class="fl">0.5</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">3</span>] <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">6</span>] <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span> ,</span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">km1 =</span> km0<span class="sc">^</span><span class="fu">exp</span>(lpz))</span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>base315 <span class="ot">&lt;-</span> pdata <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time <span class="sc">&gt;</span> <span class="fl">1.5</span> <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fl">7.5</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">landmark =</span> <span class="fl">1.5</span>,</span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a>         <span class="at">lpt =</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">7</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">8</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a>         <span class="at">km0 =</span> (surv <span class="sc">/</span> <span class="fl">0.9554490</span>)<span class="sc">^</span><span class="fu">exp</span>(lpt), </span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a>         <span class="at">lpz =</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">4</span>] <span class="sc">+</span> </span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">5</span>] <span class="sc">*</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb79-39"><a href="#cb79-39" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">3</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb79-40"><a href="#cb79-40" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">6</span>] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span> ,</span>
<span id="cb79-41"><a href="#cb79-41" aria-hidden="true" tabindex="-1"></a>         <span class="at">km1 =</span> km0<span class="sc">^</span><span class="fu">exp</span>(lpz))</span>
<span id="cb79-42"><a href="#cb79-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-43"><a href="#cb79-43" aria-hidden="true" tabindex="-1"></a>base320 <span class="ot">&lt;-</span> pdata <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time <span class="sc">&gt;</span> <span class="dv">2</span> <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="dv">8</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb79-44"><a href="#cb79-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">landmark =</span> <span class="dv">2</span>,</span>
<span id="cb79-45"><a href="#cb79-45" aria-hidden="true" tabindex="-1"></a>         <span class="at">lpt =</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">7</span>] <span class="sc">*</span> <span class="fl">1.5</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">8</span>] <span class="sc">*</span> (<span class="fl">1.5</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb79-46"><a href="#cb79-46" aria-hidden="true" tabindex="-1"></a>         <span class="at">km0 =</span> (surv <span class="sc">/</span> <span class="fl">0.9395795</span>)<span class="sc">^</span><span class="fu">exp</span>(lpt), </span>
<span id="cb79-47"><a href="#cb79-47" aria-hidden="true" tabindex="-1"></a>         <span class="at">lpz =</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">4</span>] <span class="sc">+</span> </span>
<span id="cb79-48"><a href="#cb79-48" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">2</span>] <span class="sc">*</span> <span class="fl">1.5</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb79-49"><a href="#cb79-49" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">5</span>] <span class="sc">*</span> <span class="fl">1.5</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb79-50"><a href="#cb79-50" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">3</span>] <span class="sc">*</span> (<span class="fl">1.5</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb79-51"><a href="#cb79-51" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">6</span>] <span class="sc">*</span> (<span class="fl">1.5</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span> ,</span>
<span id="cb79-52"><a href="#cb79-52" aria-hidden="true" tabindex="-1"></a>         <span class="at">km1 =</span> km0<span class="sc">^</span><span class="fu">exp</span>(lpz))</span>
<span id="cb79-53"><a href="#cb79-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-54"><a href="#cb79-54" aria-hidden="true" tabindex="-1"></a>base325 <span class="ot">&lt;-</span> pdata <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time <span class="sc">&gt;</span> <span class="fl">2.5</span> <span class="sc">&amp;</span> time <span class="sc">&lt;</span> <span class="fl">8.5</span>) <span class="sc">%&gt;%</span>  </span>
<span id="cb79-55"><a href="#cb79-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">landmark =</span> <span class="fl">2.5</span>,</span>
<span id="cb79-56"><a href="#cb79-56" aria-hidden="true" tabindex="-1"></a>         <span class="at">lpt =</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">7</span>] <span class="sc">*</span> <span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">8</span>] <span class="sc">*</span> (<span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb79-57"><a href="#cb79-57" aria-hidden="true" tabindex="-1"></a>         <span class="at">km0 =</span> (surv <span class="sc">/</span> <span class="fl">0.9126288</span>)<span class="sc">^</span><span class="fu">exp</span>(lpt), </span>
<span id="cb79-58"><a href="#cb79-58" aria-hidden="true" tabindex="-1"></a>         <span class="at">lpz =</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>(cox_land3)[<span class="dv">4</span>] <span class="sc">+</span> </span>
<span id="cb79-59"><a href="#cb79-59" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb79-60"><a href="#cb79-60" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">5</span>] <span class="sc">*</span> <span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb79-61"><a href="#cb79-61" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">3</span>] <span class="sc">*</span> (<span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb79-62"><a href="#cb79-62" aria-hidden="true" tabindex="-1"></a>           <span class="fu">coef</span>(cox_land3)[<span class="dv">6</span>] <span class="sc">*</span> (<span class="dv">2</span> <span class="sc">/</span> <span class="dv">2</span>)<span class="sc">^</span><span class="dv">2</span> ,</span>
<span id="cb79-63"><a href="#cb79-63" aria-hidden="true" tabindex="-1"></a>         <span class="at">km1 =</span> km0<span class="sc">^</span><span class="fu">exp</span>(lpz))</span>
<span id="cb79-64"><a href="#cb79-64" aria-hidden="true" tabindex="-1"></a>base3slut <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">rbind</span>(base305, base310, base315, base320, base325))</span>
<span id="cb79-65"><a href="#cb79-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-66"><a href="#cb79-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-67"><a href="#cb79-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Add prob 1 in beginning for all</span></span>
<span id="cb79-68"><a href="#cb79-68" aria-hidden="true" tabindex="-1"></a>pdata3 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(base3slut <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(landmark) <span class="sc">%&gt;%</span></span>
<span id="cb79-69"><a href="#cb79-69" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">group_modify</span>(<span class="sc">~</span> <span class="fu">add_row</span>(.x, <span class="at">km0 =</span> <span class="dv">1</span>, <span class="at">km1  =</span> <span class="dv">1</span>, <span class="at">time =</span> <span class="dv">0</span>, <span class="at">.before=</span><span class="dv">0</span>)))</span>
<span id="cb79-70"><a href="#cb79-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-71"><a href="#cb79-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure (a)</span></span>
<span id="cb79-72"><a href="#cb79-72" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.3</span>a <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> km0, <span class="at">linetype =</span> <span class="fu">as.factor</span>(landmark)), <span class="at">data =</span> pdata3) <span class="sc">+</span></span>
<span id="cb79-73"><a href="#cb79-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb79-74"><a href="#cb79-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Landmark"</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">"0.5"</span>,<span class="st">"1.0"</span>,<span class="st">"1.5"</span>, <span class="st">"2.0"</span>,<span class="st">"2.5"</span>)) <span class="sc">+</span></span>
<span id="cb79-75"><a href="#cb79-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since bone marrow transplantation (months)"</span>) <span class="sc">+</span></span>
<span id="cb79-76"><a href="#cb79-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Conditional survival probability"</span>) <span class="sc">+</span></span>
<span id="cb79-77"><a href="#cb79-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb79-78"><a href="#cb79-78" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">9</span>),</span>
<span id="cb79-79"><a href="#cb79-79" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">9</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb79-80"><a href="#cb79-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb79-81"><a href="#cb79-81" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb79-82"><a href="#cb79-82" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb79-83"><a href="#cb79-83" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span></span>
<span id="cb79-84"><a href="#cb79-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>)) <span class="sc">+</span> </span>
<span id="cb79-85"><a href="#cb79-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>))</span>
<span id="cb79-86"><a href="#cb79-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-87"><a href="#cb79-87" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.3</span>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.3-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure 5.3 (right)</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.3</span>b <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> km1, <span class="at">linetype =</span> <span class="fu">as.factor</span>(landmark)), <span class="at">data =</span> pdata3) <span class="sc">+</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Landmark"</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">"0.5"</span>,<span class="st">"1.0"</span>,<span class="st">"1.5"</span>, <span class="st">"2.0"</span>,<span class="st">"2.5"</span>)) <span class="sc">+</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since bone marrow transplantation (months)"</span>) <span class="sc">+</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Conditional survival probability"</span>) <span class="sc">+</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">9</span>),</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">9</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>   theme_general <span class="sc">+</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>))  <span class="sc">+</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>))</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.3</span>b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.3-r-2.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-22-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-22-2-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.3-sas_5895fa203b5c3d87d47447edb6f31098">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> freq; </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    tables gvhtime * gvhtime2; </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> base305; <span class="kw">set</span> base3;</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    landmark=<span class="dv">0.5</span>;</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    km0=km; </span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    lpz=-<span class="dv">0.29798+0.67374</span>;</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    km1=km0**<span class="fu">exp</span>(lpz);</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="fu">time</span>&lt;<span class="dv">6.5</span> <span class="kw">then</span> <span class="kw">output</span>;</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> base31; <span class="kw">set</span> base3;</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>    landmark=<span class="dv">1</span>;</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="fu">time</span>&gt;<span class="dv">1</span> <span class="kw">then do</span>;</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>    lpt=<span class="dv">1.41386</span>*<span class="dv">0.5</span>/<span class="dv">2+1.94038</span>*<span class="dv">0.5</span>*<span class="dv">0.5</span>/<span class="dv">4</span>;</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    km0=(km/<span class="dv">0.9784097802</span>)**<span class="fu">exp</span>(lpt);</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>    lpz=-<span class="dv">0.29798+0.67374</span>+(-<span class="dv">1.39310</span>)*<span class="dv">0.5</span>/<span class="dv">2</span>+(-<span class="dv">2.03750</span>)/<span class="dv">4</span>*<span class="dv">0.5</span>*<span class="dv">0.5</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>       +<span class="dv">0.33291</span>*<span class="dv">0.5</span>/<span class="dv">2</span>+(-<span class="dv">0.17548</span>)/<span class="dv">4</span>*<span class="dv">0.5</span>*<span class="dv">0.5</span>; </span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    km1=km0**<span class="fu">exp</span>(lpz);</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="fu">time</span>&lt;<span class="dv">7</span> <span class="kw">then</span> <span class="kw">output</span>;</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> base315; <span class="kw">set</span> base3;</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>    landmark=<span class="dv">1.5</span>;</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="fu">time</span>&gt;<span class="dv">1.5</span> <span class="kw">then do</span>;</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>    lpt=<span class="dv">1.41386</span>*<span class="dv">1</span>/<span class="dv">2+1.94038</span>*<span class="dv">1</span>*<span class="dv">1</span>/<span class="dv">4</span>;</span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>    km0=(km/<span class="dv">0.9554490221</span>)**<span class="fu">exp</span>(lpt);</span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>    lpz=-<span class="dv">0.29798+0.67374</span>+(-<span class="dv">1.39310</span>)*<span class="dv">1</span>/<span class="dv">2</span>+(-<span class="dv">2.03750</span>)/<span class="dv">4</span>*<span class="dv">1</span>*<span class="dv">1</span></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>       +<span class="dv">0.33291</span>*<span class="dv">1</span>/<span class="dv">2</span>+(-<span class="dv">0.17548</span>)/<span class="dv">4</span>*<span class="dv">1</span>*<span class="dv">1</span>;</span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>    km1=km0**<span class="fu">exp</span>(lpz);</span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="fu">time</span>&lt;<span class="dv">7.5</span> <span class="kw">then</span> <span class="kw">output</span>;</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> base32; <span class="kw">set</span> base3;</span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>    landmark=<span class="dv">2</span>;</span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="fu">time</span>&gt;<span class="dv">2</span> <span class="kw">then do</span>;</span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>    lpt=<span class="dv">1.41386</span>*<span class="dv">1.5</span>/<span class="dv">2+1.94038</span>*<span class="dv">1.5</span>*<span class="dv">1.5</span>/<span class="dv">4</span>;</span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>    km0=(km/<span class="dv">0.9395794634</span>)**<span class="fu">exp</span>(lpt);</span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a>    lpz=-<span class="dv">0.29798+0.67374</span>+(-<span class="dv">1.39310</span>)*<span class="dv">1.5</span>/<span class="dv">2</span>+(-<span class="dv">2.03750</span>)/<span class="dv">4</span>*<span class="dv">1.5</span>*<span class="dv">1.5</span></span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>       +<span class="dv">0.33291</span>*<span class="dv">1.5</span>/<span class="dv">2</span>+(-<span class="dv">0.17548</span>)/<span class="dv">4</span>*<span class="dv">1.5</span>*<span class="dv">1.5</span>;</span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>    km1=km0**<span class="fu">exp</span>(lpz);</span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="fu">time</span>&lt;<span class="dv">8</span> <span class="kw">then</span> <span class="kw">output</span>;</span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> base325; <span class="kw">set</span> base3;</span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a>    landmark=<span class="dv">2.5</span>;</span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="fu">time</span>&gt;=<span class="dv">2.5</span> <span class="kw">then do</span>;</span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a>    lpt=<span class="dv">1.41386</span>*<span class="dv">2</span>/<span class="dv">2+1.94038</span>*<span class="dv">2</span>*<span class="dv">2</span>/<span class="dv">4</span>;</span>
<span id="cb81-55"><a href="#cb81-55" aria-hidden="true" tabindex="-1"></a>    km0=(km/<span class="dv">0.9142153063</span>)**<span class="fu">exp</span>(lpt);</span>
<span id="cb81-56"><a href="#cb81-56" aria-hidden="true" tabindex="-1"></a>    lpz=-<span class="dv">0.29798+0.67374</span>+(-<span class="dv">1.39310</span>)*<span class="dv">2</span>/<span class="dv">2</span>+(-<span class="dv">2.03750</span>)/<span class="dv">4</span>*<span class="dv">2</span>*<span class="dv">2</span></span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a>       +<span class="dv">0.33291</span>*<span class="dv">2</span>/<span class="dv">2</span>+(-<span class="dv">0.17548</span>)/<span class="dv">4</span>*<span class="dv">2</span>*<span class="dv">2</span>;</span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a>    km1=km0**<span class="fu">exp</span>(lpz);</span>
<span id="cb81-59"><a href="#cb81-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="fu">time</span>&lt;<span class="dv">8.5</span> <span class="kw">then</span> <span class="kw">output</span>;</span>
<span id="cb81-60"><a href="#cb81-60" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb81-61"><a href="#cb81-61" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb81-62"><a href="#cb81-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-63"><a href="#cb81-63" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> base3slut; </span>
<span id="cb81-64"><a href="#cb81-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> base305 base31 base315 base32 base325;</span>
<span id="cb81-65"><a href="#cb81-65" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb81-66"><a href="#cb81-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-67"><a href="#cb81-67" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=base3slut;</span>
<span id="cb81-68"><a href="#cb81-68" aria-hidden="true" tabindex="-1"></a>    plot km0*<span class="fu">time</span>=landmark/haxis=axis1 vaxis=axis2;</span>
<span id="cb81-69"><a href="#cb81-69" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">9</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Months'</span>);</span>
<span id="cb81-70"><a href="#cb81-70" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none </span>
<span id="cb81-71"><a href="#cb81-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Conditional survival probability'</span>);</span>
<span id="cb81-72"><a href="#cb81-72" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb81-73"><a href="#cb81-73" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb81-74"><a href="#cb81-74" aria-hidden="true" tabindex="-1"></a>    symbol3  v=none i=stepjl c=black;</span>
<span id="cb81-75"><a href="#cb81-75" aria-hidden="true" tabindex="-1"></a>    symbol4 v=none i=stepjl c=green;</span>
<span id="cb81-76"><a href="#cb81-76" aria-hidden="true" tabindex="-1"></a>    symbol5 v=none i=stepjl c=orange;</span>
<span id="cb81-77"><a href="#cb81-77" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb81-78"><a href="#cb81-78" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span>
<span id="cb81-79"><a href="#cb81-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-80"><a href="#cb81-80" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=base3slut;</span>
<span id="cb81-81"><a href="#cb81-81" aria-hidden="true" tabindex="-1"></a>    plot km1*<span class="fu">time</span>=landmark/haxis=axis1 vaxis=axis2;</span>
<span id="cb81-82"><a href="#cb81-82" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">9</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Months'</span>);</span>
<span id="cb81-83"><a href="#cb81-83" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none </span>
<span id="cb81-84"><a href="#cb81-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Conditional survival probability'</span>);</span>
<span id="cb81-85"><a href="#cb81-85" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb81-86"><a href="#cb81-86" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb81-87"><a href="#cb81-87" aria-hidden="true" tabindex="-1"></a>    symbol3  v=none i=stepjl c=black;</span>
<span id="cb81-88"><a href="#cb81-88" aria-hidden="true" tabindex="-1"></a>    symbol4 v=none i=stepjl c=green;</span>
<span id="cb81-89"><a href="#cb81-89" aria-hidden="true" tabindex="-1"></a>    symbol5 v=none i=stepjl c=orange;</span>
<span id="cb81-90"><a href="#cb81-90" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb81-91"><a href="#cb81-91" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-5.5" class="level3">
<h3 class="anchored" data-anchor-id="table-5.5">Table 5.5</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-23-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-23-1" role="tab" aria-controls="tabset-23-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-23-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-23-2" role="tab" aria-controls="tabset-23-2" aria-selected="false">SAS-NA</a></li></ul>
<div class="tab-content">
<div id="tabset-23-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-23-1-tab">
<div class="cell" data-hash="Ch5_cache/html/table-5.5-r_79356fb927d6e55630c0cf9d954f091d">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mstate)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co">#Mostly for ggplot2</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr) <span class="co">#Extra functions to ggplot2</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xtable) <span class="co">#Converts table to LaTeX code</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table) <span class="co">#Faster than data.frame</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(compiler) <span class="co">#Improves speed of functions a tiny bit</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra) <span class="co">#Graphics</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="co"># General theme</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">22</span>),</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">22</span>),</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">22</span>),</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">22</span>))</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a><span class="co"># DATA PREPARATIONS ########################################################## </span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Read data</span></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>bmt <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/bmt.csv"</span>)</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>bmt <span class="ot">&lt;-</span> bmt <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">outof0 =</span> <span class="fu">ifelse</span>(gvhd <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> rel <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> death <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>                      <span class="at">outof0and1 =</span> <span class="fu">ifelse</span>(rel <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> death <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>                      <span class="at">dead =</span> death,</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>                      <span class="at">timerel =</span> <span class="fu">ifelse</span>(rel <span class="sc">==</span> <span class="dv">1</span>, timerel, timedeath),</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>                      <span class="at">timegvhd =</span> <span class="fu">ifelse</span>(gvhd <span class="sc">==</span><span class="dv">1</span>, timegvhd, timerel),</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>                      <span class="at">wait2 =</span> timedeath <span class="sc">-</span> timerel,</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>                      <span class="at">intxsurv =</span> timedeath,</span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>                      <span class="at">intxrel =</span> timerel,</span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>                      <span class="at">tgvhd =</span> timegvhd,)</span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a><span class="co"># PREPARATIONS FOR AALEN-JOHANSEN &amp; LANDMARK AALEN-JOHANSEN ##################</span></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a><span class="co">#Transition matrix</span></span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>tmat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="dv">4</span>,<span class="dv">4</span>)</span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>tmat[<span class="dv">1</span>,<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a>tmat[<span class="dv">2</span>,<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>tmat[<span class="dv">3</span>, <span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(tmat) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">from =</span> <span class="fu">c</span>(<span class="st">"BMT"</span>, <span class="st">"GvHD"</span>, <span class="st">"Relapse"</span>, <span class="st">"Dead"</span>), <span class="at">to =</span> <span class="fu">c</span>(<span class="st">"BMT"</span>, <span class="st">"GvHD"</span>, <span class="st">"Relapse"</span>, <span class="st">"Dead"</span>))</span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a><span class="co">#tmat</span></span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a><span class="co">#Creating data in long format, i.e. row for every transition</span></span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>long_format <span class="ot">&lt;-</span> <span class="fu">msprep</span>(<span class="at">time =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="st">"tgvhd"</span>, <span class="st">"intxrel"</span>, <span class="st">"intxsurv"</span>), <span class="at">status =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="st">"gvhd"</span>, <span class="st">"rel"</span>, <span class="st">"dead"</span>), <span class="at">data =</span> <span class="fu">as.data.frame</span>(bmt), <span class="at">trans =</span> tmat)</span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a><span class="co">#Warning is due to 4 observations where time of relapse and death are the same.</span></span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a><span class="co">#Cox model - no covariates, only strata</span></span>
<span id="cb82-47"><a href="#cb82-47" aria-hidden="true" tabindex="-1"></a>cox_base <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Tstart, Tstop, status) <span class="sc">~</span> <span class="fu">strata</span>(trans), <span class="at">data =</span> long_format, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb82-48"><a href="#cb82-48" aria-hidden="true" tabindex="-1"></a><span class="co">#Warning due to start time being equal to stop time for some of the observations</span></span>
<span id="cb82-49"><a href="#cb82-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-50"><a href="#cb82-50" aria-hidden="true" tabindex="-1"></a><span class="co">#Subject specific transition hazards</span></span>
<span id="cb82-51"><a href="#cb82-51" aria-hidden="true" tabindex="-1"></a>msfit <span class="ot">&lt;-</span> <span class="fu">msfit</span>(cox_base, <span class="at">trans =</span> tmat)</span>
<span id="cb82-52"><a href="#cb82-52" aria-hidden="true" tabindex="-1"></a><span class="co">#Warning due to the same as above</span></span>
<span id="cb82-53"><a href="#cb82-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-54"><a href="#cb82-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-55"><a href="#cb82-55" aria-hidden="true" tabindex="-1"></a><span class="co"># S = 3 #######################################################################</span></span>
<span id="cb82-56"><a href="#cb82-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-57"><a href="#cb82-57" aria-hidden="true" tabindex="-1"></a><span class="co">#Aalen-Johansen</span></span>
<span id="cb82-58"><a href="#cb82-58" aria-hidden="true" tabindex="-1"></a>AJ3 <span class="ot">&lt;-</span> <span class="fu">probtrans</span>(msfit, <span class="at">predt =</span> <span class="dv">3</span>, <span class="at">direction =</span> <span class="st">"forward"</span>, <span class="at">method =</span> <span class="st">"aalen"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb82-59"><a href="#cb82-59" aria-hidden="true" tabindex="-1"></a>AJ3_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(AJ3<span class="sc">$</span>time, AJ3<span class="sc">$</span>pstate3))</span>
<span id="cb82-60"><a href="#cb82-60" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(AJ3_data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"time"</span>, <span class="st">"p02"</span>)</span>
<span id="cb82-61"><a href="#cb82-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-62"><a href="#cb82-62" aria-hidden="true" tabindex="-1"></a>AJ3_max60 <span class="ot">&lt;-</span> <span class="fu">subset</span>(AJ3, time <span class="sc">&lt;=</span> <span class="dv">60</span>)</span>
<span id="cb82-63"><a href="#cb82-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-64"><a href="#cb82-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-65"><a href="#cb82-65" aria-hidden="true" tabindex="-1"></a><span class="co">#Landmark Aalen-Johansen</span></span>
<span id="cb82-66"><a href="#cb82-66" aria-hidden="true" tabindex="-1"></a>LMAJ3 <span class="ot">&lt;-</span> <span class="fu">LMAJ</span>(long_format, <span class="at">s =</span> <span class="dv">3</span>, <span class="at">from =</span> <span class="dv">1</span>, <span class="at">method =</span> <span class="st">"aalen"</span>) <span class="co">#Same warning as before</span></span>
<span id="cb82-67"><a href="#cb82-67" aria-hidden="true" tabindex="-1"></a>LMAJ3_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(LMAJ3<span class="sc">$</span>time, LMAJ3<span class="sc">$</span>pstate3))</span>
<span id="cb82-68"><a href="#cb82-68" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(LMAJ3_data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"time"</span>, <span class="st">"p02"</span>)</span>
<span id="cb82-69"><a href="#cb82-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-70"><a href="#cb82-70" aria-hidden="true" tabindex="-1"></a>LMAJ3_max60 <span class="ot">&lt;-</span> <span class="fu">subset</span>(LMAJ3, time <span class="sc">&lt;=</span> <span class="dv">60</span>)</span>
<span id="cb82-71"><a href="#cb82-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-72"><a href="#cb82-72" aria-hidden="true" tabindex="-1"></a><span class="co"># S = 9 #######################################################################</span></span>
<span id="cb82-73"><a href="#cb82-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-74"><a href="#cb82-74" aria-hidden="true" tabindex="-1"></a><span class="co">#Aalen-Johansen</span></span>
<span id="cb82-75"><a href="#cb82-75" aria-hidden="true" tabindex="-1"></a>AJ9 <span class="ot">&lt;-</span> <span class="fu">probtrans</span>(msfit, <span class="at">predt =</span> <span class="dv">9</span>, <span class="at">direction =</span> <span class="st">"forward"</span>, <span class="at">method =</span> <span class="st">"aalen"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb82-76"><a href="#cb82-76" aria-hidden="true" tabindex="-1"></a>AJ9_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(AJ9<span class="sc">$</span>time, AJ9<span class="sc">$</span>pstate3))</span>
<span id="cb82-77"><a href="#cb82-77" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(AJ9_data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"time"</span>, <span class="st">"p02"</span>)</span>
<span id="cb82-78"><a href="#cb82-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-79"><a href="#cb82-79" aria-hidden="true" tabindex="-1"></a>AJ9_max60 <span class="ot">&lt;-</span> <span class="fu">subset</span>(AJ9, time <span class="sc">&lt;=</span> <span class="dv">60</span>)</span>
<span id="cb82-80"><a href="#cb82-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-81"><a href="#cb82-81" aria-hidden="true" tabindex="-1"></a><span class="co">#Landmark Aalen-Johansen</span></span>
<span id="cb82-82"><a href="#cb82-82" aria-hidden="true" tabindex="-1"></a>LMAJ9 <span class="ot">&lt;-</span> <span class="fu">LMAJ</span>(long_format, <span class="at">s =</span> <span class="dv">9</span>, <span class="at">from =</span> <span class="dv">1</span>, <span class="at">method =</span> <span class="st">"aalen"</span>)</span>
<span id="cb82-83"><a href="#cb82-83" aria-hidden="true" tabindex="-1"></a>LMAJ9_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(LMAJ9<span class="sc">$</span>time, LMAJ9<span class="sc">$</span>pstate3))</span>
<span id="cb82-84"><a href="#cb82-84" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(LMAJ9_data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"time"</span>, <span class="st">"p02"</span>)</span>
<span id="cb82-85"><a href="#cb82-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-86"><a href="#cb82-86" aria-hidden="true" tabindex="-1"></a>LMAJ9_max60 <span class="ot">&lt;-</span> <span class="fu">subset</span>(LMAJ9, time <span class="sc">&lt;=</span> <span class="dv">60</span>)</span>
<span id="cb82-87"><a href="#cb82-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-88"><a href="#cb82-88" aria-hidden="true" tabindex="-1"></a><span class="co"># PREPARATIONS FOR SEMI-MARKOV AND PLUG-IN ESTIMATORS #########################</span></span>
<span id="cb82-89"><a href="#cb82-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-90"><a href="#cb82-90" aria-hidden="true" tabindex="-1"></a><span class="co">#Transforming data to data.table for faster speed</span></span>
<span id="cb82-91"><a href="#cb82-91" aria-hidden="true" tabindex="-1"></a>bmt_dt <span class="ot">&lt;-</span> <span class="fu">setDT</span>(bmt)</span>
<span id="cb82-92"><a href="#cb82-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-93"><a href="#cb82-93" aria-hidden="true" tabindex="-1"></a><span class="co">#Number of patients in state 0 at x, Y0(x)</span></span>
<span id="cb82-94"><a href="#cb82-94" aria-hidden="true" tabindex="-1"></a>patients_in_0 <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb82-95"><a href="#cb82-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">nrow</span>(bmt_dt[tgvhd <span class="sc">&gt;</span> (x <span class="sc">-</span> <span class="fl">0.000001</span>)]))}</span>
<span id="cb82-96"><a href="#cb82-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-97"><a href="#cb82-97" aria-hidden="true" tabindex="-1"></a><span class="co">#Number of patients in state 1 at x, Y1(x)</span></span>
<span id="cb82-98"><a href="#cb82-98" aria-hidden="true" tabindex="-1"></a>patients_in_1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb82-99"><a href="#cb82-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">nrow</span>(bmt_dt[gvhd <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> tgvhd <span class="sc">&lt;</span> x <span class="sc">&amp;</span> intxrel <span class="sc">&gt;</span> (x <span class="sc">-</span> <span class="fl">0.000001</span>)]))}</span>
<span id="cb82-100"><a href="#cb82-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-101"><a href="#cb82-101" aria-hidden="true" tabindex="-1"></a><span class="co">#Number of patients in state 2 at x, Y2(x)</span></span>
<span id="cb82-102"><a href="#cb82-102" aria-hidden="true" tabindex="-1"></a>patients_in_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb82-103"><a href="#cb82-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">nrow</span>(bmt_dt[rel <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> intxrel <span class="sc">&lt;</span> x <span class="sc">&amp;</span> intxsurv <span class="sc">&gt;</span> (x <span class="sc">-</span> <span class="fl">0.000001</span>)]))}</span>
<span id="cb82-104"><a href="#cb82-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-105"><a href="#cb82-105" aria-hidden="true" tabindex="-1"></a><span class="co">#alpha01 = dN01(u)/Y0(u)</span></span>
<span id="cb82-106"><a href="#cb82-106" aria-hidden="true" tabindex="-1"></a>alpha01 <span class="ot">&lt;-</span> <span class="cf">function</span>(u){ </span>
<span id="cb82-107"><a href="#cb82-107" aria-hidden="true" tabindex="-1"></a>  dN01 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(bmt_dt[tgvhd <span class="sc">==</span> u <span class="sc">&amp;</span> gvhd <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb82-108"><a href="#cb82-108" aria-hidden="true" tabindex="-1"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">patients_in_0</span>(u)</span>
<span id="cb82-109"><a href="#cb82-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dN01<span class="sc">/</span>Y0)}</span>
<span id="cb82-110"><a href="#cb82-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-111"><a href="#cb82-111" aria-hidden="true" tabindex="-1"></a><span class="co">#alpha02 = dN02(u)/Y0(u)</span></span>
<span id="cb82-112"><a href="#cb82-112" aria-hidden="true" tabindex="-1"></a>alpha02 <span class="ot">&lt;-</span> <span class="cf">function</span>(u){ </span>
<span id="cb82-113"><a href="#cb82-113" aria-hidden="true" tabindex="-1"></a>  dN02 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(bmt_dt[gvhd <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> rel <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> intxrel <span class="sc">==</span> u])</span>
<span id="cb82-114"><a href="#cb82-114" aria-hidden="true" tabindex="-1"></a>  Y0 <span class="ot">&lt;-</span> <span class="fu">patients_in_0</span>(u)</span>
<span id="cb82-115"><a href="#cb82-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dN02<span class="sc">/</span>Y0)}</span>
<span id="cb82-116"><a href="#cb82-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-117"><a href="#cb82-117" aria-hidden="true" tabindex="-1"></a><span class="co">#alpha12 = dN12(u)/Y1(u)</span></span>
<span id="cb82-118"><a href="#cb82-118" aria-hidden="true" tabindex="-1"></a>alpha12 <span class="ot">&lt;-</span> <span class="cf">function</span>(u){ </span>
<span id="cb82-119"><a href="#cb82-119" aria-hidden="true" tabindex="-1"></a>  dN12 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(bmt_dt[gvhd <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> rel <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> intxrel <span class="sc">==</span> u])</span>
<span id="cb82-120"><a href="#cb82-120" aria-hidden="true" tabindex="-1"></a>  Y1 <span class="ot">&lt;-</span> <span class="fu">patients_in_1</span>(u)</span>
<span id="cb82-121"><a href="#cb82-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dN12<span class="sc">/</span>Y1)}</span>
<span id="cb82-122"><a href="#cb82-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-123"><a href="#cb82-123" aria-hidden="true" tabindex="-1"></a><span class="co">#P_00(s,u -) = \Pi_{u \in (s,t]} (1 - dN0(u)/Y0(u))</span></span>
<span id="cb82-124"><a href="#cb82-124" aria-hidden="true" tabindex="-1"></a>p00 <span class="ot">&lt;-</span> <span class="cf">function</span>(start, end){</span>
<span id="cb82-125"><a href="#cb82-125" aria-hidden="true" tabindex="-1"></a>  exits <span class="ot">&lt;-</span> bmt_dt[outof0 <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> tgvhd <span class="sc">&gt;</span> start <span class="sc">&amp;</span> tgvhd <span class="sc">&lt;=</span> (end <span class="sc">-</span> <span class="fl">0.000001</span>)]<span class="sc">$</span>tgvhd <span class="co">#Exits from state 0 in (s,t]</span></span>
<span id="cb82-126"><a href="#cb82-126" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(exits) <span class="sc">==</span> <span class="dv">0</span>){prob <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb82-127"><a href="#cb82-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-128"><a href="#cb82-128" aria-hidden="true" tabindex="-1"></a>    exits_unique <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">table</span>(exits))</span>
<span id="cb82-129"><a href="#cb82-129" aria-hidden="true" tabindex="-1"></a>    Y0 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(exits_unique<span class="sc">$</span>exits)), patients_in_0)</span>
<span id="cb82-130"><a href="#cb82-130" aria-hidden="true" tabindex="-1"></a>    frac <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> exits_unique<span class="sc">$</span>Freq<span class="sc">/</span>Y0)</span>
<span id="cb82-131"><a href="#cb82-131" aria-hidden="true" tabindex="-1"></a>    prob <span class="ot">&lt;-</span> <span class="fu">prod</span>(frac)}</span>
<span id="cb82-132"><a href="#cb82-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob)}</span>
<span id="cb82-133"><a href="#cb82-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-134"><a href="#cb82-134" aria-hidden="true" tabindex="-1"></a><span class="co">#P_11(s,u-) = \Pi_{u \in (s,t]} (1 - dN1(u)/Y1(u))</span></span>
<span id="cb82-135"><a href="#cb82-135" aria-hidden="true" tabindex="-1"></a>p11 <span class="ot">&lt;-</span> <span class="cf">function</span>(start,end){</span>
<span id="cb82-136"><a href="#cb82-136" aria-hidden="true" tabindex="-1"></a>  exits <span class="ot">&lt;-</span> bmt_dt[gvhd <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> intxrel <span class="sc">&lt;=</span> (end<span class="sc">-</span> <span class="fl">0.000001</span>) <span class="sc">&amp;</span> intxrel <span class="sc">&gt;</span> start <span class="sc">&amp;</span> (rel <span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> dead <span class="sc">==</span><span class="dv">1</span>)]<span class="sc">$</span>intxrel <span class="co">#Time of exits from state 1 in (start, end)</span></span>
<span id="cb82-137"><a href="#cb82-137" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(exits) <span class="sc">==</span> <span class="dv">0</span>){prob <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb82-138"><a href="#cb82-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb82-139"><a href="#cb82-139" aria-hidden="true" tabindex="-1"></a>    exits_unique <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">table</span>(exits))</span>
<span id="cb82-140"><a href="#cb82-140" aria-hidden="true" tabindex="-1"></a>    Y1 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(exits_unique<span class="sc">$</span>exits)), patients_in_1)</span>
<span id="cb82-141"><a href="#cb82-141" aria-hidden="true" tabindex="-1"></a>    frac <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> exits_unique<span class="sc">$</span>Freq<span class="sc">/</span>Y1)</span>
<span id="cb82-142"><a href="#cb82-142" aria-hidden="true" tabindex="-1"></a>    prob <span class="ot">&lt;-</span> <span class="fu">prod</span>(frac)}</span>
<span id="cb82-143"><a href="#cb82-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob)}</span>
<span id="cb82-144"><a href="#cb82-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-145"><a href="#cb82-145" aria-hidden="true" tabindex="-1"></a><span class="co">#Times of 0 -&gt; 1 transitions</span></span>
<span id="cb82-146"><a href="#cb82-146" aria-hidden="true" tabindex="-1"></a>time01 <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(bmt_dt[gvhd <span class="sc">==</span> <span class="dv">1</span>]<span class="sc">$</span>tgvhd))</span>
<span id="cb82-147"><a href="#cb82-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-148"><a href="#cb82-148" aria-hidden="true" tabindex="-1"></a><span class="co">#Times of 1 -&gt; 2 transitions</span></span>
<span id="cb82-149"><a href="#cb82-149" aria-hidden="true" tabindex="-1"></a>time12 <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(bmt_dt[gvhd <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> rel <span class="sc">==</span> <span class="dv">1</span>]<span class="sc">$</span>intxrel)) </span>
<span id="cb82-150"><a href="#cb82-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-151"><a href="#cb82-151" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb82-152"><a href="#cb82-152" aria-hidden="true" tabindex="-1"></a><span class="co"># FOR REPRODUCING THE TABLE p11alpha12. Takes approximately 10 minutes</span></span>
<span id="cb82-153"><a href="#cb82-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-154"><a href="#cb82-154" aria-hidden="true" tabindex="-1"></a><span class="co">#p11alpha12_table_raw &lt;- matrix(NA, nrow = length(time01), ncol = length(time12))</span></span>
<span id="cb82-155"><a href="#cb82-155" aria-hidden="true" tabindex="-1"></a><span class="co">#colnames(p11alpha12_table_raw) &lt;- time12</span></span>
<span id="cb82-156"><a href="#cb82-156" aria-hidden="true" tabindex="-1"></a><span class="co">#rownames(p11alpha12_table_raw) &lt;- time01</span></span>
<span id="cb82-157"><a href="#cb82-157" aria-hidden="true" tabindex="-1"></a><span class="co">#for (i in 1:length(time01)){</span></span>
<span id="cb82-158"><a href="#cb82-158" aria-hidden="true" tabindex="-1"></a><span class="co">#  for (j in 1:length(time12)){</span></span>
<span id="cb82-159"><a href="#cb82-159" aria-hidden="true" tabindex="-1"></a><span class="co">#    if (time01[i] &gt; time12[j]){p11alpha12_table_raw[i,j] &lt;- NA}</span></span>
<span id="cb82-160"><a href="#cb82-160" aria-hidden="true" tabindex="-1"></a><span class="co">#    else {p11alpha12_table_raw[i,j] &lt;- p11(time01[i],time12[j])*alpha12(time12[j])</span><span class="re">}}}</span></span>
<span id="cb82-161"><a href="#cb82-161" aria-hidden="true" tabindex="-1"></a><span class="co">#p11alpha12_table &lt;- as.data.table(p11alpha12_table_raw, keep.rownames = TRUE)</span></span>
<span id="cb82-162"><a href="#cb82-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-163"><a href="#cb82-163" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb82-164"><a href="#cb82-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-165"><a href="#cb82-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Data.table of P11(u,x-)alpha12(x)</span></span>
<span id="cb82-166"><a href="#cb82-166" aria-hidden="true" tabindex="-1"></a>p11alpha12_table <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/p11alpha12tabel.csv"</span>)</span>
<span id="cb82-167"><a href="#cb82-167" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(p11alpha12_table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"rn"</span>,time12)</span>
<span id="cb82-168"><a href="#cb82-168" aria-hidden="true" tabindex="-1"></a>p11alpha12_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(p11alpha12_table)</span>
<span id="cb82-169"><a href="#cb82-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-170"><a href="#cb82-170" aria-hidden="true" tabindex="-1"></a><span class="co">#P_11(u,x-)alpha12(x)</span></span>
<span id="cb82-171"><a href="#cb82-171" aria-hidden="true" tabindex="-1"></a>p11alpha12 <span class="ot">&lt;-</span> <span class="cf">function</span>(start,end){</span>
<span id="cb82-172"><a href="#cb82-172" aria-hidden="true" tabindex="-1"></a>  start_point <span class="ot">&lt;-</span> <span class="fu">length</span>(time01[time01 <span class="sc">&lt;=</span> start])</span>
<span id="cb82-173"><a href="#cb82-173" aria-hidden="true" tabindex="-1"></a>  end_point <span class="ot">&lt;-</span> <span class="fu">length</span>(time12[time12 <span class="sc">&lt;=</span> end]) <span class="sc">+</span><span class="dv">1</span></span>
<span id="cb82-174"><a href="#cb82-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.numeric</span>(p11alpha12_table[start_point,end_point, <span class="at">with =</span> <span class="cn">FALSE</span>]))}</span>
<span id="cb82-175"><a href="#cb82-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-176"><a href="#cb82-176" aria-hidden="true" tabindex="-1"></a><span class="co">#Compilation of functions for tiny increase in speed performance</span></span>
<span id="cb82-177"><a href="#cb82-177" aria-hidden="true" tabindex="-1"></a>alpha01 <span class="ot">&lt;-</span> <span class="fu">cmpfun</span>(alpha01)</span>
<span id="cb82-178"><a href="#cb82-178" aria-hidden="true" tabindex="-1"></a>alpha02 <span class="ot">&lt;-</span> <span class="fu">cmpfun</span>(alpha02)</span>
<span id="cb82-179"><a href="#cb82-179" aria-hidden="true" tabindex="-1"></a>alpha12 <span class="ot">&lt;-</span> <span class="fu">cmpfun</span>(alpha12)</span>
<span id="cb82-180"><a href="#cb82-180" aria-hidden="true" tabindex="-1"></a>patients_in_0 <span class="ot">&lt;-</span> <span class="fu">cmpfun</span>(patients_in_0)</span>
<span id="cb82-181"><a href="#cb82-181" aria-hidden="true" tabindex="-1"></a>patients_in_1 <span class="ot">&lt;-</span> <span class="fu">cmpfun</span>(patients_in_1)</span>
<span id="cb82-182"><a href="#cb82-182" aria-hidden="true" tabindex="-1"></a>patients_in_2 <span class="ot">&lt;-</span> <span class="fu">cmpfun</span>(patients_in_2)</span>
<span id="cb82-183"><a href="#cb82-183" aria-hidden="true" tabindex="-1"></a>p11alpha12 <span class="ot">&lt;-</span> <span class="fu">cmpfun</span>(p11alpha12)</span>
<span id="cb82-184"><a href="#cb82-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-185"><a href="#cb82-185" aria-hidden="true" tabindex="-1"></a><span class="co"># S = 3 #######################################################################</span></span>
<span id="cb82-186"><a href="#cb82-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-187"><a href="#cb82-187" aria-hidden="true" tabindex="-1"></a><span class="co">#Time of 0 -&gt; 1 transitions for u &gt; 3</span></span>
<span id="cb82-188"><a href="#cb82-188" aria-hidden="true" tabindex="-1"></a>time01_s3 <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(bmt_dt[tgvhd <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> gvhd <span class="sc">==</span> <span class="dv">1</span>]<span class="sc">$</span>tgvhd))</span>
<span id="cb82-189"><a href="#cb82-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-190"><a href="#cb82-190" aria-hidden="true" tabindex="-1"></a><span class="co">#Time of 0 -&gt; 2 transitions for u &gt; 3  </span></span>
<span id="cb82-191"><a href="#cb82-191" aria-hidden="true" tabindex="-1"></a>time02_s3 <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(bmt_dt[gvhd <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> rel <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> intxrel <span class="sc">&gt;</span> <span class="dv">3</span>]<span class="sc">$</span>intxrel))</span>
<span id="cb82-192"><a href="#cb82-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-193"><a href="#cb82-193" aria-hidden="true" tabindex="-1"></a><span class="co">#Matrix where 1st column is times for 0 -&gt; 1 transition, u,</span></span>
<span id="cb82-194"><a href="#cb82-194" aria-hidden="true" tabindex="-1"></a><span class="co">#and 4th column is P00(3,u -)*alpha01(u)</span></span>
<span id="cb82-195"><a href="#cb82-195" aria-hidden="true" tabindex="-1"></a>p00alpha01_s3 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">length</span>(time01_s3), <span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb82-196"><a href="#cb82-196" aria-hidden="true" tabindex="-1"></a>p00alpha01_s3[, <span class="dv">1</span>] <span class="ot">&lt;-</span> time01_s3 <span class="co">#u, times of 0-&gt;1 transitions after 3 months</span></span>
<span id="cb82-197"><a href="#cb82-197" aria-hidden="true" tabindex="-1"></a>p00alpha01_s3[, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(p00alpha01_s3[,<span class="dv">1</span>], p00, <span class="at">start =</span> <span class="dv">3</span>) <span class="co">#P00(3,u -)</span></span>
<span id="cb82-198"><a href="#cb82-198" aria-hidden="true" tabindex="-1"></a>p00alpha01_s3[, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(p00alpha01_s3[,<span class="dv">1</span>], alpha01) <span class="co">#alpha01(u)</span></span>
<span id="cb82-199"><a href="#cb82-199" aria-hidden="true" tabindex="-1"></a>p00alpha01_s3[, <span class="dv">4</span>] <span class="ot">&lt;-</span> p00alpha01_s3[,<span class="dv">2</span>]<span class="sc">*</span>p00alpha01_s3[,<span class="dv">3</span>] <span class="co">#P00(3,u -)*alpha01(u)</span></span>
<span id="cb82-200"><a href="#cb82-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-201"><a href="#cb82-201" aria-hidden="true" tabindex="-1"></a><span class="co">#Matrix where 1st column is times for 0 -&gt; 2 transition, u,</span></span>
<span id="cb82-202"><a href="#cb82-202" aria-hidden="true" tabindex="-1"></a><span class="co">#and 4th column is P00(3,u -)*alpha02(u)</span></span>
<span id="cb82-203"><a href="#cb82-203" aria-hidden="true" tabindex="-1"></a>p00alpha02_s3 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">length</span>(time02_s3), <span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb82-204"><a href="#cb82-204" aria-hidden="true" tabindex="-1"></a>p00alpha02_s3[, <span class="dv">1</span>] <span class="ot">&lt;-</span> time02_s3 <span class="co">#u, times of 0-&gt;2 transitions after 3 months</span></span>
<span id="cb82-205"><a href="#cb82-205" aria-hidden="true" tabindex="-1"></a>p00alpha02_s3[, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(p00alpha02_s3[,<span class="dv">1</span>], p00, <span class="at">start =</span> <span class="dv">3</span>) <span class="co">#P00(3,u -)</span></span>
<span id="cb82-206"><a href="#cb82-206" aria-hidden="true" tabindex="-1"></a>p00alpha02_s3[, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(p00alpha02_s3[,<span class="dv">1</span>], alpha02) <span class="co">#alpha02(u) </span></span>
<span id="cb82-207"><a href="#cb82-207" aria-hidden="true" tabindex="-1"></a>p00alpha02_s3[, <span class="dv">4</span>] <span class="ot">&lt;-</span> p00alpha02_s3[,<span class="dv">2</span>]<span class="sc">*</span>p00alpha02_s3[,<span class="dv">3</span>] <span class="co">#P00(3,u -)*alpha(u)</span></span>
<span id="cb82-208"><a href="#cb82-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-209"><a href="#cb82-209" aria-hidden="true" tabindex="-1"></a><span class="co"># S = 9 #######################################################################</span></span>
<span id="cb82-210"><a href="#cb82-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-211"><a href="#cb82-211" aria-hidden="true" tabindex="-1"></a><span class="co">#Time of 0 -&gt; 1 transitions for u &gt; 9</span></span>
<span id="cb82-212"><a href="#cb82-212" aria-hidden="true" tabindex="-1"></a>time01_s9 <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(bmt_dt[tgvhd <span class="sc">&gt;</span> <span class="dv">9</span> <span class="sc">&amp;</span> gvhd <span class="sc">==</span> <span class="dv">1</span>]<span class="sc">$</span>tgvhd))</span>
<span id="cb82-213"><a href="#cb82-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-214"><a href="#cb82-214" aria-hidden="true" tabindex="-1"></a><span class="co">#Time of 0 -&gt; 2 transitions for u &gt; 9</span></span>
<span id="cb82-215"><a href="#cb82-215" aria-hidden="true" tabindex="-1"></a>time02_s9 <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(bmt_dt[gvhd <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> rel <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> intxrel <span class="sc">&gt;</span> <span class="dv">9</span>]<span class="sc">$</span>intxrel))</span>
<span id="cb82-216"><a href="#cb82-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-217"><a href="#cb82-217" aria-hidden="true" tabindex="-1"></a><span class="co">#Matrix where 1st column is times for 0 -&gt; 1 transition, u,</span></span>
<span id="cb82-218"><a href="#cb82-218" aria-hidden="true" tabindex="-1"></a><span class="co">#and 4th column is P00(6,u -)*alpha01(u)</span></span>
<span id="cb82-219"><a href="#cb82-219" aria-hidden="true" tabindex="-1"></a>p00alpha01_s9 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">length</span>(time01_s9), <span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb82-220"><a href="#cb82-220" aria-hidden="true" tabindex="-1"></a>p00alpha01_s9[, <span class="dv">1</span>] <span class="ot">&lt;-</span> time01_s9 <span class="co">#u, times of 0-&gt;1 transitions after 9 months</span></span>
<span id="cb82-221"><a href="#cb82-221" aria-hidden="true" tabindex="-1"></a>p00alpha01_s9[, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(p00alpha01_s9[,<span class="dv">1</span>], p00, <span class="at">start =</span> <span class="dv">9</span>) <span class="co">#P00(9,u -)</span></span>
<span id="cb82-222"><a href="#cb82-222" aria-hidden="true" tabindex="-1"></a>p00alpha01_s9[, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(p00alpha01_s9[,<span class="dv">1</span>], alpha01) <span class="co">#alpha01(u)</span></span>
<span id="cb82-223"><a href="#cb82-223" aria-hidden="true" tabindex="-1"></a>p00alpha01_s9[, <span class="dv">4</span>] <span class="ot">&lt;-</span> p00alpha01_s9[,<span class="dv">2</span>]<span class="sc">*</span>p00alpha01_s9[,<span class="dv">3</span>] <span class="co">#P00(9,u -)*alpha01(u)</span></span>
<span id="cb82-224"><a href="#cb82-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-225"><a href="#cb82-225" aria-hidden="true" tabindex="-1"></a><span class="co">#Matrix where 1st column is times for 0 -&gt; 2 transition, u,</span></span>
<span id="cb82-226"><a href="#cb82-226" aria-hidden="true" tabindex="-1"></a><span class="co">#and 4th column is P00(9,u -)*alpha02(u)</span></span>
<span id="cb82-227"><a href="#cb82-227" aria-hidden="true" tabindex="-1"></a>p00alpha02_s9 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">length</span>(time02_s9), <span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb82-228"><a href="#cb82-228" aria-hidden="true" tabindex="-1"></a>p00alpha02_s9[, <span class="dv">1</span>] <span class="ot">&lt;-</span> time02_s9 <span class="co">#u, times of 0-&gt;2 transitions after 9 months</span></span>
<span id="cb82-229"><a href="#cb82-229" aria-hidden="true" tabindex="-1"></a>p00alpha02_s9[, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(p00alpha02_s9[,<span class="dv">1</span>], p00, <span class="at">start =</span> <span class="dv">9</span>) <span class="co">#P00(9,u -)</span></span>
<span id="cb82-230"><a href="#cb82-230" aria-hidden="true" tabindex="-1"></a>p00alpha02_s9[, <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(p00alpha02_s9[,<span class="dv">1</span>], alpha02) <span class="co">#alpha02(u) </span></span>
<span id="cb82-231"><a href="#cb82-231" aria-hidden="true" tabindex="-1"></a>p00alpha02_s9[, <span class="dv">4</span>] <span class="ot">&lt;-</span> p00alpha02_s9[,<span class="dv">2</span>]<span class="sc">*</span>p00alpha02_s9[,<span class="dv">3</span>] <span class="co">#P00(9,u -)*alpha(u)</span></span>
<span id="cb82-232"><a href="#cb82-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-233"><a href="#cb82-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-234"><a href="#cb82-234" aria-hidden="true" tabindex="-1"></a><span class="co"># SEMI-MARKOV #################################################################</span></span>
<span id="cb82-235"><a href="#cb82-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-236"><a href="#cb82-236" aria-hidden="true" tabindex="-1"></a><span class="co">#Kaplan-Meier for being in state 2 under semi-Markov assumption.</span></span>
<span id="cb82-237"><a href="#cb82-237" aria-hidden="true" tabindex="-1"></a>s2_semi <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(wait2, dead) <span class="sc">~</span><span class="dv">1</span>, <span class="at">data =</span> bmt_dt[rel <span class="sc">==</span><span class="dv">1</span>], <span class="at">type =</span> <span class="st">"kaplan-meier"</span>) </span>
<span id="cb82-238"><a href="#cb82-238" aria-hidden="true" tabindex="-1"></a><span class="co">#Table containing time of observed durations in state 2, and estimates of S2_semi for each time.</span></span>
<span id="cb82-239"><a href="#cb82-239" aria-hidden="true" tabindex="-1"></a>s2_semi_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(s2_semi<span class="sc">$</span>time, s2_semi<span class="sc">$</span>surv))</span>
<span id="cb82-240"><a href="#cb82-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-241"><a href="#cb82-241" aria-hidden="true" tabindex="-1"></a><span class="co">#P_22(s,t) = P_22(t-s) under semi-Markov assumption.</span></span>
<span id="cb82-242"><a href="#cb82-242" aria-hidden="true" tabindex="-1"></a>p22_semi <span class="ot">&lt;-</span> <span class="cf">function</span>(start,end){</span>
<span id="cb82-243"><a href="#cb82-243" aria-hidden="true" tabindex="-1"></a>  duration <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb82-244"><a href="#cb82-244" aria-hidden="true" tabindex="-1"></a>  sub_tabel <span class="ot">&lt;-</span> s2_semi_table[V1 <span class="sc">&lt;=</span> duration]<span class="sc">$</span>V2</span>
<span id="cb82-245"><a href="#cb82-245" aria-hidden="true" tabindex="-1"></a>  p22 <span class="ot">&lt;-</span> sub_tabel[<span class="fu">length</span>(sub_tabel)]</span>
<span id="cb82-246"><a href="#cb82-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p22)}</span>
<span id="cb82-247"><a href="#cb82-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-248"><a href="#cb82-248" aria-hidden="true" tabindex="-1"></a><span class="co"># S = 3 ####################################################################### </span></span>
<span id="cb82-249"><a href="#cb82-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-250"><a href="#cb82-250" aria-hidden="true" tabindex="-1"></a><span class="co">#P_{0-&gt;2}(3,t) = \int_{3}^{t} P_00(3,u-)alpha02(u)P_22(u,t)</span></span>
<span id="cb82-251"><a href="#cb82-251" aria-hidden="true" tabindex="-1"></a>p02_direct_semi_s3 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-252"><a href="#cb82-252" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha02_s3[, <span class="dv">1</span>][p00alpha02_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-253"><a href="#cb82-253" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-254"><a href="#cb82-254" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-255"><a href="#cb82-255" aria-hidden="true" tabindex="-1"></a>    p00alpha2 <span class="ot">&lt;-</span> p00alpha02_s3[, <span class="dv">4</span>][p00alpha02_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-256"><a href="#cb82-256" aria-hidden="true" tabindex="-1"></a>    p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time, p22_semi, <span class="at">end =</span> t)</span>
<span id="cb82-257"><a href="#cb82-257" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha2<span class="sc">*</span>p22)}</span>
<span id="cb82-258"><a href="#cb82-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-259"><a href="#cb82-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-260"><a href="#cb82-260" aria-hidden="true" tabindex="-1"></a><span class="co">#P_{0-&gt;1-&gt;2}(3,t) = \int_{3}^{t} (P_00(3,u-)alpha01(u) \int_{u}^{t} (P_11(u,x-)alpha12(x)P_22(x,t)))</span></span>
<span id="cb82-261"><a href="#cb82-261" aria-hidden="true" tabindex="-1"></a>p02_non_direct_semi_s3 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-262"><a href="#cb82-262" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha01_s3[, <span class="dv">1</span>][p00alpha01_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-263"><a href="#cb82-263" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-264"><a href="#cb82-264" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-265"><a href="#cb82-265" aria-hidden="true" tabindex="-1"></a>    p00alpha1 <span class="ot">&lt;-</span> p00alpha01_s3[, <span class="dv">4</span>][p00alpha01_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-266"><a href="#cb82-266" aria-hidden="true" tabindex="-1"></a>    p12 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(time))</span>
<span id="cb82-267"><a href="#cb82-267" aria-hidden="true" tabindex="-1"></a>    possible_time12 <span class="ot">&lt;-</span> time12[time12 <span class="sc">&lt;</span> t]</span>
<span id="cb82-268"><a href="#cb82-268" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(time)){</span>
<span id="cb82-269"><a href="#cb82-269" aria-hidden="true" tabindex="-1"></a>      time12 <span class="ot">&lt;-</span> possible_time12[possible_time12 <span class="sc">&gt;</span> time[i]]</span>
<span id="cb82-270"><a href="#cb82-270" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(time12) <span class="sc">==</span> <span class="dv">0</span>){p12[i] <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-271"><a href="#cb82-271" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{</span>
<span id="cb82-272"><a href="#cb82-272" aria-hidden="true" tabindex="-1"></a>        p11alpha2 <span class="ot">&lt;-</span> <span class="fu">vapply</span>(time12, p11alpha12, <span class="at">start =</span> time[i], <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb82-273"><a href="#cb82-273" aria-hidden="true" tabindex="-1"></a>        p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time12, p22_semi, <span class="at">end =</span> t)</span>
<span id="cb82-274"><a href="#cb82-274" aria-hidden="true" tabindex="-1"></a>        p12[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(p11alpha2<span class="sc">*</span>p22)}}</span>
<span id="cb82-275"><a href="#cb82-275" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha1<span class="sc">*</span>p12)}</span>
<span id="cb82-276"><a href="#cb82-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-277"><a href="#cb82-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-278"><a href="#cb82-278" aria-hidden="true" tabindex="-1"></a><span class="co">#P_02(s,t) = P_{0-&gt;2}(s,t) + P_{0 -&gt; 1 -&gt; 2}(s,t)</span></span>
<span id="cb82-279"><a href="#cb82-279" aria-hidden="true" tabindex="-1"></a>p02_semi_s3 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-280"><a href="#cb82-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">p02_direct_semi_s3</span>(t) <span class="sc">+</span> <span class="fu">p02_non_direct_semi_s3</span>(t))}</span>
<span id="cb82-281"><a href="#cb82-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-282"><a href="#cb82-282" aria-hidden="true" tabindex="-1"></a><span class="co"># s = 9 #######################################################################</span></span>
<span id="cb82-283"><a href="#cb82-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-284"><a href="#cb82-284" aria-hidden="true" tabindex="-1"></a><span class="co">#P_{0-&gt;2}(9,t) = \int_{9}^{t} P_00(9,u-)alpha02(u)P_22(u,t)</span></span>
<span id="cb82-285"><a href="#cb82-285" aria-hidden="true" tabindex="-1"></a>p02_direct_semi_s9 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-286"><a href="#cb82-286" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha02_s9[, <span class="dv">1</span>][p00alpha02_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-287"><a href="#cb82-287" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-288"><a href="#cb82-288" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-289"><a href="#cb82-289" aria-hidden="true" tabindex="-1"></a>    p00alpha2 <span class="ot">&lt;-</span> p00alpha02_s9[, <span class="dv">4</span>][p00alpha02_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-290"><a href="#cb82-290" aria-hidden="true" tabindex="-1"></a>    p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time, p22_semi, <span class="at">end =</span> t)</span>
<span id="cb82-291"><a href="#cb82-291" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha2<span class="sc">*</span>p22)}</span>
<span id="cb82-292"><a href="#cb82-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-293"><a href="#cb82-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-294"><a href="#cb82-294" aria-hidden="true" tabindex="-1"></a><span class="co">#P_{0 -&gt; 1 -&gt; 2}(9,t) = \int_{9}^{t} (P_00(9,u-)alpha01(u) \int_{u}^{t} (P_11(u,x-)alpha12(x)P_22(x,t)))</span></span>
<span id="cb82-295"><a href="#cb82-295" aria-hidden="true" tabindex="-1"></a>p02_non_direct_semi_s9 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-296"><a href="#cb82-296" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha01_s9[, <span class="dv">1</span>][p00alpha01_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-297"><a href="#cb82-297" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-298"><a href="#cb82-298" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-299"><a href="#cb82-299" aria-hidden="true" tabindex="-1"></a>    p00alpha1 <span class="ot">&lt;-</span> p00alpha01_s9[, <span class="dv">4</span>][p00alpha01_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-300"><a href="#cb82-300" aria-hidden="true" tabindex="-1"></a>    p12 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(time))</span>
<span id="cb82-301"><a href="#cb82-301" aria-hidden="true" tabindex="-1"></a>    possible_time12 <span class="ot">&lt;-</span> time12[time12 <span class="sc">&lt;</span> t]</span>
<span id="cb82-302"><a href="#cb82-302" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(time)){</span>
<span id="cb82-303"><a href="#cb82-303" aria-hidden="true" tabindex="-1"></a>      time12 <span class="ot">&lt;-</span> possible_time12[possible_time12 <span class="sc">&gt;</span> time[i]]</span>
<span id="cb82-304"><a href="#cb82-304" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(time12) <span class="sc">==</span> <span class="dv">0</span>){p12[i] <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-305"><a href="#cb82-305" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{</span>
<span id="cb82-306"><a href="#cb82-306" aria-hidden="true" tabindex="-1"></a>        p11alpha2 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time12, p11alpha12, <span class="at">start =</span> time[i])</span>
<span id="cb82-307"><a href="#cb82-307" aria-hidden="true" tabindex="-1"></a>        p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time12, p22_semi, <span class="at">end =</span> t)</span>
<span id="cb82-308"><a href="#cb82-308" aria-hidden="true" tabindex="-1"></a>        p12[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(p11alpha2<span class="sc">*</span>p22)}}</span>
<span id="cb82-309"><a href="#cb82-309" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha1<span class="sc">*</span>p12)}</span>
<span id="cb82-310"><a href="#cb82-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-311"><a href="#cb82-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-312"><a href="#cb82-312" aria-hidden="true" tabindex="-1"></a><span class="co">#P_02(s,t) = P_{0-&gt;2}(s,t) + P_{0 -&gt; 1 -&gt; 2}(s,t)</span></span>
<span id="cb82-313"><a href="#cb82-313" aria-hidden="true" tabindex="-1"></a>p02_semi_s9 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-314"><a href="#cb82-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">p02_direct_semi_s9</span>(t) <span class="sc">+</span> <span class="fu">p02_non_direct_semi_s9</span>(t))}</span>
<span id="cb82-315"><a href="#cb82-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-316"><a href="#cb82-316" aria-hidden="true" tabindex="-1"></a><span class="co"># Landmark Pepe ###############################################################</span></span>
<span id="cb82-317"><a href="#cb82-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-318"><a href="#cb82-318" aria-hidden="true" tabindex="-1"></a><span class="co"># s = 3 #######################################################################</span></span>
<span id="cb82-319"><a href="#cb82-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-320"><a href="#cb82-320" aria-hidden="true" tabindex="-1"></a><span class="co">#S_012, Kaplan-Meier for being in state 0,1 or 2 among patients in state 0 at time 3</span></span>
<span id="cb82-321"><a href="#cb82-321" aria-hidden="true" tabindex="-1"></a>Pepe_S012_s3 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(intxsurv, dead) <span class="sc">~</span><span class="dv">1</span>, <span class="at">data =</span> bmt_dt[tgvhd <span class="sc">&gt;</span> <span class="dv">3</span>]) </span>
<span id="cb82-322"><a href="#cb82-322" aria-hidden="true" tabindex="-1"></a>Pepe_S012_s3_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(Pepe_S012_s3<span class="sc">$</span>time, Pepe_S012_s3<span class="sc">$</span>surv))</span>
<span id="cb82-323"><a href="#cb82-323" aria-hidden="true" tabindex="-1"></a><span class="co">#S_01, Kaplen-Meier for being in state 0 or 1 among patients in state 0 at time 3</span></span>
<span id="cb82-324"><a href="#cb82-324" aria-hidden="true" tabindex="-1"></a>Pepe_S01_s3 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(intxrel, outof0and1)<span class="sc">~</span><span class="dv">1</span>, <span class="at">data =</span> bmt_dt[tgvhd <span class="sc">&gt;</span> <span class="dv">3</span>]) </span>
<span id="cb82-325"><a href="#cb82-325" aria-hidden="true" tabindex="-1"></a>Pepe_S01_s3_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(Pepe_S01_s3<span class="sc">$</span>time, Pepe_S01_s3<span class="sc">$</span>surv))</span>
<span id="cb82-326"><a href="#cb82-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-327"><a href="#cb82-327" aria-hidden="true" tabindex="-1"></a><span class="co">#S_012(t) - S_01(t) among subjects in state 0 at time 3</span></span>
<span id="cb82-328"><a href="#cb82-328" aria-hidden="true" tabindex="-1"></a>LMPepe_s3 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){ </span>
<span id="cb82-329"><a href="#cb82-329" aria-hidden="true" tabindex="-1"></a>  S012t <span class="ot">&lt;-</span> Pepe_S012_s3_table<span class="sc">$</span>V2[<span class="fu">nrow</span>(Pepe_S012_s3_table[V1 <span class="sc">&lt;=</span> t])]</span>
<span id="cb82-330"><a href="#cb82-330" aria-hidden="true" tabindex="-1"></a>  S01t <span class="ot">&lt;-</span> Pepe_S01_s3_table<span class="sc">$</span>V2[<span class="fu">nrow</span>(Pepe_S01_s3_table[V1 <span class="sc">&lt;=</span> t])]</span>
<span id="cb82-331"><a href="#cb82-331" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(S012t) <span class="sc">==</span> <span class="dv">0</span>){S012t <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb82-332"><a href="#cb82-332" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(S01t) <span class="sc">==</span> <span class="dv">0</span>){S01t <span class="ot">&lt;-</span><span class="dv">1</span>}</span>
<span id="cb82-333"><a href="#cb82-333" aria-hidden="true" tabindex="-1"></a>  Pepe_est <span class="ot">&lt;-</span> S012t <span class="sc">-</span> S01t</span>
<span id="cb82-334"><a href="#cb82-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(Pepe_est)}</span>
<span id="cb82-335"><a href="#cb82-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-336"><a href="#cb82-336" aria-hidden="true" tabindex="-1"></a><span class="co"># s = 9 ######################################################################</span></span>
<span id="cb82-337"><a href="#cb82-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-338"><a href="#cb82-338" aria-hidden="true" tabindex="-1"></a><span class="co">#S_012, Kaplan-Meier for being in state 0,1 or 2 among patients in state 0 at time 9</span></span>
<span id="cb82-339"><a href="#cb82-339" aria-hidden="true" tabindex="-1"></a>Pepe_S012_s9 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(intxsurv, dead) <span class="sc">~</span><span class="dv">1</span>, <span class="at">data =</span> bmt_dt[tgvhd <span class="sc">&gt;</span> <span class="dv">9</span>]) </span>
<span id="cb82-340"><a href="#cb82-340" aria-hidden="true" tabindex="-1"></a>Pepe_S012_s9_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(Pepe_S012_s9<span class="sc">$</span>time, Pepe_S012_s9<span class="sc">$</span>surv))</span>
<span id="cb82-341"><a href="#cb82-341" aria-hidden="true" tabindex="-1"></a><span class="co">#S_01, Kaplan-Meier for being in state 0 or 1 among patients in state 0 at time 9</span></span>
<span id="cb82-342"><a href="#cb82-342" aria-hidden="true" tabindex="-1"></a>Pepe_S01_s9 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(intxrel, outof0and1)<span class="sc">~</span><span class="dv">1</span>, <span class="at">data =</span> bmt_dt[tgvhd <span class="sc">&gt;</span> <span class="dv">9</span>]) </span>
<span id="cb82-343"><a href="#cb82-343" aria-hidden="true" tabindex="-1"></a>Pepe_S01_s9_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(Pepe_S01_s9<span class="sc">$</span>time, Pepe_S01_s9<span class="sc">$</span>surv))</span>
<span id="cb82-344"><a href="#cb82-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-345"><a href="#cb82-345" aria-hidden="true" tabindex="-1"></a><span class="co">#S_012(t) - S_01(t) among subjects in state 0 at time 9</span></span>
<span id="cb82-346"><a href="#cb82-346" aria-hidden="true" tabindex="-1"></a>LMPepe_s9 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){ </span>
<span id="cb82-347"><a href="#cb82-347" aria-hidden="true" tabindex="-1"></a>  S012t <span class="ot">&lt;-</span> Pepe_S012_s9_table<span class="sc">$</span>V2[<span class="fu">nrow</span>(Pepe_S012_s9_table[V1 <span class="sc">&lt;=</span> t])]</span>
<span id="cb82-348"><a href="#cb82-348" aria-hidden="true" tabindex="-1"></a>  S01t <span class="ot">&lt;-</span> Pepe_S01_s9_table<span class="sc">$</span>V2[<span class="fu">nrow</span>(Pepe_S01_s9_table[V1 <span class="sc">&lt;=</span> t])]</span>
<span id="cb82-349"><a href="#cb82-349" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(S012t) <span class="sc">==</span> <span class="dv">0</span>){S012t <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb82-350"><a href="#cb82-350" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(S01t) <span class="sc">==</span> <span class="dv">0</span>){S01t <span class="ot">&lt;-</span><span class="dv">1</span>}</span>
<span id="cb82-351"><a href="#cb82-351" aria-hidden="true" tabindex="-1"></a>  Pepe_est <span class="ot">&lt;-</span> S012t <span class="sc">-</span> S01t</span>
<span id="cb82-352"><a href="#cb82-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(Pepe_est)}</span>
<span id="cb82-353"><a href="#cb82-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-354"><a href="#cb82-354" aria-hidden="true" tabindex="-1"></a><span class="co"># PLUG-IN WITH DURATION OF GVHD AS LINEAR EFFECT ##############################</span></span>
<span id="cb82-355"><a href="#cb82-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-356"><a href="#cb82-356" aria-hidden="true" tabindex="-1"></a><span class="co">#Subset of data only containing subjects with GvHD = 1.</span></span>
<span id="cb82-357"><a href="#cb82-357" aria-hidden="true" tabindex="-1"></a>gvhd_subset <span class="ot">&lt;-</span> <span class="fu">subset</span>(bmt, gvhd <span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb82-358"><a href="#cb82-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-359"><a href="#cb82-359" aria-hidden="true" tabindex="-1"></a><span class="co">#Cox model for alpha12 (GvHD -&gt; Relapse) with a linear effect of duration in state 1 as covariate</span></span>
<span id="cb82-360"><a href="#cb82-360" aria-hidden="true" tabindex="-1"></a>cox_p12_tgvhd <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(tgvhd, intxrel, rel) <span class="sc">~</span> <span class="fu">tt</span>(tgvhd), <span class="at">tt =</span> <span class="cf">function</span>(x,t,...) t <span class="sc">-</span> x, <span class="at">data =</span> gvhd_subset, <span class="at">method =</span> <span class="st">"breslow"</span>) </span>
<span id="cb82-361"><a href="#cb82-361" aria-hidden="true" tabindex="-1"></a>beta12 <span class="ot">&lt;-</span> cox_p12_tgvhd<span class="sc">$</span>coefficients</span>
<span id="cb82-362"><a href="#cb82-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-363"><a href="#cb82-363" aria-hidden="true" tabindex="-1"></a><span class="co">#Baseline hazard for alpha12</span></span>
<span id="cb82-364"><a href="#cb82-364" aria-hidden="true" tabindex="-1"></a>basehaz12 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-365"><a href="#cb82-365" aria-hidden="true" tabindex="-1"></a>  dN12 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(bmt_dt[gvhd <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> rel <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> intxrel <span class="sc">==</span> t])</span>
<span id="cb82-366"><a href="#cb82-366" aria-hidden="true" tabindex="-1"></a>  Y1 <span class="ot">&lt;-</span> bmt_dt[gvhd <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> tgvhd <span class="sc">&lt;</span> t <span class="sc">&amp;</span> intxrel <span class="sc">&gt;</span> (t<span class="fl">-0.0000001</span>)]</span>
<span id="cb82-367"><a href="#cb82-367" aria-hidden="true" tabindex="-1"></a>  Y1beta <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">exp</span>(beta12<span class="sc">*</span>(t <span class="sc">-</span> Y1<span class="sc">$</span>tgvhd)))</span>
<span id="cb82-368"><a href="#cb82-368" aria-hidden="true" tabindex="-1"></a>  base_alpha12 <span class="ot">&lt;-</span> dN12<span class="sc">/</span>Y1beta</span>
<span id="cb82-369"><a href="#cb82-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(base_alpha12)}</span>
<span id="cb82-370"><a href="#cb82-370" aria-hidden="true" tabindex="-1"></a>basehaz12_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(time12,<span class="fu">sapply</span>(time12,basehaz12)))</span>
<span id="cb82-371"><a href="#cb82-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-372"><a href="#cb82-372" aria-hidden="true" tabindex="-1"></a><span class="co">#Hazard for alpha12 with linear effect of duration in GvHD after s.</span></span>
<span id="cb82-373"><a href="#cb82-373" aria-hidden="true" tabindex="-1"></a>haz12 <span class="ot">&lt;-</span> <span class="cf">function</span>(s,x){</span>
<span id="cb82-374"><a href="#cb82-374" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x <span class="sc">%in%</span> time12){</span>
<span id="cb82-375"><a href="#cb82-375" aria-hidden="true" tabindex="-1"></a>    haz <span class="ot">&lt;-</span> basehaz12_table[basehaz12_table<span class="sc">$</span>time12 <span class="sc">==</span> x]<span class="sc">$</span>V2<span class="sc">*</span><span class="fu">exp</span>(beta12<span class="sc">*</span>(x<span class="sc">-</span>s))}</span>
<span id="cb82-376"><a href="#cb82-376" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {haz <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-377"><a href="#cb82-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(haz)}</span>
<span id="cb82-378"><a href="#cb82-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-379"><a href="#cb82-379" aria-hidden="true" tabindex="-1"></a><span class="co">#Time of 1 -&gt; 3 transitions</span></span>
<span id="cb82-380"><a href="#cb82-380" aria-hidden="true" tabindex="-1"></a>time13 <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">sort</span>(bmt_dt[gvhd <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> rel <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> dead <span class="sc">==</span> <span class="dv">1</span>]<span class="sc">$</span>intxsurv))</span>
<span id="cb82-381"><a href="#cb82-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-382"><a href="#cb82-382" aria-hidden="true" tabindex="-1"></a><span class="co">#Cox model for alpha13 (GvHD -&gt; Dead) with a linear effect of duration in state 1 as covariate</span></span>
<span id="cb82-383"><a href="#cb82-383" aria-hidden="true" tabindex="-1"></a>cox_p13_tgvhd <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(tgvhd, intxsurv, dead) <span class="sc">~</span> <span class="fu">tt</span>(tgvhd), <span class="at">tt =</span> <span class="cf">function</span>(x,t,...) t <span class="sc">-</span> x, <span class="at">data =</span> gvhd_subset, <span class="at">method =</span> <span class="st">"breslow"</span>) </span>
<span id="cb82-384"><a href="#cb82-384" aria-hidden="true" tabindex="-1"></a>beta13 <span class="ot">&lt;-</span> cox_p13_tgvhd<span class="sc">$</span>coefficients</span>
<span id="cb82-385"><a href="#cb82-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-386"><a href="#cb82-386" aria-hidden="true" tabindex="-1"></a><span class="co">#Baseline hazard for alpha13, dN13(x)/sum_i(Y_1i(x)*exp(beta(x-T01i)))</span></span>
<span id="cb82-387"><a href="#cb82-387" aria-hidden="true" tabindex="-1"></a>basehaz13 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-388"><a href="#cb82-388" aria-hidden="true" tabindex="-1"></a>  dN13 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(bmt_dt[gvhd <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> dead <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> rel <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> intxsurv <span class="sc">==</span> t])</span>
<span id="cb82-389"><a href="#cb82-389" aria-hidden="true" tabindex="-1"></a>  Y1 <span class="ot">&lt;-</span> bmt_dt[gvhd <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> tgvhd <span class="sc">&lt;</span> t <span class="sc">&amp;</span> intxrel <span class="sc">&gt;</span> (t<span class="fl">-0.0000001</span>)]</span>
<span id="cb82-390"><a href="#cb82-390" aria-hidden="true" tabindex="-1"></a>  Y1beta <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">exp</span>(beta13<span class="sc">*</span>(t <span class="sc">-</span> Y1<span class="sc">$</span>tgvhd)))</span>
<span id="cb82-391"><a href="#cb82-391" aria-hidden="true" tabindex="-1"></a>  base_alpha13 <span class="ot">&lt;-</span> dN13<span class="sc">/</span>Y1beta</span>
<span id="cb82-392"><a href="#cb82-392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(base_alpha13)}</span>
<span id="cb82-393"><a href="#cb82-393" aria-hidden="true" tabindex="-1"></a>basehaz13_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(time13,<span class="fu">sapply</span>(time13,basehaz13)))</span>
<span id="cb82-394"><a href="#cb82-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-395"><a href="#cb82-395" aria-hidden="true" tabindex="-1"></a><span class="co">#Hazard for alpha12 with linear effect of duration in GvHD after s.</span></span>
<span id="cb82-396"><a href="#cb82-396" aria-hidden="true" tabindex="-1"></a>haz13 <span class="ot">&lt;-</span> <span class="cf">function</span>(s,x){</span>
<span id="cb82-397"><a href="#cb82-397" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x <span class="sc">%in%</span> time13){</span>
<span id="cb82-398"><a href="#cb82-398" aria-hidden="true" tabindex="-1"></a>    haz <span class="ot">&lt;-</span> basehaz13_table[basehaz13_table<span class="sc">$</span>time13 <span class="sc">==</span> x]<span class="sc">$</span>V2<span class="sc">*</span><span class="fu">exp</span>(beta13<span class="sc">*</span>(x<span class="sc">-</span>s))}</span>
<span id="cb82-399"><a href="#cb82-399" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {haz <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-400"><a href="#cb82-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(haz)}</span>
<span id="cb82-401"><a href="#cb82-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-402"><a href="#cb82-402" aria-hidden="true" tabindex="-1"></a><span class="co">#P_11(s,t-) with linear effect of duration in state 1</span></span>
<span id="cb82-403"><a href="#cb82-403" aria-hidden="true" tabindex="-1"></a>p11_linear_gvhd <span class="ot">&lt;-</span> <span class="cf">function</span>(start,end){</span>
<span id="cb82-404"><a href="#cb82-404" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (start <span class="sc">&gt;</span> (end <span class="sc">-</span> <span class="fl">0.000001</span>)){p11 <span class="ot">&lt;-</span> <span class="cn">NA</span>}</span>
<span id="cb82-405"><a href="#cb82-405" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-406"><a href="#cb82-406" aria-hidden="true" tabindex="-1"></a>    time12_sub <span class="ot">&lt;-</span> time12[start <span class="sc">&lt;</span> time12 <span class="sc">&amp;</span> time12 <span class="sc">&lt;=</span> (end <span class="sc">-</span> <span class="fl">0.000001</span>)]</span>
<span id="cb82-407"><a href="#cb82-407" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(time12_sub) <span class="sc">==</span> <span class="dv">0</span>){int12 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-408"><a href="#cb82-408" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {int12 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(time12_sub, haz12, <span class="at">s =</span> start))}</span>
<span id="cb82-409"><a href="#cb82-409" aria-hidden="true" tabindex="-1"></a>    time13_sub <span class="ot">&lt;-</span> time13[start <span class="sc">&lt;</span> time13 <span class="sc">&amp;</span> time13 <span class="sc">&lt;=</span> (end <span class="sc">-</span> <span class="fl">0.000001</span>)]</span>
<span id="cb82-410"><a href="#cb82-410" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(time13_sub) <span class="sc">==</span> <span class="dv">0</span>){int13 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-411"><a href="#cb82-411" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>{int13 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(time13_sub, haz13, <span class="at">s =</span> start))}</span>
<span id="cb82-412"><a href="#cb82-412" aria-hidden="true" tabindex="-1"></a>    p11 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>(int12<span class="sc">+</span>int13))}</span>
<span id="cb82-413"><a href="#cb82-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p11)}</span>
<span id="cb82-414"><a href="#cb82-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-415"><a href="#cb82-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-416"><a href="#cb82-416" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb82-417"><a href="#cb82-417" aria-hidden="true" tabindex="-1"></a><span class="co"># For reproducing data.table p11alpha12_linear_gvhd_table. Takes approximately 5 minutes </span></span>
<span id="cb82-418"><a href="#cb82-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-419"><a href="#cb82-419" aria-hidden="true" tabindex="-1"></a><span class="co"># Table of p11alpha12 with linear effect of duration in state 1.</span></span>
<span id="cb82-420"><a href="#cb82-420" aria-hidden="true" tabindex="-1"></a><span class="co">#p11alpha12_table_raw2 &lt;- matrix(NA, nrow = length(time01), ncol = length(time12))</span></span>
<span id="cb82-421"><a href="#cb82-421" aria-hidden="true" tabindex="-1"></a><span class="co">#colnames(p11alpha12_table_raw2) &lt;- time12</span></span>
<span id="cb82-422"><a href="#cb82-422" aria-hidden="true" tabindex="-1"></a><span class="co">#rownames(p11alpha12_table_raw2) &lt;- time01</span></span>
<span id="cb82-423"><a href="#cb82-423" aria-hidden="true" tabindex="-1"></a><span class="co">#for (i in 1:length(time01)){</span></span>
<span id="cb82-424"><a href="#cb82-424" aria-hidden="true" tabindex="-1"></a><span class="co">#  for (j in 1:length(time12)){</span></span>
<span id="cb82-425"><a href="#cb82-425" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (time01[i] &gt; time12[j]){p11alpha12_table_raw2[i,j] &lt;- NA}</span></span>
<span id="cb82-426"><a href="#cb82-426" aria-hidden="true" tabindex="-1"></a><span class="co">#    else {p11alpha12_table_raw2[i,j] &lt;- p11_linear_gvhd(time01[i],time12[j])*haz12(s = time01[i], x = time12[j])</span><span class="re">}}}</span></span>
<span id="cb82-427"><a href="#cb82-427" aria-hidden="true" tabindex="-1"></a><span class="co">#p11alpha12_linear_gvhd_table &lt;- as.data.table(p11alpha12_table_raw2, keep.rownames = TRUE)</span></span>
<span id="cb82-428"><a href="#cb82-428" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb82-429"><a href="#cb82-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-430"><a href="#cb82-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-431"><a href="#cb82-431" aria-hidden="true" tabindex="-1"></a>p11alpha12_linear_gvhd_table <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/p11alpha12-linear-gvhd.csv"</span>)</span>
<span id="cb82-432"><a href="#cb82-432" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(p11alpha12_linear_gvhd_table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"rn"</span>,time12)</span>
<span id="cb82-433"><a href="#cb82-433" aria-hidden="true" tabindex="-1"></a>p11alpha12_linear_gvhd_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(p11alpha12_linear_gvhd_table)</span>
<span id="cb82-434"><a href="#cb82-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-435"><a href="#cb82-435" aria-hidden="true" tabindex="-1"></a><span class="co">#P_11(u,x-)alpha12(x) with linear effect of duration in state 1.</span></span>
<span id="cb82-436"><a href="#cb82-436" aria-hidden="true" tabindex="-1"></a>p11alpha12_lingvhd <span class="ot">&lt;-</span> <span class="cf">function</span>(start,end){</span>
<span id="cb82-437"><a href="#cb82-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">unlist</span>(p11alpha12_linear_gvhd_table[(<span class="fu">match</span>(start,time01)), (<span class="fu">match</span>(end, time12) <span class="sc">+</span> <span class="dv">1</span>), <span class="at">with =</span> <span class="cn">FALSE</span>]))}</span>
<span id="cb82-438"><a href="#cb82-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-439"><a href="#cb82-439" aria-hidden="true" tabindex="-1"></a><span class="co">#S2 = \Pi_{u &lt;= t} (1 - dN2(u)/Y2(u)), Kaplan-Meier</span></span>
<span id="cb82-440"><a href="#cb82-440" aria-hidden="true" tabindex="-1"></a>S2_markov <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-441"><a href="#cb82-441" aria-hidden="true" tabindex="-1"></a>  exits <span class="ot">&lt;-</span> bmt_dt[rel <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> dead <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> intxsurv <span class="sc">&lt;=</span> t]<span class="sc">$</span>intxsurv</span>
<span id="cb82-442"><a href="#cb82-442" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(exits) <span class="sc">==</span> <span class="dv">0</span>) {prob <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb82-443"><a href="#cb82-443" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-444"><a href="#cb82-444" aria-hidden="true" tabindex="-1"></a>    exits_unique <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">table</span>(exits))</span>
<span id="cb82-445"><a href="#cb82-445" aria-hidden="true" tabindex="-1"></a>    Y2 <span class="ot">&lt;-</span> <span class="fu">vapply</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(exits_unique<span class="sc">$</span>exits)), patients_in_2, <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb82-446"><a href="#cb82-446" aria-hidden="true" tabindex="-1"></a>    frac <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> exits_unique<span class="sc">$</span>Freq<span class="sc">/</span>Y2)</span>
<span id="cb82-447"><a href="#cb82-447" aria-hidden="true" tabindex="-1"></a>    prob <span class="ot">&lt;-</span> <span class="fu">prod</span>(frac)}</span>
<span id="cb82-448"><a href="#cb82-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob)}</span>
<span id="cb82-449"><a href="#cb82-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-450"><a href="#cb82-450" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb82-451"><a href="#cb82-451" aria-hidden="true" tabindex="-1"></a><span class="co"># For reproducing S2_markov_table. Takes approximately 10 minutes. </span></span>
<span id="cb82-452"><a href="#cb82-452" aria-hidden="true" tabindex="-1"></a><span class="co">#Data.table with 1st column times, t, and 2nd column S2_markov(t)</span></span>
<span id="cb82-453"><a href="#cb82-453" aria-hidden="true" tabindex="-1"></a><span class="co">#times_for_S2_markov &lt;- seq(0,149.34, by = 0.01)</span></span>
<span id="cb82-454"><a href="#cb82-454" aria-hidden="true" tabindex="-1"></a><span class="co">#S2_markov_of_time &lt;- sapply(times_for_S2_markov, S2_markov)</span></span>
<span id="cb82-455"><a href="#cb82-455" aria-hidden="true" tabindex="-1"></a><span class="co">#S2_markov_table &lt;- as.data.table(cbind(times_for_S2_markov, S2_markov_of_time))</span></span>
<span id="cb82-456"><a href="#cb82-456" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb82-457"><a href="#cb82-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-458"><a href="#cb82-458" aria-hidden="true" tabindex="-1"></a>s2_markov_table <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/s2_table.csv"</span>)</span>
<span id="cb82-459"><a href="#cb82-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-460"><a href="#cb82-460" aria-hidden="true" tabindex="-1"></a><span class="co">#P22(u,t) = S2(t)/S2(u)</span></span>
<span id="cb82-461"><a href="#cb82-461" aria-hidden="true" tabindex="-1"></a>p22_markov <span class="ot">&lt;-</span> <span class="cf">function</span>(start,end){</span>
<span id="cb82-462"><a href="#cb82-462" aria-hidden="true" tabindex="-1"></a>  s2_start <span class="ot">&lt;-</span> s2_markov_table[start<span class="sc">*</span><span class="dv">100</span> <span class="sc">+</span> <span class="dv">1</span>,<span class="dv">2</span>]</span>
<span id="cb82-463"><a href="#cb82-463" aria-hidden="true" tabindex="-1"></a>  s2_end <span class="ot">&lt;-</span> s2_markov_table[end<span class="sc">*</span><span class="dv">100</span> <span class="sc">+</span> <span class="dv">1</span>,<span class="dv">2</span>]</span>
<span id="cb82-464"><a href="#cb82-464" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.numeric</span>(s2_end<span class="sc">/</span>s2_start))}</span>
<span id="cb82-465"><a href="#cb82-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-466"><a href="#cb82-466" aria-hidden="true" tabindex="-1"></a><span class="co"># s = 3 #####################################################################</span></span>
<span id="cb82-467"><a href="#cb82-467" aria-hidden="true" tabindex="-1"></a>p02_direct_lingvhd_s3 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-468"><a href="#cb82-468" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha02_s3[, <span class="dv">1</span>][p00alpha02_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-469"><a href="#cb82-469" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-470"><a href="#cb82-470" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-471"><a href="#cb82-471" aria-hidden="true" tabindex="-1"></a>    p00alpha2 <span class="ot">&lt;-</span> p00alpha02_s3[, <span class="dv">4</span>][p00alpha02_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-472"><a href="#cb82-472" aria-hidden="true" tabindex="-1"></a>    p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time, p22_markov, <span class="at">end =</span> t)</span>
<span id="cb82-473"><a href="#cb82-473" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha2<span class="sc">*</span>p22)}</span>
<span id="cb82-474"><a href="#cb82-474" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-475"><a href="#cb82-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-476"><a href="#cb82-476" aria-hidden="true" tabindex="-1"></a><span class="co">#P_{0 -&gt; 1 -&gt; 2}(9,t) = \int_{9}^{t} (P_00(9,u-)alpha01(u) \int_{u}^{t} (P_11(u,x-)alpha12(x)P_22(x,t)))</span></span>
<span id="cb82-477"><a href="#cb82-477" aria-hidden="true" tabindex="-1"></a>p02_non_direct_lingvhd_s3 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-478"><a href="#cb82-478" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha01_s3[, <span class="dv">1</span>][p00alpha01_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-479"><a href="#cb82-479" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-480"><a href="#cb82-480" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-481"><a href="#cb82-481" aria-hidden="true" tabindex="-1"></a>    p00alpha1 <span class="ot">&lt;-</span> p00alpha01_s3[, <span class="dv">4</span>][p00alpha01_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-482"><a href="#cb82-482" aria-hidden="true" tabindex="-1"></a>    p12 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(time))</span>
<span id="cb82-483"><a href="#cb82-483" aria-hidden="true" tabindex="-1"></a>    possible_time12 <span class="ot">&lt;-</span> time12[time12 <span class="sc">&lt;</span> t]</span>
<span id="cb82-484"><a href="#cb82-484" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(time)){</span>
<span id="cb82-485"><a href="#cb82-485" aria-hidden="true" tabindex="-1"></a>      new_time12 <span class="ot">&lt;-</span> possible_time12[possible_time12 <span class="sc">&gt;</span> time[i]]</span>
<span id="cb82-486"><a href="#cb82-486" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(new_time12) <span class="sc">==</span> <span class="dv">0</span>){p12[i] <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-487"><a href="#cb82-487" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{</span>
<span id="cb82-488"><a href="#cb82-488" aria-hidden="true" tabindex="-1"></a>        p11alpha2 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(new_time12, p11alpha12_lingvhd, <span class="at">start =</span> time[i])</span>
<span id="cb82-489"><a href="#cb82-489" aria-hidden="true" tabindex="-1"></a>        p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(new_time12, p22_markov, <span class="at">end =</span> t)</span>
<span id="cb82-490"><a href="#cb82-490" aria-hidden="true" tabindex="-1"></a>        p12[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(p11alpha2<span class="sc">*</span>p22)}}</span>
<span id="cb82-491"><a href="#cb82-491" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha1<span class="sc">*</span>p12)}</span>
<span id="cb82-492"><a href="#cb82-492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-493"><a href="#cb82-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-494"><a href="#cb82-494" aria-hidden="true" tabindex="-1"></a><span class="co">#P_02(s,t) = P_{0-&gt;2}(s,t) + P_{0 -&gt; 1 -&gt; 2}(s,t)</span></span>
<span id="cb82-495"><a href="#cb82-495" aria-hidden="true" tabindex="-1"></a>p02_lingvhd_s3 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-496"><a href="#cb82-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">p02_direct_lingvhd_s3</span>(t) <span class="sc">+</span> <span class="fu">p02_non_direct_lingvhd_s3</span>(t))}</span>
<span id="cb82-497"><a href="#cb82-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-498"><a href="#cb82-498" aria-hidden="true" tabindex="-1"></a><span class="co"># s = 9 #####################################################################</span></span>
<span id="cb82-499"><a href="#cb82-499" aria-hidden="true" tabindex="-1"></a>p02_direct_lingvhd_s9 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-500"><a href="#cb82-500" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha02_s9[, <span class="dv">1</span>][p00alpha02_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-501"><a href="#cb82-501" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-502"><a href="#cb82-502" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-503"><a href="#cb82-503" aria-hidden="true" tabindex="-1"></a>    p00alpha2 <span class="ot">&lt;-</span> p00alpha02_s9[, <span class="dv">4</span>][p00alpha02_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-504"><a href="#cb82-504" aria-hidden="true" tabindex="-1"></a>    p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time, p22_markov, <span class="at">end =</span> t)</span>
<span id="cb82-505"><a href="#cb82-505" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha2<span class="sc">*</span>p22)}</span>
<span id="cb82-506"><a href="#cb82-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-507"><a href="#cb82-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-508"><a href="#cb82-508" aria-hidden="true" tabindex="-1"></a><span class="co">#P_{0 -&gt; 1 -&gt; 2}(9,t) = \int_{9}^{t} (P_00(9,u-)alpha01(u) \int_{u}^{t} (P_11(u,x-)alpha12(x)P_22(x,t)))</span></span>
<span id="cb82-509"><a href="#cb82-509" aria-hidden="true" tabindex="-1"></a>p02_non_direct_lingvhd_s9 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-510"><a href="#cb82-510" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha01_s9[, <span class="dv">1</span>][p00alpha01_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-511"><a href="#cb82-511" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-512"><a href="#cb82-512" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-513"><a href="#cb82-513" aria-hidden="true" tabindex="-1"></a>    p00alpha1 <span class="ot">&lt;-</span> p00alpha01_s9[, <span class="dv">4</span>][p00alpha01_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-514"><a href="#cb82-514" aria-hidden="true" tabindex="-1"></a>    p12 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(time))</span>
<span id="cb82-515"><a href="#cb82-515" aria-hidden="true" tabindex="-1"></a>    possible_time12 <span class="ot">&lt;-</span> time12[time12 <span class="sc">&lt;</span> t]</span>
<span id="cb82-516"><a href="#cb82-516" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(time)){</span>
<span id="cb82-517"><a href="#cb82-517" aria-hidden="true" tabindex="-1"></a>      new_time12 <span class="ot">&lt;-</span> possible_time12[possible_time12 <span class="sc">&gt;</span> time[i]]</span>
<span id="cb82-518"><a href="#cb82-518" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(new_time12) <span class="sc">==</span> <span class="dv">0</span>){p12[i] <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-519"><a href="#cb82-519" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{</span>
<span id="cb82-520"><a href="#cb82-520" aria-hidden="true" tabindex="-1"></a>        p11alpha2 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(new_time12, p11alpha12_lingvhd, <span class="at">start =</span> time[i])</span>
<span id="cb82-521"><a href="#cb82-521" aria-hidden="true" tabindex="-1"></a>        p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(new_time12, p22_markov, <span class="at">end =</span> t)</span>
<span id="cb82-522"><a href="#cb82-522" aria-hidden="true" tabindex="-1"></a>        p12[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(p11alpha2<span class="sc">*</span>p22)}}</span>
<span id="cb82-523"><a href="#cb82-523" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha1<span class="sc">*</span>p12)}</span>
<span id="cb82-524"><a href="#cb82-524" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-525"><a href="#cb82-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-526"><a href="#cb82-526" aria-hidden="true" tabindex="-1"></a><span class="co">#P_02(s,t) = P_{0-&gt;2}(s,t) + P_{0 -&gt; 1 -&gt; 2}(s,t)</span></span>
<span id="cb82-527"><a href="#cb82-527" aria-hidden="true" tabindex="-1"></a>p02_lingvhd_s9 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-528"><a href="#cb82-528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">p02_direct_lingvhd_s9</span>(t) <span class="sc">+</span> <span class="fu">p02_non_direct_lingvhd_s9</span>(t))}</span>
<span id="cb82-529"><a href="#cb82-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-530"><a href="#cb82-530" aria-hidden="true" tabindex="-1"></a><span class="co"># PLUG-IN WITH LINEAR EFFECT OF DURATION OF RELAPSE ###########################</span></span>
<span id="cb82-531"><a href="#cb82-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-532"><a href="#cb82-532" aria-hidden="true" tabindex="-1"></a>rel_subset <span class="ot">&lt;-</span> bmt_dt[rel <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb82-533"><a href="#cb82-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-534"><a href="#cb82-534" aria-hidden="true" tabindex="-1"></a>cox_23_linrel <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(intxrel, intxsurv, dead) <span class="sc">~</span> <span class="fu">tt</span>(intxrel), <span class="at">tt =</span> <span class="cf">function</span>(x,t,...) t <span class="sc">-</span> x, <span class="at">data =</span> rel_subset, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb82-535"><a href="#cb82-535" aria-hidden="true" tabindex="-1"></a>beta23 <span class="ot">&lt;-</span> cox_23_linrel<span class="sc">$</span>coefficients</span>
<span id="cb82-536"><a href="#cb82-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-537"><a href="#cb82-537" aria-hidden="true" tabindex="-1"></a>timej2 <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">sort</span>(bmt_dt[rel <span class="sc">==</span><span class="dv">1</span>]<span class="sc">$</span>intxrel)) <span class="co">#Time of j -&gt; 2 transitions, j = {0,1}</span></span>
<span id="cb82-538"><a href="#cb82-538" aria-hidden="true" tabindex="-1"></a>time23 <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">sort</span>(bmt_dt[rel <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> dead <span class="sc">==</span><span class="dv">1</span>]<span class="sc">$</span>intxsurv)) <span class="co">#Time of 2 -&gt; 3 transitions</span></span>
<span id="cb82-539"><a href="#cb82-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-540"><a href="#cb82-540" aria-hidden="true" tabindex="-1"></a><span class="co">#Baseline hazard for alpha23</span></span>
<span id="cb82-541"><a href="#cb82-541" aria-hidden="true" tabindex="-1"></a>basehaz23 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-542"><a href="#cb82-542" aria-hidden="true" tabindex="-1"></a>  dN23 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(bmt_dt[rel <span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> dead <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> intxsurv <span class="sc">==</span> t])</span>
<span id="cb82-543"><a href="#cb82-543" aria-hidden="true" tabindex="-1"></a>  at_risk <span class="ot">&lt;-</span> bmt_dt[rel <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> intxrel <span class="sc">&lt;</span> t <span class="sc">&amp;</span> intxsurv <span class="sc">&gt;</span> (t <span class="sc">-</span> <span class="fl">0.000001</span>)] </span>
<span id="cb82-544"><a href="#cb82-544" aria-hidden="true" tabindex="-1"></a>  weigthed_at_risk <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">exp</span>(beta23<span class="sc">*</span>(t <span class="sc">-</span> at_risk<span class="sc">$</span>intxrel)))</span>
<span id="cb82-545"><a href="#cb82-545" aria-hidden="true" tabindex="-1"></a>  haz23 <span class="ot">&lt;-</span> dN23<span class="sc">/</span>weigthed_at_risk</span>
<span id="cb82-546"><a href="#cb82-546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(haz23)}</span>
<span id="cb82-547"><a href="#cb82-547" aria-hidden="true" tabindex="-1"></a>basehaz23_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">cbind</span>(time23, <span class="fu">sapply</span>(time23,basehaz23)))</span>
<span id="cb82-548"><a href="#cb82-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-549"><a href="#cb82-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-550"><a href="#cb82-550" aria-hidden="true" tabindex="-1"></a>haz23_linrel <span class="ot">&lt;-</span> <span class="cf">function</span>(s,x){ <span class="co">#alpha23(x | T_j2 = s) = basehaz23(x)*exp(beta23(x-s))</span></span>
<span id="cb82-551"><a href="#cb82-551" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x <span class="sc">%in%</span> time23){</span>
<span id="cb82-552"><a href="#cb82-552" aria-hidden="true" tabindex="-1"></a>    haz <span class="ot">&lt;-</span> basehaz23_table[basehaz23_table<span class="sc">$</span>time23 <span class="sc">==</span> x]<span class="sc">$</span>V2<span class="sc">*</span><span class="fu">exp</span>(beta23<span class="sc">*</span>(x <span class="sc">-</span> s))}</span>
<span id="cb82-553"><a href="#cb82-553" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {haz <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-554"><a href="#cb82-554" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(haz)}</span>
<span id="cb82-555"><a href="#cb82-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-556"><a href="#cb82-556" aria-hidden="true" tabindex="-1"></a>p22_linrel_slow <span class="ot">&lt;-</span> <span class="cf">function</span>(start,end){</span>
<span id="cb82-557"><a href="#cb82-557" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (start <span class="sc">&gt;</span> end){p22 <span class="ot">&lt;-</span> <span class="cn">NA</span>}</span>
<span id="cb82-558"><a href="#cb82-558" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-559"><a href="#cb82-559" aria-hidden="true" tabindex="-1"></a>    times <span class="ot">&lt;-</span> time23[time23 <span class="sc">&gt;</span> start <span class="sc">&amp;</span> time23 <span class="sc">&lt;=</span> end]</span>
<span id="cb82-560"><a href="#cb82-560" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(times) <span class="sc">==</span> <span class="dv">0</span>){p22 <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb82-561"><a href="#cb82-561" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb82-562"><a href="#cb82-562" aria-hidden="true" tabindex="-1"></a>      terms <span class="ot">&lt;-</span> <span class="fu">sapply</span>(times, haz23_linrel, <span class="at">s =</span> start)</span>
<span id="cb82-563"><a href="#cb82-563" aria-hidden="true" tabindex="-1"></a>      int <span class="ot">&lt;-</span> <span class="fu">sum</span>(terms)</span>
<span id="cb82-564"><a href="#cb82-564" aria-hidden="true" tabindex="-1"></a>      p22 <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>int)}}</span>
<span id="cb82-565"><a href="#cb82-565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p22)}</span>
<span id="cb82-566"><a href="#cb82-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-567"><a href="#cb82-567" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb82-568"><a href="#cb82-568" aria-hidden="true" tabindex="-1"></a><span class="co"># For reproducing data.table p22_linrel_table. Takes approximately 10 minutes</span></span>
<span id="cb82-569"><a href="#cb82-569" aria-hidden="true" tabindex="-1"></a><span class="co">#Table of p22 with linear effect of relapse as covariate.</span></span>
<span id="cb82-570"><a href="#cb82-570" aria-hidden="true" tabindex="-1"></a><span class="co">#p22_linrel_table_raw &lt;- matrix(NA, nrow = length(timej2), ncol = length(time23))</span></span>
<span id="cb82-571"><a href="#cb82-571" aria-hidden="true" tabindex="-1"></a><span class="co">#rownames(p22_linrel_table_raw) &lt;- timej2</span></span>
<span id="cb82-572"><a href="#cb82-572" aria-hidden="true" tabindex="-1"></a><span class="co">#colnames(p22_linrel_table_raw) &lt;- time23</span></span>
<span id="cb82-573"><a href="#cb82-573" aria-hidden="true" tabindex="-1"></a><span class="co">#for (i in 1:length(timej2)){</span></span>
<span id="cb82-574"><a href="#cb82-574" aria-hidden="true" tabindex="-1"></a><span class="co">#  for (j in 1:length(time23)){</span></span>
<span id="cb82-575"><a href="#cb82-575" aria-hidden="true" tabindex="-1"></a><span class="co">#    if (timej2[i] &gt; time23[j]){p22_linrel_table_raw[i,j] &lt;- NA}</span></span>
<span id="cb82-576"><a href="#cb82-576" aria-hidden="true" tabindex="-1"></a><span class="co">#    else {p22_linrel_table_raw[i,j] &lt;- p22_linrel_slow(timej2[i],time23[j])</span><span class="re">}}}</span></span>
<span id="cb82-577"><a href="#cb82-577" aria-hidden="true" tabindex="-1"></a><span class="co">#p22_linrel_table &lt;- as.data.table(p22_linrel_table_raw, keep.rownames = TRUE)</span></span>
<span id="cb82-578"><a href="#cb82-578" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb82-579"><a href="#cb82-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-580"><a href="#cb82-580" aria-hidden="true" tabindex="-1"></a>p22_linrel_table <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/p22_linrel_table.csv"</span>)</span>
<span id="cb82-581"><a href="#cb82-581" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(p22_linrel_table) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"rn"</span>, time23)</span>
<span id="cb82-582"><a href="#cb82-582" aria-hidden="true" tabindex="-1"></a>p22_linrel_table <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(p22_linrel_table)</span>
<span id="cb82-583"><a href="#cb82-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-584"><a href="#cb82-584" aria-hidden="true" tabindex="-1"></a><span class="co">#P_22(s,t)with linear effect of relapse as covariate.</span></span>
<span id="cb82-585"><a href="#cb82-585" aria-hidden="true" tabindex="-1"></a>p22_linrel <span class="ot">&lt;-</span> <span class="cf">function</span>(start,end){</span>
<span id="cb82-586"><a href="#cb82-586" aria-hidden="true" tabindex="-1"></a>  end_point <span class="ot">&lt;-</span> <span class="fu">length</span>(time23[time23 <span class="sc">&lt;=</span>end]) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb82-587"><a href="#cb82-587" aria-hidden="true" tabindex="-1"></a>  start_point <span class="ot">&lt;-</span> <span class="fu">length</span>(timej2[timej2 <span class="sc">&lt;=</span> start])</span>
<span id="cb82-588"><a href="#cb82-588" aria-hidden="true" tabindex="-1"></a>  p22 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(p22_linrel_table[start_point, end_point, <span class="at">with =</span> <span class="cn">FALSE</span>])</span>
<span id="cb82-589"><a href="#cb82-589" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p22)) {p22 <span class="ot">&lt;-</span> <span class="dv">1</span>}</span>
<span id="cb82-590"><a href="#cb82-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p22)}</span>
<span id="cb82-591"><a href="#cb82-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-592"><a href="#cb82-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-593"><a href="#cb82-593" aria-hidden="true" tabindex="-1"></a><span class="co"># S = 3 ####################################################################### </span></span>
<span id="cb82-594"><a href="#cb82-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-595"><a href="#cb82-595" aria-hidden="true" tabindex="-1"></a><span class="co">#P_{0-&gt;2}(3,t) = \int_{3}^{t} P_00(3,u-)alpha02(u)P_22(u,t)</span></span>
<span id="cb82-596"><a href="#cb82-596" aria-hidden="true" tabindex="-1"></a>p02_direct_linrel_s3 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-597"><a href="#cb82-597" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha02_s3[, <span class="dv">1</span>][p00alpha02_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-598"><a href="#cb82-598" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-599"><a href="#cb82-599" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-600"><a href="#cb82-600" aria-hidden="true" tabindex="-1"></a>    p00alpha2 <span class="ot">&lt;-</span> p00alpha02_s3[, <span class="dv">4</span>][p00alpha02_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-601"><a href="#cb82-601" aria-hidden="true" tabindex="-1"></a>    p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time, p22_linrel, <span class="at">end =</span> t)</span>
<span id="cb82-602"><a href="#cb82-602" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha2<span class="sc">*</span>p22)}</span>
<span id="cb82-603"><a href="#cb82-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-604"><a href="#cb82-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-605"><a href="#cb82-605" aria-hidden="true" tabindex="-1"></a><span class="co">#P_{0-&gt;1-&gt;2}(3,t) = \int_{3}^{t} (P_00(3,u-)alpha01(u) \int_{u}^{t} (P_11(u,x-)alpha12(x)P_22(x,t)))</span></span>
<span id="cb82-606"><a href="#cb82-606" aria-hidden="true" tabindex="-1"></a>p02_non_direct_linrel_s3 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-607"><a href="#cb82-607" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha01_s3[, <span class="dv">1</span>][p00alpha01_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-608"><a href="#cb82-608" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-609"><a href="#cb82-609" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-610"><a href="#cb82-610" aria-hidden="true" tabindex="-1"></a>    p00alpha1 <span class="ot">&lt;-</span> p00alpha01_s3[, <span class="dv">4</span>][p00alpha01_s3[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-611"><a href="#cb82-611" aria-hidden="true" tabindex="-1"></a>    p12 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(time))</span>
<span id="cb82-612"><a href="#cb82-612" aria-hidden="true" tabindex="-1"></a>    possible_time12 <span class="ot">&lt;-</span> time12[time12 <span class="sc">&lt;</span> t]</span>
<span id="cb82-613"><a href="#cb82-613" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(time)){</span>
<span id="cb82-614"><a href="#cb82-614" aria-hidden="true" tabindex="-1"></a>      time12_sub <span class="ot">&lt;-</span> possible_time12[possible_time12 <span class="sc">&gt;</span> time[i]]</span>
<span id="cb82-615"><a href="#cb82-615" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(time12_sub) <span class="sc">==</span> <span class="dv">0</span>){p12[i] <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-616"><a href="#cb82-616" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{</span>
<span id="cb82-617"><a href="#cb82-617" aria-hidden="true" tabindex="-1"></a>        p11alpha2 <span class="ot">&lt;-</span> <span class="fu">vapply</span>(time12_sub, p11alpha12, <span class="at">start =</span> time[i], <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb82-618"><a href="#cb82-618" aria-hidden="true" tabindex="-1"></a>        p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time12_sub, p22_linrel, <span class="at">end =</span> t)</span>
<span id="cb82-619"><a href="#cb82-619" aria-hidden="true" tabindex="-1"></a>        p12[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(p11alpha2<span class="sc">*</span>p22)}}</span>
<span id="cb82-620"><a href="#cb82-620" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha1<span class="sc">*</span>p12)}</span>
<span id="cb82-621"><a href="#cb82-621" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-622"><a href="#cb82-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-623"><a href="#cb82-623" aria-hidden="true" tabindex="-1"></a><span class="co">#P_02(s,t) = P_{0-&gt;2}(s,t) + P_{0 -&gt; 1 -&gt; 2}(s,t)</span></span>
<span id="cb82-624"><a href="#cb82-624" aria-hidden="true" tabindex="-1"></a>p02_linrel_s3 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-625"><a href="#cb82-625" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">p02_direct_linrel_s3</span>(t) <span class="sc">+</span> <span class="fu">p02_non_direct_linrel_s3</span>(t))}</span>
<span id="cb82-626"><a href="#cb82-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-627"><a href="#cb82-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-628"><a href="#cb82-628" aria-hidden="true" tabindex="-1"></a><span class="co"># s = 9 ######################################################################</span></span>
<span id="cb82-629"><a href="#cb82-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-630"><a href="#cb82-630" aria-hidden="true" tabindex="-1"></a><span class="co">#P_{0-&gt;2}(9,t) = \int_{9}^{t} P_00(9,u-)alpha02(u)P_22(u,t)</span></span>
<span id="cb82-631"><a href="#cb82-631" aria-hidden="true" tabindex="-1"></a>p02_direct_linrel_s9 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-632"><a href="#cb82-632" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha02_s9[, <span class="dv">1</span>][p00alpha02_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-633"><a href="#cb82-633" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-634"><a href="#cb82-634" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-635"><a href="#cb82-635" aria-hidden="true" tabindex="-1"></a>    p00alpha2 <span class="ot">&lt;-</span> p00alpha02_s9[, <span class="dv">4</span>][p00alpha02_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-636"><a href="#cb82-636" aria-hidden="true" tabindex="-1"></a>    p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time, p22_linrel, <span class="at">end =</span> t)</span>
<span id="cb82-637"><a href="#cb82-637" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha2<span class="sc">*</span>p22)}</span>
<span id="cb82-638"><a href="#cb82-638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-639"><a href="#cb82-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-640"><a href="#cb82-640" aria-hidden="true" tabindex="-1"></a><span class="co">#P_{0 -&gt; 1 -&gt; 2}(9,t) = \int_{9}^{t} (P_00(9,u-)alpha01(u) \int_{u}^{t} (P_11(u,x-)alpha12(x)P_22(x,t)))</span></span>
<span id="cb82-641"><a href="#cb82-641" aria-hidden="true" tabindex="-1"></a>p02_non_direct_linrel_s9 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-642"><a href="#cb82-642" aria-hidden="true" tabindex="-1"></a>  time <span class="ot">&lt;-</span> p00alpha01_s9[, <span class="dv">1</span>][p00alpha01_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-643"><a href="#cb82-643" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(time) <span class="sc">==</span> <span class="dv">0</span>){prob02 <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-644"><a href="#cb82-644" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>{</span>
<span id="cb82-645"><a href="#cb82-645" aria-hidden="true" tabindex="-1"></a>    p00alpha1 <span class="ot">&lt;-</span> p00alpha01_s9[, <span class="dv">4</span>][p00alpha01_s9[, <span class="dv">1</span>] <span class="sc">&lt;=</span> t]</span>
<span id="cb82-646"><a href="#cb82-646" aria-hidden="true" tabindex="-1"></a>    p12 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(time))</span>
<span id="cb82-647"><a href="#cb82-647" aria-hidden="true" tabindex="-1"></a>    possible_time12 <span class="ot">&lt;-</span> time12[time12 <span class="sc">&lt;</span> t]</span>
<span id="cb82-648"><a href="#cb82-648" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(time)){</span>
<span id="cb82-649"><a href="#cb82-649" aria-hidden="true" tabindex="-1"></a>      time12 <span class="ot">&lt;-</span> possible_time12[possible_time12 <span class="sc">&gt;</span> time[i]]</span>
<span id="cb82-650"><a href="#cb82-650" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(time12) <span class="sc">==</span> <span class="dv">0</span>){p12[i] <span class="ot">&lt;-</span> <span class="dv">0</span>}</span>
<span id="cb82-651"><a href="#cb82-651" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{</span>
<span id="cb82-652"><a href="#cb82-652" aria-hidden="true" tabindex="-1"></a>        p11alpha2 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time12, p11alpha12, <span class="at">start =</span> time[i])</span>
<span id="cb82-653"><a href="#cb82-653" aria-hidden="true" tabindex="-1"></a>        p22 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time12, p22_linrel, <span class="at">end =</span> t)</span>
<span id="cb82-654"><a href="#cb82-654" aria-hidden="true" tabindex="-1"></a>        p12[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(p11alpha2<span class="sc">*</span>p22)}}</span>
<span id="cb82-655"><a href="#cb82-655" aria-hidden="true" tabindex="-1"></a>    prob02 <span class="ot">&lt;-</span> <span class="fu">sum</span>(p00alpha1<span class="sc">*</span>p12)}</span>
<span id="cb82-656"><a href="#cb82-656" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(prob02)}</span>
<span id="cb82-657"><a href="#cb82-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-658"><a href="#cb82-658" aria-hidden="true" tabindex="-1"></a><span class="co">#P_02(s,t) = P_{0-&gt;2}(s,t) + P_{0 -&gt; 1 -&gt; 2}(s,t)</span></span>
<span id="cb82-659"><a href="#cb82-659" aria-hidden="true" tabindex="-1"></a>p02_linrel_s9 <span class="ot">&lt;-</span> <span class="cf">function</span>(t){</span>
<span id="cb82-660"><a href="#cb82-660" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">p02_direct_linrel_s9</span>(t) <span class="sc">+</span> <span class="fu">p02_non_direct_linrel_s9</span>(t))}</span>
<span id="cb82-661"><a href="#cb82-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-662"><a href="#cb82-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-663"><a href="#cb82-663" aria-hidden="true" tabindex="-1"></a><span class="co"># Table 5.5 #################################################################</span></span>
<span id="cb82-664"><a href="#cb82-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-665"><a href="#cb82-665" aria-hidden="true" tabindex="-1"></a>cox12 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(tgvhd, intxrel, rel) <span class="sc">~</span> <span class="fu">tt</span>(tgvhd), <span class="at">data =</span> <span class="fu">subset</span>(bmt, gvhd <span class="sc">==</span><span class="dv">1</span>), <span class="at">tt =</span> <span class="cf">function</span>(x, t, ...) t <span class="sc">-</span> x, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb82-666"><a href="#cb82-666" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox12)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(tgvhd, intxrel, rel) ~ tt(tgvhd), data = subset(bmt, 
    gvhd == 1), tt = function(x, t, ...) t - x, method = "breslow")

  n= 974, number of events= 91 
   (2 observations deleted due to missingness)

             coef exp(coef) se(coef)     z Pr(&gt;|z|)
tt(tgvhd) 0.07421   1.07703  0.04618 1.607    0.108

          exp(coef) exp(-coef) lower .95 upper .95
tt(tgvhd)     1.077     0.9285    0.9838     1.179

Concordance= 0.549  (se = 0.027 )
Likelihood ratio test= 2.86  on 1 df,   p=0.09
Wald test            = 2.58  on 1 df,   p=0.1
Score (logrank) test = 2.39  on 1 df,   p=0.1</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>cox13 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(tgvhd, intxsurv, dead) <span class="sc">~</span> <span class="fu">tt</span>(tgvhd), <span class="at">data =</span> <span class="fu">subset</span>(bmt, gvhd <span class="sc">==</span><span class="dv">1</span>), <span class="at">tt =</span> <span class="cf">function</span>(x, t, ...) t <span class="sc">-</span> x, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox13)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(tgvhd, intxsurv, dead) ~ tt(tgvhd), data = subset(bmt, 
    gvhd == 1), tt = function(x, t, ...) t - x, method = "breslow")

  n= 974, number of events= 389 
   (2 observations deleted due to missingness)

             coef exp(coef) se(coef)     z Pr(&gt;|z|)  
tt(tgvhd) 0.04964   1.05090  0.02134 2.326     0.02 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

          exp(coef) exp(-coef) lower .95 upper .95
tt(tgvhd)     1.051     0.9516     1.008     1.096

Concordance= 0.535  (se = 0.014 )
Likelihood ratio test= 6.02  on 1 df,   p=0.01
Wald test            = 5.41  on 1 df,   p=0.02
Score (logrank) test = 4.83  on 1 df,   p=0.03</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>cox23 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(intxrel, intxsurv, dead) <span class="sc">~</span> <span class="fu">tt</span>(intxrel), <span class="at">data =</span> <span class="fu">subset</span>(bmt, rel <span class="sc">==</span> <span class="dv">1</span>), <span class="at">tt =</span> <span class="cf">function</span>(x, t, ...) t <span class="sc">-</span> x, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox23)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(intxrel, intxsurv, dead) ~ tt(intxrel), 
    data = subset(bmt, rel == 1), tt = function(x, t, ...) t - 
        x, method = "breslow")

  n= 254, number of events= 228 
   (5 observations deleted due to missingness)

                coef exp(coef) se(coef)      z Pr(&gt;|z|)    
tt(intxrel) -0.06569   0.93642  0.01557 -4.219 2.46e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

            exp(coef) exp(-coef) lower .95 upper .95
tt(intxrel)    0.9364      1.068    0.9083    0.9654

Concordance= 0.538  (se = 0.021 )
Likelihood ratio test= 21.59  on 1 df,   p=3e-06
Wald test            = 17.8  on 1 df,   p=2e-05
Score (logrank) test = 20.59  on 1 df,   p=6e-06</code></pre>
</div>
</div>
</div>
<div id="tabset-23-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-23-2-tab">

</div>
</div>
</div>
</section>
<section id="figure-5.10" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.10">Figure 5.10</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-24-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-24-1" role="tab" aria-controls="tabset-24-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-24-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-24-2" role="tab" aria-controls="tabset-24-2" aria-selected="false">SAS-NA</a></li></ul>
<div class="tab-content">
<div id="tabset-24-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-24-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.10-r_71381ca7d3622eb31c259d6527e44a62">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co">#For reproducing the data.frame semi_s3_data - takes approximately 1.5 hour</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Data.frame for plotting semi-Markov</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co">#time_semi_s3 &lt;- seq(3.01, 60, by = 0.03)</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="co">#semi_p02_s3 &lt;- sapply(time_semi_s3, p02_semi_s3)</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="co">#semi_s3_data &lt;- as.data.frame(cbind(time_semi_s3, semi_p02_s3))</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="co">#colnames(semi_s3_data) &lt;- c("time", "pstate3")</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>semi_s3_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/semi_s3_data.csv"</span>)</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="co">#LM Pepe data for plot with s = 3</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>time_pepe_s3 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">3.01</span>,<span class="dv">60</span>,<span class="fl">0.01</span>)</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>est_pepe_s3 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time_pepe_s3, LMPepe_s3)</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>data_pepe_s3 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(time_pepe_s3, est_pepe_s3))</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a><span class="co"># For reproducing the data.frame lingvhd_s3_data. Takes approximately 1 hour</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plug-in (linear effect of duration of gvhd) data for plot with s = 3</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a><span class="co">#time_lingvhd_s3 &lt;- seq(3.01,60,by = 0.03)</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="co">#lingvhd_p02_s3 &lt;- sapply(time_lingvhd_s3, p02_lingvhd_s3)</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a><span class="co">#lingvhd_s3_data &lt;- as.data.frame(cbind(time_lingvhd_s3,lingvhd_p02_s3))</span></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a><span class="co">#colnames(lingvhd_s3_data) &lt;- c("time", "pstate3")</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>lingvhd_s3_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/data_lingvhd_s3.csv"</span>)</span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a><span class="co">#For reproducing the data.frame linrel_s3_data. Takes approximately 1.5 hour</span></span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a><span class="co">#time_linrel_s3 &lt;- AJ3_max60$time</span></span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a><span class="co">#time_linrel_s3 &lt;- seq(3.01, 60, by = 0.03)</span></span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a><span class="co">#linrel_p02_s3 &lt;- sapply(time_linrel_s3, p02_linrel_s3)</span></span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a><span class="co">#linrel_s3_data &lt;- as.data.frame(cbind(time_linrel_s3, linrel_p02_s3))</span></span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a><span class="co">#colnames(linrel_s3_data) &lt;- c("time", "pstate3")</span></span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>linrel_s3_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/linrel_s3_data.csv"</span>)</span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(AJ3_max60,<span class="fu">aes</span>(time,pstate3)) <span class="sc">+</span> </span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data=</span>semi_s3_data,<span class="fu">aes</span>(<span class="at">linetype=</span><span class="st">"Semi"</span>)) <span class="sc">+</span></span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data=</span>lingvhd_s3_data,<span class="fu">aes</span>(<span class="at">linetype=</span><span class="st">"LinGvHD"</span>)) <span class="sc">+</span></span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data=</span>linrel_s3_data,<span class="fu">aes</span>(<span class="at">linetype=</span><span class="st">"LinRel"</span>)) <span class="sc">+</span></span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">linetype=</span><span class="st">"AaJ"</span>))<span class="sc">+</span></span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data=</span>LMAJ3_max60,<span class="fu">aes</span>(<span class="at">linetype=</span><span class="st">"LM AaJ"</span>)) <span class="sc">+</span></span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data =</span> data_pepe_s3, <span class="fu">aes</span>(<span class="at">x =</span> time_pepe_s3, <span class="at">y =</span> est_pepe_s3, <span class="at">linetype =</span> <span class="st">"LM Pepe"</span>)) <span class="sc">+</span></span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since bone marrow transplantation (months)"</span>) <span class="sc">+</span></span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability"</span>) <span class="sc">+</span></span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">60</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">60</span>, <span class="at">by =</span> <span class="dv">12</span>)) <span class="sc">+</span> </span>
<span id="cb88-46"><a href="#cb88-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"twodash"</span>, <span class="st">"dotted"</span>, <span class="st">"longdash"</span>, <span class="st">"dotdash"</span>, <span class="st">"dashed"</span>)) <span class="sc">+</span></span>
<span id="cb88-47"><a href="#cb88-47" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb88-48"><a href="#cb88-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>,<span class="st">"cm"</span>),</span>
<span id="cb88-49"><a href="#cb88-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title=</span><span class="fu">element_blank</span>(),</span>
<span id="cb88-50"><a href="#cb88-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">22</span>))</span>
<span id="cb88-51"><a href="#cb88-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-52"><a href="#cb88-52" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.10-r-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-24-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-24-2-tab">

</div>
</div>
</div>
</section>
<section id="figure-5.11" class="level3">
<h3 class="anchored" data-anchor-id="figure-5.11">Figure 5.11</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-25-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-25-1" role="tab" aria-controls="tabset-25-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-25-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-25-2" role="tab" aria-controls="tabset-25-2" aria-selected="false">SAS-NA</a></li></ul>
<div class="tab-content">
<div id="tabset-25-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-25-1-tab">
<div class="cell" data-hash="Ch5_cache/html/figure-5.11-r_7aad2a43ea8bd24ad19ec41a8fd3047f">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">#For reproducing the data.frame semi_s9_data - takes approximately 15 minutes</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Data.frame for plotting semi-Markov</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co">#time_semi_s9 &lt;- seq(9.01, 60, by = 0.03)</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="co">#semi_p02_s9 &lt;- sapply(time_semi_s9, p02_semi_s9)</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="co">#semi_s9_data &lt;- as.data.frame(cbind(time_semi_s9, semi_p02_s9))</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="co">#colnames(semi_s9_data) &lt;- c("time", "pstate3")</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>semi_s9_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/semi_s9_data.csv"</span>)</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="co">#LM Pepe data for plot with s = 9</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>time_pepe_s9 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fl">9.01</span>,<span class="dv">60</span>,<span class="fl">0.01</span>)</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>est_pepe_s9 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(time_pepe_s9, LMPepe_s9)</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>data_pepe_s9 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(time_pepe_s9,est_pepe_s9))</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a><span class="co"># For reproducing lingvhd_s9_data. Takes approximately 10 minutes.</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Plug-in (linear effect of duration of gvhd) data for plot with s = 9</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a><span class="co">#time_lingvhd_s9 &lt;- seq(9.01,60,by = 0.03)</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a><span class="co">#lingvhd_p02_s9 &lt;- sapply(time_lingvhd_s9, p02_lingvhd_s9)</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a><span class="co">#lingvhd_s9_data &lt;- as.data.frame(cbind(time_lingvhd_s9,lingvhd_p02_s9))</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="co">#colnames(lingvhd_s9_data) &lt;- c("time", "pstate3")</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>lingvhd_s9_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/lingvhd_s9_data.csv"</span>)</span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a><span class="co">#For reproducing the data.frame linrel_s9_data. Takes approximately 30 minutes</span></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a><span class="co">#time_linrel_s9 &lt;- seq(9.01, 60, by = 0.03)</span></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a><span class="co">#linrel_p02_s9 &lt;- sapply(time_linrel_s9, p02_linrel_s9)</span></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a><span class="co">#linrel_s9_data &lt;- as.data.frame(cbind(time_linrel_s9, linrel_p02_s9))</span></span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a><span class="co">#colnames(linrel_s9_data) &lt;- c("time", "pstate3")</span></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a>linrel_s9_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"temp/linrel_s9_data.csv"</span>)</span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(AJ9_max60,<span class="fu">aes</span>(time,pstate3)) <span class="sc">+</span> </span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data=</span>semi_s9_data,<span class="fu">aes</span>(<span class="at">linetype=</span><span class="st">"Semi"</span>)) <span class="sc">+</span></span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data=</span>lingvhd_s9_data,<span class="fu">aes</span>(<span class="at">linetype=</span><span class="st">"LinGvHD"</span>)) <span class="sc">+</span></span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data=</span>linrel_s9_data,<span class="fu">aes</span>(<span class="at">linetype=</span><span class="st">"LinRel"</span>)) <span class="sc">+</span></span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data =</span> data_pepe_s9, <span class="fu">aes</span>(<span class="at">x =</span> time_pepe_s9, <span class="at">y =</span> est_pepe_s9, <span class="at">linetype=</span> <span class="st">"LM Pepe"</span>)) <span class="sc">+</span></span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">linetype=</span><span class="st">"AaJ"</span>))<span class="sc">+</span></span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">data=</span>LMAJ9_max60,<span class="fu">aes</span>(<span class="at">linetype=</span><span class="st">"LM AaJ"</span>)) <span class="sc">+</span></span>
<span id="cb89-39"><a href="#cb89-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since bone marrow transplantation (months)"</span>) <span class="sc">+</span></span>
<span id="cb89-40"><a href="#cb89-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability"</span>) <span class="sc">+</span></span>
<span id="cb89-41"><a href="#cb89-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="fl">0.035</span>)  <span class="sc">+</span></span>
<span id="cb89-42"><a href="#cb89-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb89-43"><a href="#cb89-43" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">60</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">60</span>, <span class="at">by =</span> <span class="dv">12</span>)) <span class="sc">+</span> </span>
<span id="cb89-44"><a href="#cb89-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"twodash"</span>, <span class="st">"dotted"</span>, <span class="st">"longdash"</span>, <span class="st">"dotdash"</span>, <span class="st">"dashed"</span>)) <span class="sc">+</span></span>
<span id="cb89-45"><a href="#cb89-45" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb89-46"><a href="#cb89-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>,<span class="st">"cm"</span>),</span>
<span id="cb89-47"><a href="#cb89-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title=</span><span class="fu">element_blank</span>(),</span>
<span id="cb89-48"><a href="#cb89-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">22</span>))</span>
<span id="cb89-49"><a href="#cb89-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-50"><a href="#cb89-50" aria-hidden="true" tabindex="-1"></a>fig5<span class="fl">.11</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/figure-5.11-r-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-25-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-25-2-tab">

</div>
</div>
</div>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<p>The SAS solutions are available as single files for download:</p>
<ul>
<li><p><a href="./SAS/chapter5_solutions_cphholter.sas">Exercises 5.6 - 5.9 (The Copenhagen Holter study)</a></p></li>
<li><p><a href="./SAS/chapter5_solutions_affective.sas">Exercise 5.10 (Recurrent episodes in affective disorders)</a></p></li>
</ul>
<section id="exercise-5.1" class="level3">
<h3 class="anchored" data-anchor-id="exercise-5.1">Exercise 5.1 (*)</h3>
<p><em>Consider the two-state reversible Markov model, set up the <span class="math inline">\(\mathbf{A}(t)\)</span> and <span class="math inline">\(\mathbf{P}(s,t)\)</span> matrices, and express, using the Kolmogorov forward differential equations, the transition probabilities in terms of the transition intensities.</em></p>
<p>The intensity matrix is: <span class="math display">\[{\bf A}(t)=\left( \begin{array}{cc}
-A_{01}(t)&amp;A_{01}(t)\\
A_{10}(t)&amp;-A_{10}(t)\\
\end{array} \right).
\]</span> and the transition probability matrix: <span class="math display">\[{\bf P}(s,t)=\left( \begin{array}{cc}
P_{00}(s,t)&amp;1-P_{00}(s,t)\\
1-P_{11}(s,t)&amp;P_{11}(s,t)\\
\end{array} \right)
\]</span> or, equivalently <span class="math display">\[{\bf P}(s,t)=\left( \begin{array}{cc}
1-P_{01}(s,t)&amp;P_{01}(s,t)\\
P_{10}(s,t)&amp;1-P_{10}(s,t)\\
\end{array} \right).
\]</span> This leads to the Kolmogorov forward differential equations <span class="math display">\[\frac{\partial}{\partial t}P_{01}(s,t)+(\alpha_{01}(t)+\alpha_{10}(t))P_{01}(s,t)=\alpha_{01}(t)\]</span> and <span class="math display">\[\frac{\partial}{\partial t}P_{10}(s,t)+(\alpha_{01}(t)+\alpha_{10}(t))P_{10}(s,t)=\alpha_{10}(t).\]</span> These are linear first order differential equations, i.e., of the form <span class="math display">\[f^{\prime}(t)+g(t)f(t)=h(t)\]</span> which are known to have the solution <span class="math display">\[f(t)=v(t)\exp(-G(t))+c\exp(-G(t))\]</span> with <span class="math inline">\(G^{\prime}(t)=g(t)\)</span> and <span class="math inline">\(v^{\prime}(t)=\exp(G(t))h(t)\)</span>, and the constants <span class="math inline">\(c\)</span> are determined such that <span class="math inline">\(P_{01}(s,s)=0\)</span> and <span class="math inline">\(P_{10}(s,s)=0\)</span>. For <span class="math inline">\(s=0\)</span>, the solution is <span class="math display">\[P_{01}(0,t)=\int_0^t\exp(-\int_u^t(\alpha_{01}(x)+\alpha_{10}(x))dx)\alpha_{01}(u)du\]</span> (the constant <span class="math inline">\(c=0\)</span>) and, for a general <span class="math inline">\(s\)</span>: <span class="math display">\[P_{01}(s,t)=\int_s^t\exp(-\int_u^t(\alpha_{01}(x)+\alpha_{10}(x))dx)\alpha_{01}(u)du.\]</span> The expression for <span class="math inline">\(P_{10}(s,t)\)</span> is similar.</p>
</section>
<section id="exercise-5.2" class="level3">
<h3 class="anchored" data-anchor-id="exercise-5.2">Exercise 5.2 (*)</h3>
<p><em>Consider the four-state model for the bone marrow transplantation study, set up the <span class="math inline">\(\mathbf{A}(t)\)</span> and <span class="math inline">\(\mathbf{P}(s,t)\)</span> matrices, and express, using the Kolmogorov forward differential equations, the transition probabilities in terms of the transition intensities.</em></p>
<p>The intensity matrix is <span class="math display">\[{\bf A}(t)=\left( \begin{array}{cccc}
-A_{01}(t)-A_{02}(t)-A_{03}(t)&amp;A_{01}(t)&amp;A_{02}(t)&amp;A_{03}(t)\\
0&amp;-A_{12}(t)-A_{13}(t)&amp;A_{12}(t)&amp;A_{13}(t)\\
0&amp;0&amp;-A_{23}(t)&amp;A_{23}(t)\\
0&amp;0&amp;0&amp;0\\
\end{array} \right),
\]</span> and the transition probability matrix <span class="math display">\[{\bf P}(s,t)=\left( \begin{array}{cccc}
P_{00}(s,t)&amp;P_{01}(s,t)&amp;P_{02}(s,t)&amp;P_{03}(s,t)\\
0&amp;P_{11}(s,t)&amp;P_{12}(s,t)&amp;P_{13}(s,t)\\
0&amp;0&amp;P_{22}(s,t)&amp;P_{23}(s,t)\\
0&amp;0&amp;0&amp;1\\
\end{array} \right),
\]</span> with <span class="math inline">\(P_{00}=1-P_{01}-P_{02}-P_{03}\)</span>, <span class="math inline">\(P_{11}=1-P_{12}-P_{13}\)</span>, and <span class="math inline">\(P_{22}=1-P_{23}\)</span>. The Kolmogorov forward equations are <span class="math display">\[\frac{\partial}{\partial t}P_{00}(s,t)=-P_{00}(s,t)(\alpha_{01}(t)+\alpha_{02}(t)+\alpha_{03}(t)),\]</span> <span class="math display">\[\frac{\partial}{\partial t}P_{01}(s,t)=P_{00}(s,t)\alpha_{01}(t)-P_{01}(s,t)(\alpha_{12}(t)+\alpha_{13}(t)),\]</span> <span class="math display">\[\frac{\partial}{\partial t}P_{02}(s,t)=P_{00}(s,t)\alpha_{02}(t)+P_{01}(s,t)\alpha_{12}(t)-P_{02}(s,t)\alpha_{23}(t),\]</span> <span class="math display">\[\frac{\partial}{\partial t}P_{11}(s,t)=-P_{11}(s,t)(\alpha_{12}(t)+\alpha_{13}(t)),\]</span> <span class="math display">\[\frac{\partial}{\partial t}P_{12}(s,t)=P_{11}(s,t)\alpha_{12}(t)-P_{22}(s,t)\alpha_{23}(t),\]</span> <span class="math display">\[\frac{\partial}{\partial t}P_{22}(s,t)=-P_{22}(s,t)\alpha_{23}(t).\]</span> For <span class="math inline">\(P_{hh}, h=0,1,2,\)</span> the solutions are the well-known <span class="math display">\[P_{hh}(s,t)=\exp(-\int_s^t\alpha_{h\cdot}(u)du),\]</span> where <span class="math inline">\(\alpha_{h\cdot}(u)\)</span> is the total transition intensity out of state <span class="math inline">\(h\)</span>. For both <span class="math inline">\(P_{01}\)</span> and <span class="math inline">\(P_{21}\)</span>, the equation has the same form as that for the Markov illness-death model (Section 5.1.3, except for a misprint there where the r.h.s. of the equation for <span class="math inline">\(P_{01}\)</span> should read <span class="math inline">\(P_{00}(s,t)\alpha_{01}(t)-P_{01}(s,t)\alpha_{12}(t)\)</span>) and the solutions are, respectively, <span class="math display">\[P_{01}(s,t)=\int_s^tP_{00}(s,u)\alpha_{01}(u)P_{11}(u,t)du, \quad
P_{12}(s,t)=\int_s^tP_{11}(s,u)\alpha_{12}(u)P_{22}(u,t)du.\]</span> These results may be verified by direct differentiation or by referring to the fact that the differential equation is linear, as utilized in Exercise 5.1.</p>
<p>The equation for <span class="math inline">\(P_{02}(s,t)=f(t)\)</span> is also linear, <span class="math inline">\(f^{\prime}(t)+g(t)f(t)=h(t)\)</span>, with <span class="math inline">\(g(t)=\alpha_{23}(t)\)</span> and <span class="math inline">\(h(t)=P_{00}(s,t)\alpha_{02}(t)+P_{01}(s,t)\alpha_{12}(t)\)</span>. As a consequence, the solution (as shown in Section 5.1.5) has two terms <span class="math display">\[P_{02}^{(a)}(s,t)=\int_s^tP_{00}(s,u)\alpha_{02}(u)P_{22}(u,t)du\]</span> corresponding to the probability of a direct <span class="math inline">\(0\rightarrow 2\)</span> transition, and <span class="math display">\[P_{02}^{(b)}(s,t)=\int_s^tP_{01}(s,u)\alpha_{12}(u)P_{22}(u,t)du\]</span> corresponding to transition via state 1.</p>
</section>
<section id="exercise-5.3" class="level3">
<h3 class="anchored" data-anchor-id="exercise-5.3">Exercise 5.3 (*)</h3>
<section id="section" class="level4">
<h4 class="anchored" data-anchor-id="section">1.</h4>
<p><em>Consider the competing risks model and show that the ratio between the cause <span class="math inline">\(h\)</span> sub-distribution hazard and the corresponding cause-specific hazard is <span class="math display">\[\frac{\widetilde{\alpha}_h(t)}{\alpha_h(t)}=\frac{S(t)}{1-F_h(t)}.\]</span></em></p>
<p>Let <span class="math inline">\(T_h=\inf\{t:V(t)=h\}\)</span> be the improper variable denoting time of transition into state <span class="math inline">\(h\)</span>. Then <span class="math inline">\(P(t\leq T_h&lt;t+dt)=\alpha_{0h}(t)P(V(t)=0)dt\)</span>. The cause-specific hazard is the conditional probability of this event given <span class="math inline">\(V(t)=0\)</span>, and the conditioning event has probability <span class="math inline">\(S(t)=P(V(t)=0)\)</span>. For the sub-distribution hazard the conditioning event is <span class="math inline">\(T_h&gt;t\)</span> with probability <span class="math inline">\(1-F_h(t)\)</span>, so, the ratio between the two is <span class="math inline">\(S(t)/(1-F_1(t))\)</span>.</p>
</section>
<section id="section-1" class="level4">
<h4 class="anchored" data-anchor-id="section-1">2.</h4>
<p><em>Show that, thereby, proportional sub-distribution hazards and proportional cause-specific hazards are incompatible.</em></p>
<p>For a two-sample situation with proportional cause-specific hazards, i.e., <span class="math inline">\(\alpha_{h1}(t)=\theta\alpha_{h0}(t)\)</span>, the ratio between the corresponding sub-distribution hazards is, therefore, <span class="math display">\[\frac{\widetilde{\alpha}_{h1}(t)}{\widetilde{\alpha}_{h0}(t)}=\frac{S_1(t)/(1-F_{h1}(t))}{S_0(t)/(1-F_{h0}(t))}\]</span> <span class="math display">\[=\frac{\exp(-A_h(t)(\theta-1))}{\theta\int_0^tS_1(u)\alpha_h(u)du/\int_0^tS_0(u)\alpha_h(u)du}\]</span> which is constant in <span class="math inline">\(t\)</span> only if <span class="math inline">\(\theta=1\)</span>. A similar argument shows that proportional sub-distribution hazards leads to non-proportional cause-specific hazards.</p>
</section>
</section>
<section id="exercise-5.4" class="level3">
<h3 class="anchored" data-anchor-id="exercise-5.4">Exercise 5.4 (*)</h3>
<p><em>Consider the competing risks model and direct binomial regression for <span class="math inline">\(Q_h(t_0)\)</span>, the cause-<span class="math inline">\(h\)</span> cumulative incidence at time <span class="math inline">\(t_0\)</span>. The estimating equation (5.18) is</em> <span class="math display">\[\sum_iD_i(t_0)\widehat{W}_i(t_0)\mathbf{A}(\mathbf{\beta}^{\sf T}\mathbf{Z}_i)\bigl(N_{hi}(t_0)-Q_h(t_0\mid \mathbf{Z}_1)\bigr)\]</span> <em>with <span class="math inline">\(D_i(t_0)\)</span> the indicator <span class="math inline">\(I(T_i\wedge t_0\leq C_i)\)</span> of observing the state occupied at <span class="math inline">\(t_0\)</span> and <span class="math inline">\(\widehat{W}_i(t_0)=1/\widehat{G}((t_0\wedge X_i)-)\)</span> the estimated inverse probability of no censoring (strictly) before the minimum of <span class="math inline">\(t_0\)</span> and the observation time <span class="math inline">\(X_i\)</span> for subject <span class="math inline">\(i\)</span>. The alternative estimating equation (5.32) is</em> <span class="math display">\[\sum_i\mathbf{A}(\mathbf{\beta}^{\sf T}\mathbf{Z}_i)\bigl(N_{hi}(t_0)D_i(t_0)\widehat{W}_i(t_0)-Q_h(t_0\mid \mathbf{Z}_i)\bigr).\]</span> <em>Show that, replacing <span class="math inline">\(\widehat{G}\)</span> by the true <span class="math inline">\(G\)</span>, both estimating equations are unbiased.</em></p>
<p>Note that <span class="math inline">\(D_i(t_0)/G(t_0\wedge X_i)=D_i(t_0)/G(t_0\wedge T_i)\)</span> and that, hence, <span class="math display">\[E(D_i(t_0)/G(t_0\wedge X_i)\mid T_i)=1.\]</span> Note, further, that the observed indicator <span class="math inline">\(N_{hi}(t_0)=I(X_i\leq t_0, D_i=h)\)</span> in both sets of equations, <span class="math inline">\(\mathbf{U}=\mathbf{0}\)</span>, may be replaced by <span class="math inline">\(I(T_i\leq t_0, D_i=h)\)</span>. This is because <span class="math display">\[\widehat{W}_i(t_0)N_{hi}(t_0)=\widehat{W}_i(t_0)I(T_i\leq t_0, D_i=h).\]</span> With these remarks in place, unbiasedness of both sets of estimating equations follows by writing the expectation as <span class="math display">\[E(\mathbf{U})=E_T(E(\mathbf{U}\mid T)).\]</span></p>
</section>
<section id="exercise-5.5" class="level3">
<h3 class="anchored" data-anchor-id="exercise-5.5">Exercise 5.5 (*)</h3>
<p><em>Derive the estimating equations for the landmark model (5.11).</em></p>
<p>The pseudo-likelihood contribution from a single landmark is <span class="math display">\[\sum_{i=1}^n\int_{s_j}^{t_{hor}(s_j)}Y_i(s_j)\log\bigl(\frac{\exp(\mbox{LP}_{s_j,i})}{\sum_kY_k(t)\exp(\mbox{LP}_{s_j,k})}\bigr)dN_i(t),\]</span> however, in contrast to model (5.10), the same regression coefficient appears at all landmarks, so, the resulting pseudo-likelihood is obtained by adding over landmarks, <span class="math inline">\(j\)</span> <span class="math display">\[\sum_{j=1}^L\sum_{i=1}^n\int_{s_j}^{t_{hor}(s_j)}Y_i(s_j)\log\bigl(\frac{\exp(\mbox{LP}_{s_j,i})}{\sum_kY_k(t)\exp(\mbox{LP}_{s_j,k})}\bigr)dN_i(t).\]</span> There is a baseline hazard for each landmark, and estimation is based on events observed between <span class="math inline">\(s_j\)</span> and <span class="math inline">\(t_{hor}(s_j)\)</span>, i.e., the Breslow-type estimator <span class="math display">\[\widehat{A}_{0s_j}(t)=\int_{s_j}^t\frac{\sum_iY_i(s_j)dN_i(u)}{\sum_iY_i(u)\exp(\widehat{\mbox{LP}}_{s_j,i})}.\]</span></p>
</section>
<section id="exercise-5.6" class="level3">
<h3 class="anchored" data-anchor-id="exercise-5.6">Exercise 5.6</h3>
<p><em>Consider an illness-death model for the Copenhagen Holter study with states 0: Alive without AF or stroke, 1: Alive with AF and no stroke, 2: Dead or stroke, see Figures 1.3 and 1.7. Examine, using a time-dependent covariate, whether this process may be modeled as being Markovian.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-26-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-26-1" role="tab" aria-controls="tabset-26-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-26-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-26-2" role="tab" aria-controls="tabset-26-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-26-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-26-1-tab">
<p>The data should be loaded as <strong>chs_data</strong></p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-42_70e0e23f7ed3d706bdcdf387ddd11d53">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>chs_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/cphholter.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We then load the relevant packages</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-43_44e64347330c7c516e557c7700dc2751">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co">#Data manipulations and plots</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival) <span class="co">#Core survival analysis routines</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mstate) <span class="co">#probtrans, ELOS</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets) <span class="co">#binreg</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(timereg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, we will convert the time variables to years and add a time variable and status indicator for the composite end-point stroke-free survival.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-44_874b4f291e9238b67cc9edc801f31d68">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>chs_data <span class="ot">&lt;-</span> chs_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">timeafib =</span> timeafib<span class="sc">/</span><span class="fl">365.25</span>,</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">timestroke =</span> timestroke<span class="sc">/</span><span class="fl">365.25</span>,</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">timedeath =</span> timedeath<span class="sc">/</span><span class="fl">365.25</span>,</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">timestrokeordeath =</span> <span class="fu">ifelse</span>(stroke <span class="sc">==</span> <span class="dv">1</span>, timestroke, timedeath),</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">strokeordeath =</span> <span class="fu">ifelse</span>(stroke <span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span>, death))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For an illness-death process to be Markovian, <span class="math inline">\(\alpha_{13}(\cdot)\)</span> must only depend on time since start of the study, <span class="math inline">\(t\)</span>. We will test the Markov assumption by adding the following time-dependent covariate in a Cox model for <span class="math inline">\(\alpha_{13}(\cdot)\)</span>,</p>
<p><span class="math display">\[ Z_{i1}(t) = I(d_i(t) &lt; \text{30 days}),\]</span></p>
<p>where <span class="math inline">\(d_i(t) = t - T_{1i}\)</span> and <span class="math inline">\(T_{1i}\)</span> is the time of diagnosis of AF for patient <span class="math inline">\(i\)</span>.</p>
<p>We will first make a subset of the data only containing subjects with AF (and where no stroke occurred before the time of the AF diagnosis). We will add a variable <strong>wait</strong> to this data frame which is the difference between <strong>timeafib</strong> and <strong>timestrokeordeath</strong>.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-45_73aff48adc46d3b8c5c8e996d8805c17">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>af_subset <span class="ot">&lt;-</span> chs_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(afib <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timeafib <span class="sc">&amp;</span> timeafib <span class="sc">&lt;</span> timestrokeordeath) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">wait =</span> timestrokeordeath <span class="sc">-</span> timeafib)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then, we will split each record at 30 days after the diagnosis of AF using the <strong>survSplit</strong> function from the <em>survival</em> package. We must include a <strong>Surv</strong> object as the formula argument and specify the name of our time-dependent covariate in the <strong>episode</strong> argument and the values where we wish to split the data using the <strong>cut</strong> argument.</p>
<p>Furthermore, we will add the variables <strong>start</strong> and <strong>end</strong> which are the start and end time for each row using time since entry to study as time variable.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-46_b4a38e89f2518f6fae8fb5ac5fc38db3">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating new data for estimation with piece-wise constant effect of duration in state 1</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>data56 <span class="ot">&lt;-</span> <span class="fu">survSplit</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(wait, strokeordeath) <span class="sc">~</span> ., <span class="at">data =</span> af_subset, <span class="at">cut =</span> (<span class="dv">30</span><span class="fl">-0.00001</span>)<span class="sc">/</span><span class="fl">365.25</span>, <span class="at">episode =</span> <span class="st">"interval"</span>)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Resetting start and end points of interval</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>data56<span class="sc">$</span>start <span class="ot">&lt;-</span> data56<span class="sc">$</span>tstart <span class="sc">+</span> data56<span class="sc">$</span>timeafib</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>data56<span class="sc">$</span>end <span class="ot">&lt;-</span> data56<span class="sc">$</span>wait <span class="sc">+</span> data56<span class="sc">$</span>timeafib</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, we fit a model with <strong>coxph</strong> from the survival package using the data set <strong>data56</strong>.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-47_92d5f7a2db2b91da56bcb6efa14d1c70">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>cox56 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(start, end, strokeordeath) <span class="sc">~</span> interval, <span class="at">data=</span> data56, <span class="at">ties =</span> <span class="st">"breslow"</span>) </span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox56)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(start, end, strokeordeath) ~ interval, data = data56, 
    ties = "breslow")

  n= 129, number of events= 30 

            coef exp(coef) se(coef)      z Pr(&gt;|z|)   
interval -2.1313    0.1187   0.6735 -3.164  0.00155 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

         exp(coef) exp(-coef) lower .95 upper .95
interval    0.1187      8.426    0.0317    0.4443

Concordance= 0.547  (se = 0.029 )
Likelihood ratio test= 7.95  on 1 df,   p=0.005
Wald test            = 10.01  on 1 df,   p=0.002
Score (logrank) test = 13.75  on 1 df,   p=2e-04</code></pre>
</div>
</div>
<p>Since the time-dependent covariate is highly significant (<span class="math inline">\(p\)</span>-value is <span class="math inline">\(0.0015\)</span>), the Markov assumption does seem to be violated.</p>
</div>
<div id="tabset-26-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-26-2-tab">
<p>We first load and prepare the data:</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-48_346bc280d6c19c4c1e9b77172e47e036">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> import out = chs_<span class="kw">data</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>    datafile = <span class="st">'data/cphholter.csv'</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    dbms= csv <span class="kw">replace</span>;</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    getnames=yes;</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="co">* We will convert the time variables, timeafib, timestroke, and timedeath, from days to years;</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a><span class="co">* Furthermore, we add variables for the composite end-point of stroke or death without stroke;</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> chs_<span class="kw">data</span>;</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> chs_<span class="kw">data</span>;</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    timeafib = timeafib/<span class="dv">365.25</span>;</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>    timestroke = timestroke/<span class="dv">365.25</span>;</span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    timedeath = timedeath/<span class="dv">365.25</span>;</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>    timestrokeordeath = timedeath;</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> stroke = <span class="dv">1</span> <span class="kw">then</span> timestrokeordeath = timestroke;</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>    strokeordeath = death;</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> stroke = <span class="dv">1</span> <span class="kw">then</span> strokeordeath = <span class="dv">1</span>;</span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then code for solution.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-49_79e70e31e12b0ec74e9ebade6e329b72">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">* For the process of an illness-death model to be Markovian alpha13(.) must only depend on time since start of the study, </span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co">  t. We will test the Markov assumption by adding the following time-dependent covariate in a Cox model for alpha13(.),</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co">  </span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co">   Z_i1(t) = I(d_i(t) &gt; 30 days),</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co">   </span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co">   where d_i(t) = t - T_1i  and T_1i is the time of diagnosis of AF for patient i.;</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="co">* The model is fitted using the 'phreg' procedure. The only covariate in the model is 'wait30' which is designed as described above. </span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="co">  To account for delayed entry we must add the argument '/ entry = timeafib' in the model statement.;</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"5.6"</span>;</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span> = chs_<span class="kw">data</span>;</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timestrokeordeath*strokeordeath(<span class="dv">0</span>)=wait30 / entry = timeafib;</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>    wait30 = <span class="dv">0</span>;</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> ((timestrokeordeath - timeafib) &gt; <span class="dv">30</span>/<span class="dv">365.25</span>) <span class="kw">then</span> wait30 = <span class="dv">1</span>;</span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a><span class="co">* The time-dependent covariate is highly significant (p-value of 0.0016). Thus, the Markov assumption does seem to be violated, </span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="co">  i.e. there seems to be an effect of the duration of AF.;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="exercise-5.7" class="level3">
<h3 class="anchored" data-anchor-id="exercise-5.7">Exercise 5.7</h3>
<p><em>Consider the four-state model for the Copenhagen Holter study, see Figure 1.7.</em></p>
<section id="section-2" class="level4">
<h4 class="anchored" data-anchor-id="section-2">1.</h4>
<p><em>Fit separate landmark models at times 3, 6, and 9 years for the mortality rate, including AF, stroke, ESVEA, sex, age, and systolic blood pressure.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-27-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-27-1" role="tab" aria-controls="tabset-27-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-27-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-27-2" role="tab" aria-controls="tabset-27-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-27-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-27-1-tab">
<p>In order to fit separate land-mark models at times <span class="math inline">\(s\)</span> = 3, 6, and 9 years for the mortality rate, including AF, stroke, ESVEA, sex, age, and systolic blood pressure, we must create a new data set.</p>
<p>For each time point, we will make a data set which only contains subjects still under observation at time <span class="math inline">\(s\)</span> = 3, 6 or 9 years. The variables <strong>afib</strong> and <strong>stroke</strong> are modified such that they correspond to the indicator functions <span class="math inline">\(I(AF \leq s)\)</span> and <span class="math inline">\(I(\text{stroke} \leq s)\)</span>. Furthermore, <strong>landmark = s</strong> and <strong>entry = s</strong> are added to the data sets.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-50_afad6b0992c997f5754fc38f2ee347e9">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the landmark data at $s$ = 3, 6, 9 years </span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>lm571_3 <span class="ot">&lt;-</span> chs_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(timedeath <span class="sc">&gt;=</span> <span class="dv">3</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">afib =</span> <span class="fu">ifelse</span>(afib <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timeafib <span class="sc">&lt;=</span> <span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">stroke =</span> <span class="fu">ifelse</span>(stroke <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timestroke <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">landmark =</span> <span class="dv">3</span>,</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">entry =</span> <span class="dv">3</span>)</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>lm571_6 <span class="ot">&lt;-</span> chs_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(timedeath <span class="sc">&gt;=</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">afib =</span> <span class="fu">ifelse</span>(afib <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timeafib <span class="sc">&lt;=</span> <span class="dv">6</span>,<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">stroke =</span> <span class="fu">ifelse</span>(stroke <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timestroke <span class="sc">&lt;=</span> <span class="dv">6</span>, <span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">landmark =</span> <span class="dv">6</span>,</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">entry =</span> <span class="dv">6</span>)</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>lm571_9 <span class="ot">&lt;-</span> chs_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(timedeath <span class="sc">&gt;=</span> <span class="dv">9</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">afib =</span> <span class="fu">ifelse</span>(afib <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timeafib <span class="sc">&lt;=</span> <span class="dv">9</span>,<span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">stroke =</span> <span class="fu">ifelse</span>(stroke <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> timestroke <span class="sc">&lt;=</span> <span class="dv">9</span>, <span class="dv">1</span>,<span class="dv">0</span>),</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">landmark =</span> <span class="dv">9</span>, <span class="at">entry =</span> <span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We then create a data set called <strong>lm571</strong> where the former data sets are merged and covariates corresponding to each time point are added.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-51_7ddacfe3a1144839dd1fa72afbe5884e">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Merging the data sets and specifying covariates for each time point</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>lm571 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(lm571_3, lm571_6, lm571_9)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>lm571 <span class="ot">&lt;-</span> lm571 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">afib3 =</span> (landmark <span class="sc">==</span> <span class="dv">3</span>)<span class="sc">*</span>afib,</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">afib6 =</span> (landmark <span class="sc">==</span> <span class="dv">6</span>)<span class="sc">*</span>afib,</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">afib9 =</span> (landmark <span class="sc">==</span> <span class="dv">9</span>)<span class="sc">*</span>afib,</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">stroke3 =</span> (landmark <span class="sc">==</span> <span class="dv">3</span>)<span class="sc">*</span>stroke,</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">stroke6 =</span> (landmark <span class="sc">==</span> <span class="dv">6</span>)<span class="sc">*</span>stroke,</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">stroke9 =</span> (landmark <span class="sc">==</span> <span class="dv">9</span>)<span class="sc">*</span>stroke,</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">esvea3 =</span> (landmark <span class="sc">==</span> <span class="dv">3</span>)<span class="sc">*</span>esvea,</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">esvea6 =</span> (landmark <span class="sc">==</span> <span class="dv">6</span>)<span class="sc">*</span>esvea,</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">esvea9 =</span> (landmark <span class="sc">==</span> <span class="dv">9</span>)<span class="sc">*</span>esvea,</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sex3 =</span> (landmark <span class="sc">==</span> <span class="dv">3</span>)<span class="sc">*</span>sex,</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sex6 =</span> (landmark <span class="sc">==</span> <span class="dv">6</span>)<span class="sc">*</span>sex,</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sex9 =</span> (landmark <span class="sc">==</span> <span class="dv">9</span>)<span class="sc">*</span>sex,</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>                          <span class="at">age3 =</span> (landmark <span class="sc">==</span> <span class="dv">3</span>)<span class="sc">*</span>age,</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">age6 =</span> (landmark <span class="sc">==</span> <span class="dv">6</span>)<span class="sc">*</span>age,</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>                          <span class="at">age9 =</span> (landmark <span class="sc">==</span> <span class="dv">9</span>)<span class="sc">*</span>age,</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sbp3 =</span> (landmark <span class="sc">==</span> <span class="dv">3</span>)<span class="sc">*</span>sbp,</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sbp6 =</span> (landmark <span class="sc">==</span> <span class="dv">6</span>)<span class="sc">*</span>sbp,</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>                          <span class="at">sbp9 =</span> (landmark <span class="sc">==</span> <span class="dv">9</span>)<span class="sc">*</span>sbp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, the models are fitted with the <strong>coxph</strong> function using the <strong>lm571</strong> data set. We must include <strong>strata(landmark)</strong> in the formula argument to obtain separate models for each time point.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-52_0eb55c7cd122afeb28a4d4a8da02c2f9">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a Cox model using the land-mark data set</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>cox571 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(entry, timedeath, death) <span class="sc">~</span> afib3 <span class="sc">+</span> stroke3 <span class="sc">+</span> esvea3 <span class="sc">+</span> sex3 <span class="sc">+</span> age3 <span class="sc">+</span> sbp3 <span class="sc">+</span> </span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>                                                     afib6 <span class="sc">+</span> stroke6 <span class="sc">+</span> esvea6 <span class="sc">+</span> sex6 <span class="sc">+</span> age6 <span class="sc">+</span> sbp6 <span class="sc">+</span> </span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>                                                     afib9 <span class="sc">+</span> stroke9 <span class="sc">+</span> esvea9 <span class="sc">+</span> sex9 <span class="sc">+</span> age9 <span class="sc">+</span> sbp9 <span class="sc">+</span> <span class="fu">strata</span>(landmark),</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> lm571,</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox571)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(entry, timedeath, death) ~ afib3 + stroke3 + 
    esvea3 + sex3 + age3 + sbp3 + afib6 + stroke6 + esvea6 + 
    sex6 + age6 + sbp6 + afib9 + stroke9 + esvea9 + sex9 + age9 + 
    sbp9 + strata(landmark), data = lm571, method = "breslow")

  n= 1797, number of events= 549 
   (6 observations deleted due to missingness)

            coef exp(coef) se(coef)     z Pr(&gt;|z|)    
afib3   0.136999  1.146827 0.513704 0.267 0.789709    
stroke3 0.796183  2.217063 0.368752 2.159 0.030840 *  
esvea3  0.257979  1.294312 0.168340 1.532 0.125402    
sex3    0.649505  1.914594 0.141875 4.578 4.69e-06 ***
age3    0.078952  1.082153 0.010458 7.549 4.38e-14 ***
sbp3    0.006299  1.006319 0.002700 2.333 0.019648 *  
afib6   0.433822  1.543144 0.420121 1.033 0.301786    
stroke6 1.356334  3.881935 0.252350 5.375 7.67e-08 ***
esvea6  0.067649  1.069989 0.203817 0.332 0.739958    
sex6    0.573667  1.774763 0.163193 3.515 0.000439 ***
age6    0.067283  1.069598 0.012099 5.561 2.68e-08 ***
sbp6    0.006280  1.006300 0.003099 2.026 0.042740 *  
afib9   0.557615  1.746502 0.334701 1.666 0.095711 .  
stroke9 1.004845  2.731483 0.268416 3.744 0.000181 ***
esvea9  0.089436  1.093558 0.241025 0.371 0.710589    
sex9    0.613813  1.847462 0.190968 3.214 0.001308 ** 
age9    0.070655  1.073211 0.014072 5.021 5.14e-07 ***
sbp9    0.004288  1.004297 0.003733 1.149 0.250758    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

        exp(coef) exp(-coef) lower .95 upper .95
afib3       1.147     0.8720    0.4190     3.139
stroke3     2.217     0.4510    1.0762     4.567
esvea3      1.294     0.7726    0.9306     1.800
sex3        1.915     0.5223    1.4498     2.528
age3        1.082     0.9241    1.0602     1.105
sbp3        1.006     0.9937    1.0010     1.012
afib6       1.543     0.6480    0.6773     3.516
stroke6     3.882     0.2576    2.3673     6.366
esvea6      1.070     0.9346    0.7176     1.595
sex6        1.775     0.5635    1.2889     2.444
age6        1.070     0.9349    1.0445     1.095
sbp6        1.006     0.9937    1.0002     1.012
afib9       1.747     0.5726    0.9063     3.366
stroke9     2.731     0.3661    1.6141     4.622
esvea9      1.094     0.9144    0.6818     1.754
sex9        1.847     0.5413    1.2706     2.686
age9        1.073     0.9318    1.0440     1.103
sbp9        1.004     0.9957    0.9970     1.012

Concordance= 0.671  (se = 0.012 )
Likelihood ratio test= 230  on 18 df,   p=&lt;2e-16
Wald test            = 257.9  on 18 df,   p=&lt;2e-16
Score (logrank) test = 291.9  on 18 df,   p=&lt;2e-16</code></pre>
</div>
</div>
</div>
<div id="tabset-27-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-27-2-tab">
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-53_ff76fb37ade677535ac74502299359a0">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co">* We will now fit separate land-mark models at times 3, 6, and 9 years for the mortality rate, including AF, stroke, ESVEA, sex, </span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="co">  age, and systolic blood pressure. AF and stroke will enter as the time-dependent covariates I(AF &lt; s) and I(stroke &lt; s) for s = 3, 6,</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="co">  9 years;</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="co">* We will first make a new data set called 'landmark' where we record the status of AF and stroke for all subjects at risk at the </span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="co">  three landmark times;</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> landmark; <span class="kw">set</span> chs_<span class="kw">data</span>;</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> timedeath &gt;=<span class="dv">3</span> <span class="kw">then do</span>;</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>        landmark=<span class="dv">3</span>; entry=<span class="dv">3</span>;</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>        af = <span class="dv">0</span>; <span class="kw">if</span> afib = <span class="dv">1</span> <span class="kw">and</span> timeafib &lt;= <span class="dv">3</span> <span class="kw">then</span> af = <span class="dv">1</span>;</span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>        str =<span class="dv">0</span>; <span class="kw">if</span> stroke = <span class="dv">1</span> <span class="kw">and</span> timestroke &lt;=<span class="dv">3</span> <span class="kw">then</span> str=<span class="dv">1</span>;</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output; end</span>;</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> timedeath &gt;=<span class="dv">6</span> <span class="kw">then do</span>;</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>        landmark=<span class="dv">6</span>; entry=<span class="dv">6</span>;</span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>        af = <span class="dv">0</span>; <span class="kw">if</span> afib = <span class="dv">1</span> <span class="kw">and</span> timeafib &lt;= <span class="dv">6</span> <span class="kw">then</span> af = <span class="dv">1</span>;</span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>        str =<span class="dv">0</span>; <span class="kw">if</span> stroke = <span class="dv">1</span> <span class="kw">and</span> timestroke &lt;=<span class="dv">6</span> <span class="kw">then</span> str=<span class="dv">1</span>;</span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output; end</span>;</span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> timedeath&gt;=<span class="dv">9</span> <span class="kw">then do</span>;</span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>        landmark=<span class="dv">9</span>; entry=<span class="dv">9</span>;</span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>        af = <span class="dv">0</span>; <span class="kw">if</span> afib = <span class="dv">1</span> <span class="kw">and</span> timeafib &lt;= <span class="dv">9</span> <span class="kw">then</span> af = <span class="dv">1</span>;</span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>        str =<span class="dv">0</span>; <span class="kw">if</span> stroke = <span class="dv">1</span> <span class="kw">and</span> timestroke &lt;=<span class="dv">9</span> <span class="kw">then</span> str=<span class="dv">1</span>;</span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output; end</span>;</span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a><span class="co">* We will fit all three models within one 'phreg' procedure. Therefore, we must use three different names for the </span></span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a><span class="co">  covariates at each land-mark time. The names are specified in the data frame 'covar541';</span></span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov571;</span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a>    afib3 = <span class="dv">0</span>; afib6 = <span class="dv">0</span>; afib9 = <span class="dv">0</span>;</span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a>    stroke3 = <span class="dv">0</span>; stroke6 = <span class="dv">0</span>; stroke9 = <span class="dv">0</span>;</span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a>    esvea3 = <span class="dv">0</span>; esvea6 = <span class="dv">0</span>; esvea9 = <span class="dv">0</span>;</span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a>    sex3 = <span class="dv">0</span>; sex6 = <span class="dv">0</span>; sex9 = <span class="dv">0</span>;</span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a>    age3 = <span class="dv">0</span>; age6 = <span class="dv">0</span>; age9 = <span class="dv">0</span>;</span>
<span id="cb103-35"><a href="#cb103-35" aria-hidden="true" tabindex="-1"></a>    sbp3 = <span class="dv">0</span>; sbp6 = <span class="dv">0</span>; sbp9 = <span class="dv">0</span>;</span>
<span id="cb103-36"><a href="#cb103-36" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb103-37"><a href="#cb103-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-38"><a href="#cb103-38" aria-hidden="true" tabindex="-1"></a><span class="co">* We must include the argument '/entry = entry' in the model statement and 'landmark' in the strata statement.;</span></span>
<span id="cb103-39"><a href="#cb103-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-40"><a href="#cb103-40" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"5.7.1"</span>;</span>
<span id="cb103-41"><a href="#cb103-41" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=landmark;</span>
<span id="cb103-42"><a href="#cb103-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timedeath*death(<span class="dv">0</span>)= afib3 stroke3 esvea3 sex3 age3 sbp3</span>
<span id="cb103-43"><a href="#cb103-43" aria-hidden="true" tabindex="-1"></a>                              afib6 stroke6 esvea6 sex6 age6 sbp6</span>
<span id="cb103-44"><a href="#cb103-44" aria-hidden="true" tabindex="-1"></a>                              afib9 stroke9 esvea9 sex9 age9 sbp9 /entry=entry;</span>
<span id="cb103-45"><a href="#cb103-45" aria-hidden="true" tabindex="-1"></a>    afib3 = af*(landmark = <span class="dv">3</span>); stroke3 = str*(landmark = <span class="dv">3</span>); esvea3 = esvea*(landmark = <span class="dv">3</span>); </span>
<span id="cb103-46"><a href="#cb103-46" aria-hidden="true" tabindex="-1"></a>    sex3 = sex*(landmark = <span class="dv">3</span>); age3 = age*(landmark = <span class="dv">3</span>); sbp3 = sbp*(landmark = <span class="dv">3</span>);</span>
<span id="cb103-47"><a href="#cb103-47" aria-hidden="true" tabindex="-1"></a>    afib6 = af*(landmark = <span class="dv">6</span>); stroke6 = str*(landmark = <span class="dv">6</span>);esvea6 = esvea*(landmark = <span class="dv">6</span>); </span>
<span id="cb103-48"><a href="#cb103-48" aria-hidden="true" tabindex="-1"></a>    sex6 = sex*(landmark = <span class="dv">6</span>); age6 = age*(landmark = <span class="dv">6</span>); sbp6 = sbp*(landmark = <span class="dv">6</span>);</span>
<span id="cb103-49"><a href="#cb103-49" aria-hidden="true" tabindex="-1"></a>    afib9 = af*(landmark = <span class="dv">9</span>); stroke9 = str*(landmark = <span class="dv">9</span>); esvea9 = esvea*(landmark = <span class="dv">9</span>); </span>
<span id="cb103-50"><a href="#cb103-50" aria-hidden="true" tabindex="-1"></a>    sex9 = sex*(landmark = <span class="dv">9</span>); age9 = age*(landmark = <span class="dv">9</span>); sbp9 = sbp*(landmark = <span class="dv">9</span>);</span>
<span id="cb103-51"><a href="#cb103-51" aria-hidden="true" tabindex="-1"></a>    strata landmark;</span>
<span id="cb103-52"><a href="#cb103-52" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="section-3" class="level4">
<h4 class="anchored" data-anchor-id="section-3">2.</h4>
<p><em>Fit landmark super models where the coefficients vary smoothly among landmarks but with separate baseline hazards at each landmark.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-28-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-28-1" role="tab" aria-controls="tabset-28-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-28-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-28-2" role="tab" aria-controls="tabset-28-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-28-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-28-1-tab">
<p>We will now fit land-mark super-models where the coefficients vary smoothly among land-marks but with separate baseline hazards at each land-mark. We will let <span class="math inline">\(m = 2\)</span> and <span class="math inline">\(f_1(s) = \frac{s - s_1}{s_L - s_1} = \frac{s - 3}{9-3} = \frac{s-3}{6}\)</span> and <span class="math inline">\(f_2(s) = f_1(s)^2\)</span>.</p>
<p>Based on the data set <strong>lm571</strong> we create a new data set, <strong>lm572</strong>, where variables <span class="math inline">\(f_1(s)\)</span> and <span class="math inline">\(f_2(s)\)</span> are added for all covariates.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-54_908719e44bdaca4cf1156d31789cab40">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data frame fir the land-mark 'super-models' with separate baseline hazards at each land-mark</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>lm572 <span class="ot">&lt;-</span> lm571 <span class="sc">%&gt;%</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">afibtime  =</span> afib <span class="sc">*</span> (landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>,</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">afibtime2 =</span> afib <span class="sc">*</span> ((landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">stroketime  =</span> stroke <span class="sc">*</span> (landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>,</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">stroketime2 =</span> stroke <span class="sc">*</span> ((landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">esveatime  =</span> esvea <span class="sc">*</span> (landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>,</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">esveatime2 =</span> esvea <span class="sc">*</span> ((landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">sextime  =</span> sex <span class="sc">*</span> (landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>,</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">sextime2 =</span> sex <span class="sc">*</span> ((landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">agetime  =</span> age <span class="sc">*</span> (landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>,</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">agetime2 =</span> age <span class="sc">*</span> ((landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">sbptime  =</span> sbp <span class="sc">*</span> (landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>,</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">sbptime2 =</span> sbp <span class="sc">*</span> ((landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>)<span class="sc">^</span><span class="dv">2</span>,)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then, we fit the model with <strong>coxph</strong> using the data set <strong>lm572</strong>. We must include <strong>strata(landmark)</strong> in the formula argument to obtain separate baseline hazards at each land-mark.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-55_cf0dad254fc0e175c04a4be26be9c9b2">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a Cox model using the land-mark data set</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>cox572 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(entry, timedeath, death) <span class="sc">~</span>  afib <span class="sc">+</span> afibtime <span class="sc">+</span> afibtime2 <span class="sc">+</span> stroke <span class="sc">+</span> stroketime <span class="sc">+</span> stroketime2 <span class="sc">+</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>                                                      esvea <span class="sc">+</span> esveatime <span class="sc">+</span> esveatime2 <span class="sc">+</span> sex <span class="sc">+</span> sextime <span class="sc">+</span> sextime2 <span class="sc">+</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>                                                      age <span class="sc">+</span> agetime <span class="sc">+</span> agetime2 <span class="sc">+</span> sbp <span class="sc">+</span> sbptime <span class="sc">+</span> sbptime2 <span class="sc">+</span> <span class="fu">strata</span>(landmark),</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> lm572,</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox572)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(entry, timedeath, death) ~ afib + afibtime + 
    afibtime2 + stroke + stroketime + stroketime2 + esvea + esveatime + 
    esveatime2 + sex + sextime + sextime2 + age + agetime + agetime2 + 
    sbp + sbptime + sbptime2 + strata(landmark), data = lm572, 
    method = "breslow")

  n= 1797, number of events= 549 
   (6 observations deleted due to missingness)

                 coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
afib         0.136999  1.146827  0.513704  0.267   0.7897    
afibtime     0.766675  2.152597  2.304579  0.333   0.7394    
afibtime2   -0.346060  0.707470  2.080311 -0.166   0.8679    
stroke       0.796183  2.217063  0.368752  2.159   0.0308 *  
stroketime   2.031940  7.628872  1.521426  1.336   0.1817    
stroketime2 -1.823279  0.161495  1.360510 -1.340   0.1802    
esvea        0.257979  1.294312  0.168340  1.532   0.1254    
esveatime   -0.592779  0.552789  0.988838 -0.599   0.5489    
esveatime2   0.424236  1.528422  1.005180  0.422   0.6730    
sex          0.649505  1.914594  0.141875  4.578 4.69e-06 ***
sextime     -0.267661  0.765167  0.802333 -0.334   0.7387    
sextime2     0.231969  1.261080  0.807776  0.287   0.7740    
age          0.078952  1.082153  0.010458  7.549 4.38e-14 ***
agetime     -0.038378  0.962349  0.059369 -0.646   0.5180    
agetime2     0.030081  1.030538  0.059765  0.503   0.6147    
sbp          0.006299  1.006319  0.002700  2.333   0.0196 *  
sbptime      0.001936  1.001938  0.015272  0.127   0.8991    
sbptime2    -0.003948  0.996060  0.015447 -0.256   0.7983    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

            exp(coef) exp(-coef) lower .95 upper .95
afib           1.1468     0.8720   0.41902     3.139
afibtime       2.1526     0.4646   0.02351   197.071
afibtime2      0.7075     1.4135   0.01199    41.732
stroke         2.2171     0.4510   1.07621     4.567
stroketime     7.6289     0.1311   0.38674   150.487
stroketime2    0.1615     6.1921   0.01122     2.324
esvea          1.2943     0.7726   0.93057     1.800
esveatime      0.5528     1.8090   0.07959     3.839
esveatime2     1.5284     0.6543   0.21312    10.961
sex            1.9146     0.5223   1.44982     2.528
sextime        0.7652     1.3069   0.15878     3.687
sextime2       1.2611     0.7930   0.25892     6.142
age            1.0822     0.9241   1.06020     1.105
agetime        0.9623     1.0391   0.85664     1.081
agetime2       1.0305     0.9704   0.91663     1.159
sbp            1.0063     0.9937   1.00101     1.012
sbptime        1.0019     0.9981   0.97239     1.032
sbptime2       0.9961     1.0040   0.96636     1.027

Concordance= 0.671  (se = 0.012 )
Likelihood ratio test= 230  on 18 df,   p=&lt;2e-16
Wald test            = 257.9  on 18 df,   p=&lt;2e-16
Score (logrank) test = 291.9  on 18 df,   p=&lt;2e-16</code></pre>
</div>
</div>
</div>
<div id="tabset-28-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-28-2-tab">
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-56_dcea2415b76405a8e9c83e6f272a6617">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co">* We will now fit land-mark super-models where the coefficients vary smoothly among land-marks but with separate baseline hazards </span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="co">  at each land-mark. We will do as suggested in the book, m = 2 and f1(s) = (s - s1)/(sL - s1) = (s - 3)/6 and f2(s) = f1(s)^2.;</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="co">* Once again, we specify the names of the covariates in a data step;</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov572;</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    afib_ = <span class="dv">0</span>; afibtime = <span class="dv">0</span>; afibtime2 = <span class="dv">0</span>;</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>    stroke_ = <span class="dv">0</span>; stroketime = <span class="dv">0</span>; stroketime2 = <span class="dv">0</span>;</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>    esvea_ = <span class="dv">0</span>; esveatime = <span class="dv">0</span>; esveatime2 = <span class="dv">0</span>;</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    sex_ = <span class="dv">0</span>; sextime = <span class="dv">0</span>; sextime2 = <span class="dv">0</span>;</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>    age_ = <span class="dv">0</span>; agetime = <span class="dv">0</span>; agetime2 = <span class="dv">0</span>;</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>    sbp_ = <span class="dv">0</span>; sbptime = <span class="dv">0</span>; sbptime2 = <span class="dv">0</span>;</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a><span class="co">* Then, we fit the models using 'phreg' just as before.;</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"5.7.2"</span>;</span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=landmark;</span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timedeath*death(<span class="dv">0</span>)= afib_ afibtime afibtime2</span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>                              stroke_ stroketime stroketime2</span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a>                              esvea_ esveatime esveatime2</span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>                              sex_ sextime sextime2</span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>                              age_ agetime agetime2</span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>                              sbp_ sbptime sbptime2 / entry=entry;</span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>    afib_ = af; afibtime = af*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; afibtime2 = af*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a>    stroke_ = str; stroketime = str*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; stroketime2 = str*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a>    esvea_ = esvea; esveatime = esvea*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; esveatime2 = esvea*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a>    sex_ = sex; sextime = sex*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; sextime2 = sex*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>    age_ = age; agetime = age*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; agetime2 = age*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true" tabindex="-1"></a>    sbp_ = sbp; sbptime = sbp*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; sbptime2 = sbp*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb107-31"><a href="#cb107-31" aria-hidden="true" tabindex="-1"></a>    strata landmark;</span>
<span id="cb107-32"><a href="#cb107-32" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="section-4" class="level4">
<h4 class="anchored" data-anchor-id="section-4">3.</h4>
<p><em>Fit a landmark super model where both the coefficients and the baseline hazards vary smoothly among landmarks.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-29-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-29-1" role="tab" aria-controls="tabset-29-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-29-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-29-2" role="tab" aria-controls="tabset-29-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-29-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-29-1-tab">
<p>Finally, we will fit a land-mark super-model where both the coefficients and the baseline hazards vary smoothly among land-marks. We will choose the same smoothing functions for regression coefficients and baseline hazards, i. e. <span class="math inline">\(g_1 = f_1\)</span> and <span class="math inline">\(g_2 = f_2\)</span>.</p>
<p>Based on the data frame <strong>lm572</strong> we create a new data frame, <strong>lm573</strong>, where <span class="math inline">\(g_1\)</span> and <span class="math inline">\(g_2\)</span> are added.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-57_4a001c69f886b7378ade0f97fbc8a9bd">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data frame for a land-mark 'super-model' where both the coefficients and the baseline hazards vary smoothly among land-mark</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>lm573 <span class="ot">&lt;-</span> lm572 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">strtime =</span> (landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>,</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">strtime2 =</span> ((landmark <span class="sc">-</span> <span class="dv">3</span>)<span class="sc">/</span><span class="dv">6</span>)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then, we fit the model with <strong>coxph</strong> using the data set <strong>lm573</strong>.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-58_f235fd45313311e2785f72a3e997ca99">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a Cox model using the land-mark data set</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>cox573 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(entry, timedeath, death) <span class="sc">~</span> afib <span class="sc">+</span> afibtime <span class="sc">+</span> afibtime2 <span class="sc">+</span> stroke <span class="sc">+</span> stroketime <span class="sc">+</span> stroketime2 <span class="sc">+</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>                                                     esvea <span class="sc">+</span> esveatime <span class="sc">+</span> esveatime2 <span class="sc">+</span> sex <span class="sc">+</span> sextime <span class="sc">+</span> sextime2 <span class="sc">+</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>                                                     age <span class="sc">+</span> agetime <span class="sc">+</span> agetime2 <span class="sc">+</span> sbp <span class="sc">+</span> sbptime <span class="sc">+</span> sbptime2 <span class="sc">+</span> strtime <span class="sc">+</span> strtime2,</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> lm573,</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox573)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(entry, timedeath, death) ~ afib + afibtime + 
    afibtime2 + stroke + stroketime + stroketime2 + esvea + esveatime + 
    esveatime2 + sex + sextime + sextime2 + age + agetime + agetime2 + 
    sbp + sbptime + sbptime2 + strtime + strtime2, data = lm573, 
    method = "breslow")

  n= 1797, number of events= 549 
   (6 observations deleted due to missingness)

                 coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
afib         0.136803  1.146602  0.513611  0.266   0.7900    
afibtime     0.765264  2.149562  2.303814  0.332   0.7398    
afibtime2   -0.344476  0.708592  2.079599 -0.166   0.8684    
stroke       0.799017  2.223354  0.368384  2.169   0.0301 *  
stroketime   2.009340  7.458394  1.515493  1.326   0.1849    
stroketime2 -1.804159  0.164613  1.354815 -1.332   0.1830    
esvea        0.258459  1.294934  0.168305  1.536   0.1246    
esveatime   -0.594780  0.551684  0.988417 -0.602   0.5473    
esveatime2   0.425482  1.530328  1.004741  0.423   0.6719    
sex          0.649916  1.915380  0.141829  4.582 4.60e-06 ***
sextime     -0.270676  0.762864  0.801797 -0.338   0.7357    
sextime2     0.234638  1.264450  0.807219  0.291   0.7713    
age          0.079023  1.082229  0.010450  7.562 3.98e-14 ***
agetime     -0.038900  0.961847  0.059268 -0.656   0.5116    
agetime2     0.030511  1.030981  0.059668  0.511   0.6091    
sbp          0.006306  1.006326  0.002699  2.336   0.0195 *  
sbptime      0.001877  1.001879  0.015267  0.123   0.9021    
sbptime2    -0.003898  0.996110  0.015442 -0.252   0.8007    
strtime      2.344512 10.428185  4.381905  0.535   0.5926    
strtime2    -1.523546  0.217938  4.422212 -0.345   0.7305    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

            exp(coef) exp(-coef) lower .95 upper .95
afib           1.1466    0.87214 4.190e-01     3.138
afibtime       2.1496    0.46521 2.351e-02   196.499
afibtime2      0.7086    1.41125 1.203e-02    41.740
stroke         2.2234    0.44977 1.080e+00     4.577
stroketime     7.4584    0.13408 3.825e-01   145.424
stroketime2    0.1646    6.07486 1.157e-02     2.343
esvea          1.2949    0.77224 9.311e-01     1.801
esveatime      0.5517    1.81263 7.950e-02     3.829
esveatime2     1.5303    0.65345 2.136e-01    10.965
sex            1.9154    0.52209 1.451e+00     2.529
sextime        0.7629    1.31085 1.585e-01     3.672
sextime2       1.2645    0.79086 2.599e-01     6.152
age            1.0822    0.92402 1.060e+00     1.105
agetime        0.9618    1.03967 8.564e-01     1.080
agetime2       1.0310    0.96995 9.172e-01     1.159
sbp            1.0063    0.99371 1.001e+00     1.012
sbptime        1.0019    0.99812 9.723e-01     1.032
sbptime2       0.9961    1.00391 9.664e-01     1.027
strtime       10.4282    0.09589 1.942e-03 55987.778
strtime2       0.2179    4.58847 3.751e-05  1266.270

Concordance= 0.664  (se = 0.012 )
Likelihood ratio test= 229.9  on 20 df,   p=&lt;2e-16
Wald test            = 258  on 20 df,   p=&lt;2e-16
Score (logrank) test = 291.8  on 20 df,   p=&lt;2e-16</code></pre>
</div>
</div>
</div>
<div id="tabset-29-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-29-2-tab">
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-59_025a9af9800bd90402107558e5691e57">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">* Finally, we will fit a land-mark super-model where both the coefficients and the baseline hazards vary smoothly among </span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="co">  land-marks. We choose m = 2 and g_l = f_l as suggested in the book.;</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="co">* We thus add g_1 ('strtime') and  g_2 ('strtime2') to our data frame;</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov573;</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    afib_ = <span class="dv">0</span>; afibtime = <span class="dv">0</span>; afibtime2 = <span class="dv">0</span>;</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    stroke_ = <span class="dv">0</span>; stroketime = <span class="dv">0</span>; stroketime2 = <span class="dv">0</span>;</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>    esvea_ = <span class="dv">0</span>; esveatime = <span class="dv">0</span>; esveatime2 = <span class="dv">0</span>;</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    sex_ = <span class="dv">0</span>; sextime = <span class="dv">0</span>; sextime2 = <span class="dv">0</span>;</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>    age_ = <span class="dv">0</span>; agetime = <span class="dv">0</span>; agetime2 = <span class="dv">0</span>;</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>    sbp_ = <span class="dv">0</span>; sbptime = <span class="dv">0</span>; sbptime2 = <span class="dv">0</span>;</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>    strtime=<span class="dv">0</span>; strtime2=<span class="dv">0</span>;</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a><span class="co">*  We once again fit the model using the 'phreg' procedure (but this time we must exclude the strata statement);</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"5.7.3"</span>;</span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=landmark;</span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timedeath*death(<span class="dv">0</span>)= afib_ afibtime afibtime2</span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>                              stroke_ stroketime stroketime2</span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>                              esvea_ esveatime esveatime2</span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>                              sex_ sextime sextime2</span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>                              age_ agetime agetime2</span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a>                              sbp_ sbptime sbptime2 </span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a>                              strtime strtime2 / entry=entry;</span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a>    afib_ = af; afibtime = af*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; afibtime2 = af*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a>    stroke_ = str; stroketime = str*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; stroketime2 = str*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a>    esvea_ = esvea; esveatime = esvea*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; esveatime2 = esvea*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a>    sex_ =sex; sextime = sex*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; sextime2 = sex*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a>    age_ = age; agetime = age*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; agetime2 = age*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a>    sbp_ = sbp; sbptime = sbp*(landmark - <span class="dv">3</span>)/<span class="dv">6</span>; sbptime2 = sbp*((landmark<span class="dv">-3</span>)/<span class="dv">6</span>)**<span class="dv">2</span>;</span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a>    strtime=(landmark<span class="dv">-3</span>)/<span class="dv">6</span>; strtime2=strtime**<span class="dv">2</span>;</span>
<span id="cb111-34"><a href="#cb111-34" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-5.8" class="level3">
<h3 class="anchored" data-anchor-id="exercise-5.8">Exercise 5.8</h3>
<p><em>Consider a competing risks model for the Copenhagen Holter study with states 0: Alive without AF or stroke, 1: Alive with AF and no stroke, 2: Dead or stroke, see Figures 1.2 and 1.7.</em></p>
<p><em>Fit, using direct binomial regression, a model for being in state 1 at time 3 years including the covariates ESVEA, sex, age, and systolic blood pressure.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-30-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-30-1" role="tab" aria-controls="tabset-30-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-30-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-30-2" role="tab" aria-controls="tabset-30-2" aria-selected="false">SAS-NA</a></li></ul>
<div class="tab-content">
<div id="tabset-30-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-30-1-tab">
<p>We will fit a direct binomial model for the cumulative incidence function of AF at 3 years including covariates ESVEA, sex, age, and systolic blood pressure using the <strong>binreg</strong> function from the <em>mets</em> package.</p>
<p>Based on our original data set we will create a data frame called <strong>data58</strong> where the three observations with missing values of systolic blood pressure are removed and, add a variable called <strong>event</strong> for the competing risks (1 is AF, 2 is stroke or death and 0 is censoring from state 0) and replace the empty cells of <strong>timeaf</strong> with the values from <strong>timestrokeordeath</strong>.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-60_8d7af27cb8cdd94c47434bfa610c9d33">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding the variable 'event' and replacing empty cells of timeafib with timestrokeordeath</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>data58 <span class="ot">&lt;-</span> chs_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(sbp))  <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">event =</span> <span class="fu">ifelse</span>(afib <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span><span class="sc">*</span>strokeordeath),</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>                                                       <span class="at">timeafib =</span> <span class="fu">ifelse</span>(afib <span class="sc">==</span> <span class="dv">1</span>, timeafib, timestrokeordeath))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <strong>binreg</strong> function takes a formula argument where the left side of ~ must be an <strong>Event</strong> object. The argument <strong>cause</strong> specifies the cause of interest (i.e.&nbsp;AF in this case), <strong>time</strong> specifies the time of interest and <strong>cens.code</strong> specifies the value of censoring.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-61_284b644a1403f0c28b8d5504085910c1">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a direct binomial model</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>dirbin58 <span class="ot">&lt;-</span> <span class="fu">binreg</span>(<span class="fu">Event</span>(timeafib, event) <span class="sc">~</span> esvea <span class="sc">+</span> sex <span class="sc">+</span> age <span class="sc">+</span> sbp, </span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> data58, <span class="at">cause =</span> <span class="dv">1</span>, <span class="at">time =</span> <span class="dv">3</span>, <span class="at">cens.code =</span> <span class="dv">0</span>)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(dirbin58)<span class="sc">$</span>coef</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                 Estimate    Std.Err         2.5%        97.5%      P-value
(Intercept) -17.126036977 3.30288773 -23.59957798 -10.65249597 2.158170e-07
esvea         1.923075789 0.88496814   0.18857011   3.65758146 2.977691e-02
sex           1.452354530 1.10364006  -0.71074025   3.61544931 1.881849e-01
age           0.139439962 0.06448804   0.01304572   0.26583420 3.059809e-02
sbp           0.007478889 0.01263125  -0.01727790   0.03223568 5.537875e-01</code></pre>
</div>
</div>
<p>We get the following model</p>
<p><span class="math display">\[-17.126 + 1.9231\cdot Z_1 + 1.4524 \cdot Z_2 + 0.1394 \cdot Z_3 + 0.0075 \cdot Z_4,\]</span></p>
<p>where <span class="math inline">\(Z_1\)</span>, <span class="math inline">\(Z_2\)</span>, <span class="math inline">\(Z_3\)</span>, and <span class="math inline">\(Z_4\)</span> are the ESVEA, sex, age, and systolic blood pressure respectively.</p>
</div>
<div id="tabset-30-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-30-2-tab">
<p>There is currently no implementation of direct binomial regression in SAS.</p>
</div>
</div>
</div>
</section>
<section id="exercise-5.9" class="level3">
<h3 class="anchored" data-anchor-id="exercise-5.9">Exercise 5.9</h3>
<p><em>Consider the Cox model for stroke-free survival in the Copenhagen Holter study including the covariates ESVEA, sex, age, and systolic blood pressure (Exercises 2.4 and 3.7).</em></p>
<section id="section-5" class="level4">
<h4 class="anchored" data-anchor-id="section-5">1.</h4>
<p><em>Investigate, using cumulative Schoenfeld residuals, whether the effects of the covariates may be described as time-constant hazard ratios.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-31-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-31-1" role="tab" aria-controls="tabset-31-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-31-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-31-2" role="tab" aria-controls="tabset-31-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-31-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-31-1-tab">
<p>We will use cumulative Schoenfeld residuals to test whether the assumption of time-constant hazard ratios is reasonable for ESVEA, sex, age, and systolic blood pressure. This is done using the <strong>cox.aalen</strong> function from the <em>timereg</em> package.</p>
<p>To fit a Cox model using the <strong>cox.aalen</strong> function, all covariates must enter in the formula argument wrapped by <strong>prop()</strong>.</p>
<p>The argument <strong>n.sim</strong> specifies the number of paths to be generated from the approximate asymptotic distribution of the goodness-of-fit process.</p>
<p>Furthermore, we specify <strong>residuals = 1</strong> to get the residuals and <strong>weigthed.test = 1</strong> to get a variance weighted version of the process suitable for testing the assumption of a time-constant effects of the covariates.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-62_191dd6dcfb876c791baced8438696536">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model for stroke-free survival including ESVEA, sex, age and systolic blood pressure</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>cox591 <span class="ot">&lt;-</span> <span class="fu">cox.aalen</span>(<span class="fu">Surv</span>(timestrokeordeath, strokeordeath) <span class="sc">~</span> <span class="fu">prop</span>(esvea) <span class="sc">+</span> <span class="fu">prop</span>(sex) <span class="sc">+</span> <span class="fu">prop</span>(age) <span class="sc">+</span> <span class="fu">prop</span>(sbp),</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> chs_data, <span class="at">n.sim =</span> <span class="dv">1000</span>, <span class="at">residuals =</span> <span class="dv">1</span>, <span class="at">weighted.test =</span> <span class="dv">1</span>)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox591)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Cox-Aalen Model 

Test for Aalen terms 
Test not computed, sim=0 

Proportional Cox terms :  
              Coef.      SE Robust SE D2log(L)^-1    z    P-val lower2.5%
prop(esvea) 0.31800 0.15200   0.16200     0.15300 1.97 4.91e-02  0.020100
prop(sex)   0.57700 0.12400   0.12700     0.12700 4.54 5.72e-06  0.334000
prop(age)   0.07670 0.00898   0.00950     0.00936 8.07 6.66e-16  0.059100
prop(sbp)   0.00515 0.00231   0.00251     0.00244 2.05 4.00e-02  0.000622
            upper97.5%
prop(esvea)    0.61600
prop(sex)      0.82000
prop(age)      0.09430
prop(sbp)      0.00968
Test of Proportionality 
            sup|  hat U(t) | p-value H_0 
prop(esvea)             3.02        0.046
prop(sex)               1.51        0.850
prop(age)               2.99        0.079
prop(sbp)               1.82        0.606</code></pre>
</div>
</div>
<p>From the summary we note that the <span class="math inline">\(p\)</span>-values are quite small and borderline significant for ESVEA and age while the <span class="math inline">\(p\)</span>-values for sex and systolic blood pressure are far from significance.</p>
<p>However, we will also make a visual examination of whether the assumption of time-constant hazard ratios seems reasonable. This is done by plotting the observed cumulative Schoenfeld residuals together with 50 paths generated from the approximate asymptotic distribution against time.</p>
<p>The 50 random paths generated from the approximated asymptotic distribution are stored as the argument <strong>sim.test.procProp</strong> while the observed cumulative Schoenfeld residuals are stored as <strong>test.procProp</strong>.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-63_3ee0d8a4f897523351ece61688ed45ad">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 50 random realizations of the goodness-of-fit process</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>sim591 <span class="ot">&lt;-</span> cox591<span class="sc">$</span>sim.test.procProp</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>obs591 <span class="ot">&lt;-</span> cox591<span class="sc">$</span>test.procProp</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Time vector</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>time591 <span class="ot">&lt;-</span> obs591[,<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The values for ESVEA are stored in the second column of the <strong>obs591</strong> object and first column in each of the lists in the <strong>sim591</strong> object.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-64_3f873a12b639b35873852286e4320e49">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals (observed)</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>obs_esvea591 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time591, </span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">res =</span> obs591[,<span class="dv">2</span>])</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals (simulated)</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>sim_esvea591 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">res =</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, sim591)[,<span class="dv">1</span>],</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">time =</span> <span class="fu">rep</span>(time591, <span class="at">times =</span> <span class="dv">50</span>), </span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">each =</span> <span class="fu">length</span>(time591)))</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals plotted against time</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>(fig591_esvea <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res), <span class="at">data =</span> obs_esvea591) <span class="sc">+</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res, <span class="at">group =</span> sim), </span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> sim_esvea591) <span class="sc">+</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="st">"Time"</span>))<span class="sc">+</span></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Standardized score process"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>The effect of ESVEA does not seem to be time-constant, since the curve does not vary randomly around 0. This was also supported by the low <span class="math inline">\(p\)</span>-value from the summary.</p>
<p>We repeat the procedure for sex. The values for sex are stored in the third column of the <strong>obs591</strong> object and second column in each of the lists in the <strong>sim591</strong> object.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-65_4ea17cffc12fda1f71d36e83897c5b60">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals (observed)</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>obs_sex591 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time591, </span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">res =</span> obs591[,<span class="dv">3</span>])</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals (simulated)</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>sim_sex591 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">res =</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, sim591)[,<span class="dv">2</span>],</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">time =</span> <span class="fu">rep</span>(time591, <span class="at">times =</span> <span class="dv">50</span>), </span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">each =</span> <span class="fu">length</span>(time591)))</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals plotted against time</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>(fig591_sex <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res), <span class="at">data =</span> obs_sex591) <span class="sc">+</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res, <span class="at">group =</span> sim), </span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> sim_sex591) <span class="sc">+</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="st">"Time"</span>))<span class="sc">+</span></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Standardized score process"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>The assumption of a time-constant hazard ratio of sex seems to be reasonable since the Schoenfeld residuals vary randomly around 0. This was also supported by the high <span class="math inline">\(p\)</span>-value found in the summary.</p>
<p>We repeat the procedure for age. The values for age are stored in the fourth column of the <strong>obs591</strong> object and third column in each of the lists in the <strong>sim591</strong> object.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-66_d018c3e87de382ce2fef87e3b795aed0">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals (observed)</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>obs_age591 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time591, </span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">res =</span> obs591[,<span class="dv">4</span>])</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals (simulated)</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>sim_age591 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">res =</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, sim591)[,<span class="dv">3</span>],</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">time =</span> <span class="fu">rep</span>(time591, <span class="at">times =</span> <span class="dv">50</span>), </span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">each =</span> <span class="fu">length</span>(time591)))</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals plotted against time</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>(fig591_age <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res), <span class="at">data =</span> obs_age591) <span class="sc">+</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res, <span class="at">group =</span> sim), </span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> sim_age591) <span class="sc">+</span></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="st">"Time"</span>))<span class="sc">+</span></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Standardized score process"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>The assumption of a time-constant hazard ratio of age may seem to be violated since the curve of the Schoenfeld residuals does not vary randomly around 0. The <span class="math inline">\(p\)</span>-value from the summary is quite low as well.</p>
<p>Finally, we repeat the procedure for systolic blood pressure. The values for systolic blood pressure are stored in the fifth column of the <strong>obs591</strong> object and fourth column in each of the lists in the <strong>sim591</strong> object.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-67_d78cef012fd48941fc0b786516c237d4">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals (observed)</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>obs_sbp591 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> time591, </span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">res =</span> obs591[,<span class="dv">5</span>])</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals (simulated)</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>sim_sbp591 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">res =</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, sim591)[,<span class="dv">4</span>],</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">time =</span> <span class="fu">rep</span>(time591, <span class="at">times =</span> <span class="dv">50</span>), </span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">each =</span> <span class="fu">length</span>(time591)))</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative Schoenfeld residuals plotted against time</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>(fig591_sbp <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res), <span class="at">data =</span> obs_sbp591) <span class="sc">+</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> res, <span class="at">group =</span> sim), </span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> sim_sbp591) <span class="sc">+</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="st">"Time"</span>))<span class="sc">+</span></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Standardized score process"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>T he assumption of a time-constant hazard ratio of systolic blood pressure does seem reasonable, since the curve varies randomly around 0. This conclusion is also supported by the <span class="math inline">\(p\)</span>-value found in the summary.</p>
</div>
<div id="tabset-31-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-31-2-tab">
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-68_590bce8fa8091a76a823ae08c6e74dba">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co">* We will use cumulative Schoenfeld residuals to test whether the assumption of time-constant hazard ratios of ESVEA, sex, age, and systolic blood pressure is reasonable. This can be done by adding the 'assess' statement followed by 'ph'. </span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="co">Furthermore, '\ resample' is added to generate 1000 paths from the approximate asymptotic distribution which is used to calculate a goodness-of-fit test.;</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="co">* For the assumption of time-constant hazard ratio to hold we expect the observed Schoenfeld residuals to vary randomely around 0 </span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a><span class="co">  and that the p-value is non-significant.;</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"5.9.1"</span>;</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=chs_<span class="kw">data</span>;</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>   <span class="kw">model</span> timestrokeordeath*strokeordeath(<span class="dv">0</span>)=esvea sex age sbp;</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>   assess ph / resample;</span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a><span class="co">* The assumption of time-constant hazard ratios of ESVEA and age may not be reasonable since the p-values are borderline significant</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a><span class="co">  and the observed Schoenfeld residuals do not seem to vary randomly around 0.</span></span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a><span class="co">* In contrast, the effect of sex and systolic blood pressure does seem to fulfill the assumption of time-constant hazard ratios, since the curves of the observed Schoenfeld residuals vary randomely around 0 and the p-values are far from significant.;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="section-6" class="level4">
<h4 class="anchored" data-anchor-id="section-6">2.</h4>
<p><em>Investigate, using cumulative martingale residuals, whether the effects of age and systolic blood pressure can be considered linear on the log(hazard) scale.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-32-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-32-1" role="tab" aria-controls="tabset-32-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-32-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-32-2" role="tab" aria-controls="tabset-32-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-32-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-32-1-tab">
<p>To test whether the assumption of linearity (on the log(hazard) scale) is reasonable for the effect of age and systolic blood pressure we will consider the cumulative martingale residuals.</p>
<p>This is done using the <strong>cox.aalen</strong> and <strong>cum.residuals</strong> functions from the <em>timereg</em> pacakge.</p>
<p>Once again, the covariates should be wrapped by <strong>prop()</strong> to obtain a Cox model and the argument <strong>residuals = 1</strong> must be specified in the <strong>cox.aalen</strong> function to get the residuals.</p>
<p>Then, to get the cumulative martingale residuals the output from the model fitted with <strong>cox.aalen</strong> is given to the <strong>cum.residuals</strong> function. The argument <strong>n.sim</strong> specifies the number of paths to be generated from the approximate asymptotic distribution of the goodness-of-fit process and the argument <strong>cum.resid = 1</strong> specifies that we want residuals for each of the continuous covariates.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-69_0d1ae8decb7cd01fddfd3ce9cae4a7a6">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>cox592 <span class="ot">&lt;-</span> <span class="fu">cox.aalen</span>(<span class="fu">Surv</span>(timestrokeordeath, strokeordeath) <span class="sc">~</span> <span class="fu">prop</span>(esvea) <span class="sc">+</span> <span class="fu">prop</span>(sex) <span class="sc">+</span> <span class="fu">prop</span>(age) <span class="sc">+</span> <span class="fu">prop</span>(sbp),</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> chs_data, <span class="at">residuals =</span> <span class="dv">1</span>)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>res592 <span class="ot">&lt;-</span> <span class="fu">cum.residuals</span>(cox592, chs_data, <span class="at">cum.resid=</span><span class="dv">1</span>, <span class="at">n.sim =</span> <span class="dv">1000</span>)</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(res592)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Test for cumulative MG-residuals 

Grouped cumulative residuals not computed, you must provide
modelmatrix to get these (see help) 

Residual versus covariates consistent with model 

          sup|  hat B(t) | p-value H_0: B(t)=0
prop(age)            8.186               0.196
prop(sbp)            6.671               0.789</code></pre>
</div>
</div>
<p>The <span class="math inline">\(p\)</span>-values given in the summary do not indicate violation of the assumption of linearity of age and systolic blood pressure on the log(hazard) scale.</p>
<p>However, we will also check this assumption by plotting the cumulative martingale residuals together with 50 realizations generated from the approximated asymptotic distribution of the goodness-of-fit process against <span class="math inline">\(z\)</span>, where <span class="math inline">\(z\)</span> is either age or systolic blood pressure.</p>
<p>The observed cumulative martingale residuals versus all continuous covariates of the model are stored as <strong>proc.cumz</strong>, while 50 random realizations of the goodness-of-fit process for all continuous covariates are stored as <strong>sim.test.proccumz</strong>.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-70_41b652ad3859b0da9b909cc761449ae9">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 50 random realizations of the goodness-of-fit process</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>sim592 <span class="ot">&lt;-</span> res592<span class="sc">$</span>sim.test.proccumz</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative martingale residuals</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>obs592 <span class="ot">&lt;-</span>  res592<span class="sc">$</span>proc.cumz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The values for age are stored in the first list of the <strong>obs592</strong> and <strong>sim592</strong> objects.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-71_995ce42a9cdea1f3aecc89955d4a28d8">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>obs_age592 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">age =</span> obs592[[<span class="dv">1</span>]][,<span class="dv">1</span>],</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>                          <span class="at">res =</span> obs592[[<span class="dv">1</span>]][,<span class="dv">2</span>])</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>sim_age592 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">age =</span> <span class="fu">rep</span>((obs592[[<span class="dv">1</span>]][,<span class="dv">1</span>]), <span class="at">times =</span> <span class="dv">50</span>),</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">res =</span> <span class="fu">c</span>(sim592[[<span class="dv">1</span>]]),</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">each =</span> <span class="fu">length</span>((obs592[[<span class="dv">1</span>]][,<span class="dv">1</span>]))))</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>(fig592_age <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> res), <span class="at">data =</span> obs_age592) <span class="sc">+</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> res, <span class="at">group =</span> sim), <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> sim_age592) <span class="sc">+</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="st">"Age"</span>))<span class="sc">+</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative martingale residuals"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/unnamed-chunk-71-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>The assumption of linearity of the effect of age seems reasonable since the curve does seem to vary randomly around 0 which was also indicated by the <span class="math inline">\(p\)</span>-value.</p>
<p>We repeat the procedure for systolic blood pressure. The values for systolic blood pressure are stored in the second list of the <strong>obs592</strong> and <strong>sim592</strong> objects.</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-72_e821d8a8111c038f1d83741354fdd48e">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>obs_sbp592 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sbp =</span> obs592[[<span class="dv">2</span>]][,<span class="dv">1</span>],</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">res =</span> obs592[[<span class="dv">2</span>]][,<span class="dv">2</span>])</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>sim_sbp592 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sbp =</span> <span class="fu">rep</span>(obs592[[<span class="dv">2</span>]][,<span class="dv">1</span>], <span class="at">times =</span> <span class="dv">50</span>),</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">res =</span> <span class="fu">c</span>(sim592[[<span class="dv">2</span>]]),</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">sim =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">each =</span> <span class="fu">length</span>(obs592[[<span class="dv">2</span>]][,<span class="dv">1</span>])))</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>(fig592_sbp <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sbp, <span class="at">y =</span> res), <span class="at">data =</span> obs_sbp592) <span class="sc">+</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> sbp, <span class="at">y =</span> res, <span class="at">group =</span> sim), <span class="at">color =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.8</span>, <span class="at">data =</span> sim_sbp592) <span class="sc">+</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="st">"Systolic blood pressure"</span>))<span class="sc">+</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative martingale residuals"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch5_files/figure-html/unnamed-chunk-72-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>The assumption of linearity of the effect of systolic blood pressure seems reasonable, since the curve varies randomly around 0. This aligns with the conclusion based on the <span class="math inline">\(p\)</span>-value.</p>
</div>
<div id="tabset-32-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-32-2-tab">
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-73_d66d73cfc0c799d0822ed24e82df5e1f">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co">* To test whether the assumption of linearity (on the log(hazard) scale) is reasonable for the effect of age and systolic blood pressure we will consider the cumulative martingale residuals.;</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="co">* This can be done by adding the 'assess' statement to the 'phreg' procedure followed by the argument 'var' which specifies the  covariates of interest. '\ resample' is added to generate 1000 paths from the approximate asymptotic distribution which is used to calculate a goodness-of-fit test.;</span>  </span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="co">* Once again, we expect non-significant p-values and curves that vary randomly around 0 for the assumption of linearity to hold.;</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"5.9.2"</span>;</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=chs_<span class="kw">data</span>;</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>   <span class="kw">model</span> timestrokeordeath*strokeordeath(<span class="dv">0</span>)=esvea sex age sbp;</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>   assess <span class="fu">var</span>=(age sbp) /  resample;</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a><span class="co">* The assumption of lineraty seems to hold for both age and systolic blood pressure based on the result of both the goodness-of-fit test as well as the graphical assessment.;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-5.10" class="level3">
<h3 class="anchored" data-anchor-id="exercise-5.10">Exercise 5.10</h3>
<p><em>Consider the data on recurrent episodes in affective disorder, Example 1.1.5. Fit a Mao-Lin regression model (5.31) for the mean of the composite end-point recurrent episode or death, including initial diagnosis as the only covariate and using severity weights equal to 1.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-33-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-33-1" role="tab" aria-controls="tabset-33-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-33-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-33-2" role="tab" aria-controls="tabset-33-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-33-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-33-1-tab">
<p>Load the relevant packages</p>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-74_c7770e18640c1248f35ae5d490cdd635">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co">#Data manipulations and plots</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival) <span class="co">#Core survival analysis routines</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-75_13ea6ffc70e0043641f6d7be36abe355">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>affective_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/affective.csv"</span>)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating data corresponding to set up depicted in Figure 1.5</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>aff <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(affective_data <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(<span class="at">prev1 =</span> <span class="fu">lag</span>(start, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),  <span class="co"># moves start one line down</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prev2 =</span> <span class="fu">lag</span>(stop, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),   <span class="co"># moves stop one line down</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prev =</span> <span class="fu">ifelse</span>(state <span class="sc">==</span> <span class="dv">1</span>, prev2, prev1)) <span class="sc">%&gt;%</span> <span class="co"># picks the displaced value of stop if hospitalized, otherwise the displaced value of start.</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">filter</span>(state <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)))</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>fitML <span class="ot">&lt;-</span> <span class="fu">recreg</span>(<span class="fu">Event</span>(prev, stop, status) <span class="sc">~</span> <span class="fu">factor</span>(bip) <span class="sc">+</span> <span class="fu">cluster</span>(id),</span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> aff, <span class="at">cause =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">cens.code =</span> <span class="dv">3</span>, <span class="at">death.code =</span> <span class="dv">2</span>)</span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fitML)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 661    620

 119 clusters
coeffients:
              Estimate      S.E.   dU^-1/2 P-value
factor(bip)0 -0.559957  0.173508  0.090043  0.0012

exp(coeffients):
             Estimate    2.5%  97.5%
factor(bip)0  0.57123 0.40656 0.8026</code></pre>
</div>
</div>
</div>
<div id="tabset-33-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-33-2-tab">
<div class="cell" data-hash="Ch5_cache/html/unnamed-chunk-76_ef6427ba5988333267ea6a590996f899">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> import out=affective_<span class="kw">data</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>    datafile=<span class="st">'data/affective.csv'</span> </span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    dbms=csv <span class="kw">replace</span>;</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    getnames=yes;</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a><span class="co">* We make a data set correpsonding to the setting with cycles depicted in figure 1.5, i.e. the interval in hospital is included in the time between events.;</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'5.10'</span>;</span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> data510; </span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> affective_<span class="kw">data</span>;</span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> id;</span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> prev;</span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> first.id <span class="kw">then</span> prev=<span class="dv">0</span>; </span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output</span>; </span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> state=<span class="dv">1</span> <span class="kw">then</span> prev=start; <span class="kw">if</span> state=<span class="dv">0</span> <span class="kw">then</span> prev=<span class="kw">stop</span>;</span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> data510;</span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> data510;</span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> state = <span class="dv">0</span> <span class="kw">or</span> status = <span class="dv">2</span> <span class="kw">or</span> status = <span class="dv">3</span>;</span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a><span class="co">* Thus the entry and exit time are now 'prev' and 'stop';</span></span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-24"><a href="#cb132-24" aria-hidden="true" tabindex="-1"></a><span class="co">* Death are defined as part of composite and add an extra record with (prev,stop) length 0.5 for</span></span>
<span id="cb132-25"><a href="#cb132-25" aria-hidden="true" tabindex="-1"></a><span class="co">  death events as to be able to trick phreq to estimate Mao-Lin model:</span></span>
<span id="cb132-26"><a href="#cb132-26" aria-hidden="true" tabindex="-1"></a><span class="co">  episodes and deaths count as events and death also as competing risk;</span></span>
<span id="cb132-27"><a href="#cb132-27" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> angstML;</span>
<span id="cb132-28"><a href="#cb132-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> data510;</span>
<span id="cb132-29"><a href="#cb132-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> status ne <span class="dv">2</span> <span class="kw">then</span> <span class="kw">output</span>;</span>
<span id="cb132-30"><a href="#cb132-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> status = <span class="dv">2</span> <span class="kw">then do</span>;</span>
<span id="cb132-31"><a href="#cb132-31" aria-hidden="true" tabindex="-1"></a>        status=<span class="dv">1</span>; <span class="kw">output</span>; </span>
<span id="cb132-32"><a href="#cb132-32" aria-hidden="true" tabindex="-1"></a>        prev=<span class="kw">stop</span>; <span class="kw">stop</span>=<span class="kw">stop</span><span class="dv">+0.5</span>; status=<span class="dv">2</span>; <span class="kw">output</span>;</span>
<span id="cb132-33"><a href="#cb132-33" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>; </span>
<span id="cb132-34"><a href="#cb132-34" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb132-35"><a href="#cb132-35" aria-hidden="true" tabindex="-1"></a><span class="co">* Mao-Lin model;</span></span>
<span id="cb132-36"><a href="#cb132-36" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=angstML;</span>
<span id="cb132-37"><a href="#cb132-37" aria-hidden="true" tabindex="-1"></a>    class bip(ref=<span class="st">'0'</span>);</span>
<span id="cb132-38"><a href="#cb132-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">0</span>)= bip / entry=prev eventcode=<span class="dv">1</span> rl;</span>
<span id="cb132-39"><a href="#cb132-39" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Ch4.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Intuition for marginal models</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Ch6.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Pseudo-values</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Models for Multi-State Survival Data: Rates, Risks, and Pseudo-Values</div>   
    <div class="nav-footer-right">Built with <a href="https://quarto.org/">Quarto</a> and <a href="https://posit.co/products/open-source/rstudio/">RStudio</a></div>
  </div>
</footer>



</body></html>