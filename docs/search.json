[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Models for Multi-State Survival Data: Rates, Risks, and Pseudo-Values",
    "section": "",
    "text": "This is the code companion website to our book published by Chapman & Hall.\nR code for the analyses and plots presented in the book is given. SAS code is available for the analyses only. Solutions to the exercises in the book are available at the end of each chapter.\nThis code and output was created using R version 4.3.1 and SAS/Stat version 15.1."
  },
  {
    "objectID": "index.html#acknowledgements",
    "href": "index.html#acknowledgements",
    "title": "Models for Multi-State Survival Data: Rates, Risks, and Pseudo-Values",
    "section": "Acknowledgements",
    "text": "Acknowledgements\nThanks to Julie K. Furberg who created figures and validated analyses quoted in the book. Thanks to Eva N.S. Wandall who created solutions to practical exercises and contributed to some of the examples."
  },
  {
    "objectID": "Ch1.html#pbc3-trial-in-liver-cirrhosis-pbc3.csv",
    "href": "Ch1.html#pbc3-trial-in-liver-cirrhosis-pbc3.csv",
    "title": "1  Introduction and data sets",
    "section": "1.1 PBC3 trial in liver cirrhosis (pbc3.csv)",
    "text": "1.1 PBC3 trial in liver cirrhosis (pbc3.csv)\n\n\n\n\n\n\n\nVariable name\nDescription\n\n\n\n\nid\npatient id\n\n\nunit\nhospital\n\n\ndays\nfollow-up time in days\n\n\nstatus\n0 = censoring, 1 = transplantation, 2 = death without transplantation\n\n\ntment\n0 = placebo, 1 = CyA\n\n\nsex\n0 = female, 1 = male\n\n\nage\nage (years)\n\n\nbili\nbilirubin (micromoles/L)\n\n\nalb\nalbumin (g/L)\n\n\nstage\ndisease stage: 2 = I-II, 3 = III, 4 = IV"
  },
  {
    "objectID": "Ch1.html#guinea-bissau-childhood-vaccination-study-bissau.csv",
    "href": "Ch1.html#guinea-bissau-childhood-vaccination-study-bissau.csv",
    "title": "1  Introduction and data sets",
    "section": "1.2 Guinea-Bissau childhood vaccination study (bissau.csv)",
    "text": "1.2 Guinea-Bissau childhood vaccination study (bissau.csv)\n\n\n\n\n\n\n\nVariable name\nDescription\n\n\n\n\nid\nchild id\n\n\ncluster\ncluster id\n\n\nfuptime\nfollow-up time (days)\n\n\ndead\n0 = alive, 1 = dead\n\n\nbcg\nbcg vaccination status at initial visit: 1 = yes, 2 = no\n\n\ndtp\ndtp vaccination status at initial visit: 1 = yes, 2 = no\n\n\nsex\n0 = female, 1 = male\n\n\nage\nage in days at initial visit"
  },
  {
    "objectID": "Ch1.html#testis-cancer-incidence-and-maternal-parity-testis.csv",
    "href": "Ch1.html#testis-cancer-incidence-and-maternal-parity-testis.csv",
    "title": "1  Introduction and data sets",
    "section": "1.3 Testis cancer incidence and maternal parity (testis.csv)",
    "text": "1.3 Testis cancer incidence and maternal parity (testis.csv)\n\n\n\nVariable name\nDescription\n\n\n\n\nage\n\n\n\npyrs\n\n\n\ncases\n\n\n\nsemi\n\n\n\nnonsemi\n\n\n\nparity\n\n\n\ncohort\n\n\n\nmotherage"
  },
  {
    "objectID": "Ch1.html#prova-trial-in-liver-cirrhosis-prova.csv",
    "href": "Ch1.html#prova-trial-in-liver-cirrhosis-prova.csv",
    "title": "1  Introduction and data sets",
    "section": "1.4 PROVA trial in liver cirrhosis (prova.csv)",
    "text": "1.4 PROVA trial in liver cirrhosis (prova.csv)\n\n\n\nVariable name\nDescription\n\n\n\n\nid\npatient id\n\n\ntimedeath\n\n\n\ndeath\n\n\n\ntimebleed\n\n\n\nbleed\n\n\n\nbeta\n\n\n\nscle\n\n\n\nsex\n0 = female, 1 = male\n\n\nage\n\n\n\nbili\n\n\n\ncoag\n\n\n\nvarsize"
  },
  {
    "objectID": "Ch1.html#recurrent-episodes-in-affective-disorders-affective.csv",
    "href": "Ch1.html#recurrent-episodes-in-affective-disorders-affective.csv",
    "title": "1  Introduction and data sets",
    "section": "1.5 Recurrent episodes in affective disorders (affective.csv)",
    "text": "1.5 Recurrent episodes in affective disorders (affective.csv)\n\n\n\nVariable name\nDescription\n\n\n\n\nid\npatient id\n\n\nepisode\n\n\n\nstate\n\n\n\nstart\n\n\n\nstop\n\n\n\nstatus\n\n\n\nbip\n\n\n\nsex\n0 = female, 1 = male\n\n\nage\n\n\n\nyear\n\n\n\nwait"
  },
  {
    "objectID": "Ch1.html#leader-cardiovascular-trial-in-type-2-diabetes",
    "href": "Ch1.html#leader-cardiovascular-trial-in-type-2-diabetes",
    "title": "1  Introduction and data sets",
    "section": "1.6 LEADER cardiovascular trial in type 2 Diabetes",
    "text": "1.6 LEADER cardiovascular trial in type 2 Diabetes\nData not available."
  },
  {
    "objectID": "Ch1.html#bone-marrow-transplantation-in-acute-leukemia-bmt.csv",
    "href": "Ch1.html#bone-marrow-transplantation-in-acute-leukemia-bmt.csv",
    "title": "1  Introduction and data sets",
    "section": "1.7 Bone marrow transplantation in acute leukemia (bmt.csv)",
    "text": "1.7 Bone marrow transplantation in acute leukemia (bmt.csv)\n\n\n\nVariable name\nDescription\n\n\n\n\nid\npatient id\n\n\nteam\n\n\n\ntimedeath\n\n\n\ndeath\n\n\n\ntimerel\n\n\n\nrel\n\n\n\ntimegvhd\n\n\n\ngvhd\n\n\n\ntimeanc500\n\n\n\nanc500\n\n\n\nsex\n0 = female, 1 = male\n\n\nage\n\n\n\nall\n\n\n\nbmonly"
  },
  {
    "objectID": "Ch1.html#the-copenhagen-holter-study-cphholter.csv",
    "href": "Ch1.html#the-copenhagen-holter-study-cphholter.csv",
    "title": "1  Introduction and data sets",
    "section": "1.8 The Copenhagen Holter study (cphholter.csv)",
    "text": "1.8 The Copenhagen Holter study (cphholter.csv)\n\n\n\nVariable name\nDescription\n\n\n\n\nid\npatient id\n\n\ntimedeath\n\n\n\ndeath\n\n\n\ntimeafib\n\n\n\nafib\n\n\n\ntimestroke\n\n\n\nstroke\n\n\n\nsex\n0 = female, 1 = male\n\n\nage\n\n\n\nsmkoer\n\n\n\nesvea\n\n\n\nchol\n\n\n\ndiabet\n\n\n\nbmi\n\n\n\naspirin\n\n\n\nprobnp\n\n\n\nsbp"
  },
  {
    "objectID": "Ch1.html#small-set-of-survival-data",
    "href": "Ch1.html#small-set-of-survival-data",
    "title": "1  Introduction and data sets",
    "section": "1.9 Small set of survival data",
    "text": "1.9 Small set of survival data\n\nCreate data\n\ntimes <- c(5,6,7,8,9,12,13,15,16,20,22,23)\nage <- c(12,0,0,10,6,6,9,3,8,0,0,2)\nevent <- c(1,0,1,1,0,0,1,1,1,0,0,1)\nid <- 1:12\nexitage <- age + times\nsimpledata <- as.data.frame(cbind(id, times, event, age, exitage))\n\n\n\nFigure 1.8\n\n#------------------------------------------------------------------#\n# General plotting styles \n#------------------------------------------------------------------#\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"none\",\n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\ntheme_general_x <- theme_bw() +\n  theme(legend.position = \"none\",\n        text = element_text(size = 26), \n        axis.text.x = element_text(size = 26), \n        axis.text.y = element_text(size = 26)) \n\n# Create Figure 1.8, part (a)\nfig1.8a <- ggplot(aes(x = times, y = id), data = simpledata) +\n  geom_segment(aes(x = 0, y = id, xend = times - 0.25, yend = id), size = 1) +\n  geom_point(aes(x = times, y = id), data = subset(simpledata,event==0),\n             shape = 21, size = 6, color='black', fill='white') +\n  geom_point(aes(x = times, y = id), data = subset(simpledata,event==1),\n             shape = 16, size = 6) +\n  xlab(\"Time (t)\") +\n  ylab(\"Subject number\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 25)) +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0.5, 12), breaks = seq(1, 12, 1)) +\n  theme_general_x +\n  theme(panel.grid.major.y = element_blank(),\n        panel.grid.minor.y = element_blank())\n\n# Create Figure 1.8, part (b)\nfig1.8b <- ggplot(aes(x = exitage, y = id), data = simpledata) +\n  geom_segment(aes(x = age, y = id, xend = exitage - 0.25, yend = id), size = 1) +\n  geom_point(aes(x = exitage, y = id), data = subset(simpledata,event==0),\n             shape = 21, size = 6, color='black', fill='white') +\n  geom_point(aes(x = exitage, y = id), data = subset(simpledata,event==1),\n             shape = 16, size = 6) +\n  xlab(\"Age\") +\n  ylab(\"Subject number\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 25)) +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0.5, 12), breaks = seq(1, 12, 1)) +\n  theme_general_x + \n  theme(legend.position = \"none\",\n        panel.grid.major.y = element_blank(),\n        panel.grid.minor.y = element_blank())\n\nfig1.8a\n\n\n\nfig1.8b\n\n\n\n\n\n\nFigure 1.9\n\n#------------------------------------------------------------------#\n# Figure 1.9 \n#------------------------------------------------------------------#\nlibrary(survival)\n# Kaplan-Meier time as time variable\nkmfit <- survfit(Surv(times, event) ~ 1)\nsimpledata_km <- data.frame(surv = c(1, kmfit$surv), \n                            time = c(0, kmfit$time))\n\n# Create Figure 1.9, part (a)\nfig1.9a <- ggplot(aes(x = time, y = surv), data = simpledata_km) +\n  geom_step(size = 1) +\n  xlab(\"Time (t)\") +\n  ylab(\"Estimate of S(t)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 25)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 1), breaks = seq(0, 1, 0.1)) +\n  theme_general_x\n\n# Kaplan-Meier age as time variable\nkmfit2 <- survfit(Surv(age, exitage, event) ~ 1)\nsimpledata_km_age <- data.frame(surv = c(1, kmfit2$surv), \n                                time = c(0, kmfit2$time))\n\n# Create Figure 1.9, part (b)\nfig1.9b <- ggplot(aes(x = time, y = surv), data = simpledata_km_age) +\n  geom_step(size = 1) +\n  xlab(\"Age\") +\n  ylab(\"Estimate of S(age)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 25)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 1), breaks = seq(0, 1, 0.1)) +\n  theme_general_x\n\nfig1.9a\n\n\n\nfig1.9b\n\n\n\n\n\n\nFigure 1.10\n\n#------------------------------------------------------------------#\n# Figure 1.10 \n#------------------------------------------------------------------#\n\n# Kaplan-Meier time as time variable\nkmfit <- survfit(Surv(times, event) ~ 1)\nsimpledata_km <- data.frame(surv = c(1, kmfit$surv), \n                            time = c(0, kmfit$time))\nsubdata<-simpledata_km[simpledata_km$time<=12,]\n\n# Create Figure 1.10\nlibrary(dplyr)\nfig1.10 <- ggplot(mapping=aes(x = time, y = surv), data = simpledata_km) +\n  geom_rect(data=subdata,\n            aes(xmin = time, xmax = lead(time),\n                ymin = 0, ymax = surv),\n            linetype=0,fill=\"grey\")+\n  geom_segment(aes(x = 12, y = -Inf, xend = 12, yend = 0.733),\n               size=1,linetype=\"dashed\")+\n  geom_step(size = 1) +\n  xlab(\"Time (t)\") +\n  ylab(\"Estimate of S(t)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 25)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 1), breaks = seq(0, 1, 0.1)) +\n  theme_general +\n  annotate(geom=\"text\",x=6, y=0.45,\n           label=expression(epsilon[0](12)),size=8)\nfig1.10\n\n\n\n\n\n\nFigure 1.13\n\n#------------------------------------------------------------------#\n# Figure 1.13 \n#------------------------------------------------------------------#\n\n# N(t)\nsfit <- survfit(Surv(times, event) ~ 1)\np1 <- data.frame(time = c(0, sfit$time, 26), \n                 n = c(0, cumsum(sfit$n.event), tail(cumsum(sfit$n.event),1)))\np2 <- data.frame(time = sfit$time[sfit$n.event==1], \n                 n = cumsum(sfit$n.event)[sfit$n.event==1]-1)\np3 <- data.frame(time = sfit$time[sfit$n.event==1], \n                 n = cumsum(sfit$n.event)[sfit$n.event==1])\n\n# Create Figure 1.13, part (a)\nfig1.13a <- ggplot(aes(x = time, y = n), data = p1) +\n  geom_step(size = 1) + \n  geom_point(aes(x = time, y = n), data = p2, shape = 21, size = 6, \n             color='black', fill='white') +\n  geom_point(aes(x = time, y = n), data = p3, shape = 16, size = 6) +\n  xlab(\"Time (t)\") +\n  ylab(\"N(t)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.005)), \n                     limits = c(0, 26)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 12), breaks = seq(0, 12, 1)) +\n  theme_general_x\n\n# Y(t)\nsfit <- survfit(Surv(times, event) ~ 1)\np1 <- data.frame(time = c(0, sfit$time, 26), \n                 risk = c(sfit$n.risk, 0, 0))\np2 <- data.frame(time = sfit$time, \n                 risk = sfit$n.risk - 1)\np3 <- data.frame(time = sfit$time, \n                 risk = sfit$n.risk)\n\n# Create Figure 1.13, part (b)\nfig1.13b <- ggplot(aes(x = time, y = risk), data = p1) +\n  geom_step(size = 1) + \n  geom_point(aes(x = time, y = risk), data = p2, shape = 21, size = 6, \n             color='black', fill='white') +\n  geom_point(aes(x = time, y = risk), data = p3, shape = 16, size = 6) +\n  xlab(\"Time (t)\") +\n  ylab(\"Y(t)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.005)), \n                     limits = c(0, 26)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 12), breaks = seq(0, 12, 1)) +\n  theme_general_x\n\n\n# N(age)\nasfit <- survfit(Surv(age, exitage, event) ~ 1)\np1 <- data.frame(time = c(0, asfit$time, 26), \n                 n = c(0, cumsum(asfit$n.event),tail(cumsum(asfit$n.event), 1)))\np2 <- data.frame(time = asfit$time[asfit$n.event > 0], \n                 n = cumsum(asfit$n.event)[asfit$n.event > 0])\np3 <- data.frame(time = asfit$time[asfit$n.event > 0], \n                 n = c(0, 1, 2, 4, 5, 6))\n\n# Create Figure 1.13, part (c)\nfig1.13c <- ggplot(aes(x = time, y = n), data = p1) +\n  geom_step(size = 1) + \n  geom_point(aes(x = time, y = n), data = p2, shape = 16, size = 6) +\n  geom_point(aes(x = time, y = n), data = p3, shape = 21, size = 6, \n             color='black', fill='white') +\n  xlab(\"Age\") +\n  ylab(\"N(age)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.005)), \n                     limits = c(0, 26)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 12), breaks = seq(0, 12, 1)) +\n  theme_general_x \n\n# Y(age)\natriskage <- vector(length=25)\nfor(i in 1:25){\n  atriskage[i] <- sum((age<=i & exitage>i))\n}\n\np1 <- data.frame(time = 0:26, \n                 risk = c(atriskage[1], atriskage, 0))\np2 <- data.frame(time = c(2,3,6,7,8,9,10,12,15,17,18,20,22,24,25), \n                 risk = c(5,6,7,6,7,8, 9,10, 9, 8, 5, 4, 2, 1,0))\np3 <- data.frame(time = c(2,3,6,7,8,9,10,12,15,17,18,20,22,24,25), \n                 risk = c(4,5,6,7,6,7, 8,9, 10, 9, 8, 5, 4, 2,1))\n\n# Create Figure 1.13, part (d)\nfig1.13d <- ggplot(aes(x = time, y = risk), data = p1) +\n  geom_step(size = 1) + \n  geom_point(aes(x = time, y = risk), data = p2, shape = 21, size = 6, \n             color='black', fill='white') +\n  geom_point(aes(x = time, y = risk), data = p3, shape = 16, size = 6) +\n  xlab(\"Age\") +\n  ylab(\"Y(age)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.005)), \n                     limits = c(0, 26)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 12), breaks = seq(0, 12, 1)) +\n  theme_general_x\n\nfig1.13a\n\n\n\nfig1.13b\n\n\n\nfig1.13c\n\n\n\nfig1.13d"
  },
  {
    "objectID": "Ch1.html#exercises",
    "href": "Ch1.html#exercises",
    "title": "1  Introduction and data sets",
    "section": "Exercises",
    "text": "Exercises\n\nExercise 1.1\n\nConsider the small data set in Table 1.6 and argue why both the average of all (12) observation times and the average of the (7) uncensored times will likely underestimate the true mean survival time from entry into the study.\nThe average of all 12 observation times: \\[\\frac{5+6+7+8+9+12+13+15+16+20+22+23}{12} = \\frac{156}{12} = 13.00\\] will under-estimate the mean survival time because 5 of the terms in the sum, i.e., those corresponding to right-censored observations, are known to be smaller than the true survival times.\nThe average of the 7 uncensored observations: \\[\\frac{5+7+8+13+15+16+23}{7}=\\frac{87}{7} = 12.43\\] is also likely to under-estimate the mean because right-censoring will typically cause the longer survival times in the population to be incompletely observed. E.g., survival times longer than the time elapsed from the beginning of the study to its end will always be right-censored.\n\n\n\nExercise 1.2\n\n1. Consider the following records mimicking the Copenhagen Holter study (Example 1.1.8) in wide format and transform them into long format, i.e., create one data set for each of the possible six transitions in Figure 1.7.\nData can be converted to long format using the msprep function from the mstate package. However, we must first add indicators of whether the subjects transitioned to AF, stroke and death during the study. Furthermore, we have to fill in timeafib, timestroke and timedeath for all subjects, such that they correspond to the last time where transitions to the states AF, stroke and death are possible. Lastly, we need to specify a transition matrix.\n\nchs_data <- read.csv(\"data/cphholter.csv\")\nlibrary(tidyverse)\nlibrary(survival)\nlibrary(mstate)\n\n\n# The table from the exercise\nid <- factor(1:8)\ntimeafib <- c(NA, 10, NA, 15, NA, 30, NA, 25)\ntimestroke <- c(NA, NA, 20, 30, NA, NA, 35, 50)\ntimedeath <- c(NA, NA, NA, NA, 70, 75, 95, 65)\nlastobs <- c(100, 90, 80, 85, 70, 75, 95, 65)\ncbind(id, timeafib, timestroke, timedeath, lastobs)\n\n     id timeafib timestroke timedeath lastobs\n[1,]  1       NA         NA        NA     100\n[2,]  2       10         NA        NA      90\n[3,]  3       NA         20        NA      80\n[4,]  4       15         30        NA      85\n[5,]  5       NA         NA        70      70\n[6,]  6       30         NA        75      75\n[7,]  7       NA         35        95      95\n[8,]  8       25         50        65      65\n\n# Creating status indicators\nafib <- ifelse(is.na(timeafib), 0, 1)\nstroke <- ifelse(is.na(timestroke), 0, 1)\ndeath <- ifelse(is.na(timedeath), 0, 1)\n\n# Last time point at risk for a transition to each state\ntimedeath <- lastobs\ntimestroke <- ifelse(is.na(timestroke), timedeath, timestroke)\ntimeafib <- ifelse(is.na(timeafib), timestroke, timeafib)\nwide_data <- as.data.frame(cbind(id, timeafib, timestroke, \n                                 timedeath, afib, stroke, death))\n\n# Creating the transition matrix\ntmat <- matrix(NA,4,4)\ntmat[1, 2:4] <- 1:3\ntmat[2, 3:4] <- 4:5\ntmat[3, 4] <- 6\ndimnames(tmat) <- list(from = c(\"No event\", \"AF\", \"Stroke\", \"Death\"), \n                       to = c(\"No event\", \"AF\", \"Stroke\", \"Death\"))\ntmat\n\n          to\nfrom       No event AF Stroke Death\n  No event       NA  1      2     3\n  AF             NA NA      4     5\n  Stroke         NA NA     NA     6\n  Death          NA NA     NA    NA\n\n# Using msprep to create data in long format\nlong_data <- msprep(time = c(NA, \"timeafib\", \"timestroke\", \"timedeath\"),\n                    status = c(NA, \"afib\", \"stroke\", \"death\"),\n                    trans = tmat, data = wide_data) \nlong_data\n\nAn object of class 'msdata'\n\nData:\n   id from to trans Tstart Tstop time status\n1   1    1  2     1      0   100  100      0\n2   1    1  3     2      0   100  100      0\n3   1    1  4     3      0   100  100      0\n4   2    1  2     1      0    10   10      1\n5   2    1  3     2      0    10   10      0\n6   2    1  4     3      0    10   10      0\n7   2    2  3     4     10    90   80      0\n8   2    2  4     5     10    90   80      0\n9   3    1  2     1      0    20   20      0\n10  3    1  3     2      0    20   20      1\n11  3    1  4     3      0    20   20      0\n12  3    3  4     6     20    80   60      0\n13  4    1  2     1      0    15   15      1\n14  4    1  3     2      0    15   15      0\n15  4    1  4     3      0    15   15      0\n16  4    2  3     4     15    30   15      1\n17  4    2  4     5     15    30   15      0\n18  4    3  4     6     30    85   55      0\n19  5    1  2     1      0    70   70      0\n20  5    1  3     2      0    70   70      0\n21  5    1  4     3      0    70   70      1\n22  6    1  2     1      0    30   30      1\n23  6    1  3     2      0    30   30      0\n24  6    1  4     3      0    30   30      0\n25  6    2  3     4     30    75   45      0\n26  6    2  4     5     30    75   45      1\n27  7    1  2     1      0    35   35      0\n28  7    1  3     2      0    35   35      1\n29  7    1  4     3      0    35   35      0\n30  7    3  4     6     35    95   60      1\n31  8    1  2     1      0    25   25      1\n32  8    1  3     2      0    25   25      0\n33  8    1  4     3      0    25   25      0\n34  8    2  3     4     25    50   25      1\n35  8    2  4     5     25    50   25      0\n36  8    3  4     6     50    65   15      1\n\n\n\n\n2. Do the same for the entire data set.\nWe can then repeat the procedure for the Copenhagen Holter Study data set.\n\nchs_data$timestroke <- ifelse(is.na(chs_data$timestroke),\n                              chs_data$timedeath, chs_data$timestroke)\nchs_data$timeafib <- ifelse(is.na(chs_data$timeafib),\n                            chs_data$timestroke, chs_data$timeafib)\n\nchs_long <- msprep(time = c(NA, \"timeafib\", \"timestroke\", \"timedeath\"),\n                   status = c(NA, \"afib\", \"stroke\", \"death\"),\n                   trans = tmat, data = chs_data)\n\nNB: We get a warning because 5 subjects have two events on the same day. This will be handled if necessary for further analyses.\n\n\n\nExercise 1.3\n\n1. Derive Equations (1.2) and (1.3) for, respectively, the survival function in the two-state model (Figure 1.1) and the cumulative incidence function in the competing risks model (Figure 1.2).\nThe hazard function \\[\\alpha(t)=\\lim_{dt\\rightarrow 0}P(T\\leq t+dt\\mid T>t)/dt\\] equals \\[\\alpha(t)=\\frac{f(t)}{S(t)}=\\frac{-(d/dt) S(t)}{S(t)}=-(d/dt)\\log S(t)\\] where \\(f(t)\\) is the density function for \\(T\\) and, thereby, \\(S(t)=\\int_0^t\\alpha(u)du\\).\nThe cause \\(h\\) cumulative incidence is the probability of failing from cause \\(h\\) during \\([0,t]\\). This is the integral of the infinitesimal probabilities of failing in \\((u,u+du)\\) for \\(0\\leq u\\leq t\\). The probability of failing in \\((u,u+du)\\) is, by definition of the cause-\\(h\\)-specific hazard, equal to \\(S(u)\\alpha_h(u)du\\) and the desired result \\[Q_h(t)=\\int_0^tS(u)\\alpha_h(u)du\\] follows.\n\n\n2. Show, for the Markov illness-death model (Figure 1.3), that the state occupation probability for state 1 at time \\(t\\), \\(Q_1(t)\\), is \\[\\int_0^t\\exp\\left(-\\int_0^u(\\alpha_{01}(x)+\\alpha_{02}(x))dx\\right)\\alpha_{01}(u)\\exp\\left(-\\int_u^t\\alpha_{12}(x)dx\\right)du.\\]\nThe probability \\(P_{11}(u,t)\\) of staying in state 1 from time \\(u\\) to time \\(t\\) is given by \\(\\exp(-\\int_u^t\\alpha_{12}(x)dx)\\) and combining this with the argument from the previous question, i.e., that the (infinitesimal) probability \\(\\exp(-\\int_0^u(\\alpha_{01}(x)+\\alpha_{02}(x))dx)\\alpha_{01}(u)du\\), of moving from state 0 to state 1 during \\((u, u+du)\\), the desired result is obtained by integration over \\(u\\) from 0 to \\(t\\).\n\n\n\nExercise 1.4 (*)\n\nArgue (intuitively) how the martingale property \\(E(M(t)\\mid {\\cal H}_{s})=M(s)\\) follows from \\(E(dM(t)\\mid {\\cal H}_{t-})=0\\) (Section 1.4.3).\nBecause \\(M(s)\\) is adapted to the history \\({\\cal H}_s\\) we get \\[E(M(t)\\mid {\\cal F}_s)-M(s)=E(M(t)-M(s)\\mid {\\cal H}_s).\\] We write the difference \\(M(t)-M(s)\\) as the sum of increments \\[=E(\\int_{(s,t]}dM(u)\\mid {\\cal H}_s)\\] and change the order of integration and expectation \\[=\\int_{(s,t]}E(dM(u)\\mid {\\cal H}_s).\\] We finally use the `principle of repeated conditioning’ to obtain the desired result of 0 \\[=\\int_{(s,t]}E(E(dM(u)\\mid {\\cal H}_{u-})\\mid {\\cal H}_s)=0.\\]"
  },
  {
    "objectID": "Ch2.html#pbc3-trial",
    "href": "Ch2.html#pbc3-trial",
    "title": "2  Intuition for intensity models",
    "section": "PBC3 trial",
    "text": "PBC3 trial\n\nRead data\n\npbc3 <- data.frame(read.csv(\"data/pbc3.csv\"))\npbc3$fail <- ifelse(pbc3$status != 0, 1, 0) # event/failure indicator\npbc3$tment_char <- ifelse(pbc3$tment == 0, \"Placebo\", \"CyA\")\n\n\n\nFigure 2.1\n\n# General plotting style \nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20),\n        legend.position = \"bottom\", \n        legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        legend.key.size = unit(2,\"line\"))\n\n# Nelson Aalen estimate by treatment\nlibrary(survival)\nnafit <- survfit(Surv(days, status != 0) ~ tment, data = pbc3)\n# Collect data for plot\nnadata <- data.frame(cumhaz = nafit$cumhaz, time = nafit$time, \n                     tment = c(rep(names(nafit$strata)[1], nafit$strata[1]), \n                               rep(names(nafit$strata)[2], nafit$strata[2])))\n\n# Create Figure 2.1\nlibrary(ggplot2)\nfig2.1 <- ggplot(aes(x = time / 365.25, y = cumhaz, linetype = tment),\n                 data = nadata) + \n  geom_step(size = 1) + \n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\", \"CyA\")) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6), breaks = seq(0, 6, 1))  + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general \n\nfig2.1\n\n\n\n#------------------------------------------------------------------#\n# In-text: Nelson-Aalen estimates at 2 years\n#------------------------------------------------------------------#\ntail(subset(nadata, nadata$time <= 2*365.25 & nadata$tment == \"tment=0\"),1)\n\n     cumhaz time   tment\n60 0.183065  724 tment=0\n\ntail(subset(nadata, nadata$time <= 2*365.25 & nadata$tment == \"tment=1\"),1)\n\n       cumhaz time   tment\n209 0.1668539  725 tment=1\n\n\n\n\nTable 2.1\n\n# Data for Table 2.1\ncuts <- c(0, 2, 4) * 365.25\n# Make the data ready using survSplit from survival package\nlibrary(survival)\npbc3mult <- as.data.frame(survSplit(Surv(days, fail) ~ ., pbc3,\n                      cut = cuts[-1], \n                      episode = \"timegroup\"))\npbc3mult$risktime <- pbc3mult$days - cuts[pbc3mult$timegroup] \npbc3mult$timegroup <- as.factor(pbc3mult$timegroup)\n\nlibrary(dplyr)\npcwdata <- pbc3mult %>% \n  group_by(tment, timegroup) %>% \n  summarise(fail = sum(fail), risktime = sum(days - cuts[timegroup]))\npcwdata$risktimeyrs <- pcwdata$risktime/365.25\npcwdata$hazard <- 36525*pcwdata$fail/pcwdata$risktime\npcwdata$SD <- 36525*sqrt(pcwdata$fail)/pcwdata$risktime\ndata.frame(pcwdata)\n\n  tment timegroup fail risktime risktimeyrs    hazard       SD\n1     0         1   27 104856.0   287.08008  9.405041 1.810001\n2     0         2   17  49673.0   135.99726 12.500252 3.031756\n3     0         3    2   8642.0    23.66051  8.452904 5.977106\n4     1         1   24 107931.5   295.50034  8.121818 1.657859\n5     1         2   18  50284.5   137.67146 13.074605 3.081714\n6     1         3    2   7599.0    20.80493  9.613107 6.797493\n\n\n\n\nFigure 2.2\n\n# Rates + cuts from Table 2.1\nrateCyA <- c(8.1,13.1,9.6)\nratePbo <- c(9.4,12.5,8.5)\npcwtime <- c(0,2,4,5)\n# Collect data\nplotdata <- data.frame(rates = c(rateCyA, ratePbo),\n                       tment = c(rep(\"CyA\", length(rateCyA)), \n                                 rep(\"Placebo\", length(ratePbo))),\n                       times_s = rep(pcwtime[-4], 2),\n                       times = rep(pcwtime[-1], 2))\n\n# Create Figure 2.2\nfig2.2 <- ggplot(aes(x = time, y = rates, linetype = tment), data = plotdata) +\n  geom_segment(aes(x = times_s, y = rates, xend = times, yend = rates),size=1) +\n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\", \"CyA\"))  +\n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Estimated hazard function (per 100 years)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 5),\n                     breaks = seq(0, 5, 1))  +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0,14), breaks = seq(0, 14, 2)) +\n  theme_general\n\nfig2.2\n\n\n\n\n\n\nIn-text: LRT test using piece-wise exponential model\n\nlibrary(stats)\npoisfull <- glm(fail ~ - 1 + tment + timegroup + tment:timegroup +\n                  offset(log(risktime/36525)), data = pbc3mult, family=poisson)\npoisred <- glm(fail ~ - 1 + timegroup +\n                 offset(log(risktime/36525)), data = pbc3mult, family=poisson)\nanova(poisred,poisfull,test=\"LRT\")\n\nAnalysis of Deviance Table\n\nModel 1: fail ~ -1 + timegroup + offset(log(risktime/36525))\nModel 2: fail ~ -1 + tment + timegroup + tment:timegroup + offset(log(risktime/36525))\n  Resid. Df Resid. Dev Df Deviance Pr(>Chi)\n1       620     459.66                     \n2       617     459.35  3  0.30813   0.9585\n\n# or\nlibrary(lmtest)\nlrtest(poisred,poisfull)\n\nLikelihood ratio test\n\nModel 1: fail ~ -1 + timegroup + offset(log(risktime/36525))\nModel 2: fail ~ -1 + tment + timegroup + tment:timegroup + offset(log(risktime/36525))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   3 -319.83                     \n2   6 -319.68  3 0.3081     0.9585\n\n\n\n\nIn-text: Logrank test and p-value\n\nlibrary(survival)\nlr<-survdiff(Surv(days, status != 0) ~ tment, data = pbc3)\nc(lr$chisq,lr$pvalue)\n\n[1] 0.07708002 0.78129419\n\n\n\n\nFigure 2.3\n\n# NA data from figure 2.1 model fit\ntment1 <- subset(nadata, tment == \"tment=1\")\n# Estimated hazard per time group\npcwdata$hazard_timegroup <- pcwdata$fail / pcwdata$risktime\n# Add a numeric version of the treatment to the NA estimates\nnadata$tmentnum <- ifelse(nadata$tment == \"tment=1\", 1, 0)\n# Add piecewise constant hazard to data\nnadata$pwch <- NULL\n# Between time 0 and 2\nnadata$pwch[nadata$time <= 2 * 365.25] <- nadata$time[nadata$time <= 2 * 365.25] *\n  (pcwdata$hazard_timegroup[1] * (1-nadata$tmentnum[nadata$time <= 2 * 365.25]) +\n     pcwdata$hazard_timegroup[4] * (nadata$tmentnum[nadata$time <= 2 * 365.25]))\n# Between time 2 and 4\nnadata$pwch[nadata$time > 2 * 365.25 & nadata$time <= 4* 365.25 ] <- 2 * 365.25 * \n  (pcwdata$hazard_timegroup[1] * (1-nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25]) + \n     pcwdata$hazard_timegroup[4] * (nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25])) + \n  (nadata$time[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25] - 2 * 365.25) * \n  (pcwdata$hazard_timegroup[2] * (1-nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25]) + \n     pcwdata$hazard_timegroup[5] * (nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25]))\n# After time 4\nnadata$pwch[nadata$time > 4 * 365.25] <- 2 * 365.25 * \n  (pcwdata$hazard_timegroup[1] * (1-nadata$tmentnum[nadata$time > 4 * 365.25]) + \n     pcwdata$hazard_timegroup[4] * (nadata$tmentnum[nadata$time > 4 * 365.25])) + \n   2 * 365.25 * \n  (pcwdata$hazard_timegroup[2] * (1-nadata$tmentnum[nadata$time > 4 * 365.25]) + \n     pcwdata$hazard_timegroup[5] * (nadata$tmentnum[nadata$time > 4 * 365.25])) + \n  (nadata$time[nadata$time > 4 * 365.25] - 4 * 365.25) * \n  (pcwdata$hazard_timegroup[3] * (1-nadata$tmentnum[nadata$time > 4 * 365.25]) + \n     pcwdata$hazard_timegroup[6] * (nadata$tmentnum[nadata$time > 4 * 365.25]))\n# Reformat for plot\npiecepdata <- data.frame(cumhaz = c(nadata$cumhaz, nadata$pwch), \n                         time = rep(nadata$time, 2),\n                         tmentnum = rep(nadata$tmentnum, 2),\n                         type = c(rep(\"Nelson-Aalen\", length(nadata$time)), \n                                  rep(\"Piece-wise exponential\", length(nadata$time))))\n# Only for treatment 1\npiecepdata1 <- subset(piecepdata, tmentnum == 1)\n\n# Create Figure 2.3\nfig2.3 <- ggplot(aes(x = time / 365.25, y = cumhaz, linetype = type), \n                data = subset(piecepdata1, type == \"Nelson-Aalen\")) + \n  geom_step(size = 1) + \n  geom_line(aes(x = time / 365.25, y = cumhaz, linetype = type), size = 1,\n            data = subset(piecepdata1, type == \"Piece-wise exponential\")) + \n  labs(linetype = \"Type\") + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1))  + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general+\n  theme(legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        legend.key.size = unit(2,\"line\"))\n\nfig2.3\n\n\n\n\n\n\nIn-text: Cox model with treatment only\n\n# Fit a Cox model using the pbc3 data with treatment as a covariate\nlibrary(survival)\ncoxfit <- coxph(Surv(days, status != 0) ~ tment, data = pbc3, method = \"breslow\")\ncoxfit\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment, data = pbc3, \n    method = \"breslow\")\n\n          coef exp(coef) se(coef)      z     p\ntment -0.05854   0.94314  0.21092 -0.278 0.781\n\nLikelihood ratio test=0.08  on 1 df, p=0.7813\nn= 349, number of events= 90 \n\n\n\n\nFigure 2.5\n\n# Extract cumulative baseline hazard\ncoxcumhaz <- basehaz(coxfit, centered = FALSE)\n# Collect data for plot (Breslow estimate)\ncoxdata <- data.frame(cumhaz = coxcumhaz$hazard, \n                      time = coxcumhaz$time, \n                      tment = rep(\"0\", nrow(coxcumhaz)), \n                      type = rep(\"Breslow estimate\", nrow(coxcumhaz)))\n\n# Create Figure 2.5\nfig2.5 <- ggplot(aes(x = time / 365.25, y = cumhaz, linetype = tment),\n                 data = coxdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative baseline hazard\") + \n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\")) + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general+theme(legend.position = \"none\")\n\nfig2.5\n\n\n\n\n\n\nTable 2.3\n\n# Average covariate values of albumin and bilirubin per treatment \nlibrary(dplyr)\ntabledata <- pbc3 %>% \n  group_by(tment, tment_char) %>% \n  summarise(n = sum(id != 0),  \n            average_albumin = mean(alb, na.rm = TRUE), \n            # NOTE: Removes missing observations from mean computation\n            average_bilirubin = mean(bili, na.rm = TRUE), \n            )\ndata.frame(tabledata)\n\n  tment tment_char   n average_albumin average_bilirubin\n1     0    Placebo 173        39.26101          42.33674\n2     1        CyA 176        37.50731          48.55540\n\n\n\n\nTable 2.4\n\n# Cox model with treatment, albumin and bilirubin as covariates \nlibrary(survival)\ncoxfit <- coxph(Surv(days, status != 0) ~ tment + alb + bili,\n                data = pbc3)\ncoxfit\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili, \n    data = pbc3)\n\n            coef  exp(coef)   se(coef)      z        p\ntment -0.4965639  0.6086184  0.2256162 -2.201   0.0277\nalb   -0.1156596  0.8907784  0.0212810 -5.435 5.48e-08\nbili   0.0089494  1.0089895  0.0009801  9.131  < 2e-16\n\nLikelihood ratio test=99.06  on 3 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\n\n\nIn-text: Poisson model with treatment only\n\nlibrary(stats)\nlibrary(broom) # For using tidy() function\npoism <- glm(fail ~ tment + timegroup-1 +\n               offset(log(risktime/365.25)), data = pbc3mult,family = poisson)\ntidy(poism, exponentiate = T, conf.int = T)\n\n# A tibble: 4 × 7\n  term       estimate std.error statistic  p.value conf.low conf.high\n  <chr>         <dbl>     <dbl>     <dbl>    <dbl>    <dbl>     <dbl>\n1 tment        0.942      0.211    -0.284 7.76e- 1   0.622      1.43 \n2 timegroup1   0.0902     0.174   -13.8   2.51e-43   0.0631     0.125\n3 timegroup2   0.132      0.198   -10.2   1.29e-24   0.0876     0.191\n4 timegroup3   0.0925     0.509    -4.68  2.91e- 6   0.0283     0.220\n\n\n\n\nTable 2.5\n\n# Poisson model with treatment, albumin and bilirubin as covariates\npoismod_t25 <- glm(fail ~ tment + alb + bili+ timegroup-1 +\n                     offset(log(risktime/365.25)),data=pbc3mult,family=poisson)\ntidy(poismod_t25)\n\n# A tibble: 6 × 5\n  term       estimate std.error statistic  p.value\n  <chr>         <dbl>     <dbl>     <dbl>    <dbl>\n1 tment      -0.475    0.224        -2.12 3.39e- 2\n2 alb        -0.112    0.0213       -5.28 1.30e- 7\n3 bili        0.00846  0.000939      9.01 2.12e-19\n4 timegroup1  1.29     0.806         1.60 1.10e- 1\n5 timegroup2  2.15     0.833         2.58 9.99e- 3\n6 timegroup3  1.61     1.01          1.59 1.12e- 1\n\n\n\n\nTable 2.6\n\n# Add transformations of covariates \npbc3$albnorm <- with(pbc3, (alb-35)*(alb>35))\n\npbc3$bilihigh <- with(pbc3, (bili-17.1)*(bili>17.1))\npbc3$bilitoohigh <- with(pbc3, (bili-34.2)*(bili>34.2))\npbc3$bilimuchtoohigh <- with(pbc3, (bili-51.3)*(bili>51.3))\n\npbc3$log2bili <- with(pbc3, log2(bili))\npbc3$log2bili2 <- with(pbc3, log2bili*log2bili)\n\npbc3$logbilihigh <- with(pbc3, (log2bili-log2(17.1))*(bili>17.1))\npbc3$logbilitoohigh <- with(pbc3, (log2bili-log2(34.2))*(bili>34.2))\npbc3$logbilimuchtoohigh <- with(pbc3, (log2bili-log2(51.3))*(bili>51.3))\n\n#------------------------------------------------------------------#\n# Table 2.6 Cox models \n#------------------------------------------------------------------#\n\n# Models for LR tests\nlibrary(lmtest)\nbase_coxmod <- coxph(Surv(days, status != 0) ~ tment + alb + bili, \n                     eps = 1e-8, method = \"breslow\", data = pbc3)\nbase_coxmod_log <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                         eps = 1e-8, method = \"breslow\", data = pbc3)\n\n# Splines Cox 1\ncoxmod_t26_l1 <- coxph(Surv(days, status != 0) ~ tment + alb + albnorm + bili,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_l1\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + albnorm + \n    bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n              coef  exp(coef)   se(coef)      z      p\ntment   -0.4750722  0.6218402  0.2261462 -2.101 0.0357\nalb     -0.0854244  0.9181225  0.0453150 -1.885 0.0594\nalbnorm -0.0557001  0.9458228  0.0726447 -0.767 0.4432\nbili     0.0089810  1.0090214  0.0009843  9.124 <2e-16\n\nLikelihood ratio test=99.66  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\nlrtest(coxmod_t26_l1, base_coxmod)\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + albnorm + bili\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -413.12                     \n2   3 -413.42 -1 0.6001     0.4386\n\n# Quadratic Cox 1\ncoxmod_t26_q1 <- coxph(Surv(days, status != 0) ~ tment + alb + I(alb*alb) + bili,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_q1\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + I(alb * \n    alb) + bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n                   coef  exp(coef)   se(coef)      z      p\ntment        -0.4983093  0.6075570  0.2274284 -2.191 0.0284\nalb          -0.1295361  0.8785029  0.2130539 -0.608 0.5432\nI(alb * alb)  0.0001944  1.0001945  0.0029754  0.065 0.9479\nbili          0.0089499  1.0089901  0.0009801  9.132 <2e-16\n\nLikelihood ratio test=99.07  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\nlrtest(coxmod_t26_q1, base_coxmod)\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + I(alb * alb) + bili\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -413.41                     \n2   3 -413.42 -1 0.0042      0.948\n\n# Splines Cox 2\ncoxmod_t26_l2 <- coxph(Surv(days, status != 0) ~ tment + alb + \n                         bili + bilihigh + bilitoohigh + bilimuchtoohigh,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_l2\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili + \n    bilihigh + bilitoohigh + bilimuchtoohigh, data = pbc3, method = \"breslow\", \n    eps = 1e-08)\n\n                     coef exp(coef)  se(coef)      z        p\ntment           -0.598494  0.549639  0.229637 -2.606  0.00915\nalb             -0.090970  0.913045  0.021894 -4.155 3.25e-05\nbili             0.062425  1.064414  0.062296  1.002  0.31631\nbilihigh        -0.014631  0.985476  0.085327 -0.171  0.86386\nbilitoohigh     -0.002584  0.997419  0.052961 -0.049  0.96109\nbilimuchtoohigh -0.040017  0.960773  0.026486 -1.511  0.13082\n\nLikelihood ratio test=123.5  on 6 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\nlrtest(coxmod_t26_l2, base_coxmod)\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + bili + bilihigh + bilitoohigh + \n    bilimuchtoohigh\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   6 -401.22                         \n2   3 -413.42 -3 24.396  2.064e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n# Quadratic Cox 2\ncoxmod_t26_q2 <- coxph(Surv(days, status != 0) ~ tment+alb+bili + I(bili*bili),\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_q2\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili + \n    I(bili * bili), data = pbc3, method = \"breslow\", eps = 1e-08)\n\n                     coef  exp(coef)   se(coef)      z        p\ntment          -5.210e-01  5.939e-01  2.233e-01 -2.333 0.019640\nalb            -1.019e-01  9.031e-01  2.168e-02 -4.703 2.56e-06\nbili            1.998e-02  1.020e+00  3.263e-03  6.122 9.21e-10\nI(bili * bili) -3.051e-05  1.000e+00  9.098e-06 -3.354 0.000798\n\nLikelihood ratio test=111.4  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\nlrtest(coxmod_t26_q2, base_coxmod)\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + bili + I(bili * bili)\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   4 -407.24                         \n2   3 -413.42 -1 12.351  0.0004408 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n# Splines Cox 3\ncoxmod_t26_l3 <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili +\n                         logbilihigh + logbilitoohigh + logbilimuchtoohigh,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_l3\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili + \n    logbilihigh + logbilitoohigh + logbilimuchtoohigh, data = pbc3, \n    method = \"breslow\", eps = 1e-08)\n\n                       coef exp(coef) se(coef)      z        p\ntment              -0.58019   0.55979  0.22957 -2.527   0.0115\nalb                -0.08852   0.91528  0.02182 -4.056 4.99e-05\nlog2bili            0.20135   1.22306  0.46511  0.433   0.6651\nlogbilihigh         0.93567   2.54893  0.91503  1.023   0.3065\nlogbilitoohigh     -0.38647   0.67945  1.29333 -0.299   0.7651\nlogbilimuchtoohigh -0.18140   0.83410  0.98801 -0.184   0.8543\n\nLikelihood ratio test=121.6  on 6 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\nlrtest(coxmod_t26_l3, base_coxmod_log)\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + log2bili + logbilihigh + \n    logbilitoohigh + logbilimuchtoohigh\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -402.13                     \n2   3 -402.94 -3 1.6144     0.6561\n\n# Quadratic Cox 3\ncoxmod_t26_q3 <- coxph(Surv(days, status != 0) ~ tment+alb+log2bili + log2bili2,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_q3\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili + \n    log2bili2, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n              coef exp(coef) se(coef)      z        p\ntment     -0.57408   0.56323  0.22454 -2.557   0.0106\nalb       -0.09150   0.91256  0.02192 -4.175 2.98e-05\nlog2bili   0.58231   1.79017  0.49992  1.165   0.2441\nlog2bili2  0.00715   1.00717  0.04277  0.167   0.8672\n\nLikelihood ratio test=120  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\nlrtest(coxmod_t26_q3, base_coxmod_log)\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + log2bili + log2bili2\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -402.93                     \n2   3 -402.94 -1 0.0277     0.8677\n\n#------------------------------------------------------------------#\n# Table 2.6 Poisson models \n#------------------------------------------------------------------#\n\n# Make the data ready for Poisson models using survSplit from survival package\nlibrary(survival)\npbc3mult <- as.data.frame(survSplit(Surv(days, fail) ~ ., pbc3,\n                                    cut = cuts[-1], \n                                    episode = \"timegroup\"))\npbc3mult$risktime <- pbc3mult$days - cuts[pbc3mult$timegroup] \npbc3mult$timegroup <- as.factor(pbc3mult$timegroup)\n\n# Models for LR test\nbase_poismod <- glm(fail ~ timegroup + tment + alb + bili +\n                      offset(log(risktime)), data = pbc3mult, family = poisson)\nbase_poismod_log <- glm(fail ~ timegroup + tment + alb + log2bili +\n                          offset(log(risktime)), data=pbc3mult,family=poisson)\n\n# Splines Poisson 1\npoismod_t26_l1 <- glm(fail ~ timegroup + tment + alb + albnorm + bili +\n                        offset(log(risktime)), data=pbc3mult, family=poisson)\ntidy(poismod_t26_l1)\n\n# A tibble: 7 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept) -5.12     1.63        -3.14  1.66e- 3\n2 timegroup1  -0.311    0.604       -0.514 6.07e- 1\n3 timegroup2   0.543    0.602        0.902 3.67e- 1\n4 tment       -0.458    0.225       -2.04  4.17e- 2\n5 alb         -0.0864   0.0452      -1.91  5.57e- 2\n6 albnorm     -0.0474   0.0720      -0.658 5.11e- 1\n7 bili         0.00848  0.000942     9.00  2.24e-19\n\nlrtest(poismod_t26_l1, base_poismod)\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + albnorm + bili + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   7 -263.14                     \n2   6 -263.36 -1 0.4404     0.5069\n\n# Quadratic Poisson 1\npoismod_t26_q1 <- glm(fail ~ timegroup + tment + alb + I(alb*alb) + bili +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_q1)\n\n# A tibble: 7 × 5\n  term          estimate std.error statistic  p.value\n  <chr>            <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -3.83      3.81        -1.00  3.16e- 1\n2 timegroup1   -0.323     0.605       -0.534 5.94e- 1\n3 timegroup2    0.536     0.602        0.890 3.73e- 1\n4 tment        -0.479     0.226       -2.12  3.41e- 2\n5 alb          -0.139     0.210       -0.660 5.09e- 1\n6 I(alb * alb)  0.000371  0.00293      0.126 8.99e- 1\n7 bili          0.00846   0.000939     9.01  2.05e-19\n\nlrtest(poismod_t26_q1, base_poismod)\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + I(alb * alb) + bili + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   7 -263.36                     \n2   6 -263.36 -1 0.0158     0.8999\n\n# Splines Poisson 2\npoismod_t26_l2 <- glm(fail ~ timegroup + tment + alb + \n                        bili + bilihigh + bilitoohigh + bilimuchtoohigh +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_l2)\n\n# A tibble: 9 × 5\n  term            estimate std.error statistic    p.value\n  <chr>              <dbl>     <dbl>     <dbl>      <dbl>\n1 (Intercept)     -6.45       1.37     -4.72   0.00000240\n2 timegroup1      -0.427      0.605    -0.707  0.480     \n3 timegroup2       0.425      0.604     0.705  0.481     \n4 tment           -0.569      0.227    -2.51   0.0121    \n5 alb             -0.0865     0.0219   -3.95   0.0000770 \n6 bili             0.0617     0.0623    0.989  0.322     \n7 bilihigh        -0.0168     0.0852   -0.197  0.844     \n8 bilitoohigh      0.00265    0.0526    0.0504 0.960     \n9 bilimuchtoohigh -0.0428     0.0262   -1.63   0.102     \n\nlrtest(poismod_t26_l2, base_poismod)\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + bili + bilihigh + bilitoohigh + \n    bilimuchtoohigh + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   9 -251.09                         \n2   6 -263.36 -3 24.545  1.922e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n# Quadratic Poisson 2\npoismod_t26_q2 <- glm(fail ~ timegroup + tment + alb + bili + I(bili*bili) +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_q2)\n\n# A tibble: 7 × 5\n  term             estimate  std.error statistic  p.value\n  <chr>               <dbl>      <dbl>     <dbl>    <dbl>\n1 (Intercept)    -5.16      1.05          -4.90  9.47e- 7\n2 timegroup1     -0.382     0.605         -0.631 5.28e- 1\n3 timegroup2      0.455     0.603          0.755 4.50e- 1\n4 tment          -0.499     0.222         -2.25  2.45e- 2\n5 alb            -0.0977    0.0216        -4.52  6.24e- 6\n6 bili            0.0200    0.00327        6.12  9.49e-10\n7 I(bili * bili) -0.0000315 0.00000907    -3.48  5.10e- 4\n\nlrtest(poismod_t26_q2, base_poismod)\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + bili + I(bili * bili) + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   7 -256.69                         \n2   6 -263.36 -1 13.345  0.0002591 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n# Splines Poisson 3\npoismod_t26_l3 <- glm(fail ~ timegroup + tment + alb + \n                        log2bili + logbilihigh + logbilitoohigh + logbilimuchtoohigh +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_l3)\n\n# A tibble: 9 × 5\n  term               estimate std.error statistic  p.value\n  <chr>                 <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)         -6.52      2.00      -3.27  0.00109 \n2 timegroup1          -0.407     0.604     -0.674 0.501   \n3 timegroup2           0.418     0.604      0.693 0.488   \n4 tment               -0.556     0.227     -2.45  0.0144  \n5 alb                 -0.0844    0.0218    -3.87  0.000109\n6 log2bili             0.198     0.465      0.425 0.671   \n7 logbilihigh          0.882     0.912      0.967 0.334   \n8 logbilitoohigh      -0.234     1.28      -0.183 0.855   \n9 logbilimuchtoohigh  -0.314     0.971     -0.323 0.746   \n\nlrtest(poismod_t26_l3, base_poismod_log)\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + logbilihigh + logbilitoohigh + \n    logbilimuchtoohigh + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   9 -251.77                     \n2   6 -252.62 -3 1.7135     0.6339\n\n# Quadratic Poisson 3\npoismod_t26_q3 <- glm(fail ~ timegroup + tment + alb + log2bili + log2bili2 +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_q3)\n\n# A tibble: 7 × 5\n  term        estimate std.error statistic   p.value\n  <chr>          <dbl>     <dbl>     <dbl>     <dbl>\n1 (Intercept) -7.86       1.85     -4.25   0.0000218\n2 timegroup1  -0.406      0.605    -0.672  0.502    \n3 timegroup2   0.439      0.603     0.728  0.467    \n4 tment       -0.545      0.223    -2.45   0.0143   \n5 alb         -0.0871     0.0219   -3.98   0.0000692\n6 log2bili     0.628      0.497     1.26   0.207    \n7 log2bili2    0.00164    0.0424    0.0387 0.969    \n\nlrtest(poismod_t26_q3, base_poismod_log)\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + log2bili2 + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   7 -252.62                     \n2   6 -252.62 -1 0.0015     0.9691\n\n\n\n\nFigure 2.6\n\n# The below linear predictors include estimates from the following models\npbc3mult$timegroup <- relevel(as.factor(pbc3mult$timegroup), ref = \"3\")\npbc3mult$tment_char <- as.factor(pbc3mult$tment_char)\npbc3mult$tment_char <- relevel(pbc3mult$tment_char, ref = \"Placebo\")\nbase_poismod <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                      tment_char + alb + bili,\n                    data = pbc3mult, family = poisson)\npoismod_t26_l1 <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                        tment_char + alb + bili + albnorm,\n                      data = pbc3mult, family = poisson)\npoismod_t26_l3 <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                        tment_char + alb + \n                        bili + bilihigh + bilitoohigh + bilimuchtoohigh,\n                      data = pbc3mult,family = poisson)\n# Make a dataset with linear predictor information\nlin2 <- pbc3\nlin2$lp1 <- with(pbc3, 1.6076-0.1123*alb)\nlin2$lp2 <- with(pbc3, 0.7828-0.0864*alb-0.0474*albnorm)\nlin2$lp3 <- with(pbc3, 1.6076+0.0085*bili-38.7*0.1123)\nlin2$lp4 <- with(pbc3, -0.5534+0.0617*bili-0.0168*bilihigh+\n                   0.0027*bilitoohigh-0.0428*bilimuchtoohigh-0.0865*38.7)\nlin2row <- data.frame(effect = c(rep(\"Linear effect\", nrow(lin2)),\n                                 rep(\"Effect as linear spline\", nrow(lin2))), \n                      lp = c(lin2$lp1, lin2$lp2), alb = c(lin2$alb, lin2$alb))\nlibrary(ggplot2)\nfig2.6 <- ggplot(aes(x = alb, y = lp, linetype = effect), data = lin2row) +\n  geom_line(size = 1) + \n  xlab(\"Albumin\") + \n  ylab(\"Linear predictor\") + \n  scale_linetype_discrete(\"Effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.6\n\n\n\n\n\n\nFigure 2.7\n\n# bilirubin and the two last linear predictors\nlin2row2 <- data.frame(effect = c(rep(\"Linear effect\", nrow(lin2)),\n                                  rep(\"Effect as linear spline\", nrow(lin2))), \n                      lp = c(lin2$lp3, lin2$lp4),\n                      bili = c(lin2$bili, lin2$bili))\n\nfig2.7 <- ggplot(aes(x = bili, y = lp, linetype = effect), data = lin2row2) + \n  geom_line(size = 1) + \n  xlab(\"Bilirubin\") + \n  ylab(\"Linear predictor\") + \n  scale_linetype_discrete(\"Effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.7\n\n\n\n\n\n\nFigure 2.8\n\n# The below linear predictors include estimates from the following models\nbase_poismod2_log <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                           tment_char + alb + log2bili,\n                         data = pbc3mult, family = poisson)\npoismod_t26_l3 <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                        tment_char + alb + log2bili + \n                        logbilihigh + logbilitoohigh + logbilimuchtoohigh,\n                        data = pbc3mult, family = poisson)\n# Make a dataset with linear predictor information\nlog2 <- pbc3\nlog2$lp3 <- with(pbc3, -2.0162+0.6469*log2bili-38.7*0.087)\nlog2$lp4 <- with(pbc3, -0.6194+0.198*log2bili\n                 +0.8815*logbilihigh-0.2336*logbilitoohigh\n                 -0.3139*logbilimuchtoohigh-0.0844*38.7)\nlog2row <- data.frame(effect = c(rep(\"Linear effect\", nrow(log2)),\n                                 rep(\"Effect as linear spline\", nrow(log2))), \n                      lp = c(log2$lp3, log2$lp4),\n                      log2bili = c(log2$log2bili, log2$log2bili)\n                      )\n\nfig2.8 <- ggplot(aes(x = log2bili, y = lp, linetype = effect), data = log2row) + \n  geom_line(size = 1) + \n  xlab(expression(log[2] * \"(bilirubin)\")) +\n  ylab(\"Linear predictor\") + \n  scale_linetype_discrete(\"Effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.8\n\n\n\n\n\n\nTable 2.7\n\n# Cox model\ncoxmod_t27 <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                    eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t27\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili, \n    data = pbc3, method = \"breslow\", eps = 1e-08)\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.57406   0.56323  0.22447 -2.557   0.0105\nalb      -0.09093   0.91308  0.02164 -4.201 2.65e-05\nlog2bili  0.66500   1.94449  0.07443  8.935  < 2e-16\n\nLikelihood ratio test=120  on 3 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n# Poisson model\npoismod_t27 <- glm(fail ~ tment + alb + log2bili + timegroup + \n                     offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t27) \n\n# A tibble: 6 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.48      0.976     -7.66  1.81e-14\n2 tment        -0.545     0.223     -2.45  1.43e- 2\n3 alb          -0.0870    0.0216    -4.02  5.73e- 5\n4 log2bili      0.647     0.0733     8.83  1.04e-18\n5 timegroup3   -0.439     0.603     -0.727 4.67e- 1\n6 timegroup1   -0.844     0.229     -3.69  2.23e- 4\n\n\n\n\nTable 2.8\n\n# Cox models\n# Model for LR comparison\ncoxmod_t28_base <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\n# Cox model 1\npbc3$alb0 <- (pbc3$tment==0)*pbc3$alb\npbc3$alb1 <- (pbc3$tment==1)*pbc3$alb\ncoxmod_t28_1 <- coxph(Surv(days, status != 0) ~ tment + alb0 + alb1 + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t28_1\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb0 + alb1 + \n    log2bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n              coef exp(coef)  se(coef)      z        p\ntment    -0.009736  0.990312  1.559670 -0.006 0.995020\nalb0     -0.081319  0.921900  0.034031 -2.390 0.016869\nalb1     -0.097043  0.907517  0.027344 -3.549 0.000387\nlog2bili  0.664413  1.943350  0.074494  8.919  < 2e-16\n\nLikelihood ratio test=120.2  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\nlrtest(coxmod_t28_1, coxmod_t28_base)\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb0 + alb1 + log2bili\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -402.87                     \n2   3 -402.94 -1 0.1338     0.7145\n\n# Cox model 2\npbc3$bili0 <- (pbc3$tment==0)*pbc3$log2bili\npbc3$bili1 <- (pbc3$tment==1)*pbc3$log2bili\ncoxmod_t28_2 <- coxph(Surv(days, status != 0) ~ tment + alb + bili0 + bili1,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t28_2\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili0 + \n    bili1, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n          coef exp(coef) se(coef)      z        p\ntment  0.19880   1.21994  0.85653  0.232    0.816\nalb   -0.09331   0.91091  0.02191 -4.260 2.05e-05\nbili0  0.72558   2.06593  0.09865  7.355 1.91e-13\nbili1  0.59345   1.81022  0.10604  5.596 2.19e-08\n\nLikelihood ratio test=120.9  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\nlrtest(coxmod_t28_2, coxmod_t28_base)\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + bili0 + bili1\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -402.51                     \n2   3 -402.94 -1 0.8644     0.3525\n\n# Poisson models\n# Model for LR comparison - no interaction\npoismod_t28_base <- glm(fail ~ timegroup + tment + alb + log2bili+\n                          offset(log(risktime)), data=pbc3mult, family=poisson)\n\n# Poisson model 1\npbc3mult$alb0 <- (pbc3mult$tment==0)*pbc3mult$alb\npbc3mult$alb1 <- (pbc3mult$tment==1)*pbc3mult$alb\npoismod_t28_1 <- glm(fail ~ tment + alb0 + alb1 + log2bili + timegroup +\n                       offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t28_1) \n\n# A tibble: 7 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.87      1.36     -5.78   7.54e- 9\n2 tment         0.0920    1.55      0.0593 9.53e- 1\n3 alb0         -0.0763    0.0336   -2.27   2.32e- 2\n4 alb1         -0.0941    0.0275   -3.41   6.39e- 4\n5 log2bili      0.646     0.0733    8.81   1.23e-18\n6 timegroup3   -0.431     0.604    -0.714  4.75e- 1\n7 timegroup1   -0.844     0.229    -3.69   2.20e- 4\n\nlrtest(poismod_t28_base, poismod_t28_1)\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\nModel 2: fail ~ tment + alb0 + alb1 + log2bili + timegroup + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   7 -252.54  1 0.1723      0.678\n\n# Poisson model 2\npbc3mult$bili0 <- (pbc3mult$tment==0)*pbc3mult$log2bili\npbc3mult$bili1 <- (pbc3mult$tment==1)*pbc3mult$log2bili\npoismod_t28_2 <- glm(fail ~ tment + alb + bili0 + bili1 + timegroup +\n                       offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t28_2) \n\n# A tibble: 7 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.72      1.02      -7.59  3.10e-14\n2 tment         0.181     0.848      0.213 8.31e- 1\n3 alb          -0.0891    0.0218    -4.08  4.54e- 5\n4 bili0         0.704     0.0972     7.24  4.42e-13\n5 bili1         0.580     0.105      5.54  3.08e- 8\n6 timegroup3   -0.417     0.604     -0.691 4.90e- 1\n7 timegroup1   -0.857     0.229     -3.74  1.86e- 4\n\nlrtest(poismod_t28_base, poismod_t28_2)\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\nModel 2: fail ~ tment + alb + bili0 + bili1 + timegroup + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   7 -252.24  1 0.7787     0.3775\n\n\n\n\nTable 2.9\n\npbc3mult$tment1 <- (pbc3mult$timegroup==1)*pbc3mult$tment\npbc3mult$tment2 <- (pbc3mult$timegroup==2)*pbc3mult$tment\npbc3mult$tment3 <- (pbc3mult$timegroup==3)*pbc3mult$tment\npbc3mult$alb1 <- (pbc3mult$timegroup==1)*pbc3mult$alb\npbc3mult$alb2 <- (pbc3mult$timegroup==2)*pbc3mult$alb\npbc3mult$alb3 <- (pbc3mult$timegroup==3)*pbc3mult$alb\npbc3mult$bili1 <- (pbc3mult$timegroup==1)*pbc3mult$log2bili\npbc3mult$bili2 <- (pbc3mult$timegroup==2)*pbc3mult$log2bili\npbc3mult$bili3 <- (pbc3mult$timegroup==3)*pbc3mult$log2bili\n\npoismod_t29_base <- glm(fail~tment+alb+log2bili+timegroup+offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\n\n# Treatment\npoismod_t29_tment <- glm(fail ~ tment1 + tment2 + tment3 + alb + log2bili+\n                       timegroup + offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\ntidy(poismod_t29_tment) \n\n# A tibble: 8 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.55      0.983     -7.68  1.62e-14\n2 tment1       -0.562     0.291     -1.93  5.35e- 2\n3 tment2       -0.462     0.345     -1.34  1.80e- 1\n4 tment3       -1.27      1.23      -1.03  3.03e- 1\n5 alb          -0.0864    0.0217    -3.99  6.65e- 5\n6 log2bili      0.649     0.0737     8.81  1.30e-18\n7 timegroup3   -0.0954    0.750     -0.127 8.99e- 1\n8 timegroup1   -0.794     0.319     -2.49  1.29e- 2\n\nlrtest(poismod_t29_base, poismod_t29_tment)\n\nLikelihood ratio test\n\nModel 1: fail ~ tment + alb + log2bili + timegroup + offset(log(risktime))\nModel 2: fail ~ tment1 + tment2 + tment3 + alb + log2bili + timegroup + \n    offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   8 -252.41  2 0.4312     0.8061\n\n# Albumin\npoismod_t29_alb <- glm(fail ~ tment + alb1 + alb2 + alb3 + log2bili+\n                       timegroup + offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\ntidy(poismod_t29_alb) \n\n# A tibble: 8 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -8.75      1.42    -6.18    6.41e-10\n2 tment        -0.561     0.223   -2.52    1.18e- 2\n3 alb1         -0.110     0.0279  -3.95    7.79e- 5\n4 alb2         -0.0523    0.0347  -1.51    1.32e- 1\n5 alb3         -0.0654    0.153   -0.427   6.70e- 1\n6 log2bili      0.646     0.0736   8.78    1.68e-18\n7 timegroup3    0.0143    6.09     0.00235 9.98e- 1\n8 timegroup1    1.24      1.60     0.776   4.38e- 1\n\nlrtest(poismod_t29_base, poismod_t29_alb)\n\nLikelihood ratio test\n\nModel 1: fail ~ tment + alb + log2bili + timegroup + offset(log(risktime))\nModel 2: fail ~ tment + alb1 + alb2 + alb3 + log2bili + timegroup + offset(log(risktime))\n  #Df  LogLik Df Chisq Pr(>Chisq)\n1   6 -252.62                    \n2   8 -251.72  2 1.803      0.406\n\n# Bilirubin\npoismod_t29_bili <- glm(fail ~ tment + alb + bili1 + bili2 + bili3 +\n                       timegroup + offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\ntidy(poismod_t29_bili) \n\n# A tibble: 8 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.06      1.10      -6.40  1.55e-10\n2 tment        -0.515     0.224     -2.30  2.15e- 2\n3 alb          -0.0857    0.0217    -3.94  8.10e- 5\n4 bili1         0.710     0.0926     7.67  1.69e-14\n5 bili2         0.557     0.121      4.60  4.18e- 6\n6 bili3         0.305     0.482      0.633 5.26e- 1\n7 timegroup3    0.696     2.32       0.300 7.64e- 1\n8 timegroup1   -1.72      0.888     -1.94  5.21e- 2\n\nlrtest(poismod_t29_base, poismod_t29_bili)\n\nLikelihood ratio test\n\nModel 1: fail ~ tment + alb + log2bili + timegroup + offset(log(risktime))\nModel 2: fail ~ tment + alb + bili1 + bili2 + bili3 + timegroup + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   8 -251.84  2 1.5777     0.4544\n\n\n\n\nIn-text: stratified Cox model\n\ncoxmod_f29 <- coxph(Surv(days, status != 0) ~ strata(tment) + alb + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_f29\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ strata(tment) + alb + \n    log2bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n             coef exp(coef) se(coef)      z        p\nalb      -0.09002   0.91391  0.02168 -4.153 3.28e-05\nlog2bili  0.66328   1.94114  0.07531  8.807  < 2e-16\n\nLikelihood ratio test=119.3  on 2 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\n\n\nFigure 2.10\n\n# Extracting cumulative baseline hazards per treatment\ncumhaz_treat <- basehaz(coxmod_f29, centered = FALSE)\ncumhaz_treat <- as.data.frame(cumhaz_treat)\n# Per treatment\nhazard_t0 <- cumhaz_treat[cumhaz_treat$strata == \"tment=0\",]\nhazard_t0[1,] <- c(0, 0, \"tment=0\")\nhazard_t0$time<- as.numeric(hazard_t0$time)\nhazard_t0$hazard <- as.numeric(hazard_t0$hazard)\nhazard_t1 <- cumhaz_treat[cumhaz_treat$strata == \"tment=1\",]\n# Match times\nalltimes <- sort(unique(cumhaz_treat$time))\nhazard_t0_allt <- as.numeric(sapply(1:length(alltimes),function(k) \n  tail(hazard_t0$hazard[hazard_t0$time <= alltimes[k]], 1)))\nhazard_t1_allt <- as.numeric(sapply(1:length(alltimes), function(k)\n  tail(hazard_t1$hazard[hazard_t1$time <= alltimes[k]], 1))) \nhazards <- data.frame(hazard_t0_allt, hazard_t1_allt)\n# Extract coefficient\ncoxmod_f29_t <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\n# Make plot\nfig2.10 <- ggplot(aes(x = hazard_t0_allt, y = hazard_t1_allt), data = hazards) + \n  geom_step(size = 1) + \n  geom_abline(intercept = 0, slope = exp(coef(coxmod_f29_t)[[\"tment\"]]), \n              linetype = \"dashed\", size = 1) + \n  xlab(\"Cumulative baseline hazard: placebo\") +\n  ylab(\"Cumulative baseline hazard: CyA\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.10\n\n\n\n\n\n\nFigure 2.11\n\n# Additive Aalen models - available with timereg\nlibrary(timereg)\nnonparmod <- aalen(Surv(days, status != 0) ~ tment, data = pbc3)\nsummary(nonparmod)\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          5.96                0.00\ntment                                1.60                0.75\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.107                       0.564\ntment                               0.136                       0.614\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                          7.62                       0.424\ntment                                4.54                       0.710\n\n   \n   \n  Call: \naalen(formula = Surv(days, status != 0) ~ tment, data = pbc3)\n\ncumhazdata <- data.frame(eventtimes = nonparmod$cum[,1],\n                         basecumhaz = nonparmod$cum[,2], \n                         cumhaztreat = nonparmod$cum[,3], \n                         cumhaztreat_ll = nonparmod$cum[,3]\n                                          -1.96*sqrt(nonparmod$var.cum[,3]),\n                         cumhaztreat_ul = nonparmod$cum[,3]\n                                          +1.96*sqrt(nonparmod$var.cum[,3]))\n# Extend lines to last observed time\ncumhazdata[nrow(cumhazdata)+1,] <- c(max(pbc3$days), tail(cumhazdata, 1)[-1])\n\n# Left figure\nfig2.11.left <- ggplot(aes(x = eventtimes / 365.25, y = basecumhaz), \n                       data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative baseline hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6),breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.11.left\n\n\n\n# Right figure\nfig2.11.right <- ggplot(aes(x = eventtimes / 365.25, y = cumhaztreat), \n                        data = cumhazdata) + \n  geom_step(size = 1) + \n  geom_step(size = 1, aes(x = eventtimes / 365.25, y = cumhaztreat_ll), \n            linetype = \"dashed\") +  \n  geom_step(size = 1, aes(x = eventtimes / 365.25, y = cumhaztreat_ul), \n            linetype = \"dashed\") +\n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative treatment effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.11.right\n\n\n\n\n\n\nFigure 2.12\n\n# Make Aalen model fit\nlibrary(timereg)\nnonparmod2 <- aalen(Surv(days, status != 0) ~ tment + alb + bili, data = pbc3) \ncumhazdata <- data.frame(eventtimes = nonparmod2$cum[,1],\n                         basecumhaz = nonparmod2$cum[,2], \n                         cumhaztreat = nonparmod2$cum[,3], \n                         cumhazalb = nonparmod2$cum[,4], \n                         cumhazbili= nonparmod2$cum[,5])\n# Extend lines to last observed time\ncumhazdata[nrow(cumhazdata)+1,] <- c(max(pbc3$days), tail(cumhazdata, 1)[-1])\n\n# Figure treatment\nfig2.12.1 <- ggplot(aes(x = eventtimes / 365.25, y = cumhaztreat), \n                    data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative treatment effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\n# Figure albumin\nfig2.12.2 <- ggplot(aes(x = eventtimes / 365.25, y = cumhazalb), \n                    data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative albumin effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\n# Figure bilirubin\nfig2.12.3 <- ggplot(aes(x = eventtimes / 365.25, y = cumhazbili), \n                    data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative bilirubin effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)),\n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.12.1\n\n\n\nfig2.12.2\n\n\n\nfig2.12.3\n\n\n\n\n\n\nTable 2.10\n\n#------------------------------------------------------------------#\n# Table 2.10 and in-text results\n#------------------------------------------------------------------#\n\n# Additive model treatment only\n# p-values not exactly as in book because seed changes\nnonparmod0 <- aalen(Surv(days, status != 0) ~ tment, data = pbc3) \nsummary(nonparmod0)\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          5.96               0.000\ntment                                1.60               0.744\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.107                       0.534\ntment                               0.136                       0.573\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                          7.62                       0.397\ntment                                4.54                       0.687\n\n   \n   \n  Call: \naalen(formula = Surv(days, status != 0) ~ tment, data = pbc3)\n\n# Constant effect of treatment per year\nnonparmod01 <- aalen(Surv(days/365.25, status != 0) ~ const(tment), data = pbc3) \nsummary(nonparmod01)\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          6.62                   0\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                        0.0914                        0.41\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0136                       0.284\n\nParametric terms :     \n                Coef.    SE Robust SE     z P-val lower2.5% upper97.5%\nconst(tment) -0.00587 0.021     0.021 -0.28 0.779    -0.047     0.0353\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment), \n    data = pbc3)\n\n# Additive model with treatment, albumin, bilirubin\n# Table 2.10, first two columns\n# p-values not exactly as in book because seed changes\nnonparmod1 <- aalen(Surv(days, status != 0) ~ tment + alb + bili, data = pbc3) \nsummary(nonparmod1)\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          3.62               0.008\ntment                                2.66               0.132\nalb                                  3.82               0.003\nbili                                 4.83               0.000\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                       0.30300                       0.928\ntment                             0.12100                       0.681\nalb                               0.00666                       0.962\nbili                              0.00300                       0.181\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                      14.20000                       0.995\ntment                             3.29000                       0.805\nalb                               0.00826                       0.991\nbili                              0.00203                       0.324\n\n   \n   \n  Call: \naalen(formula = Surv(days, status != 0) ~ tment + alb + bili, \n    data = pbc3)\n\n# Table 2.10, last columns\nnonparmod2 <- aalen(Surv(days/365.25, status != 0) ~ \n                      const(tment) + const(alb) + const(bili), data = pbc3) \nsummary(nonparmod2)\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          4.03                   0\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.119                       0.181\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0263                       0.116\n\nParametric terms :     \n                Coef.       SE Robust SE     z    P-val lower2.5% upper97.5%\nconst(tment) -0.04130 0.021600  0.020100 -2.05 4.01e-02  -0.08360    0.00104\nconst(alb)   -0.00842 0.002290  0.002230 -3.77 1.63e-04  -0.01290   -0.00393\nconst(bili)   0.00230 0.000483  0.000384  5.98 2.17e-09   0.00135    0.00325\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    const(alb) + const(bili), data = pbc3)\n\n# In-text\n# Constant effect of treatment, adjusted for albumin and bilirubin\nnonparmod3 <- aalen(Surv(days/365.25, status != 0) ~ \n                      const(tment) + alb + bili, data = pbc3) \nsummary(nonparmod3)\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          3.60               0.001\nalb                                  3.80               0.002\nbili                                 4.83               0.000\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                       0.28500                       0.939\nalb                               0.00954                       0.808\nbili                              0.00315                       0.159\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                      3.16e-02                       0.995\nalb                              5.26e-05                       0.906\nbili                             6.52e-06                       0.293\n\nParametric terms :     \n               Coef.     SE Robust SE     z P-val lower2.5% upper97.5%\nconst(tment) -0.0401 0.0216    0.0204 -1.97 0.049   -0.0824    0.00224\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    alb + bili, data = pbc3)\n\n# Quadratic effect for albumin; p-values not exactly as in book because seed changes\nnonparmod44 <- aalen(Surv(days/365.25, status != 0) ~ const(tment)\n                       + I(alb/10) + I(bili/100) + I((alb/10)^2), data = pbc3) \nsummary(nonparmod44)\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n              Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                            3.23               0.015\nI(alb/10)                              3.00               0.031\nI(bili/100)                            4.88               0.000\nI((alb/10)^2)                          2.77               0.069\n\nTest for time invariant effects \n                    Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                           9.420                       0.236\nI(alb/10)                             4.950                       0.236\nI(bili/100)                           0.365                       0.079\nI((alb/10)^2)                         0.635                       0.252\n                      Cramer von Mises test p-value H_0:constant effect\n(Intercept)                         83.6000                       0.338\nI(alb/10)                           24.4000                       0.333\nI(bili/100)                          0.0949                       0.172\nI((alb/10)^2)                        0.4160                       0.333\n\nParametric terms :     \n               Coef.     SE Robust SE     z  P-val lower2.5% upper97.5%\nconst(tment) -0.0421 0.0215    0.0201 -2.09 0.0366   -0.0842   3.92e-05\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    I(alb/10) + I(bili/100) + I((alb/10)^2), data = pbc3)\n\n# Quadratic effect for bilirubin; p-values not exactly as in book as seed changes\nnonparmod43 <- aalen(Surv(days/365.25, status != 0) ~ const(tment)\n                       + I(alb/10) + I(bili/100) + I((bili/100)^2), data = pbc3) \nsummary(nonparmod43)\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n                Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                              3.82               0.006\nI(alb/10)                                4.02               0.001\nI(bili/100)                              3.85               0.002\nI((bili/100)^2)                          3.01               0.048\n\nTest for time invariant effects \n                      Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                             0.440                       0.665\nI(alb/10)                               0.117                       0.620\nI(bili/100)                             0.612                       0.440\nI((bili/100)^2)                         0.515                       0.175\n                        Cramer von Mises test p-value H_0:constant effect\n(Intercept)                            0.1320                       0.752\nI(alb/10)                              0.0124                       0.607\nI(bili/100)                            0.4640                       0.353\nI((bili/100)^2)                        0.2880                       0.181\n\nParametric terms :     \n               Coef.     SE Robust SE     z  P-val lower2.5% upper97.5%\nconst(tment) -0.0395 0.0213    0.0208 -1.89 0.0582   -0.0812    0.00225\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    I(alb/10) + I(bili/100) + I((bili/100)^2), data = pbc3)\n\n# Interactions\nnonparmod51 <- aalen(Surv(days/365.25, status != 0) ~ const(tment) + const(alb)\n                     + const(bili) + const(tment * bili),data = pbc3) \nsummary(nonparmod51)\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          4.03                   0\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.123                       0.151\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0287                       0.092\n\nParametric terms :     \n                       Coef.       SE Robust SE       z    P-val lower2.5%\nconst(tment)        -0.00194 0.029400  0.022800 -0.0851 9.32e-01  -0.05960\nconst(alb)          -0.00859 0.002260  0.002200 -3.9000 9.69e-05  -0.01300\nconst(bili)          0.00299 0.000869  0.000437  6.8400 7.77e-12   0.00129\nconst(tment * bili) -0.00116 0.001020  0.000658 -1.7600 7.92e-02  -0.00316\n                    upper97.5%\nconst(tment)          0.055700\nconst(alb)           -0.004160\nconst(bili)           0.004690\nconst(tment * bili)   0.000839\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    const(alb) + const(bili) + const(tment * bili), data = pbc3)\n\nnonparmod52 <- aalen(Surv(days/365.25, status != 0) ~ const(tment) + const(bili) \n                     + const(alb) + const(tment * alb), data = pbc3) \nsummary(nonparmod52)\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          3.06               0.002\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                          0.12                       0.188\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0265                       0.127\n\nParametric terms :     \n                      Coef.       SE Robust SE       z    P-val lower2.5%\nconst(tment)        0.01010 0.199000  0.176000  0.0576 9.54e-01  -0.38000\nconst(bili)         0.00230 0.000482  0.000385  5.9600 2.45e-09   0.00136\nconst(alb)         -0.00771 0.003150  0.002780 -2.7700 5.54e-03  -0.01390\nconst(tment * alb) -0.00132 0.004790  0.004300 -0.3060 7.59e-01  -0.01070\n                   upper97.5%\nconst(tment)          0.40000\nconst(bili)           0.00324\nconst(alb)           -0.00154\nconst(tment * alb)    0.00807\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    const(bili) + const(alb) + const(tment * alb), data = pbc3)\n\n\n\n\nTable 2.11\n\n#------------------------------------------------------------------#\n# Table 2.11 and in-text results\n#------------------------------------------------------------------#\n\n# Additive hazards model with piecewise constant baseline hazards\n# Model with only treatment as covariate\n# update data set\npbc3add <- pbc3mult\npbc3add$time1 <-  with(pbc3add, (timegroup == 1)*risktime/365.25)\npbc3add$time2 <-  with(pbc3add, (timegroup == 2)*risktime/365.25)\npbc3add$time3 <-  with(pbc3add, (timegroup == 3)*risktime/365.25)\npbc3add$tment0 <- with(pbc3add, (tment == 0)*risktime/365.25)\npbc3add$tment1 <- with(pbc3add, (tment == 1)*risktime/365.25)\npbc3add$albny <-  with(pbc3add, ((alb-35)/100)*risktime/365.25)\npbc3add$biliny <- with(pbc3add, ((bili-50)/1000)*risktime/365.25)\n\n# In-text\nadditive_pcw <- glm(fail ~ time1 + time2 + time3 + tment1 - 1,\n                    data = pbc3add, start = c(0.1, 0.1, 0.1, 0),\n                    family = poisson(link = \"identity\"))\ntidy(additive_pcw)\n\n# A tibble: 4 × 5\n  term   estimate std.error statistic      p.value\n  <chr>     <dbl>     <dbl>     <dbl>        <dbl>\n1 time1   0.0911     0.0164     5.55  0.0000000293\n2 time2   0.132      0.0241     5.46  0.0000000487\n3 time3   0.0937     0.0462     2.03  0.0423      \n4 tment1 -0.00726    0.0208    -0.350 0.726       \n\n# Table 2.11 - questionable fit\nadditive_pcw2.11 <- glm(fail ~ time1 + time2 + time3 + tment1 + albny + biliny -1,\n                    data = pbc3add, start = c(0.3, 0.35, 0.4, -0.05, -0.8, 2),\n                    family = poisson(link = \"identity\"))\ntidy(additive_pcw2.11)\n\n# A tibble: 6 × 5\n  term   estimate std.error statistic  p.value\n  <chr>     <dbl>     <dbl>     <dbl>    <dbl>\n1 time1    0.185     0.0213      8.67 4.46e-18\n2 time2    0.241     0.0258      9.32 1.21e-20\n3 time3    0.229     0.0544      4.22 2.48e- 5\n4 tment1  -0.0224    0.0173     -1.30 1.95e- 1\n5 albny   -0.436     0.128      -3.40 6.79e- 4\n6 biliny   2.22      0.408       5.45 4.98e- 8\n\nadditive_pcw2.11 <- glm(fail ~ time1 + time2 + time3 + tment1 + albny + biliny -1,\n                        data = pbc3add, start = c(0.3, 0.35, 0.4, -0.05, -0.8, 2.1),\n                        family = poisson(link = \"identity\"))\ntidy(additive_pcw2.11)\n\n# A tibble: 6 × 5\n  term   estimate std.error statistic  p.value\n  <chr>     <dbl>     <dbl>     <dbl>    <dbl>\n1 time1    0.186     0.0214      8.68 4.08e-18\n2 time2    0.242     0.0259      9.32 1.14e-20\n3 time3    0.231     0.0548      4.22 2.45e- 5\n4 tment1  -0.0223    0.0174     -1.28 2.00e- 1\n5 albny   -0.436     0.129      -3.37 7.63e- 4\n6 biliny   2.25      0.411       5.48 4.21e- 8\n\n\n\n\nTable 2.13\n\n# Death without transplantation\ncoxph(Surv(days, status == 2) ~ tment + alb + log2bili + sex + age,\n           method = \"breslow\", data = pbc3)\n\nCall:\ncoxph(formula = Surv(days, status == 2) ~ tment + alb + log2bili + \n    sex + age, data = pbc3, method = \"breslow\")\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.42049   0.65672  0.26822 -1.568   0.1169\nalb      -0.06992   0.93247  0.02906 -2.406   0.0161\nlog2bili  0.69178   1.99726  0.09303  7.436 1.04e-13\nsex       0.48557   1.62510  0.31943  1.520   0.1285\nage       0.07335   1.07611  0.01621  4.524 6.06e-06\n\nLikelihood ratio test=98.71  on 5 df, p=< 2.2e-16\nn= 343, number of events= 60 \n   (6 observations deleted due to missingness)\n\n# Transplantation\ncoxph(Surv(days, status == 1) ~ tment + alb + log2bili + sex + age,\n           method = \"breslow\", data = pbc3) \n\nCall:\ncoxph(formula = Surv(days, status == 1) ~ tment + alb + log2bili + \n    sex + age, data = pbc3, method = \"breslow\")\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.67305   0.51015  0.41318 -1.629   0.1033\nalb      -0.09400   0.91029  0.03871 -2.428   0.0152\nlog2bili  0.83213   2.29820  0.14655  5.678 1.36e-08\nsex       0.20378   1.22602  0.56329  0.362   0.7175\nage      -0.04805   0.95309  0.02138 -2.247   0.0246\n\nLikelihood ratio test=64.95  on 5 df, p=1.15e-12\nn= 343, number of events= 28 \n   (6 observations deleted due to missingness)\n\n# Failure of medical treatment\ncoxph(Surv(days, status != 0) ~ tment + alb + log2bili + sex + age,\n           method = \"breslow\", data = pbc3)\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili + \n    sex + age, data = pbc3, method = \"breslow\")\n\n             coef exp(coef) se(coef)      z       p\ntment    -0.50964   0.60071  0.22339 -2.281 0.02252\nalb      -0.07136   0.93112  0.02293 -3.112 0.00186\nlog2bili  0.73778   2.09128  0.07768  9.497 < 2e-16\nsex       0.58536   1.79563  0.26738  2.189 0.02858\nage       0.03077   1.03125  0.01199  2.566 0.01029\n\nLikelihood ratio test=134.3  on 5 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)"
  },
  {
    "objectID": "Ch2.html#guinea-bissau-study",
    "href": "Ch2.html#guinea-bissau-study",
    "title": "2  Intuition for intensity models",
    "section": "Guinea-Bissau study",
    "text": "Guinea-Bissau study\n\nRead data\n\nbissau <- data.frame(read.csv(\"data/bissau.csv\"))\n\n\n\nTable 2.12\n\nlibrary(survival)\n# Cox model in column 1\nbissau$agem <- as.integer(bissau$age/30.44)\ncoxfit0 <- coxph(Surv(fuptime, dead) ~ bcg, \n                 data = bissau, method = \"breslow\")\ncoxfit0\n\nCall:\ncoxph(formula = Surv(fuptime, dead) ~ bcg, data = bissau, method = \"breslow\")\n\n       coef exp(coef) se(coef)      z      p\nbcg -0.2821    0.7542   0.1353 -2.085 0.0371\n\nLikelihood ratio test=4.28  on 1 df, p=0.03851\nn= 5274, number of events= 222 \n\n# Cox model in column 1\ncoxfit1 <- coxph(Surv(fuptime, dead) ~ bcg + agem, \n                 data = bissau, method = \"breslow\")\ncoxfit1\n\nCall:\ncoxph(formula = Surv(fuptime, dead) ~ bcg + agem, data = bissau, \n    method = \"breslow\")\n\n         coef exp(coef) se(coef)      z      p\nbcg  -0.35203   0.70326  0.14424 -2.441 0.0147\nagem  0.05376   1.05523  0.03856  1.394 0.1633\n\nLikelihood ratio test=6.21  on 2 df, p=0.04481\nn= 5274, number of events= 222 \n\n# Make age the time variable instead\nbissau$agein <- bissau$age/(365.24/12)\nbissau$ageout <- bissau$agein + bissau$fuptime/(365.24/12)\n\n# Cox model in column 2\n# option timefix=F aligns to SAS calculation\n# see vignette 'Roundoff error and tied times' for survival package\ncoxfit2 <- coxph(Surv(agein, ageout, dead) ~ bcg, \n                 data = bissau, method = \"breslow\",timefix=F)\ncoxfit2\n\nCall:\ncoxph(formula = Surv(agein, ageout, dead) ~ bcg, data = bissau, \n    method = \"breslow\", timefix = F)\n\n       coef exp(coef) se(coef)      z      p\nbcg -0.3558    0.7006   0.1407 -2.529 0.0114\n\nLikelihood ratio test=6.28  on 1 df, p=0.01218\nn= 5274, number of events= 222 \n\n\n\n\nFigure 2.13\n\n# General plotting style \nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20),\n        legend.position = \"bottom\", \n        legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        legend.key.size = unit(2,\"line\")) \n\n\n# Extract cumulative baseline hazard\ncoxcumhaz <- basehaz(coxfit1, centered = FALSE)\n# Collect data for plot\ncoxdata <- data.frame(cumhaz = coxcumhaz$hazard, \n                      time = coxcumhaz$time, \n                      bcg = rep(\"1\", nrow(coxcumhaz)), \n                      type = rep(\"Breslow estimate\", nrow(coxcumhaz)))\n\n# Create figure\nfig2.13 <- ggplot(aes(x = time / (365.24/12), y = cumhaz), data = coxdata) + \n  geom_step(size = 1) + \n  xlab(\"Follow-up time (months)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     breaks = seq(0, 7, by = 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general\n\nfig2.13\n\n\n\n\n\n\nFigure 2.14\n\n# Extract cumulative baseline hazard\ncoxcumhaz <- basehaz(coxfit2, centered = FALSE)\n# Collect data for plot\ncoxdata <- data.frame(cumhaz = coxcumhaz$hazard, \n                      time = coxcumhaz$time, \n                      bcg = rep(\"1\", nrow(coxcumhaz)), \n                      type = rep(\"Breslow estimate\", nrow(coxcumhaz)))\n\n# Create figure\nfig2.14 <- ggplot(aes(x = time, y = cumhaz), data = coxdata) + \n  geom_step(size = 1) + \n  xlab(\"Age (months)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     breaks = seq(0, 15, by = 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.1)), \n                     breaks = seq(0, 0.15, by = 0.05), \n                     labels = c(\"0\", \"0.05\", \"0.10\", \"0.15\")) +\n  theme_general\n\nfig2.14"
  },
  {
    "objectID": "Ch2.html#recurrent-episodes-in-affective-disorders",
    "href": "Ch2.html#recurrent-episodes-in-affective-disorders",
    "title": "2  Intuition for intensity models",
    "section": "Recurrent episodes in affective disorders",
    "text": "Recurrent episodes in affective disorders\n\nRead data\n\naffective <- data.frame(read.csv(\"data/affective.csv\"))\naffective$wait <- with(affective, stop - start)\n\n\n\nTable 2.14\n\n# Cox model for 1., 2., 3., 4. episode 'Markov': Column 1\nlibrary(survival)\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 1 & state == 0))\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 1 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.3552    1.4264   0.2500 1.421 0.155\n\nLikelihood ratio test=1.89  on 1 df, p=0.1692\nn= 116, number of events= 99 \n\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 2 & state == 0))\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 2 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.1890    1.2080   0.2604 0.726 0.468\n\nLikelihood ratio test=0.51  on 1 df, p=0.4751\nn= 91, number of events= 82 \n\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 3 & state == 0)) \n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 3 & state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)      z     p\nbip -0.1175    0.8891   0.3005 -0.391 0.696\n\nLikelihood ratio test=0.16  on 1 df, p=0.6936\nn= 74, number of events= 62 \n\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 4 & state == 0)) \n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 4 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z       p\nbip 1.1500    3.1581   0.3536 3.252 0.00114\n\nLikelihood ratio test=9.93  on 1 df, p=0.001623\nn= 56, number of events= 47 \n\n# Cox model for 1., 2., 3., 4. episode 'Gap time': Column 2\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 1 & state == 0)) \n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 1 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.3991    1.4905   0.2487 1.605 0.109\n\nLikelihood ratio test=2.39  on 1 df, p=0.1222\nn= 116, number of events= 99 \n\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                     data = subset(affective, episode == 2 & state == 0))\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 2 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)    z     p\nbip 0.2165    1.2418   0.2579 0.84 0.401\n\nLikelihood ratio test=0.68  on 1 df, p=0.41\nn= 91, number of events= 82 \n\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                     data = subset(affective, episode == 3 & state == 0)) \n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 3 & state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)      z     p\nbip -0.1114    0.8946   0.2867 -0.389 0.698\n\nLikelihood ratio test=0.15  on 1 df, p=0.6953\nn= 74, number of events= 62 \n\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                     data = subset(affective, episode == 4 & state == 0)) \n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 4 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.5964    1.8155   0.3183 1.874 0.061\n\nLikelihood ratio test=3.31  on 1 df, p=0.06905\nn= 56, number of events= 47 \n\n# AG cox model, total time\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, state == 0))\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)     z        p\nbip 0.36593   1.44186  0.09448 3.873 0.000107\n\nLikelihood ratio test=14.24  on 1 df, p=0.0001612\nn= 626, number of events= 542 \n\n# AG cox model, gap time\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                   data = subset(affective, state == 0))\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)     z     p\nbip 0.12555   1.13377  0.09445 1.329 0.184\n\nLikelihood ratio test=1.74  on 1 df, p=0.1875\nn= 626, number of events= 542 \n\n# PWP cox model, total time\ncoxph(Surv(start, stop, status == 1) ~ strata(episode) + bip, method = \"breslow\",\n                   data = subset(affective, state == 0)) \n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ strata(episode) + \n    bip, data = subset(affective, state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.2418    1.2736   0.1121 2.157 0.031\n\nLikelihood ratio test=4.54  on 1 df, p=0.03312\nn= 626, number of events= 542 \n\n# PWP cox model, gap time\ncoxph(Surv(wait, status == 1) ~ strata(episode) + bip, method = \"breslow\", \n                    data = subset(affective, state == 0)) \n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ strata(episode) + bip, \n    data = subset(affective, state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)     z     p\nbip 0.02781   1.02820  0.10040 0.277 0.782\n\nLikelihood ratio test=0.08  on 1 df, p=0.7821\nn= 626, number of events= 542"
  },
  {
    "objectID": "Ch2.html#exercises",
    "href": "Ch2.html#exercises",
    "title": "2  Intuition for intensity models",
    "section": "Exercises",
    "text": "Exercises\n\nExercise 2.1"
  },
  {
    "objectID": "Ch3.html#guinea-bissau-study",
    "href": "Ch3.html#guinea-bissau-study",
    "title": "3  Intensity models",
    "section": "Guinea-Bissau study",
    "text": "Guinea-Bissau study\n\nRead data\n\nbissau <- data.frame(read.csv(\"data/bissau.csv\"))\n# Variables for age as time scale and dtp binary\nbissau$agein  <- with(bissau, age/(365.24/12))\nbissau$ageout <- with(bissau, agein+fuptime/(365.24/12))\nbissau$dtpany <- 1*with(bissau, dtp>0)\n\n\n\nTable 3.1\n\ntable(bissau$bcg, bissau$dtp)\n\n   \n       0    1    2    3\n  0 1942   19    9    3\n  1 1159 1299  582  261\n\n100*table(bissau$bcg, bissau$dtp) / rowSums(table(bissau$bcg, bissau$dtp))\n\n   \n             0          1          2          3\n  0 98.4287886  0.9630005  0.4561581  0.1520527\n  1 35.1105726 39.3517116 17.6310209  7.9066949\n\n\n\n\nTable 3.2\n\nlibrary(survival)\ncoxph(Surv(agein,ageout,dead!=0)~bcg,data=bissau,method=\"breslow\",timefix=F)\n\nCall:\ncoxph(formula = Surv(agein, ageout, dead != 0) ~ bcg, data = bissau, \n    method = \"breslow\", timefix = F)\n\n       coef exp(coef) se(coef)      z      p\nbcg -0.3558    0.7006   0.1407 -2.529 0.0114\n\nLikelihood ratio test=6.28  on 1 df, p=0.01218\nn= 5274, number of events= 222 \n\ncoxph(Surv(agein,ageout,dead!=0)~dtpany,data=bissau,method=\"breslow\",timefix=F)\n\nCall:\ncoxph(formula = Surv(agein, ageout, dead != 0) ~ dtpany, data = bissau, \n    method = \"breslow\", timefix = F)\n\n           coef exp(coef) se(coef)      z     p\ndtpany -0.03855   0.96218  0.14904 -0.259 0.796\n\nLikelihood ratio test=0.07  on 1 df, p=0.7958\nn= 5274, number of events= 222 \n\ncoxph(Surv(agein,ageout,dead!=0)~bcg+dtpany,data=bissau,method=\"breslow\",timefix=F)\n\nCall:\ncoxph(formula = Surv(agein, ageout, dead != 0) ~ bcg + dtpany, \n    data = bissau, method = \"breslow\", timefix = F)\n\n          coef exp(coef) se(coef)      z      p\nbcg    -0.5585    0.5720   0.1924 -2.902 0.0037\ndtpany  0.3286    1.3890   0.2021  1.625 0.1041\n\nLikelihood ratio test=9.01  on 2 df, p=0.01106\nn= 5274, number of events= 222 \n\ncoxph(Surv(agein,ageout,dead!=0)~bcg*dtpany,data=bissau,method=\"breslow\",timefix=F)\n\nCall:\ncoxph(formula = Surv(agein, ageout, dead != 0) ~ bcg * dtpany, \n    data = bissau, method = \"breslow\", timefix = F)\n\n              coef exp(coef) se(coef)      z       p\nbcg        -0.5764    0.5619   0.2023 -2.849 0.00439\ndtpany      0.1252    1.1334   0.7178  0.174 0.86151\nbcg:dtpany  0.2212    1.2475   0.7429  0.298 0.76595\n\nLikelihood ratio test=9.1  on 3 df, p=0.02796\nn= 5274, number of events= 222"
  },
  {
    "objectID": "Ch3.html#pbc3-trial",
    "href": "Ch3.html#pbc3-trial",
    "title": "3  Intensity models",
    "section": "PBC3 trial",
    "text": "PBC3 trial\n\nRead data\n\npbc3 <- data.frame(read.csv(\"data/pbc3.csv\"))\npbc3$log2bili <- with(pbc3, log2(bili))\npbc3$years <- with(pbc3, days/365.25)\n\n\n\nTable 3.11\n\nlibrary(survival)\n# Treatment \ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(tment), \n      data = pbc3, tt = function(x,t, ...) (x==1)*t, method = \"breslow\")\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(tment), data = pbc3, tt = function(x, t, ...) (x == 1) * \n    t, method = \"breslow\")\n\n              coef exp(coef) se(coef)      z        p\ntment     -0.65937   0.51718  0.40576 -1.625    0.104\nalb       -0.09136   0.91269  0.02167 -4.216 2.49e-05\nlog2bili   0.66299   1.94059  0.07478  8.866  < 2e-16\ntt(tment)  0.04497   1.04600  0.17811  0.253    0.801\n\nLikelihood ratio test=120.1  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(tment), \n      data = pbc3, tt = function(x,t, ...) (x==1)*log(t), method = \"breslow\")\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(tment), data = pbc3, tt = function(x, t, ...) (x == 1) * \n    log(t), method = \"breslow\")\n\n              coef exp(coef) se(coef)      z        p\ntment     -0.61330   0.54156  0.24327 -2.521   0.0117\nalb       -0.09152   0.91254  0.02163 -4.232 2.32e-05\nlog2bili   0.66214   1.93894  0.07462  8.873  < 2e-16\ntt(tment)  0.10834   1.11442  0.25424  0.426   0.6700\n\nLikelihood ratio test=120.2  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(tment), \n      data = pbc3, tt = function(x,t, ...) (x==1)*(t>2), method = \"breslow\")\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(tment), data = pbc3, tt = function(x, t, ...) (x == 1) * \n    (t > 2), method = \"breslow\")\n\n              coef exp(coef) se(coef)      z        p\ntment     -0.58773   0.55559  0.29228 -2.011   0.0443\nalb       -0.09104   0.91298  0.02168 -4.199 2.68e-05\nlog2bili   0.66456   1.94363  0.07466  8.901  < 2e-16\ntt(tment)  0.03169   1.03220  0.43384  0.073   0.9418\n\nLikelihood ratio test=120  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n# Albumin \ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(alb), \n      data = pbc3, tt = function(x,t, ...) x*t, method = \"breslow\")\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(alb), data = pbc3, tt = function(x, t, ...) x * t, method = \"breslow\")\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.59080   0.55389  0.22472 -2.629 0.008562\nalb      -0.13296   0.87550  0.03998 -3.326 0.000882\nlog2bili  0.66405   1.94265  0.07476  8.882  < 2e-16\ntt(alb)   0.02317   1.02344  0.01854  1.250 0.211400\n\nLikelihood ratio test=121.6  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(alb), \n      data = pbc3, tt = function(x,t, ...) x*log(t), method = \"breslow\")\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(alb), data = pbc3, tt = function(x, t, ...) x * log(t), \n    method = \"breslow\")\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.58958   0.55456  0.22460 -2.625  0.00867\nalb      -0.10194   0.90308  0.02349 -4.341 1.42e-05\nlog2bili  0.66488   1.94425  0.07483  8.885  < 2e-16\ntt(alb)   0.03347   1.03404  0.02561  1.307  0.19120\n\nLikelihood ratio test=121.8  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(alb), \n      data = pbc3,  tt = function(x,t, ...) (x)*(t>2), method = \"breslow\")\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(alb), data = pbc3, tt = function(x, t, ...) (x) * (t > \n    2), method = \"breslow\")\n\n             coef exp(coef) se(coef)      z       p\ntment    -0.59037   0.55412  0.22472 -2.627 0.00861\nalb      -0.11369   0.89254  0.02779 -4.091 4.3e-05\nlog2bili  0.66488   1.94426  0.07470  8.901 < 2e-16\ntt(alb)   0.05674   1.05838  0.04330  1.310 0.19005\n\nLikelihood ratio test=121.8  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n# Log2 bilirubin\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(log2bili), \n      data = pbc3, tt = function(x,t, ...) x*t, method = \"breslow\")\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(log2bili), data = pbc3, tt = function(x, t, ...) x * t, \n    method = \"breslow\")\n\n                 coef exp(coef) se(coef)      z        p\ntment        -0.54631   0.57908  0.22571 -2.420   0.0155\nalb          -0.09009   0.91385  0.02173 -4.147 3.37e-05\nlog2bili      0.77736   2.17571  0.13382  5.809 6.28e-09\ntt(log2bili) -0.06299   0.93895  0.06181 -1.019   0.3081\n\nLikelihood ratio test=121.1  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(log2bili), \n      data = pbc3, tt = function(x,t, ...) x*log(t), method = \"breslow\")\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(log2bili), data = pbc3, tt = function(x, t, ...) x * log(t), \n    method = \"breslow\")\n\n                 coef exp(coef) se(coef)      z        p\ntment        -0.55398   0.57466  0.22536 -2.458    0.014\nalb          -0.09050   0.91347  0.02170 -4.170 3.04e-05\nlog2bili      0.68779   1.98931  0.07968  8.632  < 2e-16\ntt(log2bili) -0.07701   0.92588  0.08780 -0.877    0.380\n\nLikelihood ratio test=120.8  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(log2bili), \n      data = pbc3,  tt = function(x,t, ...) (x)*(t>2), method = \"breslow\")\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(log2bili), data = pbc3, tt = function(x, t, ...) (x) * \n    (t > 2), method = \"breslow\")\n\n                 coef exp(coef) se(coef)      z        p\ntment        -0.54878   0.57765  0.22521 -2.437   0.0148\nalb          -0.09045   0.91352  0.02176 -4.157 3.22e-05\nlog2bili      0.73519   2.08587  0.09487  7.750 9.22e-15\ntt(log2bili) -0.18232   0.83334  0.14910 -1.223   0.2214\n\nLikelihood ratio test=121.5  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)"
  },
  {
    "objectID": "Ch3.html#prova-trial",
    "href": "Ch3.html#prova-trial",
    "title": "3  Intensity models",
    "section": "PROVA trial",
    "text": "PROVA trial\n\nRead data\n\nprova <- data.frame(read.csv(\"data/prova.csv\", na.strings = c(\".\")))\n# Treatment 2x2 factorial\nprova$beh <- with(prova, as.factor(scle + beta*2))\n# Extra variables\nprovany <- prova\nprovany$log2bili <- with(provany, log2(bili))\nprovany$btime    <- ifelse(provany$bleed == 1, provany$timebleed, provany$timedeath)\nprovany$d0time   <- ifelse(provany$bleed == 1, provany$timebleed, provany$timedeath)\nprovany$dead0    <- ifelse(provany$bleed == 1, 0, provany$death)\nprovany$outof0   <- ifelse(provany$bleed == 1, 1, provany$death)\nprovany$bdtime   <- ifelse(provany$bleed == 1, provany$timedeath, NA)\nprovany$deadb    <- ifelse(provany$bleed == 1, provany$death, NA)\nprovany$wait     <- ifelse(provany$bleed == 1, provany$bdtime - provany$timebleed, NA)\n\n\n\nTable 3.3\n\nlibrary(survival)\noptions(contrasts=c(\"contr.treatment\", \"contr.poly\"))\n\n## Column 1\n# Variceal bleeding\ncoxph(Surv(btime, bleed) ~ beh, data = provany, ties = \"breslow\")\n\nCall:\ncoxph(formula = Surv(btime, bleed) ~ beh, data = provany, ties = \"breslow\")\n\n         coef exp(coef) se(coef)      z     p\nbeh1  0.05563   1.05721  0.39235  0.142 0.887\nbeh2 -0.03972   0.96106  0.40039 -0.099 0.921\nbeh3 -0.03205   0.96846  0.40063 -0.080 0.936\n\nLikelihood ratio test=0.07  on 3 df, p=0.9951\nn= 286, number of events= 50 \n\n# Death without bleeding\ncoxph(Surv(d0time, dead0) ~ beh, data = provany, ties = \"breslow\")\n\nCall:\ncoxph(formula = Surv(d0time, dead0) ~ beh, data = provany, ties = \"breslow\")\n\n        coef exp(coef) se(coef)      z      p\nbeh1  0.5993    1.8208   0.4498  1.332 0.1828\nbeh2 -0.4307    0.6501   0.5701 -0.755 0.4500\nbeh3  1.0146    2.7582   0.4189  2.422 0.0154\n\nLikelihood ratio test=12.74  on 3 df, p=0.005244\nn= 286, number of events= 46 \n\n# logrank test: Variceal bleeding\nlr<-survdiff(Surv(btime, bleed) ~ beh, data = provany)\nc(lr$chisq,lr$pvalue)\n\n[1] 0.07114524 0.99505932\n\n# logrank test: Death without bleeding\nlr<-survdiff(Surv(d0time, dead0) ~ beh, data = provany)\nc(lr$chisq,lr$pvalue)\n\n[1] 12.856428541  0.004957601\n\n## Column 2\n# Variceal bleeding\ncoxph(Surv(btime, bleed) ~ beh + sex + coag + log2bili + factor(varsize),\n      data = provany, ties = \"breslow\")\n\nCall:\ncoxph(formula = Surv(btime, bleed) ~ beh + sex + coag + log2bili + \n    factor(varsize), data = provany, ties = \"breslow\")\n\n                      coef exp(coef)  se(coef)      z        p\nbeh1              0.176844  1.193445  0.433336  0.408  0.68320\nbeh2              0.207005  1.229989  0.424001  0.488  0.62539\nbeh3              0.030562  1.031034  0.420784  0.073  0.94210\nsex              -0.025865  0.974467  0.329095 -0.079  0.93736\ncoag             -0.020647  0.979565  0.007819 -2.641  0.00827\nlog2bili          0.191011  1.210473  0.149142  1.281  0.20029\nfactor(varsize)2  0.741460  2.098998  0.414959  1.787  0.07397\nfactor(varsize)3  1.884681  6.584252  0.442325  4.261 2.04e-05\n\nLikelihood ratio test=37.67  on 8 df, p=8.654e-06\nn= 271, number of events= 47 \n   (15 observations deleted due to missingness)\n\n# Death without bleeding\ncox1<-coxph(Surv(d0time, dead0) ~ beh + sex + coag + log2bili + factor(varsize),\n                    data = provany, ties = \"breslow\")\ncox1\n\nCall:\ncoxph(formula = Surv(d0time, dead0) ~ beh + sex + coag + log2bili + \n    factor(varsize), data = provany, ties = \"breslow\")\n\n                      coef exp(coef)  se(coef)      z       p\nbeh1              0.826468  2.285233  0.458574  1.802 0.07151\nbeh2             -0.159630  0.852459  0.575047 -0.278 0.78132\nbeh3              0.910385  2.485279  0.420391  2.166 0.03034\nsex               0.841579  2.320027  0.415722  2.024 0.04293\ncoag             -0.008112  0.991920  0.006804 -1.192 0.23312\nlog2bili          0.445359  1.561051  0.136749  3.257 0.00113\nfactor(varsize)2  0.221738  1.248245  0.347159  0.639 0.52300\nfactor(varsize)3  0.753294  2.123984  0.448544  1.679 0.09307\n\nLikelihood ratio test=42.13  on 8 df, p=1.283e-06\nn= 271, number of events= 46 \n   (15 observations deleted due to missingness)\n\n# Death without bleeding - reduced model\ncox2<-coxph(Surv(d0time, dead0) ~ scle + beta + sex + coag + log2bili + factor(varsize),\n                    data = provany, ties = \"breslow\")\ncox2\n\nCall:\ncoxph(formula = Surv(d0time, dead0) ~ scle + beta + sex + coag + \n    log2bili + factor(varsize), data = provany, ties = \"breslow\")\n\n                      coef exp(coef)  se(coef)      z       p\nscle              0.939205  2.557946  0.335429  2.800 0.00511\nbeta              0.011998  1.012071  0.305720  0.039 0.96869\nsex               0.850389  2.340557  0.415216  2.048 0.04055\ncoag             -0.008157  0.991876  0.006776 -1.204 0.22862\nlog2bili          0.451920  1.571327  0.135600  3.333 0.00086\nfactor(varsize)2  0.230482  1.259207  0.346233  0.666 0.50561\nfactor(varsize)3  0.758804  2.135719  0.448553  1.692 0.09071\n\nLikelihood ratio test=42  on 7 df, p=5.204e-07\nn= 271, number of events= 46 \n   (15 observations deleted due to missingness)\n\n# LRT reduced model\nlibrary(lmtest)\nlrtest(cox1,cox2)\n\nLikelihood ratio test\n\nModel 1: Surv(d0time, dead0) ~ beh + sex + coag + log2bili + factor(varsize)\nModel 2: Surv(d0time, dead0) ~ scle + beta + sex + coag + log2bili + factor(varsize)\n  #Df  LogLik Df Chisq Pr(>Chisq)\n1   8 -216.13                    \n2   7 -216.19 -1 0.127     0.7215\n\n# Death without bleeding - 'final model'\ncox3<-coxph(Surv(d0time, dead0) ~ scle + sex + coag + log2bili + factor(varsize),\n      data = provany, ties = \"breslow\")\n\ncox3\n\nCall:\ncoxph(formula = Surv(d0time, dead0) ~ scle + sex + coag + log2bili + \n    factor(varsize), data = provany, ties = \"breslow\")\n\n                      coef exp(coef)  se(coef)      z        p\nscle              0.941366  2.563481  0.330894  2.845 0.004442\nsex               0.849376  2.338188  0.414391  2.050 0.040394\ncoag             -0.008139  0.991894  0.006750 -1.206 0.227935\nlog2bili          0.452745  1.572624  0.133959  3.380 0.000726\nfactor(varsize)2  0.231860  1.260943  0.344458  0.673 0.500875\nfactor(varsize)3  0.760486  2.139316  0.446540  1.703 0.088556\n\nLikelihood ratio test=42  on 6 df, p=1.841e-07\nn= 271, number of events= 46 \n   (15 observations deleted due to missingness)\n\nlrtest(cox2,cox3)\n\nLikelihood ratio test\n\nModel 1: Surv(d0time, dead0) ~ scle + beta + sex + coag + log2bili + factor(varsize)\nModel 2: Surv(d0time, dead0) ~ scle + sex + coag + log2bili + factor(varsize)\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   7 -216.19                     \n2   6 -216.19 -1 0.0015     0.9687\n\n\n\n\nTable 3.4\n\n# Composite\ncox<-coxph(Surv(btime, outof0) ~ beh + sex + coag + log2bili + factor(varsize),\n      data = provany, ties = \"breslow\")\ncox\n\nCall:\ncoxph(formula = Surv(btime, outof0) ~ beh + sex + coag + log2bili + \n    factor(varsize), data = provany, ties = \"breslow\")\n\n                      coef exp(coef)  se(coef)      z        p\nbeh1              0.525145  1.690704  0.312502  1.680  0.09287\nbeh2              0.100189  1.105380  0.337918  0.296  0.76686\nbeh3              0.494807  1.640181  0.291638  1.697  0.08976\nsex               0.360259  1.433701  0.253379  1.422  0.15508\ncoag             -0.013600  0.986492  0.005287 -2.572  0.01010\nlog2bili          0.328376  1.388711  0.101761  3.227  0.00125\nfactor(varsize)2  0.446403  1.562681  0.263275  1.696  0.08997\nfactor(varsize)3  1.332535  3.790639  0.301391  4.421 9.81e-06\n\nLikelihood ratio test=65.71  on 8 df, p=3.489e-11\nn= 271, number of events= 93 \n   (15 observations deleted due to missingness)\n\n# LRT for treatment\ncoxreduced<-coxph(Surv(btime, outof0) ~ sex + coag + log2bili + factor(varsize),\n      data = provany, ties = \"breslow\")\nlrtest(cox,coxreduced)\n\nLikelihood ratio test\n\nModel 1: Surv(btime, outof0) ~ beh + sex + coag + log2bili + factor(varsize)\nModel 2: Surv(btime, outof0) ~ sex + coag + log2bili + factor(varsize)\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   8 -455.35                     \n2   5 -457.74 -3 4.7717     0.1893\n\n\n\n\nTable 3.8\n\n# Time since randomization (tsr)\n# Column 1\ncoxtsr<-coxph(Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili, \n              data = provany, ties = \"breslow\")\ncoxtsr\n\nCall:\ncoxph(formula = Surv(btime, bdtime, deadb != 0) ~ beh + sex + \n    log2bili, data = provany, ties = \"breslow\")\n\n            coef exp(coef) se(coef)      z       p\nbeh0     -0.7327    0.4806   0.5439 -1.347 0.17796\nbeh1     -2.1454    0.1170   0.7046 -3.045 0.00233\nbeh2     -0.8472    0.4286   0.5694 -1.488 0.13674\nsex       1.1389    3.1234   0.5039  2.260 0.02380\nlog2bili  0.1088    1.1149   0.2075  0.524 0.60011\n\nLikelihood ratio test=15.35  on 5 df, p=0.008958\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\ncoxtsr0<-coxph(Surv(btime, bdtime, deadb != 0) ~ sex + log2bili, \n              data = provany, ties = \"breslow\")\ncoxtsr0\n\nCall:\ncoxph(formula = Surv(btime, bdtime, deadb != 0) ~ sex + log2bili, \n    data = provany, ties = \"breslow\")\n\n            coef exp(coef) se(coef)      z      p\nsex       0.9095    2.4830   0.4807  1.892 0.0585\nlog2bili -0.1618    0.8506   0.1826 -0.886 0.3758\n\nLikelihood ratio test=4.19  on 2 df, p=0.1232\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n# LRT for beh\nlibrary(lmtest)\nlrtest(coxtsr,coxtsr0)\n\nLikelihood ratio test\n\nModel 1: Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili\nModel 2: Surv(btime, bdtime, deadb != 0) ~ sex + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)  \n1   5 -59.626                       \n2   2 -65.208 -3 11.164    0.01087 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\ncoxnoint<-coxph(Surv(btime, bdtime, deadb != 0) ~ scle + beta  + sex + log2bili, \n              data = provany, ties = \"breslow\")\n# LRT interaction\nlrtest(coxtsr,coxnoint)\n\nLikelihood ratio test\n\nModel 1: Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili\nModel 2: Surv(btime, bdtime, deadb != 0) ~ scle + beta + sex + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)   \n1   5 -59.626                        \n2   4 -63.061 -1 6.8707   0.008762 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n# Column 2\nprovany$tsb<-provany$btime\ncoxtsr_tt<-coxph(Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili+tt(tsb), \n      data = provany, ties = \"breslow\",\n      tt=function(x, t, ...) {\n        dt <- t-x\n        cbind(dt1=1*(dt<5), dt2=1*(dt>=5 & dt<10))\n      })\ncoxtsr_tt\n\nCall:\ncoxph(formula = Surv(btime, bdtime, deadb != 0) ~ beh + sex + \n    log2bili + tt(tsb), data = provany, ties = \"breslow\", tt = function(x, \n    t, ...) {\n    dt <- t - x\n    cbind(dt1 = 1 * (dt < 5), dt2 = 1 * (dt >= 5 & dt < 10))\n})\n\n               coef exp(coef) se(coef)      z        p\nbeh0       -0.42544   0.65348  0.61129 -0.696  0.48645\nbeh1       -1.58150   0.20567  0.75830 -2.086  0.03702\nbeh2       -0.44915   0.63817  0.63022 -0.713  0.47604\nsex         1.11875   3.06103  0.53261  2.101  0.03568\nlog2bili   -0.04822   0.95292  0.22285 -0.216  0.82869\ntt(tsb)dt1  2.94285  18.96981  0.73891  3.983 6.81e-05\ntt(tsb)dt2  2.34525  10.43583  0.80285  2.921  0.00349\n\nLikelihood ratio test=33.65  on 7 df, p=2.005e-05\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n# LRT for time-dependent covariates\nlrtest(coxtsr,coxtsr_tt)\n\nLikelihood ratio test\n\nModel 1: Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili\nModel 2: Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili + tt(tsb)\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   5 -59.626                         \n2   7 -50.478  2 18.295  0.0001065 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n# or as mentioned in text, model linear effect of time-dependent covariate\ncoxph(Surv(btime, bdtime, deadb != 0) ~ beh+sex + log2bili+tt(tsb), \n      data = provany, ties = \"breslow\",\n      tt=function(x, t, ...){t-x})\n\nCall:\ncoxph(formula = Surv(btime, bdtime, deadb != 0) ~ beh + sex + \n    log2bili + tt(tsb), data = provany, ties = \"breslow\", tt = function(x, \n    t, ...) {\n    t - x\n})\n\n              coef exp(coef)  se(coef)      z       p\nbeh0     -0.599364  0.549161  0.574135 -1.044 0.29651\nbeh1     -2.061624  0.127247  0.724588 -2.845 0.00444\nbeh2     -0.627738  0.533798  0.618629 -1.015 0.31024\nsex       0.899664  2.458776  0.530853  1.695 0.09012\nlog2bili  0.349775  1.418749  0.224830  1.556 0.11977\ntt(tsb)  -0.005179  0.994834  0.001769 -2.927 0.00342\n\nLikelihood ratio test=25.54  on 6 df, p=0.0002708\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\ncoxtsr_tt_reduced<-coxph(Surv(btime, bdtime, deadb != 0) ~ sex + log2bili+tt(tsb), \n                 data = provany, ties = \"breslow\",\n                 tt=function(x, t, ...) {\n                   dt <- t-x\n                   cbind(dt1=1*(dt<5), dt2=1*(dt>=5 & dt<10))\n                 })\ncoxtsr_tt_reduced\n\nCall:\ncoxph(formula = Surv(btime, bdtime, deadb != 0) ~ sex + log2bili + \n    tt(tsb), data = provany, ties = \"breslow\", tt = function(x, \n    t, ...) {\n    dt <- t - x\n    cbind(dt1 = 1 * (dt < 5), dt2 = 1 * (dt >= 5 & dt < 10))\n})\n\n              coef exp(coef) se(coef)      z        p\nsex         0.8381    2.3120   0.4977  1.684  0.09219\nlog2bili   -0.2288    0.7955   0.1965 -1.164  0.24434\ntt(tsb)dt1  3.1553   23.4609   0.6683  4.721 2.34e-06\ntt(tsb)dt2  2.3585   10.5748   0.7857  3.002  0.00268\n\nLikelihood ratio test=28.44  on 4 df, p=1.015e-05\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n# LRT for beh\nlrtest(coxtsr_tt,coxtsr_tt_reduced)\n\nLikelihood ratio test\n\nModel 1: Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili + tt(tsb)\nModel 2: Surv(btime, bdtime, deadb != 0) ~ sex + log2bili + tt(tsb)\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   7 -50.478                     \n2   4 -53.081 -3 5.2064     0.1573\n\n# Duration\n# Column 1\ncoxdur<-coxph(Surv(wait, deadb != 0) ~ beh + sex + log2bili,\n              data = provany, ties = \"breslow\")\ncoxdur\n\nCall:\ncoxph(formula = Surv(wait, deadb != 0) ~ beh + sex + log2bili, \n    data = provany, ties = \"breslow\")\n\n            coef exp(coef) se(coef)      z       p\nbeh0     -0.8708    0.4186   0.5136 -1.695 0.08999\nbeh1     -1.8679    0.1544   0.6373 -2.931 0.00338\nbeh2     -1.1704    0.3103   0.5915 -1.979 0.04785\nsex       0.6497    1.9149   0.5264  1.234 0.21712\nlog2bili  0.2677    1.3070   0.1790  1.496 0.13463\n\nLikelihood ratio test=13.24  on 5 df, p=0.0212\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\ncoxdur0<-coxph(Surv(wait, deadb != 0) ~ sex + log2bili,\n              data = provany, ties = \"breslow\")\ncoxdur0\n\nCall:\ncoxph(formula = Surv(wait, deadb != 0) ~ sex + log2bili, data = provany, \n    ties = \"breslow\")\n\n           coef exp(coef) se(coef)     z     p\nsex      0.6742    1.9625   0.4662 1.446 0.148\nlog2bili 0.1210    1.1286   0.1677 0.721 0.471\n\nLikelihood ratio test=3.03  on 2 df, p=0.2195\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n# LRT for beh\nlrtest(coxdur,coxdur0)\n\nLikelihood ratio test\n\nModel 1: Surv(wait, deadb != 0) ~ beh + sex + log2bili\nModel 2: Surv(wait, deadb != 0) ~ sex + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)  \n1   5 -86.494                       \n2   2 -91.600 -3 10.211    0.01685 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n# Column 2\nprovany$tsr<-provany$btime\ncoxdur_tt<-coxph(Surv(wait, deadb != 0) ~ beh + sex + log2bili+tt(tsr),\n      data = provany, ties = \"breslow\",\n      tt=function(x, t, ...) {\n        dt <- x+t\n        cbind(v1=1*(dt<1*365.25), v2=1*(dt>=1*365.25 & dt<2*365.25))\n      })\ncoxdur_tt\n\nCall:\ncoxph(formula = Surv(wait, deadb != 0) ~ beh + sex + log2bili + \n    tt(tsr), data = provany, ties = \"breslow\", tt = function(x, \n    t, ...) {\n    dt <- x + t\n    cbind(v1 = 1 * (dt < 1 * 365.25), v2 = 1 * (dt >= 1 * 365.25 & \n        dt < 2 * 365.25))\n})\n\n             coef exp(coef) se(coef)      z       p\nbeh0      -0.8467    0.4288   0.5244 -1.615 0.10639\nbeh1      -1.8660    0.1547   0.6400 -2.916 0.00355\nbeh2      -1.1583    0.3140   0.5964 -1.942 0.05211\nsex        0.6441    1.9043   0.5303  1.215 0.22455\nlog2bili   0.2829    1.3269   0.1966  1.439 0.15012\ntt(tsr)v1 -0.1723    0.8417   0.9096 -0.189 0.84973\ntt(tsr)v2 -0.2211    0.8016   0.8862 -0.250 0.80297\n\nLikelihood ratio test=13.31  on 7 df, p=0.065\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n# LRT for time-dependent covariates\nlrtest(coxdur,coxdur_tt)\n\nLikelihood ratio test\n\nModel 1: Surv(wait, deadb != 0) ~ beh + sex + log2bili\nModel 2: Surv(wait, deadb != 0) ~ beh + sex + log2bili + tt(tsr)\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   5 -86.494                     \n2   7 -86.464  2 0.0618     0.9696\n\ncoxdur_tt_reduced<-coxph(Surv(btime, bdtime, deadb != 0) ~ sex + log2bili+tt(tsb), \n                         data = provany, ties = \"breslow\",\n                         tt=function(x, t, ...) {\n                           dt <- t-x\n                           cbind(dt1=1*(dt<5), dt2=1*(dt>=5 & dt<10))\n                         })\n\n\n\nFigure 3.2\n\n# Plotting style \nlibrary(ggplot2)\nlibrary(tidyverse)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\n# Make zeros print as \"0\" always for plot axes\nlibrary(stringr)\nprettyZero <- function(l){\n  max.decimals = max(nchar(str_extract(l, \"\\\\.[0-9]+\")), na.rm = T)-1\n  lnew = formatC(l, replace.zero = T, zero.print = \"0\",\n                 digits = max.decimals, format = \"f\", preserve.width=T)\n  return(lnew)\n}\n\n# Extract cumulative baseline hazard\ncoxcumhaz <- survfit(coxtsr, \n                     newdata = data.frame(sex = 0, \n                                          beh = \"0\", \n                                          log2bili = 0))\n\n# Collect data for plot\ncoxdata <- data.frame(cumhaz = append(0,coxcumhaz$cumhaz), \n                      time = append(0,coxcumhaz$time), \n                      type = rep(\"Breslow estimate\", 1+length(coxcumhaz$time)))\n\n# Create Figure 3.2\nfig3.2 <- ggplot(aes(x = time / 365.25, y = cumhaz), data = coxdata) + \n  geom_step(linewidth = 1) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general\n\nfig3.2\n\n\n\n\n\n\nFigure 3.3\n\n# Extract cumulative baseline hazard\ncoxcumhaz <- survfit(coxdur, \n                     newdata = data.frame(sex = 0, \n                                          beh = \"0\", \n                                          log2bili = 0))\n# Collect data for plot\ncoxdata <- data.frame(cumhaz = append(0,coxcumhaz$cumhaz), \n                      time = append(0,coxcumhaz$time), \n                      type = rep(\"Breslow estimate\", 1+length(coxcumhaz$time)))\n\n# Create Figure 3.3\nfig3.3 <- ggplot(aes(x = time / 365.25, y = cumhaz), data = coxdata) + \n  geom_step(linewidth = 1) + \n  xlab(\"Duration (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), ) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)),labels = prettyZero) +\n  theme_general\n\nfig3.3\n\n\n\n\n\n\nTable 3.9\n\n# All bleeds\nprovasplit11 <- subset(provany, bleed == 1)\n# Split by duration\nprovasplit1 <- survSplit(Surv(wait, deadb != 0) ~ ., data = provasplit11, \n                           cut = c(5, 10),\n                           episode = \"wint\")\nprovasplit1$start <- with(provasplit1, \n                            btime + ifelse(wint == 1, 0, ifelse(wint == 2, 5 , 10))\n                            )\nprovasplit1$stop <- with(provasplit1, btime + wait)\nprovasplit1$risktime <- with(provasplit1, wait - tstart)\nprovasplit1$logrisktime <- log(provasplit1$risktime)\nprovasplit1$fail <- provasplit1$event\n\n# Split by time since rand (t)\nprovasplit2 <- survSplit(Surv(start, stop, fail) ~ ., data = provasplit1, \n                           cut = c((1) * 365.25, (2) * 365.25),\n                           episode = \"tint\")\n\nprovasplit2$risktime2 <- with(provasplit2, stop - start)\nprovasplit2$risktimeys2 <- provasplit2$risktime2 / 365.25\n  \nprovasplit2$logrisktime2 <- log(provasplit2$risktime2)\nprovasplit2$fail2 <- provasplit2$fail\n\n# Summarize the data, Table 3.9 output\naggregate(cbind(fail2, risktimeys2) ~ tint + wint, provasplit2, \n          FUN = function(x) c(count = length(x),\n                              sum = sum(x)))\n\n  tint wint fail2.count fail2.sum risktimeys2.count risktimeys2.sum\n1    1    1          39         8       39.00000000      0.46338125\n2    2    1          11         2       11.00000000      0.13073238\n3    3    1           1         0        1.00000000      0.01368925\n4    1    2          30         2       30.00000000      0.38603696\n5    2    2           9         1        9.00000000      0.11635866\n6    3    2           1         0        1.00000000      0.01368925\n7    1    3          28         7       28.00000000     12.42984257\n8    2    3          28         5       28.00000000     19.88227242\n9    3    3          19         4       19.00000000     21.56468172\n\n\n\n\nTable 3.10\n\n# part (a)\nsummary(glm(fail ~ offset(log(risktime)) + beh + relevel(as.factor(wint), ref = \"3\") + \n              sex + log2bili, data = provasplit1, family = poisson))\n\n\nCall:\nglm(formula = fail ~ offset(log(risktime)) + beh + relevel(as.factor(wint), \n    ref = \"3\") + sex + log2bili, family = poisson, data = provasplit1)\n\nCoefficients:\n                                     Estimate Std. Error z value Pr(>|z|)    \n(Intercept)                           -8.8925     1.1282  -7.882 3.21e-15 ***\nbeh1                                  -1.1301     0.6423  -1.759   0.0785 .  \nbeh2                                  -0.3138     0.5887  -0.533   0.5940    \nbeh3                                   0.9667     0.5157   1.874   0.0609 .  \nrelevel(as.factor(wint), ref = \"3\")1   3.6024     0.4387   8.212  < 2e-16 ***\nrelevel(as.factor(wint), ref = \"3\")2   2.8437     0.6373   4.462 8.11e-06 ***\nsex                                    0.7327     0.5190   1.412   0.1581    \nlog2bili                               0.2877     0.1824   1.577   0.1147    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 225.56  on 122  degrees of freedom\nResidual deviance: 149.88  on 115  degrees of freedom\n  (4 observations deleted due to missingness)\nAIC: 219.88\n\nNumber of Fisher Scoring iterations: 8\n\n# part (b)\nsummary(glm(fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(tint), ref = \"3\") + \n              sex + log2bili, data = provasplit2, family = poisson))\n\n\nCall:\nglm(formula = fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(tint), \n    ref = \"3\") + sex + log2bili, family = poisson, data = provasplit2)\n\nCoefficients:\n                                     Estimate Std. Error z value Pr(>|z|)    \n(Intercept)                           -8.6775     1.2008  -7.226 4.96e-13 ***\nbeh1                                  -1.2810     0.6522  -1.964   0.0495 *  \nbeh2                                  -0.4317     0.5657  -0.763   0.4454    \nbeh3                                   0.8006     0.5254   1.524   0.1275    \nrelevel(as.factor(tint), ref = \"3\")1   1.5068     0.5785   2.605   0.0092 ** \nrelevel(as.factor(tint), ref = \"3\")2   0.4304     0.6482   0.664   0.5067    \nsex                                    0.9494     0.4922   1.929   0.0538 .  \nlog2bili                               0.1792     0.2049   0.875   0.3817    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 237.84  on 160  degrees of freedom\nResidual deviance: 202.95  on 153  degrees of freedom\n  (5 observations deleted due to missingness)\nAIC: 272.95\n\nNumber of Fisher Scoring iterations: 8\n\n# part (c)\nsummary(glm(fail2 ~ offset(log(risktime2)) + beh + \n              relevel(as.factor(wint), ref = \"3\") +\n              relevel(as.factor(tint), ref = \"3\") +\n              sex + log2bili, data = provasplit2, family = poisson))\n\n\nCall:\nglm(formula = fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(wint), \n    ref = \"3\") + relevel(as.factor(tint), ref = \"3\") + sex + \n    log2bili, family = poisson, data = provasplit2)\n\nCoefficients:\n                                     Estimate Std. Error z value Pr(>|z|)    \n(Intercept)                           -8.9276     1.1636  -7.673 1.68e-14 ***\nbeh1                                  -1.1101     0.6475  -1.714   0.0864 .  \nbeh2                                  -0.3181     0.5788  -0.550   0.5826    \nbeh3                                   0.8260     0.5138   1.608   0.1079    \nrelevel(as.factor(wint), ref = \"3\")1   3.3500     0.4641   7.219 5.25e-13 ***\nrelevel(as.factor(wint), ref = \"3\")2   2.5827     0.6593   3.917 8.97e-05 ***\nrelevel(as.factor(tint), ref = \"3\")1   0.7325     0.6176   1.186   0.2356    \nrelevel(as.factor(tint), ref = \"3\")2   0.1889     0.6546   0.289   0.7729    \nsex                                    0.7672     0.5090   1.507   0.1317    \nlog2bili                               0.2301     0.1900   1.211   0.2260    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 237.84  on 160  degrees of freedom\nResidual deviance: 160.21  on 151  degrees of freedom\n  (5 observations deleted due to missingness)\nAIC: 234.21\n\nNumber of Fisher Scoring iterations: 7\n\n# Interaction model, in-text but not shown\nsummary(glm(fail2 ~ offset(log(risktime2)) + beh + as.factor(tint) * as.factor(wint) + sex + log2bili, \n            data = provasplit2, family = poisson)\n)\n\n\nCall:\nglm(formula = fail2 ~ offset(log(risktime2)) + beh + as.factor(tint) * \n    as.factor(wint) + sex + log2bili, family = poisson, data = provasplit2)\n\nCoefficients:\n                                    Estimate Std. Error z value Pr(>|z|)    \n(Intercept)                         -4.72678    1.20626  -3.919 8.91e-05 ***\nbeh1                                -1.09421    0.64703  -1.691   0.0908 .  \nbeh2                                -0.31016    0.57923  -0.535   0.5923    \nbeh3                                 0.83850    0.51484   1.629   0.1034    \nas.factor(tint)2                    -0.74368    1.06413  -0.699   0.4846    \nas.factor(tint)3                   -14.39376 1275.75399  -0.011   0.9910    \nas.factor(wint)2                    -1.03184    0.79349  -1.300   0.1935    \nas.factor(wint)3                    -3.37183    0.51906  -6.496 8.24e-11 ***\nsex                                  0.77074    0.50839   1.516   0.1295    \nlog2bili                             0.21347    0.18999   1.124   0.2612    \nas.factor(tint)2:as.factor(wint)2    1.26419    1.62046   0.780   0.4353    \nas.factor(tint)3:as.factor(wint)2    1.03184 1804.18859   0.001   0.9995    \nas.factor(tint)2:as.factor(wint)3    0.08176    1.23780   0.066   0.9473    \nas.factor(tint)3:as.factor(wint)3   13.70295 1275.75414   0.011   0.9914    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 237.84  on 160  degrees of freedom\nResidual deviance: 158.93  on 147  degrees of freedom\n  (5 observations deleted due to missingness)\nAIC: 240.93\n\nNumber of Fisher Scoring iterations: 13\n\n# LRT for time-dependent covariates\nglmboth<-glm(fail2 ~ offset(log(risktime2)) + beh + \n               relevel(as.factor(wint), ref = \"3\") +\n               relevel(as.factor(tint), ref = \"3\") +\n               sex + log2bili, data = provasplit2, family = poisson)\nglmwint<-glm(fail2 ~ offset(log(risktime2)) + beh + \n               relevel(as.factor(wint), ref = \"3\") +\n               sex + log2bili, data = provasplit2, family = poisson)\nglmtint<-glm(fail2 ~ offset(log(risktime2)) + beh + \n               relevel(as.factor(tint), ref = \"3\") +\n               sex + log2bili, data = provasplit2, family = poisson)\n# LRT effect of duration since bleeding\nlrtest(glmboth,glmtint)\n\nLikelihood ratio test\n\nModel 1: fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(wint), \n    ref = \"3\") + relevel(as.factor(tint), ref = \"3\") + sex + \n    log2bili\nModel 2: fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(tint), \n    ref = \"3\") + sex + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1  10 -107.11                         \n2   8 -128.47 -2 42.736  5.248e-10 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n# LRT effect of time since randomization\nlrtest(glmboth,glmwint)\n\nLikelihood ratio test\n\nModel 1: fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(wint), \n    ref = \"3\") + relevel(as.factor(tint), ref = \"3\") + sex + \n    log2bili\nModel 2: fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(wint), \n    ref = \"3\") + sex + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1  10 -107.11                     \n2   8 -108.08 -2 1.9499     0.3772\n\n\n\n\nTable 3.13\n\n# Prepare data set for analysis - double\ndouble1 <- provany %>% mutate(time = d0time, \n                              status = dead0, \n                              entrytime = 0, \n                              sex1 = sex, \n                              sex2 = 0, \n                              age1 = age, \n                              age2 = 0, \n                              bili1 = log2bili, \n                              bili2 = log2bili * 0,\n                              stratum = 1)\n\ndouble2 <- provany %>% filter(bleed == 1) %>% \n                       mutate(time = bdtime, \n                              status = deadb, \n                              entrytime = btime, \n                              sex1 = 0, \n                              sex2 = sex, \n                              age1 = 0, \n                              age2 = age, \n                              bili1 = log2bili * 0, \n                              bili2 = log2bili,\n                              stratum = 2)\ndouble <- as.data.frame(rbind(double1, double2))\n\n# part (a)\nTable3.13a <- coxph(Surv(entrytime, time, status != 0) ~ strata(stratum) + sex1 + sex2 + bili1 + bili2, \n            data = double, ties = \"breslow\")\nTable3.13a\n\nCall:\ncoxph(formula = Surv(entrytime, time, status != 0) ~ strata(stratum) + \n    sex1 + sex2 + bili1 + bili2, data = double, ties = \"breslow\")\n\n         coef exp(coef) se(coef)      z        p\nsex1   1.0408    2.8316   0.4110  2.532   0.0113\nsex2   0.9095    2.4830   0.4807  1.892   0.0585\nbili1  0.5275    1.6947   0.1152  4.580 4.64e-06\nbili2 -0.1618    0.8506   0.1826 -0.886   0.3758\n\nLikelihood ratio test=32.5  on 4 df, p=1.509e-06\nn= 323, number of events= 73 \n   (13 observations deleted due to missingness)\n\n# part (b)\nTable3.13b <- coxph(Surv(entrytime, time, status != 0) ~ strata(stratum) + sex + bili1 + bili2, \n            data = double, ties = \"breslow\")\nTable3.13b\n\nCall:\ncoxph(formula = Surv(entrytime, time, status != 0) ~ strata(stratum) + \n    sex + bili1 + bili2, data = double, ties = \"breslow\")\n\n         coef exp(coef) se(coef)      z        p\nsex    0.9866    2.6820   0.3115  3.167  0.00154\nbili1  0.5269    1.6936   0.1150  4.582 4.61e-06\nbili2 -0.1685    0.8449   0.1794 -0.939  0.34767\n\nLikelihood ratio test=32.46  on 3 df, p=4.185e-07\nn= 323, number of events= 73 \n   (13 observations deleted due to missingness)\n\n# part (c)\nTable3.13c <- coxph(Surv(entrytime, time, status != 0) ~ strata(stratum) + sex + bili1, \n            data = double, ties = \"breslow\")\nTable3.13c\n\nCall:\ncoxph(formula = Surv(entrytime, time, status != 0) ~ strata(stratum) + \n    sex + bili1, data = double, ties = \"breslow\")\n\n        coef exp(coef) se(coef)     z        p\nsex   0.9423    2.5659   0.3072 3.067  0.00216\nbili1 0.5263    1.6927   0.1149 4.582 4.61e-06\n\nLikelihood ratio test=31.58  on 2 df, p=1.387e-07\nn= 323, number of events= 73 \n   (13 observations deleted due to missingness)\n\n\n\n\nFigure 3.9\n\n# Extract cumulative hazard from r1 \nsurvr1 <- basehaz(Table3.13a, center = F)\npcumhaz <- data.frame(\n  cumhaz = c(survr1$hazard[survr1$strata==\"stratum=1\"],0,survr1$hazard[survr1$strata==\"stratum=2\"]), \n  time   = c(survr1$time[survr1$strata==\"stratum=1\"],0,survr1$time[survr1$strata==\"stratum=2\"]), \n  strata = c(survr1$strata[survr1$strata==\"stratum=1\"],\"2\",survr1$strata[survr1$strata==\"stratum=2\"])\n) \n\n# Create Figure 3.9\nfig3.9 <- ggplot(aes(x = time / 365.25, y = cumhaz, linetype = strata), data = pcumhaz) + \n  geom_step(linewidth = 1) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  scale_linetype_discrete(\"Stratum\", labels = c(\"1\", \"2\")) + \n  theme_general + theme(legend.position = \"none\")\n\nfig3.9"
  },
  {
    "objectID": "Ch3.html#testis-cancer",
    "href": "Ch3.html#testis-cancer",
    "title": "3  Intensity models",
    "section": "Testis cancer",
    "text": "Testis cancer\n\nRead data\n\ntestis <- data.frame(read.csv(\"data/testis.csv\"))\n# Add extra variables\ntestis$lpyrs <- log(testis$pyrs)\ntestis$par2 <- as.numeric(testis$parity < 2)\n\n\n\nFigure 3.1\n\n# Data frames\ndf1 <- data.frame(x1 = 1900 + c(50, 58, 63, 68, 73), \n                  y1 = rep(0, 5), \n                  x2 = rep(2000, 5), \n                  y2 = 100 - c(50, 58, 63, 68, 73))\n\ndf2 <- data.frame(x1 = 1968.25 + c(0, 0, 0, 0, 73-68.25), \n                  y1 = c(68.25 - 50, 68.25 - 58, 68.25 - 63, 68.25 - 68, 0), \n                  x2 = rep(1993, 5), \n                  y2 = 100 - c(50, 58, 63, 68, 73) - 7)\n\ndf3 <- data.frame(x1 = c(1968.25, 1993, 1968.25, 1968.25, 1968.25 + 1.75, 1968.25 + 6.75, 1968.25 + 11.75), \n                  y1 = c(0, 0, 0, 15, 20, 25, 30), \n                  x2 = c(1968.25, 1993, 1993, 1993, 1993, 1993, 1993), \n                  y2 = c(68.25 - 50, 100 - 57, 0, 15, 20, 25, 30) \n                  )\n\n# For labels\nD <- tapply( testis$cases, list( testis$age, testis$cohort ), sum )\nY <- tapply( testis$pyrs, list( testis$age, testis$cohort ), sum )\nx <- outer( unique( testis$age )+c(17.5,rep(2.5,4)),\n            unique( testis$cohort )+2.5,\n            \"+\" )\nx[1,] <- x[1,]-c(0,3,3,3,2)\ny <- outer( c(13,17,22,27,32), rep(1,5), \"*\" )\n\nlabel_data <- data.frame(x = x[!is.na(Y)], \n                         y = y[!is.na(Y)], \n                         label = paste( round( Y/10^4 )[!is.na(Y)] )\n                         )\nlabel_data2 <- data.frame(x = 1956, y = 47.5, label = \"PY (10,000)\")\n\n# Create plot\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        text = element_text(size = 16), \n        axis.text.x = element_text(size = 16), \n        axis.text.y = element_text(size = 16))\n\nfig3.1 <- ggplot(df1) + \n  geom_vline(xintercept = c(1968.25, 1993),\n             size = 1, linetype = \"dotted\") +\n  geom_hline(yintercept = c(0, 15, 20, 25, 30),\n             size = 1, linetype = \"dotted\") +\n  geom_segment(aes(x = x1, y = y1, \n                   xend = x2, yend = y2), \n               data = df1,\n               size = 1, linetype = \"dotted\") + \n  geom_segment(aes(x = x1, y = y1, \n                   xend = x2, yend = y2), \n               data = df2,\n               size = 1.5) + \n  geom_segment(aes(x = x1, y = y1, \n                   xend = x2, yend = y2), \n               data = df3,\n               size = 1.5) + \n  theme_general + \n  xlab(\"Calendar time\") + \n  ylab(\"Age (years)\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.005)),\n                     limits = c(1950, 2000), \n                     breaks = seq(1950, 2000, 10)) +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.005)), \n                     limits = c(0, 50), \n                     breaks = seq(0, 50, 10)) + \n  geom_label(aes(x = x, y = y, label = label), size = 5, label.size = NA,\n             hjust = 1.1, vjust = 0.7, \n             data = label_data) + \n  theme(plot.margin=unit(c(0.75, 0.75, 0.75, 0.75), \"cm\"))\n\nfig3.1\n\n\n\n\n\n\nTable 3.5\n\nlibrary(broom)\nlibrary(lmtest)\n\n# Column 1\ntestis$age <- as.factor(testis$age)\ntestis$age <- relevel(testis$age, ref = \"20\")\nsummary(glm(cases ~ offset(lpyrs) + par2 + age, data = testis, family = poisson))\n\n\nCall:\nglm(formula = cases ~ offset(lpyrs) + par2 + age, family = poisson, \n    data = testis)\n\nCoefficients:\n            Estimate Std. Error  z value Pr(>|z|)    \n(Intercept) -9.04435    0.08393 -107.757  < 2e-16 ***\npar2         0.21663    0.08405    2.577  0.00996 ** \nage0        -4.03084    0.21105  -19.099  < 2e-16 ***\nage15       -1.17094    0.11886   -9.851  < 2e-16 ***\nage25        0.55962    0.09802    5.709 1.14e-08 ***\nage30        0.75263    0.13272    5.671 1.42e-08 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 1647.61  on 236  degrees of freedom\nResidual deviance:  201.07  on 231  degrees of freedom\nAIC: 540.84\n\nNumber of Fisher Scoring iterations: 5\n\n# Column 2\ntestis$motherage <- as.factor(testis$motherage)\ntestis$motherage <- relevel(testis$motherage, ref = \"30\")\ntestis$cohort <- as.factor(testis$cohort)\ntestis$cohort <- relevel(testis$cohort, ref = \"1973\")\nsummary(poisfull<-glm(cases ~ offset(lpyrs) + par2 + age + motherage + cohort, \n                      data = testis,family = poisson))\n\n\nCall:\nglm(formula = cases ~ offset(lpyrs) + par2 + age + motherage + \n    cohort, family = poisson, data = testis)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept) -9.11684    0.29271 -31.146  < 2e-16 ***\npar2         0.22967    0.09112   2.521   0.0117 *  \nage0        -4.00398    0.23905 -16.749  < 2e-16 ***\nage15       -1.16652    0.12522  -9.316  < 2e-16 ***\nage25        0.61710    0.10445   5.908 3.46e-09 ***\nage30        0.95356    0.15378   6.201 5.62e-10 ***\nmotherage12  0.02926    0.24121   0.121   0.9034    \nmotherage20  0.05796    0.22233   0.261   0.7943    \nmotherage25 -0.11663    0.22510  -0.518   0.6044    \ncohort1950  -0.36275    0.28800  -1.260   0.2078    \ncohort1958  -0.08031    0.24838  -0.323   0.7464    \ncohort1963   0.12346    0.23712   0.521   0.6026    \ncohort1968   0.13376    0.23600   0.567   0.5709    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 1647.6  on 236  degrees of freedom\nResidual deviance:  190.2  on 224  degrees of freedom\nAIC: 543.98\n\nNumber of Fisher Scoring iterations: 5\n\ntidy(poisfull, exponentiate = TRUE, conf.int = TRUE)\n\n# A tibble: 13 × 7\n   term        estimate std.error statistic   p.value  conf.low conf.high\n   <chr>          <dbl>     <dbl>     <dbl>     <dbl>     <dbl>     <dbl>\n 1 (Intercept) 0.000110    0.293    -31.1   5.74e-213 0.0000605  0.000191\n 2 par2        1.26        0.0911     2.52  1.17e-  2 1.05       1.51    \n 3 age0        0.0182      0.239    -16.7   5.72e- 63 0.0112     0.0286  \n 4 age15       0.311       0.125     -9.32  1.21e- 20 0.243      0.397   \n 5 age25       1.85        0.104      5.91  3.46e-  9 1.51       2.28    \n 6 age30       2.59        0.154      6.20  5.62e- 10 1.91       3.50    \n 7 motherage12 1.03        0.241      0.121 9.03e-  1 0.652      1.68    \n 8 motherage20 1.06        0.222      0.261 7.94e-  1 0.698      1.68    \n 9 motherage25 0.890       0.225     -0.518 6.04e-  1 0.583      1.41    \n10 cohort1950  0.696       0.288     -1.26  2.08e-  1 0.398      1.23    \n11 cohort1958  0.923       0.248     -0.323 7.46e-  1 0.574      1.52    \n12 cohort1963  1.13        0.237      0.521 6.03e-  1 0.720      1.83    \n13 cohort1968  1.14        0.236      0.567 5.71e-  1 0.729      1.84    \n\n# LRT for mother's age\npoismage<-glm(cases ~ offset(lpyrs) + par2 + age + cohort, \n              data = testis,family = poisson)\nlrtest(poisfull,poismage)\n\nLikelihood ratio test\n\nModel 1: cases ~ offset(lpyrs) + par2 + age + motherage + cohort\nModel 2: cases ~ offset(lpyrs) + par2 + age + cohort\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1  13 -258.99                     \n2  10 -260.25 -3 2.5336     0.4692\n\n# LRT for birth cohort of son\npoiscohort<-glm(cases ~ offset(lpyrs) + par2 + age + motherage, \n                data = testis,family = poisson)\nlrtest(poisfull,poiscohort)\n\nLikelihood ratio test\n\nModel 1: cases ~ offset(lpyrs) + par2 + age + motherage + cohort\nModel 2: cases ~ offset(lpyrs) + par2 + age + motherage\n  #Df  LogLik Df  Chisq Pr(>Chisq)  \n1  13 -258.99                       \n2   9 -263.60 -4 9.2204    0.05582 .\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n# LRT parity and age\npoisinteract<-glm(cases ~ offset(lpyrs) + par2 + age + motherage + cohort + par2*age, \n                  data = testis, family = poisson)\nlrtest(poisfull,poisinteract)\n\nLikelihood ratio test\n\nModel 1: cases ~ offset(lpyrs) + par2 + age + motherage + cohort\nModel 2: cases ~ offset(lpyrs) + par2 + age + motherage + cohort + par2 * \n    age\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1  13 -258.99                     \n2  17 -255.11  4 7.7606     0.1008\n\n# HR for seminomas\ntidy(glm(semi ~ offset(lpyrs) + par2 + age + motherage + cohort, \n         data = testis, family = poisson),\n     exponentiate = T, conf.int = T)\n\n# A tibble: 13 × 7\n   term         estimate std.error statistic  p.value   conf.low conf.high\n   <chr>           <dbl>     <dbl>     <dbl>    <dbl>      <dbl>     <dbl>\n 1 (Intercept) 0.0000297     1.00   -10.4    1.98e-25 0.00000314  0.000178\n 2 par2        1.23          0.171    1.23   2.19e- 1 0.886       1.73    \n 3 age0        0.00297       1.13    -5.17   2.38e- 7 0.000147    0.0176  \n 4 age15       0.0949        0.443   -5.32   1.03e- 7 0.0357      0.209   \n 5 age25       2.98          0.200    5.47   4.55e- 8 2.03        4.44    \n 6 age30       6.62          0.245    7.71   1.30e-14 4.11       10.8     \n 7 motherage12 0.900         0.640   -0.164  8.69e- 1 0.295       3.94    \n 8 motherage20 0.978         0.618   -0.0360 9.71e- 1 0.339       4.15    \n 9 motherage25 1.23          0.617    0.338  7.35e- 1 0.427       5.22    \n10 cohort1950  0.731         0.907   -0.345  7.30e- 1 0.140       5.71    \n11 cohort1958  0.966         0.879   -0.0389 9.69e- 1 0.198       7.26    \n12 cohort1963  0.862         0.869   -0.171  8.64e- 1 0.180       6.39    \n13 cohort1968  0.691         0.879   -0.421  6.74e- 1 0.140       5.18    \n\n# HAr for non-seminomas\ntidy(glm(nonsemi ~ offset(lpyrs) + par2 + age + motherage + cohort, \n         data = testis, family = poisson),\n     exponentiate = T, conf.int = T)\n\n# A tibble: 13 × 7\n   term         estimate std.error statistic   p.value  conf.low conf.high\n   <chr>           <dbl>     <dbl>     <dbl>     <dbl>     <dbl>     <dbl>\n 1 (Intercept) 0.0000860     0.308   -30.4   7.09e-203 0.0000459  0.000154\n 2 par2        1.27          0.108     2.19  2.88e-  2 1.03       1.56    \n 3 age0        0.0223        0.246   -15.4   9.35e- 54 0.0135     0.0355  \n 4 age15       0.369         0.133    -7.48  7.32e- 14 0.283      0.478   \n 5 age25       1.49          0.125     3.21  1.35e-  3 1.17       1.91    \n 6 age30       1.21          0.229     0.846 3.97e-  1 0.762      1.88    \n 7 motherage12 1.09          0.264     0.341 7.33e-  1 0.662      1.87    \n 8 motherage20 1.10          0.239     0.382 7.03e-  1 0.700      1.79    \n 9 motherage25 0.804         0.244    -0.892 3.72e-  1 0.508      1.33    \n10 cohort1950  0.639         0.328    -1.37  1.72e-  1 0.335      1.22    \n11 cohort1958  0.828         0.264    -0.718 4.73e-  1 0.499      1.41    \n12 cohort1963  1.15          0.247     0.550 5.82e-  1 0.715      1.89    \n13 cohort1968  1.19          0.245     0.722 4.70e-  1 0.748      1.96"
  },
  {
    "objectID": "Ch3.html#recurrent-episodes-in-affective-disorders",
    "href": "Ch3.html#recurrent-episodes-in-affective-disorders",
    "title": "3  Intensity models",
    "section": "Recurrent episodes in affective disorders",
    "text": "Recurrent episodes in affective disorders\n\nRead data\n\naffective <- data.frame(read.csv(\"data/affective.csv\"))\naffective$wait <- with(affective, stop - start)\n\n\n\nTable 3.6\n\nlibrary(survival)\ncoxph(Surv(start, stop, status == 1) ~ bip,\n      data = subset(affective, state == 0), ties = \"breslow\")\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    state == 0), ties = \"breslow\")\n\n       coef exp(coef) se(coef)     z        p\nbip 0.36593   1.44186  0.09448 3.873 0.000107\n\nLikelihood ratio test=14.24  on 1 df, p=0.0001612\nn= 626, number of events= 542 \n\ncoxph(Surv(start, stop, status == 1) ~ bip + episode,\n      data = subset(affective, state == 0), ties = \"breslow\")\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip + episode, \n    data = subset(affective, state == 0), ties = \"breslow\")\n\n            coef exp(coef) se(coef)      z        p\nbip     0.318455  1.375002 0.094545  3.368 0.000756\nepisode 0.126230  1.134543 0.008675 14.552  < 2e-16\n\nLikelihood ratio test=177.8  on 2 df, p=< 2.2e-16\nn= 626, number of events= 542 \n\ncoxph(Surv(start, stop, status == 1) ~ bip + episode + I(episode*episode),\n      data = subset(affective, state == 0), ties = \"breslow\")\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip + episode + \n    I(episode * episode), data = subset(affective, state == 0), \n    ties = \"breslow\")\n\n                          coef exp(coef)  se(coef)      z      p\nbip                   0.066935  1.069226  0.097084  0.689  0.491\nepisode               0.424503  1.528831  0.032315 13.136 <2e-16\nI(episode * episode) -0.013617  0.986476  0.001554 -8.764 <2e-16\n\nLikelihood ratio test=283.1  on 3 df, p=< 2.2e-16\nn= 626, number of events= 542 \n\naffective$epi<-with(affective, ifelse(episode<25,episode,25))\ncoxph(Surv(start, stop, status == 1) ~ bip + factor(epi),\n      data = subset(affective, state == 0), ties = \"breslow\")\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip + factor(epi), \n    data = subset(affective, state == 0), ties = \"breslow\")\n\n                  coef exp(coef) se(coef)      z       p\nbip            0.08265   1.08617  0.09911  0.834 0.40428\nfactor(epi)1  -1.05299   0.34889  1.01925 -1.033 0.30156\nfactor(epi)2  -0.19882   0.81969  1.01745 -0.195 0.84507\nfactor(epi)3   0.10702   1.11296  1.01767  0.105 0.91625\nfactor(epi)4   0.33779   1.40184  1.01879  0.332 0.74022\nfactor(epi)5   0.87778   2.40555  1.01966  0.861 0.38932\nfactor(epi)6   0.82540   2.28280  1.02289  0.807 0.41971\nfactor(epi)7   1.03045   2.80233  1.02334  1.007 0.31396\nfactor(epi)8   1.32179   3.75014  1.02557  1.289 0.19746\nfactor(epi)9   1.93669   6.93579  1.02934  1.881 0.05990\nfactor(epi)10  2.23691   9.36437  1.03634  2.158 0.03089\nfactor(epi)11  1.43431   4.19677  1.03473  1.386 0.16569\nfactor(epi)12  1.64060   5.15824  1.04425  1.571 0.11616\nfactor(epi)13  1.81915   6.16659  1.05244  1.729 0.08390\nfactor(epi)14  1.54530   4.68937  1.05713  1.462 0.14380\nfactor(epi)15  2.17967   8.84340  1.07677  2.024 0.04294\nfactor(epi)16  1.62044   5.05531  1.08609  1.492 0.13570\nfactor(epi)17  2.64324  14.05863  1.11442  2.372 0.01770\nfactor(epi)18  3.31788  27.60164  1.14484  2.898 0.00375\nfactor(epi)19  2.77865  16.09720  1.17711  2.361 0.01825\nfactor(epi)20  1.44524   4.24287  1.23541  1.170 0.24206\nfactor(epi)21  2.94624  19.03419  1.26311  2.333 0.01967\nfactor(epi)22  1.47210   4.35839  1.23833  1.189 0.23452\nfactor(epi)23  2.08914   8.07794  1.23944  1.686 0.09188\nfactor(epi)24  2.47251  11.85221  1.24911  1.979 0.04777\n\nLikelihood ratio test=324.9  on 25 df, p=< 2.2e-16\nn= 626, number of events= 542 \n\n\n\n\nTable 3.7\n\ncoxph(Surv(start, stop, status == 1) ~ bip + tt(year),\n      data = subset(affective, state == 0), ties = \"breslow\",\n       tt=function(x, t, ...) {\n         per <- x + 0.5 + t/12\n         cbind(period1=1*(66<=per & per<71),\n               period2=1*(71<=per & per<76),\n               period3=1*(76<=per & per<81),\n               period4=1*(81<=per))})\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip + tt(year), \n    data = subset(affective, state == 0), ties = \"breslow\", tt = function(x, \n        t, ...) {\n        per <- x + 0.5 + t/12\n        cbind(period1 = 1 * (66 <= per & per < 71), period2 = 1 * \n            (71 <= per & per < 76), period3 = 1 * (76 <= per & \n            per < 81), period4 = 1 * (81 <= per))\n    })\n\n                    coef exp(coef) se(coef)      z        p\nbip              0.36123   1.43509  0.09454  3.821 0.000133\ntt(year)period1 -0.25060   0.77834  0.20834 -1.203 0.229047\ntt(year)period2 -0.17948   0.83570  0.33095 -0.542 0.587596\ntt(year)period3 -0.36737   0.69256  0.43858 -0.838 0.402237\ntt(year)period4 -1.33241   0.26384  0.55385 -2.406 0.016141\n\nLikelihood ratio test=25.16  on 5 df, p=0.0001299\nn= 626, number of events= 542"
  },
  {
    "objectID": "Ch3.html#bone-marrow-transplantation-in-acute-leukemia",
    "href": "Ch3.html#bone-marrow-transplantation-in-acute-leukemia",
    "title": "3  Intensity models",
    "section": "Bone marrow transplantation in acute leukemia",
    "text": "Bone marrow transplantation in acute leukemia"
  }
]