[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Models for Multi-State Survival Data",
    "section": "",
    "text": "This is the code companion website to our book published by Chapman & Hall.\nR code with output for analyses and plots presented in the book is provided. Corresponding code in SAS with no output is given, and a few places only R or SAS code is available. When using bootstrap small deviations from the book will occur as no fixed seeds have been used.\nPlease note, that code often depends on previous code in the same chapter including loading of required R packages.\nSolutions to the exercises are available at the end of each chapter.\nA chapter with errata is also provided."
  },
  {
    "objectID": "index.html#acknowledgements",
    "href": "index.html#acknowledgements",
    "title": "Models for Multi-State Survival Data",
    "section": "Acknowledgements",
    "text": "Acknowledgements\nThanks to Julie K. Furberg who created figures and validated analyses quoted in the book. Thanks to Eva N.S. Wandall who created solutions to practical exercises and contributed to some of the examples."
  },
  {
    "objectID": "Ch1.html#pbc3-trial-in-liver-cirrhosis-pbc3.csv",
    "href": "Ch1.html#pbc3-trial-in-liver-cirrhosis-pbc3.csv",
    "title": "1  Introduction and data sets",
    "section": "1.1 PBC3 trial in liver cirrhosis (pbc3.csv)",
    "text": "1.1 PBC3 trial in liver cirrhosis (pbc3.csv)\n\n\n\n\n\n\n\nVariable name\nDescription\n\n\n\n\nid\npatient id\n\n\nunit\nhospital\n\n\ndays\nfollow-up time in days\n\n\nstatus\n0 = censoring, 1 = transplantation, 2 = death without transplantation\n\n\ntment\n0 = placebo, 1 = CyA\n\n\nsex\n0 = female, 1 = male\n\n\nage\nage in years\n\n\nbili\nbilirubin (micromoles/L)\n\n\nalb\nalbumin (g/L)\n\n\nstage\ndisease stage: 2 = I-II, 3 = III, 4 = IV"
  },
  {
    "objectID": "Ch1.html#guinea-bissau-childhood-vaccination-study-bissau.csv",
    "href": "Ch1.html#guinea-bissau-childhood-vaccination-study-bissau.csv",
    "title": "1  Introduction and data sets",
    "section": "1.2 Guinea-Bissau childhood vaccination study (bissau.csv)",
    "text": "1.2 Guinea-Bissau childhood vaccination study (bissau.csv)\n\n\n\n\n\n\n\nVariable name\nDescription\n\n\n\n\nid\nchild id\n\n\ncluster\ncluster id\n\n\nfuptime\nfollow-up time (days)\n\n\ndead\n0 = alive, 1 = dead\n\n\nbcg\nbcg vaccination status at initial visit: 0 = no, 1 = yes\n\n\ndtp\nno of dtp vaccinations at initial visit\n\n\nsex\n0 = female, 1 = male\n\n\nage\nage in days at initial visit"
  },
  {
    "objectID": "Ch1.html#testis-cancer-incidence-and-maternal-parity-testis.csv",
    "href": "Ch1.html#testis-cancer-incidence-and-maternal-parity-testis.csv",
    "title": "1  Introduction and data sets",
    "section": "1.3 Testis cancer incidence and maternal parity (testis.csv)",
    "text": "1.3 Testis cancer incidence and maternal parity (testis.csv)\n\n\n\n\n\n\n\nVariable name\nDescription\n\n\n\n\nage\nage of son\n\n\n\n0 = 0-14 years\n\n\n\n15 = 15-19 years\n\n\n\n20 = 20-24 years\n\n\n\n25 = 25-29 years\n\n\n\n30 = 30+ years\n\n\npyrs\nperson years at risk\n\n\ncases\nnumber of testis cancer\n\n\nsemi\nnumber of seminomas cases\n\n\nnonsemi\nnumber of non-seminomas cases\n\n\nparity\nparity of mother at birth of son\n\n\ncohort\nson cohort (year of birth)\n\n\n\n1950 = 1950-1957\n\n\n\n1958 = 1958-1962\n\n\n\n1963 = 1963-1967\n\n\n\n1968 = 1968-1972\n\n\n\n1973 = 1973-1992\n\n\nmotherage\nmother’s age at birth of son\n\n\n\n12 = 12-19\n\n\n\n20 = 20-24\n\n\n\n25 = 25-29\n\n\n\n30 = 30+"
  },
  {
    "objectID": "Ch1.html#prova-trial-in-liver-cirrhosis-prova.csv",
    "href": "Ch1.html#prova-trial-in-liver-cirrhosis-prova.csv",
    "title": "1  Introduction and data sets",
    "section": "1.4 PROVA trial in liver cirrhosis (prova.csv)",
    "text": "1.4 PROVA trial in liver cirrhosis (prova.csv)\n\n\n\n\n\n\n\nVariable name\nDescription\n\n\n\n\nid\npatient id\n\n\ntimedeath\nfollowup time (days)\n\n\ndeath\n0 = alive, 1 = dead\n\n\ntimebleed\ntime to bleeding (days); missing if bleed = 0\n\n\nbleed\n0 = no bleeding, 1 = bleeding\n\n\nbeta\n0 = no propranolol, 1 = propranolol\n\n\nscle\n0 = no sclerotherapy, 1 = sclerotherapy\n\n\nsex\n0 = female, 1 = male\n\n\nage\nage (years)\n\n\nbili\nbilirubin (micromoles/L)\n\n\ncoag\ncoagulation factors (% of normal)\n\n\nvarsize\nvariceal size: 1 = small, 2 = medium, 3 = large"
  },
  {
    "objectID": "Ch1.html#recurrent-episodes-in-affective-disorders-affective.csv",
    "href": "Ch1.html#recurrent-episodes-in-affective-disorders-affective.csv",
    "title": "1  Introduction and data sets",
    "section": "1.5 Recurrent episodes in affective disorders (affective.csv)",
    "text": "1.5 Recurrent episodes in affective disorders (affective.csv)\n\n\n\n\n\n\n\nVariable name\nDescription\n\n\n\n\nid\npatient id\n\n\nepisode\nnumber of affective episodes\n\n\nstate\n0 = no current affective episode, 1 = current affective episode\n\n\nstart\nstart time in state (months)\n\n\nstop\nlast time seen in state (months)\n\n\nstatus\nstatus at time stop:\n\n\n\n0 = transition to state 0\n\n\n\n1 = transition to state 1\n\n\n\n2 = transition to death\n\n\n\n3 = censoring\n\n\nbip\n0 = unipolar, 1 = bipolar\n\n\nsex\n0 = female, 1 = male\n\n\nage\nage (years)\n\n\nyear\nyear of initial episode"
  },
  {
    "objectID": "Ch1.html#leader-cardiovascular-trial-in-type-2-diabetes",
    "href": "Ch1.html#leader-cardiovascular-trial-in-type-2-diabetes",
    "title": "1  Introduction and data sets",
    "section": "1.6 LEADER cardiovascular trial in type 2 diabetes",
    "text": "1.6 LEADER cardiovascular trial in type 2 diabetes\nData not available for download.\n\n\n\n\n\n\n\nVariable name\nDescription\n\n\n\n\nid\npatient id\n\n\nstart\n\n\n\nstop\n\n\n\nstatus\n\n\n\ntype\n\n\n\neventtype\n\n\n\neventno\n\n\n\ntreat"
  },
  {
    "objectID": "Ch1.html#bone-marrow-transplantation-in-acute-leukemia-bmt.csv",
    "href": "Ch1.html#bone-marrow-transplantation-in-acute-leukemia-bmt.csv",
    "title": "1  Introduction and data sets",
    "section": "1.7 Bone marrow transplantation in acute leukemia (bmt.csv)",
    "text": "1.7 Bone marrow transplantation in acute leukemia (bmt.csv)\n\n\n\n\n\n\n\nVariable name\nDescription\n\n\n\n\nid\npatient id\n\n\nteam\nteam id\n\n\ntimedeath\nfollowup time (months)\n\n\ndeath\n0 = alive, 1 = dead\n\n\ntimerel\ntime to relapse (months); missing if rel = 0\n\n\nrel\n0 = no replase, 1 = relapse\n\n\ntimegvhd\ntime to GvHD (months); missing if gvhd = 0\n\n\ngvhd\n0 = no GvHD, 1 = GvHD\n\n\ntimeanc500\ntime to absolute neutrophil count (ANC) above 500 cells per \\(\\mu\\)L; missing if anc500 = 0\n\n\nanc500\n0 = ANC below 500, 1 = ANC above 500\n\n\nsex\n0 = female, 1 = male\n\n\nage\nage (years)\n\n\nall\n0 = acute myelogenous leukemia (AML)\n\n\n\n1 = acute lymphoblastic leukemia (ALL)\n\n\nbmonly\n0 = peripheral blood/bone marrow, 1 = only bone marrow"
  },
  {
    "objectID": "Ch1.html#the-copenhagen-holter-study-cphholter.csv",
    "href": "Ch1.html#the-copenhagen-holter-study-cphholter.csv",
    "title": "1  Introduction and data sets",
    "section": "1.8 The Copenhagen Holter study (cphholter.csv)",
    "text": "1.8 The Copenhagen Holter study (cphholter.csv)\n\n\n\n\n\n\n\nVariable name\nDescription\n\n\n\n\nid\npatient id\n\n\ntimedeath\nfollowup time (days)\n\n\ndeath\n0 = alive, 1 = dead\n\n\ntimeafib\ntime to atrial fibrillation (days); missing if afib = 0\n\n\nafib\n0 = no atrial fibrillation, 1 = atrial fibrillation\n\n\ntimestroke\ntime to stroke (days); missing if stroke = 0\n\n\nstroke\n0 = no stroke, 1 = stroke\n\n\nsex\n0 = female, 1 = male\n\n\nage\nage (years)\n\n\nsmoker\ncurrent smoker: 0 = no, 1 = yes\n\n\nesvea\nexcessive supra-ventricular ectopic activity: 0 = no, 1 = yes\n\n\nchol\ncholesterol (mmol/L)\n\n\ndiabet\ndiabets mellitus: 0 = no, 1 = yes\n\n\nbmi\nbody mass index (kg/m\\(^2\\))\n\n\naspirin\naspirin use: 0 = no, 1 = yes\n\n\nprobnp\nNT-proBNP (pmol/L)\n\n\nsbp\nsystolic blood pressure (mmHg)"
  },
  {
    "objectID": "Ch1.html#small-set-of-survival-data",
    "href": "Ch1.html#small-set-of-survival-data",
    "title": "1  Introduction and data sets",
    "section": "1.9 Small set of survival data",
    "text": "1.9 Small set of survival data\n\nCreate data\n\n\nCode show/hide\ntimes <- c(5,6,7,8,9,12,13,15,16,20,22,23)\nage <- c(12,0,0,10,6,6,9,3,8,0,0,2)\nevent <- c(1,0,1,1,0,0,1,1,1,0,0,1)\nid <- 1:12\nexitage <- age + times\nsimpledata <- as.data.frame(cbind(id, times, event, age, exitage))\n\n\n\n\nFigure 1.8\n\n\nCode show/hide\n#------------------------------------------------------------------#\n# General plotting styles \n#------------------------------------------------------------------#\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"none\",\n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\ntheme_general_x <- theme_bw() +\n  theme(legend.position = \"none\",\n        text = element_text(size = 26), \n        axis.text.x = element_text(size = 26), \n        axis.text.y = element_text(size = 26)) \n\n# Create Figure 1.8, part (a)\nfig1.8a <- ggplot(aes(x = times, y = id), data = simpledata) +\n  geom_segment(aes(x = 0, y = id, xend = times - 0.25, yend = id), size = 1) +\n  geom_point(aes(x = times, y = id), data = subset(simpledata,event==0),\n             shape = 21, size = 6, color='black', fill='white') +\n  geom_point(aes(x = times, y = id), data = subset(simpledata,event==1),\n             shape = 16, size = 6) +\n  xlab(\"Time (t)\") +\n  ylab(\"Subject number\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 25)) +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0.5, 12), breaks = seq(1, 12, 1)) +\n  theme_general_x +\n  theme(panel.grid.major.y = element_blank(),\n        panel.grid.minor.y = element_blank())\n\nfig1.8a\n\n\n\n\n\nCode show/hide\n# Create Figure 1.8, part (b)\nfig1.8b <- ggplot(aes(x = exitage, y = id), data = simpledata) +\n  geom_segment(aes(x = age, y = id, xend = exitage - 0.25, yend = id), size = 1) +\n  geom_point(aes(x = exitage, y = id), data = subset(simpledata,event==0),\n             shape = 21, size = 6, color='black', fill='white') +\n  geom_point(aes(x = exitage, y = id), data = subset(simpledata,event==1),\n             shape = 16, size = 6) +\n  xlab(\"Age\") +\n  ylab(\"Subject number\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 25)) +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0.5, 12), breaks = seq(1, 12, 1)) +\n  theme_general_x + \n  theme(legend.position = \"none\",\n        panel.grid.major.y = element_blank(),\n        panel.grid.minor.y = element_blank())\n\nfig1.8b\n\n\n\n\n\n\n\nFigure 1.9\n\n\nCode show/hide\n#------------------------------------------------------------------#\n# Figure 1.9 \n#------------------------------------------------------------------#\nlibrary(survival)\n# Kaplan-Meier time as time variable\nkmfit <- survfit(Surv(times, event) ~ 1)\nsimpledata_km <- data.frame(surv = c(1, kmfit$surv), \n                            time = c(0, kmfit$time))\n\n# Create Figure 1.9, part (a)\nfig1.9a <- ggplot(aes(x = time, y = surv), data = simpledata_km) +\n  geom_step(size = 1) +\n  xlab(\"Time (t)\") +\n  ylab(\"Estimate of S(t)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 25)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 1), breaks = seq(0, 1, 0.1)) +\n  theme_general_x\n\nfig1.9a\n\n\n\n\n\nCode show/hide\n# Kaplan-Meier age as time variable\nkmfit2 <- survfit(Surv(age, exitage, event) ~ 1)\nsimpledata_km_age <- data.frame(surv = c(1, kmfit2$surv), \n                                time = c(0, kmfit2$time))\n\n# Create Figure 1.9, part (b)\nfig1.9b <- ggplot(aes(x = time, y = surv), data = simpledata_km_age) +\n  geom_step(size = 1) +\n  xlab(\"Age\") +\n  ylab(\"Estimate of S(age)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 25)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 1), breaks = seq(0, 1, 0.1)) +\n  theme_general_x\n\nfig1.9b\n\n\n\n\n\n\n\nFigure 1.10\n\n\nCode show/hide\n#------------------------------------------------------------------#\n# Figure 1.10 \n#------------------------------------------------------------------#\n\n# Kaplan-Meier time as time variable\nkmfit <- survfit(Surv(times, event) ~ 1)\nsimpledata_km <- data.frame(surv = c(1, kmfit$surv), \n                            time = c(0, kmfit$time))\nsubdata<-simpledata_km[simpledata_km$time<=12,]\n\n# Create Figure 1.10\nlibrary(dplyr)\nfig1.10 <- ggplot(mapping=aes(x = time, y = surv), data = simpledata_km) +\n  geom_rect(data=subdata,\n            aes(xmin = time, xmax = lead(time),\n                ymin = 0, ymax = surv),\n            linetype=0,fill=\"grey\")+\n  geom_segment(aes(x = 12, y = -Inf, xend = 12, yend = 0.733),\n               size=1,linetype=\"dashed\")+\n  geom_step(size = 1) +\n  xlab(\"Time (t)\") +\n  ylab(\"Estimate of S(t)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 25)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 1), breaks = seq(0, 1, 0.1)) +\n  theme_general +\n  annotate(geom=\"text\",x=6, y=0.45,\n           label=expression(epsilon[0](12)),size=8)\nfig1.10\n\n\n\n\n\n\n\nFigure 1.13\n\n\nCode show/hide\n#------------------------------------------------------------------#\n# Figure 1.13 \n#------------------------------------------------------------------#\n\n# N(t)\nsfit <- survfit(Surv(times, event) ~ 1)\np1 <- data.frame(time = c(0, sfit$time, 26), \n                 n = c(0, cumsum(sfit$n.event), tail(cumsum(sfit$n.event),1)))\np2 <- data.frame(time = sfit$time[sfit$n.event==1], \n                 n = cumsum(sfit$n.event)[sfit$n.event==1]-1)\np3 <- data.frame(time = sfit$time[sfit$n.event==1], \n                 n = cumsum(sfit$n.event)[sfit$n.event==1])\n\n# Create Figure 1.13, part (a)\nfig1.13a <- ggplot(aes(x = time, y = n), data = p1) +\n  geom_step(size = 1) + \n  geom_point(aes(x = time, y = n), data = p2, shape = 21, size = 6, \n             color='black', fill='white') +\n  geom_point(aes(x = time, y = n), data = p3, shape = 16, size = 6) +\n  xlab(\"Time (t)\") +\n  ylab(\"N(t)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.005)), \n                     limits = c(0, 26)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 12), breaks = seq(0, 12, 1)) +\n  theme_general_x\n\nfig1.13a\n\n\n\n\n\nCode show/hide\n# Y(t)\nsfit <- survfit(Surv(times, event) ~ 1)\np1 <- data.frame(time = c(0, sfit$time, 26), \n                 risk = c(sfit$n.risk, 0, 0))\np2 <- data.frame(time = sfit$time, \n                 risk = sfit$n.risk - 1)\np3 <- data.frame(time = sfit$time, \n                 risk = sfit$n.risk)\n\n# Create Figure 1.13, part (b)\nfig1.13b <- ggplot(aes(x = time, y = risk), data = p1) +\n  geom_step(size = 1) + \n  geom_point(aes(x = time, y = risk), data = p2, shape = 21, size = 6, \n             color='black', fill='white') +\n  geom_point(aes(x = time, y = risk), data = p3, shape = 16, size = 6) +\n  xlab(\"Time (t)\") +\n  ylab(\"Y(t)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.005)), \n                     limits = c(0, 26)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 12), breaks = seq(0, 12, 1)) +\n  theme_general_x\n\nfig1.13b\n\n\n\n\n\nCode show/hide\n# N(age)\nasfit <- survfit(Surv(age, exitage, event) ~ 1)\np1 <- data.frame(time = c(0, asfit$time, 26), \n                 n = c(0, cumsum(asfit$n.event),tail(cumsum(asfit$n.event), 1)))\np2 <- data.frame(time = asfit$time[asfit$n.event > 0], \n                 n = cumsum(asfit$n.event)[asfit$n.event > 0])\np3 <- data.frame(time = asfit$time[asfit$n.event > 0], \n                 n = c(0, 1, 2, 4, 5, 6))\n\n# Create Figure 1.13, part (c)\nfig1.13c <- ggplot(aes(x = time, y = n), data = p1) +\n  geom_step(size = 1) + \n  geom_point(aes(x = time, y = n), data = p2, shape = 16, size = 6) +\n  geom_point(aes(x = time, y = n), data = p3, shape = 21, size = 6, \n             color='black', fill='white') +\n  xlab(\"Age\") +\n  ylab(\"N(age)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.005)), \n                     limits = c(0, 26)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 12), breaks = seq(0, 12, 1)) +\n  theme_general_x \n\nfig1.13c\n\n\n\n\n\nCode show/hide\n# Y(age)\natriskage <- vector(length=25)\nfor(i in 1:25){\n  atriskage[i] <- sum((age<=i & exitage>i))\n}\n\np1 <- data.frame(time = 0:26, \n                 risk = c(atriskage[1], atriskage, 0))\np2 <- data.frame(time = c(2,3,6,7,8,9,10,12,15,17,18,20,22,24,25), \n                 risk = c(5,6,7,6,7,8, 9,10, 9, 8, 5, 4, 2, 1,0))\np3 <- data.frame(time = c(2,3,6,7,8,9,10,12,15,17,18,20,22,24,25), \n                 risk = c(4,5,6,7,6,7, 8,9, 10, 9, 8, 5, 4, 2,1))\n\n# Create Figure 1.13, part (d)\nfig1.13d <- ggplot(aes(x = time, y = risk), data = p1) +\n  geom_step(size = 1) + \n  geom_point(aes(x = time, y = risk), data = p2, shape = 21, size = 6, \n             color='black', fill='white') +\n  geom_point(aes(x = time, y = risk), data = p3, shape = 16, size = 6) +\n  xlab(\"Age\") +\n  ylab(\"Y(age)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.005)), \n                     limits = c(0, 26)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 12), breaks = seq(0, 12, 1)) +\n  theme_general_x\n\nfig1.13d"
  },
  {
    "objectID": "Ch1.html#exercises",
    "href": "Ch1.html#exercises",
    "title": "1  Introduction and data sets",
    "section": "Exercises",
    "text": "Exercises\n\nExercise 1.1\nConsider the small data set in Table 1.6 and argue why both the average of all (12) observation times and the average of the (7) uncensored times will likely underestimate the true mean survival time from entry into the study.\nThe average of all 12 observation times: \\[\\frac{5+6+7+8+9+12+13+15+16+20+22+23}{12} = \\frac{156}{12} = 13.00\\] will under-estimate the mean survival time because 5 of the terms in the sum, i.e., those corresponding to right-censored observations, are known to be smaller than the true survival times.\nThe average of the 7 uncensored observations: \\[\\frac{5+7+8+13+15+16+23}{7}=\\frac{87}{7} = 12.43\\] is also likely to under-estimate the mean because right-censoring will typically cause the longer survival times in the population to be incompletely observed. E.g., survival times longer than the time elapsed from the beginning of the study to its end will always be right-censored.\n\n\nExercise 1.2\n\n1.\nConsider the following records mimicking the Copenhagen Holter study (Example 1.1.8) in wide format and transform them into long format, i.e., create one data set for each of the possible six transitions in Figure 1.7.\nData can (partly) be converted to long format using the msprep function from the mstate package. However, we must first add indicators of whether the subjects transitioned to AF, stroke and death during the study. Furthermore, we have to fill in timeafib, timestroke and timedeath for all subjects, such that they correspond to the last time where transitions to the states AF, stroke and death are possible. Lastly, we need to specify a transition matrix.\n\n\nCode show/hide\nchs_data <- read.csv(\"data/cphholter.csv\")\nlibrary(tidyverse)\nlibrary(survival)\nlibrary(mstate)\n\n\n\n\nCode show/hide\n# The table from the exercise\nid <- factor(1:8)\ntimeafib <- c(NA, 10, NA, 15, NA, 30, NA, 25)\ntimestroke <- c(NA, NA, 20, 30, NA, NA, 35, 50)\ntimedeath <- c(NA, NA, NA, NA, 70, 75, 95, 65)\nlastobs <- c(100, 90, 80, 85, 70, 75, 95, 65)\ncbind(id, timeafib, timestroke, timedeath, lastobs)\n\n\n     id timeafib timestroke timedeath lastobs\n[1,]  1       NA         NA        NA     100\n[2,]  2       10         NA        NA      90\n[3,]  3       NA         20        NA      80\n[4,]  4       15         30        NA      85\n[5,]  5       NA         NA        70      70\n[6,]  6       30         NA        75      75\n[7,]  7       NA         35        95      95\n[8,]  8       25         50        65      65\n\n\nCode show/hide\n# Creating status indicators\nafib <- ifelse(is.na(timeafib), 0, 1)\nstroke <- ifelse(is.na(timestroke), 0, 1)\ndeath <- ifelse(is.na(timedeath), 0, 1)\n\n# Last time point at risk for a transition to each state\ntimedeath <- lastobs\ntimestroke <- ifelse(is.na(timestroke), timedeath, timestroke)\ntimeafib <- ifelse(is.na(timeafib), timestroke, timeafib)\nwide_data <- as.data.frame(cbind(id, timeafib, timestroke, \n                                 timedeath, afib, stroke, death))\n\n# Creating the transition matrix without the Stroke to AF transition\ntmat <- matrix(NA,4,4)\ntmat[1, 2:4] <- 1:3\ntmat[2, 3:4] <- 4:5\ntmat[3, 4] <- 6\ndimnames(tmat) <- list(from = c(\"No event\", \"AF\", \"Stroke\", \"Death\"), \n                       to = c(\"No event\", \"AF\", \"Stroke\", \"Death\"))\ntmat\n\n\n          to\nfrom       No event AF Stroke Death\n  No event       NA  1      2     3\n  AF             NA NA      4     5\n  Stroke         NA NA     NA     6\n  Death          NA NA     NA    NA\n\n\nCode show/hide\n# Using msprep to create data in long format\nlong_data <- msprep(time = c(NA, \"timeafib\", \"timestroke\", \"timedeath\"),\n                    status = c(NA, \"afib\", \"stroke\", \"death\"),\n                    trans = tmat, data = wide_data) \nlong_data\n\n\nAn object of class 'msdata'\n\nData:\n   id from to trans Tstart Tstop time status\n1   1    1  2     1      0   100  100      0\n2   1    1  3     2      0   100  100      0\n3   1    1  4     3      0   100  100      0\n4   2    1  2     1      0    10   10      1\n5   2    1  3     2      0    10   10      0\n6   2    1  4     3      0    10   10      0\n7   2    2  3     4     10    90   80      0\n8   2    2  4     5     10    90   80      0\n9   3    1  2     1      0    20   20      0\n10  3    1  3     2      0    20   20      1\n11  3    1  4     3      0    20   20      0\n12  3    3  4     6     20    80   60      0\n13  4    1  2     1      0    15   15      1\n14  4    1  3     2      0    15   15      0\n15  4    1  4     3      0    15   15      0\n16  4    2  3     4     15    30   15      1\n17  4    2  4     5     15    30   15      0\n18  4    3  4     6     30    85   55      0\n19  5    1  2     1      0    70   70      0\n20  5    1  3     2      0    70   70      0\n21  5    1  4     3      0    70   70      1\n22  6    1  2     1      0    30   30      1\n23  6    1  3     2      0    30   30      0\n24  6    1  4     3      0    30   30      0\n25  6    2  3     4     30    75   45      0\n26  6    2  4     5     30    75   45      1\n27  7    1  2     1      0    35   35      0\n28  7    1  3     2      0    35   35      1\n29  7    1  4     3      0    35   35      0\n30  7    3  4     6     35    95   60      1\n31  8    1  2     1      0    25   25      1\n32  8    1  3     2      0    25   25      0\n33  8    1  4     3      0    25   25      0\n34  8    2  3     4     25    50   25      1\n35  8    2  4     5     25    50   25      0\n36  8    3  4     6     50    65   15      1\n\n\nCode show/hide\n# Now, the Stroke to AF transition is added manually\n\nstroketoaf<-subset(wide_data,stroke==1)\n\nstroketoaf$from <- 3\nstroketoaf$to <- 2\nstroketoaf$trans <- 7\nstroketoaf$Tstart <- stroketoaf$timestroke\nstroketoaf$Tstop <- ifelse(stroketoaf$timeafib>stroketoaf$timestroke,timeafib,timedeath)\nstroketoaf$status <- ifelse(stroketoaf$timeafib>stroketoaf$timestroke,1,0)\nstroketoaf$time <- stroketoaf$Tstop - stroketoaf$Tstart\nstroketoaf_long <- subset(stroketoaf, select = c(id,from,to,trans,Tstart,Tstop,time,status)) \n\n# and added to the data set created my msprep\n\nfinaldata <- rbind(long_data,stroketoaf_long)\n\nfinaldata\n\n\nAn object of class 'msdata'\n\nData:\n   id from to trans Tstart Tstop time status\n1   1    1  2     1      0   100  100      0\n2   1    1  3     2      0   100  100      0\n3   1    1  4     3      0   100  100      0\n4   2    1  2     1      0    10   10      1\n5   2    1  3     2      0    10   10      0\n6   2    1  4     3      0    10   10      0\n7   2    2  3     4     10    90   80      0\n8   2    2  4     5     10    90   80      0\n9   3    1  2     1      0    20   20      0\n10  3    1  3     2      0    20   20      1\n11  3    1  4     3      0    20   20      0\n12  3    3  4     6     20    80   60      0\n13  4    1  2     1      0    15   15      1\n14  4    1  3     2      0    15   15      0\n15  4    1  4     3      0    15   15      0\n16  4    2  3     4     15    30   15      1\n17  4    2  4     5     15    30   15      0\n18  4    3  4     6     30    85   55      0\n19  5    1  2     1      0    70   70      0\n20  5    1  3     2      0    70   70      0\n21  5    1  4     3      0    70   70      1\n22  6    1  2     1      0    30   30      1\n23  6    1  3     2      0    30   30      0\n24  6    1  4     3      0    30   30      0\n25  6    2  3     4     30    75   45      0\n26  6    2  4     5     30    75   45      1\n27  7    1  2     1      0    35   35      0\n28  7    1  3     2      0    35   35      1\n29  7    1  4     3      0    35   35      0\n30  7    3  4     6     35    95   60      1\n31  8    1  2     1      0    25   25      1\n32  8    1  3     2      0    25   25      0\n33  8    1  4     3      0    25   25      0\n34  8    2  3     4     25    50   25      1\n35  8    2  4     5     25    50   25      0\n36  8    3  4     6     50    65   15      1\n37  3    3  2     7     20   100   80      0\n41  4    3  2     7     30    90   60      0\n71  7    3  2     7     35    80   45      0\n81  8    3  2     7     50    85   35      0\n\n\n\n\n2.\nDo the same for the entire data set.\nWe can then repeat the procedure for the Copenhagen Holter Study data set.\n\n\nCode show/hide\nchs_data$timestroke <- ifelse(is.na(chs_data$timestroke),\n                              chs_data$timedeath, chs_data$timestroke)\nchs_data$timeafib <- ifelse(is.na(chs_data$timeafib),\n                            chs_data$timestroke, chs_data$timeafib)\n\nchs_long <- msprep(time = c(NA, \"timeafib\", \"timestroke\", \"timedeath\"),\n                   status = c(NA, \"afib\", \"stroke\", \"death\"),\n                   trans = tmat, data = chs_data)\n\nchs_stroketoaf<-subset(chs_data,stroke==1)\n\nchs_stroketoaf$from <- 3\nchs_stroketoaf$to <- 2\nchs_stroketoaf$trans <- 7\nchs_stroketoaf$Tstart <- chs_stroketoaf$timestroke\nchs_stroketoaf$Tstop <- ifelse(chs_stroketoaf$timeafib>chs_stroketoaf$timestroke,chs_stroketoaf$timeafib,chs_stroketoaf$timedeath)\nchs_stroketoaf$status <- ifelse(chs_stroketoaf$timeafib>chs_stroketoaf$timestroke,1,0)\nchs_stroketoaf$time <- chs_stroketoaf$Tstop - chs_stroketoaf$Tstart\nchs_stroketoaf_long <- subset(chs_stroketoaf, select = c(id,from,to,trans,Tstart,Tstop,time,status)) \n\n\nchs_finaldata <- rbind(chs_long,chs_stroketoaf_long)\n\nchs_finaldata\n\n\nAn object of class 'msdata'\n\nData:\n       id from to trans Tstart Tstop time status\n1       1    1  2     1      0  5396 5396      0\n2       1    1  3     2      0  5396 5396      0\n3       1    1  4     3      0  5396 5396      0\n4       2    1  2     1      0  5392 5392      0\n5       2    1  3     2      0  5392 5392      0\n6       2    1  4     3      0  5392 5392      0\n7       3    1  2     1      0  5373 5373      0\n8       3    1  3     2      0  5373 5373      0\n9       3    1  4     3      0  5373 5373      0\n10      4    1  2     1      0  5436 5436      0\n11      4    1  3     2      0  5436 5436      0\n12      4    1  4     3      0  5436 5436      0\n13      5    1  2     1      0  5352 5352      0\n14      5    1  3     2      0  5352 5352      0\n15      5    1  4     3      0  5352 5352      0\n16      6    1  2     1      0  5367 5367      0\n17      6    1  3     2      0  5367 5367      0\n18      6    1  4     3      0  5367 5367      0\n19      7    1  2     1      0  4184 4184      0\n20      7    1  3     2      0  4184 4184      0\n21      7    1  4     3      0  4184 4184      1\n22      8    1  2     1      0  5261 5261      0\n23      8    1  3     2      0  5261 5261      0\n24      8    1  4     3      0  5261 5261      0\n25      9    1  2     1      0  4282 4282      1\n26      9    1  3     2      0  4282 4282      0\n27      9    1  4     3      0  4282 4282      0\n28      9    2  3     4   4282  5288 1006      0\n29      9    2  4     5   4282  5288 1006      0\n30     10    1  2     1      0  3347 3347      0\n31     10    1  3     2      0  3347 3347      0\n32     10    1  4     3      0  3347 3347      1\n33     11    1  2     1      0  5420 5420      0\n34     11    1  3     2      0  5420 5420      0\n35     11    1  4     3      0  5420 5420      0\n36     12    1  2     1      0  4359 4359      1\n37     12    1  3     2      0  4359 4359      0\n38     12    1  4     3      0  4359 4359      0\n39     12    2  3     4   4359  4359    0      1\n40     12    2  4     5   4359  4359    0      0\n41     12    3  4     6   4359  5324  965      0\n42     13    1  2     1      0  5522 5522      0\n43     13    1  3     2      0  5522 5522      0\n44     13    1  4     3      0  5522 5522      0\n45     14    1  2     1      0  3786 3786      1\n46     14    1  3     2      0  3786 3786      0\n47     14    1  4     3      0  3786 3786      0\n48     14    2  3     4   3786  5337 1551      0\n49     14    2  4     5   3786  5337 1551      0\n50     15    1  2     1      0  4352 4352      0\n51     15    1  3     2      0  4352 4352      0\n52     15    1  4     3      0  4352 4352      1\n53     16    1  2     1      0  1428 1428      0\n54     16    1  3     2      0  1428 1428      0\n55     16    1  4     3      0  1428 1428      1\n56     17    1  2     1      0  5246 5246      0\n57     17    1  3     2      0  5246 5246      0\n58     17    1  4     3      0  5246 5246      0\n59     18    1  2     1      0  3325 3325      0\n60     18    1  3     2      0  3325 3325      1\n61     18    1  4     3      0  3325 3325      0\n62     18    3  4     6   3325  5506 2181      0\n63     19    1  2     1      0  2220 2220      0\n64     19    1  3     2      0  2220 2220      1\n65     19    1  4     3      0  2220 2220      0\n66     19    3  4     6   2220  2540  320      1\n67     20    1  2     1      0  1254 1254      0\n68     20    1  3     2      0  1254 1254      0\n69     20    1  4     3      0  1254 1254      1\n70     21    1  2     1      0  5415 5415      0\n71     21    1  3     2      0  5415 5415      0\n72     21    1  4     3      0  5415 5415      0\n73     22    1  2     1      0  5340 5340      0\n74     22    1  3     2      0  5340 5340      0\n75     22    1  4     3      0  5340 5340      0\n76     23    1  2     1      0  3774 3774      0\n77     23    1  3     2      0  3774 3774      0\n78     23    1  4     3      0  3774 3774      1\n79     24    1  2     1      0  5445 5445      0\n80     24    1  3     2      0  5445 5445      0\n81     24    1  4     3      0  5445 5445      0\n82     25    1  2     1      0  5353 5353      0\n83     25    1  3     2      0  5353 5353      0\n84     25    1  4     3      0  5353 5353      0\n85     26    1  2     1      0  1634 1634      0\n86     26    1  3     2      0  1634 1634      0\n87     26    1  4     3      0  1634 1634      1\n88     27    1  2     1      0  5438 5438      0\n89     27    1  3     2      0  5438 5438      0\n90     27    1  4     3      0  5438 5438      0\n91     28    1  2     1      0  5393 5393      0\n92     28    1  3     2      0  5393 5393      0\n93     28    1  4     3      0  5393 5393      0\n94     29    1  2     1      0  5449 5449      0\n95     29    1  3     2      0  5449 5449      0\n96     29    1  4     3      0  5449 5449      0\n97     30    1  2     1      0  1065 1065      0\n98     30    1  3     2      0  1065 1065      1\n99     30    1  4     3      0  1065 1065      0\n100    30    3  4     6   1065  3971 2906      1\n101    31    1  2     1      0  1911 1911      1\n102    31    1  3     2      0  1911 1911      0\n103    31    1  4     3      0  1911 1911      0\n104    31    2  3     4   1911  4760 2849      0\n105    31    2  4     5   1911  4760 2849      1\n106    32    1  2     1      0  3245 3245      0\n107    32    1  3     2      0  3245 3245      0\n108    32    1  4     3      0  3245 3245      1\n109    33    1  2     1      0  5354 5354      0\n110    33    1  3     2      0  5354 5354      0\n111    33    1  4     3      0  5354 5354      0\n112    34    1  2     1      0   490  490      0\n113    34    1  3     2      0   490  490      0\n114    34    1  4     3      0   490  490      1\n115    35    1  2     1      0  2776 2776      0\n116    35    1  3     2      0  2776 2776      1\n117    35    1  4     3      0  2776 2776      0\n118    35    3  4     6   2776  2792   16      1\n119    36    1  2     1      0  5359 5359      0\n120    36    1  3     2      0  5359 5359      0\n121    36    1  4     3      0  5359 5359      0\n122    37    1  2     1      0  5326 5326      0\n123    37    1  3     2      0  5326 5326      0\n124    37    1  4     3      0  5326 5326      0\n125    38    1  2     1      0  5284 5284      0\n126    38    1  3     2      0  5284 5284      0\n127    38    1  4     3      0  5284 5284      0\n128    39    1  2     1      0  3756 3756      0\n129    39    1  3     2      0  3756 3756      0\n130    39    1  4     3      0  3756 3756      1\n131    40    1  2     1      0  4470 4470      0\n132    40    1  3     2      0  4470 4470      0\n133    40    1  4     3      0  4470 4470      1\n134    41    1  2     1      0  2885 2885      0\n135    41    1  3     2      0  2885 2885      1\n136    41    1  4     3      0  2885 2885      0\n137    41    3  4     6   2885  4444 1559      1\n138    42    1  2     1      0  2211 2211      0\n139    42    1  3     2      0  2211 2211      0\n140    42    1  4     3      0  2211 2211      1\n141    43    1  2     1      0   476  476      0\n142    43    1  3     2      0   476  476      0\n143    43    1  4     3      0   476  476      1\n144    44    1  2     1      0  5385 5385      0\n145    44    1  3     2      0  5385 5385      0\n146    44    1  4     3      0  5385 5385      1\n147    45    1  2     1      0  1428 1428      1\n148    45    1  3     2      0  1428 1428      0\n149    45    1  4     3      0  1428 1428      0\n150    45    2  3     4   1428  1614  186      1\n151    45    2  4     5   1428  1614  186      0\n152    45    3  4     6   1614  1618    4      1\n153    46    1  2     1      0  5457 5457      0\n154    46    1  3     2      0  5457 5457      0\n155    46    1  4     3      0  5457 5457      0\n156    47    1  2     1      0  5330 5330      0\n157    47    1  3     2      0  5330 5330      0\n158    47    1  4     3      0  5330 5330      0\n159    48    1  2     1      0  3923 3923      1\n160    48    1  3     2      0  3923 3923      0\n161    48    1  4     3      0  3923 3923      0\n162    48    2  3     4   3923  5018 1095      0\n163    48    2  4     5   3923  5018 1095      1\n164    49    1  2     1      0  5361 5361      0\n165    49    1  3     2      0  5361 5361      0\n166    49    1  4     3      0  5361 5361      0\n167    50    1  2     1      0  5248 5248      0\n168    50    1  3     2      0  5248 5248      0\n169    50    1  4     3      0  5248 5248      0\n170    51    1  2     1      0  5374 5374      0\n171    51    1  3     2      0  5374 5374      0\n172    51    1  4     3      0  5374 5374      0\n173    52    1  2     1      0   716  716      1\n174    52    1  3     2      0   716  716      0\n175    52    1  4     3      0   716  716      0\n176    52    2  3     4    716  5528 4812      0\n177    52    2  4     5    716  5528 4812      0\n178    53    1  2     1      0  1989 1989      1\n179    53    1  3     2      0  1989 1989      0\n180    53    1  4     3      0  1989 1989      0\n181    53    2  3     4   1989  3825 1836      0\n182    53    2  4     5   1989  3825 1836      1\n183    54    1  2     1      0  5324 5324      0\n184    54    1  3     2      0  5324 5324      0\n185    54    1  4     3      0  5324 5324      0\n186    55    1  2     1      0  4273 4273      0\n187    55    1  3     2      0  4273 4273      0\n188    55    1  4     3      0  4273 4273      1\n189    56    1  2     1      0  2988 2988      0\n190    56    1  3     2      0  2988 2988      0\n191    56    1  4     3      0  2988 2988      1\n192    57    1  2     1      0  5336 5336      0\n193    57    1  3     2      0  5336 5336      0\n194    57    1  4     3      0  5336 5336      0\n195    58    1  2     1      0  5297 5297      0\n196    58    1  3     2      0  5297 5297      0\n197    58    1  4     3      0  5297 5297      0\n198    59    1  2     1      0  1327 1327      1\n199    59    1  3     2      0  1327 1327      0\n200    59    1  4     3      0  1327 1327      0\n201    59    2  3     4   1327  5245 3918      0\n202    59    2  4     5   1327  5245 3918      0\n203    60    1  2     1      0  5413 5413      0\n204    60    1  3     2      0  5413 5413      0\n205    60    1  4     3      0  5413 5413      0\n206    61    1  2     1      0  4727 4727      1\n207    61    1  3     2      0  4727 4727      0\n208    61    1  4     3      0  4727 4727      0\n209    61    2  3     4   4727  4916  189      0\n210    61    2  4     5   4727  4916  189      1\n211    62    1  2     1      0  5324 5324      0\n212    62    1  3     2      0  5324 5324      0\n213    62    1  4     3      0  5324 5324      0\n214    63    1  2     1      0  5423 5423      0\n215    63    1  3     2      0  5423 5423      0\n216    63    1  4     3      0  5423 5423      0\n217    64    1  2     1      0  5402 5402      0\n218    64    1  3     2      0  5402 5402      0\n219    64    1  4     3      0  5402 5402      0\n220    65    1  2     1      0  5358 5358      0\n221    65    1  3     2      0  5358 5358      0\n222    65    1  4     3      0  5358 5358      0\n223    66    1  2     1      0  5449 5449      0\n224    66    1  3     2      0  5449 5449      0\n225    66    1  4     3      0  5449 5449      0\n226    67    1  2     1      0  5414 5414      0\n227    67    1  3     2      0  5414 5414      0\n228    67    1  4     3      0  5414 5414      0\n229    68    1  2     1      0  1155 1155      0\n230    68    1  3     2      0  1155 1155      0\n231    68    1  4     3      0  1155 1155      1\n232    69    1  2     1      0  2544 2544      1\n233    69    1  3     2      0  2544 2544      0\n234    69    1  4     3      0  2544 2544      0\n235    69    2  3     4   2544  5242 2698      0\n236    69    2  4     5   2544  5242 2698      0\n237    70    1  2     1      0  5345 5345      0\n238    70    1  3     2      0  5345 5345      0\n239    70    1  4     3      0  5345 5345      0\n240    71    1  2     1      0  5359 5359      0\n241    71    1  3     2      0  5359 5359      0\n242    71    1  4     3      0  5359 5359      0\n243    72    1  2     1      0  5521 5521      0\n244    72    1  3     2      0  5521 5521      0\n245    72    1  4     3      0  5521 5521      0\n246    73    1  2     1      0  1010 1010      0\n247    73    1  3     2      0  1010 1010      1\n248    73    1  4     3      0  1010 1010      0\n249    73    3  4     6   1010  3293 2283      1\n250    74    1  2     1      0  1831 1831      0\n251    74    1  3     2      0  1831 1831      0\n252    74    1  4     3      0  1831 1831      1\n253    75    1  2     1      0  4198 4198      0\n254    75    1  3     2      0  4198 4198      0\n255    75    1  4     3      0  4198 4198      1\n256    76    1  2     1      0  5336 5336      0\n257    76    1  3     2      0  5336 5336      0\n258    76    1  4     3      0  5336 5336      0\n259    77    1  2     1      0  5442 5442      0\n260    77    1  3     2      0  5442 5442      0\n261    77    1  4     3      0  5442 5442      0\n262    78    1  2     1      0  5189 5189      1\n263    78    1  3     2      0  5189 5189      0\n264    78    1  4     3      0  5189 5189      0\n265    78    2  3     4   5189  5275   86      0\n266    78    2  4     5   5189  5275   86      0\n267    79    1  2     1      0  5350 5350      0\n268    79    1  3     2      0  5350 5350      0\n269    79    1  4     3      0  5350 5350      0\n270    80    1  2     1      0  5309 5309      0\n271    80    1  3     2      0  5309 5309      0\n272    80    1  4     3      0  5309 5309      0\n273    81    1  2     1      0  5364 5364      0\n274    81    1  3     2      0  5364 5364      0\n275    81    1  4     3      0  5364 5364      0\n276    82    1  2     1      0  5382 5382      0\n277    82    1  3     2      0  5382 5382      0\n278    82    1  4     3      0  5382 5382      0\n279    83    1  2     1      0  5386 5386      0\n280    83    1  3     2      0  5386 5386      0\n281    83    1  4     3      0  5386 5386      0\n282    84    1  2     1      0  1961 1961      0\n283    84    1  3     2      0  1961 1961      0\n284    84    1  4     3      0  1961 1961      1\n285    85    1  2     1      0  3799 3799      1\n286    85    1  3     2      0  3799 3799      0\n287    85    1  4     3      0  3799 3799      0\n288    85    2  3     4   3799  4799 1000      0\n289    85    2  4     5   3799  4799 1000      0\n290    86    1  2     1      0  5522 5522      0\n291    86    1  3     2      0  5522 5522      0\n292    86    1  4     3      0  5522 5522      0\n293    87    1  2     1      0  5458 5458      0\n294    87    1  3     2      0  5458 5458      0\n295    87    1  4     3      0  5458 5458      0\n296    88    1  2     1      0  2144 2144      1\n297    88    1  3     2      0  2144 2144      0\n298    88    1  4     3      0  2144 2144      0\n299    88    2  3     4   2144  5270 3126      0\n300    88    2  4     5   2144  5270 3126      0\n301    89    1  2     1      0  3024 3024      0\n302    89    1  3     2      0  3024 3024      1\n303    89    1  4     3      0  3024 3024      0\n304    89    3  4     6   3024  4214 1190      1\n305    90    1  2     1      0  1437 1437      0\n306    90    1  3     2      0  1437 1437      0\n307    90    1  4     3      0  1437 1437      1\n308    91    1  2     1      0  4733 4733      1\n309    91    1  3     2      0  4733 4733      0\n310    91    1  4     3      0  4733 4733      0\n311    91    2  3     4   4733  5274  541      0\n312    91    2  4     5   4733  5274  541      0\n313    92    1  2     1      0  4366 4366      0\n314    92    1  3     2      0  4366 4366      1\n315    92    1  4     3      0  4366 4366      0\n316    92    3  4     6   4366  5463 1097      0\n317    93    1  2     1      0  5444 5444      0\n318    93    1  3     2      0  5444 5444      0\n319    93    1  4     3      0  5444 5444      0\n320    94    1  2     1      0  4030 4030      0\n321    94    1  3     2      0  4030 4030      0\n322    94    1  4     3      0  4030 4030      1\n323    95    1  2     1      0  4586 4586      0\n324    95    1  3     2      0  4586 4586      1\n325    95    1  4     3      0  4586 4586      0\n326    95    3  4     6   4586  5290  704      0\n327    96    1  2     1      0  5367 5367      0\n328    96    1  3     2      0  5367 5367      0\n329    96    1  4     3      0  5367 5367      0\n330    97    1  2     1      0  5308 5308      0\n331    97    1  3     2      0  5308 5308      0\n332    97    1  4     3      0  5308 5308      0\n333    98    1  2     1      0  5445 5445      0\n334    98    1  3     2      0  5445 5445      0\n335    98    1  4     3      0  5445 5445      0\n336    99    1  2     1      0  4785 4785      0\n337    99    1  3     2      0  4785 4785      0\n338    99    1  4     3      0  4785 4785      0\n339   100    1  2     1      0  4309 4309      1\n340   100    1  3     2      0  4309 4309      0\n341   100    1  4     3      0  4309 4309      0\n342   100    2  3     4   4309  5521 1212      0\n343   100    2  4     5   4309  5521 1212      0\n344   101    1  2     1      0  4123 4123      1\n345   101    1  3     2      0  4123 4123      0\n346   101    1  4     3      0  4123 4123      0\n347   101    2  3     4   4123  5489 1366      0\n348   101    2  4     5   4123  5489 1366      0\n349   102    1  2     1      0  5390 5390      0\n350   102    1  3     2      0  5390 5390      0\n351   102    1  4     3      0  5390 5390      1\n352   103    1  2     1      0  5387 5387      0\n353   103    1  3     2      0  5387 5387      0\n354   103    1  4     3      0  5387 5387      0\n355   104    1  2     1      0  3698 3698      1\n356   104    1  3     2      0  3698 3698      0\n357   104    1  4     3      0  3698 3698      0\n358   104    2  3     4   3698  5407 1709      0\n359   104    2  4     5   3698  5407 1709      1\n360   105    1  2     1      0  5320 5320      0\n361   105    1  3     2      0  5320 5320      0\n362   105    1  4     3      0  5320 5320      0\n363   106    1  2     1      0  5345 5345      0\n364   106    1  3     2      0  5345 5345      0\n365   106    1  4     3      0  5345 5345      0\n366   107    1  2     1      0  5380 5380      0\n367   107    1  3     2      0  5380 5380      0\n368   107    1  4     3      0  5380 5380      0\n369   108    1  2     1      0  4799 4799      0\n370   108    1  3     2      0  4799 4799      0\n371   108    1  4     3      0  4799 4799      0\n372   109    1  2     1      0  5330 5330      0\n373   109    1  3     2      0  5330 5330      0\n374   109    1  4     3      0  5330 5330      0\n375   110    1  2     1      0  5473 5473      0\n376   110    1  3     2      0  5473 5473      0\n377   110    1  4     3      0  5473 5473      0\n378   111    1  2     1      0  5281 5281      0\n379   111    1  3     2      0  5281 5281      0\n380   111    1  4     3      0  5281 5281      0\n381   112    1  2     1      0  1588 1588      0\n382   112    1  3     2      0  1588 1588      0\n383   112    1  4     3      0  1588 1588      1\n384   113    1  2     1      0  5325 5325      0\n385   113    1  3     2      0  5325 5325      0\n386   113    1  4     3      0  5325 5325      0\n387   114    1  2     1      0  5506 5506      0\n388   114    1  3     2      0  5506 5506      0\n389   114    1  4     3      0  5506 5506      0\n390   115    1  2     1      0  5459 5459      0\n391   115    1  3     2      0  5459 5459      0\n392   115    1  4     3      0  5459 5459      0\n393   116    1  2     1      0  5389 5389      0\n394   116    1  3     2      0  5389 5389      0\n395   116    1  4     3      0  5389 5389      0\n396   117    1  2     1      0   898  898      0\n397   117    1  3     2      0   898  898      1\n398   117    1  4     3      0   898  898      0\n399   117    3  4     6    898  4343 3445      1\n400   118    1  2     1      0  5288 5288      0\n401   118    1  3     2      0  5288 5288      0\n402   118    1  4     3      0  5288 5288      0\n403   119    1  2     1      0  5437 5437      0\n404   119    1  3     2      0  5437 5437      0\n405   119    1  4     3      0  5437 5437      0\n406   120    1  2     1      0  1249 1249      0\n407   120    1  3     2      0  1249 1249      1\n408   120    1  4     3      0  1249 1249      0\n409   120    3  4     6   1249  1263   14      1\n410   121    1  2     1      0  2448 2448      0\n411   121    1  3     2      0  2448 2448      0\n412   121    1  4     3      0  2448 2448      1\n413   122    1  2     1      0  4784 4784      0\n414   122    1  3     2      0  4784 4784      0\n415   122    1  4     3      0  4784 4784      0\n416   123    1  2     1      0  3962 3962      0\n417   123    1  3     2      0  3962 3962      1\n418   123    1  4     3      0  3962 3962      0\n419   123    3  4     6   3962  5471 1509      0\n420   124    1  2     1      0  2016 2016      0\n421   124    1  3     2      0  2016 2016      1\n422   124    1  4     3      0  2016 2016      0\n423   124    3  4     6   2016  3882 1866      1\n424   125    1  2     1      0  5245 5245      0\n425   125    1  3     2      0  5245 5245      0\n426   125    1  4     3      0  5245 5245      0\n427   126    1  2     1      0  5266 5266      0\n428   126    1  3     2      0  5266 5266      0\n429   126    1  4     3      0  5266 5266      0\n430   127    1  2     1      0  5380 5380      0\n431   127    1  3     2      0  5380 5380      0\n432   127    1  4     3      0  5380 5380      0\n433   128    1  2     1      0  5455 5455      0\n434   128    1  3     2      0  5455 5455      0\n435   128    1  4     3      0  5455 5455      0\n436   129    1  2     1      0  5199 5199      0\n437   129    1  3     2      0  5199 5199      0\n438   129    1  4     3      0  5199 5199      1\n439   130    1  2     1      0  3715 3715      0\n440   130    1  3     2      0  3715 3715      1\n441   130    1  4     3      0  3715 3715      0\n442   130    3  4     6   3715  5395 1680      0\n443   131    1  2     1      0  5420 5420      0\n444   131    1  3     2      0  5420 5420      0\n445   131    1  4     3      0  5420 5420      0\n446   132    1  2     1      0  2965 2965      0\n447   132    1  3     2      0  2965 2965      1\n448   132    1  4     3      0  2965 2965      0\n449   132    3  4     6   2965  5351 2386      0\n450   133    1  2     1      0  3150 3150      0\n451   133    1  3     2      0  3150 3150      0\n452   133    1  4     3      0  3150 3150      1\n453   134    1  2     1      0  5319 5319      0\n454   134    1  3     2      0  5319 5319      0\n455   134    1  4     3      0  5319 5319      0\n456   135    1  2     1      0  5499 5499      0\n457   135    1  3     2      0  5499 5499      0\n458   135    1  4     3      0  5499 5499      0\n459   136    1  2     1      0    17   17      0\n460   136    1  3     2      0    17   17      0\n461   136    1  4     3      0    17   17      1\n462   137    1  2     1      0   277  277      0\n463   137    1  3     2      0   277  277      0\n464   137    1  4     3      0   277  277      1\n465   138    1  2     1      0  5435 5435      0\n466   138    1  3     2      0  5435 5435      0\n467   138    1  4     3      0  5435 5435      0\n468   139    1  2     1      0  5373 5373      0\n469   139    1  3     2      0  5373 5373      0\n470   139    1  4     3      0  5373 5373      0\n471   140    1  2     1      0  5473 5473      0\n472   140    1  3     2      0  5473 5473      0\n473   140    1  4     3      0  5473 5473      0\n474   141    1  2     1      0  5339 5339      0\n475   141    1  3     2      0  5339 5339      0\n476   141    1  4     3      0  5339 5339      0\n477   142    1  2     1      0  5325 5325      0\n478   142    1  3     2      0  5325 5325      0\n479   142    1  4     3      0  5325 5325      0\n480   143    1  2     1      0  5490 5490      0\n481   143    1  3     2      0  5490 5490      0\n482   143    1  4     3      0  5490 5490      0\n483   144    1  2     1      0  3950 3950      0\n484   144    1  3     2      0  3950 3950      0\n485   144    1  4     3      0  3950 3950      1\n486   145    1  2     1      0  5305 5305      0\n487   145    1  3     2      0  5305 5305      0\n488   145    1  4     3      0  5305 5305      0\n489   146    1  2     1      0  5413 5413      0\n490   146    1  3     2      0  5413 5413      0\n491   146    1  4     3      0  5413 5413      0\n492   147    1  2     1      0   819  819      0\n493   147    1  3     2      0   819  819      0\n494   147    1  4     3      0   819  819      1\n495   148    1  2     1      0  1841 1841      0\n496   148    1  3     2      0  1841 1841      0\n497   148    1  4     3      0  1841 1841      1\n498   149    1  2     1      0  5451 5451      0\n499   149    1  3     2      0  5451 5451      0\n500   149    1  4     3      0  5451 5451      0\n501   150    1  2     1      0  5236 5236      1\n502   150    1  3     2      0  5236 5236      0\n503   150    1  4     3      0  5236 5236      0\n504   150    2  3     4   5236  5373  137      0\n505   150    2  4     5   5236  5373  137      0\n506   151    1  2     1      0  4534 4534      1\n507   151    1  3     2      0  4534 4534      0\n508   151    1  4     3      0  4534 4534      0\n509   151    2  3     4   4534  5368  834      0\n510   151    2  4     5   4534  5368  834      0\n511   152    1  2     1      0  5353 5353      0\n512   152    1  3     2      0  5353 5353      0\n513   152    1  4     3      0  5353 5353      0\n514   153    1  2     1      0  5375 5375      0\n515   153    1  3     2      0  5375 5375      0\n516   153    1  4     3      0  5375 5375      0\n517   154    1  2     1      0  5469 5469      0\n518   154    1  3     2      0  5469 5469      0\n519   154    1  4     3      0  5469 5469      0\n520   155    1  2     1      0  5305 5305      0\n521   155    1  3     2      0  5305 5305      0\n522   155    1  4     3      0  5305 5305      0\n523   156    1  2     1      0  5253 5253      0\n524   156    1  3     2      0  5253 5253      0\n525   156    1  4     3      0  5253 5253      0\n526   157    1  2     1      0  5259 5259      0\n527   157    1  3     2      0  5259 5259      0\n528   157    1  4     3      0  5259 5259      0\n529   158    1  2     1      0  5368 5368      0\n530   158    1  3     2      0  5368 5368      0\n531   158    1  4     3      0  5368 5368      0\n532   159    1  2     1      0  5308 5308      0\n533   159    1  3     2      0  5308 5308      0\n534   159    1  4     3      0  5308 5308      0\n535   160    1  2     1      0  5469 5469      0\n536   160    1  3     2      0  5469 5469      0\n537   160    1  4     3      0  5469 5469      0\n538   161    1  2     1      0  5353 5353      0\n539   161    1  3     2      0  5353 5353      0\n540   161    1  4     3      0  5353 5353      0\n541   162    1  2     1      0  5340 5340      0\n542   162    1  3     2      0  5340 5340      0\n543   162    1  4     3      0  5340 5340      0\n544   163    1  2     1      0  2986 2986      0\n545   163    1  3     2      0  2986 2986      0\n546   163    1  4     3      0  2986 2986      1\n547   164    1  2     1      0  2037 2037      0\n548   164    1  3     2      0  2037 2037      1\n549   164    1  4     3      0  2037 2037      0\n550   164    3  4     6   2037  3906 1869      1\n551   165    1  2     1      0  4794 4794      0\n552   165    1  3     2      0  4794 4794      0\n553   165    1  4     3      0  4794 4794      0\n554   166    1  2     1      0  5325 5325      1\n555   166    1  3     2      0  5325 5325      0\n556   166    1  4     3      0  5325 5325      0\n557   166    2  3     4   5325  5450  125      0\n558   166    2  4     5   5325  5450  125      0\n559   167    1  2     1      0  5289 5289      0\n560   167    1  3     2      0  5289 5289      0\n561   167    1  4     3      0  5289 5289      0\n562   168    1  2     1      0  5414 5414      0\n563   168    1  3     2      0  5414 5414      0\n564   168    1  4     3      0  5414 5414      0\n565   169    1  2     1      0  5248 5248      0\n566   169    1  3     2      0  5248 5248      0\n567   169    1  4     3      0  5248 5248      0\n568   170    1  2     1      0  3879 3879      0\n569   170    1  3     2      0  3879 3879      0\n570   170    1  4     3      0  3879 3879      1\n571   171    1  2     1      0  5177 5177      0\n572   171    1  3     2      0  5177 5177      0\n573   171    1  4     3      0  5177 5177      1\n574   172    1  2     1      0  1960 1960      0\n575   172    1  3     2      0  1960 1960      0\n576   172    1  4     3      0  1960 1960      1\n577   173    1  2     1      0  5382 5382      0\n578   173    1  3     2      0  5382 5382      0\n579   173    1  4     3      0  5382 5382      0\n580   174    1  2     1      0  5441 5441      0\n581   174    1  3     2      0  5441 5441      0\n582   174    1  4     3      0  5441 5441      0\n583   175    1  2     1      0  1440 1440      0\n584   175    1  3     2      0  1440 1440      0\n585   175    1  4     3      0  1440 1440      1\n586   176    1  2     1      0  3974 3974      0\n587   176    1  3     2      0  3974 3974      0\n588   176    1  4     3      0  3974 3974      1\n589   177    1  2     1      0  5330 5330      0\n590   177    1  3     2      0  5330 5330      0\n591   177    1  4     3      0  5330 5330      0\n592   178    1  2     1      0  5289 5289      0\n593   178    1  3     2      0  5289 5289      0\n594   178    1  4     3      0  5289 5289      0\n595   179    1  2     1      0   650  650      0\n596   179    1  3     2      0   650  650      0\n597   179    1  4     3      0   650  650      1\n598   180    1  2     1      0  5333 5333      0\n599   180    1  3     2      0  5333 5333      0\n600   180    1  4     3      0  5333 5333      0\n601   181    1  2     1      0  4988 4988      0\n602   181    1  3     2      0  4988 4988      0\n603   181    1  4     3      0  4988 4988      1\n604   182    1  2     1      0   915  915      0\n605   182    1  3     2      0   915  915      0\n606   182    1  4     3      0   915  915      1\n607   183    1  2     1      0  2810 2810      0\n608   183    1  3     2      0  2810 2810      1\n609   183    1  4     3      0  2810 2810      0\n610   183    3  4     6   2810  5280 2470      0\n611   184    1  2     1      0  5280 5280      0\n612   184    1  3     2      0  5280 5280      0\n613   184    1  4     3      0  5280 5280      0\n614   185    1  2     1      0  5318 5318      0\n615   185    1  3     2      0  5318 5318      0\n616   185    1  4     3      0  5318 5318      0\n617   186    1  2     1      0  5252 5252      0\n618   186    1  3     2      0  5252 5252      0\n619   186    1  4     3      0  5252 5252      0\n620   187    1  2     1      0  3381 3381      0\n621   187    1  3     2      0  3381 3381      1\n622   187    1  4     3      0  3381 3381      0\n623   187    3  4     6   3381  4208  827      1\n624   188    1  2     1      0  5513 5513      0\n625   188    1  3     2      0  5513 5513      0\n626   188    1  4     3      0  5513 5513      0\n627   189    1  2     1      0  5408 5408      0\n628   189    1  3     2      0  5408 5408      0\n629   189    1  4     3      0  5408 5408      0\n630   190    1  2     1      0  5311 5311      0\n631   190    1  3     2      0  5311 5311      0\n632   190    1  4     3      0  5311 5311      0\n633   191    1  2     1      0  5386 5386      0\n634   191    1  3     2      0  5386 5386      0\n635   191    1  4     3      0  5386 5386      0\n636   192    1  2     1      0  5414 5414      0\n637   192    1  3     2      0  5414 5414      0\n638   192    1  4     3      0  5414 5414      0\n639   193    1  2     1      0  3852 3852      0\n640   193    1  3     2      0  3852 3852      0\n641   193    1  4     3      0  3852 3852      1\n642   194    1  2     1      0  5352 5352      0\n643   194    1  3     2      0  5352 5352      0\n644   194    1  4     3      0  5352 5352      0\n645   195    1  2     1      0  3753 3753      0\n646   195    1  3     2      0  3753 3753      1\n647   195    1  4     3      0  3753 3753      0\n648   195    3  4     6   3753  5380 1627      0\n649   196    1  2     1      0  5357 5357      0\n650   196    1  3     2      0  5357 5357      0\n651   196    1  4     3      0  5357 5357      0\n652   197    1  2     1      0  5473 5473      0\n653   197    1  3     2      0  5473 5473      0\n654   197    1  4     3      0  5473 5473      0\n655   198    1  2     1      0  5395 5395      0\n656   198    1  3     2      0  5395 5395      0\n657   198    1  4     3      0  5395 5395      0\n658   199    1  2     1      0  3729 3729      0\n659   199    1  3     2      0  3729 3729      0\n660   199    1  4     3      0  3729 3729      1\n661   200    1  2     1      0  5431 5431      0\n662   200    1  3     2      0  5431 5431      0\n663   200    1  4     3      0  5431 5431      0\n664   201    1  2     1      0  4213 4213      0\n665   201    1  3     2      0  4213 4213      0\n666   201    1  4     3      0  4213 4213      1\n667   202    1  2     1      0  1557 1557      0\n668   202    1  3     2      0  1557 1557      0\n669   202    1  4     3      0  1557 1557      1\n670   203    1  2     1      0  4776 4776      0\n671   203    1  3     2      0  4776 4776      0\n672   203    1  4     3      0  4776 4776      0\n673   204    1  2     1      0  3035 3035      0\n674   204    1  3     2      0  3035 3035      0\n675   204    1  4     3      0  3035 3035      1\n676   205    1  2     1      0  5297 5297      0\n677   205    1  3     2      0  5297 5297      0\n678   205    1  4     3      0  5297 5297      0\n679   206    1  2     1      0  5282 5282      0\n680   206    1  3     2      0  5282 5282      0\n681   206    1  4     3      0  5282 5282      0\n682   207    1  2     1      0  2430 2430      0\n683   207    1  3     2      0  2430 2430      0\n684   207    1  4     3      0  2430 2430      1\n685   208    1  2     1      0  5449 5449      0\n686   208    1  3     2      0  5449 5449      0\n687   208    1  4     3      0  5449 5449      0\n688   209    1  2     1      0  5380 5380      0\n689   209    1  3     2      0  5380 5380      0\n690   209    1  4     3      0  5380 5380      0\n691   210    1  2     1      0  5373 5373      0\n692   210    1  3     2      0  5373 5373      0\n693   210    1  4     3      0  5373 5373      0\n694   211    1  2     1      0  5268 5268      0\n695   211    1  3     2      0  5268 5268      0\n696   211    1  4     3      0  5268 5268      0\n697   212    1  2     1      0  5240 5240      0\n698   212    1  3     2      0  5240 5240      0\n699   212    1  4     3      0  5240 5240      0\n700   213    1  2     1      0  5379 5379      0\n701   213    1  3     2      0  5379 5379      0\n702   213    1  4     3      0  5379 5379      0\n703   214    1  2     1      0  5399 5399      0\n704   214    1  3     2      0  5399 5399      0\n705   214    1  4     3      0  5399 5399      0\n706   215    1  2     1      0  5084 5084      0\n707   215    1  3     2      0  5084 5084      0\n708   215    1  4     3      0  5084 5084      1\n709   216    1  2     1      0  5351 5351      0\n710   216    1  3     2      0  5351 5351      0\n711   216    1  4     3      0  5351 5351      0\n712   217    1  2     1      0  4489 4489      0\n713   217    1  3     2      0  4489 4489      0\n714   217    1  4     3      0  4489 4489      1\n715   218    1  2     1      0  5526 5526      0\n716   218    1  3     2      0  5526 5526      0\n717   218    1  4     3      0  5526 5526      0\n718   219    1  2     1      0  5395 5395      0\n719   219    1  3     2      0  5395 5395      0\n720   219    1  4     3      0  5395 5395      0\n721   220    1  2     1      0  5513 5513      0\n722   220    1  3     2      0  5513 5513      0\n723   220    1  4     3      0  5513 5513      0\n724   221    1  2     1      0  4388 4388      0\n725   221    1  3     2      0  4388 4388      0\n726   221    1  4     3      0  4388 4388      1\n727   222    1  2     1      0  5457 5457      0\n728   222    1  3     2      0  5457 5457      0\n729   222    1  4     3      0  5457 5457      0\n730   223    1  2     1      0  2531 2531      1\n731   223    1  3     2      0  2531 2531      0\n732   223    1  4     3      0  2531 2531      0\n733   223    2  3     4   2531  3679 1148      1\n734   223    2  4     5   2531  3679 1148      0\n735   223    3  4     6   3679  3700   21      1\n736   224    1  2     1      0  5310 5310      0\n737   224    1  3     2      0  5310 5310      0\n738   224    1  4     3      0  5310 5310      0\n739   225    1  2     1      0  5522 5522      0\n740   225    1  3     2      0  5522 5522      0\n741   225    1  4     3      0  5522 5522      0\n742   226    1  2     1      0  4303 4303      0\n743   226    1  3     2      0  4303 4303      0\n744   226    1  4     3      0  4303 4303      1\n745   227    1  2     1      0  3086 3086      0\n746   227    1  3     2      0  3086 3086      0\n747   227    1  4     3      0  3086 3086      1\n748   228    1  2     1      0  3956 3956      1\n749   228    1  3     2      0  3956 3956      0\n750   228    1  4     3      0  3956 3956      0\n751   228    2  3     4   3956  4158  202      1\n752   228    2  4     5   3956  4158  202      0\n753   228    3  4     6   4158  4661  503      1\n754   229    1  2     1      0  2145 2145      0\n755   229    1  3     2      0  2145 2145      0\n756   229    1  4     3      0  2145 2145      1\n757   230    1  2     1      0  5463 5463      0\n758   230    1  3     2      0  5463 5463      0\n759   230    1  4     3      0  5463 5463      0\n760   231    1  2     1      0  5337 5337      0\n761   231    1  3     2      0  5337 5337      0\n762   231    1  4     3      0  5337 5337      0\n763   232    1  2     1      0  5364 5364      0\n764   232    1  3     2      0  5364 5364      0\n765   232    1  4     3      0  5364 5364      0\n766   233    1  2     1      0  2306 2306      0\n767   233    1  3     2      0  2306 2306      0\n768   233    1  4     3      0  2306 2306      1\n769   234    1  2     1      0  5326 5326      0\n770   234    1  3     2      0  5326 5326      0\n771   234    1  4     3      0  5326 5326      0\n772   235    1  2     1      0  5433 5433      0\n773   235    1  3     2      0  5433 5433      0\n774   235    1  4     3      0  5433 5433      0\n775   236    1  2     1      0  4030 4030      0\n776   236    1  3     2      0  4030 4030      0\n777   236    1  4     3      0  4030 4030      1\n778   237    1  2     1      0  2329 2329      0\n779   237    1  3     2      0  2329 2329      0\n780   237    1  4     3      0  2329 2329      1\n781   238    1  2     1      0  1032 1032      0\n782   238    1  3     2      0  1032 1032      0\n783   238    1  4     3      0  1032 1032      1\n784   239    1  2     1      0  4694 4694      0\n785   239    1  3     2      0  4694 4694      0\n786   239    1  4     3      0  4694 4694      1\n787   240    1  2     1      0  1340 1340      0\n788   240    1  3     2      0  1340 1340      0\n789   240    1  4     3      0  1340 1340      1\n790   241    1  2     1      0  5360 5360      0\n791   241    1  3     2      0  5360 5360      0\n792   241    1  4     3      0  5360 5360      0\n793   242    1  2     1      0  1269 1269      0\n794   242    1  3     2      0  1269 1269      1\n795   242    1  4     3      0  1269 1269      0\n796   242    3  4     6   1269  1269    0      1\n797   243    1  2     1      0  4747 4747      1\n798   243    1  3     2      0  4747 4747      0\n799   243    1  4     3      0  4747 4747      0\n800   243    2  3     4   4747  5366  619      0\n801   243    2  4     5   4747  5366  619      0\n802   244    1  2     1      0  3233 3233      1\n803   244    1  3     2      0  3233 3233      0\n804   244    1  4     3      0  3233 3233      0\n805   244    2  3     4   3233  5466 2233      0\n806   244    2  4     5   3233  5466 2233      0\n807   245    1  2     1      0  5452 5452      0\n808   245    1  3     2      0  5452 5452      0\n809   245    1  4     3      0  5452 5452      0\n810   246    1  2     1      0  5214 5214      0\n811   246    1  3     2      0  5214 5214      0\n812   246    1  4     3      0  5214 5214      1\n813   247    1  2     1      0  1040 1040      0\n814   247    1  3     2      0  1040 1040      0\n815   247    1  4     3      0  1040 1040      1\n816   248    1  2     1      0  5388 5388      0\n817   248    1  3     2      0  5388 5388      0\n818   248    1  4     3      0  5388 5388      0\n819   249    1  2     1      0  5413 5413      0\n820   249    1  3     2      0  5413 5413      0\n821   249    1  4     3      0  5413 5413      0\n822   250    1  2     1      0  1245 1245      0\n823   250    1  3     2      0  1245 1245      1\n824   250    1  4     3      0  1245 1245      0\n825   250    3  4     6   1245  2505 1260      1\n826   251    1  2     1      0  5340 5340      0\n827   251    1  3     2      0  5340 5340      0\n828   251    1  4     3      0  5340 5340      0\n829   252    1  2     1      0  5400 5400      0\n830   252    1  3     2      0  5400 5400      0\n831   252    1  4     3      0  5400 5400      0\n832   253    1  2     1      0  5438 5438      0\n833   253    1  3     2      0  5438 5438      0\n834   253    1  4     3      0  5438 5438      0\n835   254    1  2     1      0  5493 5493      0\n836   254    1  3     2      0  5493 5493      0\n837   254    1  4     3      0  5493 5493      0\n838   255    1  2     1      0  5388 5388      0\n839   255    1  3     2      0  5388 5388      0\n840   255    1  4     3      0  5388 5388      0\n841   256    1  2     1      0  5242 5242      0\n842   256    1  3     2      0  5242 5242      0\n843   256    1  4     3      0  5242 5242      0\n844   257    1  2     1      0  5260 5260      0\n845   257    1  3     2      0  5260 5260      0\n846   257    1  4     3      0  5260 5260      0\n847   258    1  2     1      0   465  465      0\n848   258    1  3     2      0   465  465      1\n849   258    1  4     3      0   465  465      0\n850   258    3  4     6    465  5249 4784      0\n851   259    1  2     1      0  5414 5414      0\n852   259    1  3     2      0  5414 5414      0\n853   259    1  4     3      0  5414 5414      0\n854   260    1  2     1      0  5284 5284      0\n855   260    1  3     2      0  5284 5284      0\n856   260    1  4     3      0  5284 5284      0\n857   261    1  2     1      0  2957 2957      1\n858   261    1  3     2      0  2957 2957      0\n859   261    1  4     3      0  2957 2957      0\n860   261    2  3     4   2957  3201  244      1\n861   261    2  4     5   2957  3201  244      0\n862   261    3  4     6   3201  3210    9      1\n863   262    1  2     1      0  5445 5445      0\n864   262    1  3     2      0  5445 5445      0\n865   262    1  4     3      0  5445 5445      0\n866   263    1  2     1      0  5393 5393      0\n867   263    1  3     2      0  5393 5393      0\n868   263    1  4     3      0  5393 5393      0\n869   264    1  2     1      0  3363 3363      0\n870   264    1  3     2      0  3363 3363      0\n871   264    1  4     3      0  3363 3363      1\n872   265    1  2     1      0  5310 5310      0\n873   265    1  3     2      0  5310 5310      0\n874   265    1  4     3      0  5310 5310      0\n875   266    1  2     1      0  5388 5388      0\n876   266    1  3     2      0  5388 5388      0\n877   266    1  4     3      0  5388 5388      0\n878   267    1  2     1      0  1984 1984      0\n879   267    1  3     2      0  1984 1984      1\n880   267    1  4     3      0  1984 1984      0\n881   267    3  4     6   1984  1984    0      1\n882   268    1  2     1      0  1558 1558      0\n883   268    1  3     2      0  1558 1558      0\n884   268    1  4     3      0  1558 1558      1\n885   269    1  2     1      0  4714 4714      0\n886   269    1  3     2      0  4714 4714      0\n887   269    1  4     3      0  4714 4714      1\n888   270    1  2     1      0  4707 4707      0\n889   270    1  3     2      0  4707 4707      0\n890   270    1  4     3      0  4707 4707      1\n891   271    1  2     1      0  5200 5200      0\n892   271    1  3     2      0  5200 5200      0\n893   271    1  4     3      0  5200 5200      1\n894   272    1  2     1      0   571  571      0\n895   272    1  3     2      0   571  571      0\n896   272    1  4     3      0   571  571      1\n897   273    1  2     1      0  5472 5472      0\n898   273    1  3     2      0  5472 5472      0\n899   273    1  4     3      0  5472 5472      0\n900   274    1  2     1      0   379  379      0\n901   274    1  3     2      0   379  379      1\n902   274    1  4     3      0   379  379      0\n903   274    3  4     6    379   866  487      1\n904   275    1  2     1      0  4017 4017      0\n905   275    1  3     2      0  4017 4017      1\n906   275    1  4     3      0  4017 4017      0\n907   275    3  4     6   4017  5289 1272      0\n908   276    1  2     1      0  5332 5332      0\n909   276    1  3     2      0  5332 5332      0\n910   276    1  4     3      0  5332 5332      0\n911   277    1  2     1      0  5359 5359      0\n912   277    1  3     2      0  5359 5359      0\n913   277    1  4     3      0  5359 5359      0\n914   278    1  2     1      0  5526 5526      0\n915   278    1  3     2      0  5526 5526      0\n916   278    1  4     3      0  5526 5526      0\n917   279    1  2     1      0  3307 3307      0\n918   279    1  3     2      0  3307 3307      0\n919   279    1  4     3      0  3307 3307      1\n920   280    1  2     1      0  3509 3509      0\n921   280    1  3     2      0  3509 3509      0\n922   280    1  4     3      0  3509 3509      1\n923   281    1  2     1      0  5382 5382      0\n924   281    1  3     2      0  5382 5382      0\n925   281    1  4     3      0  5382 5382      0\n926   282    1  2     1      0  4132 4132      0\n927   282    1  3     2      0  4132 4132      0\n928   282    1  4     3      0  4132 4132      1\n929   283    1  2     1      0  4793 4793      0\n930   283    1  3     2      0  4793 4793      0\n931   283    1  4     3      0  4793 4793      0\n932   284    1  2     1      0  3550 3550      0\n933   284    1  3     2      0  3550 3550      0\n934   284    1  4     3      0  3550 3550      1\n935   285    1  2     1      0  2175 2175      0\n936   285    1  3     2      0  2175 2175      1\n937   285    1  4     3      0  2175 2175      0\n938   285    3  4     6   2175  3880 1705      1\n939   286    1  2     1      0  2696 2696      0\n940   286    1  3     2      0  2696 2696      0\n941   286    1  4     3      0  2696 2696      1\n942   287    1  2     1      0  5241 5241      0\n943   287    1  3     2      0  5241 5241      0\n944   287    1  4     3      0  5241 5241      0\n945   288    1  2     1      0  4363 4363      1\n946   288    1  3     2      0  4363 4363      0\n947   288    1  4     3      0  4363 4363      0\n948   288    2  3     4   4363  5432 1069      1\n949   288    2  4     5   4363  5432 1069      0\n950   288    3  4     6   5432  5535  103      0\n951   289    1  2     1      0   954  954      0\n952   289    1  3     2      0   954  954      1\n953   289    1  4     3      0   954  954      0\n954   289    3  4     6    954   995   41      1\n955   290    1  2     1      0  5324 5324      0\n956   290    1  3     2      0  5324 5324      0\n957   290    1  4     3      0  5324 5324      0\n958   291    1  2     1      0  3534 3534      0\n959   291    1  3     2      0  3534 3534      0\n960   291    1  4     3      0  3534 3534      1\n961   292    1  2     1      0  3174 3174      1\n962   292    1  3     2      0  3174 3174      0\n963   292    1  4     3      0  3174 3174      0\n964   292    2  3     4   3174  5462 2288      0\n965   292    2  4     5   3174  5462 2288      0\n966   293    1  2     1      0  2425 2425      0\n967   293    1  3     2      0  2425 2425      0\n968   293    1  4     3      0  2425 2425      1\n969   294    1  2     1      0  5345 5345      0\n970   294    1  3     2      0  5345 5345      0\n971   294    1  4     3      0  5345 5345      0\n972   295    1  2     1      0  1869 1869      0\n973   295    1  3     2      0  1869 1869      1\n974   295    1  4     3      0  1869 1869      0\n975   295    3  4     6   1869  3149 1280      1\n976   296    1  2     1      0  4711 4711      1\n977   296    1  3     2      0  4711 4711      0\n978   296    1  4     3      0  4711 4711      0\n979   296    2  3     4   4711  5248  537      0\n980   296    2  4     5   4711  5248  537      0\n981   297    1  2     1      0  2639 2639      0\n982   297    1  3     2      0  2639 2639      0\n983   297    1  4     3      0  2639 2639      1\n984   298    1  2     1      0  1842 1842      0\n985   298    1  3     2      0  1842 1842      0\n986   298    1  4     3      0  1842 1842      1\n987   299    1  2     1      0   620  620      0\n988   299    1  3     2      0   620  620      1\n989   299    1  4     3      0   620  620      0\n990   299    3  4     6    620  3456 2836      1\n991   300    1  2     1      0  5133 5133      0\n992   300    1  3     2      0  5133 5133      0\n993   300    1  4     3      0  5133 5133      1\n994   301    1  2     1      0  2684 2684      0\n995   301    1  3     2      0  2684 2684      0\n996   301    1  4     3      0  2684 2684      1\n997   302    1  2     1      0  2575 2575      0\n998   302    1  3     2      0  2575 2575      1\n999   302    1  4     3      0  2575 2575      0\n1000  302    3  4     6   2575  4595 2020      1\n1001  303    1  2     1      0  5319 5319      0\n1002  303    1  3     2      0  5319 5319      0\n1003  303    1  4     3      0  5319 5319      0\n1004  304    1  2     1      0  5395 5395      0\n1005  304    1  3     2      0  5395 5395      0\n1006  304    1  4     3      0  5395 5395      0\n1007  305    1  2     1      0  1471 1471      0\n1008  305    1  3     2      0  1471 1471      0\n1009  305    1  4     3      0  1471 1471      1\n1010  306    1  2     1      0  5350 5350      0\n1011  306    1  3     2      0  5350 5350      0\n1012  306    1  4     3      0  5350 5350      0\n1013  307    1  2     1      0  5436 5436      0\n1014  307    1  3     2      0  5436 5436      0\n1015  307    1  4     3      0  5436 5436      0\n1016  308    1  2     1      0  1300 1300      0\n1017  308    1  3     2      0  1300 1300      0\n1018  308    1  4     3      0  1300 1300      1\n1019  309    1  2     1      0  1101 1101      0\n1020  309    1  3     2      0  1101 1101      0\n1021  309    1  4     3      0  1101 1101      1\n1022  310    1  2     1      0  1859 1859      0\n1023  310    1  3     2      0  1859 1859      0\n1024  310    1  4     3      0  1859 1859      1\n1025  311    1  2     1      0  3937 3937      1\n1026  311    1  3     2      0  3937 3937      0\n1027  311    1  4     3      0  3937 3937      0\n1028  311    2  3     4   3937  5464 1527      0\n1029  311    2  4     5   3937  5464 1527      0\n1030  312    1  2     1      0  3020 3020      0\n1031  312    1  3     2      0  3020 3020      0\n1032  312    1  4     3      0  3020 3020      1\n1033  313    1  2     1      0  5297 5297      0\n1034  313    1  3     2      0  5297 5297      0\n1035  313    1  4     3      0  5297 5297      0\n1036  314    1  2     1      0  5308 5308      0\n1037  314    1  3     2      0  5308 5308      0\n1038  314    1  4     3      0  5308 5308      0\n1039  315    1  2     1      0  1029 1029      1\n1040  315    1  3     2      0  1029 1029      0\n1041  315    1  4     3      0  1029 1029      0\n1042  315    2  3     4   1029  1983  954      0\n1043  315    2  4     5   1029  1983  954      1\n1044  316    1  2     1      0  2441 2441      1\n1045  316    1  3     2      0  2441 2441      0\n1046  316    1  4     3      0  2441 2441      0\n1047  316    2  3     4   2441  3800 1359      0\n1048  316    2  4     5   2441  3800 1359      1\n1049  317    1  2     1      0  3749 3749      0\n1050  317    1  3     2      0  3749 3749      0\n1051  317    1  4     3      0  3749 3749      1\n1052  318    1  2     1      0  5457 5457      0\n1053  318    1  3     2      0  5457 5457      0\n1054  318    1  4     3      0  5457 5457      0\n1055  319    1  2     1      0  5277 5277      0\n1056  319    1  3     2      0  5277 5277      0\n1057  319    1  4     3      0  5277 5277      0\n1058  320    1  2     1      0  1731 1731      0\n1059  320    1  3     2      0  1731 1731      0\n1060  320    1  4     3      0  1731 1731      1\n1061  321    1  2     1      0  4794 4794      0\n1062  321    1  3     2      0  4794 4794      0\n1063  321    1  4     3      0  4794 4794      0\n1064  322    1  2     1      0  1022 1022      0\n1065  322    1  3     2      0  1022 1022      0\n1066  322    1  4     3      0  1022 1022      1\n1067  323    1  2     1      0  2553 2553      1\n1068  323    1  3     2      0  2553 2553      0\n1069  323    1  4     3      0  2553 2553      0\n1070  323    2  3     4   2553  5325 2772      0\n1071  323    2  4     5   2553  5325 2772      0\n1072  324    1  2     1      0  3492 3492      0\n1073  324    1  3     2      0  3492 3492      0\n1074  324    1  4     3      0  3492 3492      1\n1075  325    1  2     1      0  3443 3443      1\n1076  325    1  3     2      0  3443 3443      0\n1077  325    1  4     3      0  3443 3443      0\n1078  325    2  3     4   3443  5291 1848      0\n1079  325    2  4     5   3443  5291 1848      0\n1080  326    1  2     1      0  5325 5325      0\n1081  326    1  3     2      0  5325 5325      0\n1082  326    1  4     3      0  5325 5325      0\n1083  327    1  2     1      0  4455 4455      1\n1084  327    1  3     2      0  4455 4455      0\n1085  327    1  4     3      0  4455 4455      0\n1086  327    2  3     4   4455  5332  877      0\n1087  327    2  4     5   4455  5332  877      0\n1088  328    1  2     1      0  5273 5273      0\n1089  328    1  3     2      0  5273 5273      0\n1090  328    1  4     3      0  5273 5273      0\n1091  329    1  2     1      0  5350 5350      0\n1092  329    1  3     2      0  5350 5350      0\n1093  329    1  4     3      0  5350 5350      0\n1094  330    1  2     1      0  5326 5326      0\n1095  330    1  3     2      0  5326 5326      0\n1096  330    1  4     3      0  5326 5326      0\n1097  331    1  2     1      0  5247 5247      0\n1098  331    1  3     2      0  5247 5247      0\n1099  331    1  4     3      0  5247 5247      0\n1100  332    1  2     1      0  3796 3796      0\n1101  332    1  3     2      0  3796 3796      0\n1102  332    1  4     3      0  3796 3796      1\n1103  333    1  2     1      0  5305 5305      0\n1104  333    1  3     2      0  5305 5305      0\n1105  333    1  4     3      0  5305 5305      0\n1106  334    1  2     1      0  5410 5410      0\n1107  334    1  3     2      0  5410 5410      0\n1108  334    1  4     3      0  5410 5410      0\n1109  335    1  2     1      0  1736 1736      0\n1110  335    1  3     2      0  1736 1736      0\n1111  335    1  4     3      0  1736 1736      1\n1112  336    1  2     1      0  4048 4048      1\n1113  336    1  3     2      0  4048 4048      0\n1114  336    1  4     3      0  4048 4048      0\n1115  336    2  3     4   4048  4612  564      0\n1116  336    2  4     5   4048  4612  564      1\n1117  337    1  2     1      0  2487 2487      0\n1118  337    1  3     2      0  2487 2487      1\n1119  337    1  4     3      0  2487 2487      0\n1120  337    3  4     6   2487  2617  130      1\n1121  338    1  2     1      0  3170 3170      0\n1122  338    1  3     2      0  3170 3170      0\n1123  338    1  4     3      0  3170 3170      1\n1124  339    1  2     1      0  2296 2296      0\n1125  339    1  3     2      0  2296 2296      0\n1126  339    1  4     3      0  2296 2296      1\n1127  340    1  2     1      0  5452 5452      0\n1128  340    1  3     2      0  5452 5452      0\n1129  340    1  4     3      0  5452 5452      0\n1130  341    1  2     1      0  4556 4556      0\n1131  341    1  3     2      0  4556 4556      1\n1132  341    1  4     3      0  4556 4556      0\n1133  341    3  4     6   4556  5277  721      0\n1134  342    1  2     1      0  5312 5312      0\n1135  342    1  3     2      0  5312 5312      0\n1136  342    1  4     3      0  5312 5312      0\n1137  343    1  2     1      0  5352 5352      0\n1138  343    1  3     2      0  5352 5352      0\n1139  343    1  4     3      0  5352 5352      0\n1140  344    1  2     1      0  5360 5360      0\n1141  344    1  3     2      0  5360 5360      0\n1142  344    1  4     3      0  5360 5360      0\n1143  345    1  2     1      0  5535 5535      0\n1144  345    1  3     2      0  5535 5535      0\n1145  345    1  4     3      0  5535 5535      0\n1146  346    1  2     1      0  3843 3843      1\n1147  346    1  3     2      0  3843 3843      0\n1148  346    1  4     3      0  3843 3843      0\n1149  346    2  3     4   3843  4404  561      0\n1150  346    2  4     5   3843  4404  561      1\n1151  347    1  2     1      0  2049 2049      1\n1152  347    1  3     2      0  2049 2049      0\n1153  347    1  4     3      0  2049 2049      0\n1154  347    2  3     4   2049  4351 2302      0\n1155  347    2  4     5   2049  4351 2302      1\n1156  348    1  2     1      0   984  984      1\n1157  348    1  3     2      0   984  984      0\n1158  348    1  4     3      0   984  984      0\n1159  348    2  3     4    984  4238 3254      0\n1160  348    2  4     5    984  4238 3254      1\n1161  349    1  2     1      0  5274 5274      0\n1162  349    1  3     2      0  5274 5274      0\n1163  349    1  4     3      0  5274 5274      0\n1164  350    1  2     1      0  4387 4387      0\n1165  350    1  3     2      0  4387 4387      0\n1166  350    1  4     3      0  4387 4387      1\n1167  351    1  2     1      0  4327 4327      0\n1168  351    1  3     2      0  4327 4327      0\n1169  351    1  4     3      0  4327 4327      1\n1170  352    1  2     1      0  3344 3344      1\n1171  352    1  3     2      0  3344 3344      0\n1172  352    1  4     3      0  3344 3344      0\n1173  352    2  3     4   3344  3360   16      0\n1174  352    2  4     5   3344  3360   16      1\n1175  353    1  2     1      0  4431 4431      0\n1176  353    1  3     2      0  4431 4431      0\n1177  353    1  4     3      0  4431 4431      1\n1178  354    1  2     1      0  5392 5392      0\n1179  354    1  3     2      0  5392 5392      0\n1180  354    1  4     3      0  5392 5392      0\n1181  355    1  2     1      0  5416 5416      0\n1182  355    1  3     2      0  5416 5416      0\n1183  355    1  4     3      0  5416 5416      0\n1184  356    1  2     1      0  5375 5375      0\n1185  356    1  3     2      0  5375 5375      0\n1186  356    1  4     3      0  5375 5375      0\n1187  357    1  2     1      0  3680 3680      0\n1188  357    1  3     2      0  3680 3680      0\n1189  357    1  4     3      0  3680 3680      1\n1190  358    1  2     1      0  5365 5365      0\n1191  358    1  3     2      0  5365 5365      0\n1192  358    1  4     3      0  5365 5365      0\n1193  359    1  2     1      0  5319 5319      0\n1194  359    1  3     2      0  5319 5319      0\n1195  359    1  4     3      0  5319 5319      0\n1196  360    1  2     1      0  5396 5396      0\n1197  360    1  3     2      0  5396 5396      0\n1198  360    1  4     3      0  5396 5396      0\n1199  361    1  2     1      0  5528 5528      0\n1200  361    1  3     2      0  5528 5528      0\n1201  361    1  4     3      0  5528 5528      0\n1202  362    1  2     1      0  5518 5518      0\n1203  362    1  3     2      0  5518 5518      0\n1204  362    1  4     3      0  5518 5518      0\n1205  363    1  2     1      0   164  164      0\n1206  363    1  3     2      0   164  164      0\n1207  363    1  4     3      0   164  164      1\n1208  364    1  2     1      0  5374 5374      0\n1209  364    1  3     2      0  5374 5374      0\n1210  364    1  4     3      0  5374 5374      0\n1211  365    1  2     1      0   526  526      0\n1212  365    1  3     2      0   526  526      1\n1213  365    1  4     3      0   526  526      0\n1214  365    3  4     6    526  5404 4878      1\n1215  366    1  2     1      0  5107 5107      0\n1216  366    1  3     2      0  5107 5107      0\n1217  366    1  4     3      0  5107 5107      1\n1218  367    1  2     1      0  5297 5297      0\n1219  367    1  3     2      0  5297 5297      0\n1220  367    1  4     3      0  5297 5297      0\n1221  368    1  2     1      0  5298 5298      0\n1222  368    1  3     2      0  5298 5298      0\n1223  368    1  4     3      0  5298 5298      0\n1224  369    1  2     1      0    98   98      0\n1225  369    1  3     2      0    98   98      1\n1226  369    1  4     3      0    98   98      0\n1227  369    3  4     6     98   315  217      1\n1228  370    1  2     1      0  1224 1224      0\n1229  370    1  3     2      0  1224 1224      0\n1230  370    1  4     3      0  1224 1224      1\n1231  371    1  2     1      0  5403 5403      0\n1232  371    1  3     2      0  5403 5403      0\n1233  371    1  4     3      0  5403 5403      0\n1234  372    1  2     1      0  5408 5408      0\n1235  372    1  3     2      0  5408 5408      0\n1236  372    1  4     3      0  5408 5408      0\n1237  373    1  2     1      0  3238 3238      0\n1238  373    1  3     2      0  3238 3238      0\n1239  373    1  4     3      0  3238 3238      1\n1240  374    1  2     1      0  5354 5354      0\n1241  374    1  3     2      0  5354 5354      0\n1242  374    1  4     3      0  5354 5354      0\n1243  375    1  2     1      0   800  800      1\n1244  375    1  3     2      0   800  800      0\n1245  375    1  4     3      0   800  800      0\n1246  375    2  3     4    800  1618  818      0\n1247  375    2  4     5    800  1618  818      1\n1248  376    1  2     1      0  2501 2501      0\n1249  376    1  3     2      0  2501 2501      0\n1250  376    1  4     3      0  2501 2501      1\n1251  377    1  2     1      0  1228 1228      0\n1252  377    1  3     2      0  1228 1228      0\n1253  377    1  4     3      0  1228 1228      1\n1254  378    1  2     1      0  2875 2875      0\n1255  378    1  3     2      0  2875 2875      0\n1256  378    1  4     3      0  2875 2875      1\n1257  379    1  2     1      0  3367 3367      0\n1258  379    1  3     2      0  3367 3367      0\n1259  379    1  4     3      0  3367 3367      1\n1260  380    1  2     1      0  1628 1628      0\n1261  380    1  3     2      0  1628 1628      0\n1262  380    1  4     3      0  1628 1628      1\n1263  381    1  2     1      0  5275 5275      0\n1264  381    1  3     2      0  5275 5275      0\n1265  381    1  4     3      0  5275 5275      0\n1266  382    1  2     1      0  1453 1453      1\n1267  382    1  3     2      0  1453 1453      0\n1268  382    1  4     3      0  1453 1453      0\n1269  382    2  3     4   1453  1455    2      0\n1270  382    2  4     5   1453  1455    2      1\n1271  383    1  2     1      0  3778 3778      0\n1272  383    1  3     2      0  3778 3778      1\n1273  383    1  4     3      0  3778 3778      0\n1274  383    3  4     6   3778  5322 1544      0\n1275  384    1  2     1      0  5416 5416      0\n1276  384    1  3     2      0  5416 5416      0\n1277  384    1  4     3      0  5416 5416      0\n1278  385    1  2     1      0  5248 5248      0\n1279  385    1  3     2      0  5248 5248      0\n1280  385    1  4     3      0  5248 5248      0\n1281  386    1  2     1      0  5357 5357      0\n1282  386    1  3     2      0  5357 5357      0\n1283  386    1  4     3      0  5357 5357      0\n1284  387    1  2     1      0  5283 5283      0\n1285  387    1  3     2      0  5283 5283      0\n1286  387    1  4     3      0  5283 5283      0\n1287  388    1  2     1      0  5385 5385      0\n1288  388    1  3     2      0  5385 5385      0\n1289  388    1  4     3      0  5385 5385      1\n1290  389    1  2     1      0  1615 1615      0\n1291  389    1  3     2      0  1615 1615      1\n1292  389    1  4     3      0  1615 1615      0\n1293  389    3  4     6   1615  3104 1489      1\n1294  390    1  2     1      0  5287 5287      0\n1295  390    1  3     2      0  5287 5287      0\n1296  390    1  4     3      0  5287 5287      0\n1297  391    1  2     1      0  5337 5337      0\n1298  391    1  3     2      0  5337 5337      0\n1299  391    1  4     3      0  5337 5337      0\n1300  392    1  2     1      0  1361 1361      0\n1301  392    1  3     2      0  1361 1361      1\n1302  392    1  4     3      0  1361 1361      0\n1303  392    3  4     6   1361  1392   31      1\n1304  393    1  2     1      0  5415 5415      0\n1305  393    1  3     2      0  5415 5415      0\n1306  393    1  4     3      0  5415 5415      0\n1307  394    1  2     1      0  3930 3930      0\n1308  394    1  3     2      0  3930 3930      0\n1309  394    1  4     3      0  3930 3930      1\n1310  395    1  2     1      0  2241 2241      1\n1311  395    1  3     2      0  2241 2241      0\n1312  395    1  4     3      0  2241 2241      0\n1313  395    2  3     4   2241  5284 3043      0\n1314  395    2  4     5   2241  5284 3043      0\n1315  396    1  2     1      0  5033 5033      0\n1316  396    1  3     2      0  5033 5033      0\n1317  396    1  4     3      0  5033 5033      1\n1318  397    1  2     1      0  4709 4709      0\n1319  397    1  3     2      0  4709 4709      1\n1320  397    1  4     3      0  4709 4709      0\n1321  397    3  4     6   4709  4718    9      1\n1322  398    1  2     1      0  4357 4357      1\n1323  398    1  3     2      0  4357 4357      0\n1324  398    1  4     3      0  4357 4357      0\n1325  398    2  3     4   4357  4882  525      0\n1326  398    2  4     5   4357  4882  525      0\n1327  399    1  2     1      0  2222 2222      0\n1328  399    1  3     2      0  2222 2222      0\n1329  399    1  4     3      0  2222 2222      1\n1330  400    1  2     1      0  3907 3907      0\n1331  400    1  3     2      0  3907 3907      0\n1332  400    1  4     3      0  3907 3907      1\n1333  401    1  2     1      0  5261 5261      0\n1334  401    1  3     2      0  5261 5261      0\n1335  401    1  4     3      0  5261 5261      0\n1336  402    1  2     1      0  5229 5229      1\n1337  402    1  3     2      0  5229 5229      0\n1338  402    1  4     3      0  5229 5229      0\n1339  402    2  3     4   5229  5254   25      0\n1340  402    2  4     5   5229  5254   25      0\n1341  403    1  2     1      0  2253 2253      1\n1342  403    1  3     2      0  2253 2253      0\n1343  403    1  4     3      0  2253 2253      0\n1344  403    2  3     4   2253  4025 1772      0\n1345  403    2  4     5   2253  4025 1772      1\n1346  404    1  2     1      0  5260 5260      0\n1347  404    1  3     2      0  5260 5260      0\n1348  404    1  4     3      0  5260 5260      0\n1349  405    1  2     1      0   433  433      0\n1350  405    1  3     2      0   433  433      0\n1351  405    1  4     3      0   433  433      1\n1352  406    1  2     1      0  5423 5423      0\n1353  406    1  3     2      0  5423 5423      0\n1354  406    1  4     3      0  5423 5423      0\n1355  407    1  2     1      0    20   20      1\n1356  407    1  3     2      0    20   20      0\n1357  407    1  4     3      0    20   20      0\n1358  407    2  3     4     20  4632 4612      0\n1359  407    2  4     5     20  4632 4612      1\n1360  408    1  2     1      0  5291 5291      0\n1361  408    1  3     2      0  5291 5291      0\n1362  408    1  4     3      0  5291 5291      0\n1363  409    1  2     1      0  5471 5471      0\n1364  409    1  3     2      0  5471 5471      0\n1365  409    1  4     3      0  5471 5471      0\n1366  410    1  2     1      0  5179 5179      0\n1367  410    1  3     2      0  5179 5179      0\n1368  410    1  4     3      0  5179 5179      1\n1369  411    1  2     1      0  5287 5287      0\n1370  411    1  3     2      0  5287 5287      0\n1371  411    1  4     3      0  5287 5287      0\n1372  412    1  2     1      0  5333 5333      0\n1373  412    1  3     2      0  5333 5333      0\n1374  412    1  4     3      0  5333 5333      0\n1375  413    1  2     1      0  5290 5290      0\n1376  413    1  3     2      0  5290 5290      0\n1377  413    1  4     3      0  5290 5290      0\n1378  414    1  2     1      0  5288 5288      0\n1379  414    1  3     2      0  5288 5288      0\n1380  414    1  4     3      0  5288 5288      0\n1381  415    1  2     1      0  3029 3029      0\n1382  415    1  3     2      0  3029 3029      0\n1383  415    1  4     3      0  3029 3029      1\n1384  416    1  2     1      0  3205 3205      0\n1385  416    1  3     2      0  3205 3205      1\n1386  416    1  4     3      0  3205 3205      0\n1387  416    3  4     6   3205  3212    7      1\n1388  417    1  2     1      0  4912 4912      0\n1389  417    1  3     2      0  4912 4912      0\n1390  417    1  4     3      0  4912 4912      1\n1391  418    1  2     1      0  4780 4780      0\n1392  418    1  3     2      0  4780 4780      0\n1393  418    1  4     3      0  4780 4780      0\n1394  419    1  2     1      0  5267 5267      0\n1395  419    1  3     2      0  5267 5267      0\n1396  419    1  4     3      0  5267 5267      0\n1397  420    1  2     1      0  5500 5500      0\n1398  420    1  3     2      0  5500 5500      0\n1399  420    1  4     3      0  5500 5500      0\n1400  421    1  2     1      0  4523 4523      0\n1401  421    1  3     2      0  4523 4523      0\n1402  421    1  4     3      0  4523 4523      1\n1403  422    1  2     1      0  5507 5507      0\n1404  422    1  3     2      0  5507 5507      0\n1405  422    1  4     3      0  5507 5507      0\n1406  423    1  2     1      0  2097 2097      1\n1407  423    1  3     2      0  2097 2097      0\n1408  423    1  4     3      0  2097 2097      0\n1409  423    2  3     4   2097  5456 3359      0\n1410  423    2  4     5   2097  5456 3359      0\n1411  424    1  2     1      0  5329 5329      0\n1412  424    1  3     2      0  5329 5329      0\n1413  424    1  4     3      0  5329 5329      0\n1414  425    1  2     1      0  5322 5322      0\n1415  425    1  3     2      0  5322 5322      0\n1416  425    1  4     3      0  5322 5322      0\n1417  426    1  2     1      0  5060 5060      1\n1418  426    1  3     2      0  5060 5060      0\n1419  426    1  4     3      0  5060 5060      0\n1420  426    2  3     4   5060  5420  360      0\n1421  426    2  4     5   5060  5420  360      0\n1422  427    1  2     1      0  5326 5326      0\n1423  427    1  3     2      0  5326 5326      0\n1424  427    1  4     3      0  5326 5326      0\n1425  428    1  2     1      0  1538 1538      0\n1426  428    1  3     2      0  1538 1538      0\n1427  428    1  4     3      0  1538 1538      1\n1428  429    1  2     1      0  4460 4460      1\n1429  429    1  3     2      0  4460 4460      0\n1430  429    1  4     3      0  4460 4460      0\n1431  429    2  3     4   4460  4765  305      0\n1432  429    2  4     5   4460  4765  305      0\n1433  430    1  2     1      0  3401 3401      0\n1434  430    1  3     2      0  3401 3401      0\n1435  430    1  4     3      0  3401 3401      1\n1436  431    1  2     1      0  5410 5410      0\n1437  431    1  3     2      0  5410 5410      0\n1438  431    1  4     3      0  5410 5410      0\n1439  432    1  2     1      0  5533 5533      0\n1440  432    1  3     2      0  5533 5533      0\n1441  432    1  4     3      0  5533 5533      0\n1442  433    1  2     1      0  5268 5268      0\n1443  433    1  3     2      0  5268 5268      0\n1444  433    1  4     3      0  5268 5268      0\n1445  434    1  2     1      0  1620 1620      0\n1446  434    1  3     2      0  1620 1620      0\n1447  434    1  4     3      0  1620 1620      1\n1448  435    1  2     1      0  5382 5382      0\n1449  435    1  3     2      0  5382 5382      0\n1450  435    1  4     3      0  5382 5382      0\n1451  436    1  2     1      0   375  375      0\n1452  436    1  3     2      0   375  375      1\n1453  436    1  4     3      0   375  375      0\n1454  436    3  4     6    375  2714 2339      1\n1455  437    1  2     1      0  1282 1282      0\n1456  437    1  3     2      0  1282 1282      1\n1457  437    1  4     3      0  1282 1282      0\n1458  437    3  4     6   1282  5478 4196      0\n1459  438    1  2     1      0  4799 4799      0\n1460  438    1  3     2      0  4799 4799      0\n1461  438    1  4     3      0  4799 4799      0\n1462  439    1  2     1      0  1575 1575      0\n1463  439    1  3     2      0  1575 1575      1\n1464  439    1  4     3      0  1575 1575      0\n1465  439    3  4     6   1575  2643 1068      1\n1466  440    1  2     1      0  3753 3753      0\n1467  440    1  3     2      0  3753 3753      0\n1468  440    1  4     3      0  3753 3753      1\n1469  441    1  2     1      0   116  116      0\n1470  441    1  3     2      0   116  116      0\n1471  441    1  4     3      0   116  116      1\n1472  442    1  2     1      0  4110 4110      0\n1473  442    1  3     2      0  4110 4110      0\n1474  442    1  4     3      0  4110 4110      1\n1475  443    1  2     1      0  5490 5490      0\n1476  443    1  3     2      0  5490 5490      0\n1477  443    1  4     3      0  5490 5490      0\n1478  444    1  2     1      0  5261 5261      0\n1479  444    1  3     2      0  5261 5261      0\n1480  444    1  4     3      0  5261 5261      0\n1481  445    1  2     1      0  5518 5518      0\n1482  445    1  3     2      0  5518 5518      0\n1483  445    1  4     3      0  5518 5518      0\n1484  446    1  2     1      0  5361 5361      0\n1485  446    1  3     2      0  5361 5361      0\n1486  446    1  4     3      0  5361 5361      0\n1487  447    1  2     1      0  2471 2471      0\n1488  447    1  3     2      0  2471 2471      1\n1489  447    1  4     3      0  2471 2471      0\n1490  447    3  4     6   2471  5326 2855      0\n1491  448    1  2     1      0  3607 3607      0\n1492  448    1  3     2      0  3607 3607      0\n1493  448    1  4     3      0  3607 3607      1\n1494  449    1  2     1      0  3256 3256      0\n1495  449    1  3     2      0  3256 3256      1\n1496  449    1  4     3      0  3256 3256      0\n1497  449    3  4     6   3256  5319 2063      0\n1498  450    1  2     1      0  5388 5388      0\n1499  450    1  3     2      0  5388 5388      0\n1500  450    1  4     3      0  5388 5388      0\n1501  451    1  2     1      0  5401 5401      0\n1502  451    1  3     2      0  5401 5401      0\n1503  451    1  4     3      0  5401 5401      0\n1504  452    1  2     1      0  5318 5318      0\n1505  452    1  3     2      0  5318 5318      0\n1506  452    1  4     3      0  5318 5318      0\n1507  453    1  2     1      0  5438 5438      0\n1508  453    1  3     2      0  5438 5438      0\n1509  453    1  4     3      0  5438 5438      0\n1510  454    1  2     1      0  5401 5401      0\n1511  454    1  3     2      0  5401 5401      0\n1512  454    1  4     3      0  5401 5401      0\n1513  455    1  2     1      0  4303 4303      0\n1514  455    1  3     2      0  4303 4303      0\n1515  455    1  4     3      0  4303 4303      1\n1516  456    1  2     1      0  5358 5358      0\n1517  456    1  3     2      0  5358 5358      0\n1518  456    1  4     3      0  5358 5358      0\n1519  457    1  2     1      0  4529 4529      0\n1520  457    1  3     2      0  4529 4529      0\n1521  457    1  4     3      0  4529 4529      1\n1522  458    1  2     1      0  4672 4672      0\n1523  458    1  3     2      0  4672 4672      1\n1524  458    1  4     3      0  4672 4672      0\n1525  458    3  4     6   4672  4841  169      1\n1526  459    1  2     1      0  5333 5333      0\n1527  459    1  3     2      0  5333 5333      0\n1528  459    1  4     3      0  5333 5333      0\n1529  460    1  2     1      0  5318 5318      0\n1530  460    1  3     2      0  5318 5318      0\n1531  460    1  4     3      0  5318 5318      0\n1532  461    1  2     1      0  5399 5399      0\n1533  461    1  3     2      0  5399 5399      0\n1534  461    1  4     3      0  5399 5399      0\n1535  462    1  2     1      0  5443 5443      0\n1536  462    1  3     2      0  5443 5443      0\n1537  462    1  4     3      0  5443 5443      0\n1538  463    1  2     1      0  4063 4063      0\n1539  463    1  3     2      0  4063 4063      1\n1540  463    1  4     3      0  4063 4063      0\n1541  463    3  4     6   4063  5386 1323      0\n1542  464    1  2     1      0  5363 5363      0\n1543  464    1  3     2      0  5363 5363      0\n1544  464    1  4     3      0  5363 5363      0\n1545  465    1  2     1      0  5276 5276      0\n1546  465    1  3     2      0  5276 5276      0\n1547  465    1  4     3      0  5276 5276      0\n1548  466    1  2     1      0  5406 5406      0\n1549  466    1  3     2      0  5406 5406      0\n1550  466    1  4     3      0  5406 5406      0\n1551  467    1  2     1      0  5261 5261      0\n1552  467    1  3     2      0  5261 5261      0\n1553  467    1  4     3      0  5261 5261      0\n1554  468    1  2     1      0  5331 5331      0\n1555  468    1  3     2      0  5331 5331      0\n1556  468    1  4     3      0  5331 5331      0\n1557  469    1  2     1      0  1996 1996      0\n1558  469    1  3     2      0  1996 1996      0\n1559  469    1  4     3      0  1996 1996      1\n1560  470    1  2     1      0  3878 3878      0\n1561  470    1  3     2      0  3878 3878      0\n1562  470    1  4     3      0  3878 3878      1\n1563  471    1  2     1      0  5274 5274      0\n1564  471    1  3     2      0  5274 5274      0\n1565  471    1  4     3      0  5274 5274      0\n1566  472    1  2     1      0  5357 5357      0\n1567  472    1  3     2      0  5357 5357      0\n1568  472    1  4     3      0  5357 5357      0\n1569  473    1  2     1      0  5389 5389      0\n1570  473    1  3     2      0  5389 5389      0\n1571  473    1  4     3      0  5389 5389      0\n1572  474    1  2     1      0  5259 5259      0\n1573  474    1  3     2      0  5259 5259      0\n1574  474    1  4     3      0  5259 5259      0\n1575  475    1  2     1      0  1624 1624      0\n1576  475    1  3     2      0  1624 1624      0\n1577  475    1  4     3      0  1624 1624      1\n1578  476    1  2     1      0  5414 5414      0\n1579  476    1  3     2      0  5414 5414      0\n1580  476    1  4     3      0  5414 5414      0\n1581  477    1  2     1      0  4409 4409      0\n1582  477    1  3     2      0  4409 4409      0\n1583  477    1  4     3      0  4409 4409      1\n1584  478    1  2     1      0  2955 2955      0\n1585  478    1  3     2      0  2955 2955      1\n1586  478    1  4     3      0  2955 2955      0\n1587  478    3  4     6   2955  5470 2515      0\n1588  479    1  2     1      0  5246 5246      0\n1589  479    1  3     2      0  5246 5246      0\n1590  479    1  4     3      0  5246 5246      0\n1591  480    1  2     1      0  5420 5420      0\n1592  480    1  3     2      0  5420 5420      0\n1593  480    1  4     3      0  5420 5420      0\n1594  481    1  2     1      0  5423 5423      0\n1595  481    1  3     2      0  5423 5423      0\n1596  481    1  4     3      0  5423 5423      0\n1597  482    1  2     1      0  5054 5054      0\n1598  482    1  3     2      0  5054 5054      0\n1599  482    1  4     3      0  5054 5054      1\n1600  483    1  2     1      0  5407 5407      0\n1601  483    1  3     2      0  5407 5407      0\n1602  483    1  4     3      0  5407 5407      0\n1603  484    1  2     1      0  4785 4785      0\n1604  484    1  3     2      0  4785 4785      0\n1605  484    1  4     3      0  4785 4785      0\n1606  485    1  2     1      0  5525 5525      0\n1607  485    1  3     2      0  5525 5525      0\n1608  485    1  4     3      0  5525 5525      0\n1609  486    1  2     1      0  2273 2273      1\n1610  486    1  3     2      0  2273 2273      0\n1611  486    1  4     3      0  2273 2273      0\n1612  486    2  3     4   2273  3527 1254      0\n1613  486    2  4     5   2273  3527 1254      1\n1614  487    1  2     1      0  2001 2001      0\n1615  487    1  3     2      0  2001 2001      0\n1616  487    1  4     3      0  2001 2001      1\n1617  488    1  2     1      0  5284 5284      0\n1618  488    1  3     2      0  5284 5284      0\n1619  488    1  4     3      0  5284 5284      0\n1620  489    1  2     1      0  5273 5273      0\n1621  489    1  3     2      0  5273 5273      0\n1622  489    1  4     3      0  5273 5273      0\n1623  490    1  2     1      0  5455 5455      0\n1624  490    1  3     2      0  5455 5455      0\n1625  490    1  4     3      0  5455 5455      0\n1626  491    1  2     1      0  5247 5247      1\n1627  491    1  3     2      0  5247 5247      0\n1628  491    1  4     3      0  5247 5247      0\n1629  491    2  3     4   5247  5389  142      0\n1630  491    2  4     5   5247  5389  142      0\n1631  492    1  2     1      0  5266 5266      0\n1632  492    1  3     2      0  5266 5266      0\n1633  492    1  4     3      0  5266 5266      0\n1634  493    1  2     1      0  4073 4073      0\n1635  493    1  3     2      0  4073 4073      0\n1636  493    1  4     3      0  4073 4073      1\n1637  494    1  2     1      0  2821 2821      0\n1638  494    1  3     2      0  2821 2821      0\n1639  494    1  4     3      0  2821 2821      1\n1640  495    1  2     1      0  1196 1196      0\n1641  495    1  3     2      0  1196 1196      0\n1642  495    1  4     3      0  1196 1196      1\n1643  496    1  2     1      0   240  240      0\n1644  496    1  3     2      0   240  240      0\n1645  496    1  4     3      0   240  240      1\n1646  497    1  2     1      0  5058 5058      0\n1647  497    1  3     2      0  5058 5058      0\n1648  497    1  4     3      0  5058 5058      1\n1649  498    1  2     1      0  5212 5212      0\n1650  498    1  3     2      0  5212 5212      0\n1651  498    1  4     3      0  5212 5212      1\n1652  499    1  2     1      0  5374 5374      0\n1653  499    1  3     2      0  5374 5374      0\n1654  499    1  4     3      0  5374 5374      0\n1655  500    1  2     1      0  5499 5499      0\n1656  500    1  3     2      0  5499 5499      0\n1657  500    1  4     3      0  5499 5499      0\n1658  501    1  2     1      0  5291 5291      0\n1659  501    1  3     2      0  5291 5291      0\n1660  501    1  4     3      0  5291 5291      0\n1661  502    1  2     1      0  5322 5322      0\n1662  502    1  3     2      0  5322 5322      0\n1663  502    1  4     3      0  5322 5322      0\n1664  503    1  2     1      0  1944 1944      0\n1665  503    1  3     2      0  1944 1944      0\n1666  503    1  4     3      0  1944 1944      1\n1667  504    1  2     1      0  2462 2462      0\n1668  504    1  3     2      0  2462 2462      0\n1669  504    1  4     3      0  2462 2462      1\n1670  505    1  2     1      0  5280 5280      0\n1671  505    1  3     2      0  5280 5280      0\n1672  505    1  4     3      0  5280 5280      0\n1673  506    1  2     1      0  2422 2422      0\n1674  506    1  3     2      0  2422 2422      1\n1675  506    1  4     3      0  2422 2422      0\n1676  506    3  4     6   2422  5267 2845      0\n1677  507    1  2     1      0  5309 5309      0\n1678  507    1  3     2      0  5309 5309      0\n1679  507    1  4     3      0  5309 5309      0\n1680  508    1  2     1      0  3291 3291      0\n1681  508    1  3     2      0  3291 3291      0\n1682  508    1  4     3      0  3291 3291      1\n1683  509    1  2     1      0  5445 5445      0\n1684  509    1  3     2      0  5445 5445      0\n1685  509    1  4     3      0  5445 5445      0\n1686  510    1  2     1      0  5354 5354      0\n1687  510    1  3     2      0  5354 5354      0\n1688  510    1  4     3      0  5354 5354      0\n1689  511    1  2     1      0  5249 5249      0\n1690  511    1  3     2      0  5249 5249      0\n1691  511    1  4     3      0  5249 5249      0\n1692  512    1  2     1      0  4543 4543      1\n1693  512    1  3     2      0  4543 4543      0\n1694  512    1  4     3      0  4543 4543      0\n1695  512    2  3     4   4543  5396  853      0\n1696  512    2  4     5   4543  5396  853      0\n1697  513    1  2     1      0  2426 2426      1\n1698  513    1  3     2      0  2426 2426      0\n1699  513    1  4     3      0  2426 2426      0\n1700  513    2  3     4   2426  2462   36      0\n1701  513    2  4     5   2426  2462   36      1\n1702  514    1  2     1      0  5325 5325      0\n1703  514    1  3     2      0  5325 5325      0\n1704  514    1  4     3      0  5325 5325      0\n1705  515    1  2     1      0   745  745      0\n1706  515    1  3     2      0   745  745      0\n1707  515    1  4     3      0   745  745      1\n1708  516    1  2     1      0  5273 5273      0\n1709  516    1  3     2      0  5273 5273      0\n1710  516    1  4     3      0  5273 5273      0\n1711  517    1  2     1      0  5267 5267      0\n1712  517    1  3     2      0  5267 5267      0\n1713  517    1  4     3      0  5267 5267      0\n1714  518    1  2     1      0  5379 5379      0\n1715  518    1  3     2      0  5379 5379      0\n1716  518    1  4     3      0  5379 5379      0\n1717  519    1  2     1      0  5266 5266      0\n1718  519    1  3     2      0  5266 5266      0\n1719  519    1  4     3      0  5266 5266      0\n1720  520    1  2     1      0  4793 4793      0\n1721  520    1  3     2      0  4793 4793      0\n1722  520    1  4     3      0  4793 4793      0\n1723  521    1  2     1      0  3222 3222      0\n1724  521    1  3     2      0  3222 3222      0\n1725  521    1  4     3      0  3222 3222      1\n1726  522    1  2     1      0   251  251      0\n1727  522    1  3     2      0   251  251      1\n1728  522    1  4     3      0   251  251      0\n1729  522    3  4     6    251  2764 2513      1\n1730  523    1  2     1      0  4542 4542      1\n1731  523    1  3     2      0  4542 4542      0\n1732  523    1  4     3      0  4542 4542      0\n1733  523    2  3     4   4542  4567   25      0\n1734  523    2  4     5   4542  4567   25      1\n1735  524    1  2     1      0  3455 3455      0\n1736  524    1  3     2      0  3455 3455      0\n1737  524    1  4     3      0  3455 3455      1\n1738  525    1  2     1      0  5423 5423      0\n1739  525    1  3     2      0  5423 5423      0\n1740  525    1  4     3      0  5423 5423      0\n1741  526    1  2     1      0  2019 2019      0\n1742  526    1  3     2      0  2019 2019      0\n1743  526    1  4     3      0  2019 2019      1\n1744  527    1  2     1      0  5285 5285      0\n1745  527    1  3     2      0  5285 5285      0\n1746  527    1  4     3      0  5285 5285      0\n1747  528    1  2     1      0  3622 3622      0\n1748  528    1  3     2      0  3622 3622      0\n1749  528    1  4     3      0  3622 3622      1\n1750  529    1  2     1      0  5547 5547      0\n1751  529    1  3     2      0  5547 5547      0\n1752  529    1  4     3      0  5547 5547      0\n1753  530    1  2     1      0   155  155      0\n1754  530    1  3     2      0   155  155      0\n1755  530    1  4     3      0   155  155      1\n1756  531    1  2     1      0  2449 2449      0\n1757  531    1  3     2      0  2449 2449      1\n1758  531    1  4     3      0  2449 2449      0\n1759  531    3  4     6   2449  5323 2874      0\n1760  532    1  2     1      0  5338 5338      0\n1761  532    1  3     2      0  5338 5338      0\n1762  532    1  4     3      0  5338 5338      0\n1763  533    1  2     1      0  2264 2264      1\n1764  533    1  3     2      0  2264 2264      0\n1765  533    1  4     3      0  2264 2264      0\n1766  533    2  3     4   2264  2264    0      1\n1767  533    2  4     5   2264  2264    0      0\n1768  533    3  4     6   2264  2314   50      1\n1769  534    1  2     1      0  1541 1541      0\n1770  534    1  3     2      0  1541 1541      1\n1771  534    1  4     3      0  1541 1541      0\n1772  534    3  4     6   1541  4597 3056      1\n1773  535    1  2     1      0  5325 5325      0\n1774  535    1  3     2      0  5325 5325      0\n1775  535    1  4     3      0  5325 5325      0\n1776  536    1  2     1      0  2714 2714      0\n1777  536    1  3     2      0  2714 2714      0\n1778  536    1  4     3      0  2714 2714      1\n1779  537    1  2     1      0  5374 5374      0\n1780  537    1  3     2      0  5374 5374      0\n1781  537    1  4     3      0  5374 5374      0\n1782  538    1  2     1      0  3466 3466      0\n1783  538    1  3     2      0  3466 3466      0\n1784  538    1  4     3      0  3466 3466      1\n1785  539    1  2     1      0  5333 5333      0\n1786  539    1  3     2      0  5333 5333      0\n1787  539    1  4     3      0  5333 5333      0\n1788  540    1  2     1      0  3589 3589      0\n1789  540    1  3     2      0  3589 3589      1\n1790  540    1  4     3      0  3589 3589      0\n1791  540    3  4     6   3589  5332 1743      0\n1792  541    1  2     1      0  2726 2726      0\n1793  541    1  3     2      0  2726 2726      1\n1794  541    1  4     3      0  2726 2726      0\n1795  541    3  4     6   2726  5359 2633      0\n1796  542    1  2     1      0  4805 4805      1\n1797  542    1  3     2      0  4805 4805      0\n1798  542    1  4     3      0  4805 4805      0\n1799  542    2  3     4   4805  5350  545      0\n1800  542    2  4     5   4805  5350  545      0\n1801  543    1  2     1      0  5385 5385      0\n1802  543    1  3     2      0  5385 5385      0\n1803  543    1  4     3      0  5385 5385      0\n1804  544    1  2     1      0  5281 5281      0\n1805  544    1  3     2      0  5281 5281      0\n1806  544    1  4     3      0  5281 5281      0\n1807  545    1  2     1      0  3148 3148      0\n1808  545    1  3     2      0  3148 3148      0\n1809  545    1  4     3      0  3148 3148      1\n1810  546    1  2     1      0  2305 2305      0\n1811  546    1  3     2      0  2305 2305      0\n1812  546    1  4     3      0  2305 2305      1\n1813  547    1  2     1      0  1977 1977      0\n1814  547    1  3     2      0  1977 1977      0\n1815  547    1  4     3      0  1977 1977      1\n1816  548    1  2     1      0  3350 3350      0\n1817  548    1  3     2      0  3350 3350      0\n1818  548    1  4     3      0  3350 3350      1\n1819  549    1  2     1      0  1403 1403      1\n1820  549    1  3     2      0  1403 1403      0\n1821  549    1  4     3      0  1403 1403      0\n1822  549    2  3     4   1403  5367 3964      0\n1823  549    2  4     5   1403  5367 3964      0\n1824  550    1  2     1      0  3262 3262      1\n1825  550    1  3     2      0  3262 3262      0\n1826  550    1  4     3      0  3262 3262      0\n1827  550    2  3     4   3262  3262    0      1\n1828  550    2  4     5   3262  3262    0      0\n1829  550    3  4     6   3262  5375 2113      0\n1830  551    1  2     1      0  1464 1464      1\n1831  551    1  3     2      0  1464 1464      0\n1832  551    1  4     3      0  1464 1464      0\n1833  551    2  3     4   1464  4818 3354      0\n1834  551    2  4     5   1464  4818 3354      1\n1835  552    1  2     1      0  4785 4785      1\n1836  552    1  3     2      0  4785 4785      0\n1837  552    1  4     3      0  4785 4785      0\n1838  552    2  3     4   4785  5428  643      0\n1839  552    2  4     5   4785  5428  643      0\n1840  553    1  2     1      0  1256 1256      0\n1841  553    1  3     2      0  1256 1256      0\n1842  553    1  4     3      0  1256 1256      1\n1843  554    1  2     1      0  4679 4679      0\n1844  554    1  3     2      0  4679 4679      0\n1845  554    1  4     3      0  4679 4679      1\n1846  555    1  2     1      0  5281 5281      0\n1847  555    1  3     2      0  5281 5281      0\n1848  555    1  4     3      0  5281 5281      0\n1849  556    1  2     1      0   739  739      0\n1850  556    1  3     2      0   739  739      1\n1851  556    1  4     3      0   739  739      0\n1852  556    3  4     6    739  5049 4310      1\n1853  557    1  2     1      0  3861 3861      0\n1854  557    1  3     2      0  3861 3861      0\n1855  557    1  4     3      0  3861 3861      1\n1856  558    1  2     1      0  5242 5242      0\n1857  558    1  3     2      0  5242 5242      0\n1858  558    1  4     3      0  5242 5242      0\n1859  559    1  2     1      0  5463 5463      0\n1860  559    1  3     2      0  5463 5463      0\n1861  559    1  4     3      0  5463 5463      0\n1862  560    1  2     1      0   645  645      0\n1863  560    1  3     2      0   645  645      1\n1864  560    1  4     3      0   645  645      0\n1865  560    3  4     6    645  2331 1686      1\n1866  561    1  2     1      0  5254 5254      0\n1867  561    1  3     2      0  5254 5254      0\n1868  561    1  4     3      0  5254 5254      0\n1869  562    1  2     1      0  5333 5333      0\n1870  562    1  3     2      0  5333 5333      0\n1871  562    1  4     3      0  5333 5333      0\n1872  563    1  2     1      0  5338 5338      0\n1873  563    1  3     2      0  5338 5338      0\n1874  563    1  4     3      0  5338 5338      0\n1875  564    1  2     1      0  5392 5392      0\n1876  564    1  3     2      0  5392 5392      0\n1877  564    1  4     3      0  5392 5392      0\n1878  565    1  2     1      0   333  333      0\n1879  565    1  3     2      0   333  333      0\n1880  565    1  4     3      0   333  333      1\n1881  566    1  2     1      0  5459 5459      0\n1882  566    1  3     2      0  5459 5459      0\n1883  566    1  4     3      0  5459 5459      0\n1884  567    1  2     1      0  3472 3472      0\n1885  567    1  3     2      0  3472 3472      0\n1886  567    1  4     3      0  3472 3472      1\n1887  568    1  2     1      0   189  189      0\n1888  568    1  3     2      0   189  189      0\n1889  568    1  4     3      0   189  189      1\n1890  569    1  2     1      0  4778 4778      0\n1891  569    1  3     2      0  4778 4778      0\n1892  569    1  4     3      0  4778 4778      0\n1893  570    1  2     1      0  5389 5389      0\n1894  570    1  3     2      0  5389 5389      0\n1895  570    1  4     3      0  5389 5389      0\n1896  571    1  2     1      0  5298 5298      0\n1897  571    1  3     2      0  5298 5298      0\n1898  571    1  4     3      0  5298 5298      0\n1899  572    1  2     1      0  5345 5345      0\n1900  572    1  3     2      0  5345 5345      0\n1901  572    1  4     3      0  5345 5345      0\n1902  573    1  2     1      0  5322 5322      0\n1903  573    1  3     2      0  5322 5322      0\n1904  573    1  4     3      0  5322 5322      0\n1905  574    1  2     1      0  5470 5470      0\n1906  574    1  3     2      0  5470 5470      0\n1907  574    1  4     3      0  5470 5470      0\n1908  575    1  2     1      0  5028 5028      0\n1909  575    1  3     2      0  5028 5028      0\n1910  575    1  4     3      0  5028 5028      1\n1911  576    1  2     1      0  5459 5459      0\n1912  576    1  3     2      0  5459 5459      0\n1913  576    1  4     3      0  5459 5459      0\n1914  577    1  2     1      0  1272 1272      0\n1915  577    1  3     2      0  1272 1272      0\n1916  577    1  4     3      0  1272 1272      1\n1917  578    1  2     1      0  5354 5354      0\n1918  578    1  3     2      0  5354 5354      0\n1919  578    1  4     3      0  5354 5354      1\n1920  579    1  2     1      0  1630 1630      0\n1921  579    1  3     2      0  1630 1630      1\n1922  579    1  4     3      0  1630 1630      0\n1923  579    3  4     6   1630  4310 2680      1\n1924  580    1  2     1      0  4690 4690      0\n1925  580    1  3     2      0  4690 4690      1\n1926  580    1  4     3      0  4690 4690      0\n1927  580    3  4     6   4690  5473  783      0\n1928  581    1  2     1      0  5408 5408      0\n1929  581    1  3     2      0  5408 5408      0\n1930  581    1  4     3      0  5408 5408      0\n1931  582    1  2     1      0  5358 5358      0\n1932  582    1  3     2      0  5358 5358      0\n1933  582    1  4     3      0  5358 5358      0\n1934  583    1  2     1      0  5456 5456      0\n1935  583    1  3     2      0  5456 5456      0\n1936  583    1  4     3      0  5456 5456      0\n1937  584    1  2     1      0  1299 1299      0\n1938  584    1  3     2      0  1299 1299      0\n1939  584    1  4     3      0  1299 1299      1\n1940  585    1  2     1      0  5366 5366      0\n1941  585    1  3     2      0  5366 5366      0\n1942  585    1  4     3      0  5366 5366      0\n1943  586    1  2     1      0  3536 3536      0\n1944  586    1  3     2      0  3536 3536      0\n1945  586    1  4     3      0  3536 3536      1\n1946  587    1  2     1      0  2013 2013      0\n1947  587    1  3     2      0  2013 2013      1\n1948  587    1  4     3      0  2013 2013      0\n1949  587    3  4     6   2013  5128 3115      1\n1950  588    1  2     1      0  1844 1844      0\n1951  588    1  3     2      0  1844 1844      0\n1952  588    1  4     3      0  1844 1844      1\n1953  589    1  2     1      0  2673 2673      0\n1954  589    1  3     2      0  2673 2673      0\n1955  589    1  4     3      0  2673 2673      1\n1956  590    1  2     1      0  5443 5443      0\n1957  590    1  3     2      0  5443 5443      0\n1958  590    1  4     3      0  5443 5443      0\n1959  591    1  2     1      0  5458 5458      0\n1960  591    1  3     2      0  5458 5458      0\n1961  591    1  4     3      0  5458 5458      0\n1962  592    1  2     1      0  2153 2153      0\n1963  592    1  3     2      0  2153 2153      1\n1964  592    1  4     3      0  2153 2153      0\n1965  592    3  4     6   2153  5312 3159      1\n1966  593    1  2     1      0  1177 1177      0\n1967  593    1  3     2      0  1177 1177      0\n1968  593    1  4     3      0  1177 1177      1\n1969  594    1  2     1      0  5308 5308      0\n1970  594    1  3     2      0  5308 5308      0\n1971  594    1  4     3      0  5308 5308      0\n1972  595    1  2     1      0  4531 4531      0\n1973  595    1  3     2      0  4531 4531      0\n1974  595    1  4     3      0  4531 4531      1\n1975  596    1  2     1      0  1932 1932      0\n1976  596    1  3     2      0  1932 1932      0\n1977  596    1  4     3      0  1932 1932      1\n1978  597    1  2     1      0  4732 4732      0\n1979  597    1  3     2      0  4732 4732      0\n1980  597    1  4     3      0  4732 4732      1\n1981  598    1  2     1      0  5249 5249      0\n1982  598    1  3     2      0  5249 5249      0\n1983  598    1  4     3      0  5249 5249      0\n1984  599    1  2     1      0  5455 5455      0\n1985  599    1  3     2      0  5455 5455      0\n1986  599    1  4     3      0  5455 5455      0\n1987  600    1  2     1      0  5393 5393      0\n1988  600    1  3     2      0  5393 5393      0\n1989  600    1  4     3      0  5393 5393      0\n1990  601    1  2     1      0  5375 5375      0\n1991  601    1  3     2      0  5375 5375      0\n1992  601    1  4     3      0  5375 5375      0\n1993  602    1  2     1      0  5339 5339      0\n1994  602    1  3     2      0  5339 5339      0\n1995  602    1  4     3      0  5339 5339      0\n1996  603    1  2     1      0  5275 5275      0\n1997  603    1  3     2      0  5275 5275      0\n1998  603    1  4     3      0  5275 5275      0\n1999  604    1  2     1      0   139  139      0\n2000  604    1  3     2      0   139  139      0\n2001  604    1  4     3      0   139  139      1\n2002  605    1  2     1      0  5340 5340      0\n2003  605    1  3     2      0  5340 5340      0\n2004  605    1  4     3      0  5340 5340      0\n2005  606    1  2     1      0  3146 3146      0\n2006  606    1  3     2      0  3146 3146      0\n2007  606    1  4     3      0  3146 3146      1\n2008  607    1  2     1      0  4062 4062      0\n2009  607    1  3     2      0  4062 4062      0\n2010  607    1  4     3      0  4062 4062      1\n2011  608    1  2     1      0  5401 5401      0\n2012  608    1  3     2      0  5401 5401      0\n2013  608    1  4     3      0  5401 5401      0\n2014  609    1  2     1      0  1174 1174      0\n2015  609    1  3     2      0  1174 1174      0\n2016  609    1  4     3      0  1174 1174      1\n2017  610    1  2     1      0  5260 5260      0\n2018  610    1  3     2      0  5260 5260      0\n2019  610    1  4     3      0  5260 5260      0\n2020  611    1  2     1      0  5355 5355      0\n2021  611    1  3     2      0  5355 5355      0\n2022  611    1  4     3      0  5355 5355      0\n2023  612    1  2     1      0  3866 3866      1\n2024  612    1  3     2      0  3866 3866      0\n2025  612    1  4     3      0  3866 3866      0\n2026  612    2  3     4   3866  5295 1429      0\n2027  612    2  4     5   3866  5295 1429      1\n2028  613    1  2     1      0  3372 3372      0\n2029  613    1  3     2      0  3372 3372      0\n2030  613    1  4     3      0  3372 3372      1\n2031  614    1  2     1      0  5414 5414      0\n2032  614    1  3     2      0  5414 5414      0\n2033  614    1  4     3      0  5414 5414      0\n2034  615    1  2     1      0  3340 3340      0\n2035  615    1  3     2      0  3340 3340      0\n2036  615    1  4     3      0  3340 3340      1\n2037  616    1  2     1      0  4396 4396      0\n2038  616    1  3     2      0  4396 4396      0\n2039  616    1  4     3      0  4396 4396      1\n2040  617    1  2     1      0  3623 3623      0\n2041  617    1  3     2      0  3623 3623      1\n2042  617    1  4     3      0  3623 3623      0\n2043  617    3  4     6   3623  3683   60      1\n2044  618    1  2     1      0  5436 5436      0\n2045  618    1  3     2      0  5436 5436      0\n2046  618    1  4     3      0  5436 5436      0\n2047  619    1  2     1      0  5259 5259      0\n2048  619    1  3     2      0  5259 5259      0\n2049  619    1  4     3      0  5259 5259      0\n2050  620    1  2     1      0  1843 1843      0\n2051  620    1  3     2      0  1843 1843      1\n2052  620    1  4     3      0  1843 1843      0\n2053  620    3  4     6   1843  4848 3005      1\n2054  621    1  2     1      0  5289 5289      0\n2055  621    1  3     2      0  5289 5289      0\n2056  621    1  4     3      0  5289 5289      0\n2057  622    1  2     1      0  2509 2509      0\n2058  622    1  3     2      0  2509 2509      0\n2059  622    1  4     3      0  2509 2509      1\n2060  623    1  2     1      0  5395 5395      0\n2061  623    1  3     2      0  5395 5395      0\n2062  623    1  4     3      0  5395 5395      0\n2063  624    1  2     1      0  5380 5380      0\n2064  624    1  3     2      0  5380 5380      0\n2065  624    1  4     3      0  5380 5380      0\n2066  625    1  2     1      0  3692 3692      0\n2067  625    1  3     2      0  3692 3692      1\n2068  625    1  4     3      0  3692 3692      0\n2069  625    3  4     6   3692  4376  684      1\n2070  626    1  2     1      0  3779 3779      1\n2071  626    1  3     2      0  3779 3779      0\n2072  626    1  4     3      0  3779 3779      0\n2073  626    2  3     4   3779  4529  750      0\n2074  626    2  4     5   3779  4529  750      1\n2075  627    1  2     1      0  5281 5281      0\n2076  627    1  3     2      0  5281 5281      0\n2077  627    1  4     3      0  5281 5281      0\n2078  628    1  2     1      0  5408 5408      0\n2079  628    1  3     2      0  5408 5408      0\n2080  628    1  4     3      0  5408 5408      0\n2081  629    1  2     1      0  5319 5319      0\n2082  629    1  3     2      0  5319 5319      0\n2083  629    1  4     3      0  5319 5319      0\n2084  630    1  2     1      0  4787 4787      0\n2085  630    1  3     2      0  4787 4787      0\n2086  630    1  4     3      0  4787 4787      0\n2087  631    1  2     1      0  5273 5273      0\n2088  631    1  3     2      0  5273 5273      0\n2089  631    1  4     3      0  5273 5273      0\n2090  632    1  2     1      0  5471 5471      0\n2091  632    1  3     2      0  5471 5471      0\n2092  632    1  4     3      0  5471 5471      0\n2093  633    1  2     1      0  5268 5268      0\n2094  633    1  3     2      0  5268 5268      0\n2095  633    1  4     3      0  5268 5268      0\n2096  634    1  2     1      0  1325 1325      0\n2097  634    1  3     2      0  1325 1325      0\n2098  634    1  4     3      0  1325 1325      1\n2099  635    1  2     1      0  5375 5375      0\n2100  635    1  3     2      0  5375 5375      0\n2101  635    1  4     3      0  5375 5375      0\n2102  636    1  2     1      0  5443 5443      0\n2103  636    1  3     2      0  5443 5443      0\n2104  636    1  4     3      0  5443 5443      0\n2105  637    1  2     1      0  5465 5465      0\n2106  637    1  3     2      0  5465 5465      0\n2107  637    1  4     3      0  5465 5465      0\n2108  638    1  2     1      0  5282 5282      0\n2109  638    1  3     2      0  5282 5282      0\n2110  638    1  4     3      0  5282 5282      0\n2111  639    1  2     1      0  5352 5352      0\n2112  639    1  3     2      0  5352 5352      0\n2113  639    1  4     3      0  5352 5352      0\n2114  640    1  2     1      0  1791 1791      0\n2115  640    1  3     2      0  1791 1791      0\n2116  640    1  4     3      0  1791 1791      1\n2117  641    1  2     1      0  2211 2211      0\n2118  641    1  3     2      0  2211 2211      0\n2119  641    1  4     3      0  2211 2211      1\n2120  642    1  2     1      0  4191 4191      1\n2121  642    1  3     2      0  4191 4191      0\n2122  642    1  4     3      0  4191 4191      0\n2123  642    2  3     4   4191  4597  406      0\n2124  642    2  4     5   4191  4597  406      1\n2125  643    1  2     1      0  5396 5396      0\n2126  643    1  3     2      0  5396 5396      0\n2127  643    1  4     3      0  5396 5396      0\n2128  644    1  2     1      0  2418 2418      0\n2129  644    1  3     2      0  2418 2418      0\n2130  644    1  4     3      0  2418 2418      1\n2131  645    1  2     1      0  2675 2675      0\n2132  645    1  3     2      0  2675 2675      0\n2133  645    1  4     3      0  2675 2675      1\n2134  646    1  2     1      0  4683 4683      1\n2135  646    1  3     2      0  4683 4683      0\n2136  646    1  4     3      0  4683 4683      0\n2137  646    2  3     4   4683  5247  564      0\n2138  646    2  4     5   4683  5247  564      0\n2139  647    1  2     1      0  5528 5528      0\n2140  647    1  3     2      0  5528 5528      0\n2141  647    1  4     3      0  5528 5528      0\n2142  648    1  2     1      0  5385 5385      0\n2143  648    1  3     2      0  5385 5385      0\n2144  648    1  4     3      0  5385 5385      0\n2145  649    1  2     1      0  5512 5512      0\n2146  649    1  3     2      0  5512 5512      0\n2147  649    1  4     3      0  5512 5512      0\n2148  650    1  2     1      0  1768 1768      0\n2149  650    1  3     2      0  1768 1768      0\n2150  650    1  4     3      0  1768 1768      1\n2151  651    1  2     1      0  5270 5270      0\n2152  651    1  3     2      0  5270 5270      0\n2153  651    1  4     3      0  5270 5270      0\n2154  652    1  2     1      0  3342 3342      1\n2155  652    1  3     2      0  3342 3342      0\n2156  652    1  4     3      0  3342 3342      0\n2157  652    2  3     4   3342  5323 1981      0\n2158  652    2  4     5   3342  5323 1981      0\n2159  653    1  2     1      0  5451 5451      0\n2160  653    1  3     2      0  5451 5451      0\n2161  653    1  4     3      0  5451 5451      0\n2162  654    1  2     1      0  3273 3273      0\n2163  654    1  3     2      0  3273 3273      1\n2164  654    1  4     3      0  3273 3273      0\n2165  654    3  4     6   3273  3350   77      1\n2166  655    1  2     1      0  5512 5512      0\n2167  655    1  3     2      0  5512 5512      0\n2168  655    1  4     3      0  5512 5512      0\n2169  656    1  2     1      0   569  569      0\n2170  656    1  3     2      0   569  569      0\n2171  656    1  4     3      0   569  569      1\n2172  657    1  2     1      0  5296 5296      0\n2173  657    1  3     2      0  5296 5296      0\n2174  657    1  4     3      0  5296 5296      0\n2175  658    1  2     1      0  5069 5069      1\n2176  658    1  3     2      0  5069 5069      0\n2177  658    1  4     3      0  5069 5069      0\n2178  658    2  3     4   5069  5274  205      0\n2179  658    2  4     5   5069  5274  205      0\n2180  659    1  2     1      0  5277 5277      0\n2181  659    1  3     2      0  5277 5277      0\n2182  659    1  4     3      0  5277 5277      0\n2183  660    1  2     1      0  4105 4105      0\n2184  660    1  3     2      0  4105 4105      0\n2185  660    1  4     3      0  4105 4105      1\n2186  661    1  2     1      0  1874 1874      0\n2187  661    1  3     2      0  1874 1874      0\n2188  661    1  4     3      0  1874 1874      1\n2189  662    1  2     1      0  5165 5165      0\n2190  662    1  3     2      0  5165 5165      0\n2191  662    1  4     3      0  5165 5165      1\n2192  663    1  2     1      0   847  847      1\n2193  663    1  3     2      0   847  847      0\n2194  663    1  4     3      0   847  847      0\n2195  663    2  3     4    847  5431 4584      0\n2196  663    2  4     5    847  5431 4584      0\n2197  664    1  2     1      0  5438 5438      0\n2198  664    1  3     2      0  5438 5438      0\n2199  664    1  4     3      0  5438 5438      0\n2200  665    1  2     1      0  4942 4942      1\n2201  665    1  3     2      0  4942 4942      0\n2202  665    1  4     3      0  4942 4942      0\n2203  665    2  3     4   4942  4997   55      0\n2204  665    2  4     5   4942  4997   55      1\n2205  666    1  2     1      0  4307 4307      0\n2206  666    1  3     2      0  4307 4307      0\n2207  666    1  4     3      0  4307 4307      1\n2208  667    1  2     1      0  5331 5331      0\n2209  667    1  3     2      0  5331 5331      0\n2210  667    1  4     3      0  5331 5331      0\n2211  668    1  2     1      0  5256 5256      0\n2212  668    1  3     2      0  5256 5256      0\n2213  668    1  4     3      0  5256 5256      0\n2214  669    1  2     1      0  5466 5466      0\n2215  669    1  3     2      0  5466 5466      0\n2216  669    1  4     3      0  5466 5466      0\n2217  670    1  2     1      0  1285 1285      0\n2218  670    1  3     2      0  1285 1285      0\n2219  670    1  4     3      0  1285 1285      1\n2220  671    1  2     1      0  1215 1215      0\n2221  671    1  3     2      0  1215 1215      1\n2222  671    1  4     3      0  1215 1215      0\n2223  671    3  4     6   1215  1252   37      1\n2224  672    1  2     1      0  5276 5276      0\n2225  672    1  3     2      0  5276 5276      0\n2226  672    1  4     3      0  5276 5276      0\n2227  673    1  2     1      0  2271 2271      1\n2228  673    1  3     2      0  2271 2271      0\n2229  673    1  4     3      0  2271 2271      0\n2230  673    2  3     4   2271  2289   18      1\n2231  673    2  4     5   2271  2289   18      0\n2232  673    3  4     6   2289  5280 2991      0\n2233  674    1  2     1      0  4037 4037      0\n2234  674    1  3     2      0  4037 4037      0\n2235  674    1  4     3      0  4037 4037      1\n2236  675    1  2     1      0  3478 3478      0\n2237  675    1  3     2      0  3478 3478      0\n2238  675    1  4     3      0  3478 3478      1\n2239  676    1  2     1      0  5260 5260      0\n2240  676    1  3     2      0  5260 5260      0\n2241  676    1  4     3      0  5260 5260      0\n2242  677    1  2     1      0  5464 5464      0\n2243  677    1  3     2      0  5464 5464      0\n2244  677    1  4     3      0  5464 5464      0\n2245  678    1  2     1      0  4755 4755      0\n2246  678    1  3     2      0  4755 4755      0\n2247  678    1  4     3      0  4755 4755      1\n12100  12    3  2     7   4359  5324  965      0\n18100  18    3  2     7   3325  5506 2181      0\n19100  19    3  2     7   2220  2540  320      0\n3010   30    3  2     7   1065  3971 2906      0\n3510   35    3  2     7   2776  2792   16      0\n4110   41    3  2     7   2885  4444 1559      0\n4510   45    3  2     7   1614  1618    4      0\n7310   73    3  2     7   1010  3288 2278      1\n8910   89    3  2     7   3024  4214 1190      0\n9210   92    3  2     7   4366  5463 1097      0\n9510   95    3  2     7   4586  5290  704      0\n11710 117    3  2     7    898  4343 3445      0\n12010 120    3  2     7   1249  1263   14      0\n12310 123    3  2     7   3962  5471 1509      0\n12410 124    3  2     7   2016  3882 1866      0\n13010 130    3  2     7   3715  5395 1680      0\n13210 132    3  2     7   2965  5208 2243      1\n16410 164    3  2     7   2037  3906 1869      0\n18310 183    3  2     7   2810  5280 2470      0\n18710 187    3  2     7   3381  4208  827      0\n19510 195    3  2     7   3753  5380 1627      0\n22310 223    3  2     7   3679  3700   21      0\n2281  228    3  2     7   4158  4661  503      0\n2421  242    3  2     7   1269  1269    0      0\n2501  250    3  2     7   1245  2505 1260      0\n2581  258    3  2     7    465  5249 4784      0\n2611  261    3  2     7   3201  3210    9      0\n2671  267    3  2     7   1984  1984    0      0\n2741  274    3  2     7    379   866  487      0\n2751  275    3  2     7   4017  5289 1272      0\n2851  285    3  2     7   2175  3880 1705      0\n2881  288    3  2     7   5432  5535  103      0\n2891  289    3  2     7    954   995   41      0\n2951  295    3  2     7   1869  3149 1280      0\n2991  299    3  2     7    620  3456 2836      0\n3021  302    3  2     7   2575  4454 1879      1\n3371  337    3  2     7   2487  2617  130      0\n3411  341    3  2     7   4556  5277  721      0\n3651  365    3  2     7    526  5404 4878      0\n3691  369    3  2     7     98   315  217      0\n3831  383    3  2     7   3778  5322 1544      0\n3891  389    3  2     7   1615  3104 1489      0\n3921  392    3  2     7   1361  1392   31      0\n3971  397    3  2     7   4709  4718    9      0\n4161  416    3  2     7   3205  3212    7      0\n4361  436    3  2     7    375  2714 2339      0\n4371  437    3  2     7   1282  5478 4196      0\n4391  439    3  2     7   1575  2643 1068      0\n4471  447    3  2     7   2471  4621 2150      1\n4491  449    3  2     7   3256  5319 2063      0\n4581  458    3  2     7   4672  4841  169      0\n4631  463    3  2     7   4063  5386 1323      0\n4781  478    3  2     7   2955  4383 1428      1\n5061  506    3  2     7   2422  4832 2410      1\n5221  522    3  2     7    251  2764 2513      0\n5311  531    3  2     7   2449  5323 2874      0\n5331  533    3  2     7   2264  2314   50      0\n5341  534    3  2     7   1541  4597 3056      0\n5401  540    3  2     7   3589  5332 1743      0\n5411  541    3  2     7   2726  5359 2633      0\n5501  550    3  2     7   3262  5375 2113      0\n5561  556    3  2     7    739  5049 4310      0\n5601  560    3  2     7    645  2331 1686      0\n5791  579    3  2     7   1630  4310 2680      0\n5801  580    3  2     7   4690  5473  783      0\n5871  587    3  2     7   2013  5128 3115      0\n5921  592    3  2     7   2153  5312 3159      0\n6171  617    3  2     7   3623  3683   60      0\n6201  620    3  2     7   1843  4842 2999      1\n6251  625    3  2     7   3692  4376  684      0\n6541  654    3  2     7   3273  3350   77      0\n6711  671    3  2     7   1215  1252   37      0\n6731  673    3  2     7   2289  5280 2991      0\n\n\nNB: We get a warning because 5 subjects have two events on the same day. This will be handled if necessary for further analyses.\n\n\n\nExercise 1.3\n\n1.\nDerive Equations (1.2) and (1.3) for, respectively, the survival function in the two-state model (Figure 1.1) and the cumulative incidence function in the competing risks model (Figure 1.2).\nThe hazard function \\[\\alpha(t)=\\lim_{dt\\rightarrow 0}P(T\\leq t+dt\\mid T>t)/dt\\] equals \\[\\alpha(t)=\\frac{f(t)}{S(t)}=\\frac{-(d/dt) S(t)}{S(t)}=-(d/dt)\\log S(t)\\] where \\(f(t)\\) is the density function for \\(T\\) and, thereby, \\(S(t)=\\exp(-\\int_0^t\\alpha(u)du)\\).\nThe cause \\(h\\) cumulative incidence is the probability of failing from cause \\(h\\) during \\([0,t]\\). This is the integral of the infinitesimal probabilities of failing in \\((u,u+du)\\) for \\(0\\leq u\\leq t\\). The probability of failing in \\((u,u+du)\\) is, by definition of the cause-\\(h\\)-specific hazard, equal to \\(S(u)\\alpha_h(u)du\\) and the desired result \\[Q_h(t)=\\int_0^tS(u)\\alpha_h(u)du\\] follows.\n\n\n2.\nShow, for the Markov illness-death model (Figure 1.3), that the state occupation probability for state 1 at time \\(t\\), \\(Q_1(t)\\), is \\[\\int_0^t\\exp\\left(-\\int_0^u(\\alpha_{01}(x)+\\alpha_{02}(x))dx\\right)\\alpha_{01}(u)\\exp\\left(-\\int_u^t\\alpha_{12}(x)dx\\right)du.\\]\nThe probability \\(P_{11}(u,t)\\) of staying in state 1 from time \\(u\\) to time \\(t\\) is given by \\(\\exp(-\\int_u^t\\alpha_{12}(x)dx)\\) and combining this with the argument from the previous question, i.e., that the (infinitesimal) probability \\(\\exp(-\\int_0^u(\\alpha_{01}(x)+\\alpha_{02}(x))dx)\\alpha_{01}(u)du\\), of moving from state 0 to state 1 during \\((u, u+du)\\), the desired result is obtained by integration over \\(u\\) from 0 to \\(t\\).\n\n\n\nExercise 1.4 (*)\nArgue (intuitively) how the martingale property \\(E(M(t)\\mid {\\cal H}_{s})=M(s)\\) follows from \\(E(dM(t)\\mid {\\cal H}_{t-})=0\\) (Section 1.4.3).\nBecause \\(M(s)\\) is adapted to the history \\({\\cal H}_s\\) we get \\[E(M(t)\\mid {\\cal F}_s)-M(s)=E(M(t)-M(s)\\mid {\\cal H}_s).\\] We write the difference \\(M(t)-M(s)\\) as the sum of increments \\[=E(\\int_{(s,t]}dM(u)\\mid {\\cal H}_s)\\] and change the order of integration and expectation \\[=\\int_{(s,t]}E(dM(u)\\mid {\\cal H}_s).\\] We finally use the `principle of repeated conditioning’ to obtain the desired result of 0 \\[=\\int_{(s,t]}E(E(dM(u)\\mid {\\cal H}_{u-})\\mid {\\cal H}_s)=0.\\]"
  },
  {
    "objectID": "Ch2.html#pbc3-trial-in-liver-cirrhosis",
    "href": "Ch2.html#pbc3-trial-in-liver-cirrhosis",
    "title": "2  Intuition for intensity models",
    "section": "PBC3 trial in liver cirrhosis",
    "text": "PBC3 trial in liver cirrhosis\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\npbc3 <- read.csv(\"data/pbc3.csv\")\npbc3$fail <- ifelse(pbc3$status != 0, 1, 0) # event/failure indicator\npbc3$tment_char <- ifelse(pbc3$tment == 0, \"Placebo\", \"CyA\")\n\n# Add transformations of covariates \npbc3$albnorm <- with(pbc3, (alb-35)*(alb>35))\npbc3$alb10 <- with(pbc3, alb/10)\npbc3$alb2 <- with(pbc3, alb10*alb10)\n\npbc3$bilihigh <- with(pbc3, (bili-17.1)*(bili>17.1))\npbc3$bilitoohigh <- with(pbc3, (bili-34.2)*(bili>34.2))\npbc3$bilimuchtoohigh <- with(pbc3, (bili-51.3)*(bili>51.3))\npbc3$bili100 <- with(pbc3, bili/100)\npbc3$bili2 <- with(pbc3, bili100*bili100)\n\npbc3$log2bili <- with(pbc3, log2(bili))\npbc3$log2bili2 <- with(pbc3, log2bili*log2bili)\n\npbc3$logbilihigh <- with(pbc3, (log2bili-log2(17.1))*(bili>17.1))\npbc3$logbilitoohigh <- with(pbc3, (log2bili-log2(34.2))*(bili>34.2))\npbc3$logbilimuchtoohigh <- with(pbc3, (log2bili-log2(51.3))*(bili>51.3))\n\n\n\n\n\n\nCode show/hide\nproc import out=pbc3\n    datafile=\"data/pbc3.csv\"\n    dbms=csv replace;\nrun;\ndata pbc3; \n    set pbc3;\n    albnorm=(alb-35)*(alb>35);\n    alb10=alb/10;\n    alb2=alb*alb;\n    bilihigh=(bili-17.1)*(bili>17.1);\n    bilitoohigh=(bili-34.2)*(bili>34.2);\n    bilimuchtoohigh=(bili-51.3)*(bili>51.3);\n    bili100=bili/100;\n    bili2=bili*bili;\n    log2bili=log2(bili);\n    logbilihigh=(log2bili-log2(17.1))*(bili>17.1);\n    logbilitoohigh=(log2bili-log2(34.2))*(bili>34.2);\n    logbilimuchtoohigh=(log2bili-log2(51.3))*(bili>51.3);\n    log2bili2=log2bili*log2bili;\nrun;\n\n\n\n\n\n\n\nFigure 2.1\n\nRSAS\n\n\n\n\nCode show/hide\n# General plotting style \nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20),\n        legend.position = \"bottom\", \n        legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        legend.key.size = unit(2,\"line\"))\n\n# Nelson Aalen estimate by treatment\nlibrary(survival)\nnafit <- survfit(Surv(days, status != 0) ~ tment, data = pbc3)\n# Collect data for plot\nnadata <- data.frame(cumhaz = nafit$cumhaz, time = nafit$time, \n                     tment = c(rep(names(nafit$strata)[1], nafit$strata[1]), \n                               rep(names(nafit$strata)[2], nafit$strata[2])))\n\n# Create Figure 2.1\nlibrary(ggplot2)\nfig2.1 <- ggplot(aes(x = time / 365.25, y = cumhaz, linetype = tment),\n                 data = nadata) + \n  geom_step(size = 1) + \n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\", \"CyA\")) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6), breaks = seq(0, 6, 1))  + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general \n\nfig2.1\n\n\n\n\n\n\n\n\n\nCode show/hide\nproc phreg data=pbc3; \n    model days*status(0)=;\n    strata tment;\n    baseline out=hazdat cumhaz=naa stdcumhaz=sdnaa;\nrun;\ndata hazdat; \n    set hazdat; \n    daysyears = days/365.25; \nrun; \nproc gplot data=hazdat;\n    plot naa*daysyears=tment/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none\n    label=('Years');\n    axis2 order=0 to 0.7 by 0.1 minor=none\n    label=(a=90 'Cumulative hazard');\n    symbol1  v=none i=stepjl c=red;\n    symbol2  v=none i=stepjl c=blue;\nrun;\n\n\n\n\n\n\n\nIn-text: Nelson-Aalen estimates at 2 years\n\nRSAS\n\n\n\n\nCode show/hide\ntail(subset(nadata, nadata$time <= 2*365.25 & nadata$tment == \"tment=0\"),1)\n\n\n     cumhaz time   tment\n60 0.183065  724 tment=0\n\n\nCode show/hide\ntail(subset(nadata, nadata$time <= 2*365.25 & nadata$tment == \"tment=1\"),1)\n\n\n       cumhaz time   tment\n209 0.1668539  725 tment=1\n\n\n\n\n\n\nCode show/hide\nproc print data=hazdat;\n    where 1.5<daysyears<=2; \nrun;\n\n\n\n\n\n\n\nTable 2.1\n\nRSAS\n\n\n\n\nCode show/hide\n# Data for Table 2.1\ncuts <- c(0, 2, 4) * 365.25\n# Make the data ready using survSplit from survival package\nlibrary(survival)\npbc3mult <- as.data.frame(survSplit(Surv(days, fail) ~ ., pbc3,\n                      cut = cuts[-1], \n                      episode = \"timegroup\"))\npbc3mult$risktime <- pbc3mult$days - cuts[pbc3mult$timegroup] \npbc3mult$timegroup <- as.factor(pbc3mult$timegroup)\n\nlibrary(dplyr)\npcwdata <- pbc3mult %>% \n  group_by(tment, timegroup) %>% \n  summarise(fail = sum(fail), risktime = sum(days - cuts[timegroup]))\npcwdata$risktimeyrs <- pcwdata$risktime/365.25\npcwdata$hazard <- 36525*pcwdata$fail/pcwdata$risktime\npcwdata$SD <- 36525*sqrt(pcwdata$fail)/pcwdata$risktime\ndata.frame(pcwdata)\n\n\n  tment timegroup fail risktime risktimeyrs    hazard       SD\n1     0         1   27 104856.0   287.08008  9.405041 1.810001\n2     0         2   17  49673.0   135.99726 12.500252 3.031756\n3     0         3    2   8642.0    23.66051  8.452904 5.977106\n4     1         1   24 107931.5   295.50034  8.121818 1.657859\n5     1         2   18  50284.5   137.67146 13.074605 3.081714\n6     1         3    2   7599.0    20.80493  9.613107 6.797493\n\n\n\n\n\n\nCode show/hide\n/* prepare for poisson model */\ndata pbc3mult; \n    set pbc3;\n    fail=(days<=2 * 365.25)*(status ne 0);\n    risktime=min(2 * 365.25, days);\n    logrisk=log(risktime); interv=1; output;  \n    if days>2 * 365.25 then do;\n    fail=(days<=4 * 365.25)*(status ne 0);\n    risktime=min(2 * 365.25 ,days-2 * 365.25);\n    logrisk=log(risktime); interv=2; output; end;\n    if days>4 * 365.25  then do;\n    fail=status ne 0; \n    risktime=days-4 * 365.25;\n    logrisk=log(risktime); interv=3; output; end;\nrun;\nproc means sum  data=pbc3mult;\n    class tment interv;\n    var fail risktime;\nrun;\n\nproc genmod data=pbc3mult;\n    where tment=1;\n    class interv;\n    model fail=interv/dist=poi offset=logrisk;\n    estimate '0-2 years' intercept 1  interv 1 0 0/exp;\n    estimate '2-4 years' intercept 1  interv 0 1 0/exp;\n    estimate '4-6 years' intercept 1  interv 0 0 1/exp;\nrun;\nproc genmod data=pbc3mult;\n    where tment=0;\n    class interv;\n    model fail=interv/dist=poi offset=logrisk;\n    estimate '0-2 years' intercept 1  interv 1 0 0/exp;\n    estimate '2-4 years' intercept 1  interv 0 1 0/exp;\n    estimate '4-6 years' intercept 1  interv 0 0 1/exp;\nrun;\n\n\n\n\n\n\n\nFigure 2.2\n\nR\n\n\n\n\nCode show/hide\n# Rates + cuts from Table 2.1\nrateCyA <- c(8.1,13.1,9.6)\nratePbo <- c(9.4,12.5,8.5)\npcwtime <- c(0,2,4,5)\n# Collect data\nplotdata <- data.frame(rates = c(rateCyA, ratePbo),\n                       tment = c(rep(\"CyA\", length(rateCyA)), \n                                 rep(\"Placebo\", length(ratePbo))),\n                       times_s = rep(pcwtime[-4], 2),\n                       times = rep(pcwtime[-1], 2))\n\n# Create Figure 2.2\nfig2.2 <- ggplot(aes(x = time, y = rates, linetype = tment), data = plotdata) +\n  geom_segment(aes(x = times_s, y = rates, xend = times, yend = rates),size=1) +\n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\", \"CyA\"))  +\n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Estimated hazard function (per 100 years)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 5),\n                     breaks = seq(0, 5, 1))  +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0,14), breaks = seq(0, 14, 2)) +\n  theme_general\n\nfig2.2\n\n\n\n\n\n\n\n\n\n\nIn-text: LRT test piece-wise exponential model\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(stats)\npoisfull <- glm(fail ~ tment + timegroup + tment*timegroup +\n                  offset(log(risktime/36525)), data = pbc3mult, family=poisson)\npoisred <- glm(fail ~  timegroup + tment +\n                 offset(log(risktime/36525)), data = pbc3mult, family=poisson)\nanova(poisred,poisfull,test=\"LRT\")\n\n\nAnalysis of Deviance Table\n\nModel 1: fail ~ timegroup + tment + offset(log(risktime/36525))\nModel 2: fail ~ tment + timegroup + tment * timegroup + offset(log(risktime/36525))\n  Resid. Df Resid. Dev Df Deviance Pr(>Chi)\n1       619     459.58                     \n2       617     459.35  2  0.22745   0.8925\n\n\nCode show/hide\n# or\nlibrary(lmtest)\nlrtest(poisred,poisfull)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + offset(log(risktime/36525))\nModel 2: fail ~ tment + timegroup + tment * timegroup + offset(log(risktime/36525))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -319.79                     \n2   6 -319.68  2 0.2274     0.8925\n\n\n\n\n\n\nCode show/hide\nods output modelfit=full;\nproc genmod data=pbc3mult;\n    class interv tment;\n    model fail=interv|tment /dist=poi offset=logrisk;\nrun;\ndata full;\n  set full;\n     where Criterion=\"Deviance\";\n     full_like=value;\n     full_df=df;\n     keep full_like full_df;\nrun;\nproc print;run;\nods output modelfit=reduced;\nproc genmod data=pbc3mult;\n    class interv tment;\n    model fail=interv /dist=poi offset=logrisk;\nrun;\ndata reduced;\n  set reduced;\n     where Criterion=\"Deviance\";\n     reduced_like=value;\n     reduced_df=df;\n     keep reduced_like reduced_df;\nrun;\ndata lrt_pval;\n merge full reduced;\n  lrt = reduced_like - full_like;\n    df  = reduced_df - full_df;\n  p_value = 1 - probchi(lrt,df);\nrun;\nproc print data=lrt_pval;\n  title \"LR test statistic and p-value\";\nrun;\n\n\n\n\n\n\n\nIn-text: Logrank test and p-value\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(survival)\nlr<-survdiff(Surv(days, status != 0) ~ tment, data = pbc3)\nc(lr$chisq,lr$pvalue)\n\n\n[1] 0.07708002 0.78129419\n\n\n\n\n\n\nCode show/hide\nproc lifetest data=pbc3 notable; \n    time days*status(0);\n    strata tment;\nrun;\n\n\n\n\n\n\n\nFigure 2.3\n\nRSAS\n\n\n\n\nCode show/hide\n# NA data from figure 2.1 model fit\ntment1 <- subset(nadata, tment == \"tment=1\")\n# Estimated hazard per time group\npcwdata$hazard_timegroup <- pcwdata$fail / pcwdata$risktime\n# Add a numeric version of the treatment to the NA estimates\nnadata$tmentnum <- ifelse(nadata$tment == \"tment=1\", 1, 0)\n# Add piecewise constant hazard to data\nnadata$pwch <- NULL\n# Between time 0 and 2\nnadata$pwch[nadata$time <= 2 * 365.25] <- nadata$time[nadata$time <= 2 * 365.25] *\n  (pcwdata$hazard_timegroup[1] * (1-nadata$tmentnum[nadata$time <= 2 * 365.25]) +\n     pcwdata$hazard_timegroup[4] * (nadata$tmentnum[nadata$time <= 2 * 365.25]))\n# Between time 2 and 4\nnadata$pwch[nadata$time > 2 * 365.25 & nadata$time <= 4* 365.25 ] <- 2 * 365.25 * \n  (pcwdata$hazard_timegroup[1] * (1-nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25]) + \n     pcwdata$hazard_timegroup[4] * (nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25])) + \n  (nadata$time[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25] - 2 * 365.25) * \n  (pcwdata$hazard_timegroup[2] * (1-nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25]) + \n     pcwdata$hazard_timegroup[5] * (nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25]))\n# After time 4\nnadata$pwch[nadata$time > 4 * 365.25] <- 2 * 365.25 * \n  (pcwdata$hazard_timegroup[1] * (1-nadata$tmentnum[nadata$time > 4 * 365.25]) + \n     pcwdata$hazard_timegroup[4] * (nadata$tmentnum[nadata$time > 4 * 365.25])) + \n   2 * 365.25 * \n  (pcwdata$hazard_timegroup[2] * (1-nadata$tmentnum[nadata$time > 4 * 365.25]) + \n     pcwdata$hazard_timegroup[5] * (nadata$tmentnum[nadata$time > 4 * 365.25])) + \n  (nadata$time[nadata$time > 4 * 365.25] - 4 * 365.25) * \n  (pcwdata$hazard_timegroup[3] * (1-nadata$tmentnum[nadata$time > 4 * 365.25]) + \n     pcwdata$hazard_timegroup[6] * (nadata$tmentnum[nadata$time > 4 * 365.25]))\n# Reformat for plot\npiecepdata <- data.frame(cumhaz = c(nadata$cumhaz, nadata$pwch), \n                         time = rep(nadata$time, 2),\n                         tmentnum = rep(nadata$tmentnum, 2),\n                         type = c(rep(\"Nelson-Aalen\", length(nadata$time)), \n                                  rep(\"Piece-wise exponential\", length(nadata$time))))\n# Only for treatment 1\npiecepdata1 <- subset(piecepdata, tmentnum == 1)\n\n# Create Figure 2.3\nfig2.3 <- ggplot(aes(x = time / 365.25, y = cumhaz, linetype = type), \n                data = subset(piecepdata1, type == \"Nelson-Aalen\")) + \n  geom_step(size = 1) + \n  geom_line(aes(x = time / 365.25, y = cumhaz, linetype = type), size = 1,\n            data = subset(piecepdata1, type == \"Piece-wise exponential\")) + \n  labs(linetype = \"Type\") + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1))  + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general+\n  theme(legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        legend.key.size = unit(2,\"line\"))\n\nfig2.3\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata hazdat; \n    set hazdat;\n    if days<=2 * 365.25 then \n        pwch=days*(27.0000000/104856*(1-tment)+24.0000000/107931.5*tment);\n\n    if 2 * 365.25 <days<=4 * 365.25 then\n        pwch=2* 365.25*(27.0000000/104856*(1-tment)+24.0000000/107931.5*tment)\n        +(days-2* 365.25)*(17.0000000/49673*(1-tment)+18.0000000/50284*tment);\n\n    if 4 * 365.25 <days then\n        pwch=2* 365.25 *(27.0000000/104856*(1-tment)+24.0000000/107931.5*tment)\n        +(2* 365.25)*(17.0000000/49673*(1-tment)+18.0000000/50284*tment)\n        +(days-4* 365.25)*(2.0000000/8642*(1-tment)+2.0000000/7599*tment);\n    daysyears = days/365.25; \nrun; \n\nproc gplot data=hazdat; where tment=1;\n    plot (naa pwch)*daysyears/overlay haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 0.7 by 0.1 minor=none\n      label=(a=90 'Cumulative hazard');\n    symbol1  v=none i=stepjl r=1 c=red;\n    symbol2 v=none i=join r=1 c=blue;\nrun;\n\n\n\n\n\n\n\nIn-text: Cox model with treatment only\n\nRSAS\n\n\n\n\nCode show/hide\n# Fit a Cox model using the pbc3 data with treatment as a covariate\nlibrary(survival)\ncoxfit <- coxph(Surv(days, status != 0) ~ tment, data = pbc3, method = \"breslow\")\ncoxfit\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment, data = pbc3, \n    method = \"breslow\")\n\n          coef exp(coef) se(coef)      z     p\ntment -0.05854   0.94314  0.21092 -0.278 0.781\n\nLikelihood ratio test=0.08  on 1 df, p=0.7813\nn= 349, number of events= 90 \n\n\n\n\n\n\nCode show/hide\nproc phreg data=pbc3;\n    model days*status(0)=tment/rl;\nrun;\n\n\n\n\n\n\n\nFigure 2.5\n\nRSAS\n\n\n\n\nCode show/hide\n# Extract cumulative baseline hazard\ncoxcumhaz <- basehaz(coxfit, centered = FALSE)\n# Collect data for plot (Breslow estimate)\ncoxdata <- data.frame(cumhaz = coxcumhaz$hazard, \n                      time = coxcumhaz$time, \n                      tment = rep(\"0\", nrow(coxcumhaz)), \n                      type = rep(\"Breslow estimate\", nrow(coxcumhaz)))\n\nfig2.5 <- ggplot(aes(x = time / 365.25, y = cumhaz, linetype = tment),\n                 data = coxdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative baseline hazard\") + \n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\")) + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general+theme(legend.position = \"none\")\n\nfig2.5\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata cov;\n    tment=0;\nrun;\nproc phreg data=pbc3;\n    model days*status(0)=tment/rl;\n    baseline out=breslow cumhaz=breslow covariates=cov;\nrun;\ndata breslow; \n    set breslow; \n    daysyears = days/365.25; \nrun; \nproc gplot data=breslow;\n    plot breslow*daysyears=tment/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 0.7 by 0.1 minor=none label=(a=90 'Cumulative baseline hazard');\n    symbol1  v=none i=stepjl c=blue;\nrun;\n\n\n\n\n\n\n\nTable 2.3\n\nRSAS\n\n\n\n\nCode show/hide\n# Average covariate values of albumin and bilirubin per treatment \nlibrary(dplyr)\ntabledata <- pbc3 %>% \n  group_by(tment, tment_char) %>% \n  summarise(n = sum(id != 0),  \n            average_albumin = mean(alb, na.rm = TRUE), \n            # NOTE: Removes missing observations from mean computation\n            average_bilirubin = mean(bili, na.rm = TRUE), \n            )\ndata.frame(tabledata)\n\n\n  tment tment_char   n average_albumin average_bilirubin\n1     0    Placebo 173        39.26101          42.33674\n2     1        CyA 176        37.50731          48.55540\n\n\n\n\n\n\nCode show/hide\nproc means data=pbc3 mean;\n  class tment;\n    var alb bili;\nrun;\n\n\n\n\n\n\n\nTable 2.4\n\nRSAS\n\n\n\n\nCode show/hide\n# Cox model with treatment, albumin and bilirubin as covariates \nlibrary(survival)\ncoxfit <- coxph(Surv(days, status != 0) ~ tment + alb + bili,\n                data = pbc3)\ncoxfit\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili, \n    data = pbc3)\n\n            coef  exp(coef)   se(coef)      z        p\ntment -0.4965639  0.6086184  0.2256162 -2.201   0.0277\nalb   -0.1156596  0.8907784  0.0212810 -5.435 5.48e-08\nbili   0.0089494  1.0089895  0.0009801  9.131  < 2e-16\n\nLikelihood ratio test=99.06  on 3 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\n\n\n\n\nCode show/hide\nproc phreg data=pbc3;\n    model days*status(0)=tment alb bili / rl;\nrun;\n\n\n\n\n\n\n\nIn-text: Poisson model with treatment only (and time)\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(stats)\nlibrary(jtools) # For using summ() function to get exp(beta)\noptions(contrasts=c(\"contr.treatment\", \"contr.poly\"))\npoism <- glm(fail ~ -1 +tment + timegroup +\n               offset(log(risktime/365.25)), data = pbc3mult,family = poisson)\nsumm(poism, exp = T,digits = 3, model.info = F, model.fit = F)\n\n\n\n\n\n\n\n\n\nexp(Est.)\n\n\n2.5%\n\n\n97.5%\n\n\nz val.\n\n\np\n\n\n\n\n\n\ntment\n\n\n0.942\n\n\n0.623\n\n\n1.424\n\n\n-0.284\n\n\n0.776\n\n\n\n\ntimegroup1\n\n\n0.090\n\n\n0.064\n\n\n0.127\n\n\n-13.801\n\n\n0.000\n\n\n\n\ntimegroup2\n\n\n0.132\n\n\n0.089\n\n\n0.194\n\n\n-10.242\n\n\n0.000\n\n\n\n\ntimegroup3\n\n\n0.092\n\n\n0.034\n\n\n0.251\n\n\n-4.677\n\n\n0.000\n\n\n\n\n\n\n Standard errors: MLE\n\n\n\n\n\n\n\n\n\n\n\nCode show/hide\nproc genmod data=pbc3mult;\n  class tment(ref=\"0\") interv ;\n  model fail = tment interv / dist=poi offset=logrisk;\n    estimate 'CyA  vs placebo' tment 1 -1 / exp;\n  estimate '0-2 years' intercept 1 tment 0 1 interv 1 0 0 / exp;\n  estimate '2-4 years' intercept 1 tment 0 1 interv 0 1 0 / exp;\n  estimate '4+ years'  intercept 1 tment 0 1 interv 0 0 1 / exp;\nrun;\n\n\n\n\n\n\n\nTable 2.5\n\nRSAS\n\n\n\n\nCode show/hide\n# Poisson model with treatment, albumin and bilirubin as covariates\npoismod_t25 <- glm(fail ~ tment + alb + bili+ timegroup-1 +\n                     offset(log(risktime/365.25)),data=pbc3mult,family=poisson)\ntidy(poismod_t25)\n\n\n# A tibble: 6 × 5\n  term       estimate std.error statistic  p.value\n  <chr>         <dbl>     <dbl>     <dbl>    <dbl>\n1 tment      -0.475    0.224        -2.12 3.39e- 2\n2 alb        -0.112    0.0213       -5.28 1.30e- 7\n3 bili        0.00846  0.000939      9.01 2.12e-19\n4 timegroup1  1.29     0.806         1.60 1.10e- 1\n5 timegroup2  2.15     0.833         2.58 9.99e- 3\n6 timegroup3  1.61     1.01          1.59 1.12e- 1\n\n\n\n\n\n\nCode show/hide\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= tment interv alb  bili / dist=poi offset=logrisk ;\nrun;\n\n\n\n\n\n\n\nTable 2.6\n\nRSAS\n\n\n\n\nCode show/hide\n#------------------------------------------------------------------#\n# Table 2.6 Cox models \n#------------------------------------------------------------------#\n\n# Models for LR tests\nlibrary(lmtest)\nbase_coxmod <- coxph(Surv(days, status != 0) ~ tment + alb + bili, \n                     eps = 1e-8, method = \"breslow\", data = pbc3)\nbase_coxmod_log <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                         eps = 1e-8, method = \"breslow\", data = pbc3)\n\n# Splines Cox 1\ncoxmod_t26_l1 <- coxph(Surv(days, status != 0) ~ tment + alb + albnorm + bili,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_l1\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + albnorm + \n    bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n              coef  exp(coef)   se(coef)      z      p\ntment   -0.4750722  0.6218402  0.2261462 -2.101 0.0357\nalb     -0.0854244  0.9181225  0.0453150 -1.885 0.0594\nalbnorm -0.0557001  0.9458228  0.0726447 -0.767 0.4432\nbili     0.0089810  1.0090214  0.0009843  9.124 <2e-16\n\nLikelihood ratio test=99.66  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\nlrtest(coxmod_t26_l1, base_coxmod)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + albnorm + bili\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -413.12                     \n2   3 -413.42 -1 0.6001     0.4386\n\n\nCode show/hide\n# Quadratic Cox 1\ncoxmod_t26_q1 <- coxph(Surv(days, status != 0) ~ tment + alb + I(alb*alb) + bili,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_q1\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + I(alb * \n    alb) + bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n                   coef  exp(coef)   se(coef)      z      p\ntment        -0.4983093  0.6075570  0.2274284 -2.191 0.0284\nalb          -0.1295361  0.8785029  0.2130539 -0.608 0.5432\nI(alb * alb)  0.0001944  1.0001945  0.0029754  0.065 0.9479\nbili          0.0089499  1.0089901  0.0009801  9.132 <2e-16\n\nLikelihood ratio test=99.07  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\nlrtest(coxmod_t26_q1, base_coxmod)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + I(alb * alb) + bili\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -413.41                     \n2   3 -413.42 -1 0.0042      0.948\n\n\nCode show/hide\n# Splines Cox 2\ncoxmod_t26_l2 <- coxph(Surv(days, status != 0) ~ tment + alb + \n                         bili + bilihigh + bilitoohigh + bilimuchtoohigh,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_l2\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili + \n    bilihigh + bilitoohigh + bilimuchtoohigh, data = pbc3, method = \"breslow\", \n    eps = 1e-08)\n\n                     coef exp(coef)  se(coef)      z        p\ntment           -0.598494  0.549639  0.229637 -2.606  0.00915\nalb             -0.090970  0.913045  0.021894 -4.155 3.25e-05\nbili             0.062425  1.064414  0.062296  1.002  0.31631\nbilihigh        -0.014631  0.985476  0.085327 -0.171  0.86386\nbilitoohigh     -0.002584  0.997419  0.052961 -0.049  0.96109\nbilimuchtoohigh -0.040017  0.960773  0.026486 -1.511  0.13082\n\nLikelihood ratio test=123.5  on 6 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\nlrtest(coxmod_t26_l2, base_coxmod)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + bili + bilihigh + bilitoohigh + \n    bilimuchtoohigh\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   6 -401.22                         \n2   3 -413.42 -3 24.396  2.064e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode show/hide\n# Quadratic Cox 2\ncoxmod_t26_q2 <- coxph(Surv(days, status != 0) ~ tment+alb+bili + I(bili*bili),\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_q2\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili + \n    I(bili * bili), data = pbc3, method = \"breslow\", eps = 1e-08)\n\n                     coef  exp(coef)   se(coef)      z        p\ntment          -5.210e-01  5.939e-01  2.233e-01 -2.333 0.019640\nalb            -1.019e-01  9.031e-01  2.168e-02 -4.703 2.56e-06\nbili            1.998e-02  1.020e+00  3.263e-03  6.122 9.21e-10\nI(bili * bili) -3.051e-05  1.000e+00  9.098e-06 -3.354 0.000798\n\nLikelihood ratio test=111.4  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\nlrtest(coxmod_t26_q2, base_coxmod)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + bili + I(bili * bili)\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   4 -407.24                         \n2   3 -413.42 -1 12.351  0.0004408 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode show/hide\n# Splines Cox 3\ncoxmod_t26_l3 <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili +\n                         logbilihigh + logbilitoohigh + logbilimuchtoohigh,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_l3\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili + \n    logbilihigh + logbilitoohigh + logbilimuchtoohigh, data = pbc3, \n    method = \"breslow\", eps = 1e-08)\n\n                       coef exp(coef) se(coef)      z        p\ntment              -0.58019   0.55979  0.22957 -2.527   0.0115\nalb                -0.08852   0.91528  0.02182 -4.056 4.99e-05\nlog2bili            0.20135   1.22306  0.46511  0.433   0.6651\nlogbilihigh         0.93567   2.54893  0.91503  1.023   0.3065\nlogbilitoohigh     -0.38647   0.67945  1.29333 -0.299   0.7651\nlogbilimuchtoohigh -0.18140   0.83410  0.98801 -0.184   0.8543\n\nLikelihood ratio test=121.6  on 6 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\nlrtest(coxmod_t26_l3, base_coxmod_log)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + log2bili + logbilihigh + \n    logbilitoohigh + logbilimuchtoohigh\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -402.13                     \n2   3 -402.94 -3 1.6144     0.6561\n\n\nCode show/hide\n# Quadratic Cox 3\ncoxmod_t26_q3 <- coxph(Surv(days, status != 0) ~ tment+alb+log2bili + log2bili2,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_q3\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili + \n    log2bili2, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n              coef exp(coef) se(coef)      z        p\ntment     -0.57408   0.56323  0.22454 -2.557   0.0106\nalb       -0.09150   0.91256  0.02192 -4.175 2.98e-05\nlog2bili   0.58231   1.79017  0.49992  1.165   0.2441\nlog2bili2  0.00715   1.00717  0.04277  0.167   0.8672\n\nLikelihood ratio test=120  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\nlrtest(coxmod_t26_q3, base_coxmod_log)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + log2bili + log2bili2\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -402.93                     \n2   3 -402.94 -1 0.0277     0.8677\n\n\nCode show/hide\n#------------------------------------------------------------------#\n# Table 2.6 Poisson models \n#------------------------------------------------------------------#\n\n# Make the data ready for Poisson models using survSplit from survival package\nlibrary(survival)\npbc3mult <- as.data.frame(survSplit(Surv(days, fail) ~ ., pbc3,\n                                    cut = cuts[-1], \n                                    episode = \"timegroup\"))\npbc3mult$risktime <- pbc3mult$days - cuts[pbc3mult$timegroup] \npbc3mult$timegroup <- as.factor(pbc3mult$timegroup)\n\n# Models for LR test\nbase_poismod <- glm(fail ~ timegroup + tment + alb + bili +\n                      offset(log(risktime)), data = pbc3mult, family = poisson)\nbase_poismod_log <- glm(fail ~ timegroup + tment + alb + log2bili +\n                          offset(log(risktime)), data=pbc3mult,family=poisson)\n\n# Splines Poisson 1\npoismod_t26_l1 <- glm(fail ~ timegroup + tment + alb + albnorm + bili +\n                        offset(log(risktime)), data=pbc3mult, family=poisson)\ntidy(poismod_t26_l1)\n\n\n# A tibble: 7 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept) -5.43     1.50        -3.62  2.92e- 4\n2 timegroup2   0.854    0.236        3.62  3.00e- 4\n3 timegroup3   0.311    0.604        0.514 6.07e- 1\n4 tment       -0.458    0.225       -2.04  4.17e- 2\n5 alb         -0.0864   0.0452      -1.91  5.57e- 2\n6 albnorm     -0.0474   0.0720      -0.658 5.11e- 1\n7 bili         0.00848  0.000942     9.00  2.24e-19\n\n\nCode show/hide\nlrtest(poismod_t26_l1, base_poismod)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + albnorm + bili + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   7 -263.14                     \n2   6 -263.36 -1 0.4404     0.5069\n\n\nCode show/hide\n# Quadratic Poisson 1\npoismod_t26_q1 <- glm(fail ~ timegroup + tment + alb + I(alb*alb) + bili +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_q1)\n\n\n# A tibble: 7 × 5\n  term          estimate std.error statistic  p.value\n  <chr>            <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -4.15      3.74        -1.11  2.67e- 1\n2 timegroup2    0.859     0.236        3.63  2.79e- 4\n3 timegroup3    0.323     0.605        0.534 5.94e- 1\n4 tment        -0.479     0.226       -2.12  3.41e- 2\n5 alb          -0.139     0.210       -0.660 5.09e- 1\n6 I(alb * alb)  0.000371  0.00293      0.126 8.99e- 1\n7 bili          0.00846   0.000939     9.01  2.05e-19\n\n\nCode show/hide\nlrtest(poismod_t26_q1, base_poismod)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + I(alb * alb) + bili + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   7 -263.36                     \n2   6 -263.36 -1 0.0158     0.8999\n\n\nCode show/hide\n# Splines Poisson 2\npoismod_t26_l2 <- glm(fail ~ timegroup + tment + alb + \n                        bili + bilihigh + bilitoohigh + bilimuchtoohigh +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_l2)\n\n\n# A tibble: 9 × 5\n  term            estimate std.error statistic      p.value\n  <chr>              <dbl>     <dbl>     <dbl>        <dbl>\n1 (Intercept)     -6.88       1.21     -5.68   0.0000000134\n2 timegroup2       0.853      0.232     3.68   0.000230    \n3 timegroup3       0.427      0.605     0.707  0.480       \n4 tment           -0.569      0.227    -2.51   0.0121      \n5 alb             -0.0865     0.0219   -3.95   0.0000770   \n6 bili             0.0617     0.0623    0.989  0.322       \n7 bilihigh        -0.0168     0.0852   -0.197  0.844       \n8 bilitoohigh      0.00265    0.0526    0.0504 0.960       \n9 bilimuchtoohigh -0.0428     0.0262   -1.63   0.102       \n\n\nCode show/hide\nlrtest(poismod_t26_l2, base_poismod)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + bili + bilihigh + bilitoohigh + \n    bilimuchtoohigh + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   9 -251.09                         \n2   6 -263.36 -3 24.545  1.922e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode show/hide\n# Quadratic Poisson 2\npoismod_t26_q2 <- glm(fail ~ timegroup + tment + alb + bili + I(bili*bili) +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_q2)\n\n\n# A tibble: 7 × 5\n  term             estimate  std.error statistic  p.value\n  <chr>               <dbl>      <dbl>     <dbl>    <dbl>\n1 (Intercept)    -5.54      0.844         -6.57  5.08e-11\n2 timegroup2      0.837     0.232          3.61  3.06e- 4\n3 timegroup3      0.382     0.605          0.631 5.28e- 1\n4 tment          -0.499     0.222         -2.25  2.45e- 2\n5 alb            -0.0977    0.0216        -4.52  6.24e- 6\n6 bili            0.0200    0.00327        6.12  9.49e-10\n7 I(bili * bili) -0.0000315 0.00000907    -3.48  5.10e- 4\n\n\nCode show/hide\nlrtest(poismod_t26_q2, base_poismod)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + bili + I(bili * bili) + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   7 -256.69                         \n2   6 -263.36 -1 13.345  0.0002591 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode show/hide\n# Splines Poisson 3\npoismod_t26_l3 <- glm(fail ~ timegroup + tment + alb + \n                        log2bili + logbilihigh + logbilitoohigh + logbilimuchtoohigh +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_l3)\n\n\n# A tibble: 9 × 5\n  term               estimate std.error statistic  p.value\n  <chr>                 <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)         -6.93      1.89      -3.67  0.000246\n2 timegroup2           0.825     0.229      3.60  0.000320\n3 timegroup3           0.407     0.604      0.674 0.501   \n4 tment               -0.556     0.227     -2.45  0.0144  \n5 alb                 -0.0844    0.0218    -3.87  0.000109\n6 log2bili             0.198     0.465      0.425 0.671   \n7 logbilihigh          0.882     0.912      0.967 0.334   \n8 logbilitoohigh      -0.234     1.28      -0.183 0.855   \n9 logbilimuchtoohigh  -0.314     0.971     -0.323 0.746   \n\n\nCode show/hide\nlrtest(poismod_t26_l3, base_poismod_log)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + logbilihigh + logbilitoohigh + \n    logbilimuchtoohigh + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   9 -251.77                     \n2   6 -252.62 -3 1.7135     0.6339\n\n\nCode show/hide\n# Quadratic Poisson 3\npoismod_t26_q3 <- glm(fail ~ timegroup + tment + alb + log2bili + log2bili2 +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_q3)\n\n\n# A tibble: 7 × 5\n  term        estimate std.error statistic    p.value\n  <chr>          <dbl>     <dbl>     <dbl>      <dbl>\n1 (Intercept) -8.27       1.73     -4.77   0.00000184\n2 timegroup2   0.845      0.230     3.67   0.000245  \n3 timegroup3   0.406      0.605     0.672  0.502     \n4 tment       -0.545      0.223    -2.45   0.0143    \n5 alb         -0.0871     0.0219   -3.98   0.0000692 \n6 log2bili     0.628      0.497     1.26   0.207     \n7 log2bili2    0.00164    0.0424    0.0387 0.969     \n\n\nCode show/hide\nlrtest(poismod_t26_q3, base_poismod_log)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + log2bili2 + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   7 -252.62                     \n2   6 -252.62 -1 0.0015     0.9691\n\n\n\n\n\n\nCode show/hide\n** Cox models **;\n\n* Base models for LR tests; \nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb bili/rl ties=breslow CONVERGELIKE=1E-8 type3(lr);\nrun;\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili/rl ties=breslow CONVERGELIKE=1E-8 type3(lr);\nrun;\n\n* Splines Cox 1; \n* LRT can here be read of type3 test result; \nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb albnorm bili/rl ties=breslow CONVERGELIKE=1E-8 type3(lr);\nrun;\n\n* Quadratic Cox 1; \n* LRT can here be read of type3 test result; \nproc phreg data=pbc3;\n  alb2=alb*alb;\n    class tment (ref='0');\n    model days*status(0)=tment alb10 alb2 bili100/rl type3(LR);\nrun;\n\n* Splines Cox 2;\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb bili bilihigh bilitoohigh \n                             bilimuchtoohigh/rl type3(lr) ties=breslow CONVERGELIKE=1E-8;\n  Wald_same_as_LRT: test  bilihigh=bilitoohigh=bilimuchtoohigh=0;\nrun;\n* LRT; \ndata p;\n    chi2=826.830-802.434;\n    p=1-probchi(chi2,3);\nproc print;\nrun;\n\n* Quadratic Cox 2; \n* LRT can here be read of type3 test result; \nproc phreg data=pbc3;\n  bili2=bili*bili;\n    class tment (ref='0');\n    model days*status(0)=tment alb10 bili bili2 / rl type3(LR);\nrun;\n\n* Splines Cox 3;\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili logbilihigh \n                             logbilitoohigh logbilimuchtoohigh/rl ties=breslow CONVERGELIKE=1E-8;\n  Wald_same_as_LRT: test  logbilihigh=logbilitoohigh=logbilimuchtoohigh=0;\nrun;\n* LRT; \ndata p;\n    chi2=805.881-804.267;\n    p=1-probchi(chi2,3);\nproc print;\nrun;\n\n* Quadratic Cox 3; \n* LRT can here be read of type3 test result; \nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb10 log2bili log2bili2/rl type3(LR);\nrun;\n\n* Split data into timegroups for Poisson models; \ndata pbc3mult; \n    set pbc3;\n    fail=(days<=2 * 365.25)*(status ne 0);\n    risktime=min(2 * 365.25,days);\n    logrisk=log(risktime); interv=1; output;  \n    if days>2* 365.25 then do;\n    fail=(days<=4* 365.25)*(status ne 0);\n    risktime=min(2* 365.25,days-2* 365.25);\n    logrisk=log(risktime); interv=2; output; end;\n    if days>4* 365.25 then do;\n    fail=status ne 0; \n    risktime=days-4* 365.25;\n    logrisk=log(risktime); interv=3; output; end;\nrun;\n\n\n** Possion models **;\n\n* Models to compare with for the LR tests; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb bili/ dist=poi offset=logrisk type3;\nrun;\n\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb log2bili/ dist=poi offset=logrisk type3;\nrun;\n\n* Splines Poisson 1; \n* LRT can here be read of type3 test result; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb albnorm bili/ dist=poi offset=logrisk type3;\nrun;\n\n* Quadratic Poisson 1;\n* LRT can here be read of type3 test result; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb10 alb2 bili100/ dist=poi offset=logrisk type3;\nrun;\n\n* Splines Poisson 2; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb bili bilihigh bilitoohigh  \n                 bilimuchtoohigh/ dist=poi offset=logrisk type3;\nrun;\n* LRT; \ndata p;\n    chi2=350.7253-326.1805;\n    p=1-probchi(chi2,3);\nproc print;\nrun;\n\n* Quadratic Poisson 2;\n* LRT can here be read of type3 test result; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb10 bili100 bili2/ dist=poi offset=logrisk type3;\nrun;\n\n* Splines Poisson 3;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb log2bili logbilihigh logbilitoohigh \n                 logbilimuchtoohigh / dist=poi offset=logrisk type3;\nrun;\n* LRT; \ndata p;\n    chi2=329.2509-327.5375;\n    p=1-probchi(chi2,3);\nproc print;\nrun;\n\n* Quadratic Poisson 3;\n* LRT can here be read of type3 test result; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb10 log2bili log2bili2/ dist=poi offset=logrisk type3;\nrun;\n\n\n\n\n\n\n\nFigure 2.6\n\nRSAS\n\n\n\n\nCode show/hide\n# The below linear predictors include estimates from the following models\npbc3mult$timegroup <- relevel(as.factor(pbc3mult$timegroup), ref = \"3\")\npbc3mult$tment_char <- as.factor(pbc3mult$tment_char)\npbc3mult$tment_char <- relevel(pbc3mult$tment_char, ref = \"Placebo\")\nbase_poismod <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                      tment_char + alb + bili,\n                    data = pbc3mult, family = poisson)\npoismod_t26_l1 <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                        tment_char + alb + bili + albnorm,\n                      data = pbc3mult, family = poisson)\npoismod_t26_l3 <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                        tment_char + alb + \n                        bili + bilihigh + bilitoohigh + bilimuchtoohigh,\n                      data = pbc3mult,family = poisson)\n# Make a dataset with linear predictor information\nlin2 <- pbc3\nlin2$lp1 <- with(pbc3, 1.6076-0.1123*alb)\nlin2$lp2 <- with(pbc3, 0.7828-0.0864*alb-0.0474*albnorm)\nlin2$lp3 <- with(pbc3, 1.6076+0.0085*bili-38.7*0.1123)\nlin2$lp4 <- with(pbc3, -0.5534+0.0617*bili-0.0168*bilihigh+\n                   0.0027*bilitoohigh-0.0428*bilimuchtoohigh-0.0865*38.7)\nlin2row <- data.frame(effect = c(rep(\"Linear effect\", nrow(lin2)),\n                                 rep(\"Effect as linear spline\", nrow(lin2))), \n                      lp = c(lin2$lp1, lin2$lp2), alb = c(lin2$alb, lin2$alb))\nlibrary(ggplot2)\nfig2.6 <- ggplot(aes(x = alb, y = lp, linetype = effect), data = lin2row) +\n  geom_line(size = 1) + \n  xlab(\"Albumin\") + \n  ylab(\"Linear predictor\") + \n  scale_linetype_discrete(\"Effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.6\n\n\n\n\n\n\n\n\n\nCode show/hide\n* Below is estimates from the following models collected; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb bili/ dist=poi offset=logrisk type3;\nrun;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb albnorm bili/ dist=poi offset=logrisk type3;\nrun;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb bili bilihigh bilitoohigh \n             logbilimuchtoohigh / dist=poi offset=logrisk type3;\nrun;\n\n* Collect linear predictor information; \ndata lin2; set pbc3;\n    lp1=1.6076-0.1123*alb; * bilirubin = 0; \n    lp2=0.7828-0.0864*alb-0.0474*albnorm;\n    lp3=1.6076+0.0085*bili-38.7*0.1123; *also an effect of albumin at 38.7; \n    lp4=-0.5534+0.0617*bili-0.0168*bilihigh+0.0027*bilitoohigh\n        -0.0428*bilimuchtoohigh-0.0865*38.7;\nrun;\nproc sort data=lin2; by alb; run;\nlegend1 label=none;\nproc gplot data=lin2;\n    plot (lp2 lp1)*alb/overlay haxis=axis1 vaxis=axis2 legend=legend1;\n    axis1 order=20 to 60 by 10 minor=none label=('Se-albumin');\n    axis2 order=-6 to 0 by 1 minor=none label=(a=90 'Linear predictor');\n    symbol1 v=none i=join r=1 c=red;\n    symbol2 v=none i=join r=1 c=blue;\n    label lp2=\"Effect as linear spline\";\n    label lp1=\"Linear effect\";\nrun; \nquit;\n\n\n\n\n\n\n\nFigure 2.7\n\nRSAS\n\n\n\n\nCode show/hide\n# bilirubin and the two last linear predictors\nlin2row2 <- data.frame(effect = c(rep(\"Linear effect\", nrow(lin2)),\n                                  rep(\"Effect as linear spline\", nrow(lin2))), \n                      lp = c(lin2$lp3, lin2$lp4),\n                      bili = c(lin2$bili, lin2$bili))\n\nfig2.7 <- ggplot(aes(x = bili, y = lp, linetype = effect), data = lin2row2) + \n  geom_line(size = 1) + \n  xlab(\"Bilirubin\") + \n  ylab(\"Linear predictor\") + \n  scale_linetype_discrete(\"Effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.7\n\n\n\n\n\n\n\n\n\nCode show/hide\nproc sort data=lin2; by bili; run;\nproc gplot data=lin2;\n    plot (lp4 lp3)*bili/overlay haxis=axis1 vaxis=axis2 legend=legend1;\n    axis1 order=0 to 500 by 100 minor=none label=('Se-bilirubin');\n    axis2 order=-5 to 2 by 1 minor=none label=(a=90 'Linear predictor');\n    symbol1 v=none i=join r=1 c=red;\n    symbol2 v=none i=join r=1 c=blue;\n    label lp4=\"Effect as linear spline\";\n    label lp3=\"Linear effect\";\nrun;quit;\n\n\n\n\n\n\n\nFigure 2.8\n\nRSAS\n\n\n\n\nCode show/hide\n# The below linear predictors include estimates from the following models\nbase_poismod2_log <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                           tment_char + alb + log2bili,\n                         data = pbc3mult, family = poisson)\npoismod_t26_l3 <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                        tment_char + alb + log2bili + \n                        logbilihigh + logbilitoohigh + logbilimuchtoohigh,\n                        data = pbc3mult, family = poisson)\n# Make a dataset with linear predictor information\nlog2 <- pbc3\nlog2$lp3 <- with(pbc3, -2.0162+0.6469*log2bili-38.7*0.087)\nlog2$lp4 <- with(pbc3, -0.6194+0.198*log2bili\n                 +0.8815*logbilihigh-0.2336*logbilitoohigh\n                 -0.3139*logbilimuchtoohigh-0.0844*38.7)\nlog2row <- data.frame(effect = c(rep(\"Linear effect\", nrow(log2)),\n                                 rep(\"Effect as linear spline\", nrow(log2))), \n                      lp = c(log2$lp3, log2$lp4),\n                      log2bili = c(log2$log2bili, log2$log2bili)\n                      )\n\nfig2.8 <- ggplot(aes(x = log2bili, y = lp, linetype = effect), data = log2row) + \n  geom_line(size = 1) + \n  xlab(expression(log[2] * \"(bilirubin)\")) +\n  ylab(\"Linear predictor\") + \n  scale_linetype_discrete(\"Effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.8\n\n\n\n\n\n\n\n\n\nCode show/hide\n* Linear predictors from the following models; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb log2bili / dist=poi offset=logrisk type3;\nrun;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb log2bili logbilihigh logbilitoohigh \n                 logbilimuchtoohigh / dist=poi offset=logrisk type3;\nrun;\n\n* Create data with linear predictors as a function of bilirubin values; \ndata log2; \n    set pbc3;\n    lp3=-2.0162+0.6469*log2bili-38.7*0.087;\n    lp4=-0.6194+0.198*log2bili+0.8815*logbilihigh-0.2336*logbilitoohigh\n        -0.3139*logbilimuchtoohigh-0.0844*38.7;\nrun; \nproc sort data=log2;by bili; run;\nproc gplot data=log2;\n    plot (lp4 lp3)*log2bili/overlay haxis=axis1 vaxis=axis2 legend=legend1;\n    axis1 order=1 to 9 by 1 minor=none label=('log2(Se-bilirubin)');\n    axis2 order=-5 to 1 by 1 minor=none label=(a=90 'Linear predictor');\n    symbol1 v=none i=join r=1 c=red;\n    symbol2 v=none i=join r=1 c=blue;\n    label lp4=\"Effect as linear spline\";\n    label lp3=\"Linear effect\";\nrun;quit;\n\n\n\n\n\n\n\nTable 2.7\n\nRSAS\n\n\n\n\nCode show/hide\n# Cox model\ncoxmod_t27 <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                    eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t27\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili, \n    data = pbc3, method = \"breslow\", eps = 1e-08)\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.57406   0.56323  0.22447 -2.557   0.0105\nalb      -0.09093   0.91308  0.02164 -4.201 2.65e-05\nlog2bili  0.66500   1.94449  0.07443  8.935  < 2e-16\n\nLikelihood ratio test=120  on 3 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\n# Poisson model\npoismod_t27 <- glm(fail ~ tment + alb + log2bili + timegroup + \n                     offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t27) \n\n\n# A tibble: 6 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.48      0.976     -7.66  1.81e-14\n2 tment        -0.545     0.223     -2.45  1.43e- 2\n3 alb          -0.0870    0.0216    -4.02  5.73e- 5\n4 log2bili      0.647     0.0733     8.83  1.04e-18\n5 timegroup3   -0.439     0.603     -0.727 4.67e- 1\n6 timegroup1   -0.844     0.229     -3.69  2.23e- 4\n\n\n\n\n\n\nCode show/hide\n* Cox model; \nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili / rl;\nrun;\n* Poisson model;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb log2bili / dist=poi offset=logrisk;\nrun;\n\n\n\n\n\n\n\nTable 2.8\n\nRSAS\n\n\n\n\nCode show/hide\n# Cox models\n# Model for LR comparison\ncoxmod_t28_base <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\n# Cox model 1\npbc3$alb0 <- (pbc3$tment==0)*pbc3$alb\npbc3$alb1 <- (pbc3$tment==1)*pbc3$alb\ncoxmod_t28_1 <- coxph(Surv(days, status != 0) ~ tment + alb0 + alb1 + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t28_1\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb0 + alb1 + \n    log2bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n              coef exp(coef)  se(coef)      z        p\ntment    -0.009736  0.990312  1.559670 -0.006 0.995020\nalb0     -0.081319  0.921900  0.034031 -2.390 0.016869\nalb1     -0.097043  0.907517  0.027344 -3.549 0.000387\nlog2bili  0.664413  1.943350  0.074494  8.919  < 2e-16\n\nLikelihood ratio test=120.2  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\nlrtest(coxmod_t28_1, coxmod_t28_base)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb0 + alb1 + log2bili\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -402.87                     \n2   3 -402.94 -1 0.1338     0.7145\n\n\nCode show/hide\n# Cox model 2\npbc3$bili0 <- (pbc3$tment==0)*pbc3$log2bili\npbc3$bili1 <- (pbc3$tment==1)*pbc3$log2bili\ncoxmod_t28_2 <- coxph(Surv(days, status != 0) ~ tment + alb + bili0 + bili1,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t28_2\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili0 + \n    bili1, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n          coef exp(coef) se(coef)      z        p\ntment  0.19880   1.21994  0.85653  0.232    0.816\nalb   -0.09331   0.91091  0.02191 -4.260 2.05e-05\nbili0  0.72558   2.06593  0.09865  7.355 1.91e-13\nbili1  0.59345   1.81022  0.10604  5.596 2.19e-08\n\nLikelihood ratio test=120.9  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\nlrtest(coxmod_t28_2, coxmod_t28_base)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + bili0 + bili1\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -402.51                     \n2   3 -402.94 -1 0.8644     0.3525\n\n\nCode show/hide\n# Poisson models\n# Model for LR comparison - no interaction\npoismod_t28_base <- glm(fail ~ timegroup + tment + alb + log2bili+\n                          offset(log(risktime)), data=pbc3mult, family=poisson)\n\n# Poisson model 1\npbc3mult$alb0 <- (pbc3mult$tment==0)*pbc3mult$alb\npbc3mult$alb1 <- (pbc3mult$tment==1)*pbc3mult$alb\npoismod_t28_1 <- glm(fail ~ tment + alb0 + alb1 + log2bili + timegroup +\n                       offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t28_1) \n\n\n# A tibble: 7 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.87      1.36     -5.78   7.54e- 9\n2 tment         0.0920    1.55      0.0593 9.53e- 1\n3 alb0         -0.0763    0.0336   -2.27   2.32e- 2\n4 alb1         -0.0941    0.0275   -3.41   6.39e- 4\n5 log2bili      0.646     0.0733    8.81   1.23e-18\n6 timegroup3   -0.431     0.604    -0.714  4.75e- 1\n7 timegroup1   -0.844     0.229    -3.69   2.20e- 4\n\n\nCode show/hide\nlrtest(poismod_t28_base, poismod_t28_1)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\nModel 2: fail ~ tment + alb0 + alb1 + log2bili + timegroup + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   7 -252.54  1 0.1723      0.678\n\n\nCode show/hide\n# Poisson model 2\npbc3mult$bili0 <- (pbc3mult$tment==0)*pbc3mult$log2bili\npbc3mult$bili1 <- (pbc3mult$tment==1)*pbc3mult$log2bili\npoismod_t28_2 <- glm(fail ~ tment + alb + bili0 + bili1 + timegroup +\n                       offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t28_2) \n\n\n# A tibble: 7 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.72      1.02      -7.59  3.10e-14\n2 tment         0.181     0.848      0.213 8.31e- 1\n3 alb          -0.0891    0.0218    -4.08  4.54e- 5\n4 bili0         0.704     0.0972     7.24  4.42e-13\n5 bili1         0.580     0.105      5.54  3.08e- 8\n6 timegroup3   -0.417     0.604     -0.691 4.90e- 1\n7 timegroup1   -0.857     0.229     -3.74  1.86e- 4\n\n\nCode show/hide\nlrtest(poismod_t28_base, poismod_t28_2)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\nModel 2: fail ~ tment + alb + bili0 + bili1 + timegroup + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   7 -252.24  1 0.7787     0.3775\n\n\n\n\n\n\nCode show/hide\n* Cox model 1; \nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb tment*alb log2bili /rl type3 (LR);\n    estimate 'alb, tment=0' alb 1;\n    estimate 'alb, tment=1' alb 1 tment*alb 1;\nrun;\n* Cox model 2; \nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili tment*log2bili/rl  type3 (LR);\n    estimate 'log2bili, tment=0' log2bili 1;\n    estimate 'log2bili, tment=1' log2bili 1 tment*log2bili 1;\nrun;\n\n* Poisson model 1; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment log2bili alb(tment) / dist=poi offset=logrisk type3;\n    contrast 'LRT' alb(tment) 1 -1;\nrun;\n* Poisson model 2; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb log2bili(tment)/ dist=poi offset=logrisk type3;\n    contrast 'LRT' log2bili(tment) 1 -1;\nrun;\n\n\n\n\n\n\n\nTable 2.9\n\nRSAS\n\n\n\n\nCode show/hide\npbc3mult$tment1 <- (pbc3mult$timegroup==1)*pbc3mult$tment\npbc3mult$tment2 <- (pbc3mult$timegroup==2)*pbc3mult$tment\npbc3mult$tment3 <- (pbc3mult$timegroup==3)*pbc3mult$tment\npbc3mult$alb1 <- (pbc3mult$timegroup==1)*pbc3mult$alb\npbc3mult$alb2 <- (pbc3mult$timegroup==2)*pbc3mult$alb\npbc3mult$alb3 <- (pbc3mult$timegroup==3)*pbc3mult$alb\npbc3mult$bili1 <- (pbc3mult$timegroup==1)*pbc3mult$log2bili\npbc3mult$bili2 <- (pbc3mult$timegroup==2)*pbc3mult$log2bili\npbc3mult$bili3 <- (pbc3mult$timegroup==3)*pbc3mult$log2bili\n\noptions(contrasts=c(\"contr.treatment\", \"contr.poly\"))\npoismod_t29_base <- glm(fail~tment+alb+log2bili+timegroup+offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\n\n# Treatment\npoismod_t29_tment <- glm(fail ~ tment1 + tment2 + tment3 + alb + log2bili+\n                       timegroup + offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\ntidy(poismod_t29_tment) \n\n\n# A tibble: 8 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.65      1.17      -6.53  6.43e-11\n2 tment1       -0.562     0.291     -1.93  5.35e- 2\n3 tment2       -0.462     0.345     -1.34  1.80e- 1\n4 tment3       -1.27      1.23      -1.03  3.03e- 1\n5 alb          -0.0864    0.0217    -3.99  6.65e- 5\n6 log2bili      0.649     0.0737     8.81  1.30e-18\n7 timegroup1   -0.699     0.745     -0.938 3.48e- 1\n8 timegroup2    0.0954    0.750      0.127 8.99e- 1\n\n\nCode show/hide\nlrtest(poismod_t29_base, poismod_t29_tment)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ tment + alb + log2bili + timegroup + offset(log(risktime))\nModel 2: fail ~ tment1 + tment2 + tment3 + alb + log2bili + timegroup + \n    offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   8 -252.41  2 0.4312     0.8061\n\n\nCode show/hide\n# Albumin\npoismod_t29_alb <- glm(fail ~ tment + alb1 + alb2 + alb3 + log2bili+\n                       timegroup + offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\ntidy(poismod_t29_alb) \n\n\n# A tibble: 8 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -8.73      5.94    -1.47    1.42e- 1\n2 tment        -0.561     0.223   -2.52    1.18e- 2\n3 alb1         -0.110     0.0279  -3.95    7.79e- 5\n4 alb2         -0.0523    0.0347  -1.51    1.32e- 1\n5 alb3         -0.0654    0.153   -0.427   6.70e- 1\n6 log2bili      0.646     0.0736   8.78    1.68e-18\n7 timegroup1    1.23      6.03     0.203   8.39e- 1\n8 timegroup2   -0.0143    6.09    -0.00235 9.98e- 1\n\n\nCode show/hide\nlrtest(poismod_t29_base, poismod_t29_alb)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ tment + alb + log2bili + timegroup + offset(log(risktime))\nModel 2: fail ~ tment + alb1 + alb2 + alb3 + log2bili + timegroup + offset(log(risktime))\n  #Df  LogLik Df Chisq Pr(>Chisq)\n1   6 -252.62                    \n2   8 -251.72  2 1.803      0.406\n\n\nCode show/hide\n# Bilirubin\npoismod_t29_bili <- glm(fail ~ tment + alb + bili1 + bili2 + bili3 +\n                       timegroup + offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\ntidy(poismod_t29_bili) \n\n\n# A tibble: 8 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -6.36      2.36      -2.69  7.05e- 3\n2 tment        -0.515     0.224     -2.30  2.15e- 2\n3 alb          -0.0857    0.0217    -3.94  8.10e- 5\n4 bili1         0.710     0.0926     7.67  1.69e-14\n5 bili2         0.557     0.121      4.60  4.18e- 6\n6 bili3         0.305     0.482      0.633 5.26e- 1\n7 timegroup1   -2.42      2.31      -1.05  2.95e- 1\n8 timegroup2   -0.696     2.32      -0.300 7.64e- 1\n\n\nCode show/hide\nlrtest(poismod_t29_base, poismod_t29_bili)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ tment + alb + log2bili + timegroup + offset(log(risktime))\nModel 2: fail ~ tment + alb + bili1 + bili2 + bili3 + timegroup + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   8 -251.84  2 1.5777     0.4544\n\n\n\n\n\n\nCode show/hide\n* Treatment; \n* Estimates ;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv(ref='1');\n    model fail= interv tment(interv) alb log2bili/ dist=poi offset=logrisk type3;\nrun;\n* LRT ;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv(ref='1');\n    model fail= interv tment interv*tment alb log2bili/ dist=poi offset=logrisk type3;\nrun;\n\n* Albumin;\n* Estimates ;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv(ref='1');\n    model fail= interv tment log2bili alb(interv) / dist=poi offset=logrisk type3;\nrun;\n* LRT ;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv(ref='1');\n    model fail= interv tment alb log2bili alb*interv/ dist=poi offset=logrisk type3;\nrun;\n\n* Bilirubin;\n* Estimates ;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv(ref='1');\n    model fail= interv tment alb log2bili(interv)/ dist=poi offset=logrisk type3;\nrun;\n* LRT ;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv(ref='1');\n    model fail= interv tment alb log2bili log2bili*interv/ dist=poi offset=logrisk type3;\nrun;\n\n\n\n\n\n\n\nIn-text: stratified Cox model\n\nRSAS\n\n\n\n\nCode show/hide\ncoxmod_f29 <- coxph(Surv(days, status != 0) ~ strata(tment) + alb + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_f29\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ strata(tment) + alb + \n    log2bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n             coef exp(coef) se(coef)      z        p\nalb      -0.09002   0.91391  0.02168 -4.153 3.28e-05\nlog2bili  0.66328   1.94114  0.07531  8.807  < 2e-16\n\nLikelihood ratio test=119.3  on 2 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\n\n\n\n\nCode show/hide\nproc phreg data=pbc3;\n    model days*status(0)= alb log2bili / rl;\n    strata tment;\nrun;\n\n\n\n\n\n\n\nFigure 2.10\n\nRSAS\n\n\n\n\nCode show/hide\n# Extracting cumulative baseline hazards per treatment\ncumhaz_treat <- basehaz(coxmod_f29, centered = FALSE)\ncumhaz_treat <- as.data.frame(cumhaz_treat)\n# Per treatment\nhazard_t0 <- cumhaz_treat[cumhaz_treat$strata == \"tment=0\",]\nhazard_t0[1,] <- c(0, 0, \"tment=0\")\nhazard_t0$time<- as.numeric(hazard_t0$time)\nhazard_t0$hazard <- as.numeric(hazard_t0$hazard)\nhazard_t1 <- cumhaz_treat[cumhaz_treat$strata == \"tment=1\",]\n# Match times\nalltimes <- sort(unique(cumhaz_treat$time))\nhazard_t0_allt <- as.numeric(sapply(1:length(alltimes),function(k) \n  tail(hazard_t0$hazard[hazard_t0$time <= alltimes[k]], 1)))\nhazard_t1_allt <- as.numeric(sapply(1:length(alltimes), function(k)\n  tail(hazard_t1$hazard[hazard_t1$time <= alltimes[k]], 1))) \nhazards <- data.frame(hazard_t0_allt, hazard_t1_allt)\n# Extract coefficient\ncoxmod_f29_t <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\n# Make plot\nlibrary(ggplot2)\nfig2.10 <- ggplot(aes(x = hazard_t0_allt, y = hazard_t1_allt), data = hazards) + \n  geom_step(linewidth = 1) + \n  geom_abline(intercept = 0, slope = exp(coef(coxmod_f29_t)[[\"tment\"]]), \n              linetype = \"dashed\", size = 1) + \n  xlab(\"Cumulative baseline hazard: placebo\") +\n  ylab(\"Cumulative baseline hazard: CyA\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.10\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata covstr;\n    alb=0; log2bili=0;\nrun;\nproc phreg data=pbc3;\n    model days*status(0)= alb log2bili/rl;\n    strata tment;\n    baseline out=breslowstr cumhaz=breslow covariates=covstr;\nrun;\ndata breslow0;\n    set breslowstr; \n    if tment=0; \n  a00=breslow; \nrun;\ndata breslow1; \n    set breslowstr; \n    if tment=1;     \n    a01=breslow; \nrun;\ndata breslow01; \n    merge breslow0 breslow1; \n    by days; \nrun;\ndata breslowrev; \n  set breslow01;\n    by days;\n    retain last1 last2;\n    if a00=. then cumhaz0=last1; if a00 ne . then cumhaz0=a00; \n    if a01=. then cumhaz1=last2; if a01 ne . then cumhaz1=a01;\n    output;\n    last1=cumhaz0; last2=cumhaz1; \nrun;\ndata breslowrev; \n    set breslowrev;\n    line=exp(-0.574)*cumhaz0;\nrun;\nproc gplot data=breslowrev;\n    plot cumhaz1*cumhaz0 line*cumhaz0/haxis=axis1 vaxis=axis2 overlay;\n    axis1 order=0 to 1.5 by 0.5 minor=none label=('Cumulative baseline hazard: placebo');\n    axis2 order=0 to 1 by 0.5 minor=none label=(a=90 'Cumulative baseline hazard: CyA');\n    symbol1  v=none i=stepjl c=red;\n    symbol2  v=none i=rl c=blue;\nrun;\nquit;\n\n\n\n\n\n\n\nFigure 2.11\n\nR\n\n\n\n\nCode show/hide\n# Additive Aalen models - available with timereg\nlibrary(timereg)\nnonparmod <- aalen(Surv(days, status != 0) ~ tment, data = pbc3)\nsummary(nonparmod)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          5.96               0.000\ntment                                1.60               0.714\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.107                       0.565\ntment                               0.136                       0.648\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                          7.62                       0.444\ntment                                4.54                       0.730\n\n   \n   \n  Call: \naalen(formula = Surv(days, status != 0) ~ tment, data = pbc3)\n\n\nCode show/hide\ncumhazdata <- data.frame(eventtimes = nonparmod$cum[,1],\n                         basecumhaz = nonparmod$cum[,2], \n                         cumhaztreat = nonparmod$cum[,3], \n                         cumhaztreat_ll = nonparmod$cum[,3]\n                                          -1.96*sqrt(nonparmod$var.cum[,3]),\n                         cumhaztreat_ul = nonparmod$cum[,3]\n                                          +1.96*sqrt(nonparmod$var.cum[,3]))\n# Extend lines to last observed time\ncumhazdata[nrow(cumhazdata)+1,] <- c(max(pbc3$days), tail(cumhazdata, 1)[-1])\n\n# Left figure\nfig2.11.left <- ggplot(aes(x = eventtimes / 365.25, y = basecumhaz), \n                       data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative baseline hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6),breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.11.left\n\n\n\n\n\nCode show/hide\n# Right figure\nfig2.11.right <- ggplot(aes(x = eventtimes / 365.25, y = cumhaztreat), \n                        data = cumhazdata) + \n  geom_step(size = 1) + \n  geom_step(size = 1, aes(x = eventtimes / 365.25, y = cumhaztreat_ll), \n            linetype = \"dashed\") +  \n  geom_step(size = 1, aes(x = eventtimes / 365.25, y = cumhaztreat_ul), \n            linetype = \"dashed\") +\n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative treatment effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.11.right\n\n\n\n\n\n\n\n\n\n\nFigure 2.12\n\nR\n\n\n\n\nCode show/hide\n# Make Aalen model fit\nlibrary(timereg)\nnonparmod2 <- aalen(Surv(days, status != 0) ~ tment + alb + bili, data = pbc3) \ncumhazdata <- data.frame(eventtimes = nonparmod2$cum[,1],\n                         basecumhaz = nonparmod2$cum[,2], \n                         cumhaztreat = nonparmod2$cum[,3], \n                         cumhazalb = nonparmod2$cum[,4], \n                         cumhazbili= nonparmod2$cum[,5])\n# Extend lines to last observed time\ncumhazdata[nrow(cumhazdata)+1,] <- c(max(pbc3$days), tail(cumhazdata, 1)[-1])\n\n# Figure treatment\nfig2.12.1 <- ggplot(aes(x = eventtimes / 365.25, y = cumhaztreat), \n                    data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative treatment effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\n# Figure albumin\nfig2.12.2 <- ggplot(aes(x = eventtimes / 365.25, y = cumhazalb), \n                    data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative albumin effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\n# Figure bilirubin\nfig2.12.3 <- ggplot(aes(x = eventtimes / 365.25, y = cumhazbili), \n                    data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative bilirubin effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)),\n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.12.1\n\n\n\n\n\nCode show/hide\nfig2.12.2\n\n\n\n\n\nCode show/hide\nfig2.12.3\n\n\n\n\n\n\n\n\n\n\nTable 2.10\n\nRSAS\n\n\n\n\nCode show/hide\n#------------------------------------------------------------------#\n# Table 2.10 and in-text results\n#------------------------------------------------------------------#\n\n# Additive model treatment only\n# p-values not exactly as in book because seed changes\nnonparmod0 <- aalen(Surv(days, status != 0) ~ tment, data = pbc3) \nsummary(nonparmod0)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          5.96               0.000\ntment                                1.60               0.736\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.107                       0.571\ntment                               0.136                       0.649\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                          7.62                       0.434\ntment                                4.54                       0.741\n\n   \n   \n  Call: \naalen(formula = Surv(days, status != 0) ~ tment, data = pbc3)\n\n\nCode show/hide\n# Constant effect of treatment per year\nnonparmod01 <- aalen(Surv(days/365.25, status != 0) ~ const(tment), data = pbc3) \nsummary(nonparmod01)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          6.62                   0\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                        0.0914                       0.406\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0136                       0.276\n\nParametric terms :     \n                Coef.    SE Robust SE     z P-val lower2.5% upper97.5%\nconst(tment) -0.00587 0.021     0.021 -0.28 0.779    -0.047     0.0353\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment), \n    data = pbc3)\n\n\nCode show/hide\n# Additive model with treatment, albumin, bilirubin\n# Table 2.10, first two columns\n# p-values not exactly as in book because seed changes\nnonparmod1 <- aalen(Surv(days, status != 0) ~ tment + alb + bili, data = pbc3) \nsummary(nonparmod1)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          3.62               0.007\ntment                                2.66               0.128\nalb                                  3.82               0.005\nbili                                 4.83               0.000\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                       0.30300                       0.942\ntment                             0.12100                       0.705\nalb                               0.00666                       0.963\nbili                              0.00301                       0.175\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                      14.20000                       0.992\ntment                             3.29000                       0.797\nalb                               0.00826                       0.991\nbili                              0.00203                       0.316\n\n   \n   \n  Call: \naalen(formula = Surv(days, status != 0) ~ tment + alb + bili, \n    data = pbc3)\n\n\nCode show/hide\n# Constant effects per year\n# Table 2.10, last columns\nnonparmod2 <- aalen(Surv(days/365.25, status != 0) ~ \n                      const(tment) + const(alb) + const(bili), data = pbc3) \nsummary(nonparmod2)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          4.03               0.001\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.119                       0.179\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0263                       0.114\n\nParametric terms :     \n                Coef.       SE Robust SE     z    P-val lower2.5% upper97.5%\nconst(tment) -0.04130 0.021600  0.020100 -2.05 4.02e-02  -0.08360    0.00104\nconst(alb)   -0.00842 0.002290  0.002230 -3.77 1.63e-04  -0.01290   -0.00393\nconst(bili)   0.00230 0.000483  0.000384  5.98 2.17e-09   0.00135    0.00325\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    const(alb) + const(bili), data = pbc3)\n\n\nCode show/hide\n# In-text\n# Constant effect of treatment, adjusted for albumin and bilirubin\nnonparmod3 <- aalen(Surv(days/365.25, status != 0) ~ \n                      const(tment) + alb + bili, data = pbc3) \nsummary(nonparmod3)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          3.60               0.002\nalb                                  3.80               0.001\nbili                                 4.83               0.000\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                       0.28500                       0.949\nalb                               0.00954                       0.826\nbili                              0.00315                       0.161\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                      3.16e-02                       0.995\nalb                              5.26e-05                       0.919\nbili                             6.52e-06                       0.281\n\nParametric terms :     \n               Coef.     SE Robust SE     z P-val lower2.5% upper97.5%\nconst(tment) -0.0401 0.0216    0.0204 -1.97 0.049   -0.0824    0.00224\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    alb + bili, data = pbc3)\n\n\nCode show/hide\n# Quadratic effect for albumin; p-values not exactly as in book because seed changes\nnonparmod44 <- aalen(Surv(days/365.25, status != 0) ~ const(tment)\n                       + I(alb/10) + I(bili/100) + I((alb/10)^2), data = pbc3) \nsummary(nonparmod44)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n              Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                            3.23               0.019\nI(alb/10)                              3.00               0.039\nI(bili/100)                            4.88               0.000\nI((alb/10)^2)                          2.77               0.084\n\nTest for time invariant effects \n                    Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                           9.420                       0.250\nI(alb/10)                             4.950                       0.255\nI(bili/100)                           0.365                       0.071\nI((alb/10)^2)                         0.635                       0.258\n                      Cramer von Mises test p-value H_0:constant effect\n(Intercept)                         83.6000                       0.367\nI(alb/10)                           24.4000                       0.355\nI(bili/100)                          0.0949                       0.179\nI((alb/10)^2)                        0.4160                       0.350\n\nParametric terms :     \n               Coef.     SE Robust SE     z  P-val lower2.5% upper97.5%\nconst(tment) -0.0421 0.0215    0.0201 -2.09 0.0366   -0.0842   3.92e-05\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    I(alb/10) + I(bili/100) + I((alb/10)^2), data = pbc3)\n\n\nCode show/hide\n# Quadratic effect for bilirubin; p-values not exactly as in book as seed changes\nnonparmod43 <- aalen(Surv(days/365.25, status != 0) ~ const(tment)\n                       + I(alb/10) + I(bili/100) + I((bili/100)^2), data = pbc3) \nsummary(nonparmod43)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n                Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                              3.82               0.001\nI(alb/10)                                4.02               0.001\nI(bili/100)                              3.85               0.001\nI((bili/100)^2)                          3.01               0.046\n\nTest for time invariant effects \n                      Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                             0.440                       0.674\nI(alb/10)                               0.117                       0.621\nI(bili/100)                             0.612                       0.446\nI((bili/100)^2)                         0.515                       0.162\n                        Cramer von Mises test p-value H_0:constant effect\n(Intercept)                            0.1320                       0.742\nI(alb/10)                              0.0124                       0.609\nI(bili/100)                            0.4640                       0.326\nI((bili/100)^2)                        0.2880                       0.166\n\nParametric terms :     \n               Coef.     SE Robust SE     z  P-val lower2.5% upper97.5%\nconst(tment) -0.0395 0.0213    0.0208 -1.89 0.0582   -0.0812    0.00225\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    I(alb/10) + I(bili/100) + I((bili/100)^2), data = pbc3)\n\n\nCode show/hide\n# Interactions\nnonparmod51 <- aalen(Surv(days/365.25, status != 0) ~ const(tment) + const(alb)\n                     + const(bili) + const(tment * bili),data = pbc3) \nsummary(nonparmod51)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          4.03                   0\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.123                       0.198\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0287                       0.125\n\nParametric terms :     \n                       Coef.       SE Robust SE       z    P-val lower2.5%\nconst(tment)        -0.00194 0.029400  0.022800 -0.0851 9.32e-01  -0.05960\nconst(alb)          -0.00859 0.002260  0.002200 -3.9000 9.69e-05  -0.01300\nconst(bili)          0.00299 0.000869  0.000437  6.8400 7.77e-12   0.00129\nconst(tment * bili) -0.00116 0.001020  0.000658 -1.7600 7.92e-02  -0.00316\n                    upper97.5%\nconst(tment)          0.055700\nconst(alb)           -0.004160\nconst(bili)           0.004690\nconst(tment * bili)   0.000839\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    const(alb) + const(bili) + const(tment * bili), data = pbc3)\n\n\nCode show/hide\nnonparmod52 <- aalen(Surv(days/365.25, status != 0) ~ const(tment) + const(bili) \n                     + const(alb) + const(tment * alb), data = pbc3) \nsummary(nonparmod52)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          3.06               0.004\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                          0.12                        0.18\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0265                       0.116\n\nParametric terms :     \n                      Coef.       SE Robust SE       z    P-val lower2.5%\nconst(tment)        0.01010 0.199000  0.176000  0.0576 9.54e-01  -0.38000\nconst(bili)         0.00230 0.000482  0.000385  5.9600 2.45e-09   0.00136\nconst(alb)         -0.00771 0.003150  0.002780 -2.7700 5.54e-03  -0.01390\nconst(tment * alb) -0.00132 0.004790  0.004300 -0.3060 7.59e-01  -0.01070\n                   upper97.5%\nconst(tment)          0.40000\nconst(bili)           0.00324\nconst(alb)           -0.00154\nconst(tment * alb)    0.00807\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    const(bili) + const(alb) + const(tment * alb), data = pbc3)\n\n\n\n\n\n\nCode show/hide\n* Only constant effect per year possible;\n* Create new variables;\ndata pbc3add; \n    set pbc3mult;\n    time1=(interv=1)*risktime/365.25; \n    time2=(interv=2)*risktime/365.25; \n    time3=(interv=3)*risktime/365.25;\n    tment0=(tment=0)*risktime/365.25; \n    tment1=(tment=1)*risktime/365.25;\n    albny=(alb-35)*risktime/365.25;\n    biliny=(bili-50)*risktime/365.25;\nrun;\n\n* link=id;\n* Constant effect of treatment per year;\nproc genmod data=pbc3add;\n    model fail=time1 time2 time3 tment1/dist=poi link=id noint;\nrun;\n\n* Constant effects per year;\nproc genmod data=pbc3add;\n    model fail=time1 time2 time3 tment1 albny biliny/dist=poi link=id noint;\nrun;\n\n\n\n\n\n\n\nTable 2.11\n\nR\n\n\n\n\nCode show/hide\n#------------------------------------------------------------------#\n# Table 2.11 and in-text results\n#------------------------------------------------------------------#\n\n# Additive hazards model with piecewise constant baseline hazards\n# Model with only treatment as covariate\n# update data set\npbc3add <- pbc3mult\npbc3add$time1 <-  with(pbc3add, (timegroup == 1)*risktime/365.25)\npbc3add$time2 <-  with(pbc3add, (timegroup == 2)*risktime/365.25)\npbc3add$time3 <-  with(pbc3add, (timegroup == 3)*risktime/365.25)\npbc3add$tment0 <- with(pbc3add, (tment == 0)*risktime/365.25)\npbc3add$tment1 <- with(pbc3add, (tment == 1)*risktime/365.25)\npbc3add$albny <-  with(pbc3add, ((alb-35)/100)*risktime/365.25)\npbc3add$biliny <- with(pbc3add, ((bili-50)/1000)*risktime/365.25)\n\n# In-text\nadditive_pcw <- glm(fail ~ time1 + time2 + time3 + tment1 - 1,\n                    data = pbc3add, start = c(0.1, 0.1, 0.1, 0),\n                    family = poisson(link = \"identity\"))\ntidy(additive_pcw)\n\n\n# A tibble: 4 × 5\n  term   estimate std.error statistic      p.value\n  <chr>     <dbl>     <dbl>     <dbl>        <dbl>\n1 time1   0.0911     0.0164     5.55  0.0000000293\n2 time2   0.132      0.0241     5.46  0.0000000487\n3 time3   0.0937     0.0462     2.03  0.0423      \n4 tment1 -0.00726    0.0208    -0.350 0.726       \n\n\nCode show/hide\n# Table 2.11 - questionable fit\nadditive_pcw2.11 <- glm(fail ~ time1 + time2 + time3 + tment1 + albny + biliny -1,\n                    data = pbc3add, start = c(0.3, 0.35, 0.4, -0.05, -0.8, 2),\n                    family = poisson(link = \"identity\"))\ntidy(additive_pcw2.11)\n\n\n# A tibble: 6 × 5\n  term   estimate std.error statistic  p.value\n  <chr>     <dbl>     <dbl>     <dbl>    <dbl>\n1 time1    0.185     0.0213      8.67 4.46e-18\n2 time2    0.241     0.0258      9.32 1.21e-20\n3 time3    0.229     0.0544      4.22 2.48e- 5\n4 tment1  -0.0224    0.0173     -1.30 1.95e- 1\n5 albny   -0.436     0.128      -3.40 6.79e- 4\n6 biliny   2.22      0.408       5.45 4.98e- 8\n\n\nCode show/hide\nadditive_pcw2.11 <- glm(fail ~ time1 + time2 + time3 + tment1 + albny + biliny -1,\n                        data = pbc3add, start = c(0.3, 0.35, 0.4, -0.05, -0.8, 2.1),\n                        family = poisson(link = \"identity\"))\ntidy(additive_pcw2.11)\n\n\n# A tibble: 6 × 5\n  term   estimate std.error statistic  p.value\n  <chr>     <dbl>     <dbl>     <dbl>    <dbl>\n1 time1    0.186     0.0214      8.68 4.08e-18\n2 time2    0.242     0.0259      9.32 1.14e-20\n3 time3    0.231     0.0548      4.22 2.45e- 5\n4 tment1  -0.0223    0.0174     -1.28 2.00e- 1\n5 albny   -0.436     0.129      -3.37 7.63e- 4\n6 biliny   2.25      0.411       5.48 4.21e- 8\n\n\n\n\n\n\n\nTable 2.13\n\nR\n\n\n\n\nCode show/hide\n# Death without transplantation\ncoxph(Surv(days, status == 2) ~ tment + alb + log2bili + sex + age,\n           method = \"breslow\", data = pbc3)\n\n\nCall:\ncoxph(formula = Surv(days, status == 2) ~ tment + alb + log2bili + \n    sex + age, data = pbc3, method = \"breslow\")\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.42049   0.65672  0.26822 -1.568   0.1169\nalb      -0.06992   0.93247  0.02906 -2.406   0.0161\nlog2bili  0.69178   1.99726  0.09303  7.436 1.04e-13\nsex       0.48557   1.62510  0.31943  1.520   0.1285\nage       0.07335   1.07611  0.01621  4.524 6.06e-06\n\nLikelihood ratio test=98.71  on 5 df, p=< 2.2e-16\nn= 343, number of events= 60 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\n# Transplantation\ncoxph(Surv(days, status == 1) ~ tment + alb + log2bili + sex + age,\n           method = \"breslow\", data = pbc3) \n\n\nCall:\ncoxph(formula = Surv(days, status == 1) ~ tment + alb + log2bili + \n    sex + age, data = pbc3, method = \"breslow\")\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.67305   0.51015  0.41318 -1.629   0.1033\nalb      -0.09400   0.91029  0.03871 -2.428   0.0152\nlog2bili  0.83213   2.29820  0.14655  5.678 1.36e-08\nsex       0.20378   1.22602  0.56329  0.362   0.7175\nage      -0.04805   0.95309  0.02138 -2.247   0.0246\n\nLikelihood ratio test=64.95  on 5 df, p=1.15e-12\nn= 343, number of events= 28 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\n# Failure of medical treatment\ncoxph(Surv(days, status != 0) ~ tment + alb + log2bili + sex + age,\n           method = \"breslow\", data = pbc3)\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili + \n    sex + age, data = pbc3, method = \"breslow\")\n\n             coef exp(coef) se(coef)      z       p\ntment    -0.50964   0.60071  0.22339 -2.281 0.02252\nalb      -0.07136   0.93112  0.02293 -3.112 0.00186\nlog2bili  0.73778   2.09128  0.07768  9.497 < 2e-16\nsex       0.58536   1.79563  0.26738  2.189 0.02858\nage       0.03077   1.03125  0.01199  2.566 0.01029\n\nLikelihood ratio test=134.3  on 5 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)"
  },
  {
    "objectID": "Ch2.html#guinea-bissau-childhood-vaccination-study",
    "href": "Ch2.html#guinea-bissau-childhood-vaccination-study",
    "title": "2  Intuition for intensity models",
    "section": "Guinea-Bissau childhood vaccination study",
    "text": "Guinea-Bissau childhood vaccination study\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\nbissau <- data.frame(read.csv(\"data/bissau.csv\"))\nbissau$agem <- as.integer(bissau$age/30.44)\n\n\n\n\n\n\nCode show/hide\nproc import out=bissau\n    datafile=\"data/bissau.csv\"\n    dbms=csv replace;\nrun;\ndata bissau; \n    set bissau; \n    agem = int(age/30.44); * Age in months; \nrun;\n\n\n\n\n\n\n\nTable 2.12\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(survival)\n# Cox model in column 1\ncoxfit0 <- coxph(Surv(fuptime, dead) ~ bcg, \n                 data = bissau, method = \"breslow\")\ncoxfit0\n\n\nCall:\ncoxph(formula = Surv(fuptime, dead) ~ bcg, data = bissau, method = \"breslow\")\n\n       coef exp(coef) se(coef)      z      p\nbcg -0.2821    0.7542   0.1353 -2.085 0.0371\n\nLikelihood ratio test=4.28  on 1 df, p=0.03851\nn= 5274, number of events= 222 \n\n\nCode show/hide\n# Cox model in column 1\ncoxfit1 <- coxph(Surv(fuptime, dead) ~ bcg + agem, \n                 data = bissau, method = \"breslow\")\ncoxfit1\n\n\nCall:\ncoxph(formula = Surv(fuptime, dead) ~ bcg + agem, data = bissau, \n    method = \"breslow\")\n\n         coef exp(coef) se(coef)      z      p\nbcg  -0.35203   0.70326  0.14424 -2.441 0.0147\nagem  0.05376   1.05523  0.03856  1.394 0.1633\n\nLikelihood ratio test=6.21  on 2 df, p=0.04481\nn= 5274, number of events= 222 \n\n\nCode show/hide\n# Make age the time variable instead\nbissau$agein <- bissau$age/(365.24/12)\nbissau$ageout <- bissau$agein + bissau$fuptime/(365.24/12)\n\n# Cox model in column 2\n# option timefix=F aligns to SAS calculation\n# see vignette 'Roundoff error and tied times' for survival package\ncoxfit2 <- coxph(Surv(agein, ageout, dead) ~ bcg, \n                 data = bissau, method = \"breslow\",timefix=F)\ncoxfit2\n\n\nCall:\ncoxph(formula = Surv(agein, ageout, dead) ~ bcg, data = bissau, \n    method = \"breslow\", timefix = F)\n\n       coef exp(coef) se(coef)      z      p\nbcg -0.3558    0.7006   0.1407 -2.529 0.0114\n\nLikelihood ratio test=6.28  on 1 df, p=0.01218\nn= 5274, number of events= 222 \n\n\n\n\n\n\nCode show/hide\nproc phreg data=bissau;\n    model fuptime*dead(0)=bcg agem / rl;\nrun;\n\n* Make age the time variable instead;\ndata bissau; \n    set bissau;\n    agein=age/(365.24/12);\n    ageout=agein+fuptime/(365.24/12);\nrun;\n\n* Cox model fit - column 2; \nproc phreg data=bissau;\n    model ageout*dead(0)=bcg / entry=agein rl;\nrun;\n\n\n\n\n\n\n\nFigure 2.13\n\nRSAS\n\n\n\n\nCode show/hide\n# General plotting style \nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20),\n        legend.position = \"bottom\", \n        legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        legend.key.size = unit(2,\"line\")) \n\n\n# Extract cumulative baseline hazard for covariate pattern\ncovdata<-data.frame(rbind(c(bcg=0, agem=3)))\ncoxcumhaz <- basehaz(coxfit1, covdata)\n# Create figure\nfig2.13 <- ggplot(aes(x = time / (365.24/12), y = hazard), data = coxcumhaz) + \n  geom_step(size = 1) + \n  xlab(\"Follow-up time (months)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     breaks = seq(0, 7, by = 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general\n\nfig2.13\n\n\n\n\n\n\n\n\n\nCode show/hide\n* Cox model fit and get cumulative baseline hazard ; \nproc phreg data=bissau;\n    model fuptime*dead(0)=bcg agem/rl;\n    baseline out=hazfuptime covariates=cov1 cumhaz=basefup;\nrun;\ndata hazfuptime_months; \n    set hazfuptime; \n    fuptime_m = fuptime / (365.24/12); \nrun;\nproc gplot data=hazfuptime_months;\n    plot basefup*fuptime_m/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 7 by 1 minor=none\n    label=('Follow-up time (months)');\n    axis2 order=0 to 0.06 by 0.01 minor=none\n    label=(a=90 'Cumulative hazard');\n    symbol1 v=none i=stepjl c=blue;\nrun;\nquit;\n* or using proc sgplot;\nods graphics on;\nproc sgplot data=hazfuptime_months;\n  step x=fuptime_m y=basefup / justify=left;\n    xaxis grid values=(0 to 7 by 1);\n    yaxis grid values=(0 to 0.06 by 0.01);\n    label fuptime_m=\"Follow-up time (months)\";\n    label basefup=\"Cumulative hazard\";\nrun;\n\n\n\n\n\n\n\nFigure 2.14\n\nRSAS\n\n\n\n\nCode show/hide\n# Extract cumulative baseline hazard\ncoxcumhaz <- basehaz(coxfit2, centered = FALSE)\nfig2.14 <- ggplot(aes(x = time, y = hazard), data = coxcumhaz) + \n  geom_step(size = 1) + \n  xlab(\"Age (months)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     breaks = seq(0, 15, by = 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.1)), \n                     breaks = seq(0, 0.15, by = 0.05), \n                     labels = c(\"0\", \"0.05\", \"0.10\", \"0.15\")) +\n  theme_general\n\nfig2.14\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata cov2;\ninput bcg;\ndatalines;\n0\n;\nrun;\n* Cox model fit and get cumulative baseline hazard ; \nproc phreg data=bissau;\n    model ageout*dead(0)=bcg / entry=agein rl;\n    baseline out=hazage covariates=cov2 cumhaz=baseage;\nrun;\nproc gplot data=hazage;\n    plot baseage*ageout/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 15 by 5 minor=none\n        label=('Age (months)');\n    axis2 order=0 to 0.15 by 0.05 minor=none \n        label=(a=90 'Cumulative baseline hazard');\n    symbol1  v=none i=stepjl c=blue;\nrun;\nquit;"
  },
  {
    "objectID": "Ch2.html#recurrent-episodes-in-affective-disorders",
    "href": "Ch2.html#recurrent-episodes-in-affective-disorders",
    "title": "2  Intuition for intensity models",
    "section": "Recurrent episodes in affective disorders",
    "text": "Recurrent episodes in affective disorders\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\naffective <- data.frame(read.csv(\"data/affective.csv\"))\naffective$wait <- with(affective, stop - start)\n\n\n\n\n\n\nCode show/hide\nproc import out=affective\n    datafile=\"data/affective.csv\"\n    dbms=csv replace;\nrun;\ndata affective; \n    set affective; \n    wait = stop - start; \nrun; \n\n\n\n\n\n\n\nTable 2.14\n\nRSAS\n\n\n\n\nCode show/hide\n# Cox model for 1., 2., 3., 4. episode 'Markov': Column 1\nlibrary(survival)\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 1 & state == 0))\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 1 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.3552    1.4264   0.2500 1.421 0.155\n\nLikelihood ratio test=1.89  on 1 df, p=0.1692\nn= 116, number of events= 99 \n\n\nCode show/hide\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 2 & state == 0))\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 2 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.1890    1.2080   0.2604 0.726 0.468\n\nLikelihood ratio test=0.51  on 1 df, p=0.4751\nn= 91, number of events= 82 \n\n\nCode show/hide\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 3 & state == 0)) \n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 3 & state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)      z     p\nbip -0.1175    0.8891   0.3005 -0.391 0.696\n\nLikelihood ratio test=0.16  on 1 df, p=0.6936\nn= 74, number of events= 62 \n\n\nCode show/hide\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 4 & state == 0)) \n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 4 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z       p\nbip 1.1500    3.1581   0.3536 3.252 0.00114\n\nLikelihood ratio test=9.93  on 1 df, p=0.001623\nn= 56, number of events= 47 \n\n\nCode show/hide\n# Cox model for 1., 2., 3., 4. episode 'Gap time': Column 2\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 1 & state == 0)) \n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 1 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.3991    1.4905   0.2487 1.605 0.109\n\nLikelihood ratio test=2.39  on 1 df, p=0.1222\nn= 116, number of events= 99 \n\n\nCode show/hide\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                     data = subset(affective, episode == 2 & state == 0))\n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 2 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)    z     p\nbip 0.2165    1.2418   0.2579 0.84 0.401\n\nLikelihood ratio test=0.68  on 1 df, p=0.41\nn= 91, number of events= 82 \n\n\nCode show/hide\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                     data = subset(affective, episode == 3 & state == 0)) \n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 3 & state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)      z     p\nbip -0.1114    0.8946   0.2867 -0.389 0.698\n\nLikelihood ratio test=0.15  on 1 df, p=0.6953\nn= 74, number of events= 62 \n\n\nCode show/hide\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                     data = subset(affective, episode == 4 & state == 0)) \n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 4 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.5964    1.8155   0.3183 1.874 0.061\n\nLikelihood ratio test=3.31  on 1 df, p=0.06905\nn= 56, number of events= 47 \n\n\nCode show/hide\n# AG cox model, total time\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, state == 0))\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)     z        p\nbip 0.36593   1.44186  0.09448 3.873 0.000107\n\nLikelihood ratio test=14.24  on 1 df, p=0.0001612\nn= 626, number of events= 542 \n\n\nCode show/hide\n# AG cox model, gap time\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                   data = subset(affective, state == 0))\n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)     z     p\nbip 0.12555   1.13377  0.09445 1.329 0.184\n\nLikelihood ratio test=1.74  on 1 df, p=0.1875\nn= 626, number of events= 542 \n\n\nCode show/hide\n# PWP cox model, total time\ncoxph(Surv(start, stop, status == 1) ~ strata(episode) + bip, method = \"breslow\",\n                   data = subset(affective, state == 0)) \n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ strata(episode) + \n    bip, data = subset(affective, state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.2418    1.2736   0.1121 2.157 0.031\n\nLikelihood ratio test=4.54  on 1 df, p=0.03312\nn= 626, number of events= 542 \n\n\nCode show/hide\n# PWP cox model, gap time\ncoxph(Surv(wait, status == 1) ~ strata(episode) + bip, method = \"breslow\", \n                    data = subset(affective, state == 0)) \n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ strata(episode) + bip, \n    data = subset(affective, state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)     z     p\nbip 0.02781   1.02820  0.10040 0.277 0.782\n\nLikelihood ratio test=0.08  on 1 df, p=0.7821\nn= 626, number of events= 542 \n\n\n\n\n\n\nCode show/hide\nproc sort data=affective out=state0;\n  where state=0;\n  by state episode;\nrun;\n\n* Cox model for 1., 2., 3., 4. episode 'Markov': Column 1; \nproc phreg data=state0;\n  where episode<=4;\n    model stop*status (2 3)= bip / entry=start;\n    by episode;\nrun;\n\n* AG model, no past; \nproc phreg data=state0;\n    model stop*status (2 3)= bip / entry=start;\nrun;\n\n* PWP model; \nproc phreg data=state0; \n    model stop*status (2 3)= bip / entry=start;\n    strata episode;\nrun; \n\n* Cox model for 1., 2., 3., 4. episode 'Gap time': Column 2; \nproc phreg data=state0;\n  where episode<=4;\n    model wait*status (2 3)= bip;\n    by episode;\nrun;\n\n* AG gap time model; \nproc phreg data=state0;\n    model wait*status (2 3)= bip;\nrun;\n\n* PWP gap time model; \nproc phreg data=state0;\n    model wait*status (2 3)= bip;\n    strata episode;\nrun;"
  },
  {
    "objectID": "Ch2.html#leader-cardiovascular-trial-in-type-2-diabetes",
    "href": "Ch2.html#leader-cardiovascular-trial-in-type-2-diabetes",
    "title": "2  Intuition for intensity models",
    "section": "LEADER cardiovascular trial in type 2 diabetes",
    "text": "LEADER cardiovascular trial in type 2 diabetes\n\n\n\n\nRead data\n\nR\n\n\nAssume that the LEADER data set is loaded in data set leader.\n\n\nCode show/hide\n# One data set per recurrent endpoint type\nleader_mi <- subset(leader, type == \"recurrent_mi\")\nleader_3p <- subset(leader, type == \"recurrent_comb_str_mi_cvdth\")\n\n\n\n\n\n\n\nFigure 2.15\n\nR\n\n\n\n\nCode show/hide\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\",\n        legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        legend.key.size = unit(2,\"line\"),\n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\n# Nelson-Aalen estimate of the cumulative hazard of MI\nlibrary(survival)\nfit <- survfit(Surv(start, stop, status == 1) ~ treat, data = leader_mi,\n               id = id, ctype = 1)\n\nplotdata <- data.frame(cumhaz = fit$cumhaz, time = fit$time,\n                       treat = c(rep(\"Placebo\", fit$strata[[1]]),\n                                 rep(\"Liraglutide\", fit$strata[[2]])))\n\nfig2.15 <- ggplot(aes(x = time * 1 / (365.25 / 12), y = cumhaz), data = plotdata) +\n  geom_step(aes(linetype = treat), linewidth = 1) +\n  scale_linetype_discrete(\"Treatment\") +\n  ylab(\"Cumulative hazard\") +\n  xlab(\"Time since randomization (months)\") +\n  theme_bw() +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)),\n                     limits = c(0, 65), breaks = seq(0, 60, by = 12)) +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)),\n                     limits = c(0, 0.12), breaks = seq(0, 0.12, by = 0.02)) +\n  theme_general\n\nfig2.15\n\n\n\n\n\n\n\n\n\n\nTable 2.15\n\nR\n\n\n\n\nCode show/hide\n# Cox model first events\nlibrary(survival)\ncoxph(Surv(start, stop, status == 1) ~ treat,\n      data = subset(leader_mi, eventno == 1), method = \"breslow\",)\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ treat, data = subset(leader_mi, \n    eventno == 1), method = \"breslow\")\n\n          coef exp(coef) se(coef)      z      p\ntreat -0.15949   0.85258  0.07984 -1.998 0.0458\n\nLikelihood ratio test=4  on 1 df, p=0.04545\nn= 9340, number of events= 631 \n\n\nCode show/hide\n# AG Cox type\ncoxph(Surv(start, stop, status == 1) ~ treat, data = leader_mi,\n                   method = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ treat, data = leader_mi, \n    method = \"breslow\")\n\n          coef exp(coef) se(coef)      z      p\ntreat -0.16418   0.84859  0.07184 -2.285 0.0223\n\nLikelihood ratio test=5.24  on 1 df, p=0.02208\nn= 10120, number of events= 780 \n\n\nCode show/hide\n# AG model, piece-wise constant hazards\n# Calculating cuts -> 5\nalltimes <- seq(0,max(leader_mi$stop),length=99)\nFunctionIntervalM <- function(a,b) {\n  seq(from=min(a), to = max(a), by = (max(a)-min(a))/b)\n}\ncuts <- FunctionIntervalM(a = alltimes, b = 5)\ncut_data <- survSplit(Surv(start, stop, status == 1) ~ .,\n                      leader_mi,\n                      cut = cuts[-1],\n                      episode = \"timegroup\")\ncoxph(Surv(start, stop, event) ~ treat + strata(timegroup), data = cut_data)\n\n\nCall:\ncoxph(formula = Surv(start, stop, event) ~ treat + strata(timegroup), \n    data = cut_data)\n\n          coef exp(coef) se(coef)      z      p\ntreat -0.16418   0.84859  0.07184 -2.285 0.0223\n\nLikelihood ratio test=5.24  on 1 df, p=0.02207\nn= 39070, number of events= 780 \n\n\nCode show/hide\n# PWP 2nd event\ncoxph(Surv(start, stop, status == 1) ~ treat,\n                     method = \"breslow\", subset = (eventno == 2),\n                     data = leader_mi)\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ treat, data = leader_mi, \n    subset = (eventno == 2), method = \"breslow\")\n\n          coef exp(coef) se(coef)      z     p\ntreat -0.04662   0.95445  0.19686 -0.237 0.813\n\nLikelihood ratio test=0.06  on 1 df, p=0.8126\nn= 631, number of events= 105 \n\n\nCode show/hide\n# PWP 3rd event\ncoxph(Surv(start, stop, status == 1) ~ treat,\n                   method = \"breslow\", subset = (eventno == 3),\n                   data = leader_mi)\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ treat, data = leader_mi, \n    subset = (eventno == 3), method = \"breslow\")\n\n          coef exp(coef) se(coef)      z     p\ntreat -0.02328   0.97699  0.39979 -0.058 0.954\n\nLikelihood ratio test=0  on 1 df, p=0.9536\nn= 105, number of events= 27 \n\n\nCode show/hide\n# PWP 4th event\ncoxph(Surv(start, stop, status == 1) ~ treat,\n                   method = \"breslow\", subset = (eventno == 4),\n                   data = leader_mi)\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ treat, data = leader_mi, \n    subset = (eventno == 4), method = \"breslow\")\n\n        coef exp(coef) se(coef)     z     p\ntreat 0.6288    1.8753   0.7370 0.853 0.394\n\nLikelihood ratio test=0.75  on 1 df, p=0.3852\nn= 27, number of events= 9 \n\n\nCode show/hide\n# PWP 5th event\ncoxph(Surv(start, stop, status == 1) ~ treat,\n                   method = \"breslow\", subset = (eventno == 5),\n                   data = leader_mi)\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ treat, data = leader_mi, \n    subset = (eventno == 5), method = \"breslow\")\n\n         coef exp(coef) se(coef)      z     p\ntreat -0.4287    0.6514   1.2299 -0.349 0.727\n\nLikelihood ratio test=0.13  on 1 df, p=0.7221\nn= 9, number of events= 3 \n\n\nCode show/hide\n# PWP all\ncoxph(Surv(start, stop, status == 1) ~ treat + strata(eventno),\n                   method = \"breslow\",\n                   data = leader_mi)\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ treat + strata(eventno), \n    data = leader_mi, method = \"breslow\")\n\n          coef exp(coef) se(coef)      z      p\ntreat -0.13020   0.87792  0.07222 -1.803 0.0714\n\nLikelihood ratio test=3.26  on 1 df, p=0.07103\nn= 10120, number of events= 780"
  },
  {
    "objectID": "Ch2.html#exercises",
    "href": "Ch2.html#exercises",
    "title": "2  Intuition for intensity models",
    "section": "Exercises",
    "text": "Exercises\n\nExercise 2.1"
  },
  {
    "objectID": "Ch3.html#pbc3-trial-in-liver-cirrhosis",
    "href": "Ch3.html#pbc3-trial-in-liver-cirrhosis",
    "title": "3  Intensity models",
    "section": "PBC3 trial in liver cirrhosis",
    "text": "PBC3 trial in liver cirrhosis\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\npbc3 <- data.frame(read.csv(\"data/pbc3.csv\"))\npbc3$log2bili <- with(pbc3, log2(bili))\npbc3$years <- with(pbc3, days/365.25)\n\n\n\n\n\n\nCode show/hide\nproc import out=pbc3\n    datafile=\"data/pbc3.csv\"\n    dbms=csv replace;\nrun;\ndata pbc3; \n    set pbc3;\n    log2bili=log2(bili);\nrun;\n\n\n\n\n\n\n\nTable 3.11\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(survival)\n# Treatment \ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(tment), \n      data = pbc3, tt = function(x,t, ...) (x==1)*t, method = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(tment), data = pbc3, tt = function(x, t, ...) (x == 1) * \n    t, method = \"breslow\")\n\n              coef exp(coef) se(coef)      z        p\ntment     -0.65937   0.51718  0.40576 -1.625    0.104\nalb       -0.09136   0.91269  0.02167 -4.216 2.49e-05\nlog2bili   0.66299   1.94059  0.07478  8.866  < 2e-16\ntt(tment)  0.04497   1.04600  0.17811  0.253    0.801\n\nLikelihood ratio test=120.1  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(tment), \n      data = pbc3, tt = function(x,t, ...) (x==1)*log(t), method = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(tment), data = pbc3, tt = function(x, t, ...) (x == 1) * \n    log(t), method = \"breslow\")\n\n              coef exp(coef) se(coef)      z        p\ntment     -0.61330   0.54156  0.24327 -2.521   0.0117\nalb       -0.09152   0.91254  0.02163 -4.232 2.32e-05\nlog2bili   0.66214   1.93894  0.07462  8.873  < 2e-16\ntt(tment)  0.10834   1.11442  0.25424  0.426   0.6700\n\nLikelihood ratio test=120.2  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(tment), \n      data = pbc3, tt = function(x,t, ...) (x==1)*(t>2), method = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(tment), data = pbc3, tt = function(x, t, ...) (x == 1) * \n    (t > 2), method = \"breslow\")\n\n              coef exp(coef) se(coef)      z        p\ntment     -0.58773   0.55559  0.29228 -2.011   0.0443\nalb       -0.09104   0.91298  0.02168 -4.199 2.68e-05\nlog2bili   0.66456   1.94363  0.07466  8.901  < 2e-16\ntt(tment)  0.03169   1.03220  0.43384  0.073   0.9418\n\nLikelihood ratio test=120  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\n# Albumin \ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(alb), \n      data = pbc3, tt = function(x,t, ...) x*t, method = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(alb), data = pbc3, tt = function(x, t, ...) x * t, method = \"breslow\")\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.59080   0.55389  0.22472 -2.629 0.008562\nalb      -0.13296   0.87550  0.03998 -3.326 0.000882\nlog2bili  0.66405   1.94265  0.07476  8.882  < 2e-16\ntt(alb)   0.02317   1.02344  0.01854  1.250 0.211400\n\nLikelihood ratio test=121.6  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(alb), \n      data = pbc3, tt = function(x,t, ...) x*log(t), method = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(alb), data = pbc3, tt = function(x, t, ...) x * log(t), \n    method = \"breslow\")\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.58958   0.55456  0.22460 -2.625  0.00867\nalb      -0.10194   0.90308  0.02349 -4.341 1.42e-05\nlog2bili  0.66488   1.94425  0.07483  8.885  < 2e-16\ntt(alb)   0.03347   1.03404  0.02561  1.307  0.19120\n\nLikelihood ratio test=121.8  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(alb), \n      data = pbc3,  tt = function(x,t, ...) (x)*(t>2), method = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(alb), data = pbc3, tt = function(x, t, ...) (x) * (t > \n    2), method = \"breslow\")\n\n             coef exp(coef) se(coef)      z       p\ntment    -0.59037   0.55412  0.22472 -2.627 0.00861\nalb      -0.11369   0.89254  0.02779 -4.091 4.3e-05\nlog2bili  0.66488   1.94426  0.07470  8.901 < 2e-16\ntt(alb)   0.05674   1.05838  0.04330  1.310 0.19005\n\nLikelihood ratio test=121.8  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\n# Log2 bilirubin\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(log2bili), \n      data = pbc3, tt = function(x,t, ...) x*t, method = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(log2bili), data = pbc3, tt = function(x, t, ...) x * t, \n    method = \"breslow\")\n\n                 coef exp(coef) se(coef)      z        p\ntment        -0.54631   0.57908  0.22571 -2.420   0.0155\nalb          -0.09009   0.91385  0.02173 -4.147 3.37e-05\nlog2bili      0.77736   2.17571  0.13382  5.809 6.28e-09\ntt(log2bili) -0.06299   0.93895  0.06181 -1.019   0.3081\n\nLikelihood ratio test=121.1  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(log2bili), \n      data = pbc3, tt = function(x,t, ...) x*log(t), method = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(log2bili), data = pbc3, tt = function(x, t, ...) x * log(t), \n    method = \"breslow\")\n\n                 coef exp(coef) se(coef)      z        p\ntment        -0.55398   0.57466  0.22536 -2.458    0.014\nalb          -0.09050   0.91347  0.02170 -4.170 3.04e-05\nlog2bili      0.68779   1.98931  0.07968  8.632  < 2e-16\ntt(log2bili) -0.07701   0.92588  0.08780 -0.877    0.380\n\nLikelihood ratio test=120.8  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode show/hide\ncoxph(Surv(years, status != 0) ~ tment + alb + log2bili + tt(log2bili), \n      data = pbc3,  tt = function(x,t, ...) (x)*(t>2), method = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(years, status != 0) ~ tment + alb + log2bili + \n    tt(log2bili), data = pbc3, tt = function(x, t, ...) (x) * \n    (t > 2), method = \"breslow\")\n\n                 coef exp(coef) se(coef)      z        p\ntment        -0.54878   0.57765  0.22521 -2.437   0.0148\nalb          -0.09045   0.91352  0.02176 -4.157 3.22e-05\nlog2bili      0.73519   2.08587  0.09487  7.750 9.22e-15\ntt(log2bili) -0.18232   0.83334  0.14910 -1.223   0.2214\n\nLikelihood ratio test=121.5  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\n\n\n\n\nCode show/hide\n* Treatment; \nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili tmenttime/rl;\n    tmenttime=(tment=1)*days;\nrun;\n\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili tmentlogtime/rl;\n    tmentlogtime=(tment=1)*log(days);\nrun;\n\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili tmentt0/rl;\n    tmentt0=(tment=1)*(days>2*365.25);\nrun;\n\n* Log bilirubin;\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili bilitime/rl;\n    bilitime=log2bili*days;\nrun;\n\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili bililogtime/rl;\n    bililogtime=log2bili*log(days);\nrun;\n\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili bilit0/rl;\n    bilit0=log2bili*(days>2*365.25);\nrun;\n\n* Albumin; \nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili albtime/rl;\n    albtime=alb*days;\nrun;\n\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili alblogtime/rl;\n    alblogtime=alb*log(days);\nrun;\n\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili albt0/rl;\n    albt0=alb*(days>2*365.25);\nrun;"
  },
  {
    "objectID": "Ch3.html#guinea-bissau-childhood-vaccination-study",
    "href": "Ch3.html#guinea-bissau-childhood-vaccination-study",
    "title": "3  Intensity models",
    "section": "Guinea-Bissau childhood vaccination study",
    "text": "Guinea-Bissau childhood vaccination study\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\nbissau <- data.frame(read.csv(\"data/bissau.csv\"))\n# Variables for age as time scale and dtp binary\nbissau$agein  <- with(bissau, age/(365.24/12))\nbissau$ageout <- with(bissau, agein+fuptime/(365.24/12))\nbissau$dtpany <- 1*with(bissau, dtp>0)\n\n\n\n\n\n\nCode show/hide\nproc import \n    datafile=\"data/bissau.csv\" out=bissau\n    dbms = csv replace;\nrun;\ndata bissau; \n    set bissau;\n    agein=age/(365.24/12);\n    ageout=agein+fuptime/(365.24/12);\n    dtpany=(dtp>0);\nrun; \n\n\n\n\n\n\n\nTable 3.1\n\nRSAS\n\n\n\n\nCode show/hide\ntable(bissau$bcg, bissau$dtp)\n\n\n   \n       0    1    2    3\n  0 1942   19    9    3\n  1 1159 1299  582  261\n\n\nCode show/hide\n100*table(bissau$bcg, bissau$dtp) / rowSums(table(bissau$bcg, bissau$dtp))\n\n\n   \n             0          1          2          3\n  0 98.4287886  0.9630005  0.4561581  0.1520527\n  1 35.1105726 39.3517116 17.6310209  7.9066949\n\n\n\n\n\n\nCode show/hide\nproc freq data=bissau;\n    tables bcg*dtp bcg*dtpany/ nocol nopercent;\nrun;\n\n\n\n\n\n\n\nTable 3.2\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(survival)\ncoxph(Surv(agein,ageout,dead!=0)~bcg,data=bissau,method=\"breslow\",timefix=F)\n\n\nCall:\ncoxph(formula = Surv(agein, ageout, dead != 0) ~ bcg, data = bissau, \n    method = \"breslow\", timefix = F)\n\n       coef exp(coef) se(coef)      z      p\nbcg -0.3558    0.7006   0.1407 -2.529 0.0114\n\nLikelihood ratio test=6.28  on 1 df, p=0.01218\nn= 5274, number of events= 222 \n\n\nCode show/hide\ncoxph(Surv(agein,ageout,dead!=0)~dtpany,data=bissau,method=\"breslow\",timefix=F)\n\n\nCall:\ncoxph(formula = Surv(agein, ageout, dead != 0) ~ dtpany, data = bissau, \n    method = \"breslow\", timefix = F)\n\n           coef exp(coef) se(coef)      z     p\ndtpany -0.03855   0.96218  0.14904 -0.259 0.796\n\nLikelihood ratio test=0.07  on 1 df, p=0.7958\nn= 5274, number of events= 222 \n\n\nCode show/hide\ncoxph(Surv(agein,ageout,dead!=0)~bcg+dtpany,data=bissau,method=\"breslow\",timefix=F)\n\n\nCall:\ncoxph(formula = Surv(agein, ageout, dead != 0) ~ bcg + dtpany, \n    data = bissau, method = \"breslow\", timefix = F)\n\n          coef exp(coef) se(coef)      z      p\nbcg    -0.5585    0.5720   0.1924 -2.902 0.0037\ndtpany  0.3286    1.3890   0.2021  1.625 0.1041\n\nLikelihood ratio test=9.01  on 2 df, p=0.01106\nn= 5274, number of events= 222 \n\n\nCode show/hide\ncoxph(Surv(agein,ageout,dead!=0)~bcg*dtpany,data=bissau,method=\"breslow\",timefix=F)\n\n\nCall:\ncoxph(formula = Surv(agein, ageout, dead != 0) ~ bcg * dtpany, \n    data = bissau, method = \"breslow\", timefix = F)\n\n              coef exp(coef) se(coef)      z       p\nbcg        -0.5764    0.5619   0.2023 -2.849 0.00439\ndtpany      0.1252    1.1334   0.7178  0.174 0.86151\nbcg:dtpany  0.2212    1.2475   0.7429  0.298 0.76595\n\nLikelihood ratio test=9.1  on 3 df, p=0.02796\nn= 5274, number of events= 222 \n\n\n\n\n\n\nCode show/hide\nproc phreg data=bissau;\n    model ageout*dead(0) = bcg / entry=agein rl;\nrun;\nproc phreg data=bissau;\n    model ageout*dead(0) = dtpany / entry=agein rl;\nrun;\nproc phreg data=bissau;\n    model ageout*dead(0) = bcg dtpany / entry=agein rl;\nrun;\nproc phreg data=bissau;\n    model ageout*dead(0) = bcg dtpany bcg*dtpany / entry=agein rl;\nrun;"
  },
  {
    "objectID": "Ch3.html#testis-cancer-incidence-and-maternal-parity",
    "href": "Ch3.html#testis-cancer-incidence-and-maternal-parity",
    "title": "3  Intensity models",
    "section": "Testis cancer incidence and maternal parity",
    "text": "Testis cancer incidence and maternal parity\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\ntestis <- data.frame(read.csv(\"data/testis.csv\"))\n# Add extra variables\ntestis$lpyrs <- log(testis$pyrs)\ntestis$par2 <- as.numeric(testis$parity < 2)\n\n\n\n\n\n\nCode show/hide\nproc import out=testis\n    datafile=\"data/testis.csv\"\n    dbms=csv replace;\nrun;\ndata testis; \n    set testis; \n    lpyrs = log(pyrs); \n    par2 = (parity>=2); \nrun;\n\n\n\n\n\n\n\nFigure 3.1\n\nR\n\n\n\n\nCode show/hide\n# Data frames\ndf1 <- data.frame(x1 = 1900 + c(50, 58, 63, 68, 73), \n                  y1 = rep(0, 5), \n                  x2 = rep(2000, 5), \n                  y2 = 100 - c(50, 58, 63, 68, 73))\n\ndf2 <- data.frame(x1 = 1968.25 + c(0, 0, 0, 0, 73-68.25), \n                  y1 = c(68.25 - 50, 68.25 - 58, 68.25 - 63, 68.25 - 68, 0), \n                  x2 = rep(1993, 5), \n                  y2 = 100 - c(50, 58, 63, 68, 73) - 7)\n\ndf3 <- data.frame(x1 = c(1968.25, 1993, 1968.25, 1968.25, 1968.25 + 1.75, 1968.25 + 6.75, 1968.25 + 11.75), \n                  y1 = c(0, 0, 0, 15, 20, 25, 30), \n                  x2 = c(1968.25, 1993, 1993, 1993, 1993, 1993, 1993), \n                  y2 = c(68.25 - 50, 100 - 57, 0, 15, 20, 25, 30) \n                  )\n\n# For labels\nD <- tapply( testis$cases, list( testis$age, testis$cohort ), sum )\nY <- tapply( testis$pyrs, list( testis$age, testis$cohort ), sum )\nx <- outer( unique( testis$age )+c(17.5,rep(2.5,4)),\n            unique( testis$cohort )+2.5,\n            \"+\" )\nx[1,] <- x[1,]-c(0,3,3,3,2)\ny <- outer( c(13,17,22,27,32), rep(1,5), \"*\" )\n\nlabel_data <- data.frame(x = x[!is.na(Y)], \n                         y = y[!is.na(Y)], \n                         label = paste( round( Y/10^4 )[!is.na(Y)] )\n                         )\nlabel_data2 <- data.frame(x = 1956, y = 47.5, label = \"PY (10,000)\")\n\n# Create plot\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        text = element_text(size = 16), \n        axis.text.x = element_text(size = 16), \n        axis.text.y = element_text(size = 16))\n\nfig3.1 <- ggplot(df1) + \n  geom_vline(xintercept = c(1968.25, 1993),\n             size = 1, linetype = \"dotted\") +\n  geom_hline(yintercept = c(0, 15, 20, 25, 30),\n             size = 1, linetype = \"dotted\") +\n  geom_segment(aes(x = x1, y = y1, \n                   xend = x2, yend = y2), \n               data = df1,\n               size = 1, linetype = \"dotted\") + \n  geom_segment(aes(x = x1, y = y1, \n                   xend = x2, yend = y2), \n               data = df2,\n               size = 1.5) + \n  geom_segment(aes(x = x1, y = y1, \n                   xend = x2, yend = y2), \n               data = df3,\n               size = 1.5) + \n  theme_general + \n  xlab(\"Calendar time\") + \n  ylab(\"Age (years)\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.005)),\n                     limits = c(1950, 2000), \n                     breaks = seq(1950, 2000, 10)) +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.005)), \n                     limits = c(0, 50), \n                     breaks = seq(0, 50, 10)) + \n  geom_label(aes(x = x, y = y, label = label), size = 5, label.size = NA,\n             hjust = 1.1, vjust = 0.7, \n             data = label_data) + \n  theme(plot.margin=unit(c(0.75, 0.75, 0.75, 0.75), \"cm\"))\n\nfig3.1\n\n\n\n\n\n\n\n\n\n\nTable 3.5\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(broom)\nlibrary(lmtest)\n\n# Column 1\noptions(contrasts=c(\"contr.treatment\", \"contr.poly\"))\ntestis$age <- as.factor(testis$age)\ntestis$age <- relevel(testis$age, ref = '20')\nsummary(glm(cases ~ offset(lpyrs) + par2 + age, data = testis, family = poisson))\n\n\n\nCall:\nglm(formula = cases ~ offset(lpyrs) + par2 + age, family = poisson, \n    data = testis)\n\nCoefficients:\n            Estimate Std. Error  z value Pr(>|z|)    \n(Intercept) -9.04435    0.08393 -107.757  < 2e-16 ***\npar2         0.21663    0.08405    2.577  0.00996 ** \nage0        -4.03084    0.21105  -19.099  < 2e-16 ***\nage15       -1.17094    0.11886   -9.851  < 2e-16 ***\nage25        0.55962    0.09802    5.709 1.14e-08 ***\nage30        0.75263    0.13272    5.671 1.42e-08 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 1647.61  on 236  degrees of freedom\nResidual deviance:  201.07  on 231  degrees of freedom\nAIC: 540.84\n\nNumber of Fisher Scoring iterations: 5\n\n\nCode show/hide\n# Column 2\ntestis$motherage <- as.factor(testis$motherage)\ntestis$motherage <- relevel(testis$motherage, ref = \"30\")\ntestis$cohort <- as.factor(testis$cohort)\ntestis$cohort <- relevel(testis$cohort, ref = \"1973\")\nsummary(poisfull<-glm(cases ~ offset(lpyrs) + par2 + age + motherage + cohort, \n                      data = testis,family = poisson))\n\n\n\nCall:\nglm(formula = cases ~ offset(lpyrs) + par2 + age + motherage + \n    cohort, family = poisson, data = testis)\n\nCoefficients:\n            Estimate Std. Error z value Pr(>|z|)    \n(Intercept) -9.11684    0.29271 -31.146  < 2e-16 ***\npar2         0.22967    0.09112   2.521   0.0117 *  \nage0        -4.00398    0.23905 -16.749  < 2e-16 ***\nage15       -1.16652    0.12522  -9.316  < 2e-16 ***\nage25        0.61710    0.10445   5.908 3.46e-09 ***\nage30        0.95356    0.15378   6.201 5.62e-10 ***\nmotherage12  0.02926    0.24121   0.121   0.9034    \nmotherage20  0.05796    0.22233   0.261   0.7943    \nmotherage25 -0.11663    0.22510  -0.518   0.6044    \ncohort1950  -0.36275    0.28800  -1.260   0.2078    \ncohort1958  -0.08031    0.24838  -0.323   0.7464    \ncohort1963   0.12346    0.23712   0.521   0.6026    \ncohort1968   0.13376    0.23600   0.567   0.5709    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 1647.6  on 236  degrees of freedom\nResidual deviance:  190.2  on 224  degrees of freedom\nAIC: 543.98\n\nNumber of Fisher Scoring iterations: 5\n\n\nCode show/hide\ntidy(poisfull, exponentiate = TRUE, conf.int = TRUE)\n\n\n# A tibble: 13 × 7\n   term        estimate std.error statistic   p.value  conf.low conf.high\n   <chr>          <dbl>     <dbl>     <dbl>     <dbl>     <dbl>     <dbl>\n 1 (Intercept) 0.000110    0.293    -31.1   5.74e-213 0.0000605  0.000191\n 2 par2        1.26        0.0911     2.52  1.17e-  2 1.05       1.51    \n 3 age0        0.0182      0.239    -16.7   5.72e- 63 0.0112     0.0286  \n 4 age15       0.311       0.125     -9.32  1.21e- 20 0.243      0.397   \n 5 age25       1.85        0.104      5.91  3.46e-  9 1.51       2.28    \n 6 age30       2.59        0.154      6.20  5.62e- 10 1.91       3.50    \n 7 motherage12 1.03        0.241      0.121 9.03e-  1 0.652      1.68    \n 8 motherage20 1.06        0.222      0.261 7.94e-  1 0.698      1.68    \n 9 motherage25 0.890       0.225     -0.518 6.04e-  1 0.583      1.41    \n10 cohort1950  0.696       0.288     -1.26  2.08e-  1 0.398      1.23    \n11 cohort1958  0.923       0.248     -0.323 7.46e-  1 0.574      1.52    \n12 cohort1963  1.13        0.237      0.521 6.03e-  1 0.720      1.83    \n13 cohort1968  1.14        0.236      0.567 5.71e-  1 0.729      1.84    \n\n\nCode show/hide\n# LRT for mother's age\npoismage<-glm(cases ~ offset(lpyrs) + par2 + age + cohort, \n              data = testis,family = poisson)\nlrtest(poisfull,poismage)\n\n\nLikelihood ratio test\n\nModel 1: cases ~ offset(lpyrs) + par2 + age + motherage + cohort\nModel 2: cases ~ offset(lpyrs) + par2 + age + cohort\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1  13 -258.99                     \n2  10 -260.25 -3 2.5336     0.4692\n\n\nCode show/hide\n# LRT for birth cohort of son\npoiscohort<-glm(cases ~ offset(lpyrs) + par2 + age + motherage, \n                data = testis,family = poisson)\nlrtest(poisfull,poiscohort)\n\n\nLikelihood ratio test\n\nModel 1: cases ~ offset(lpyrs) + par2 + age + motherage + cohort\nModel 2: cases ~ offset(lpyrs) + par2 + age + motherage\n  #Df  LogLik Df  Chisq Pr(>Chisq)  \n1  13 -258.99                       \n2   9 -263.60 -4 9.2204    0.05582 .\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode show/hide\n# LRT parity and age\npoisinteract<-glm(cases ~ offset(lpyrs) + par2 + age + motherage + cohort + par2*age, \n                  data = testis, family = poisson)\nlrtest(poisfull,poisinteract)\n\n\nLikelihood ratio test\n\nModel 1: cases ~ offset(lpyrs) + par2 + age + motherage + cohort\nModel 2: cases ~ offset(lpyrs) + par2 + age + motherage + cohort + par2 * \n    age\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1  13 -258.99                     \n2  17 -255.11  4 7.7606     0.1008\n\n\nCode show/hide\n# HR for seminomas\ntidy(glm(semi ~ offset(lpyrs) + par2 + age + motherage + cohort, \n         data = testis, family = poisson),\n     exponentiate = T, conf.int = T)\n\n\n# A tibble: 13 × 7\n   term         estimate std.error statistic  p.value   conf.low conf.high\n   <chr>           <dbl>     <dbl>     <dbl>    <dbl>      <dbl>     <dbl>\n 1 (Intercept) 0.0000297     1.00   -10.4    1.98e-25 0.00000314  0.000178\n 2 par2        1.23          0.171    1.23   2.19e- 1 0.886       1.73    \n 3 age0        0.00297       1.13    -5.17   2.38e- 7 0.000147    0.0176  \n 4 age15       0.0949        0.443   -5.32   1.03e- 7 0.0357      0.209   \n 5 age25       2.98          0.200    5.47   4.55e- 8 2.03        4.44    \n 6 age30       6.62          0.245    7.71   1.30e-14 4.11       10.8     \n 7 motherage12 0.900         0.640   -0.164  8.69e- 1 0.295       3.94    \n 8 motherage20 0.978         0.618   -0.0360 9.71e- 1 0.339       4.15    \n 9 motherage25 1.23          0.617    0.338  7.35e- 1 0.427       5.22    \n10 cohort1950  0.731         0.907   -0.345  7.30e- 1 0.140       5.71    \n11 cohort1958  0.966         0.879   -0.0389 9.69e- 1 0.198       7.26    \n12 cohort1963  0.862         0.869   -0.171  8.64e- 1 0.180       6.39    \n13 cohort1968  0.691         0.879   -0.421  6.74e- 1 0.140       5.18    \n\n\nCode show/hide\n# HR for non-seminomas\ntidy(glm(nonsemi ~ offset(lpyrs) + par2 + age + motherage + cohort, \n         data = testis, family = poisson),\n     exponentiate = T, conf.int = T)\n\n\n# A tibble: 13 × 7\n   term         estimate std.error statistic   p.value  conf.low conf.high\n   <chr>           <dbl>     <dbl>     <dbl>     <dbl>     <dbl>     <dbl>\n 1 (Intercept) 0.0000860     0.308   -30.4   7.09e-203 0.0000459  0.000154\n 2 par2        1.27          0.108     2.19  2.88e-  2 1.03       1.56    \n 3 age0        0.0223        0.246   -15.4   9.35e- 54 0.0135     0.0355  \n 4 age15       0.369         0.133    -7.48  7.32e- 14 0.283      0.478   \n 5 age25       1.49          0.125     3.21  1.35e-  3 1.17       1.91    \n 6 age30       1.21          0.229     0.846 3.97e-  1 0.762      1.88    \n 7 motherage12 1.09          0.264     0.341 7.33e-  1 0.662      1.87    \n 8 motherage20 1.10          0.239     0.382 7.03e-  1 0.700      1.79    \n 9 motherage25 0.804         0.244    -0.892 3.72e-  1 0.508      1.33    \n10 cohort1950  0.639         0.328    -1.37  1.72e-  1 0.335      1.22    \n11 cohort1958  0.828         0.264    -0.718 4.73e-  1 0.499      1.41    \n12 cohort1963  1.15          0.247     0.550 5.82e-  1 0.715      1.89    \n13 cohort1968  1.19          0.245     0.722 4.70e-  1 0.748      1.96    \n\n\n\n\n\n\nCode show/hide\n* Column 1; \nproc genmod;\n    class age (ref='20') par2 (ref='1');\n    model cases=par2 age/dist=poi offset=lpyrs type3;\n    estimate 'RR' par2 1 -1/exp;\nrun;\n* Column 2; \nproc genmod;\n    class age (ref='20') motherage(ref='30') cohort(ref='1973') par2 (ref='1');\n    model cases=par2 age motherage cohort/dist=poi offset=lpyrs type3;\n    estimate 'RR' par2 1 -1/exp;\nrun;\n* In-text interaction test; \nproc genmod;\n    class age (ref='20') motherage(ref='30') cohort(ref='1973') par2 (ref='1');\n    model cases=par2 age motherage cohort par2*age/dist=poi offset=lpyrs type3;\nrun;\n* seminomas;\nproc genmod;\n    class age (ref='20') motherage(ref='30') cohort(ref='1973') par2 (ref='1');\n    model semi=par2 age motherage cohort/dist=poi offset=lpyrs type3;\n    estimate 'RR' par2 1 -1/exp;\nrun;\n* non-seminomas;\nproc genmod;\n    class age (ref='20') motherage(ref='30') cohort(ref='1973') par2 (ref='1');\n    model nonsemi=par2 age motherage cohort/dist=poi offset=lpyrs type3;\n    estimate 'RR' par2 1 -1/exp;\nrun;"
  },
  {
    "objectID": "Ch3.html#prova-trial-in-liver-cirrhosis",
    "href": "Ch3.html#prova-trial-in-liver-cirrhosis",
    "title": "3  Intensity models",
    "section": "PROVA trial in liver cirrhosis",
    "text": "PROVA trial in liver cirrhosis\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\nprova <- data.frame(read.csv(\"data/prova.csv\", na.strings = c(\".\")))\n# Treatment 2x2 factorial\nprova$beh <- with(prova, as.factor(scle + beta*2))\n# Extra variables\nprovany <- prova\nprovany$log2bili <- with(provany, log2(bili))\nprovany$btime    <- ifelse(provany$bleed == 1, provany$timebleed, provany$timedeath)\nprovany$d0time   <- ifelse(provany$bleed == 1, provany$timebleed, provany$timedeath)\nprovany$dead0    <- ifelse(provany$bleed == 1, 0, provany$death)\nprovany$outof0   <- ifelse(provany$bleed == 1, 1, provany$death)\nprovany$bdtime   <- ifelse(provany$bleed == 1, provany$timedeath, NA)\nprovany$deadb    <- ifelse(provany$bleed == 1, provany$death, NA)\nprovany$wait     <- ifelse(provany$bleed == 1, provany$bdtime - provany$timebleed, NA)\n\n\n\n\n\n\nCode show/hide\nproc import out=prova\n    datafile=\"data/prova.csv\"\n    dbms=csv replace;\nrun;\ndata prova; \n    set prova; \n    beh = scle + beta*2; \n    log2bili = log2(bili);\n    if bleed = 1 then wait = timedeath - timebleed;\nrun; \ndata provany; \n    set prova;\n    if bleed=1 then do; btime=timebleed; d0time=timebleed; dead0=0; outof0=1; \n    bdtime=timedeath; deadb=death; wait=bdtime-timebleed; \n    end;\n    if bleed=0 then do; btime=timedeath; d0time=timedeath; dead0=death; outof0=death; \n    bdtime=.; deadb=.; wait=.; end;\n    log2bili=log2(bili);\nrun;\n\n\n\n\n\n\n\nTable 3.3\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(survival)\noptions(contrasts=c(\"contr.treatment\", \"contr.poly\"))\n\n## Column 1\n# Variceal bleeding\ncoxph(Surv(btime, bleed) ~ beh, data = provany, ties = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(btime, bleed) ~ beh, data = provany, ties = \"breslow\")\n\n         coef exp(coef) se(coef)      z     p\nbeh1  0.05563   1.05721  0.39235  0.142 0.887\nbeh2 -0.03972   0.96106  0.40039 -0.099 0.921\nbeh3 -0.03205   0.96846  0.40063 -0.080 0.936\n\nLikelihood ratio test=0.07  on 3 df, p=0.9951\nn= 286, number of events= 50 \n\n\nCode show/hide\n# logrank test: Variceal bleeding\nlr<-survdiff(Surv(btime, bleed) ~ beh, data = provany)\nc(lr$chisq,lr$pvalue)\n\n\n[1] 0.07114524 0.99505932\n\n\nCode show/hide\n# Death without bleeding\ncox1<-coxph(Surv(d0time, dead0) ~ beh, data = provany, ties = \"breslow\")\n# logrank test: Death without bleeding\nlr<-survdiff(Surv(d0time, dead0) ~ beh, data = provany)\nc(lr$chisq,lr$pvalue)\n\n\n[1] 12.856428541  0.004957601\n\n\nCode show/hide\n# Death without bleeding - additive model\ncox2<-coxph(Surv(d0time, dead0) ~ scle + beta, data = provany, ties = \"breslow\")\nlibrary(lmtest)\n# Death without bleeding - remove propranolol\nlrtest(cox2,cox1)\n\n\nLikelihood ratio test\n\nModel 1: Surv(d0time, dead0) ~ scle + beta\nModel 2: Surv(d0time, dead0) ~ beh\n  #Df  LogLik Df Chisq Pr(>Chisq)\n1   2 -234.19                    \n2   3 -233.38  1 1.627     0.2021\n\n\nCode show/hide\ncox3<-coxph(Surv(d0time, dead0) ~ scle, data = provany, ties = \"breslow\")\nlrtest(cox3,cox2)\n\n\nLikelihood ratio test\n\nModel 1: Surv(d0time, dead0) ~ scle\nModel 2: Surv(d0time, dead0) ~ scle + beta\n  #Df  LogLik Df Chisq Pr(>Chisq)\n1   1 -234.36                    \n2   2 -234.19  1 0.348     0.5553\n\n\nCode show/hide\ncox3\n\n\nCall:\ncoxph(formula = Surv(d0time, dead0) ~ scle, data = provany, ties = \"breslow\")\n\n       coef exp(coef) se(coef)     z       p\nscle 1.0180    2.7677   0.3281 3.103 0.00191\n\nLikelihood ratio test=10.76  on 1 df, p=0.001037\nn= 286, number of events= 46 \n\n\nCode show/hide\n## Column 2\n# Variceal bleeding\ncoxph(Surv(btime, bleed) ~ beh + sex + coag + log2bili + factor(varsize),\n      data = provany, ties = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(btime, bleed) ~ beh + sex + coag + log2bili + \n    factor(varsize), data = provany, ties = \"breslow\")\n\n                      coef exp(coef)  se(coef)      z        p\nbeh1              0.176844  1.193445  0.433336  0.408  0.68320\nbeh2              0.207005  1.229989  0.424001  0.488  0.62539\nbeh3              0.030562  1.031034  0.420784  0.073  0.94210\nsex              -0.025865  0.974467  0.329095 -0.079  0.93736\ncoag             -0.020647  0.979565  0.007819 -2.641  0.00827\nlog2bili          0.191011  1.210473  0.149142  1.281  0.20029\nfactor(varsize)2  0.741460  2.098998  0.414959  1.787  0.07397\nfactor(varsize)3  1.884681  6.584252  0.442325  4.261 2.04e-05\n\nLikelihood ratio test=37.67  on 8 df, p=8.654e-06\nn= 271, number of events= 47 \n   (15 observations deleted due to missingness)\n\n\nCode show/hide\n# Death without bleeding\ncoxph(Surv(d0time, dead0) ~ beh + sex + coag + log2bili + factor(varsize),\n                    data = provany, ties = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(d0time, dead0) ~ beh + sex + coag + log2bili + \n    factor(varsize), data = provany, ties = \"breslow\")\n\n                      coef exp(coef)  se(coef)      z       p\nbeh1              0.826468  2.285233  0.458574  1.802 0.07151\nbeh2             -0.159630  0.852459  0.575047 -0.278 0.78132\nbeh3              0.910385  2.485279  0.420391  2.166 0.03034\nsex               0.841579  2.320027  0.415722  2.024 0.04293\ncoag             -0.008112  0.991920  0.006804 -1.192 0.23312\nlog2bili          0.445359  1.561051  0.136749  3.257 0.00113\nfactor(varsize)2  0.221738  1.248245  0.347159  0.639 0.52300\nfactor(varsize)3  0.753294  2.123984  0.448544  1.679 0.09307\n\nLikelihood ratio test=42.13  on 8 df, p=1.283e-06\nn= 271, number of events= 46 \n   (15 observations deleted due to missingness)\n\n\n\n\n\n\nCode show/hide\n* Table 3.3 column 1;\n* Variceal bleeding; \n* logrank test is the score test;\nproc phreg data=provany;\n    class beh (ref='0');\n    model btime*bleed(0)=beh  / type3(lr);\nrun;\n\n* Death without bleeding; \n* logrank test is the score test;\nproc phreg data=provany;\n    class beh (ref='0');\n    model d0time*dead0(0)=beh / type3(lr);\nrun;\n* Death without bleeding - in text LRT for additive model; \nproc phreg data=provany;\n    model d0time*dead0(0)=scle|beta / type3(lr);\n    estimate 'both' scle 1 beta 1 scle*beta 1;\nrun;\nproc phreg data=provany;\n    model d0time*dead0(0)=scle beta / type3(lr);\nrun;\n* Death without bleeding - remove propranolol;\nproc phreg data=provany;\n    model d0time*dead0(0)=scle / type3(lr);\nrun;\n\n* Table 3.3 column 2;\n* Variceal bleeding;\nproc phreg data=provany;\n    class beh (ref='0') varsize (ref='1');\n    model btime*bleed(0)=beh sex coag log2bili varsize / type3(lr);\nrun;\n\n* Death without bleeding; \nproc phreg data=provany;\n    class beh (ref='0') varsize (ref='1');\n    model d0time*dead0(0)=beh sex coag log2bili varsize / type3(lr);\nrun;\n\n\n\n\n\n\n\nTable 3.4\n\nRSAS\n\n\n\n\nCode show/hide\n# Composite\ncox<-coxph(Surv(btime, outof0) ~ beh + sex + coag + log2bili + factor(varsize),\n      data = provany, ties = \"breslow\")\ncox\n\n\nCall:\ncoxph(formula = Surv(btime, outof0) ~ beh + sex + coag + log2bili + \n    factor(varsize), data = provany, ties = \"breslow\")\n\n                      coef exp(coef)  se(coef)      z        p\nbeh1              0.525145  1.690704  0.312502  1.680  0.09287\nbeh2              0.100189  1.105380  0.337918  0.296  0.76686\nbeh3              0.494807  1.640181  0.291638  1.697  0.08976\nsex               0.360259  1.433701  0.253379  1.422  0.15508\ncoag             -0.013600  0.986492  0.005287 -2.572  0.01010\nlog2bili          0.328376  1.388711  0.101761  3.227  0.00125\nfactor(varsize)2  0.446403  1.562681  0.263275  1.696  0.08997\nfactor(varsize)3  1.332535  3.790639  0.301391  4.421 9.81e-06\n\nLikelihood ratio test=65.71  on 8 df, p=3.489e-11\nn= 271, number of events= 93 \n   (15 observations deleted due to missingness)\n\n\nCode show/hide\n# LRT for treatment\ncoxreduced<-coxph(Surv(btime, outof0) ~ sex + coag + log2bili + factor(varsize),\n      data = provany, ties = \"breslow\")\nlrtest(coxreduced,cox)\n\n\nLikelihood ratio test\n\nModel 1: Surv(btime, outof0) ~ sex + coag + log2bili + factor(varsize)\nModel 2: Surv(btime, outof0) ~ beh + sex + coag + log2bili + factor(varsize)\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   5 -457.74                     \n2   8 -455.35  3 4.7717     0.1893\n\n\n\n\n\n\nCode show/hide\nproc phreg data=provany;\n    class beh (ref='0') varsize (ref='1');\n    model btime*outof0(0)=beh sex coag log2bili varsize  / type3(lr);\nrun;\n\n\n\n\n\n\n\nTable 3.8\n\nRSAS\n\n\n\n\nCode show/hide\n# Time since randomization (tsr)\n# Column 1\ncoxtsr<-coxph(Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili, \n              data = provany, ties = \"breslow\")\ncoxtsr\n\n\nCall:\ncoxph(formula = Surv(btime, bdtime, deadb != 0) ~ beh + sex + \n    log2bili, data = provany, ties = \"breslow\")\n\n            coef exp(coef) se(coef)      z      p\nbeh1     -1.4127    0.2435   0.6787 -2.081 0.0374\nbeh2     -0.1146    0.8918   0.5952 -0.192 0.8474\nbeh3      0.7327    2.0807   0.5439  1.347 0.1780\nsex       1.1389    3.1234   0.5039  2.260 0.0238\nlog2bili  0.1088    1.1149   0.2075  0.524 0.6001\n\nLikelihood ratio test=15.35  on 5 df, p=0.008958\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n\nCode show/hide\ncoxtsr0<-coxph(Surv(btime, bdtime, deadb != 0) ~ sex + log2bili, \n              data = provany, ties = \"breslow\")\ncoxtsr0\n\n\nCall:\ncoxph(formula = Surv(btime, bdtime, deadb != 0) ~ sex + log2bili, \n    data = provany, ties = \"breslow\")\n\n            coef exp(coef) se(coef)      z      p\nsex       0.9095    2.4830   0.4807  1.892 0.0585\nlog2bili -0.1618    0.8506   0.1826 -0.886 0.3758\n\nLikelihood ratio test=4.19  on 2 df, p=0.1232\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n\nCode show/hide\n# LRT for beh\nlibrary(lmtest)\nlrtest(coxtsr,coxtsr0)\n\n\nLikelihood ratio test\n\nModel 1: Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili\nModel 2: Surv(btime, bdtime, deadb != 0) ~ sex + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)  \n1   5 -59.626                       \n2   2 -65.208 -3 11.164    0.01087 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode show/hide\ncoxnoint<-coxph(Surv(btime, bdtime, deadb != 0) ~ scle + beta  + sex + log2bili, \n              data = provany, ties = \"breslow\")\n# LRT interaction\nlrtest(coxnoint,coxtsr)\n\n\nLikelihood ratio test\n\nModel 1: Surv(btime, bdtime, deadb != 0) ~ scle + beta + sex + log2bili\nModel 2: Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)   \n1   4 -63.061                        \n2   5 -59.626  1 6.8707   0.008762 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode show/hide\n# Column 2\nprovany$tsb<-provany$btime\ncoxtsr_tt<-coxph(Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili+tt(tsb), \n      data = provany, ties = \"breslow\",\n      tt=function(x, t, ...) {\n        dt <- t-x\n        cbind(dt1=1*(dt<5), dt2=1*(dt>=5 & dt<10))\n      })\ncoxtsr_tt\n\n\nCall:\ncoxph(formula = Surv(btime, bdtime, deadb != 0) ~ beh + sex + \n    log2bili + tt(tsb), data = provany, ties = \"breslow\", tt = function(x, \n    t, ...) {\n    dt <- t - x\n    cbind(dt1 = 1 * (dt < 5), dt2 = 1 * (dt >= 5 & dt < 10))\n})\n\n               coef exp(coef) se(coef)      z        p\nbeh1       -1.15606   0.31472  0.68428 -1.689  0.09113\nbeh2       -0.02371   0.97657  0.63136 -0.038  0.97005\nbeh3        0.42544   1.53026  0.61129  0.696  0.48645\nsex         1.11875   3.06103  0.53261  2.101  0.03568\nlog2bili   -0.04822   0.95292  0.22285 -0.216  0.82869\ntt(tsb)dt1  2.94285  18.96981  0.73891  3.983 6.81e-05\ntt(tsb)dt2  2.34525  10.43583  0.80285  2.921  0.00349\n\nLikelihood ratio test=33.65  on 7 df, p=2.005e-05\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n\nCode show/hide\n# LRT for time-dependent covariates\nlrtest(coxtsr_tt,coxtsr)\n\n\nLikelihood ratio test\n\nModel 1: Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili + tt(tsb)\nModel 2: Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   7 -50.478                         \n2   5 -59.626 -2 18.295  0.0001065 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode show/hide\n# LRT for beh\ncoxtsr_tt_reduced<-coxph(Surv(btime, bdtime, deadb != 0) ~ sex + log2bili+tt(tsb), \n                 data = provany, ties = \"breslow\",\n                 tt=function(x, t, ...) {\n                   dt <- t-x\n                   cbind(dt1=1*(dt<5), dt2=1*(dt>=5 & dt<10))\n                 })\nlrtest(coxtsr_tt_reduced,coxtsr_tt)\n\n\nLikelihood ratio test\n\nModel 1: Surv(btime, bdtime, deadb != 0) ~ sex + log2bili + tt(tsb)\nModel 2: Surv(btime, bdtime, deadb != 0) ~ beh + sex + log2bili + tt(tsb)\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -53.081                     \n2   7 -50.478  3 5.2064     0.1573\n\n\nCode show/hide\n# In text, model linear effect of time-dependent covariate\ncoxph(Surv(btime, bdtime, deadb != 0) ~ beh+sex + log2bili+tt(tsb), \n      data = provany, ties = \"breslow\",\n      tt=function(x, t, ...){t-x})\n\n\nCall:\ncoxph(formula = Surv(btime, bdtime, deadb != 0) ~ beh + sex + \n    log2bili + tt(tsb), data = provany, ties = \"breslow\", tt = function(x, \n    t, ...) {\n    t - x\n})\n\n              coef exp(coef)  se(coef)      z       p\nbeh1     -1.462260  0.231712  0.685283 -2.134 0.03286\nbeh2     -0.028375  0.972024  0.620246 -0.046 0.96351\nbeh3      0.599364  1.820960  0.574135  1.044 0.29651\nsex       0.899664  2.458776  0.530853  1.695 0.09012\nlog2bili  0.349775  1.418749  0.224830  1.556 0.11977\ntt(tsb)  -0.005179  0.994834  0.001769 -2.927 0.00342\n\nLikelihood ratio test=25.54  on 6 df, p=0.0002708\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n\nCode show/hide\n# Duration\n# Column 1\ncoxdur<-coxph(Surv(wait, deadb != 0) ~ beh + sex + log2bili,\n              data = provany, ties = \"breslow\")\ncoxdur\n\n\nCall:\ncoxph(formula = Surv(wait, deadb != 0) ~ beh + sex + log2bili, \n    data = provany, ties = \"breslow\")\n\n            coef exp(coef) se(coef)      z     p\nbeh1     -0.9971    0.3689   0.6429 -1.551 0.121\nbeh2     -0.2995    0.7412   0.5965 -0.502 0.616\nbeh3      0.8708    2.3889   0.5136  1.695 0.090\nsex       0.6497    1.9149   0.5264  1.234 0.217\nlog2bili  0.2677    1.3070   0.1790  1.496 0.135\n\nLikelihood ratio test=13.24  on 5 df, p=0.0212\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n\nCode show/hide\ncoxdur0<-coxph(Surv(wait, deadb != 0) ~ sex + log2bili,\n              data = provany, ties = \"breslow\")\ncoxdur0\n\n\nCall:\ncoxph(formula = Surv(wait, deadb != 0) ~ sex + log2bili, data = provany, \n    ties = \"breslow\")\n\n           coef exp(coef) se(coef)     z     p\nsex      0.6742    1.9625   0.4662 1.446 0.148\nlog2bili 0.1210    1.1286   0.1677 0.721 0.471\n\nLikelihood ratio test=3.03  on 2 df, p=0.2195\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n\nCode show/hide\n# LRT for beh\nlrtest(coxdur,coxdur0)\n\n\nLikelihood ratio test\n\nModel 1: Surv(wait, deadb != 0) ~ beh + sex + log2bili\nModel 2: Surv(wait, deadb != 0) ~ sex + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)  \n1   5 -86.494                       \n2   2 -91.600 -3 10.211    0.01685 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode show/hide\n# Column 2\nprovany$tsr<-provany$btime\ncoxdur_tt<-coxph(Surv(wait, deadb != 0) ~ beh + sex + log2bili+tt(tsr),\n      data = provany, ties = \"breslow\",\n      tt=function(x, t, ...) {\n        dt <- x+t\n        cbind(v1=1*(dt<1*365.25), v2=1*(dt>=1*365.25 & dt<2*365.25))\n      })\ncoxdur_tt\n\n\nCall:\ncoxph(formula = Surv(wait, deadb != 0) ~ beh + sex + log2bili + \n    tt(tsr), data = provany, ties = \"breslow\", tt = function(x, \n    t, ...) {\n    dt <- x + t\n    cbind(v1 = 1 * (dt < 1 * 365.25), v2 = 1 * (dt >= 1 * 365.25 & \n        dt < 2 * 365.25))\n})\n\n             coef exp(coef) se(coef)      z     p\nbeh1      -1.0192    0.3609   0.6502 -1.567 0.117\nbeh2      -0.3116    0.7323   0.6005 -0.519 0.604\nbeh3       0.8467    2.3320   0.5244  1.615 0.106\nsex        0.6441    1.9043   0.5303  1.215 0.225\nlog2bili   0.2829    1.3269   0.1966  1.439 0.150\ntt(tsr)v1 -0.1723    0.8417   0.9096 -0.189 0.850\ntt(tsr)v2 -0.2211    0.8016   0.8862 -0.250 0.803\n\nLikelihood ratio test=13.31  on 7 df, p=0.065\nn= 48, number of events= 27 \n   (238 observations deleted due to missingness)\n\n\nCode show/hide\n# LRT for time-dependent covariates\nlrtest(coxdur,coxdur_tt)\n\n\nLikelihood ratio test\n\nModel 1: Surv(wait, deadb != 0) ~ beh + sex + log2bili\nModel 2: Surv(wait, deadb != 0) ~ beh + sex + log2bili + tt(tsr)\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   5 -86.494                     \n2   7 -86.464  2 0.0618     0.9696\n\n\nCode show/hide\ncoxdur_tt_reduced<-coxph(Surv(btime, bdtime, deadb != 0) ~ sex + log2bili+tt(tsb), \n                         data = provany, ties = \"breslow\",\n                         tt=function(x, t, ...) {\n                           dt <- t-x\n                           cbind(dt1=1*(dt<5), dt2=1*(dt>=5 & dt<10))\n                         })\n\n\n\n\n\n\nCode show/hide\n* Time since randomisation;\n* Column 1; \nproc phreg data=provany atrisk;\n    class beh (ref='0');\n    model bdtime*deadb(0)=beh sex log2bili / entry=btime rl type3(lr);\nrun;\n* LRT interaction scle*beta;\nproc phreg data=provany atrisk;\n    class beh (ref='0');\n    model bdtime*deadb(0)=scle|beta sex log2bili / entry=btime rl type3(lr);\nrun;\n* Column 2; \nproc phreg  data=provany;\n    class beh (ref='0');\n    model bdtime*deadb(0)=beh sex log2bili wait1 wait2 / entry=btime rl type3(lr);\n    wait1=0; wait2=0;\n    if (bdtime-btime<5) then wait1=1;\n    if (5<=bdtime-btime<10) then wait2=1;\n    duration: test wait1=0, wait2=0;\nrun;\n\n* In text: Linear effect of time-dependent covariate;\nproc phreg  data=provany;\n    class beh (ref='0');\n    model bdtime*deadb(0)=beh sex log2bili lin / entry=btime rl type3(lr);\n    lin=bdtime-btime;\nrun;\n\n\n* Duration; \n* Column 1; \nproc phreg data=provany;\n    class beh (ref='0');\n    model wait*deadb(0)=beh sex log2bili / type3(lr);\n    baseline out=cumhazwait cumhaz=breslowwait covariates=covar;\nrun;\n\n* Column 2;\nproc phreg data=provany;\n    class beh (ref='0');\n    model wait*deadb(0)=beh sex log2bili time1 time2 / type3(lr);\n    time1=0; time2=0;\n    if (btime+wait<365.25) then time1=1;\n    if (365.25<=btime+wait<2*365.25) then time2=1;\n    timeeff: test time1=0, time2=0;\nrun;\n\n\n\n\n\n\n\nFigure 3.2\n\nRSAS\n\n\n\n\nCode show/hide\n# Plotting style \nlibrary(ggplot2)\nlibrary(tidyverse)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\n# Make zeros print as \"0\" always for plot axes\nlibrary(stringr)\nprettyZero <- function(l){\n  max.decimals = max(nchar(str_extract(l, \"\\\\.[0-9]+\")), na.rm = T)-1\n  lnew = formatC(l, replace.zero = T, zero.print = \"0\",\n                 digits = max.decimals, format = \"f\", preserve.width=T)\n  return(lnew)\n}\n\n# Extract cumulative baseline hazard\ncoxcumhaz <- survfit(coxtsr, \n                     newdata = data.frame(sex = 0, \n                                          beh = \"0\", \n                                          log2bili = 0))\n\n# Collect data for plot\ncoxdata <- data.frame(cumhaz = append(0,coxcumhaz$cumhaz), \n                      time = append(0,coxcumhaz$time), \n                      type = rep(\"Breslow estimate\", 1+length(coxcumhaz$time)))\n\n# Create Figure 3.2\nfig3.2 <- ggplot(aes(x = time / 365.25, y = cumhaz), data = coxdata) + \n  geom_step(linewidth = 1) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general\n\nfig3.2\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata covar; \n    input beh sex log2bili; \n    datalines; \n    0 0 0\n; \nrun; \nproc phreg data=provany atrisk;\n    class beh (ref='0');\n    model bdtime*deadb(0)=beh sex log2bili/entry=btime rl type3(lr);\n    baseline out=cumhaztime cumhaz=breslowtime covariates=covar;\nrun;\ndata cumhaztime;\n    set cumhaztime; \n    bdtimeyears = bdtime / 365.25; \nrun;\nproc gplot data=cumhaztime;\n    plot breslowtime*bdtimeyears/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 4 by 1 minor=none \n          label=('Time since randomization (Years)');\n    axis2 order=0 to 1.1 by 0.1 minor=none label=(a=90 'Cumulative hazard');\n    symbol1  v=none i=stepjl c=blue;\nrun;\nquit;\n\n\n\n\n\n\n\nFigure 3.3\n\nRSAS\n\n\n\n\nCode show/hide\n# Extract cumulative baseline hazard\ncoxcumhaz <- survfit(coxdur, \n                     newdata = data.frame(sex = 0, \n                                          beh = \"0\", \n                                          log2bili = 0))\n# Collect data for plot\ncoxdata <- data.frame(cumhaz = append(0,coxcumhaz$cumhaz), \n                      time = append(0,coxcumhaz$time), \n                      type = rep(\"Breslow estimate\", 1+length(coxcumhaz$time)))\n\n# Create Figure 3.3\nfig3.3 <- ggplot(aes(x = time / 365.25, y = cumhaz), data = coxdata) + \n  geom_step(linewidth = 1) + \n  xlab(\"Duration (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), ) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)),labels = prettyZero) +\n  theme_general\n\nfig3.3\n\n\n\n\n\n\n\n\n\nCode show/hide\n* Duration; \ndata covar; \n    input beh sex log2bili; \n    datalines; \n    0 0 0\n; \nrun; \nproc phreg data=provany;\n    class beh (ref='0');\n    model wait*deadb(0)=beh sex log2bili / type3(lr);\n    baseline out=cumhazwait cumhaz=breslowwait covariates=covar;\nrun;\ndata cumhazwait;\n    set cumhazwait; \n    waityears = wait / 365.25; \nrun;\nproc gplot data=cumhazwait;\n    plot breslowwait*waityears/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 4 by 1 minor=none label=('Duration (Years)');\n    axis2 order=0 to 0.2 by 0.05 minor=none label=(a=90 'Cumulative hazard');\n    symbol1  v=none i=stepjl c=blue;\nrun;\nquit;\n\n\n\n\n\n\n\nTable 3.9\n\nRSAS\n\n\n\n\nCode show/hide\n# All bleeds\nprovasplit11 <- subset(provany, bleed == 1)\n# Split by duration\nprovasplit1 <- survSplit(Surv(wait, deadb != 0) ~ ., data = provasplit11, \n                           cut = c(5, 10),\n                           episode = \"wint\")\nprovasplit1$start <- with(provasplit1, \n                            btime + ifelse(wint == 1, 0, ifelse(wint == 2, 5 , 10))\n                            )\nprovasplit1$stop <- with(provasplit1, btime + wait)\nprovasplit1$risktime <- with(provasplit1, wait - tstart)\nprovasplit1$logrisktime <- log(provasplit1$risktime)\nprovasplit1$fail <- provasplit1$event\n\n# Split by time since rand (t)\nprovasplit2 <- survSplit(Surv(start, stop, fail) ~ ., data = provasplit1, \n                           cut = c((1) * 365.25, (2) * 365.25),\n                           episode = \"tint\")\n\nprovasplit2$risktime2 <- with(provasplit2, stop - start)\nprovasplit2$risktimeys2 <- provasplit2$risktime2 / 365.25\n  \nprovasplit2$logrisktime2 <- log(provasplit2$risktime2)\nprovasplit2$fail2 <- provasplit2$fail\n\n# Summarize the data, Table 3.9 output\naggregate(cbind(fail2, risktimeys2) ~ tint + wint, provasplit2, \n          FUN = function(x) c(count = length(x),\n                              sum = sum(x)))\n\n\n  tint wint fail2.count fail2.sum risktimeys2.count risktimeys2.sum\n1    1    1          39         8       39.00000000      0.46338125\n2    2    1          11         2       11.00000000      0.13073238\n3    3    1           1         0        1.00000000      0.01368925\n4    1    2          30         2       30.00000000      0.38603696\n5    2    2           9         1        9.00000000      0.11635866\n6    3    2           1         0        1.00000000      0.01368925\n7    1    3          28         7       28.00000000     12.42984257\n8    2    3          28         5       28.00000000     19.88227242\n9    3    3          19         4       19.00000000     21.56468172\n\n\n\n\n\n\nCode show/hide\ndata provasplit1;\n    set provany;\n    where bleed=1;\n    fail=(wait<5)*(deadb ne 0);\n    risktime=min(5,wait);\n    logrisk=log(risktime); wint=1; \n    start=btime; slut=btime+min(5,wait); output;  \n    if wait>=5 then do;\n    fail=(wait<10)*(deadb ne 0);\n    risktime=min(5,wait-5);\n    logrisk=log(risktime); wint=2; \n    start=btime+5; slut=btime+min(10,wait); output; end;\n    if wait>10 then do;\n    fail=deadb ne 0; \n    risktime=wait-10;\n    logrisk=log(risktime); wint=3; \n    start=btime+10; slut=btime+wait; output; end;\nrun;\n\ndata provasplit2; \n    set provasplit1;\n    if start<365.25 then do; risktime2=min(slut,365.25)-start;\n    fail2=fail*(slut<365.25); logrisk2=log(risktime2); tint=1; output;\n    if slut>365.25 then do; risktime2=min(slut,2*365.25)-365.25; logrisk2=log(risktime2);\n    fail2=fail*(slut<2*365.25); tint=2; output; end;\n    if slut>2*365.25 then do; risktime2=slut-2*365.25; logrisk2=log(risktime2);\n    fail2=fail; tint=3; output; end;\n    end;\n    if 365.25<=start<2*365.25 then do; risktime2=min(slut,2*365.25)-start;\n    fail2=fail*(slut<2*365.25); logrisk2=log(risktime2); tint=2; output;\n    if slut>2*365.25 then do; risktime2=slut-2*365.25; logrisk2=log(risktime2);\n    fail2=fail; tint=3; output; end;\n    end;\n    if start>=2*365.25 then do; risktime2=slut-start; logrisk2=log(risktime2);\n    fail2=fail; tint=3; output; \nend;\nrun;\ndata provasplit2; \n    set provasplit2;\n    risktime2ys=risktime2/365.25;\nrun;\nproc means data=provasplit2 sum; \n    class wint tint;\n    var fail2 risktime2ys;\nrun;\n\n\n\n\n\n\n\nTable 3.10\n\nRSAS\n\n\n\n\nCode show/hide\n# part (a)\nsummary(glm(fail ~ offset(log(risktime)) + beh + relevel(as.factor(wint), ref = \"3\") + \n              sex + log2bili, data = provasplit1, family = poisson))\n\n\n\nCall:\nglm(formula = fail ~ offset(log(risktime)) + beh + relevel(as.factor(wint), \n    ref = \"3\") + sex + log2bili, family = poisson, data = provasplit1)\n\nCoefficients:\n                                     Estimate Std. Error z value Pr(>|z|)    \n(Intercept)                           -8.8925     1.1282  -7.882 3.21e-15 ***\nbeh1                                  -1.1301     0.6423  -1.759   0.0785 .  \nbeh2                                  -0.3138     0.5887  -0.533   0.5940    \nbeh3                                   0.9667     0.5157   1.874   0.0609 .  \nrelevel(as.factor(wint), ref = \"3\")1   3.6024     0.4387   8.212  < 2e-16 ***\nrelevel(as.factor(wint), ref = \"3\")2   2.8437     0.6373   4.462 8.11e-06 ***\nsex                                    0.7327     0.5190   1.412   0.1581    \nlog2bili                               0.2877     0.1824   1.577   0.1147    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 225.56  on 122  degrees of freedom\nResidual deviance: 149.88  on 115  degrees of freedom\n  (4 observations deleted due to missingness)\nAIC: 219.88\n\nNumber of Fisher Scoring iterations: 8\n\n\nCode show/hide\n# part (b)\nsummary(glm(fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(tint), ref = \"3\") + \n              sex + log2bili, data = provasplit2, family = poisson))\n\n\n\nCall:\nglm(formula = fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(tint), \n    ref = \"3\") + sex + log2bili, family = poisson, data = provasplit2)\n\nCoefficients:\n                                     Estimate Std. Error z value Pr(>|z|)    \n(Intercept)                           -8.6775     1.2008  -7.226 4.96e-13 ***\nbeh1                                  -1.2810     0.6522  -1.964   0.0495 *  \nbeh2                                  -0.4317     0.5657  -0.763   0.4454    \nbeh3                                   0.8006     0.5254   1.524   0.1275    \nrelevel(as.factor(tint), ref = \"3\")1   1.5068     0.5785   2.605   0.0092 ** \nrelevel(as.factor(tint), ref = \"3\")2   0.4304     0.6482   0.664   0.5067    \nsex                                    0.9494     0.4922   1.929   0.0538 .  \nlog2bili                               0.1792     0.2049   0.875   0.3817    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 237.84  on 160  degrees of freedom\nResidual deviance: 202.95  on 153  degrees of freedom\n  (5 observations deleted due to missingness)\nAIC: 272.95\n\nNumber of Fisher Scoring iterations: 8\n\n\nCode show/hide\n# part (c)\nsummary(glm(fail2 ~ offset(log(risktime2)) + beh + \n              relevel(as.factor(wint), ref = \"3\") +\n              relevel(as.factor(tint), ref = \"3\") +\n              sex + log2bili, data = provasplit2, family = poisson))\n\n\n\nCall:\nglm(formula = fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(wint), \n    ref = \"3\") + relevel(as.factor(tint), ref = \"3\") + sex + \n    log2bili, family = poisson, data = provasplit2)\n\nCoefficients:\n                                     Estimate Std. Error z value Pr(>|z|)    \n(Intercept)                           -8.9276     1.1636  -7.673 1.68e-14 ***\nbeh1                                  -1.1101     0.6475  -1.714   0.0864 .  \nbeh2                                  -0.3181     0.5788  -0.550   0.5826    \nbeh3                                   0.8260     0.5138   1.608   0.1079    \nrelevel(as.factor(wint), ref = \"3\")1   3.3500     0.4641   7.219 5.25e-13 ***\nrelevel(as.factor(wint), ref = \"3\")2   2.5827     0.6593   3.917 8.97e-05 ***\nrelevel(as.factor(tint), ref = \"3\")1   0.7325     0.6176   1.186   0.2356    \nrelevel(as.factor(tint), ref = \"3\")2   0.1889     0.6546   0.289   0.7729    \nsex                                    0.7672     0.5090   1.507   0.1317    \nlog2bili                               0.2301     0.1900   1.211   0.2260    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 237.84  on 160  degrees of freedom\nResidual deviance: 160.21  on 151  degrees of freedom\n  (5 observations deleted due to missingness)\nAIC: 234.21\n\nNumber of Fisher Scoring iterations: 7\n\n\nCode show/hide\n# Interaction model, in-text but not shown\nsummary(glm(fail2 ~ offset(log(risktime2)) + beh + as.factor(tint) * as.factor(wint) + sex + log2bili, \n            data = provasplit2, family = poisson)\n)\n\n\n\nCall:\nglm(formula = fail2 ~ offset(log(risktime2)) + beh + as.factor(tint) * \n    as.factor(wint) + sex + log2bili, family = poisson, data = provasplit2)\n\nCoefficients:\n                                    Estimate Std. Error z value Pr(>|z|)    \n(Intercept)                         -4.72678    1.20626  -3.919 8.91e-05 ***\nbeh1                                -1.09421    0.64703  -1.691   0.0908 .  \nbeh2                                -0.31016    0.57923  -0.535   0.5923    \nbeh3                                 0.83850    0.51484   1.629   0.1034    \nas.factor(tint)2                    -0.74368    1.06413  -0.699   0.4846    \nas.factor(tint)3                   -14.39376 1275.75399  -0.011   0.9910    \nas.factor(wint)2                    -1.03184    0.79349  -1.300   0.1935    \nas.factor(wint)3                    -3.37183    0.51906  -6.496 8.24e-11 ***\nsex                                  0.77074    0.50839   1.516   0.1295    \nlog2bili                             0.21347    0.18999   1.124   0.2612    \nas.factor(tint)2:as.factor(wint)2    1.26419    1.62046   0.780   0.4353    \nas.factor(tint)3:as.factor(wint)2    1.03184 1804.18859   0.001   0.9995    \nas.factor(tint)2:as.factor(wint)3    0.08176    1.23780   0.066   0.9473    \nas.factor(tint)3:as.factor(wint)3   13.70295 1275.75414   0.011   0.9914    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 237.84  on 160  degrees of freedom\nResidual deviance: 158.93  on 147  degrees of freedom\n  (5 observations deleted due to missingness)\nAIC: 240.93\n\nNumber of Fisher Scoring iterations: 13\n\n\nCode show/hide\n# LRT for time-dependent covariates\nglmboth<-glm(fail2 ~ offset(log(risktime2)) + beh + \n               relevel(as.factor(wint), ref = \"3\") +\n               relevel(as.factor(tint), ref = \"3\") +\n               sex + log2bili, data = provasplit2, family = poisson)\nglmwint<-glm(fail2 ~ offset(log(risktime2)) + beh + \n               relevel(as.factor(wint), ref = \"3\") +\n               sex + log2bili, data = provasplit2, family = poisson)\nglmtint<-glm(fail2 ~ offset(log(risktime2)) + beh + \n               relevel(as.factor(tint), ref = \"3\") +\n               sex + log2bili, data = provasplit2, family = poisson)\n# LRT effect of duration since bleeding\nlrtest(glmtint,glmboth)\n\n\nLikelihood ratio test\n\nModel 1: fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(tint), \n    ref = \"3\") + sex + log2bili\nModel 2: fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(wint), \n    ref = \"3\") + relevel(as.factor(tint), ref = \"3\") + sex + \n    log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   8 -128.47                         \n2  10 -107.11  2 42.736  5.248e-10 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode show/hide\n# LRT effect of time since randomization\nlrtest(glmwint,glmboth)\n\n\nLikelihood ratio test\n\nModel 1: fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(wint), \n    ref = \"3\") + sex + log2bili\nModel 2: fail2 ~ offset(log(risktime2)) + beh + relevel(as.factor(wint), \n    ref = \"3\") + relevel(as.factor(tint), ref = \"3\") + sex + \n    log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   8 -108.08                     \n2  10 -107.11  2 1.9499     0.3772\n\n\n\n\n\n\nCode show/hide\n* part (a);\nproc genmod data=provasplit1;\n    class beh (ref='0') wint;\n    model fail=beh wint sex log2bili/dist=poi offset=logrisk type3;\nrun;\n\n* part (b);\nproc genmod data=provasplit2;\n    class beh (ref='0') tint;\n    model fail2=beh tint sex log2bili/dist=poi offset=logrisk2 type3;\nrun;\n\n* part (c);\nproc genmod data=provasplit2;\n    class beh (ref='0') wint tint;\n    model fail2=beh wint tint sex log2bili/dist=poi offset=logrisk2 type3;\nrun;\n\n* Interaction model, in-text;\nproc genmod data=provasplit2;\n    class beh (ref='0') wint tint;\n    model fail2=beh wint tint wint*tint sex log2bili/dist=poi offset=logrisk2 type3;\nrun;\n\n\n\n\n\n\n\nTable 3.13\n\nRSAS\n\n\n\n\nCode show/hide\n# Prepare data set for analysis - double\ndouble1 <- provany %>% mutate(time = d0time, \n                              status = dead0, \n                              entrytime = 0, \n                              sex1 = sex, \n                              sex2 = 0, \n                              age1 = age, \n                              age2 = 0, \n                              bili1 = log2bili, \n                              bili2 = log2bili * 0,\n                              bleeding = 1)\n\ndouble2 <- provany %>% filter(bleed == 1) %>% \n                       mutate(time = bdtime, \n                              status = deadb, \n                              entrytime = btime, \n                              sex1 = 0, \n                              sex2 = sex, \n                              age1 = 0, \n                              age2 = age, \n                              bili1 = log2bili * 0, \n                              bili2 = log2bili,\n                              bleeding = 2)\ndouble <- as.data.frame(rbind(double1, double2))\n\n# part (a)\nTable3.13a <- coxph(Surv(entrytime, time, status != 0) ~ strata(bleeding) + sex1 + sex2 + bili1 + bili2, \n            data = double, ties = \"breslow\")\nTable3.13a\n\n\nCall:\ncoxph(formula = Surv(entrytime, time, status != 0) ~ strata(bleeding) + \n    sex1 + sex2 + bili1 + bili2, data = double, ties = \"breslow\")\n\n         coef exp(coef) se(coef)      z        p\nsex1   1.0408    2.8316   0.4110  2.532   0.0113\nsex2   0.9095    2.4830   0.4807  1.892   0.0585\nbili1  0.5275    1.6947   0.1152  4.580 4.64e-06\nbili2 -0.1618    0.8506   0.1826 -0.886   0.3758\n\nLikelihood ratio test=32.5  on 4 df, p=1.509e-06\nn= 323, number of events= 73 \n   (13 observations deleted due to missingness)\n\n\nCode show/hide\n# part (b)\nTable3.13b <- coxph(Surv(entrytime, time, status != 0) ~ strata(bleeding) + sex + bili1 + bili2, \n                    data = double, ties = \"breslow\")\nTable3.13b\n\n\nCall:\ncoxph(formula = Surv(entrytime, time, status != 0) ~ strata(bleeding) + \n    sex + bili1 + bili2, data = double, ties = \"breslow\")\n\n         coef exp(coef) se(coef)      z        p\nsex    0.9866    2.6820   0.3115  3.167  0.00154\nbili1  0.5269    1.6936   0.1150  4.582 4.61e-06\nbili2 -0.1685    0.8449   0.1794 -0.939  0.34767\n\nLikelihood ratio test=32.46  on 3 df, p=4.185e-07\nn= 323, number of events= 73 \n   (13 observations deleted due to missingness)\n\n\nCode show/hide\n# LRT sex\nlrtest(Table3.13b,Table3.13a)\n\n\nLikelihood ratio test\n\nModel 1: Surv(entrytime, time, status != 0) ~ strata(bleeding) + sex + \n    bili1 + bili2\nModel 2: Surv(entrytime, time, status != 0) ~ strata(bleeding) + sex1 + \n    sex2 + bili1 + bili2\n  #Df  LogLik Df Chisq Pr(>Chisq)\n1   3 -288.94                    \n2   4 -288.92  1 0.043     0.8357\n\n\nCode show/hide\n# In-text: LRT log2(bilirubin)\nTable3.13bx <- coxph(Surv(entrytime, time, status != 0) ~ strata(bleeding) + sex1 + sex2 + log2bili, \n                     data = double, ties = \"breslow\")\nlrtest(Table3.13bx,Table3.13a)\n\n\nLikelihood ratio test\n\nModel 1: Surv(entrytime, time, status != 0) ~ strata(bleeding) + sex1 + \n    sex2 + log2bili\nModel 2: Surv(entrytime, time, status != 0) ~ strata(bleeding) + sex1 + \n    sex2 + bili1 + bili2\n  #Df  LogLik Df  Chisq Pr(>Chisq)   \n1   3 -293.86                        \n2   4 -288.92  1 9.8962   0.001656 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode show/hide\n# part (c)\nTable3.13c <- coxph(Surv(entrytime, time, status != 0) ~ strata(bleeding) + sex + bili1, \n                    data = double, ties = \"breslow\")\nTable3.13c\n\n\nCall:\ncoxph(formula = Surv(entrytime, time, status != 0) ~ strata(bleeding) + \n    sex + bili1, data = double, ties = \"breslow\")\n\n        coef exp(coef) se(coef)     z        p\nsex   0.9423    2.5659   0.3072 3.067  0.00216\nbili1 0.5263    1.6927   0.1149 4.582 4.61e-06\n\nLikelihood ratio test=31.58  on 2 df, p=1.387e-07\nn= 323, number of events= 73 \n   (13 observations deleted due to missingness)\n\n\nCode show/hide\n# In-text: LRT proportionality\nph<-coxph(Surv(entrytime, time, status != 0) ~ bleeding + sex + bili1, \n          data = double, ties = \"breslow\")\n\npht<-coxph(Surv(entrytime, time, status != 0) ~ bleeding + tt(bleeding) \n           + sex + bili1, \n          data = double, ties = \"breslow\",\n          tt = function(x,t, ...){\n             bleedt = x*log(t)\n           })\nlrtest(ph, pht)\n\n\nLikelihood ratio test\n\nModel 1: Surv(entrytime, time, status != 0) ~ bleeding + sex + bili1\nModel 2: Surv(entrytime, time, status != 0) ~ bleeding + tt(bleeding) + \n    sex + bili1\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   3 -343.23                         \n2   4 -335.42  1 15.615  7.764e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\n\n\n\n\nCode show/hide\n* Prepare data set for analysis - double; \ndata double; \n    set provany; \n    time=d0time; \n    status=dead0; \n    entrytime=0; \n    sex1=sex; \n    sex2=0;\n    age1=age; \n    age2=0; \n    bili1=log2bili; \n    bili2=log2bili*0; \n    bleeding=1; \n    output;\n\n    if bleed=1 then do;\n        time=bdtime; \n        status=deadb; \n        entrytime=btime; \n        sex1=0; \n        sex2=sex;\n        age1=0; \n        age2=age; \n        bili1=log2bili*0; \n        bili2=log2bili; \n        bleeding=2; \n        output; \n    end;\nrun;\n\n* part (a);\nproc phreg data=double;\n    model time*status(0)=sex1 sex2 bili1 bili2 /entry=entrytime type3(lr);\n    strata bleeding;\n    test sex1=sex2; /* wald tests instead of LRT */\n    test bili1=bili2;\nrun;\n\n* part (b);\nproc phreg data=double; \n    model time*status(0)=sex bili1 bili2 /entry=entrytime type3(lr);\n    strata bleeding;\nrun;\n\n* part (c);\nproc phreg data=double; \n    model time*status(0)=sex bili1 /entry=entrytime type3(lr);\n    strata bleeding;\nrun;\n\n* In-text: LRT proportionality;\nproc phreg data=double; \n  bleedinglogt=bleeding*log(time);\n    model time*status(0)=sex bili1 bleeding bleedinglogt /entry=entrytime type3(lr);\nrun;\n\n\n\n\n\n\n\nFigure 3.9\n\nRSAS\n\n\n\n\nCode show/hide\n# Extract cumulative hazard from r1 \nsurvr1 <- basehaz(Table3.13a, center = F)\npcumhaz <- data.frame(\n  cumhaz = c(survr1$hazard[survr1$strata==\"stratum=1\"],0,survr1$hazard[survr1$strata==\"stratum=2\"]), \n  time   = c(survr1$time[survr1$strata==\"stratum=1\"],0,survr1$time[survr1$strata==\"stratum=2\"]), \n  strata = c(survr1$strata[survr1$strata==\"stratum=1\"],\"2\",survr1$strata[survr1$strata==\"stratum=2\"])\n) \n\n# Create Figure 3.9\nfig3.9 <- ggplot(aes(x = time / 365.25, y = cumhaz, linetype = strata), data = pcumhaz) + \n  geom_step(linewidth = 1) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  scale_linetype_discrete(\"Stratum\", labels = c(\"1\", \"2\")) + \n  theme_general + theme(legend.position = \"none\")\n\nfig3.9\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata covar; \n    input sex1 sex2 bili1 bili2; \n    datalines; \n    0 0 0 0\n; \nrun; \n* part (a);\nproc phreg data=double;\n    model time*status(0)=sex1 sex2 bili1 bili2 /entry=entrytime type3(lr);\n    strata bleeding;\n    baseline out=mort cumhaz=breslow covariates=covar;\nrun;\ndata mort; \n    set mort; \n    timeyears = time /365.25; \nrun;\nproc gplot data=mort; \n    plot breslow*timeyears=bleeding/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 4 by 1 minor=none \n          label=('Time since randomization (Years)');\n    axis2 order=0 to 4 by 1 minor=none label=(a=90 'Cumulative hazard');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\nrun;\nquit;"
  },
  {
    "objectID": "Ch3.html#recurrent-episodes-in-affective-disorders",
    "href": "Ch3.html#recurrent-episodes-in-affective-disorders",
    "title": "3  Intensity models",
    "section": "Recurrent episodes in affective disorders",
    "text": "Recurrent episodes in affective disorders\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\naffective <- data.frame(read.csv(\"data/affective.csv\"))\naffective$wait <- with(affective, stop - start)\n\n\n\n\n\n\nCode show/hide\nproc import out=affective\n    datafile=\"data/affective.csv\"\n    dbms=csv replace;\nrun;\ndata affective; \n    set affective; \n    wait = stop - start; \nrun; \n\n\n\n\n\n\n\nTable 3.6\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(survival)\ncoxph(Surv(start, stop, status == 1) ~ bip,\n      data = subset(affective, state == 0), ties = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    state == 0), ties = \"breslow\")\n\n       coef exp(coef) se(coef)     z        p\nbip 0.36593   1.44186  0.09448 3.873 0.000107\n\nLikelihood ratio test=14.24  on 1 df, p=0.0001612\nn= 626, number of events= 542 \n\n\nCode show/hide\ncoxph(Surv(start, stop, status == 1) ~ bip + episode,\n      data = subset(affective, state == 0), ties = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip + episode, \n    data = subset(affective, state == 0), ties = \"breslow\")\n\n            coef exp(coef) se(coef)      z        p\nbip     0.318455  1.375002 0.094545  3.368 0.000756\nepisode 0.126230  1.134543 0.008675 14.552  < 2e-16\n\nLikelihood ratio test=177.8  on 2 df, p=< 2.2e-16\nn= 626, number of events= 542 \n\n\nCode show/hide\ncoxph(Surv(start, stop, status == 1) ~ bip + episode + I(episode*episode),\n      data = subset(affective, state == 0), ties = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip + episode + \n    I(episode * episode), data = subset(affective, state == 0), \n    ties = \"breslow\")\n\n                          coef exp(coef)  se(coef)      z      p\nbip                   0.066935  1.069226  0.097084  0.689  0.491\nepisode               0.424503  1.528831  0.032315 13.136 <2e-16\nI(episode * episode) -0.013617  0.986476  0.001554 -8.764 <2e-16\n\nLikelihood ratio test=283.1  on 3 df, p=< 2.2e-16\nn= 626, number of events= 542 \n\n\nCode show/hide\n# Episode as categorical\naffective$epi<-with(affective, ifelse(episode<10,episode,10))\ncoxph(Surv(start, stop, status == 1) ~ bip + factor(epi),\n      data = subset(affective, state == 0), ties = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip + factor(epi), \n    data = subset(affective, state == 0), ties = \"breslow\")\n\n                  coef exp(coef) se(coef)      z        p\nbip            0.08048   1.08381  0.09723  0.828    0.408\nfactor(epi)2   0.85474   2.35077  0.16125  5.301 1.15e-07\nfactor(epi)3   1.16051   3.19155  0.18519  6.267 3.69e-10\nfactor(epi)4   1.38768   4.00554  0.20278  6.843 7.75e-12\nfactor(epi)5   1.93212   6.90414  0.21559  8.962  < 2e-16\nfactor(epi)6   1.88500   6.58637  0.23483  8.027 9.97e-16\nfactor(epi)7   2.08122   8.01427  0.24693  8.429  < 2e-16\nfactor(epi)8   2.37102  10.70835  0.26095  9.086  < 2e-16\nfactor(epi)9   3.00076  20.10084  0.27006 11.112  < 2e-16\nfactor(epi)10  2.85119  17.30842  0.18992 15.013  < 2e-16\n\nLikelihood ratio test=298.5  on 10 df, p=< 2.2e-16\nn= 626, number of events= 542 \n\n\n\n\n\n\nCode show/hide\nproc phreg data=affective;\n    where state=0; \n    model stop*status(2 3)= bip / entry=start rl type3(lr);\nrun;\n\nproc phreg data=affective;\n    where state=0; \n    model stop*status(2 3)= bip episode / entry=start rl type3(lr);\nrun;\n\n* Episode as categorical;\ndata affective2;\n  set affective;\n    if episode>10 the episode=10;\nproc phreg data=affective2;\n    where state=0; \n    class episode(ref=\"1\");\n    model stop*status(2 3)= bip episode / entry=start rl type3(lr);\nrun;\n\nproc phreg data=affective;\n    where state=0; \n    model stop*status(2 3)= bip episode episode*episode / entry=start rl type3(lr);\nrun;\n\n\n\n\n\n\n\nTable 3.7\n\nRSAS\n\n\n\n\nCode show/hide\ncoxph(Surv(start, stop, status == 1) ~ bip + tt(year),\n      data = subset(affective, state == 0), ties = \"breslow\",\n       tt=function(x, t, ...) {\n         per <- x + 0.5 + t/12\n         cbind(period1=1*(66<=per & per<71),\n               period2=1*(71<=per & per<76),\n               period3=1*(76<=per & per<81),\n               period4=1*(81<=per))})\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip + tt(year), \n    data = subset(affective, state == 0), ties = \"breslow\", tt = function(x, \n        t, ...) {\n        per <- x + 0.5 + t/12\n        cbind(period1 = 1 * (66 <= per & per < 71), period2 = 1 * \n            (71 <= per & per < 76), period3 = 1 * (76 <= per & \n            per < 81), period4 = 1 * (81 <= per))\n    })\n\n                    coef exp(coef) se(coef)      z        p\nbip              0.36123   1.43509  0.09454  3.821 0.000133\ntt(year)period1 -0.25060   0.77834  0.20834 -1.203 0.229047\ntt(year)period2 -0.17948   0.83570  0.33095 -0.542 0.587596\ntt(year)period3 -0.36737   0.69256  0.43858 -0.838 0.402237\ntt(year)period4 -1.33241   0.26384  0.55385 -2.406 0.016141\n\nLikelihood ratio test=25.16  on 5 df, p=0.0001299\nn= 626, number of events= 542 \n\n\n\n\n\n\nCode show/hide\nproc phreg data=affective;\n    where state=0; \n    model stop*status(2 3)= bip period1 period2 period3 period4 / entry=start rl type3(lr);\n    period=year+0.5+stop/12;\n    period1=0; period2=0; period3=0; period4=0;\n    if 71>period>=66 then period1=1;\n    if 76>period>=71 then period2=1;\n    if 81>period>=76 then period3=1;\n    if period>=81 then period4=1;\nrun"
  },
  {
    "objectID": "Ch3.html#leader-cardiovascular-trial-in-type-2-diabetes",
    "href": "Ch3.html#leader-cardiovascular-trial-in-type-2-diabetes",
    "title": "3  Intensity models",
    "section": "LEADER cardiovascular trial in type 2 diabetes",
    "text": "LEADER cardiovascular trial in type 2 diabetes\n\n\n\n\nRead data\n\nR\n\n\nAssume that the LEADER data set is loaded in data set leader.\n\n\nCode show/hide\n# One data set per recurrent endpoint type\nleader_mi <- subset(leader, type == \"recurrent_mi\")\nleader_3p <- subset(leader, type == \"recurrent_comb_str_mi_cvdth\")\n\n\n\n\n\n\n\nTable 3.15\n\nR\n\n\n\n\nCode show/hide\n# Cox model, frailty\nlibrary(survival)\ncoxfrail <- coxph(Surv(start, stop, status == 1) ~ treat + frailty(id), \n                  method = \"breslow\", \n                  data = leader_mi)\nsummary(coxfrail)\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ treat + frailty(id), \n    data = leader_mi, method = \"breslow\")\n\n  n= 10120, number of events= 780 \n\n            coef    se(coef) se2     Chisq   DF   p     \ntreat       -0.1773 0.0877   0.07197    4.09    1 0.0430\nfrailty(id)                          3219.37 3030 0.0084\n\n      exp(coef) exp(-coef) lower .95 upper .95\ntreat    0.8376      1.194    0.7053    0.9946\n\nIterations: 7 outer, 28 Newton-Raphson\n     Variance of random effect= 5.686665   I-likelihood = -6863.6 \nDegrees of freedom for terms=    0.7 3030.1 \nConcordance= 0.975  (se = 0.001 )\nLikelihood ratio test= 2841  on 3031 df,   p=1\n\n\nCode show/hide\n# PieceWise constant, frailty\n# Make cuts \nalltimes <- seq(0,max(leader_mi$stop),length=99)\n\nFunctionIntervalM <- function(a,b) {\n  seq(from=min(a), to = max(a), by = (max(a)-min(a))/b)\n}\n\ncuts <- FunctionIntervalM(a = alltimes, b = 5)\ncuts\n\n\n[1]    0.0  379.2  758.4 1137.6 1516.8 1896.0\n\n\nCode show/hide\n# AG model, piecewise constant hazards \ncut_data <- survSplit(Surv(start, stop, status == 1) ~ ., \n                      leader_mi,\n                      cut = cuts[-1], \n                      episode = \"timegroup\")\n\npwch_frail <- coxph(Surv(start, stop, event) ~ \n                    treat + strata(timegroup) + frailty(id), \n                               data = cut_data)\nsummary(pwch_frail)\n\n\nCall:\ncoxph(formula = Surv(start, stop, event) ~ treat + strata(timegroup) + \n    frailty(id), data = cut_data)\n\n  n= 39070, number of events= 780 \n\n            coef    se(coef) se2     Chisq   DF   p     \ntreat       -0.1773 0.08772  0.07197    4.09    1 0.0430\nfrailty(id)                          3222.23 3033 0.0085\n\n      exp(coef) exp(-coef) lower .95 upper .95\ntreat    0.8375      1.194    0.7052    0.9946\n\nIterations: 7 outer, 28 Newton-Raphson\n     Variance of random effect= 5.694404   I-likelihood = -6863.4 \nDegrees of freedom for terms=    0.7 3033.3 \nConcordance= 0.975  (se = 0.001 )\nLikelihood ratio test= 2843  on 3034 df,   p=1\n\n\nCode show/hide\n# Joint frailty model, piecewise constant hazards\nlibrary(frailtypack)\nleader_mi$death <- ifelse(leader_mi$status == 2, 1, 0)\njointfrail_pc_eq_mi <- frailtyPenal(Surv(start, stop, status == 1) ~\n                                      cluster(id) + treat + terminal(death),\n                                    formula.terminalEvent = ~ treat,\n                                    data = leader_mi,\n                                    hazard = \"Piecewise-equi\", nb.int = c(5, 5),\n                                    recurrentAG = TRUE)\n\n\n\nBe patient. The program is computing ... \nThe program took 222.38 seconds \n\n\nCode show/hide\njointfrail_pc_eq_mi\n\n\nCall:\nfrailtyPenal(formula = Surv(start, stop, status == 1) ~ cluster(id) + \n    treat + terminal(death), formula.terminalEvent = ~treat, \n    data = leader_mi, recurrentAG = TRUE, hazard = \"Piecewise-equi\", \n    nb.int = c(5, 5))\n\n\n  Joint gamma frailty model for recurrent and a terminal event processes \n  using a Parametrical approach for the hazard function \n\nRecurrences:\n------------- \n          coef exp(coef) SE coef (H)        z        p\ntreat -0.18591  0.830349   0.0680109 -2.73353 0.006266\n\nTerminal event:\n---------------- \n           coef exp(coef) SE coef (H)        z         p\ntreat -0.211397  0.809452   0.0784837 -2.69352 0.0070702\n\n Frailty parameters: \n   theta (variance of Frailties, w): 0.895749 (SE (H): 0.0306499 ) p = < 1e-16 \n   alpha (w^alpha for terminal event): 1.85978 (SE (H): 0.115069 ) p = < 1e-16 \n \n   marginal log-likelihood = -16965\n   Convergence criteria: \n   parameters = 3.07e-08 likelihood = 0.000848 gradient = 2.12e-07 \n\n   AIC = Aikaike information Criterion     = 1.67777 \n\nThe expression of the Aikaike Criterion is: \n        'AIC = (1/n)[np - l(.)]' \n\n   n observations= 10120  n subjects= 9340\n   n recurrent events= 780\n   n terminal events= 828\n   n censored events= 9340\n   number of iterations:  37 \n   Number of nodes for the Gauss-Laguerre quadrature:  32 \n   Exact number of time intervals used:  5 \n   Exact number of time intervals used:  5 \n\n\nCode show/hide\nsummary(jointfrail_pc_eq_mi)\n\n\nRecurrences:\n------------- \n           hr     95%     C.I. \n treat   0.83 (   0.73 -   0.95 ) \n\nTerminal event:\n--------------- \n           hr     95%     C.I. \n treat   0.81 (   0.69 -   0.94 )"
  },
  {
    "objectID": "Ch3.html#bone-marrow-transplantation-in-acute-leukemia",
    "href": "Ch3.html#bone-marrow-transplantation-in-acute-leukemia",
    "title": "3  Intensity models",
    "section": "Bone marrow transplantation in acute leukemia",
    "text": "Bone marrow transplantation in acute leukemia\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\nbmt <- data.frame(read.csv(\"data/bmt.csv\"))\nbmt$intxsurv<- bmt$timedeath\nbmt$intxrel <- ifelse(bmt$rel == 1, bmt$timerel, bmt$timedeath)\nbmt$trm     <- ifelse(bmt$rel == 0 & bmt$death == 1, 1, 0)\nbmt$tgvhd   <- ifelse(bmt$gvhd == 1, bmt$timegvhd, bmt$intxrel)\nbmt$tanc500 <- ifelse(bmt$anc500 == 1, bmt$timeanc500, bmt$intxrel)\nbmt$state0  <- bmt$rel + 2*bmt$trm\n\n\n\n\n\n\nCode show/hide\nproc import out=bmt\n    datafile=\"data/bmt.csv\"\n    dbms=csv replace;\nrun;\ndata bmt; \n    set bmt;\n    intxsurv=timedeath; dead=death;\n    if rel=1 then intxrel=timerel; if rel=0 then intxrel=timedeath;\n    trm=0; if rel=0 and death=1 then trm=1;\n    state0=rel+2*trm;\n    if gvhd=1 then tgvhd=timegvhd; if gvhd=0 then tgvhd=intxrel;\nrun;\n\n\n\n\n\n\n\nFigure 3.5\n\nRSAS\n\n\n\n\nCode show/hide\n# General theme\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\n# Model fit and make plot data\nlibrary(survival)\nfit1 <- survfit(Surv(tgvhd, gvhd != 0) ~ 1, data = bmt)\npdata1 <- data.frame(cumhaz = fit1$cumhaz, \n                     time = fit1$time) \n# Create Figure 3.5\nfig3.5 <- ggplot(aes(x = time, y = cumhaz), data = pdata1) + \n  geom_step(linewidth = 1) + \n  xlab(\"Time since bone marrow transplantation (months)\") + \n  ylab(\"Cumulative GvHD hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 156), breaks = seq(0, 156, by = 12)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 0.8), breaks = seq(0, 0.8, by = 0.1)) +\n  theme_general\n\nfig3.5\n\n\n\n\n\n\n\n\n\nCode show/hide\nproc phreg data=bmt;\n    model tgvhd*gvhd(0)=;\n    baseline out=alfagvh cumhaz=naagvh;\nrun;\nproc gplot data=alfagvh;\n    plot naagvh*tgvhd/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 156 by 12 minor=none\n    label=('Time since bone marrow transplantation (months)');\n    axis2 order=0 to 0.8 by 0.1 minor=none\n    label=(a=90 'Cumulative GvHD hazard');\n    symbol1  v=none i=stepjl c=blue;\nrun;\nquit;\n\n\n\n\n\n\n\nFigure 3.6\n\nRSAS\n\n\n\n\nCode show/hide\n# Reformatting\nbmt$nyreltime <- with(bmt, ifelse(tgvhd < intxrel, tgvhd, intxrel))\nbmt$nyrel <- with(bmt, ifelse(tgvhd < intxrel, 0, rel))\nbmt$nytrm <- with(bmt, ifelse(tgvhd < intxrel, 0, trm))\n\n# Cumulative relapse rate without GvHD \nfit11 <- survfit(Surv(nyreltime, nyrel != 0) ~ 1, data = bmt)\n# Cumulative relapse rate after GvHD\nfit12 <- survfit(Surv(tgvhd, intxrel, rel != 0) ~ 1, \n                 data = subset(bmt, gvhd == 1 & tgvhd < intxrel))\n\n\n# Collect plot data\npdata11 <- data.frame(cumhaz = fit11$cumhaz, time = fit11$time) \npdata12 <- data.frame(cumhaz = fit12$cumhaz, time = fit12$time) \n\n# Create Figure 3.6\nfig3.6 <- ggplot(aes(x = time, y = cumhaz), data = pdata11) + \n  geom_step(linewidth = 1) +\n  geom_step(aes(x = time, y = cumhaz), data = pdata12, \n            linewidth = 1, linetype = \"dashed\") + \n  xlab(\"Time since bone marrow transplantation (months)\") + \n  ylab(\"Cumulative relapse hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 156), breaks = seq(0, 156, by = 12)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 0.2), breaks = seq(0, 0.2, by = 0.1)) +\n  theme_general\n\nfig3.6\n\n\n\n\n\n\n\n\n\nCode show/hide\n* Reformatting; \ndata bmt; \nset bmt; /* Censor at GvHD */\n    if tgvhd<intxrel then do;\n    nyreltime=tgvhd; nyrel=0; nytrm=0; end;\n    if tgvhd=intxrel then do;\n    nyreltime=intxrel; nyrel=rel; nytrm=trm; end;\nrun;\n\n* Cumulative relapse rate without gvhd; \nproc phreg data=bmt;\n    model nyreltime*nyrel(0)=;\n    baseline out=alfa0rel cumhaz=naa0rel;\nrun;\n\n* Cumulative relapse rate after gvhd; \nproc phreg data=bmt;\n    where gvhd=1;\n    model intxrel*rel(0)=/entry=tgvhd;\n    baseline out=alfagvhrel cumhaz=naagvhrel;\nrun;\ndata alfa0rel; \n    set alfa0rel; \n    reltime=nyreltime; \nrun;\ndata alfagvhrel; \n    set alfagvhrel; \n    reltime=intxrel; \nrun;\ndata rel; \n    merge alfa0rel alfagvhrel; \n    by reltime; \nrun;\ndata relrev; \n    set rel;\n    by reltime;\n    retain last1 last2;\n    if naa0rel=. then a02=last1; if naa0rel ne . then a02=naa0rel; \n    if naagvhrel=. then a13=last2; if naagvhrel ne . then a13=naagvhrel;\n    output;\n    last1=a02; last2=a13; \nrun;\nlegend1 label=none;\nproc gplot data=relrev;\n    plot a02*reltime a13*reltime/haxis=axis1 vaxis=axis2 overlay legend=legend1;\n    axis1 order=0 to 156 by 12 minor=none\n        label=('Time since bone marrow transplantation (months)');\n    axis2 order=0 to 0.2 by 0.1 minor=none\n        label=(a=90 'Cumulative relapse hazard');\n    symbol1  v=none i=stepjl c=red;\n    symbol2  v=none i=stepjl c=blue;\n    label a02=\"No GvHD\";\n    label a13=\"After GvHD\";\nrun;\nquit;\n\n\n\n\n\n\n\nFigure 3.7\n\nRSAS\n\n\n\n\nCode show/hide\n# Need to get the cumulative hazard estimates at the same time points\n# All times\nall_t <- sort(unique(c(unique(pdata11$time), unique(pdata12$time))))\n# Evaluate each step function at these time points \nstep11 <- stepfun(x = pdata11$time, y = c(0, pdata11$cumhaz))\nstep12 <- stepfun(x = pdata12$time, y = c(0, pdata12$cumhaz))\n\npdata11_a <- data.frame(time = all_t, \n                        cumhaz = step11(all_t))\npdata12_a <- data.frame(time = all_t, \n                        cumhaz = step12(all_t))\n# Collect data\npdata_b <- data.frame(cumhaz1 = pdata11_a$cumhaz, \n                      cumhaz2 = pdata12_a$cumhaz, \n                      time = all_t)\n\n# Make zeros print as \"0\" always in plots\nlibrary(stringr)\nprettyZero <- function(l){\n  max.decimals = max(nchar(str_extract(l, \"\\\\.[0-9]+\")), na.rm = T)-1\n  lnew = formatC(l, replace.zero = T, zero.print = \"0\",\n                 digits = max.decimals, format = \"f\", preserve.width=T)\n  return(lnew)\n}\n# Create Figure 3.7\nfig3.7 <- ggplot(aes(x = cumhaz1, y = cumhaz2), data = pdata_b) + \n  geom_step(linewidth = 1) +\n  geom_abline(aes(intercept = 0, slope = 0.858), linewidth = 1, \n              linetype = \"dashed\") + \n  xlab(\"Cumulative relapse hazard: no GvHD\") + \n  ylab(\"Cumulative relapse hazard: GvHD\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 0.2), breaks = seq(0, 0.2, by = 0.05),\n                     labels = prettyZero) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 0.2), breaks = seq(0, 0.2, by = 0.05),\n                     labels = prettyZero) +\n  theme_general\n\nfig3.7\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata relrev; \n    set relrev;\n    line=0.858*a02;\nrun;\nproc gplot data=relrev;\n    plot a13*a02 line*a02/haxis=axis1 vaxis=axis2 overlay;\n    axis1 order=0 to 0.2 by 0.05 minor=none \n    label=('Cumulative relapse hazard: no GvHD');\n    axis2 order=0 to 0.2 by 0.05 minor=none \n    label=(a=90 'Cumulative relapse hazard: GvHD');\n    symbol1  v=none i=stepjl c=red;\n    symbol2  v=none i=rl c=blue;\nrun;\nquit;\n\n\n\n\n\n\n\nIn-text: GvHD as time-dependent covariate\n\nRelapse\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(broom)\ntidy(coxph(Surv(intxrel,rel!=0) ~ tt(tgvhd), data = bmt, ties=\"breslow\",\n      tt=function(x, t, ...) {\n        dt <- t-x\n        cbind(tdcgvhd=1*(dt>0))\n      }),exp=T, conf.int = T)\n\n\n# A tibble: 1 × 7\n  term      estimate std.error statistic p.value conf.low conf.high\n  <chr>        <dbl>     <dbl>     <dbl>   <dbl>    <dbl>     <dbl>\n1 tt(tgvhd)    0.858     0.132     -1.15   0.248    0.663      1.11\n\n\nCode show/hide\n# test ph\ntidy(coxph(Surv(intxrel,rel!=0) ~ tt(tgvhd), data = bmt, ties=\"breslow\",\n      tt=function(x, t, ...) {\n        dt <- t-x\n        cbind(tdc=1*(dt>0),tdc_logt=(dt>0)*log(t+1))\n      }),exp=T, conf.int = T)\n\n\n# A tibble: 2 × 7\n  term              estimate std.error statistic p.value conf.low conf.high\n  <chr>                <dbl>     <dbl>     <dbl>   <dbl>    <dbl>     <dbl>\n1 tt(tgvhd)tdc         0.599     0.409    -1.25    0.210    0.268      1.34\n2 tt(tgvhd)tdc_logt    1.18      0.175     0.936   0.349    0.836      1.66\n\n\n\n\n\n\nCode show/hide\nproc phreg data=bmt;\n    model intxrel*rel(0)= ttgvhd / rl type3(lr);\n    ttgvhd=(intxrel-tgvhd)>0;\nrun;\n\n* test ph;\nproc phreg data=bmt;\n    model intxrel*rel(0)= ttgvhd ttgvhdlogt / rl type3(lr);\n    ttgvhd=(intxrel-tgvhd)>0;\n    ttgvhdlogt=ttgvhd*log(intxrel+1);\nrun;\n\n\n\n\n\n\n\nDeath in remission\n\nRSAS\n\n\n\n\nCode show/hide\ntidy(coxph(Surv(intxrel,trm!=0) ~ tt(tgvhd), data = bmt, ties=\"breslow\",\n      tt=function(x, t, ...) {\n        dt <- t-x\n        cbind(tdcgvhd=1*(dt>0))\n      }), exp=T, conf.int = T)\n\n\n# A tibble: 1 × 7\n  term      estimate std.error statistic  p.value conf.low conf.high\n  <chr>        <dbl>     <dbl>     <dbl>    <dbl>    <dbl>     <dbl>\n1 tt(tgvhd)     3.11    0.0964      11.8 4.88e-32     2.58      3.76\n\n\nCode show/hide\n# test ph\ntidy(coxph(Surv(intxrel,trm!=0) ~ tt(tgvhd), data = bmt, ties=\"breslow\",\n      tt=function(x, t, ...) {\n        dt <- t-x\n        cbind(tdc=1*(dt>0),tdc_logt=1*(dt>0)*log(t+1))\n      }), exp=T, conf.int = T)\n\n\n# A tibble: 2 × 7\n  term              estimate std.error statistic  p.value conf.low conf.high\n  <chr>                <dbl>     <dbl>     <dbl>    <dbl>    <dbl>     <dbl>\n1 tt(tgvhd)tdc         4.10     0.197       7.18 6.99e-13    2.79       6.03\n2 tt(tgvhd)tdc_logt    0.872    0.0851     -1.61 1.07e- 1    0.738      1.03\n\n\n\n\n\n\nCode show/hide\nproc phreg data=bmt;\n    model intxrel*trm(0)= ttgvhd / rl type3(lr);\n    ttgvhd=(intxrel-tgvhd)>0;\nrun;\n\n* test ph;\nproc phreg data=bmt;\n    model intxrel*trm(0)= ttgvhd ttgvhdlogt / rl type3(lr);\n    ttgvhd=(intxrel-tgvhd)>0;\n    ttgvhdlogt=ttgvhd*log(intxrel+1);\nrun;\n\n\n\n\n\n\n\n\nFigure 3.8\n\nRSAS\n\n\n\n\nCode show/hide\n# Cumulative death rate without GvHD \nfit11 <- survfit(Surv(nyreltime, nytrm != 0) ~ 1, data = bmt)\n\n# Cumulative death rate with GvHD\nfit12 <- survfit(Surv(tgvhd, intxrel, trm != 0) ~ 1, \n                 data = subset(bmt, gvhd == 1 & tgvhd < intxrel))\n\n# Collect plot data\npdata11 <- data.frame(cumhaz = fit11$cumhaz, \n                      time = fit11$time) \n\npdata12 <- data.frame(cumhaz = fit12$cumhaz, \n                      time = fit12$time) \n\n\n# Need to get the cumulative hazard estimates at the same time points\n# All times\nall_t <- sort(unique(c(unique(pdata11$time), unique(pdata12$time))))\n\n# Evaluate each step function at these time points \nstep11 <- stepfun(x = pdata11$time, y = c(0, pdata11$cumhaz))\nstep12 <- stepfun(x = pdata12$time, y = c(0, pdata12$cumhaz))\n\npdata11_a <- data.frame(time = all_t, \n                        cumhaz = step11(all_t))\npdata12_a <- data.frame(time = all_t, \n                        cumhaz = step12(all_t))\n\n# Collect data\npdata_b <- data.frame(cumhaz1 = pdata11_a$cumhaz, \n                      cumhaz2 = pdata12_a$cumhaz, \n                      time = all_t)\n\n# Create Figure 3.8\nfig3.8 <- ggplot(aes(x = cumhaz1, y = cumhaz2), data = pdata_b) + \n  geom_step(linewidth = 1) +\n  geom_abline(aes(intercept = 0, slope = 3.113), \n              linewidth = 1, linetype = \"dashed\") + \n  xlab(\"Cumulative death hazard: no GvHD\") + \n  ylab(\"Cumulative death hazard: GvHD\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 0.2), breaks = seq(0, 0.2, by = 0.05),\n                     labels = prettyZero) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 1.0), breaks = seq(0, 1.0, by = 0.2),\n                     labels = prettyZero) +\n  theme_general\n\nfig3.8\n\n\n\n\n\n\n\n\n\nCode show/hide\n* Cumulative death rate without gvhd; \nproc phreg data=bmt; \n    model nyreltime*nytrm(0)=;\n    baseline out=alfa0dead cumhaz=naa0dead;\nrun;\n* Cumulative death rate with gvhd; \nproc phreg data=bmt;\n    where gvhd=1;\n    model intxrel*trm(0)=/entry=tgvhd;\n    baseline out=alfagvhdead cumhaz=naagvhdead;\nrun;\n* Book-keeping for plot;\ndata alfa0dead; \n    set alfa0dead; \n    deadtime=nyreltime; \nrun;\ndata alfagvhdead; \n    set alfagvhdead; \n    deadtime=intxrel; \nrun;\ndata dead; \n    merge alfa0dead alfagvhdead; \n    by deadtime; \nrun;\ndata deadrev; \n    set dead;\n    by deadtime;\n    retain last1 last2;\n    if naa0dead=. then a02=last1; if naa0dead ne . then a02=naa0dead; \n    if naagvhdead=. then a13=last2; if naagvhdead ne . then a13=naagvhdead;\n    output;\n    last1=a02; last2=a13; \nrun;\n* Add coefficient; \ndata deadrev; \n    set deadrev;\n    line=3.113*a02;\nrun;\nproc gplot data=deadrev;\n    plot a13*a02 line*a02/haxis=axis1 vaxis=axis2 overlay;\n    axis1 order=0 to 0.2 by 0.05 minor=none\n    label=('Cumulative death hazard: no GvHD');\n    axis2 order=0 to 1 by 0.2 minor=none\n    label=(a=90 'Cumulative death hazard: GvHD');\n    symbol1  v=none i=stepjl c=red;\n    symbol2  v=none i=rl c=blue;;\nrun;\nquit;\n\n\n\n\n\n\n\nFigure 3.4\n\nRSAS\n\n\n\n\nCode show/hide\n# Cumulative death hazards wrt relapse; \n# Cumulative death rate no relapse or GvHD\nfit11 <- survfit(Surv(intxrel, trm != 0) ~ 1, data = bmt)\n# Cumulative death rate after relapse\nbmt$intxsurv <- with(bmt, ifelse(intxrel == intxsurv & rel == 1, intxsurv + 0.01, intxsurv))\nfit12 <- survfit(Surv(intxrel, intxsurv, death != 0) ~ 1, data = subset(bmt, rel == 1))\n# Cumulative death rate after GvHD\nfit13 <- survfit(Surv(tgvhd, intxrel, trm != 0) ~ 1, data = subset(bmt, gvhd == 1))\n# Collect plot data\npdata11 <- data.frame(cumhaz = fit11$cumhaz, time = fit11$time) \npdata12 <- data.frame(cumhaz = fit12$cumhaz, time = fit12$time) \npdata13 <- data.frame(cumhaz = fit13$cumhaz, time = fit13$time) \n\ntail(pdata12)\n\n\n      cumhaz   time\n220 7.557091  84.70\n221 7.557091  85.43\n222 7.557091  96.41\n223 8.057091  99.80\n224 8.057091  99.87\n225 8.057091 105.10\n\n\nCode show/hide\n# Create Figure 3.4\nfig3.4 <- ggplot(aes(x = time, y = cumhaz), data = pdata11) + \n  geom_step(linewidth = 1) +\n  geom_step(aes(x = time, y = cumhaz), data = pdata12, \n            linewidth = 1, linetype = \"dashed\") + \n  geom_step(aes(x = time, y = cumhaz), data = pdata13, \n            linewidth = 1, linetype = \"dotted\") + \n  xlab(\"Time since bone marrow transplantation (months)\") + \n  ylab(\"Cumulative hazard of death\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 156), breaks = seq(0, 156, by = 12)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general\n\nfig3.4\n\n\n\n\n\n\n\n\n\nCode show/hide\n* Cumulative death hazards wrt relapse ;\nproc phreg data=bmt; \n    model intxrel*trm(0)=;\n    baseline out=alfa02 cumhaz=naa02;\nrun;\ndata bmt; \n    set bmt; \n    if intxrel eq intxsurv and rel eq 1 then intxsurv = intxsurv + 0.01; \nrun; \nproc phreg data=bmt;\n    where rel=1;\n    model intxsurv*dead(0)=/entry=intxrel;\n    baseline out=alfa13 cumhaz=naa13;\nrun;\n\n* Book-keeping; \ndata alfa02; \n    set alfa02; \n    deadtime=intxrel; \nrun;\ndata alfa13; \n    set alfa13; \n    deadtime=intxsurv; \nrun;\ndata alfadead; \n    merge alfa02 alfa13; \n    by deadtime; \nrun;\ndata alfarev; set alfadead;\n    by deadtime;\n    retain last1 last2;\n    if naa02=. then a0rel=last1; if naa02 ne . then a0rel=naa02; \n    if naa13=. then arel=last2; if naa13 ne . then arel=naa13;\n    output;\n    last1=a0rel; last2=arel; \nrun;\n* 3 mortality rates simultaneously;\ndata alfa3dead; \n    merge deadrev alfarev; \n    by deadtime; \nrun;\nproc gplot data=alfa3dead;\n    plot arel*deadtime a02*deadtime a13*deadtime\n                     / overlay haxis=axis1 vaxis=axis2 legend=legend1;\n    axis1 order=0 to 120 by 10 minor=none\n        label=('Time since bone marrow transplantation (months)');\n    axis2 order=0 to 9 by 1 minor=none\n        label=(a=90 'Cumulative hazard of death');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\n    symbol3  v=none i=stepjl c=black;\n    label arel=\"After relapse\";\n    label a02=\"No relapse and no GvHD\";\n    label a13=\"After GvHD\";\nrun;\nquit;\n\n\n\n\n\n\n\nTable 3.12\n\nRSAS\n\n\n\n\nCode show/hide\n# Relapse\n# Column 1\ncoxph(Surv(intxrel,rel!=0) ~ tt(tgvhd) + I(age/10) + bmonly + all,\n      data = bmt, ties=\"breslow\",\n      tt=function(x, t, ...) {\n        dt <- t-x\n        cbind(tdcgvhd=1*(dt>0))\n      })\n\n\nCall:\ncoxph(formula = Surv(intxrel, rel != 0) ~ tt(tgvhd) + I(age/10) + \n    bmonly + all, data = bmt, ties = \"breslow\", tt = function(x, \n    t, ...) {\n    dt <- t - x\n    cbind(tdcgvhd = 1 * (dt > 0))\n})\n\n              coef exp(coef) se(coef)      z        p\ntt(tgvhd) -0.18363   0.83225  0.13370 -1.373    0.170\nI(age/10) -0.03973   0.96105  0.04450 -0.893    0.372\nbmonly    -0.12543   0.88211  0.13504 -0.929    0.353\nall        0.56273   1.75546  0.12965  4.340 1.42e-05\n\nLikelihood ratio test=22.52  on 4 df, p=0.0001578\nn= 2009, number of events= 259 \n\n\nCode show/hide\n# Column 2\ncoxph(Surv(intxrel,rel!=0) ~  tt(tgvhd) + I(age/10) + bmonly + all + tt(tanc500),\n      data = bmt, ties=\"breslow\",\n      tt=function(x, t, ...) {\n        dt <- t-x\n        cbind(tdcgvhd=1*(dt>0))\n      })\n\n\nCall:\ncoxph(formula = Surv(intxrel, rel != 0) ~ tt(tgvhd) + I(age/10) + \n    bmonly + all + tt(tanc500), data = bmt, ties = \"breslow\", \n    tt = function(x, t, ...) {\n        dt <- t - x\n        cbind(tdcgvhd = 1 * (dt > 0))\n    })\n\n                coef exp(coef) se(coef)      z        p\ntt(tgvhd)   -0.18830   0.82837  0.13374 -1.408   0.1592\nI(age/10)   -0.03934   0.96143  0.04452 -0.884   0.3770\nbmonly      -0.12979   0.87828  0.13515 -0.960   0.3369\nall          0.56216   1.75445  0.12968  4.335 1.46e-05\ntt(tanc500) -2.13768   0.11793  1.07729 -1.984   0.0472\n\nLikelihood ratio test=24.91  on 5 df, p=0.0001452\nn= 2009, number of events= 259 \n\n\nCode show/hide\n# Death in remission\n# Column 1\ncoxph(Surv(intxrel,trm!=0) ~ tt(tgvhd) + I(age/10) + bmonly + all,\n      data = bmt, ties=\"breslow\",\n      tt=function(x, t, ...) {\n        dt <- t-x\n        cbind(tdcgvhd=1*(dt>0))\n      })\n\n\nCall:\ncoxph(formula = Surv(intxrel, trm != 0) ~ tt(tgvhd) + I(age/10) + \n    bmonly + all, data = bmt, ties = \"breslow\", tt = function(x, \n    t, ...) {\n    dt <- t - x\n    cbind(tdcgvhd = 1 * (dt > 0))\n})\n\n              coef exp(coef) se(coef)      z        p\ntt(tgvhd)  1.04140   2.83318  0.09801 10.626  < 2e-16\nI(age/10)  0.26280   1.30056  0.03278  8.016 1.09e-15\nbmonly    -0.08546   0.91809  0.09556 -0.894 0.371162\nall        0.33359   1.39597  0.09817  3.398 0.000678\n\nLikelihood ratio test=227  on 4 df, p=< 2.2e-16\nn= 2009, number of events= 505 \n\n\nCode show/hide\n# Column 2\ncoxph(Surv(intxrel,trm!=0) ~  tt(tgvhd) + I(age/10) + bmonly + all + tt(tanc500),\n      data = bmt, ties=\"breslow\",\n      tt=function(x, t, ...) {\n        dt <- t-x\n        cbind(tdcgvhd=1*(dt>0))\n      })\n\n\nCall:\ncoxph(formula = Surv(intxrel, trm != 0) ~ tt(tgvhd) + I(age/10) + \n    bmonly + all + tt(tanc500), data = bmt, ties = \"breslow\", \n    tt = function(x, t, ...) {\n        dt <- t - x\n        cbind(tdcgvhd = 1 * (dt > 0))\n    })\n\n                coef exp(coef) se(coef)      z        p\ntt(tgvhd)    1.04016   2.82966  0.09854 10.556  < 2e-16\nI(age/10)    0.26289   1.30069  0.03288  7.996 1.28e-15\nbmonly      -0.14047   0.86895  0.09627 -1.459 0.144550\nall          0.33553   1.39868  0.09826  3.415 0.000639\ntt(tanc500) -2.22822   0.10772  0.30523 -7.300 2.87e-13\n\nLikelihood ratio test=275.1  on 5 df, p=< 2.2e-16\nn= 2009, number of events= 505 \n\n\n\n\n\n\nCode show/hide\n** Relapse **; \n* Column 1;\nproc phreg data=bmt;\n    class bmonly(ref=\"0\") all(ref=\"0\");\n    model intxrel*rel(0)=tdcgvhd age bmonly all/rl;\n    tdcgvhd=0;\n    if gvhd=1 and intxrel>tgvhd then tdcgvhd=1;\nrun;\n* Column 2;\nproc phreg data=bmt;\n    class bmonly(ref=\"0\") all(ref=\"0\");\n    model intxrel*rel(0)= tdcgvhd age bmonly all  tdcanc500/rl;\n    tdcanc500=0;\n    if anc500=1 and intxrel>timeanc500 then tdcanc500=1;\n    tdcgvhd=0;\n    if gvhd=1 and intxrel>tgvhd then tdcgvhd=1;\nrun;\n\n\n** Death in remission **;\n* Column 1; \nproc phreg data=bmt;\n    class bmonly(ref=\"0\") all(ref=\"0\");\n    model intxrel*trm(0)=tdcgvhd age bmonly all/rl;\n    tdcgvhd=0;\n    if gvhd=1 and intxrel>tgvhd then tdcgvhd=1;\nrun;\n\n* Column 2;\nproc phreg data=bmt;\n    class bmonly(ref=\"0\") all(ref=\"0\");\n    model intxrel*trm(0)=tdcgvhd  age bmonly all tdcanc500 /rl;\n    tdcanc500=0;\n    if anc500=1 and intxrel>timeanc500 then tdcanc500=1;\n    tdcgvhd=0;\n    if gvhd=1 and intxrel>tgvhd then tdcgvhd=1;\nrun;\n\n\n\n\n\n\n\nTable 3.14\n\nRSAS\n\n\n\n\nCode show/hide\n# Prepare data set for analysis - double\nlibrary(tidyverse)\nbmtext <- bmt %>% mutate(nygsource = bmonly, \n                         nydisease = all, \n                         age10 = age/10,\n                         time = ifelse(gvhd == 1, tgvhd, intxrel), \n                         status = ifelse(gvhd == 1, 0, trm),\n                         entry = 0,\n                         ) \n\n\ndouble1 <- bmtext  %>% \n  mutate(age1 = age10, \n         age2 = 0,\n         gsource1 = nygsource, \n         gsource2 = 0,\n         disease1 = nydisease,\n         disease2 = 0, \n         stratum = 1)\n\ndouble2 <- bmtext %>% filter(gvhd == 1) %>% \n  mutate(time = intxrel, \n         status = trm,  \n         entry = tgvhd,\n         age1 = 0, \n         age2 = age10,\n         gsource1 = 0, \n         gsource2 = nygsource,\n         disease1 = 0,\n         disease2 = nydisease, \n         stratum = 2)\n\ndoubledod <- as.data.frame(rbind(double1, double2))\n\n# Row 1\nr1<-coxph(Surv(entry, time, status != 0) ~ strata(stratum) + disease1 + disease2 + age1 + age2, \n            data = doubledod, ties = \"breslow\")\nr1\n\n\nCall:\ncoxph(formula = Surv(entry, time, status != 0) ~ strata(stratum) + \n    disease1 + disease2 + age1 + age2, data = doubledod, ties = \"breslow\")\n\n            coef exp(coef) se(coef)     z        p\ndisease1 0.26705   1.30610  0.15893 1.680  0.09290\ndisease2 0.36025   1.43369  0.12492 2.884  0.00393\nage1     0.25561   1.29125  0.04791 5.336 9.53e-08\nage2     0.28675   1.33209  0.04083 7.023 2.17e-12\n\nLikelihood ratio test=82.11  on 4 df, p=< 2.2e-16\nn= 2983, number of events= 505 \n   (2 observations deleted due to missingness)\n\n\nCode show/hide\n# Row 2\ndoubledod$type <- doubledod$stratum - 1\nr2<-coxph(Surv(entry, time, status != 0) ~ disease1 + disease2 + age1 + age2 + type, \n            data = doubledod, ties = \"breslow\")\nr2\n\n\nCall:\ncoxph(formula = Surv(entry, time, status != 0) ~ disease1 + disease2 + \n    age1 + age2 + type, data = doubledod, ties = \"breslow\")\n\n            coef exp(coef) se(coef)     z        p\ndisease1 0.26172   1.29916  0.15877 1.648  0.09926\ndisease2 0.37891   1.46069  0.12478 3.037  0.00239\nage1     0.24601   1.27891  0.04754 5.175 2.28e-07\nage2     0.29228   1.33948  0.04101 7.128 1.02e-12\ntype     0.84247   2.32210  0.26891 3.133  0.00173\n\nLikelihood ratio test=226.9  on 5 df, p=< 2.2e-16\nn= 2983, number of events= 505 \n   (2 observations deleted due to missingness)\n\n\nCode show/hide\nr2t<-coxph(Surv(entry, time, status != 0) ~ disease1 + disease2 + age1 + age2 + type\n           +tt(type), \n            data = doubledod, ties = \"breslow\",\n           tt = function(x,t, ...){\n             gvhdt = x*log(t)\n           })\n\n# In-text: LRT proportionality\nlibrary(lmtest)\nlrtest(r2, r2t)\n\n\nLikelihood ratio test\n\nModel 1: Surv(entry, time, status != 0) ~ disease1 + disease2 + age1 + \n    age2 + type\nModel 2: Surv(entry, time, status != 0) ~ disease1 + disease2 + age1 + \n    age2 + type + tt(type)\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   5 -3542.8                     \n2   6 -3541.8  1 2.0768     0.1496\n\n\nCode show/hide\n# Row 3\nr3<-coxph(Surv(entry, time, status != 0) ~ nydisease + age10 + type, \n            data = doubledod, ties = \"breslow\")\nr3\n\n\nCall:\ncoxph(formula = Surv(entry, time, status != 0) ~ nydisease + \n    age10 + type, data = doubledod, ties = \"breslow\")\n\n             coef exp(coef) se(coef)      z        p\nnydisease 0.33159   1.39318  0.09808  3.381 0.000723\nage10     0.27230   1.31298  0.03103  8.774  < 2e-16\ntype      1.04934   2.85577  0.09758 10.754  < 2e-16\n\nLikelihood ratio test=226.2  on 3 df, p=< 2.2e-16\nn= 2983, number of events= 505 \n   (2 observations deleted due to missingness)\n\n\nCode show/hide\n# In-text: LRT common coefficients\nlrtest(r3,r2)\n\n\nLikelihood ratio test\n\nModel 1: Surv(entry, time, status != 0) ~ nydisease + age10 + type\nModel 2: Surv(entry, time, status != 0) ~ disease1 + disease2 + age1 + \n    age2 + type\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   3 -3543.2                     \n2   5 -3542.8  2 0.7389     0.6911\n\n\n\n\n\n\nCode show/hide\n* Make \"double\" data set; \ndata doubledod; \n    set bmt; \n    nygsource=bmonly; \n    nydisease=all; \n    age10=age/10;\n    time=intxrel; \n    status=trm; \n    entry=0;\n\n    if gvhd=1 then do; \n        time=tgvhd; \n        status=0; \n    end;\n    age1=age10; \n    age2=0; \n    gsource1=nygsource; \n    gsource2=0;\n    disease1=nydisease; \n    disease2=0; \n    stratum=1; \n    output;\n\n    if gvhd=1 then do;\n        time=intxrel; \n        status=trm; \n        entry=tgvhd;\n        age1=0; \n        age2=age10; \n        gsource1=0; \n        gsource2=nygsource;\n        disease1=0; \n        disease2=nydisease; \n        stratum=2; \n        output; \n    end;\nrun;\n\n* Row 1; \nproc phreg data=doubledod; \n    model time*status(0)=disease1 disease2 \n    age1 age2 /entry=entry type3(lr);\n    strata stratum;\nrun;\n\n* Row 2; \nproc phreg data=doubledod; \n    model time*status(0)=disease1 disease2 \n    age1 age2 type /entry=entry type3(lr);\n    type=stratum-1;\n    test age1=age2, disease1=disease2; /* Wald test instead of LRT */\nrun;\n\n* In-text: LRT proportionality variable 'typelogt';\nproc phreg data=doubledod; \n    model time*status(0)=disease1 disease2 \n    age1 age2 type typelogt  /entry=entry type3(lr);\n    type=stratum-1;\n    typelogt=type*log(time);\nrun;\n\n\n* Row 3; \nproc phreg data=doubledod; \n    class stratum (ref='1') nydisease (ref='0');\n    model time*status(0)=nydisease age10 type /entry=entry type3(lr);\n    type=stratum-1;\nrun;\n\n\n\n\n\n\n\nFigure 3.10\n\nRSAS\n\n\n\n\nCode show/hide\n# Extract cumulative hazard from r1 \nsurvr1 <- basehaz(r1, center = F)\npcumhaz <- data.frame(cumhaz = survr1$hazard, \n                      time = survr1$time, \n                      strata = survr1$strata) \n\n# Create Figure 3.10\nfig3.10 <- ggplot(aes(x = time, y = cumhaz, linetype = strata), data = pcumhaz) + \n  geom_step(linewidth = 1) + \n  xlab(\"Time since bone marrow transplantation (months)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 156), breaks = seq(0, 156, by = 12)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  scale_linetype_discrete(\"Stratum\", labels = c(\"1\", \"2\")) + \n  theme_general + theme(legend.position = \"none\")\n\nfig3.10\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata covar; \n    input disease1 disease2 age1 age2; \n    datalines; \n    0 0 0 0\n; \nrun; \nproc phreg data=doubledod; \n    model time*status(0)=disease1 disease2 age1 age2 / entry=entry ;\n    strata stratum;\n    baseline out=trm cumhaz=breslow covariates=covar;\nrun;\nproc gplot data=trm;\n    plot breslow*time=stratum/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 156 by 12 minor=none\n        label=('Time since bone marrow transplantation (months)');\n    axis2 order=0 to 0.3 by 0.05 minor=none\n        label=(a=90 'Cumulative hazard of death in remission');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;;\nrun;\nquit;\n\n\n\n\n\n\n\nTable 3.15\n\nRSAS\n\n\n\n\nCode show/hide\ncoxph(Surv(intxrel, state0 != 0) ~ bmonly + all + age \n      + frailty.gamma(team, eps = 1e-09), data = bmt, ties = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(intxrel, state0 != 0) ~ bmonly + all + age + \n    frailty.gamma(team, eps = 1e-09), data = bmt, ties = \"breslow\")\n\n                              coef se(coef)      se2    Chisq DF       p\nbmonly                    -0.17512  0.08704  0.08178  4.04856  1  0.0442\nall                        0.47196  0.07965  0.07829 35.11425  1 3.1e-09\nage                        0.01873  0.00275  0.00263 46.44972  1 9.4e-12\nfrailty.gamma(team, eps =                            84.11745 51  0.0024\n\nIterations: 9 outer, 43 Newton-Raphson\n     Variance of random effect= 0.117   I-likelihood = -5495.9 \nDegrees of freedom for terms=  0.9  1.0  0.9 51.0 \nLikelihood ratio test=214  on 53.7 df, p=<2e-16\nn= 2009, number of events= 764 \n\n\nCode show/hide\ncoxph(Surv(intxrel, state0 != 0) ~ bmonly + all + age\n      + frailty.gaussian(team, eps = 1e-09, sparse=F), data = bmt, ties = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(intxrel, state0 != 0) ~ bmonly + all + age + \n    frailty.gaussian(team, eps = 1e-09, sparse = F), data = bmt, \n    ties = \"breslow\")\n\n                              coef se(coef)      se2    Chisq   DF       p\nbmonly                    -0.17683  0.08755  0.08208  4.08010  1.0  0.0434\nall                        0.47435  0.07989  0.07844 35.25576  1.0 2.9e-09\nage                        0.01891  0.00278  0.00265 46.42018  1.0 9.5e-12\nfrailty.gaussian(team, ep                            90.71464 55.1  0.0018\n\nIterations: 8 outer, 22 Newton-Raphson\n     Variance of random effect= 0.139 \nDegrees of freedom for terms=  0.9  1.0  0.9 55.2 \nLikelihood ratio test=695  on 57.9 df, p=<2e-16\nn= 2009, number of events= 764 \n\n\n\n\n\n\nCode show/hide\n* Gamma; \nproc phreg data=bmt;\n    class bmonly(ref=\"0\") all(ref=\"0\") team;\n    model intxrel*state0(0)=bmonly all age/rl;\n    random team/dist=gamma;\nrun;\n\n* Log-normal; \nproc phreg data=bmt;\n    class bmonly(ref=\"0\") all(ref=\"0\") team;\n    model intxrel*state0(0)=bmonly all age/rl;\n    random team;\nrun;\n\n\n\n\n\n\n\nIn-text: stratified Cox model by center\n\nRSAS\n\n\n\n\nCode show/hide\ncoxph(Surv(intxrel, state0 != 0) ~ bmonly + all + age \n      + strata(team), data = bmt, ties = \"breslow\")\n\n\nCall:\ncoxph(formula = Surv(intxrel, state0 != 0) ~ bmonly + all + age + \n    strata(team), data = bmt, ties = \"breslow\")\n\n            coef exp(coef)  se(coef)      z        p\nbmonly -0.196894  0.821277  0.114392 -1.721   0.0852\nall     0.470582  1.600926  0.090822  5.181 2.20e-07\nage     0.020946  1.021167  0.003539  5.918 3.26e-09\n\nLikelihood ratio test=61.1  on 3 df, p=3.424e-13\nn= 2009, number of events= 764 \n\n\n\n\n\n\nCode show/hide\nproc phreg data=bmt;\n    class bmonly(ref=\"0\") all(ref=\"0\") team;\n    model intxrel*state0(0)=bmonly all age/rl;\n    strata team;\nrun;"
  },
  {
    "objectID": "Ch3.html#exercises",
    "href": "Ch3.html#exercises",
    "title": "3  Intensity models",
    "section": "Exercises",
    "text": "Exercises\n\nExercise 3.1 (*)\nShow that, under the null hypothesis \\(H_0 : A_0(t) = A_1(t)\\), the test statistic \\(\\int_0^t K(u)\\left( d\\widehat{A}_1(u)-d\\widehat{A}_0(u)\\right)\\) is a martingale (Section 3.2.2).\nThe counting processes can be decomposed as \\(N_h(t)=\\int_0^tY_h(u)\\alpha_h(u)du + M_h(t), h=0,1\\), so under \\(H_0\\), \\[d\\widehat{A}_h(u)=\\frac{dN_h(u)}{Y_h(u)}=\\alpha(u)du+\\frac{dM_h(u)}{Y_h(u)},\\] and the test statistic reduces to the martingale integral \\[\\int_0^tK(u)\\left(\\frac{dM_1(u)}{Y_1(u)}-\\frac{dM_0(u)}{Y_0(u)}\\right),\\] which is itself a martingale.\n\n\nExercise 3.2 (*)\nShow that, when evaluated at the true parameter vector \\(\\mathbf{\\beta}_0\\), the Cox partial likelihood score \\[\n\\int_0^t\\sum_i \\bigl(\\mathbf{Z}_i-\\frac{\\sum_jY_j(u)\\mathbf{Z}_j\\exp(\\mathbf{\\beta}_0^{\\sf T}\\mathbf{Z}_j)}{\\sum_jY_j(u)\\exp(\\mathbf{\\beta}_0^{\\sf T}\\mathbf{Z}_j)}\\bigr)dN_i(u)\n\\] is a martingale (Section 3.3).\nEach individual counting process can be decomposed as \\[N_i(t)=\\int_0^t \\alpha_0(u)Y_i(u)\\exp(\\mathbf{\\beta}_0^{\\sf T}\\mathbf{Z}_i)du + M_i(t)\\] and with \\(S_0(\\mathbf{\\beta},t)=\\sum_iY_i(t)\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)\\), \\(\\mathbf{S}_1(\\mathbf{\\beta},t)=\\sum_iY_i(t)\\mathbf{Z}_i\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)\\), the integrand in the Cox score becomes \\[\\sum_i \\bigl(\\mathbf{Z}_i-\\frac{\\mathbf{S}_1(\\mathbf{\\beta},u)}{S_0(\\mathbf{\\beta},u)}\\bigr)(\\alpha_0(u)Y_i(u)\\exp(\\mathbf{\\beta}_0^{\\sf T}\\mathbf{Z}_i)du + dM_i(u))\n\\] \\[=\\alpha_0(u)\\bigl(\\mathbf{S}_1(\\mathbf{\\beta},u)-\\frac{\\mathbf{S}_1(\\mathbf{\\beta},u)}{{S}_0(\\mathbf{\\beta},u)}{S}_0({\\beta},u)\\bigr)du\n+ \\sum_i(\\mathbf{Z}_i-\\frac{\\mathbf{S}_1(\\mathbf{\\beta},u)}{S_0(\\mathbf{\\beta},u)}\\bigr)dM_i(u)\\] and the Cox score is then the martingale integral \\[\\int_0^t \\sum_i(\\mathbf{Z}_i-\\frac{\\mathbf{S}_1(\\mathbf{\\beta},u)}{S_0(\\mathbf{\\beta},u)}\\bigr)dM_i(u).\\]\n\n\nExercise 3.3 (*)\nShow that, for a Cox model with a single binary covariate, the score test for the hypothesis \\(\\beta=0\\) based on the first and second derivative of \\(\\log\\mbox{PL}(\\beta)\\) (Equation (3.16)) is equal to the logrank test.}\nWith a single binary covariate \\(Z_i=I(i\\mbox{ is in group 1})\\), the Cox score \\[\\sum_i \\int_0^t\\left(Z_i-\\frac{S_1(\\beta,u)}{S_0(\\beta,u)}\\right)dN_i(u)\\] (with \\(S_0, S_1\\) defined in Exercise 3.2) reduces to \\[N_1(\\infty)-\\int_0^{\\infty}\\frac{Y_1(u)}{Y_0(u)+Y_1(u)}d(N_0+N_1)(u)\\] when \\(\\beta=0\\) and \\(t=\\infty\\). This is the numerator in the logrank test, \\(\\mbox{LR}(\\infty)\\), Section 3.2.2. With \\(S_2(\\beta,t)=\\sum_jZ_j^2Y_j(t)\\exp(\\beta Z_j)\\), minus the derivative of the Cox score is \\[\\sum_i\\int_0^t\\frac{S_0(\\beta,u)S_2(\\beta,u)-S_1(\\beta,u)^2}{S_0(\\beta,u)^2}dN_i(u)\\] which for \\(\\beta=0\\) and \\(t=\\infty\\) (when there are no ties) reduces to the hypergeometric variance, \\(v\\) (Section 3.2.2) \\[\\int_0^{\\infty}\\frac{Y_0(u)Y_1(u)}{(Y_0(u)+Y_1(u))^2}d(N_0+N_1)(u)\\] and the resulting score test is the logrank test.\n\n\nExercise 3.4 (*)\nShow that, for the stratified Cox model (3.20), the profile likelihood is given by (3.21) and the resulting Breslow estimator by (3.22).\nThe log-likelihood for the stratified Cox model based on the Jacod formula is \\[\\sum_j\\sum_{i\\in S_j}\\left(\\int_0^{\\infty}\\log\\bigl(Y_i(t)\\alpha_{0j}(t)\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)\\bigr)dN_i(t)-\\int_0^{\\infty}Y_i(t)\\alpha_{0j}(t)\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)dt\\right)\\] (Section 3.3). Taking derivative with respect to a single \\(\\alpha_{0j}(t)\\), we get \\[\\sum_{i \\in S_j}\\left(\\frac{1}{\\alpha_{0j}(t)}dN_i(t)-Y_i(t)\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)dt\\right),\\] and equating to 0 and solving leads to \\[\\widehat{\\alpha_{0j}(t)dt}=\\frac{\\sum_{i\\in S_j}dN_i(t)}{\\sum_{i \\in S_j}Y_i(t)\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)},\\] the jump in the Breslow estimator (3.22).\nInserting this into the Jacod formula leads to the profile likelihood \\[\\prod_j\\prod_{i\\in S_j}\\exp\\left(-\\int_0^{\\infty}Y_i(t)\\frac{\\sum_{\\ell\\in S_j}dN_\\ell(t)}{\\sum_{\\ell \\in S_j}Y_\\ell(t)\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_\\ell)}\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)dt\\right)\\] \\[\\times \\prod_j\\prod_{i\\in S_j}\\prod_t \\left(Y_i(t)\\frac{\\sum_{\\ell\\in S_j}dN_\\ell(t)}{\\sum_{\\ell \\in S_j}Y_\\ell(t)\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_\\ell)}\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)\\right)^{dN_i(t)},\\] where, in the first line, factors depending on \\(\\mathbf{\\beta}\\) cancel, and the remaining factors depending on \\(\\mathbf{\\beta}\\) are exactly (3.21).\n\n\nExercise 3.5 (*)\nConsider the situation in Section 3.4 with categorical covariates and show that the likelihood is given by \\[\n\\prod_{\\ell=1}^L\\prod_{\\mathbf{c}\\in {\\cal C}}(\\alpha_{0\\ell}\\theta_{\\mathbf{c}})^{N_{\\ell \\mathbf{c}}}\\exp(-\\alpha_{0\\ell}\\theta_{\\mathbf{c}} Y_{\\ell \\mathbf{c}}).\n\\]\nThe starting point is the Jacod formula where factor \\(i\\) is \\[\\prod_t (Y_i(t)\\alpha_i(t))^{dN_i(t)}\\exp(-\\int_0^{\\infty}Y_i(t)\\alpha_i(t)dt),\\] and when \\(\\alpha_i(t)=\\alpha_{0\\ell}\\mathbf{\\theta}_{\\mathbf{c}}\\) if \\(t\\in [s_{\\ell -1},s_{\\ell})\\) and \\(i\\) has covariates in category \\(\\mathbf{c}\\), this is proportional to \\[\\prod_{\\ell=1}^L(\\alpha_{0\\ell}\\mathbf{\\theta}_{\\mathbf{c}})^{N_{\\ell\\mathbf{c}}^i}\\exp(-\\sum_{\\ell=1}^LY_{\\ell\\mathbf{c}}^i\\mathbf{\\theta}_{\\mathbf{c}}),\\] where \\(N_{\\ell\\mathbf{c}}^i\\) is the number of events for subject \\(i\\) in \\([s_{\\ell -1},s_{\\ell})\\) and \\(Y_{\\ell\\mathbf{c}}^i\\) the time spent by subject \\(i\\) in \\([s_{\\ell -1},s_{\\ell})\\). Collecting factors from all subjects with covariates in category \\(\\mathbf{c}\\), the joint likelihood contribution from those subjects is \\[\\prod_{\\ell=1}^L(\\alpha_{0\\ell}\\mathbf{\\theta}_{\\mathbf{c}})^{N_{\\ell\\mathbf{c}}}\\exp(-\\sum_{\\ell=1}^LY_{\\ell\\mathbf{c}}\\mathbf{\\theta}_{\\mathbf{c}}),\\] where \\(N_{\\ell\\mathbf{c}}\\) and \\(Y_{\\ell\\mathbf{c}}\\) are the sums over those subjects of the individual values of \\(N_{\\ell\\mathbf{c}}^i\\) and \\(Y_{\\ell\\mathbf{c}}^i\\), respectively. The total likelihood is now the product over all categories \\(\\mathbf{c}\\).\n\n\nExercise 3.6 (*)\nDerive the estimating equations for the model studied in Section 3.8.4\nThe arguments are, in fact, identical to those used for the stratified Cox model in Exercise 3.4. The only difference appears due to the fact that the likelihood does not factorize over types, \\(\\nu\\)."
  },
  {
    "objectID": "Ch4.html#pbc3-trial-in-liver-cirrhosis",
    "href": "Ch4.html#pbc3-trial-in-liver-cirrhosis",
    "title": "4  Intuition for marginal models",
    "section": "PBC3 trial in liver cirrhosis",
    "text": "PBC3 trial in liver cirrhosis\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\npbc3 <- read.csv(\"data/pbc3.csv\")\npbc3$followup<-pbc3$days/365.25\npbc3$fail <- ifelse(pbc3$status != 0, 1, 0) # event/failure indicator\npbc3$tment_char <- ifelse(pbc3$tment == 0, \"Placebo\", \"CyA\")\n# Add transformations of covariates \npbc3$albnorm <- with(pbc3, (alb-35)*(alb>35))\npbc3$alb10 <- with(pbc3, alb/10)\npbc3$alb2 <- with(pbc3, alb10*alb10)\n\npbc3$bilihigh <- with(pbc3, (bili-17.1)*(bili>17.1))\npbc3$bilitoohigh <- with(pbc3, (bili-34.2)*(bili>34.2))\npbc3$bilimuchtoohigh <- with(pbc3, (bili-51.3)*(bili>51.3))\npbc3$bili100 <- with(pbc3, bili/100)\npbc3$bili2 <- with(pbc3, bili100*bili100)\n\npbc3$log2bili <- with(pbc3, log2(bili))\npbc3$log2bili2 <- with(pbc3, log2bili*log2bili)\n\npbc3$logbilihigh <- with(pbc3, (log2bili-log2(17.1))*(bili>17.1))\npbc3$logbilitoohigh <- with(pbc3, (log2bili-log2(34.2))*(bili>34.2))\npbc3$logbilimuchtoohigh <- with(pbc3, (log2bili-log2(51.3))*(bili>51.3))\n\n\n\n\n\n\nCode show/hide\nproc import out=pbc3\n    datafile=\"data/pbc3.csv\"\n    dbms=csv replace;\nrun;\n    \ndata pbc3; \n    set pbc3;\n    followup=days/365.25; /* time in years */\n    albnorm=(alb-35)*(alb>35);\n    alb10=alb/10; alb2=alb10*alb10;\n    bilihigh=(bili-17.1)*(bili>17.1);\n    bilitoohigh=(bili-34.2)*(bili>34.2);\n    bilimuchtoohigh=(bili-51.3)*(bili>51.3);\n    bili100=bili/100; bili2=bili100*bili100;\n    log2bili=log2(bili);\n    logbilihigh=(log2bili-log2(17.1))*(bili>17.1);\n    logbilitoohigh=(log2bili-log2(34.2))*(bili>34.2);\n    logbilimuchtoohigh=(log2bili-log2(51.3))*(bili>51.3);\n    log2bili2=log2bili*log2bili;\nrun;\n\n\n\n\n\n\n\nFigure 4.2\n\nRSAS\n\n\n\n\nCode show/hide\n# General plotting style \nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20),\n        legend.position = \"bottom\", \n        legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        legend.key.size = unit(2,\"line\"))\n\n# Kaplan-Meier estimate per treatment\n# Please note conf.type=\"log-log\"\nlibrary(survival)\nkmfit <- survfit(Surv(days, status != 0) ~ tment, data = pbc3, conf.type=\"log-log\")\n\n# Collect data for plot\n# Note that the standard errors produced by survfit are for the cumulative hazard\nkmdata <- data.frame(surv = kmfit$surv, \n                     time = kmfit$time, \n                     tment = c(rep(names(kmfit$strata)[1], kmfit$strata[1]), \n                               rep(names(kmfit$strata)[2], kmfit$strata[2])))\n\n# Create Figure 4.2\nfig4.2 <- ggplot(aes(x = time / 365.25, y = surv, linetype = tment), data = kmdata) + \n  geom_step(linewidth = 1) + \n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\", \"CyA\")) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Survival probability\") +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 6), breaks = seq(0, 6, by = 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), limits = c(0,1)) +\n  theme_general\n\nfig4.2\n\n\n\n\n\n\n\n\n\nCode show/hide\n* Kaplan-Meier plot per treatment;\n* Using proc lifetest;\nproc lifetest data=pbc3 notable plots=(survival(nocensor));\n  time followup*status(0);\n    strata tment;\nrun;\n\n* Using proc phreg;\nproc phreg data=pbc3;\n    model days*status(0)=;\n    strata tment;\n    baseline out=survdat survival=km / method=pl;\nrun;\n\ndata survdat;\n    set survdat; \n    daysyears = days/365.25; \nrun; \n\nproc gplot data=survdat;\nplot km*daysyears=tment/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none label=(a=90 'Survival probability');\n    symbol1  v=none i=stepjl c=red;\n    symbol2  v=none i=stepjl c=blue;\nrun;\n\n\n\n\n\n\n\nIn-text: Kaplan-Meier estimates at 2 years\n\nRSAS\n\n\n\n\nCode show/hide\n# 95 c.i. uses conf.type=\"log-log\" - see above\nsummary(kmfit,times=2*365.25)\n\n\nCall: survfit(formula = Surv(days, status != 0) ~ tment, data = pbc3, \n    conf.type = \"log-log\")\n\n                tment=0 \n        time       n.risk      n.event     survival      std.err lower 95% CI \n    730.5000     106.0000      27.0000       0.8322       0.0296       0.7645 \nupper 95% CI \n      0.8819 \n\n                tment=1 \n        time       n.risk      n.event     survival      std.err lower 95% CI \n    730.5000     111.0000      24.0000       0.8458       0.0292       0.7782 \nupper 95% CI \n      0.8941 \n\n\n\n\n\n\nCode show/hide\nproc lifetest data=pbc3 timelist=2;\n  time followup*status(0);\n  strata tment;\nrun;\n\nproc print data=survdat;\n  where days<=2*365.25;\nrun;\n\n\n\n\n\n\n\nFigure 4.4\n\nRSAS\n\n\n\n\nCode show/hide\n# Poisson model fit (like in Chapter 2)\n# Cuts\ncuts <- c(0, 2, 4) * 365.25\n# event/failure indicator\npbc3$fail <- ifelse(pbc3$status != 0, 1, 0)\n# Make the data ready using survSplit\npbc3mult <- survSplit(Surv(days, fail) ~ ., \n                      pbc3,\n                      cut = cuts[-1], \n                      episode = \"timegroup\")\n\n# Risk time\npbc3mult$risktime <- pbc3mult$days - cuts[pbc3mult$timegroup] \n\n# Summarize\nlibrary(dplyr)\nsumdata <- pbc3mult %>% \n  group_by(tment, timegroup) %>% \n  summarise(fail = sum(fail), \n            risktime = sum(days - cuts[timegroup])#,\n            #logrisktime = sum(log(days))\n  )\nsumdata <- as.data.frame(sumdata)\n\n# Placebo KM data from figure 4.2 model fit\ntment1 <- subset(kmdata, tment == \"tment=1\")\n# Estimated hazard per time group\nsumdata$hazard_timegroup <- sumdata$fail / sumdata$risktime\n# Add a numeric version of the treatment to the NA estimates\nkmdata$tmentnum <- ifelse(kmdata$tment == \"tment=0\", 0, 1)\n# Add piecewise constant hazard to data\nkmdata$pwch <- NULL\n\n# Between time 0 and 2\nkmdata$pwch[kmdata$time <= 2 * 365.25] <- kmdata$time[kmdata$time <= 2  * 365.25] * \n  (sumdata$hazard_timegroup[1] * (1-kmdata$tmentnum[kmdata$time <= 2  * 365.25]) + \n     sumdata$hazard_timegroup[4] * (kmdata$tmentnum[kmdata$time <= 2 * 365.25]))\n\n# Between time 2 and 4\nkmdata$pwch[kmdata$time > 2  * 365.25 & kmdata$time <= 4 * 365.25] <- 2  * 365.25 * \n  (sumdata$hazard_timegroup[1]\n   * (1-kmdata$tmentnum[kmdata$time > 2  * 365.25& kmdata$time <= 4 * 365.25]) + \n     sumdata$hazard_timegroup[4] \n   * (kmdata$tmentnum[kmdata$time > 2  * 365.25& kmdata$time <= 4 * 365.25])) + \n  (kmdata$time[kmdata$time > 2 * 365.25 & kmdata$time <= 4 * 365.25] - 2 * 365.25) * \n  (sumdata$hazard_timegroup[2] \n   * (1-kmdata$tmentnum[kmdata$time > 2  * 365.25& kmdata$time <= 4 * 365.25]) + \n     sumdata$hazard_timegroup[5] \n   * (kmdata$tmentnum[kmdata$time > 2 * 365.25 & kmdata$time <= 4 * 365.25]))\n\n# After time 4\nkmdata$pwch[kmdata$time > 4 * 365.25] <- 2 * 365.25 * \n  (sumdata$hazard_timegroup[1] * (1-kmdata$tmentnum[kmdata$time > 4 * 365.25]) + \n     sumdata$hazard_timegroup[4] * (kmdata$tmentnum[kmdata$time > 4 * 365.25])) + \n  2 * 365.25 *\n  (sumdata$hazard_timegroup[2] * (1-kmdata$tmentnum[kmdata$time > 4 * 365.25]) + \n     sumdata$hazard_timegroup[5] * (kmdata$tmentnum[kmdata$time > 4 * 365.25])) + \n  (kmdata$time[kmdata$time > 4 * 365.25] - 4 * 365.25) * \n  (sumdata$hazard_timegroup[3] * (1-kmdata$tmentnum[kmdata$time > 4 * 365.25]) + \n     sumdata$hazard_timegroup[6] * (kmdata$tmentnum[kmdata$time > 4 * 365.25]))\n\n# Change to estimated survival (plug-in formula)\nkmdata$pwcs <- exp(-kmdata$pwch)\n# Reformat for plot\npiecepdata <- data.frame(surv = c(kmdata$surv, kmdata$pwcs), \n                         time = rep(kmdata$time, 2),\n                         tmentnum = rep(kmdata$tmentnum, 2),\n                         type = c(rep(\"Kaplan-Meier\", length(kmdata$time)), \n                                  rep(\"Piece-wise exponential\", length(kmdata$time))))\n# Only for treatment 1\npiecepdata1 <- subset(piecepdata, tmentnum == 1)\n\n# Create Figure 4.4\nfig4.4 <- ggplot(aes(x = time / 365.25, y = surv, linetype = type), \n                data = subset(piecepdata1, type == \"Kaplan-Meier\")) + \n  geom_step(linewidth = 1) + \n  geom_line(aes(x = time/ 365.25, y = surv, linetype = type), linewidth = 1,\n            data = subset(piecepdata1, type == \"Piece-wise exponential\")) + \n  labs(linetype = \"Type\") + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Survival probability\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general\nfig4.4\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata survdat; \n    set survdat;\n    if days<=2 * 365.25 then\n    pwch=exp(-(days*(27.0000000/104856*(1-tment)+24.0000000/107931.5*tment)));\n    if 2 * 365.25 <days<=4 * 365.25 then\n    pwch=exp(-(2* 365.25*(27.0000000/104856*(1-tment)+24.0000000/107931.5*tment)\n    +(days-2* 365.25)*(17.0000000/49673*(1-tment)+18.0000000/50284*tment)));\n    if 4 * 365.25 <days then\n    pwch=exp(-(2* 365.25 *(27.0000000/104856*(1-tment)+24.0000000/107931.5*tment)\n    +(2* 365.25)*(17.0000000/49673*(1-tment)+18.0000000/50284*tment)\n    +(days-4* 365.25)*(2.0000000/8642*(1-tment)+2.0000000/7599*tment)));\nrun;\n\ndata survdat;\n    set survdat; \n    daysyears = days/365.25; \nrun; \n\nproc gplot data=survdat; \n    where tment=1;\n    plot (km pwch)*daysyears/overlay haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none label=(a=90 'Survival probability');\n    symbol1  v=none i=stepjl r=1 c=red;\n    symbol2 v=none i=join r=1 c=blue;\nrun;\nquit;\n\n\n\n\n\n\n\nFigure 4.5\n\nRSAS\n\n\n\n\nCode show/hide\n# Cox model\ncoxfit <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili, data = pbc3, \n                 method = \"breslow\")\n# Unique days times \nfu <- sort(unique(pbc3$days))\n# Data for prediction\npreddata <- data.frame(tment = c(rep(0, length(fu)), rep(1, length(fu))), \n                       alb = rep(38, length(fu) * 2),\n                       log2bili = rep(log2(45), length(fu) * 2), \n                       days = c(fu, fu),\n                       status = rep(1, length(fu) * 2))\n\n# Linear predictor\npreds <- predict(coxfit, newdata = preddata, type = \"survival\")\npreddata$preds <- preds\n\n# Create Figure 4.5\nfig4.5 <- ggplot(aes(x = days / 365.25, y = preds, linetype = as.factor(tment)), \n                data = preddata) + \n  geom_step(linewidth = 1) + \n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\", \"CyA\")) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Estimated survival function\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general \nfig4.5\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata cov;\n    tment=0; alb=38; log2bili=log2(45); output;\n    tment=1; alb=38; log2bili=log2(45); output;\nrun;\n\nproc phreg data=pbc3;\n    model days*status(0)=tment alb log2bili/rl;\n    baseline out=predsurv survival=surv covariates=cov/ method=breslow;\nrun;\n\ndata predsurv;\n    set predsurv; \n    daysyears = days/365.25; \nrun; \n\nproc gplot data=predsurv;\n    plot surv*daysyears=tment/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none label=(a=90 'Estimated survival function');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\nrun;\nquit;\n\n\n\n\n\n\n\nFigure 4.6\n\nRSAS\n\n\n\n\nCode show/hide\n# Add log(-log(S(t)))\npreddata$logminlogsurv <- with(preddata, log(-log(preds)))\n\n# Create Figure 4.6\nfig4.6 <- ggplot(aes(x = days / 365.25, y = logminlogsurv, linetype = as.factor(tment)), \n                data = preddata) + \n  geom_step(linewidth = 1) + \n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\", \"CyA\")) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"log(-log(survival function))\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05))) +\n  theme_general\n\nfig4.6\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata predsurv2; \n    set predsurv; \n    logminlogsurv = log(-log(surv)); \nrun; \n\ndata predsurv2;\n    set predsurv2; \n    daysyears = days/365.25; \nrun; \n\nproc gplot data=predsurv2;\n    plot logminlogsurv*daysyears=tment/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=-7 to 0 by 1 minor=none label=(a=90 'log(-log(survival function))');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\nrun;\nquit;\n\n\n\n\n\n\n\nFigure 4.7\n\nRSAS\n\n\n\n\nCode show/hide\n# g-formula\n# We want to predict responses if all subjects had been given both CyA and placebo (tment = 0,1)\n# We need to have n survival curves * 2\n# make a double data set with extra Z\npbc3_counterfact <- pbc3\npbc3_counterfact$tment <- ifelse(pbc3_counterfact$tment == 1, 0, 1) # opposite treatment\npbc3_double <- rbind(pbc3, pbc3_counterfact)\n\n# Baseline survival\ncoxfit <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili, data = pbc3, \n                 method = \"breslow\")\npred <- survfit(coxfit, newdata = data.frame(tment = 0, alb = 0, log2bili = 0))\nallsurv <-\n  lapply(1:nrow(pbc3_double),\n       function(i)\n         pred$surv ^\n         exp(coef(coxfit)[1] * pbc3_double$tment[i] +\n               coef(coxfit)[2] * pbc3_double$alb[i] +\n               coef(coxfit)[3] * pbc3_double$log2bili[i]))\npotout <-\n  data.frame(surv = unlist(allsurv),\n           tment = rep(pbc3_double$tment, each = length(pred$time)),\n           time = rep(pred$time, times = nrow(pbc3)*2))\n\n# Average over values\nlibrary(dplyr)\nsumdata <- potout %>%\n  group_by(tment, time) %>%\n  summarise(average_pred = mean(surv, na.rm = TRUE),\n            .groups = c(\"keep\"))\nsumdata <- as.data.frame(sumdata)\n\n# Create Figure 4.7\nfig4.7 <- ggplot(aes(x = time / 365.25, y = average_pred, linetype = as.factor(tment)),\n                data = sumdata) +\n  geom_step(linewidth = 1) +\n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\", \"CyA\")) +\n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Estimated survival function (g-formula)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general \n\nfig4.7\n\n\n\n\n\n\n\n\n\nCode show/hide\nproc phreg data=pbc3;\n    class tment;\n    model days*status(0)=tment alb log2bili / rl;\n    baseline out=gsurv survival=surv stderr=sd /\n    method=breslow diradj group=tment;\nrun;\ndata gsurv;\n    set gsurv; \n    daysyears = days/365.25; \nrun; \nproc gplot data=gsurv;\n    plot surv*daysyears=tment / haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none\n  label=(a=90 'Estimated survival function (g-formula)');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\nrun;\nquit;\n\n\n\n\n\n\n\nIn-text: g-formula from Cox\n\nRSAS\n\n\n\nUsing riskRegression package\n\n\nCode show/hide\nlibrary(riskRegression)\nsubpbc<-subset(pbc3, !is.na(alb))\nsubpbc$tment<-relevel(factor(subpbc$tment),ref=\"0\")\ncfit <- coxph(Surv(days, fail) ~ tment + alb + log2bili, data = subpbc, \n                 method = \"breslow\",y=TRUE,x=TRUE)\natecfit<-ate(cfit, data = subpbc, treatment = \"tment\", times = 2*365.25,\n             cause=1, verbose=F)\nsummary(atecfit,type=\"meanRisk\",se=T)\n\n\n     Average treatment effect \n\n - Treatment            : tment (2 levels: \"0\" \"1\")\n - Event                : fail (cause: 1, censoring: 0)\n - Time  [min;max]      : days [1;2150]\n - Eval. time          : 730.5\n      number at risk 0     102\n      number at risk 1     110\n\n Estimation procedure \n - Estimator  : G-formula\n - Uncertainty: Gaussian approximation \n                where the variance is estimated via the influence function \n\n Testing procedure\n - Null hypothesis     : given two treatments (A,B) and a specific timepoint, equal risks \n - Confidence level    : 0.95\n\n Results: \n - Standardized risk between time zero and 'time', reported on the scale [0;1] (probability scale)\n   (average risk when treating all subjects with one treatment)\n\n time tment  risk     se          ci\n  730     0 0.201 0.0271 [0.15;0.25]\n  730     1 0.133 0.0217 [0.09;0.18]\n\n risk            : estimated standardized risk \n ci              : pointwise confidence intervals \n\n\nCode show/hide\nsummary(atecfit,type=\"diffRisk\",se=T)\n\n\n     Average treatment effect \n\n - Treatment            : tment (2 levels: \"0\" \"1\")\n - Event                : fail (cause: 1, censoring: 0)\n - Time  [min;max]      : days [1;2150]\n - Eval. time          : 730.5\n      number at risk 0     102\n      number at risk 1     110\n\n Estimation procedure \n - Estimator  : G-formula\n - Uncertainty: Gaussian approximation \n                where the variance is estimated via the influence function \n\n Testing procedure\n - Null hypothesis     : given two treatments (A,B) and a specific timepoint, equal risks \n - Confidence level    : 0.95\n\n Results: \n - Difference in standardized risk (B-A) between time zero and 'time' \n                reported on the scale [-1;1] (difference between two probabilities)\n (difference in average risks when treating all subjects with the experimental treatment (B),\n                                vs. treating all subjects with the reference treatment (A))\n\n time tment=A tment=B difference     se            ci p.value\n  730       0       1    -0.0681 0.0259 [-0.12;-0.02] 0.00855\n\n difference      : estimated difference in standardized risks \n ci              : pointwise confidence intervals \n p.value         : (unadjusted) p-value \n\n\nCode show/hide\n# Survival instead of failure risk\n1-atecfit$meanRisk$estimate\n\n\n[1] 0.7989143 0.8670633\n\n\nCode show/hide\n# Bootstrap\natecfitB<-ate(cfit, data = subpbc, treatment = \"tment\", times = 2*365.25,\n             cause=1, verbose=F, B=100)\nsummary(atecfitB,type=\"meanRisk\",se=T)\n\n\n     Average treatment effect \n\n - Treatment            : tment (2 levels: \"0\" \"1\")\n - Event                : fail (cause: 1, censoring: 0)\n - Time  [min;max]      : days [1;2150]\n - Eval. time          : 730.5\n      number at risk 0     102\n      number at risk 1     110\n\n Estimation procedure \n - Estimator  : G-formula\n - Uncertainty: Percentile bootstrap based on 100 bootstrap samples\n                that were drawn with replacement from the original data.\n\n Testing procedure\n - Null hypothesis     : given two treatments (A,B) and a specific timepoint, equal risks \n - Confidence level    : 0.95\n\n Results: \n - Standardized risk between time zero and 'time', reported on the scale [0;1] (probability scale)\n   (average risk when treating all subjects with one treatment)\n\n time tment  risk risk.boot     se          ci\n  730     0 0.201     0.199 0.0261 [0.15;0.26]\n  730     1 0.133     0.132 0.0192 [0.10;0.17]\n\n risk            : estimated standardized risk \n risk.boot       : average value over the bootstrap samples \n ci              : pointwise confidence intervals \n\n\nCode show/hide\nsummary(atecfitB,type=\"diffRisk\",se=T)\n\n\n     Average treatment effect \n\n - Treatment            : tment (2 levels: \"0\" \"1\")\n - Event                : fail (cause: 1, censoring: 0)\n - Time  [min;max]      : days [1;2150]\n - Eval. time          : 730.5\n      number at risk 0     102\n      number at risk 1     110\n\n Estimation procedure \n - Estimator  : G-formula\n - Uncertainty: Percentile bootstrap based on 100 bootstrap samples\n                that were drawn with replacement from the original data.\n\n Testing procedure\n - Null hypothesis     : given two treatments (A,B) and a specific timepoint, equal risks \n - Confidence level    : 0.95\n\n Results: \n - Difference in standardized risk (B-A) between time zero and 'time' \n                reported on the scale [-1;1] (difference between two probabilities)\n (difference in average risks when treating all subjects with the experimental treatment (B),\n                                vs. treating all subjects with the reference treatment (A))\n\n time tment=A tment=B difference difference.boot     se            ci p.value\n  730       0       1    -0.0681         -0.0668 0.0239 [-0.12;-0.02]       0\n\n difference      : estimated difference in standardized risks \n difference.boot : average value over the bootstrap samples \n ci              : pointwise confidence intervals \n p.value         : (unadjusted) p-value \n\n\n\n\nUsing mets package\n\n\nCode show/hide\nlibrary(mets)\ncfitmets <- phreg(Surv(days, fail) ~ tment + alb + log2bili, data = subpbc)\nsummary(survivalG(cfitmets, subpbc, time = 2*365.25))\n\n\nrisk:\n      Estimate Std.Err   2.5%  97.5%    P-value\nrisk0   0.7989 0.02722 0.7455 0.8522 2.325e-189\nrisk1   0.8671 0.02171 0.8245 0.9096  0.000e+00\n\nAverage Treatment effects (G-estimator) :\n   Estimate Std.Err    2.5%  97.5%  P-value\np1   0.0682 0.02622 0.01681 0.1196 0.009297\n\nAverage Treatment effect ratio (G-estimator) :\n     Estimate    Std.Err     2.5%    97.5%    P-value\n[p1] 1.085375 0.03484226 1.017085 1.153664 0.01427275\n\n\n\n\n\n\n\nCode show/hide\nproc print data=gsurv;\n  where days=714;\nrun;\n\n\n\n\n\n\n\nFigure 4.8\n\nRSAS\n\n\n\n\nCode show/hide\n# Product representation based on Breslow estimator\n# Survival prediction\npreds <- basehaz(coxfit, centered = F)\n\n# For tment=0, alb=38, log2bili=log2(45)\ndA_tment0 <- diff(c(0, preds$hazard \n                    * exp(coef(coxfit)[1]*0 + coef(coxfit)[2]*38 + coef(coxfit)[3] * log2(45) )))\nsurv_tment0 <- cumprod(1 - dA_tment0)\n\n# For tment=1, alb=38, log2bili=log2(45)\ndA_tment1 <- diff(c(0, preds$hazard \n                    * exp(coef(coxfit)[1]*1 + coef(coxfit)[2]*38 + coef(coxfit)[3] * log2(45) )))\nsurv_tment1 <- cumprod(1 - dA_tment1)\n\npdata <- data.frame(surv = c(surv_tment0, surv_tment1),\n                    time = c(preds$time, preds$time), \n                    tment = c(rep(\"0\", length(preds$time)),\n                              rep(\"1\", length(preds$time))))\n\n# Create Figure 4.8\nfig4.8 <- ggplot(aes(x = time / 365.25, y = surv, linetype = as.factor(tment)), \n                data = pdata) + \n  geom_step(linewidth = 1) + \n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\", \"CyA\")) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Estimated survival function\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general\n\nfig4.8\n\n\n\n\n\n\n\n\n\nCode show/hide\nproc phreg data=pbc3;\n    *class tment;\n    model days*status(0)=tment alb log2bili/rl;\n    baseline out=predsurvpl survival=surv covariates=cov / method=pl;\nrun;\n\ndata predsurvpl;\n    set predsurvpl; \n    daysyears = days/365.25; \nrun; \n\nproc gplot data=predsurvpl;\n    plot surv*daysyears=tment/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none label=(a=90 'Estimated survival function');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\nrun;\nquit;\n\n\n\n\n\n\n\nTable 4.1\n\nRSAS\n\n\n\nNon-parametric using survival package\n\n\nCode show/hide\nlibrary(survival)\nnp_km <- survfit(Surv(days/365.25, status != 0) ~ tment, data = pbc3)\nprint(np_km,rmean=3)\n\n\nCall: survfit(formula = Surv(days/365.25, status != 0) ~ tment, data = pbc3)\n\n          n events rmean* se(rmean) median 0.95LCL 0.95UCL\ntment=0 173     46   2.61    0.0633     NA    4.51      NA\ntment=1 176     44   2.68    0.0565     NA    4.66      NA\n    * restricted mean with upper limit =  3 \n\n\n\n\nNon-parametric using mets package\n\n\nCode show/hide\n# non-parametric could also be done using mets package\nlibrary(mets)\nout1 <- phreg(Surv(days/365.25,fail)~strata(tment),data=pbc3)\nrm1 <- resmean.phreg(out1,times=3)\nsummary(rm1)\n\n\n  strata times    rmean   se.rmean years.lost\n1      0     3 2.606095 0.06325665  0.3939052\n2      1     3 2.677657 0.05654602  0.3223425\n\n\nCode show/hide\nresmeanIPCW(Event(days/365.25,fail)~1, data=subset(pbc3,tment==0),time=3,model=\"linear\")\n\n\n\n   n events\n 173     36\n\n 173 clusters\ncoeffients:\n            Estimate  Std.Err     2.5%    97.5% P-value\n(Intercept) 2.605894 0.063305 2.481818 2.729969       0\n\nexp(coeffients):\n            Estimate   2.5%  97.5%\n(Intercept)   13.543 11.963 15.332\n\n\nCode show/hide\nresmeanIPCW(Event(days/365.25,fail)~1, data=subset(pbc3,tment==1),time=3,model=\"linear\")\n\n\n\n   n events\n 176     32\n\n 176 clusters\ncoeffients:\n            Estimate  Std.Err     2.5%    97.5% P-value\n(Intercept) 2.677458 0.056607 2.566511 2.788405       0\n\nexp(coeffients):\n            Estimate   2.5%  97.5%\n(Intercept)   14.548 13.020 16.255\n\n\nCode show/hide\n# or\noptions(contrasts=c(\"contr.treatment\", \"contr.poly\"))\nout<-resmeanIPCW(Event(days/365.25,fail)~-1+factor(tment),data=pbc3,time=3,model=\"linear\",\n            cens.model = ~strata(tment))\nestimate(out)\n\n\n               Estimate Std.Err  2.5% 97.5% P-value\nfactor(tment)0    2.606 0.06330 2.482 2.730       0\nfactor(tment)1    2.677 0.05661 2.567 2.788       0\n\n\n\n\nCode for rest of table\n\n\nCode show/hide\n#### Non-parametric using RISCA package\nkmdata <- data.frame(surv = np_km$surv, \n                      time = np_km$time, \n                     strata = c(rep(names(np_km$strata[1]), np_km$strata[[1]]), \n                              rep(names(np_km$strata[2]), np_km$strata[[2]])))\n# Restrict to each treat\nkmdata0 <- subset(kmdata, strata == \"tment=0\")\nkmdata1 <- subset(kmdata, strata == \"tment=1\")\n\n# rmst\nlibrary(RISCA)\nrmst0 <- rmst(times = kmdata0$time, surv.rates = kmdata0$surv, max.time = 3, type = \"s\")\nrmst1 <- rmst(times = kmdata1$time, surv.rates = kmdata1$surv, max.time = 3, type = \"s\")\n\n# Cox model, alb = 38, bili = 45\n# Cox model fit with covariates tment, alb and log2bili\ncoxfit <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili, data = pbc3, \n                method = \"breslow\")\n\n# Unique followup times \nfu <- sort(unique(pbc3$days))\n\n# Data for prediction\npreddata1 <- data.frame(tment = c(rep(0, length(fu)), rep(1, length(fu))), \n                       alb = rep(38, length(fu) * 2),\n                       log2bili = rep(log2(45), length(fu) * 2), \n                       days = c(fu, fu),\n                       status = rep(1, length(fu) * 2)\n)\n\n# Linear predictor\npreds1 <- predict(coxfit, newdata = preddata1, type = \"survival\")\n\npreddata1$preds <- preds1\n\ncox10 <- subset(preddata1, tment == \"0\")\ncox11 <- subset(preddata1, tment == \"1\")\n\n# Rmst \nrmstcox10 <- rmst(times = cox10$days, surv.rates = cox10$preds, max.time = 3 * 365.25, type = \"s\")\nrmstcox11 <- rmst(times = cox11$days, surv.rates = cox11$preds, max.time = 3 * 365.25, type = \"s\")\n\n# Cox for alb = 20 and bili = 90 \n\n# Data for prediction\npreddata2 <- data.frame(tment = c(rep(0, length(fu)), rep(1, length(fu))), \n                        alb = rep(20, length(fu) * 2),\n                        log2bili = rep(log2(90), length(fu) * 2), \n                        days = c(fu, fu),\n                        status = rep(1, length(fu) * 2)\n)\n\n# Linear predictor\npreds2 <- predict(coxfit, newdata = preddata2, type = \"survival\")\n\npreddata2$preds <- preds2\n\ncox20 <- subset(preddata2, tment == \"0\")\ncox21 <- subset(preddata2, tment == \"1\")\n\n# Rmst \nrmstcox20 <- rmst(times = cox20$days, surv.rates = cox20$preds, max.time = 3 * 365.25, type = \"s\")\nrmstcox21 <- rmst(times = cox21$days, surv.rates = cox21$preds, max.time = 3 * 365.25, type = \"s\")\n\n# Cox model, g-formula\n\n# We want to predict responses if all subjects had been given both CyA and placebo (tment = 0,1)\n# We need to have n survival curves * 2\n# make a double data set with extra Z\npbc3_counterfact <- pbc3\npbc3_counterfact$tment <- ifelse(pbc3_counterfact$tment == 1, 0, 1) # opposite treatment\npbc3_double <- rbind(pbc3, pbc3_counterfact)\n\n# Baseline survival\npred <- survfit(coxfit, newdata = data.frame(tment = 0, alb = 0, log2bili = 0))\n\nallsurv <-\n  lapply(1:nrow(pbc3_double),\n         function(i)\n           pred$surv ^\n           exp(coef(coxfit)[1] * pbc3_double$tment[i] +\n                 coef(coxfit)[2] * pbc3_double$alb[i] +\n                 coef(coxfit)[3] * pbc3_double$log2bili[i]))\n\npotout <-\n  data.frame(surv = unlist(allsurv),\n             tment = rep(pbc3_double$tment, each = length(pred$time)),\n             time = rep(pred$time, times = nrow(pbc3)*2)\n  )\n\n# Average over values\nrequire(dplyr)\nsumdata <- potout %>%\n  group_by(tment, time) %>%\n  summarise(average_pred = mean(surv, na.rm = TRUE),\n            .groups = c(\"keep\"))\nsumdata <- as.data.frame(sumdata)\n\n\n# Split data per group\ncoxg0 <- subset(sumdata, tment == \"0\")\ncoxg1 <- subset(sumdata, tment == \"1\")\n\n# Rmst \nrmstcoxg0 <- rmst(times = coxg0$time, surv.rates = coxg0$average_pred, max.time = 3 * 365.25, type = \"s\")\nrmstcoxg1 <- rmst(times = coxg1$time, surv.rates = coxg1$average_pred, max.time = 3 * 365.25, type = \"s\")\n\n##### BOOTSTRAP FOR SE'S #####\n\n# Resample data sets \n\nB<-200\nbootdata <- list()\nkmres <- cox1res <- cox2res <- coxgres <- list()\n\n#colnames(kmres) <- colnames(cox1res) <- colnames(cox2res) <- colnames(coxgres) <- c(\"rmst0\", \"rmst1\")\n\n\nfor (b in 1:B){\n  bootdata[[b]] <- pbc3[sample(1:nrow(pbc3), size = nrow(pbc3), replace = T),]\n  \n  ###### KM #######\n  np_km <- survfit(Surv(days, status != 0) ~ tment, data = bootdata[[b]])\n  \n  kmdata <- data.frame(surv = np_km$surv, \n                       time = np_km$time, \n                       strata = c(rep(names(np_km$strata[1]), np_km$strata[[1]]), \n                                  rep(names(np_km$strata[2]), np_km$strata[[2]])))\n  # Restrict to each treat\n  kmdata0 <- subset(kmdata, strata == \"tment=0\")\n  kmdata1 <- subset(kmdata, strata == \"tment=1\")\n  \n  # rmst\n  rmst0 <- rmst(times = kmdata0$time, surv.rates = kmdata0$surv, max.time = 3 * 365.25, type = \"s\")\n  rmst1 <- rmst(times = kmdata1$time, surv.rates = kmdata1$surv, max.time = 3 * 365.25, type = \"s\")\n\n  kmres[[b]] <- c(rmst0, rmst1)\n  \n  \n  ###### Cox 1 #######\n  \n  coxfit <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili, data = bootdata[[b]], \n                  method = \"breslow\")\n  \n  # Unique followup times \n  fu <- sort(unique(pbc3$days))\n  \n  # Data for prediction\n  preddata1 <- data.frame(tment = c(rep(0, length(fu)), rep(1, length(fu))), \n                          alb = rep(38, length(fu) * 2),\n                          log2bili = rep(log2(45), length(fu) * 2), \n                          days = c(fu, fu),\n                          status = rep(1, length(fu) * 2))\n  \n  # Linear predictor\n  preds1 <- predict(coxfit, newdata = preddata1, type = \"survival\")\n  preddata1$preds <- preds1\n  cox10 <- subset(preddata1, tment == \"0\")\n  cox11 <- subset(preddata1, tment == \"1\")\n  \n  # Rmst \n  rmstcox10 <- rmst(times = cox10$days, surv.rates = cox10$preds, max.time = 3 * 365.25, type = \"s\")\n  rmstcox11 <- rmst(times = cox11$days, surv.rates = cox11$preds, max.time = 3 * 365.25, type = \"s\")\n    cox1res[[b]] <- c(rmstcox10, rmstcox11)\n  \n  ###### Cox 2 #######\n\n  # Cox for alb = 20 and bili = 90   \n  # Data for prediction\n  preddata2 <- data.frame(tment = c(rep(0, length(fu)), rep(1, length(fu))), \n                          alb = rep(20, length(fu) * 2),\n                          log2bili = rep(log2(90), length(fu) * 2), \n                          days = c(fu, fu),\n                          status = rep(1, length(fu) * 2))\n  \n  # Linear predictor\n  preds2 <- predict(coxfit, newdata = preddata2, type = \"survival\")\n  preddata2$preds <- preds2\n  cox20 <- subset(preddata2, tment == \"0\")\n  cox21 <- subset(preddata2, tment == \"1\")\n  \n  # Rmst \n  rmstcox20 <- rmst(times = cox20$days, surv.rates = cox20$preds, max.time = 3 * 365.25, type = \"s\")\n  rmstcox21 <- rmst(times = cox21$days, surv.rates = cox21$preds, max.time = 3 * 365.25, type = \"s\")\n  cox2res[[b]] <- c(rmstcox20, rmstcox21) \n  \n  \n  ##### Cox - g formula #######\n  \n  # We want to predict responses if all subjects had been given both CyA and placebo (tment = 0,1)\n  # We need to have n survival curves * 2\n  # make a double data set with extra Z\n  pbc3_counterfact <- bootdata[[b]]\n  pbc3_counterfact$tment <- ifelse(pbc3_counterfact$tment == 1, 0, 1) # opposite treatment\n  pbc3_double <- rbind(bootdata[[b]], pbc3_counterfact)\n  \n  # Baseline survival\n  pred <- survfit(coxfit, newdata = data.frame(tment = 0, alb = 0, log2bili = 0))\n  \n  allsurv <-\n    lapply(1:nrow(pbc3_double),\n           function(i)\n             pred$surv ^\n             exp(coef(coxfit)[1] * pbc3_double$tment[i] +\n                   coef(coxfit)[2] * pbc3_double$alb[i] +\n                   coef(coxfit)[3] * pbc3_double$log2bili[i]))\n  \n  potout <-\n    data.frame(surv = unlist(allsurv),\n               tment = rep(pbc3_double$tment, each = length(pred$time)),\n               time = rep(pred$time, times = nrow(pbc3)*2)\n    )\n  \n  # Average over values\n  require(dplyr)\n  sumdata <- potout %>%\n    group_by(tment, time) %>%\n    summarise(average_pred = mean(surv, na.rm = TRUE),\n              .groups = c(\"keep\"))\n  sumdata <- as.data.frame(sumdata)\n\n  # Split data per group\n  coxg0 <- subset(sumdata, tment == \"0\")\n  coxg1 <- subset(sumdata, tment == \"1\")\n  \n  # Rmst \n  rmstcoxg0 <- rmst(times = coxg0$time, surv.rates = coxg0$average_pred, max.time = 3 * 365.25, type = \"s\")\n  rmstcoxg1 <- rmst(times = coxg1$time, surv.rates = coxg1$average_pred, max.time = 3 * 365.25, type = \"s\")\n  coxgres[[b]] <- c(rmstcoxg0, rmstcoxg1)\n}\n\nkmreso <- do.call(\"rbind\", kmres)\ncox1reso <- do.call(\"rbind\", cox1res)\ncox2reso <- do.call(\"rbind\", cox2res)\ncoxgreso <- do.call(\"rbind\", coxgres)\n\n\n\n\nCox (38,45)\n\n\nCode show/hide\napply(cox1reso, 2, mean)/365.25\n\n\n[1] 2.527231 2.720892\n\n\nCode show/hide\napply(cox1reso, 2, sd)/365.25\n\n\n[1] 0.06340501 0.04929527\n\n\n\n\nCox (20,90)\n\n\nCode show/hide\napply(cox2reso, 2, mean)/365.25\n\n\n[1] 0.9566561 1.3641107\n\n\nCode show/hide\napply(cox2reso, 2, sd)/365.25\n\n\n[1] 0.2510078 0.2445435\n\n\n\n\nCox g-formula\n\n\nCode show/hide\napply(coxgreso, 2, mean)/365.25\n\n\n[1] 2.548957 2.703833\n\n\nCode show/hide\napply(coxgreso, 2, sd)/365.25\n\n\n[1] 0.05726278 0.04401984\n\n\n\n\nCox g-formula using RISCA package\n\n\nCode show/hide\npbc3$followup<-pbc3$days/365.25\ncoxf <- coxph(Surv(followup, fail) ~ tment + alb + log2bili,\n                data = pbc3, method = \"breslow\")\nlibrary(RISCA)\ngc.ate <- gc.survival(object=coxf, data=pbc3, \n                      group=\"tment\", times=\"followup\", failures=\"fail\",\n                      max.time=3, iterations=1000, effect=\"ATE\")\nrbind(Placebo=gc.ate$RMST0,CyA=gc.ate$RMST1)\n\n\n        estimate  std.error ci.lower ci.upper\nPlacebo 2.553795 0.05834140 2.439448 2.668142\nCyA     2.705696 0.04488675 2.617719 2.793672\n\n\n\n\n\n\nNon-parametric using PROC RMSTREG\n\n\nCode show/hide\nproc sort data=pbc3 out=pbc3sorted;\n    by tment;\nrun;\nproc rmstreg data=pbc3sorted tau=3;\n  by tment;\n  model followup*status(0)= / \n        link=linear method=ipcw(strata=tment);\nrun;\n\n* Bootstrapping using 'point='; \ndata bootpbc;\n    do sampnum = 1 to 1000; /* nboot=1000*/\n        do i = 1 to 349;      /*nobs=349*/\n            x=round(ranuni(0)*349); \n            set pbc3\n            point=x;\n            output;\n        end;\n    end;\n    stop;\nrun;\nproc sort data=bootpbc out=boot;\n  by sampnum tment;\nrun;\nproc rmstreg data=boot tau=3;\n  by sampnum tment;\n  model followup*status(0)= / \n        link=linear method=ipcw(strata=tment);\n    ods output parameterestimates=pe;\nrun;\nproc means data=pe mean stddev;\n  class tment;\n    var estimate;\nrun;\n\n\n\n\nMacro and bootstrap data set\n\n\nCode show/hide\n* Bootstrapping using 'point='; \ndata bootpbc;\n    do sampnum = 1 to 1000; /* nboot=1000*/\n        do i = 1 to 349;      /*nobs=349*/\n            x=round(ranuni(0)*349); \n            set pbc3\n            point=x;\n            output;\n        end;\n    end;\n    stop;\nrun;\n\n* AUC under stepcurves; \n%macro areastepby(data,byvar,trt,grp,time,y,tau);\n    data select;\n        set &data;\n        where &trt=&grp;\n    run;\n\n    data select;\n        set select;\n        by &byvar;\n        retain mu oldt oldy;\n        if first.&byvar then do;\n            oldt=0; oldy=1; mu=0;\n        end;\n        if &time>&tau then do;\n            &time=&tau; &y=oldy;\n        end;\n        if not first.&byvar then mu+oldy*(&time-oldt);\n        if last.&byvar then do;\n        if &time<&tau then mu+(&tau-&time)*&y; end;\n        oldy=&y; oldt=&time;\n    run;\n\n    data last; set select;\n        by  &byvar;\n        if last.&byvar;\n    run;\n%mend areastepby;\n\n\n\n\nNon-parametric using macro\n\n\nCode show/hide\nproc phreg data=bootpbc noprint;\n    by sampnum;\n    model followup*status(0)=;\n    strata tment;\n    baseline out=survdat survival=km / method=pl;\nrun;\n\n%areastepby(survdat,sampnum,tment,0,followup,km,3);\ntitle \"Placebo\";\nproc means data=last mean stddev;\n    var mu;\nrun;\n%areastepby(survdat,sampnum,tment,1,followup,km,3);\ntitle \"CyA\";\nproc means data=last mean stddev;\n    var mu;\nrun;\n\n\n\n\nCox (38,45) using macro\n\n\nCode show/hide\ndata cov;\n    tment=0; alb=38; log2bili=log2(45); output;\n    tment=1; alb=38; log2bili=log2(45); output;\nrun;\nproc phreg data=bootpbc noprint;\n    by sampnum;\n    model followup*status(0)=tment alb log2bili/rl;\n    baseline out=predsurv survival=surv covariates=cov/ method=breslow;\nrun;\n\n%areastepby(predsurv,sampnum,tment,0,followup,surv,3);\ntitle \"Placebo\";\nproc means data=last mean stddev;\n    var mu;\nrun;\n%areastepby(predsurv,sampnum,tment,1,followup,surv,3);\ntitle \"CyA\";\nproc means data=last mean stddev;\n    var mu;\nrun;\n\n\n\n\nCox (20,90) using macro\n\n\nCode show/hide\ndata cov;\n    tment=0; alb=20; log2bili=log2(90); output;\n    tment=1; alb=20; log2bili=log2(90); output;\nrun;\nproc phreg data=bootpbc noprint;\n    by sampnum;\n    model followup*status(0)=tment alb log2bili/rl;\n    baseline out=predsurv2 survival=surv covariates=cov/ method=breslow;\nrun;\n\n%areastepby(predsurv2,sampnum,tment,0,followup,surv,3);\ntitle \"Placebo\";\nproc means data=last mean stddev;\n    var mu;\nrun;\n%areastepby(predsurv2,sampnum,tment,1,followup,surv,3);\ntitle \"CyA\";\nproc means data=last mean stddev;\n    var mu;\nrun;\n\n\n\n\nCox g-formula using macro\n\n\nCode show/hide\nproc phreg data=bootpbc noprint;\n    by sampnum;\n    class tment (ref='0');\n    model followup*status(0)=tment alb log2bili/rl;\n    baseline out=gsurv survival=surv stderr=se/ method=breslow diradj group=tment;\nrun;\n\n%areastepby(gsurv,sampnum,tment,0,followup,surv,3);\ntitle \"Placebo\";\nproc means data=last mean stddev;\n    var mu;\nrun;\n%areastepby(gsurv,sampnum,tment,1,followup,surv,3);\ntitle \"CyA\";\nproc means data=last mean stddev;\n    var mu;\nrun;\n\n\n\n\n\n\n\n\nFigure 4.10\n\nRSAS\n\n\n\n\nCode show/hide\n# Cumulative incidences are estimated using Aalen-Johansen\n\n# Overall survival \noverall_surv <- survfit(Surv(days, status != 0) ~ 1, \n                        data = subset(pbc3, tment_char == \"Placebo\"))\n\n# Cause 1 survival: transplantation\nlibrary(mets)\ncause1_cif <- cif(Event(days, status) ~ 1, \n                  data = subset(pbc3, tment_char == \"Placebo\"), \n                  cause = 1)\n\n# Cause 2 survival: death w/o transplantation\ncause2_cif <- cif(Event(days, status) ~ 1, \n                  data = subset(pbc3, tment_char == \"Placebo\"), \n                  cause = 2)\n\n# Get them on the same time scale - book keeping\n\nalltimes <- overall_surv$time\ncause1st <- stepfun(x = cause1_cif$cumhaz[,1], y = c(0, cause1_cif$cumhaz[,2]))\ncause1times <- cause1st(v = alltimes)\n\ncause2st <- stepfun(x = cause2_cif$cumhaz[,1], y = c(0, cause2_cif$cumhaz[,2]))\ncause2times <- cause2st(v = alltimes)\n\n\n# Collect the data \ndata_comb <- data.frame(cif = c(overall_surv$surv + cause1times + cause2times, \n                                cause1times + cause2times, \n                                cause1times),\n                        time = c(alltimes, alltimes, alltimes),\n                        type = c(rep(\"Overall\", length(alltimes)), \n                                 rep(\"Transplantation + death without transplantation\", length(alltimes)), \n                                 rep(\"Transplantation\", length(alltimes)))\n                        )\n\n# Create Figure 4.10\nfig4.10 <- ggplot(aes(x = time / 365.25, y = cif, linetype = type), \n                data = data_comb) + \n  geom_step(linewidth = 1) + \n  scale_linetype_discrete(\"Type\") + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Stacked cumulative incidence and survival\") + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)), \n                     limits = c(0, 6), \n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)), \n                     limits = c(0, 1.0), \n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general + \n  guides(linetype = guide_legend(nrow = 3, byrow = TRUE)) + \n  theme(legend.position=\"bottom\",\n        legend.box=\"vertical\",\n        text = element_text(size=21), \n        legend.key.width = unit(1, \"cm\"))\n\nfig4.10\n\n\n\n\n\n\n\n\n\nCode show/hide\nproc phreg data=pbc3 noprint;\nmodel days*status(0)=;\nbaseline out=overallsurv survival=surv / method=;\nrun;\nproc sort;by tment days;run;\nproc phreg data=pbc3 noprint;\nmodel days*status(0)=/eventcode=1;\nstrata tment;\nbaseline out=cuminc1 cif=cif1;\nrun;\nproc sort;by tment days;run;\nproc phreg data=pbc3 noprint;\nmodel days*status(0)=/eventcode=2;\nstrata tment;\nbaseline out=cuminc2 cif=cif2;\nrun;\nproc sort;by tment days;run;\ndata plot0; \nmerge overallsurv cuminc1 cuminc2; \nby tment days;\nif tment=0;\nfail=1-surv;\nrun;\n\ndata plot0ok; \nset plot0;\nby days;\nretain last0 last1 last2;\nif fail=. then c0=last0; if fail ne . then c0=fail;\nif cif1=. then c1=last1; if cif1 ne . then c1=cif1;\nif cif2=. then c2=last2; if cif2 ne . then c2=cif2;\noutput;\nlast0=c0; last1=c1; last2=c2;\nrun;\ndata plot0ok; \nset plot0ok;\ncum1=c1; \ncum2=c1+c2; \ncum3=c1+c2+(1-c0);\nrun;\nproc print;run;\n\ndata plot0ok; \nset plot0ok; \ndaysyears = days/365.25; \nrun; \n\nproc gplot \ndata=plot0ok;\nplot cum1*daysyears cum2*daysyears cum3*daysyears /overlay haxis=axis1 vaxis=axis2;\naxis1 order=0 to 6 by 1 minor=none label=('Years');\naxis2 order=0 to 1 by 0.1 minor=none label=(a=90 'Stacked cumulative incidence and survival');\nsymbol1  v=none i=stepjl c=blue;\nsymbol2  v=none i=stepjl c=red;\nsymbol3  v=none i=stepjl c=black;\nrun;\nquit;\n\n\n\n\n\n\n\nFigure 4.11\n\nRSAS\n\n\n\n\nCode show/hide\n# Cumulative incidences are (wrongly) estimated using Kaplan-Meier\n\n# Overall survival \noverall_surv <- survfit(Surv(days, status != 0) ~ 1, \n                        data = subset(pbc3, tment_char == \"Placebo\"))\n\n# Cause 1 survival: transplantation, KM\ncause1_cif_w <- survfit(Surv(days, status == 1) ~ 1, \n                        data = subset(pbc3, tment_char == \"Placebo\"))\n\n# Cause 2 survival: death w/o transplantation, KM\ncause2_cif_w <- survfit(Surv(days, status == 2) ~ 1, \n                      data = subset(pbc3, tment_char == \"Placebo\"))\n\n# Get them on the same time scale - book keeping\nalltimes <- overall_surv$time\ncause1st <- stepfun(x = cause1_cif_w$time, y = c(0, cause1_cif_w$surv))\ncause1times <- cause1st(v = alltimes)\n\ncause2st <- stepfun(x = cause2_cif_w$time, y = c(0, cause2_cif_w$surv))\ncause2times <- cause2st(v = alltimes)\n\n# Collect the data \ndata_comb <- data.frame(cif_w = c(overall_surv$surv + 1-cause1times + 1-cause2times, \n                                1-cause1times + 1-cause2times, \n                                1-cause1times),\n                        time = c(alltimes, alltimes, alltimes),\n                        type = c(rep(\"Overall\", length(alltimes)), \n                                 rep(\"Transplantation + death without transplantation\", length(alltimes)), \n                                 rep(\"Transplantation\", length(alltimes)))\n)\n\n\n\n# Create Figure\nfig4.11 <- ggplot(aes(x = time / 365.25, y = cif_w, linetype = type), \n                 data = data_comb) + \n  geom_step(linewidth = 1) + \n  scale_linetype_discrete(\"Type\") + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Stacked cumulative incidence and survival\") + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)), \n                     limits = c(0, 6), \n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)), \n                     limits = c(0, 1.1), \n                     breaks = seq(0, 1.1, 0.1)) +\n  theme_general + \n  guides(linetype = guide_legend(nrow = 3, byrow = TRUE)) + \n  theme(legend.box=\"vertical\",\n        text = element_text(size=21), \n        legend.key.width = unit(1, \"cm\"))\nfig4.11\n\n\n\n\n\n\n\n\n\nCode show/hide\nproc phreg data=pbc3 noprint;\n    model days*status(0 2)=;\n    strata tment;\n    baseline out=cuminc1wrng survival=s1wrng;\nrun;\n\nproc phreg data=pbc3 noprint;\n    model days*status(0 1)=;\n    baseline out=cuminc2wrng survival=s2wrng;\n    strata tment;\nrun;\n\ndata plot0wrng; \n    merge overallsurv cuminc1wrng cuminc2wrng; \n    where tment=0; by days;\nrun;\n\ndata plot0wrng; \n    set plot0wrng;\n    by days;\n    retain last1 last2;\n    if s1wrng=. then c1=last1; if s1wrng ne . then c1=1-s1wrng;\n    if s2wrng=. then c2=last2; if s2wrng ne . then c2=1-s2wrng;\n    output;\n    last1=c1; last2=c2;\nrun;\n\ndata plot0wrng; \n    set plot0wrng;\n    cum1=c1; cum2=c1+c2; cum3=c1+c2+surv; one=1;\nrun;\n\ndata plot0wrng; \n    set plot0wrng; \n    daysyears = days/365.25; \nrun; \n\nproc gplot \n    data=plot0wrng;\n    plot cum1*daysyears cum2*daysyears cum3*daysyears one*daysyears\n         /overlay haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1.1 by 0.1 minor=none label=(a=90 'Stacked cumulative incidence and survival');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\n    symbol3  v=none i=stepjl c=black;\n    symbol4  v=none i=stepjl l=2 c=black;\nrun;\nquit;\n\n\n\n\n\n\n\nFigure 4.12\n\nRSAS\n\n\n\nFigure 4.12 (a)\n\n\nCode show/hide\n# Overall\noverall_cox <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili + sex + age,\n                        data = subset(pbc3, !is.na(alb)),\n                     method = \"breslow\", eps=1e-9)\n\n# Cause 1: transplantation\ncause1_cox <- coxph(Surv(days, status == 1) ~ tment + alb + log2bili + sex + age,\n                    data = subset(pbc3, !is.na(alb)), \n                    method = \"breslow\", eps=1e-9)\n\n# Cause 2: death w/o transplantation\ncause2_cox <- coxph(Surv(days, status == 2) ~ tment + alb + log2bili + sex + age,\n                    data = subset(pbc3, !is.na(alb)), \n                    method = \"breslow\", eps=1e-9)\n\n\n# for tment = placebo, age = 40, alb = 38, bili = log2(45) and sex = F\nnewd <- data.frame(tment = 0, age = 40, \n                   alb = 38, log2bili = log2(45), \n                   sex = 0)\nest_cause1 <- survfit(cause1_cox, ctype = 2, newdata = newd)$cumhaz \n\nest_cause2 <- survfit(cause2_cox, ctype = 2, newdata = newd)$cumhaz \n\nest_overall <- survfit(overall_cox, ctype = 2, newdata = newd)$surv\n\n# Calculate S, and F1 and F2\nalltimes <- basehaz(overall_cox, centered = F)$time\n\nA <- cumsum(diff(c(0, est_cause1 + est_cause2)))\ndA <- diff(c(0, A))\nS <- cumprod(1-dA) #exp(-cumsum(dA)) \nA1 <- est_cause1\nA2 <- est_cause2\n\ndat <- data.frame(cbind(alltimes, A, dA, S, A1, A2))\ndat2 <- subset(dat, dA > 0)\ndat2$lagS <- with(dat2, c(0, S[-length(S)])) \n\ndat2$F1 <- with(dat2, cumsum(lagS * diff(c(0, A1))))\ndat2$F2 <- with(dat2, cumsum(lagS * diff(c(0, A2))))\n\n\n# Collect the data\ndata_comb <- with(dat2, \n                  data.frame(cif_w = c(rep(1, length(alltimes)),\n                                       F1 + F2,\n                                       F1),\n                             time = c(alltimes, alltimes, alltimes),\n                             type = c(rep(\"Overall\", length(alltimes)),\n                                      rep(\"Transplantation + death without transplantation\", length(alltimes)),\n                                      rep(\"Transplantation\", length(alltimes)))\n                  ))\n\n\n# Create Figure\nfig4.12a <- ggplot(aes(x = time / 365.25, y = cif_w, linetype = type),\n                 data = data_comb) +\n  geom_step(linewidth = 1) +\n  scale_linetype_discrete(\"Type\") +\n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Stacked cumulative incidence and survival\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general +\n  guides(linetype = guide_legend(nrow = 3, byrow = TRUE)) + \n  theme(legend.box=\"vertical\",\n        text = element_text(size=22), \n        legend.key.width = unit(1, \"cm\"))\n\nfig4.12a\n\n\n\n\n\n\n\nFigure 4.12 (b)\n\n\nCode show/hide\n# for tment = placebo, age = 40, alb = 20, bili = log2(90) and sex = F\nnewd <- data.frame(tment = 0, age = 40, \n                    alb = 20, log2bili = log2(90), \n                    sex = 0)\n\nest_cause1 <- survfit(cause1_cox, ctype = 2, newdata = newd)$cumhaz\n\nest_cause2 <- survfit(cause2_cox, ctype = 2, newdata = newd)$cumhaz\n\nest_overall <- survfit(overall_cox, ctype = 2, newdata = newd)$surv\n\n\n# Calculate S, and F1 and F2\nalltimes <- basehaz(overall_cox, centered = F)$time\n\nA <- cumsum(diff(c(0, est_cause1 + est_cause2)))\ndA <- diff(c(0, A))\nS <- cumprod(1-dA) #exp(-cumsum(dA)) \nA1 <- est_cause1\nA2 <- est_cause2\n\ndat <- data.frame(cbind(alltimes, A, dA, S, A1, A2))\ndat2 <- subset(dat, dA > 0)\ndat2$lagS <- with(dat2, c(0, S[-length(S)])) \n\ndat2$F1 <- with(dat2, cumsum(lagS * diff(c(0, A1))))\ndat2$F2 <- with(dat2, cumsum(lagS * diff(c(0, A2))))\n\n\n# Collect the data\ndata_comb <- with(dat2, \n                  data.frame(cif_w = c(rep(1, length(alltimes)),\n                                  F1 + F2,\n                                  F1),\n                        time = c(alltimes, alltimes, alltimes),\n                        type = c(rep(\"Overall\", length(alltimes)),\n                                 rep(\"Transplantation + death without transplantation\", length(alltimes)),\n                                 rep(\"Transplantation\", length(alltimes)))))\n\n# Create Figure\nfig4.12b <- ggplot(aes(x = time / 365.25, y = cif_w, linetype = type),\n                 data = data_comb) +\n  geom_step(linewidth = 1) +\n  scale_linetype_discrete(\"Type\") +\n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Stacked cumulative incidence and survival\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general +\n  guides(linetype = guide_legend(nrow = 3, byrow = TRUE)) + \n  theme(legend.box=\"vertical\",\n        text = element_text(size=22), \n        legend.key.width = unit(1, \"cm\"))\n\n\nfig4.12b\n\n\n\n\n\n\n\nFigure 4.12 (c)\n\n\nCode show/hide\n# for tment = placebo, age = 60, alb = 38, bili = log2(45) and sex = F\nnewd <- data.frame(tment = 0, age = 60, \n                   alb = 38, log2bili = log2(45), \n                   sex = 0)\n\nest_cause1 <- survfit(cause1_cox, ctype = 2, newdata = newd)$cumhaz\n\nest_cause2 <- survfit(cause2_cox, ctype = 2, newdata = newd)$cumhaz\n\nest_overall <- survfit(overall_cox, ctype = 2, newdata = newd)$surv\n\n\n# Calculate S, and F1 and F2\nalltimes <- basehaz(overall_cox, centered = F)$time\n\nA <- cumsum(diff(c(0, est_cause1 + est_cause2)))\ndA <- diff(c(0, A))\nS <- cumprod(1-dA) #exp(-cumsum(dA)) \nA1 <- est_cause1\nA2 <- est_cause2\n\ndat <- data.frame(cbind(alltimes, A, dA, S, A1, A2))\ndat2 <- subset(dat, dA > 0)\ndat2$lagS <- with(dat2, c(0, S[-length(S)])) \n\ndat2$F1 <- with(dat2, cumsum(lagS * diff(c(0, A1))))\ndat2$F2 <- with(dat2, cumsum(lagS * diff(c(0, A2))))\n\n\n# Collect the data\ndata_comb <- with(dat2, \n                  data.frame(cif_w = c(rep(1, length(alltimes)), F1 + F2, F1),\n                             time = c(alltimes, alltimes, alltimes),\n                             type = c(rep(\"Overall\", length(alltimes)),\n                                      rep(\"Transplantation + death without transplantation\",\n                                          length(alltimes)),\n                                      rep(\"Transplantation\", length(alltimes)))))\n\n# Create Figure\nfig4.12c <- ggplot(aes(x = time / 365.25, y = cif_w, linetype = type),\n                 data = data_comb) +\n  geom_step(linewidth = 1) +\n  scale_linetype_discrete(\"Type\") +\n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Stacked cumulative incidence and survival\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general + \n  guides(linetype = guide_legend(nrow = 3, byrow = TRUE)) + \n  theme(legend.position=\"bottom\",\n        legend.box=\"vertical\",\n        text = element_text(size=22), \n        legend.key.width = unit(1, \"cm\"))\n\n\nfig4.12c\n\n\n\n\n\n\n\n\n\nMacro and double data set\nThe SAS macro below can alternatively be loaded using this code:\n\n\nCode show/hide\nfilename cumincpr url 'http://publicifsv.sund.ku.dk/~pka/CumInc.sas';\n%inc cumincpr;\n\n\n\n\nCode show/hide\n%macro CumInc(Data,Strata,Time,Surv);\n\n/* Number of Stratas */\n  \n  proc sort data=&Data;\nby &Strata;\n\ndata nstrat;\nset &Data end=last;\nby &Strata;\nfirstS=first.&Strata;\nretain nStrata 0;\nnStrata+firstS;\nif last then call symput('nStrata',nStrata);\ndrop firstS;\nrun;\n\n\n/* Observations in ciData are deleted */\n  \n  \n  data newData; \nset &Data;\nstart=(&Time eq 0);   \nretain komb 0;\nkomb+start;\nmed=0;\n%do k=0 %to (&nStrata-1) %by 1;\nmed=med+(komb eq (1+&k*(&nStrata+1)));\n%end;\nif (med eq 1);  \ndrop start med komb;\nrun;\n\n/* Time vector */\n  \n  proc sort data=newData;\nby &Time;\n\ndata Time (keep=&Time); \nset newData;\n%do i=1 %to &nStrata %by 1;\nif &Time=lag(&Time) then delete;\n%end;\n\n\n/* Strata vector */\n  \n  proc sort data=newData;\nby &Strata &Time;\n\ndata temp1;\nset newData; by &Strata;\nretain stratum 0;\nstratum+first.&Strata;\n\n/*  A=sum(A_1,...,A_nStrata) */\n  \n  %do i=1 %to &nStrata %by 1;\ndata data&i;\nset temp1;\nif stratum=&i;\n\ndata data&i (keep = &Time A&i);\nmerge data&i Time; by &Time;  \nretain Surv&i;\nif not (&Surv=.) then Surv&i=&Surv;\nA&i=-log(Surv&i);\n\n%end;\n\n\ndata A_and_S;\nA=0;\n%do i=1 %to &nStrata %by 1;\nmerge data&i; by &Time;\nA+A&i;\n%end;\n\ndA=A-lag(A);\nif dA eq . then dA=0;\n\nretain S 1;\nS+S*(1-dA)-S;\nlagS=lag(S);\nrun;\n\n\n\n/* Output */\n  \n  data temp2 (keep = &Strata &Time);\nset temp1; \nproc sort data=temp2; by &Time;\n\ndata temp3;\nmerge temp2 A_and_S; by &Time;\nproc sort data=temp3; by &Strata &Time;\n\n\ndata data0 (keep = &Time p stratum);\nset temp3; by &Strata;\n*   lagS=lag(S);\n\nif first.&Strata then do;\nlagS=1; end;\n\nretain stratum 0;\nstratum+first.&Strata;\n\n%do i=1 %to &nStrata %by 1;\nlagA&i=lag(A&i);\nif ((stratum eq &i) and (first.&Strata)) then lagA&i=0;\nif (stratum ne &i) then lagA&i=0;\n\nl&i=(stratum=&i)*(lagS*(A&i-lagA&i));\nretain p&i 0;\np&i+l&i; \nif (stratum ne &i) then p&i=0;\n%end;\n\np=0;\n%do i=1 %to &nStrata %by 1;\np=p+p&i; %end;\nrun;\n\n\n\n\n\n/* put data into the right form */\n  \n  %do i=1 %to &nStrata;\ndata data&i;\nset data0;\nif (stratum eq &i);\np0&i=p; drop p stratum;\n\nproc sort data=data&i;\nby &Time;\n%end;\n\ndata data;\nset data1;\n%do i=1 %to &nStrata;\ndata data;\nmerge data data&i;\nby &Time;\n%end;\n\n\n* and complete the p-s;\n\nproc sort data=data;\n by &Time;\n\ndata data; \n set data end=last;\n  by &Time;\n   n=_N_;\n  if last then call symput('nobs',n);\n  drop n;\n\ndata data;\n set data;\n  %do i=1 %to &nStrata;\n   %do j=1 %to &nobs;\n    dummy=lag(p0&i);\n    if (p0&i eq .) then p0&i=dummy;\n   %end;\n  %end;\n  drop dummy;\n  p00=1;\n  %do i=1 %to &nStrata;\n   p00=p00-p0&i;\n  %end;\nrun;\n%mend CumInc;\n\n\n* Cuminc macro requires duplication; \ndata pbc32; \n    set pbc3 pbc3;\n    h=1+(_N_ gt 349);\n    time=days;\n    d=(status=1)*(h=1)+(status=2)*(h=2);\n    tment1=tment*(h=1); tment2=tment*(h=2);\n    sex1=sex*(h=1); sex2=sex*(h=2);\n    age1=age*(h=1); age2=age*(h=2);\n    alb1=alb*(h=1); alb2=alb*(h=2);\n    log2bili1=log2bili*(h=1); log2bili2=log2bili*(h=2);\nrun;\n\n\n\n\nFigure 4.12 (a)\n\n\nCode show/hide\ndata cov;\n  input tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;\n  datalines; \n  0 0 0 0 40 0 38 0 45 0\n  0 0 0 0 0 40 0 38 0 45\n  ;\nrun;\ndata cov; \n  set cov;\n    if log2bili1>0 then log2bili1=log2(log2bili1);\n    if log2bili2>0 then log2bili2=log2(log2bili2);\nrun;\nproc phreg data=pbc32 noprint;\n    model time*d(0)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 \n                    log2bili1 log2bili2/rl;\n    strata h;\n    baseline out=cidata covariates=cov survival=surv/nomean method=ch;\nrun;\n%cuminc(cidata,h,time,surv);\ndata data; set data; tment=0; run;\ndata plot1; \n    set data; \n    cum1=p01; cum2=p01+p02; cum3=1;\n    p = p01+p02+p00;\nrun;\ndata plot1; \n    set plot1; \n    daysyears = time/365.25; \nrun; \nproc gplot data=plot1;\n    plot cum1*daysyears cum2*daysyears cum3*daysyears/overlay haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none label=(a=90 'Stacked cumulative incidence and survival');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\n    symbol3  v=none i=stepjl c=black;\nrun;\nquit;\n\n\n\n\nFigure 4.12 (b)\n\n\nCode show/hide\ndata cov;\n    input tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;\n    datalines; \n    0 0 0 0 40 0 20 0 90 0\n    0 0 0 0 0 40 0 20 0 90\n    ;\nrun;\ndata cov; \n  set cov;\n    if log2bili1>0 then log2bili1=log2(log2bili1);\n    if log2bili2>0 then log2bili2=log2(log2bili2);\nrun;\nproc phreg data=pbc32 noprint;\n    model time*d(0)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 \n                    log2bili1 log2bili2/rl;\n    strata h;\n    baseline out=cidata covariates=cov survival=surv/nomean method=ch;\nrun;\n%cuminc(cidata,h,time,surv);\ndata data; set data; tment=0; run;\ndata plot2plac; set data; \n    cum1=p01; cum2=p01+p02; cum3=1;\nrun;\ndata plot2plac; \n    set plot2plac; \n    daysyears = time/365.25; \nrun; \nproc gplot data=plot2plac;\n    plot cum1*daysyears cum2*daysyears cum3*daysyears/overlay haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none label=(a=90 'Stacked cumulative incidence and survival');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\n    symbol3  v=none i=stepjl c=black;\nrun;\nquit;\n\n\n\n\nFigure 4.12 (c)\n\n\nCode show/hide\ndata cov;\n    input tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;\n    datalines; \n    0 0 0 0 60 0 38 0 45 0\n    0 0 0 0 0 60 0 38 0 45\n    ;\nrun;\ndata cov;\n    set cov;\n    if log2bili1>0 then log2bili1=log2(log2bili1);\n    if log2bili2>0 then log2bili2=log2(log2bili2);\nrun;\nproc phreg data=pbc32 noprint;\n    model time*d(0)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 \n                    log2bili1 log2bili2/rl;\n    strata h;\n    baseline out=cidata covariates=cov survival=surv/nomean method=ch;\nrun;\n%cuminc(cidata,h,time,surv);\ndata data; set data; tment=0; run;\ndata plot3plac; set data; \n    cum1=p01; cum2=p01+p02; cum3=1;\nrun;\ndata plot3plac; \n    set plot3plac; \n    daysyears = time/365.25; \nrun; \nproc gplot data=plot3plac;\n    plot cum1*daysyears cum2*daysyears cum3*daysyears/overlay haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none label=(a=90 'Stacked cumulative incidence and survival');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\n    symbol3  v=none i=stepjl c=black;\nrun;\nquit;\n\n\n\n\n\n\n\n\nTable 4.2\n\nRSAS\n\n\n\nScenario 1 (no adjustment)\n\n\nCode show/hide\nlibrary(\"survRM2\")\n\n# No adjustment \ncoxsurv <- coxph(Surv(days, status != 0) ~ strata(tment), data = pbc3, \n                      method = \"breslow\")\n\n# death w/o transplant\ncox1 <- coxph(Surv(days, status == 2) ~ strata(tment), data = pbc3, \n              method = \"breslow\")\n\n# transplant\ncox2 <- coxph(Surv(days, status == 1) ~ strata(tment), data = pbc3, \n              method = \"breslow\")\n\ntime <- basehaz(cox1, center = F)$time\nsurv <- exp(-basehaz(coxsurv, center = F)$hazard)\nlamd1 <- basehaz(cox1, center = F)$hazard\nlamd2 <- basehaz(cox2, center = F)$hazard\nstrat <- basehaz(cox1, center = F)$strata\n  \n# Cumulative incidence\nF01_plac <- cumsum(surv[strat == \"tment=0\"] * diff(c(0,lamd1[strat == \"tment=0\"])))\nF01_cya <- cumsum(surv[strat == \"tment=1\"] * diff(c(0,lamd1[strat == \"tment=1\"])))\n\nF02_plac <- cumsum(surv[strat == \"tment=0\"] * diff(c(0,lamd2[strat == \"tment=0\"])))\nF02_cya <- cumsum(surv[strat == \"tment=1\"] * diff(c(0,lamd2[strat == \"tment=1\"])))\n\ntimep <- time[strat == \"tment=0\"]\ntimec <- time[strat == \"tment=1\"]\n\n# Transplantation\nscenario1.T <- c(Placebo=sum(diff(c(0, timep[timep <= 3 * 365.25])) * F02_plac[timep <= 3 * 365.25])/365.25,\nCyA=sum(diff(c(0, timec[timec <= 3 * 365.25])) * F02_cya[timec <= 3 * 365.25])/365.25)\n\n# Death without transplantation\nscenario1.D <- c(Placebo=sum(diff(c(0, timep[timep <= 3 * 365.25])) * F01_plac[timep <= 3 * 365.25])/365.25,\nCyA=sum(diff(c(0, timec[timec <= 3 * 365.25])) * F01_cya[timec <= 3 * 365.25])/365.25)\nscenario1.T;scenario1.D \n\n\n   Placebo        CyA \n0.14268790 0.08567096 \n\n\n  Placebo       CyA \n0.2499754 0.2365865 \n\n\n\n\nScenario 1 (no adjustment) using mets package\n\n\nCode show/hide\nlibrary(mets)\nrmc1 <- cif.yearslost(Event(days/365.25,status)~strata(tment), \n                      data=pbc3, time=3)\nsummary(rmc1)\n\n\n  strata times     intF11    intF12  se.intF11  se.intF12 total.years.lost\n1      0     3 0.14274534 0.2511599 0.04083718 0.05260692        0.3939052\n2      1     3 0.08637516 0.2359673 0.03029502 0.05031025        0.3223425\n\n\n\n\nScenario 2\n\n\nCode show/hide\ncoxsurv <- coxph(Surv(days/365.25, status != 0) ~ tment + sex + age + alb + log2bili,\n                 data = pbc3, method = \"breslow\")\n# death w/o transplant\ncox1 <- coxph(Surv(days/365.25, status == 2) ~ tment + sex + age + alb + log2bili,\n              data = pbc3, method = \"breslow\")\n# transplant\ncox2 <- coxph(Surv(days/365.25, status == 1) ~ tment + sex + age + alb + log2bili,\n              data = pbc3, method = \"breslow\")\n\n# Sex = F, age = 40, alb = 38, bili = 45\n# Predictions \nnewd <- data.frame(tment = c(0, 1),\n                   sex = c(0, 0),\n                   age = c(40, 40),\n                   alb = c(38, 38), \n                   log2bili = log2(c(45, 45)))\n\n# predictions\ntime <- basehaz(cox1, center = F)$time\nsurv <- exp(-basehaz(coxsurv, center = F)$hazard)\nlamd1 <- basehaz(cox1, center = F)$hazard\nlamd2 <- basehaz(cox2, center = F)$hazard\n\nlpsurv <- predict(coxsurv, newd, type = \"lp\", reference = \"zero\")\nlpcox1 <- predict(cox1, newd, type = \"lp\", reference = \"zero\")\nlpcox2 <- predict(cox2, newd, type = \"lp\", reference = \"zero\")\n\n# Linear predictors\nsurv_plac <- surv^exp(lpsurv[1])\nsurv_cya <- surv^exp(lpsurv[2])\n\nlamd1_plac <- lamd1 * exp(lpcox1[1])\nlamd1_cya <- lamd1 * exp(lpcox1[2])\n\nlamd2_plac <- lamd2 * exp(lpcox2[1])\nlamd2_cya <- lamd2 * exp(lpcox2[2])\n\n# Cumulative incidence\nF01_plac <- cumsum(surv_plac * diff(c(0,lamd1_plac)))\nF01_cya  <- cumsum(surv_cya * diff(c(0,lamd1_cya)))\n\nF02_plac <- cumsum(surv_plac * diff(c(0,lamd2_plac)))\nF02_cya  <- cumsum(surv_cya * diff(c(0,lamd2_cya)))\n\ntimep <- timec <- time\n\n# Transplantation\nscenario2.T <- c(Placebo=sum(diff(c(0, timep[timep <= 3])) * F02_plac[timep <= 3]),\nCyA=sum(diff(c(0, timec[timec <= 3])) * F02_cya[timec <= 3]))\n\n# Death without transplantation\nscenario2.D <- c(Placebo=sum(diff(c(0, timep[timep <= 3])) * F01_plac[timep <= 3]),\n                 CyA    =sum(diff(c(0, timec[timec <= 3])) * F01_cya[timec  <= 3])\n                 )\nscenario2.T;scenario2.D \n\n\n  Placebo       CyA \n0.2204065 0.1161289 \n\n\n   Placebo        CyA \n0.09008897 0.06091087 \n\n\n\n\nScenario 3\n\n\nCode show/hide\n# Sex = F, age = 40, alb = 20, bili = 90 #\n# Predictions \nnewd <- data.frame(tment = c(0, 1),\n                   sex = c(0, 0),\n                   age = c(40, 40),\n                   alb = c(20, 20), \n                   log2bili = log2(c(90, 90)))\n\n# predictions\ntime <- basehaz(cox1, center = F)$time\nsurv <- exp(-basehaz(coxsurv, center = F)$hazard)\nlamd1 <- basehaz(cox1, center = F)$hazard\nlamd2 <- basehaz(cox2, center = F)$hazard\n\nlpsurv <- predict(coxsurv, newd, type = \"lp\", reference = \"zero\")\nlpcox1 <- predict(cox1, newd, type = \"lp\", reference = \"zero\")\nlpcox2 <- predict(cox2, newd, type = \"lp\", reference = \"zero\")\n\n# Linear predictors\nsurv_plac <- surv^exp(lpsurv[1])\nsurv_cya <- surv^exp(lpsurv[2])\n\nlamd1_plac <- lamd1 * exp(lpcox1[1])\nlamd1_cya <- lamd1 * exp(lpcox1[2])\n\nlamd2_plac <- lamd2 * exp(lpcox2[1])\nlamd2_cya <- lamd2 * exp(lpcox2[2])\n\n# Cumulative incidence\nF01_plac <- cumsum(surv_plac * diff(c(0,lamd1_plac)))\nF01_cya <- cumsum(surv_cya * diff(c(0,lamd1_cya)))\n\nF02_plac <- cumsum(surv_plac * diff(c(0,lamd2_plac)))\nF02_cya <- cumsum(surv_cya * diff(c(0,lamd2_cya)))\n\ntimep <- timec <- time\n\n# Transplantation\nscenario3.T <- c(Placebo=sum(diff(c(0, timep[timep <= 3])) * F02_plac[timep <= 3]),\n                 CyA    =sum(diff(c(0, timec[timec <= 3])) * F02_cya[timec  <= 3])\n                 )\n\n# Death without transplantation\nscenario3.D <- c(Placebo=sum(diff(c(0, timep[timep <= 3])) * F01_plac[timep <= 3]),\n                 CyA    =sum(diff(c(0, timec[timec <= 3])) * F01_cya[timec  <= 3]))\nscenario3.T;scenario3.D\n\n\nPlacebo     CyA \n1.69057 1.06836 \n\n\n  Placebo       CyA \n0.4232820 0.3293008 \n\n\n\n\nScenario 4\n\n\nCode show/hide\n##### Sex = F, age = 60, alb = 38, bili = 45 #####\n\n# Predictions \nnewd <- data.frame(tment = c(0, 1),\n                   sex = c(0, 0),\n                   age = c(60, 60),\n                   alb = c(38, 38), \n                   log2bili = log2(c(45, 45)))\n\n# predictions\nlpsurv <- predict(coxsurv, newd, type = \"lp\", reference = \"zero\")\nlpcox1 <- predict(cox1, newd, type = \"lp\", reference = \"zero\")\nlpcox2 <- predict(cox2, newd, type = \"lp\", reference = \"zero\")\n\ntime <- basehaz(cox1, center = F)$time\nsurv <- exp(-basehaz(coxsurv, center = F)$hazard)\nlamd1 <- basehaz(cox1, center = F)$hazard\nlamd2 <- basehaz(cox2, center = F)$hazard\n\n# Linear predictors\nsurv_plac <- surv^exp(lpsurv[1])\nsurv_cya <- surv^exp(lpsurv[2])\n\nlamd1_plac <- lamd1 * exp(lpcox1[1])\nlamd1_cya <- lamd1 * exp(lpcox1[2])\n\nlamd2_plac <- lamd2 * exp(lpcox2[1])\nlamd2_cya <- lamd2 * exp(lpcox2[2])\n\n# Cumulative incidence\nF01_plac <- cumsum(surv_plac * diff(c(0,lamd1_plac)))\nF01_cya <- cumsum(surv_cya * diff(c(0,lamd1_cya)))\n\nF02_plac <- cumsum(surv_plac * diff(c(0,lamd2_plac)))\nF02_cya <- cumsum(surv_cya * diff(c(0,lamd2_cya)))\n\ntimep <- timec <- time\n\n# Transplantation\nscenario4.T <- c(Placebo=sum(diff(c(0, timep[timep <= 3])) * F02_plac[timep <= 3]), \n                 CyA    =sum(diff(c(0, timec[timec <= 3])) * F02_cya[timec  <= 3])\n                 )\n\n# Death without transplantation\nscenario4.D <- c(Placebo=sum(diff(c(0, timep[timep <= 3])) * F01_plac[timep <= 3]),\n                 CyA    =sum(diff(c(0, timec[timec <= 3])) * F01_cya[timec  <= 3])\n                 )\nscenario4.T;scenario4.D\n\n\n   Placebo        CyA \n0.07879677 0.04263005 \n\n\n  Placebo       CyA \n0.3678765 0.2544924 \n\n\n\n\n\n\nMacro for area under CIF\n\n\nCode show/hide\n%macro areastep(data,trt,grp,time,y,tau);\n    data select; set &data; where &trt=&grp;\n    run;\n    data select; set select;by &trt;\n        retain mu;\n        if first.&trt then mu=0;\n        if &time>&tau then do;\n        &time=&tau; &y=lag(&y); end;\n        mu+lag(&y)*(&time-lag(&time));\n        if last.&trt then do;\n        if &time<&tau then mu+(&tau-&time)*&y; end;\n    run;\n    data last;\n      set select;\n        by &trt;\n        if last.&trt;\n    run;\n    proc print; run;\n%mend areastep;\n\n\n\n\nScenario 1 (no adjustment)\n\n\nCode show/hide\n* No adjustment: Transplantation; \nproc phreg data=pbc3 noprint;\n    model followup*status(0)=/eventcode=1;\n    strata tment;\n    baseline out=cuminc1 cif=cif1 stdcif=std1;\nrun;\ntitle \"Placebo\";\n%areastep(cuminc1,tment,0,followup,cif1,3);\ntitle \"CyA\";\n%areastep(cuminc1,tment,1,followup,cif1,3);\n\n* No adjustment: Death wo transplant;\nproc phreg data=pbc3 noprint;\n    model followup*status(0)=/eventcode=2;\n    strata tment;\n    baseline out=cuminc2 cif=cif2 stdcif=std2;\nrun;\ntitle \"Placebo\";\n%areastep(cuminc2,tment,0,followup,cif2,3);\ntitle \"CyA\";\n%areastep(cuminc2,tment,1,followup,cif2,3);\n\n\n\n\nScenario 2\n\n\nCode show/hide\n*** age=40 alb=38 bili=45 ***; \n* CyA; \ndata cov;\n    input tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;\n    datalines; \n    1 0 0 0 40 0 38 0 45 0\n    0 1 0 0 0 40 0 38 0 45\n    ;\nrun;\n\ndata cov; set cov;\n    if log2bili1>0 then log2bili1=log2(log2bili1);\n    if log2bili2>0 then log2bili2=log2(log2bili2);\nrun;\n\nproc phreg data=pbc32 noprint;\n    model time*d(0)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 \n    log2bili1 log2bili2/rl;\n    strata h;\n    baseline out=cidata covariates=cov survival=surv/nomean method=ch;\nrun;\n%cuminc(cidata,h,time,surv);\ndata dataC; \n    set data; \n    tment=1; \nrun;\n%areastep(dataC,tment,1,time,p01,3);\n%areastep(dataC,tment,1,time,p02,3);\n\n* Placebo; \ndata cov;\n    input tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;\n    datalines; \n    0 0 0 0 40 0 38 0 45 0\n    0 0 0 0 0 40 0 38 0 45\n    ;\nrun;\ndata cov; set cov;\n    if log2bili1>0 then log2bili1=log2(log2bili1);\n    if log2bili2>0 then log2bili2=log2(log2bili2);\nrun;\nproc phreg data=pbc32 noprint;\n    model time*d(0)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 \n                                    log2bili1 log2bili2;\n    strata h;\n    baseline out=cidata covariates=cov survival=surv/nomean method=ch;\nrun;\n%cuminc(cidata,h,time,surv);\ndata dataP; \nset data; \ntment=0; \nrun;\n%areastep(dataP,tment,0,time,p01,3);\n%areastep(dataP,tment,0,time,p02,3);\n\n\n\n\nScenario 3\n\n\nCode show/hide\n*** age=40 alb=20 bili=90 ***; \n* CyA; \ndata cov;\n    input tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;\n    datalines; \n    1 0 0 0 40 0 20 0 90 0\n    0 1 0 0 0 40 0 20 0 90\n    ;\nrun;\n\ndata cov; set cov;\n    if log2bili1>0 then log2bili1=log2(log2bili1);\n    if log2bili2>0 then log2bili2=log2(log2bili2);\nrun;\n\nproc phreg data=pbc32 noprint;\n    model time*d(0)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 \n    log2bili1 log2bili2/rl;\n    strata h;\n    baseline out=cidata covariates=cov survival=surv/nomean method=ch;\nrun;\n\n%cuminc(cidata,h,time,surv);\n\ndata dataC; \n    set data; \n    tment=1; \nrun;\n\n%areastep(dataC,tment,1,time,p01,3);\n%areastep(dataC,tment,1,time,p02,3);\n\n* Placebo; \ndata cov;\n    input tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;\n    datalines; \n    0 0 0 0 40 0 20 0 90 0\n    0 0 0 0 0 40 0 20 0 90\n    ;\nrun;\n\ndata cov; set cov;\n    if log2bili1>0 then log2bili1=log2(log2bili1);\n    if log2bili2>0 then log2bili2=log2(log2bili2);\nrun;\nproc phreg data=pbc32 noprint;\n    model time*d(0)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 \n    log2bili1 log2bili2/rl;\n    strata h;\n    baseline out=cidata covariates=cov survival=surv/nomean method=ch;\nrun;\n%cuminc(cidata,h,time,surv);\ndata dataP; \n    set data; \n    tment=0; \nrun;\n%areastep(dataP,tment,0,time,p01,3);\n%areastep(dataP,tment,0,time,p02,3);\n\n\n\n\nScenario 4\n\n\nCode show/hide\n*** age=60 alb=38 bili=45 ***; \n* CyA; \ndata cov;\n    input tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;\n    datalines; \n    1 0 0 0 60 0 38 0 45 0\n    0 1 0 0 0 60 0 38 0 45\n    ;\nrun;\ndata cov; set cov;\n    if log2bili1>0 then log2bili1=log2(log2bili1);\n    if log2bili2>0 then log2bili2=log2(log2bili2);\nrun;\nproc phreg data=pbc32 noprint;\n    model time*d(0)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 \n    log2bili1 log2bili2/rl;\n    strata h;\n    baseline out=cidata covariates=cov survival=surv/nomean method=ch;\nrun;\n%cuminc(cidata,h,time,surv);\ndata dataC; \n    set data; \n    tment=1; \nrun;\n%areastep(dataC,tment,1,time,p01,3);\n%areastep(dataC,tment,1,time,p02,3);\n\n* Placebo; \ndata cov;\n    input tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;\n    datalines; \n    0 0 0 0 60 0 38 0 45 0\n    0 0 0 0 0 60 0 38 0 45\n    ;\nrun;\ndata cov; set cov;\n    if log2bili1>0 then log2bili1=log2(log2bili1);\n    if log2bili2>0 then log2bili2=log2(log2bili2);\nrun;\nproc phreg data=pbc32 noprint;\n    model time*d(0)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 \n    log2bili1 log2bili2/rl;\n    strata h;\n    baseline out=cidata covariates=cov survival=surv/nomean method=ch;\nrun;\n%cuminc(cidata,h,time,surv);\ndata dataP; \n    set data; \n    tment=0; \nrun;\n%areastep(dataP,tment,0,time,p01,3);\n%areastep(dataP,tment,0,time,p02,3);\n\n\n\n\n\n\n\n\nTable 4.4\n\nRSAS\n\n\n\nUsing survRM2 package\nHere we get the same as in SAS PROC RMSTREG\n\n\nCode show/hide\nlibrary(\"survRM2\")\npbcsub <- subset(pbc3,!is.na(alb))\ntime   <- pbcsub$days/365.25\nstatus <- pbcsub$status!=0\narm    <- pbcsub$tment==\"1\"\nalb    <- pbcsub$alb\nlogbili<- log2(pbcsub$bili)\nxx <- cbind(alb, logbili)\nrmst2(time, status, arm, tau=3, covariates=xx)\n\n\n\nThe truncation time: tau = 3  was specified. \n\nSummary of between-group contrast (adjusted for the covariates) \n                      Est. lower .95 upper .95     p\nRMST (arm=1)-(arm=0) 0.168     0.016     0.320 0.031\nRMST (arm=1)/(arm=0) 1.065     1.004     1.130 0.037\nRMTL (arm=1)/(arm=0) 0.548     0.364     0.823 0.004\n\n\nModel summary (difference of RMST) \n            coef se(coef)      z     p lower .95 upper .95\nintercept  2.376    0.381  6.241 0.000     1.630     3.122\narm        0.168    0.078  2.160 0.031     0.016     0.320\nalb        0.031    0.008  4.058 0.000     0.016     0.045\nlogbili   -0.214    0.034 -6.207 0.000    -0.281    -0.146\n\n\nModel summary (ratio of RMST) \n            coef se(coef)      z     p exp(coef) lower .95 upper .95\nintercept  0.882    0.151  5.827 0.000     2.415     1.795     3.249\narm        0.063    0.030  2.089 0.037     1.065     1.004     1.130\nalb        0.011    0.003  3.859 0.000     1.012     1.006     1.017\nlogbili   -0.085    0.016 -5.499 0.000     0.918     0.891     0.947\n\n\nModel summary (ratio of time-lost) \n            coef se(coef)      z     p exp(coef) lower .95 upper .95\nintercept -0.142    0.802 -0.177 0.860     0.868     0.180     4.183\narm       -0.602    0.208 -2.895 0.004     0.548     0.364     0.823\nalb       -0.095    0.017 -5.469 0.000     0.909     0.878     0.941\nlogbili    0.524    0.061  8.540 0.000     1.689     1.498     1.906\n\n\n\n\nUsing mets package\nHowever, this does not align exactly with survRM2 package?\n\n\nCode show/hide\nlibrary(mets)\noptions(contrasts=c(\"contr.treatment\", \"contr.poly\"))\nresmeanIPCW(Event(followup,fail)~factor(tment)+alb+log2bili,\n            data=pbcsub, time=3, model=\"lin\",\n            cens.model=~strata(tment))\n\n\n\n   n events\n 343     67\n\n 343 clusters\ncoeffients:\n                Estimate   Std.Err      2.5%     97.5% P-value\n(Intercept)     2.722803  1.326849  0.122227  5.323380  0.0402\nfactor(tment)1  0.144855  0.085063 -0.021866  0.311576  0.0886\nalb             0.022829  0.027178 -0.030438  0.076096  0.4009\nlog2bili       -0.223035  0.093775 -0.406830 -0.039240  0.0174\n\nexp(coeffients):\n               Estimate     2.5%    97.5%\n(Intercept)    15.22293  1.13001 205.0758\nfactor(tment)1  1.15587  0.97837   1.3656\nalb             1.02309  0.97002   1.0791\nlog2bili        0.80009  0.66576   0.9615\n\n\n\n\n\n\n\nCode show/hide\nproc rmstreg data=pbc3 tau=3;\n  model followup*status(0)=tment alb log2bili / \n        link=linear method=ipcw(strata=tment);\nrun;\n\n\n\n\n\n\n\nIn-text: RMST g-formula and bootstrap\n\nR\n\n\n\n\nCode show/hide\npbcsub <- subset(pbc3,!is.na(alb))\ntime   <- pbcsub$days/365.25\nstatus <- pbcsub$status!=0\narm    <- pbcsub$tment==\"1\"\nalb    <- pbcsub$alb\nlogbili<- log2(pbcsub$bili)\nxx <- cbind(alb, logbili)\ntrydata<-as.data.frame(cbind(arm,time,status,xx))\n\nboot.fun <- function(dat, index){\nbdata <- dat[index,]\nobj<-rmst2(bdata$time,bdata$status,bdata$arm,tau=3,\n           covariates=cbind(bdata$alb,bdata$logbili))\nrmst0<-obj$RMST.difference.adjusted[1,1]+\n  obj$RMST.difference.adjusted[2,1]*0+\n  obj$RMST.difference.adjusted[3,1]*bdata$alb+\n  obj$RMST.difference.adjusted[4,1]*bdata$logbili\nrmst1<-obj$RMST.difference.adjusted[1,1]+\n  obj$RMST.difference.adjusted[2,1]*1+\n  obj$RMST.difference.adjusted[3,1]*bdata$alb+\n  obj$RMST.difference.adjusted[4,1]*bdata$logbili\ndiff<-rmst1-rmst0\nres<-cbind(mean(rmst0),mean(rmst1),mean(diff))\nreturn(res)\n}\n\nlibrary(boot)\nB<-200\nbootres <- boot(trydata, boot.fun, R = B)\n\n# mean and SD\nrbind(\n  cbind(Placebo=mean(bootres$t[,1]),\n        CyA=mean(bootres$t[,2]),\n        Diff=mean(bootres$t[,3])),\n  cbind(Placebo=sqrt(var(bootres$t[,1])),\n        CyA=sqrt(var(bootres$t[,2])),\n        Diff=sqrt(var(bootres$t[,3])))\n)\n\n\n        Placebo        CyA       Diff\n[1,] 2.56815001 2.72999845 0.16184844\n[2,] 0.06209124 0.05416741 0.07844583\n\n\n\n\n\n\n\nTable 4.5\n\nRSAS\n\n\n\nUsing mets package\n\n\nCode show/hide\nlibrary(mets)\noptions(contrasts=c(\"contr.treatment\", \"contr.poly\"))\nsubpbc<-subset(pbc3, !is.na(alb))\nsubpbc$tment<-factor(subpbc$tment)\n\n# Death w/o transplant\nfgdeath<-cifreg(Event(days,status)~factor(tment)+alb+log2bili+sex+age, cause=2, \n                data = subpbc, propodds=NULL)\nfgdeath\n\n\nCall:\ncifreg(formula = Event(days, status) ~ factor(tment) + alb + \n    log2bili + sex + age, data = subpbc, cause = 2, propodds = NULL)\n\n   n events\n 343     60\n\n 343 clusters\ncoeffients:\n                Estimate      S.E.   dU^-1/2 P-value\nfactor(tment)1 -0.352775  0.260075  0.267053  0.1750\nalb            -0.061245  0.030848  0.028700  0.0471\nlog2bili        0.615653  0.088872  0.090387  0.0000\nsex             0.414735  0.316821  0.312520  0.1905\nage             0.087488  0.015744  0.016208  0.0000\n\nexp(coeffients):\n               Estimate    2.5%  97.5%\nfactor(tment)1  0.70274 0.42210 1.1700\nalb             0.94059 0.88541 0.9992\nlog2bili        1.85087 1.55499 2.2030\nsex             1.51397 0.81365 2.8171\nage             1.09143 1.05826 1.1256\n\n\nCode show/hide\n# Transplant\nfgtrans<-cifreg(Event(days,status)~factor(tment)+alb+log2bili+sex+age, cause=1, \n                data = subpbc, propodds=NULL, cox.prep=TRUE)\nfgtrans\n\n\nCall:\ncifreg(formula = Event(days, status) ~ factor(tment) + alb + \n    log2bili + sex + age, data = subpbc, cause = 1, propodds = NULL, \n    cox.prep = TRUE)\n\n   n events\n 343     28\n\n 343 clusters\ncoeffients:\n                Estimate      S.E.   dU^-1/2 P-value\nfactor(tment)1 -0.407479  0.368430  0.403161  0.2687\nalb            -0.069736  0.032685  0.038429  0.0329\nlog2bili        0.619024  0.101177  0.128955  0.0000\nsex             0.087804  0.579890  0.551723  0.8796\nage            -0.075062  0.017119  0.020770  0.0000\n\nexp(coeffients):\n               Estimate    2.5%  97.5%\nfactor(tment)1  0.66533 0.32317 1.3698\nalb             0.93264 0.87477 0.9943\nlog2bili        1.85711 1.52306 2.2644\nsex             1.09177 0.35037 3.4020\nage             0.92769 0.89708 0.9593\n\n\n\n\nUsing survival package\n\n\nCode show/hide\n# Death w/o transplant\n# Two step\nfg_c2 <- finegray(Surv(days, as.factor(status)) ~ ., etype = 2,\n                  data = subset(pbc3, !is.na(alb)))\nfg_cox2 <- coxph(Surv(fgstart, fgstop, fgstatus) ~ \n                   tment + alb + log2bili + sex + age, \n                 weight = fgwt, data = fg_c2, eps=1e-9)\nsummary(fg_cox2)\n\n\nCall:\ncoxph(formula = Surv(fgstart, fgstop, fgstatus) ~ tment + alb + \n    log2bili + sex + age, data = fg_c2, weights = fgwt, eps = 1e-09)\n\n  n= 1004, number of events= 60 \n\n             coef exp(coef) se(coef) robust se      z Pr(>|z|)    \ntment    -0.35282   0.70270  0.26705   0.25111 -1.405   0.1600    \nalb      -0.06122   0.94062  0.02870   0.02933 -2.087   0.0369 *  \nlog2bili  0.61556   1.85069  0.09038   0.08521  7.224 5.06e-13 ***\nsex       0.41484   1.51412  0.31251   0.30590  1.356   0.1751    \nage       0.08748   1.09142  0.01621   0.01507  5.804 6.47e-09 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n         exp(coef) exp(-coef) lower .95 upper .95\ntment       0.7027     1.4231    0.4296    1.1495\nalb         0.9406     1.0631    0.8881    0.9963\nlog2bili    1.8507     0.5403    1.5660    2.1871\nsex         1.5141     0.6604    0.8313    2.7577\nage         1.0914     0.9162    1.0597    1.1241\n\nConcordance= 0.829  (se = 0.024 )\nLikelihood ratio test= 89.68  on 5 df,   p=<2e-16\nWald test            = 111.5  on 5 df,   p=<2e-16\nScore (logrank) test = 93.71  on 5 df,   p=<2e-16,   Robust = 43.86  p=2e-08\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\nCode show/hide\n# Transplant\n# Two step\nfg_c1 <- finegray(Surv(days, as.factor(status)) ~ ., etype = 1,\n                  data = subset(pbc3, !is.na(alb)))\nfg_cox1 <- coxph(Surv(fgstart, fgstop, fgstatus) ~ \n                   tment + alb + log2bili + sex + age, \n                 weight = fgwt, data = fg_c1, eps=1e-9)\nsummary(fg_cox1)\n\n\nCall:\ncoxph(formula = Surv(fgstart, fgstop, fgstatus) ~ tment + alb + \n    log2bili + sex + age, data = fg_c1, weights = fgwt, eps = 1e-09)\n\n  n= 1068, number of events= 28 \n\n             coef exp(coef) se(coef) robust se      z Pr(>|z|)    \ntment    -0.40756   0.66527  0.40311   0.34977 -1.165   0.2439    \nalb      -0.06960   0.93276  0.03844   0.03005 -2.316   0.0205 *  \nlog2bili  0.61867   1.85646  0.12892   0.09119  6.785 1.16e-11 ***\nsex       0.09043   1.09465  0.55193   0.55524  0.163   0.8706    \nage      -0.07507   0.92768  0.02077   0.01590 -4.720 2.36e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n         exp(coef) exp(-coef) lower .95 upper .95\ntment       0.6653     1.5031    0.3352    1.3205\nalb         0.9328     1.0721    0.8794    0.9894\nlog2bili    1.8565     0.5387    1.5526    2.2198\nsex         1.0946     0.9135    0.3687    3.2501\nage         0.9277     1.0780    0.8992    0.9570\n\nConcordance= 0.858  (se = 0.025 )\nLikelihood ratio test= 52.17  on 5 df,   p=5e-10\nWald test            = 78.57  on 5 df,   p=2e-15\nScore (logrank) test = 56.42  on 5 df,   p=7e-11,   Robust = 21.26  p=7e-04\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\n\n\n\n\n\nCode show/hide\n* Death without transplantation; \nproc phreg data=pbc3;\n    class sex (ref='1') tment (ref='0');\n    model days*status(0)=sex tment age log2bili alb / rl eventcode=2;\nrun;\n\n* Transplantation; \nproc phreg data=pbc3;\n    class sex (ref='1') tment (ref='0');\n    model days*status(0)=sex tment age log2bili alb / rl eventcode=1;\nrun;\n\n\n\n\n\n\n\nIn-text: Fine-Gray and g-formula\nUsing mets package and not bootstrap as in book.\n\nRSAS\n\n\n\n\nCode show/hide\n# Fine-Gray models using package mets\nlibrary(mets)\noptions(contrasts=c(\"contr.treatment\", \"contr.poly\"))\n# Transplant\nsubpbc<-subset(pbc3, !is.na(alb))\nsubpbc$trt<-factor(subpbc$tment)\nfgtrans<-cifreg(Event(days,status)~trt+alb+log2bili+sex+age, cause=1, \n                data = subpbc, propodds=NULL, cox.prep=TRUE)\nsummary(survivalG(fgtrans, subpbc, 2*365.25))\n\n\nrisk:\n      Estimate Std.Err    2.5%   97.5%   P-value\nrisk0  0.06890 0.01994 0.02983 0.10798 0.0005477\nrisk1  0.04895 0.01310 0.02327 0.07464 0.0001875\n\nAverage Treatment effects (G-estimator) :\n   Estimate Std.Err     2.5%   97.5% P-value\np1 -0.01995 0.01915 -0.05748 0.01758  0.2975\n\nAverage Treatment effect ratio (G-estimator) :\n      Estimate Std.Err      2.5%    97.5%   P-value\n[p1] 0.7104376 0.21938 0.2804607 1.140415 0.1868643\n\n\nCode show/hide\n# Death w/o transplant\nfgdeath<-cifreg(Event(days,status)~trt+alb+log2bili+sex+age, cause=2, \n                data = subpbc, propodds=NULL, cox.prep=TRUE)\nsummary(survivalG(fgdeath, subpbc, 2*365.25))\n\n\nrisk:\n      Estimate Std.Err    2.5%  97.5%   P-value\nrisk0  0.11694 0.02164 0.07453 0.1594 6.520e-08\nrisk1  0.08815 0.01890 0.05111 0.1252 3.107e-06\n\nAverage Treatment effects (G-estimator) :\n   Estimate Std.Err     2.5%   97.5% P-value\np1 -0.02879 0.02126 -0.07046 0.01289  0.1758\n\nAverage Treatment effect ratio (G-estimator) :\n      Estimate   Std.Err      2.5%    97.5%   P-value\n[p1] 0.7538432 0.1581281 0.4439178 1.063769 0.1195436\n\n\n\n\n\n\n\n\n\n\n\n\nFigure 4.17\n\nRSAS\n\n\n\nFigure 4.17 (a)\n\n\nCode show/hide\n# Fine-Gray model for death w/o transplant\n# Predictions \n# Placebo\nnewd_t0 <- data.frame(tment = 0, age = 40, \n                      alb = 38, log2bili = log2(45), \n                      sex = 0)\nC2_t0 <- survfit(fg_cox2, ctype = 2, newdata = newd_t0)$cumhaz \n\n# CyA\nnewd_t1 <- data.frame(tment = 1, age = 40, \n                      alb = 38, log2bili = log2(45), \n                      sex = 0)\nC2_t1 <- survfit(fg_cox2, ctype = 2, newdata = newd_t1)$cumhaz \n\ntime <- survfit(fg_cox2, ctype = 2, newdata = newd_t1)$time\n\n# Make data ready for plotting \npdata <- data.frame(time = c(time, time), \n                    cif = c(C2_t0, C2_t1), \n                    tment = c(rep(\"Placebo\", length(time)), \n                              rep(\"CyA\", length(time))))\n\n# Create Figure\nfig4.17a <- ggplot(aes(x = time / 365.25, y = cif, linetype = tment), \n                 data = pdata) + \n  geom_step(linewidth = 1) + \n  scale_linetype_manual(\"Treatment\", values = c(\"dashed\", \"solid\"),guide = guide_legend(reverse = TRUE)) + \n  xlab(\"Time since randomization (years)\") + \n  ylab('Cumulative incidence for death w/o transplantation') + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 6), \n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.02, 0.05)), \n                     limits = c(0, 1.0), \n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general + \n  theme(legend.position=\"bottom\", legend.box = \"vertical\")\n      #  legend.key.size = unit(1.5, 'cm'))\n\nfig4.17a\n\n\n\n\n\n\n\nFigure 4.17 (b)\n\n\nCode show/hide\n# Fine-Gray model for transplant\n# Predictions \n# Placebo\nC1_t0 <- survfit(fg_cox1, ctype = 2, newdata = newd_t0)$cumhaz \n\n# CyA\nC1_t1 <- survfit(fg_cox1, ctype = 2, newdata = newd_t1)$cumhaz \n\ntime <- survfit(fg_cox1, ctype = 2, newdata = newd_t1)$time\n\n# Make data ready for plotting \npdata <- data.frame(time = c(time, time), \n                    cif = c(C1_t0, C1_t1), \n                    tment = c(rep(\"Placebo\", length(time)), \n                              rep(\"CyA\", length(time))))\n\n# Create Figure\nfig4.17b <- ggplot(aes(x = time / 365.25, y = cif, linetype = tment), \n                 data = pdata) + \n  geom_step(linewidth = 1) + \n  scale_linetype_manual(\"Treatment\", values = c(\"dashed\", \"solid\"),guide = guide_legend(reverse = TRUE)) + \n  xlab(\"Time since randomization (years)\") + \n  ylab('Cumulative incidence for transplantation') + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 6), \n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.02, 0.05)), \n                     limits = c(0, 1.0), \n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general + \n  theme(legend.box = \"vertical\",\n        legend.key.size = unit(1.5, 'cm'))\n\n\nfig4.17b\n\n\n\n\n\n\n\n\n\nCovariate values\n\n\nCode show/hide\ndata cov0;\n    input sex tment age alb log2bili;\n    log2bili=log2(log2bili);\n    datalines;\n    0 0 40 38 45\n    ;\nrun;\ndata cov1;\n    input sex tment age alb log2bili;\n    log2bili=log2(log2bili);\n    datalines;\n    0 1 40 38 45\n    ;\nrun;\n\n\n\n\nFigure 4.17 (a)\n\n\nCode show/hide\n* For death without transplantation; \nproc phreg data=pbc3;\n    model days*status(0)=sex tment age log2bili alb/eventcode=2;\n    baseline out=cuminc20 covariates=cov0 cif=cif20;\nrun;\nproc phreg data=pbc3;\n    model days*status(0)=sex tment age log2bili alb/eventcode=2;\n    baseline out=cuminc21 covariates=cov1 cif=cif21;\nrun;\ndata cuminc2; \n    merge cuminc20 cuminc21; \n    by days; \nrun;\ndata cuminc2; \n    set cuminc2; \n    daysyears = days / 365.25; \nrun; \nproc gplot data=cuminc2;\n    plot cif20*daysyears cif21*daysyears/overlay haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none label=(a=90 'Cumulative incidences for death');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\nrun;\nquit;\n\n\n\n\nFigure 4.17 (b)\n\n\nCode show/hide\n* For transplantation; \nproc phreg data=pbc3;\n    *class sex tment (ref='0');\n    model days*status(0)=sex tment age log2bili alb/eventcode=1;\n    baseline out=cuminc10 covariates=cov0 cif=cif10;\nrun;\nproc phreg data=pbc3;\n    *class sex tment (ref='0');\n    model days*status(0)=sex tment age log2bili alb/eventcode=1;\n    baseline out=cuminc11 covariates=cov1 cif=cif11;\nrun;\ndata cuminc1; \n    merge cuminc10 cuminc11; \n    by days; \nrun;\ndata cuminc1; \n    set cuminc1; \n    daysyears = days / 365.25; \nrun; \nproc gplot data=cuminc1;\n    plot cif10*daysyears cif11*daysyears/overlay haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none label=(a=90 'Cumulative incidence for transpl.');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\nrun;\nquit;\n\n\n\n\n\n\n\n\nTable 4.6\n\nR\n\n\n\nCreate R function rmtl.ipcw()\nThe function rmtl.ipcw() fit a restricted mean time lost regression model using IPCW with competing risks data.\n\n\nCode show/hide\n### Note: This code is modified from the original 'rmst2reg function' of the\n### survRM2 package, which was authored by Hajime Uno, Lu Tian, Angel Cronin, \n### Chakib Battioui, and Miki Horiguchi, in order to account for competing risks.\n### Last updated by Sarah Conner on October 22, 2020\n\nlibrary(survival)\n\nrmtl.ipcw <- function(times, event, eoi=1, tau, cov=NULL, strata=FALSE, group=NULL){\n  \n  if(is.null(group) & strata==TRUE){stop('Please specify a factor variable to statify weights.')}\n  if(is.null(cov)){print('Warning: Fitting intercept-only model.')}\n  \n  # Round event times to avoid issues with survival() package rounding differently\n  y <- round(times,4)\n  id <- 1:length(y)\n  \n  # Recode so delta1 reflects event of interest, delta2 reflects all competing events. Assumes 0=censoring.\n  delta1 <- ifelse(event==eoi, 1, 0)\n  delta2 <- ifelse(event!=0 & event!=eoi, 1, 0)\n  \n  # Overall quantities\n  x <- cbind(int=rep(1, length(y)), cov)\n  p <- length(x[1,])\n  if(is.null(group)){group <- as.factor(rep(1, length(y)))}\n  \n  # Recode event indicators to reflect status at chosen tau\n  delta1[y>tau] <- 0\n  delta2[y>tau] <- 0\n  \n  y <- pmin(y, tau)\n  y1 <- y*delta1\n  \n  d0 <- 1 - (delta1 + delta2) # censoring indicator\n  d0[y==tau] <- 0  # If follow-up lasts til tau, the event will not count as 'censored' in IPCW weights\n  weights <- NULL\n  \n  ## Calculate IPCW weights (option to stratify by group) ## \n  \n  if(strata==TRUE){\n    for(aa in 1:length(unique(group))){\n      # Subset the group\n      a <- unique(group)[aa]\n      d0.a <- d0[group==a]\n      delta1.a <- delta1[group==a]\n      y.a <- y[group==a]\n      x.a <- x[group==a,]\n      n.a <- length(d0.a)\n      orig.id.a0 <- orig.id.a <- id[group==a]\n      \n      # Order the event times\n      id.a <- order(y.a)\n      y.a <- y.a[id.a]\n      d0.a <- d0.a[id.a]\n      delta1.a <- delta1.a[id.a]\n      x.a <- x.a[id.a,]\n      orig.id.a <- orig.id.a[id.a]\n      \n      # Derive IPCW\n      fit <- survfit(Surv(y.a, d0.a) ~ 1)\n      weights.a <- (1-d0.a)/rep(fit$surv, table(y.a))\n      \n      # Need to assign weights accordig to original ID, not ordered by event time\n      linked.weights.a <- cbind(orig.id.a, weights.a, delta1.a, d0.a, y.a)\n      weights <- rbind(weights, linked.weights.a)\n    }\n  } else {\n    \n    # Order the event times\n    id.a <- order(y)\n    y.a <- y[id.a]\n    d0.a <- d0[id.a]\n    delta1.a <- delta1[id.a]\n    x.a <- x[id.a,]\n    orig.id.a <- id[id.a]\n    \n    # Derive IPCW\n    fit <- survfit(Surv(y.a, d0.a) ~ 1)\n    weights.a <- (1-d0.a)/rep(fit$surv, table(y.a))\n    \n    # Need to assign weights accordig to original ID, not ordered by event time\n    linked.weights.a <- cbind(orig.id.a, weights.a, delta1.a, d0.a, y.a)\n    weights <- rbind(weights, linked.weights.a)\n  }\n  \n  \n  ## Fit linear model ## \n  \n  # Link weights to original data frame\n  #colnames(weights) <- c('id', 'weights')\n  #data <- merge(data0, weights, by='id')\n  #summary(lm(tau-y ~ x-1, weights=weights, data=data))\n  \n  # Or, sort weights and use vectors\n  w <- weights[order(weights[, 1]),2]\n  lm.fit <- lm(delta1*(tau-y) ~ x-1, weights=w)\n  \n  \n  ## Derive SE ##\n  \n  beta0 <- lm.fit$coef\n  error <- tau - y - as.vector(x %*% beta0)\n  score <- x * w * error\n  \n  # Kappa (sandwich variance components) stratified by group\n  kappa <- NULL\n  \n  for(aa in 1:length(unique(group))){\n    \n    # Subset the group\n    a <- unique(group)[aa]\n    d0.a <- d0[group==a]\n    delta1.a <- delta1[group==a]\n    y.a <- y[group==a]\n    x.a <- x[group==a,]\n    n.a <- length(d0.a)\n    orig.id.a0 <- orig.id.a <- id[group==a]\n    score.a <- score[group==a,]\n    \n    # Kappa calculations for sandwich variance\n    kappa.a <- matrix(0, n.a, p)\n    \n    for(i in 1:n.a){\n      kappa1 <- score.a[i,]\n    \n      kappa2 <- apply(score.a[y.a>=y.a[i],,drop=F], 2, sum)*(d0.a[i])/sum(y.a>=y.a[i])\n    \n      kappa3 <- rep(0, p)\n    \n      for(k in 1:n.a){\n        if(y.a[k]<=y.a[i]){\n          kappa3 <- kappa3+apply(score.a[y.a>=y.a[k],,drop=F], 2, sum)*(d0.a[k])/(sum(y.a>=y.a[k]))^2\n        }\n      }\n  \n      kappa.a[i,] <- kappa1+kappa2-kappa3\n    }\n    kappa <- rbind(kappa, kappa.a)\n  }\n  \n  # Transpose the kappas rbinded from each group gives pxp matrix\n  gamma <- t(kappa) %*% kappa\n  \n  A <- t(x) %*% x\n  varbeta <- solve(A) %*% gamma %*% solve(A)\n  se <- sqrt(diag(varbeta))\n  \n  \n  #--- Return results ---\n  \n  res <- cbind(beta=lm.fit$coef, se=se, cil=lm.fit$coef-(1.96*se), ciu=lm.fit$coef+(1.96*se), \n               z=lm.fit$coef/se, p=2*(1-pnorm(abs(lm.fit$coef/se))))\n  #rownames(res) <- c(\"Intercept\", colnames(x[,-1])) FJERNET! PKA 030621\n  \n  allres <- list(res=res, varbeta=varbeta)\n  #print(round(res, 3))\n  invisible(allres)\nreturn(res[,1]) #tilføjet 040322\n}  \n\n\n\n\nUsing rmtl.ipcw() function\n\n\nCode show/hide\nrmtl.ipcw(pbc3$days/365.25,pbc3$status,eoi=2,tau=3,cov=pbc3$tment)\n\n\n        xint         xcov \n0.2438698018 0.0001853217 \n\n\nCode show/hide\nrmtl.ipcw(pbc3$days/365.25,pbc3$status,eoi=1,tau=3,cov=pbc3$tment)\n\n\n       xint        xcov \n 0.13827426 -0.04885493 \n\n\nCode show/hide\npbcny   <- subset(pbc3,!is.na(alb))\ntime    <- pbcny$days/365.25\nstatus  <- pbcny$status\narm     <- pbcny$tment\nsex     <- pbcny$sex\nage     <- pbcny$age\nalb     <- pbcny$alb\nlogbili <- log2(pbcny$bili)\n\nx <- cbind(arm, alb, logbili, sex, age)\nrmtl.ipcw(time, status, eoi=2, tau=3, x)\n\n\n       xint        xarm        xalb    xlogbili        xsex        xage \n-0.47710972 -0.08191763 -0.01872268  0.15948703  0.12945255  0.01324603 \n\n\nCode show/hide\nrmtl.ipcw(time, status, eoi=1, tau=3, x)\n\n\n        xint         xarm         xalb     xlogbili         xsex         xage \n 0.595880668 -0.066527285 -0.006567316  0.071836632  0.131691403 -0.010132691 \n\n\nCode show/hide\nx1 <- cbind(arm, alb, logbili)\nrmtl.ipcw(time, status, eoi=2, tau=3, x1)\n\n\n       xint        xarm        xalb    xlogbili \n 0.79996123 -0.07930867 -0.02829702  0.12396009 \n\n\nCode show/hide\nrmtl.ipcw(time, status, eoi=1, tau=3, x1)\n\n\n        xint         xarm         xalb     xlogbili \n-0.201485168 -0.068452390 -0.002058876  0.091436591 \n\n\n\n\nUsing mets package\nHowever, does not give exactly same results as hard code\n\n\nCode show/hide\nlibrary(mets)\n\n# Death without transplantation\nresmeanIPCW(Event(days/365.25,status)~factor(tment),cause=2,\n            data=pbc3, time=3, model=\"linear\")\n\n\n\n   n events\n 349     47\n\n 349 clusters\ncoeffients:\n                Estimate   Std.Err      2.5%     97.5% P-value\n(Intercept)     0.253900  0.053258  0.149517  0.358284  0.0000\nfactor(tment)1 -0.019753  0.073194 -0.163211  0.123704  0.7873\n\nexp(coeffients):\n               Estimate    2.5%  97.5%\n(Intercept)     1.28904 1.16127 1.4309\nfactor(tment)1  0.98044 0.84941 1.1317\n\n\nCode show/hide\nresmeanIPCW(Event(days/365.25,status)~factor(tment)+alb+log2bili+sex+age,cause=2,\n            data=subset(pbc3,!is.na(alb)), time=3, model=\"linear\")\n\n\n\n   n events\n 343     47\n\n 343 clusters\ncoeffients:\n                 Estimate    Std.Err       2.5%      97.5% P-value\n(Intercept)    -0.7249855  0.4048719 -1.5185199  0.0685489  0.0733\nfactor(tment)1 -0.0804114  0.0668270 -0.2113898  0.0505670  0.2289\nalb            -0.0151672  0.0063347 -0.0275830 -0.0027514  0.0167\nlog2bili        0.1729104  0.0323201  0.1095641  0.2362567  0.0000\nsex             0.2071442  0.1068157 -0.0022107  0.4164990  0.0525\nage             0.0141707  0.0030794  0.0081351  0.0202063  0.0000\n\nexp(coeffients):\n               Estimate    2.5%  97.5%\n(Intercept)     0.48433 0.21904 1.0710\nfactor(tment)1  0.92274 0.80946 1.0519\nalb             0.98495 0.97279 0.9973\nlog2bili        1.18876 1.11579 1.2665\nsex             1.23016 0.99779 1.5166\nage             1.01427 1.00817 1.0204\n\n\nCode show/hide\nresmeanIPCW(Event(days/365.25,status)~factor(tment)+alb+log2bili,cause=2,\n            data=subset(pbc3,!is.na(alb)), time=3, model=\"linear\")\n\n\n\n   n events\n 343     47\n\n 343 clusters\ncoeffients:\n                 Estimate    Std.Err       2.5%      97.5% P-value\n(Intercept)     0.4548449  0.3266548 -0.1853868  1.0950766  0.1638\nfactor(tment)1 -0.0888451  0.0688834 -0.2238542  0.0461640  0.1971\nalb            -0.0215121  0.0066239 -0.0344947 -0.0085294  0.0012\nlog2bili        0.1439391  0.0323606  0.0805134  0.2073648  0.0000\n\nexp(coeffients):\n               Estimate    2.5%  97.5%\n(Intercept)     1.57593 0.83078 2.9894\nfactor(tment)1  0.91499 0.79943 1.0472\nalb             0.97872 0.96609 0.9915\nlog2bili        1.15481 1.08384 1.2304\n\n\nCode show/hide\n# Transplantation\nresmeanIPCW(Event(days/365.25,status)~factor(tment),cause=1,\n            data=pbc3, time=3, model=\"lin\")\n\n\n\n   n events\n 349     21\n\n 349 clusters\ncoeffients:\n                Estimate   Std.Err      2.5%     97.5% P-value\n(Intercept)     0.143960  0.041249  0.063114  0.224806  0.0005\nfactor(tment)1 -0.058157  0.051128 -0.158365  0.042052  0.2553\n\nexp(coeffients):\n               Estimate    2.5%  97.5%\n(Intercept)     1.15484 1.06515 1.2521\nfactor(tment)1  0.94350 0.85354 1.0429\n\n\nCode show/hide\nresmeanIPCW(Event(days/365.25,status)~factor(tment)+alb+log2bili+sex+age,cause=1,\n            data=subset(pbc3,!is.na(alb)), time=3, model=\"lin\")\n\n\n\n   n events\n 343     20\n\n 343 clusters\ncoeffients:\n                 Estimate    Std.Err       2.5%      97.5% P-value\n(Intercept)     0.3224456  0.2826487 -0.2315356  0.8764268  0.2540\nfactor(tment)1 -0.0688959  0.0453965 -0.1578714  0.0200796  0.1291\nalb            -0.0038059  0.0042657 -0.0121665  0.0045546  0.3723\nlog2bili        0.0868250  0.0236530  0.0404659  0.1331841  0.0002\nsex             0.1010467  0.0785489 -0.0529064  0.2549998  0.1983\nage            -0.0082742  0.0028017 -0.0137653 -0.0027831  0.0031\n\nexp(coeffients):\n               Estimate    2.5%  97.5%\n(Intercept)     1.38050 0.79331 2.4023\nfactor(tment)1  0.93342 0.85396 1.0203\nalb             0.99620 0.98791 1.0046\nlog2bili        1.09071 1.04130 1.1425\nsex             1.10633 0.94847 1.2905\nage             0.99176 0.98633 0.9972\n\n\nCode show/hide\nresmeanIPCW(Event(days/365.25,status)~factor(tment)+alb+log2bili,cause=1,\n            data=subset(pbc3,!is.na(alb)), time=3, model=\"lin\")\n\n\n\n   n events\n 343     20\n\n 343 clusters\ncoeffients:\n                  Estimate     Std.Err        2.5%       97.5% P-value\n(Intercept)    -0.29824097  0.21529398 -0.72020941  0.12372746  0.1660\nfactor(tment)1 -0.06453816  0.04593998 -0.15457888  0.02550255  0.1601\nalb            -0.00067397  0.00410667 -0.00872290  0.00737496  0.8696\nlog2bili        0.10093806  0.02632894  0.04933429  0.15254183  0.0001\n\nexp(coeffients):\n               Estimate    2.5%  97.5%\n(Intercept)     0.74212 0.48665 1.1317\nfactor(tment)1  0.93750 0.85678 1.0258\nalb             0.99933 0.99132 1.0074\nlog2bili        1.10621 1.05057 1.1648\n\n\n\n\n\n\n\n\nIn-text: Time lost g-formula and bootstrap\n\nR\n\n\n\n\nCode show/hide\nlibrary(boot)\n\n# Transplantation\nboot.fun <- function(dat, index){\nbdata <- dat[index,]\nobj<-rmtl.ipcw(bdata$time,bdata$status,eoi=1,tau=3,cbind(bdata$arm,bdata$alb,bdata$logbili))\nrmst0<-obj[1]+obj[2]*0+obj[3]*bdata$alb+obj[4]*bdata$logbili\nrmst1<-obj[1]+obj[2]*1+obj[3]*bdata$alb+obj[4]*bdata$logbili\ndiff<-rmst1-rmst0\nres<-cbind(mean(rmst0),mean(rmst1),mean(diff))\nreturn(res)\n}\nB<-200 \nset.seed(1234)\ntrydata<-as.data.frame(cbind(time,status,x1))\nbootres <- boot(trydata, boot.fun, R = B)\n\n# mean and SD\nprint(\"Transplantation\")\n\n\n[1] \"Transplantation\"\n\n\nCode show/hide\nrbind(\n  cbind(Placebo=mean(bootres$t[,1]),\n        CyA=mean(bootres$t[,2]),\n        Diff=mean(bootres$t[,3])),\n  cbind(Placebo=sqrt(var(bootres$t[,1])),\n        CyA=sqrt(var(bootres$t[,2])),\n        Diff=sqrt(var(bootres$t[,3])))\n)\n\n\n        Placebo        CyA        Diff\n[1,] 0.14211202 0.07317405 -0.06893798\n[2,] 0.04101209 0.02876443  0.04993619\n\n\nCode show/hide\n# Death without transplantation\nboot.fun <- function(dat, index){\nbdata <- dat[index,]\nobj<-rmtl.ipcw(bdata$time,bdata$status,eoi=2,tau=3,cbind(bdata$arm,bdata$alb,bdata$logbili))\n\nrmst0<-obj[1]+obj[2]*0+obj[3]*bdata$alb+obj[4]*bdata$logbili\nrmst1<-obj[1]+obj[2]*1+obj[3]*bdata$alb+obj[4]*bdata$logbili\ndiff<-rmst1-rmst0\nres<-cbind(mean(rmst0),mean(rmst1),mean(diff))\nreturn(res)\n}\n\ntrydata<-as.data.frame(cbind(time,status,x1))\nbootres <- boot(trydata, boot.fun, R = B)\n# mean and SD\nprint(\"Death without transplantation\")\n\n\n[1] \"Death without transplantation\"\n\n\nCode show/hide\nrbind(\n  cbind(Placebo=mean(bootres$t[,1]),\n        CyA=mean(bootres$t[,2]),\n        Diff=mean(bootres$t[,3])),\n  cbind(Placebo=sqrt(var(bootres$t[,1])),\n        CyA=sqrt(var(bootres$t[,2])),\n        Diff=sqrt(var(bootres$t[,3])))\n)\n\n\n        Placebo        CyA        Diff\n[1,] 0.28945212 0.21368521 -0.07576691\n[2,] 0.05330835 0.05003825  0.07054484\n\n\n\n\n\n\n\nFigure 4.21\n\nRSAS\n\n\n\n\nCode show/hide\n# Overall survival \noverall_surv <- survfit(Surv(days, status != 0) ~ 1, data = pbc3)\n\n# Censoring\ncens_surv <- survfit(Surv(days, status == 0) ~ 1, data = pbc3)\n\n# Make data ready for plotting \npdata <- data.frame(time = c(overall_surv$time, cens_surv$time), \n                    surv = c(overall_surv$surv, cens_surv$surv), \n                    type = c(rep(\"Treatment failure\", length(overall_surv$time)), \n                             rep(\"Censoring\", length(overall_surv$time))))\n\n# Create Figure\nfig4.21 <- ggplot(aes(x = time / 365.25, y = surv, linetype = type), \n                 data = pdata) + \n  geom_step(linewidth = 1) + \n  scale_linetype_manual(\"Type\", values = c(\"dashed\", \"solid\")) + \n  xlab(\"Time since randomization (years)\") + \n  ylab('Probability') + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 6), \n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.02, 0.05)), \n                     limits = c(0, 1.0), \n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general + \n  theme(legend.box = \"vertical\",\n        legend.key.size = unit(1.5, 'cm'))\n\n\nfig4.21\n\n\n\n\n\n\n\n\n\nCode show/hide\nproc phreg data=pbc3 atrisk noprint;\n    model followup*status(1 2)=;\n    baseline out=survcens survival=kmc / method=pl;\nrun;\nproc phreg data=pbc3 atrisk noprint;\n    model followup*status(0)=;\n    baseline out=survdat survival=kms / method=pl;\nrun;\ndata plotsurv; \n    merge survcens survdat; \n    by followup;\nrun;\ndata plotfin; set plotsurv;\n    by followup;\n    retain lastc lasts;\n    if kmc=. then do c=lastc; s=kms; end; \n    if kms=. then do s=lasts; c=kmc; end;\n    if kmc ne . and kms ne . then do; c=kmc; s=kms; end;\n    output;\n    lastc=c; lasts=s;\nrun;\nproc gplot data=plotfin;\n    plot c*followup s*followup/haxis=axis1 vaxis=axis2 overlay;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none\n    label=(a=90 '\"Survival\" probability');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\nrun;\nquit;\n\n\n\n\n\n\n\nIn-text: Cox for censoring\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(broom)\ntidy(coxph(Surv(days, status == 0) ~ tment, data = pbc3, method = \"breslow\"))\n\n\n# A tibble: 1 × 5\n  term  estimate std.error statistic p.value\n  <chr>    <dbl>     <dbl>     <dbl>   <dbl>\n1 tment   0.0840     0.125     0.669   0.503\n\n\nCode show/hide\ntidy(coxph(Surv(days, status == 0) ~ alb, data = pbc3, method = \"breslow\"))\n\n\n# A tibble: 1 × 5\n  term  estimate std.error statistic p.value\n  <chr>    <dbl>     <dbl>     <dbl>   <dbl>\n1 alb    0.00102    0.0128    0.0793   0.937\n\n\nCode show/hide\ntidy(coxph(Surv(days, status == 0) ~ bili, data = pbc3, method = \"breslow\"))\n\n\n# A tibble: 1 × 5\n  term  estimate std.error statistic p.value\n  <chr>    <dbl>     <dbl>     <dbl>   <dbl>\n1 bili  -0.00252   0.00182     -1.39   0.165\n\n\n\n\n\n\nCode show/hide\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model followup*status(1 2)=tment/rl;\nrun;\nproc phreg data=pbc3;\n    model followup*status(1 2)=alb/rl;\nrun;\nproc phreg data=pbc3;\n    model followup*status(1 2)=bili/rl;\nrun;"
  },
  {
    "objectID": "Ch4.html#prova-trial-in-liver-cirrhosis",
    "href": "Ch4.html#prova-trial-in-liver-cirrhosis",
    "title": "4  Intuition for marginal models",
    "section": "PROVA trial in liver cirrhosis",
    "text": "PROVA trial in liver cirrhosis\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\nprova <- read.csv(\"data/prova.csv\", na.strings = c(\".\"))\n# Treatment 2x2 factorial\nprova$beh <- with(prova, as.factor(scle + beta*2))\n# Extra variables\nprovany <- prova\nprovany$log2bili <- with(provany, log2(bili))\n\n\n\n\n\n\nCode show/hide\nproc import out=prova\n    datafile=\"data/prova.csv\"\n    dbms=csv replace;\nrun;\ndata cens;\n  set prova;\n    if timebleed=. then time=timedeath;\n    else time= timebleed + timedeath;\n    beh = scle + beta*2; \n    log2bili = log2(bili);\nrun;\n\n\n\n\n\n\n\nFigure 4.22\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\",\n        text = element_text(size = 20),\n        axis.text.x = element_text(size = 20),\n        axis.text.y = element_text(size = 20))\n\n# Make KM estimate of censoring distribution\nprovany$time <- with(provany, ifelse(!is.na(timebleed), timebleed + timedeath, timedeath))\ncensdist <- survfit(Surv(time, death == 0) ~ 1, data = provany)\ncensdist\n\n\nCall: survfit(formula = Surv(time, death == 0) ~ 1, data = provany)\n\n       n events median 0.95LCL 0.95UCL\n[1,] 286    211    905     796    1082\n\n\nCode show/hide\n# Make data ready for plotting\npdata <- data.frame(time = censdist$time,\n                    surv = censdist$surv)\n\n\n# Create Figure\nfig4.22 <- ggplot(aes(x = time / 365.25, y = surv),\n                 data = pdata) +\n  geom_step(linewidth = 1) +\n  xlab(\"Time since randomization (years)\") +\n  ylab('Probability of no censoring') +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.005)),\n                     limits = c(0, 7),\n                     breaks = seq(0, 7, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.005)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general +\n  theme(legend.box = \"vertical\",\n        legend.key.size = unit(1.5, 'cm'))\n\n\nfig4.22\n\n\n\n\n\n\n\n\n\nCode show/hide\nproc phreg data=cens atrisk noprint;\n    model time*death(1)=;\n    baseline out=survcens survival=kmc / method=pl;\nrun;\ndata survcens; \n    set survcens; \n    timey = time/365.25; \nrun;\nproc gplot data=survcens;\n    plot kmc*timey/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none label=(a=90 'Probability of no censoring');\n    symbol1  v=none i=stepjl c=black;\nrun;\nquit;\n\n\n\n\n\n\n\nTable 4.12\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(survival)\noptions(contrasts=c(\"contr.treatment\", \"contr.poly\"))\n# treat\ncoxph(Surv(time, death == 0) ~ beh, data = provany)\n\n\nCall:\ncoxph(formula = Surv(time, death == 0) ~ beh, data = provany)\n\n         coef exp(coef) se(coef)      z     p\nbeh1  0.03074   1.03122  0.19080  0.161 0.872\nbeh2 -0.04113   0.95970  0.18910 -0.218 0.828\nbeh3  0.04131   1.04218  0.20386  0.203 0.839\n\nLikelihood ratio test=0.22  on 3 df, p=0.9751\nn= 286, number of events= 211 \n\n\nCode show/hide\n# size \ncoxph(Surv(time, death == 0) ~ factor(varsize), data = provany)\n\n\nCall:\ncoxph(formula = Surv(time, death == 0) ~ factor(varsize), data = provany)\n\n                    coef exp(coef) se(coef)      z      p\nfactor(varsize)2 -0.2324    0.7926   0.1465 -1.586 0.1127\nfactor(varsize)3 -0.4386    0.6449   0.2327 -1.885 0.0594\n\nLikelihood ratio test=4.77  on 2 df, p=0.0922\nn= 286, number of events= 211 \n\n\nCode show/hide\n# sex\ncoxph(Surv(time, death == 0) ~ sex, data = provany)\n\n\nCall:\ncoxph(formula = Surv(time, death == 0) ~ sex, data = provany)\n\n       coef exp(coef) se(coef)    z     p\nsex 0.07847   1.08163  0.14542 0.54 0.589\n\nLikelihood ratio test=0.29  on 1 df, p=0.588\nn= 286, number of events= 211 \n\n\nCode show/hide\n# coag\ncoxph(Surv(time, death == 0) ~ coag, data = provany)\n\n\nCall:\ncoxph(formula = Surv(time, death == 0) ~ coag, data = provany)\n\n          coef exp(coef)  se(coef)      z     p\ncoag -0.002827  0.997177  0.002635 -1.073 0.283\n\nLikelihood ratio test=1.18  on 1 df, p=0.2775\nn= 272, number of events= 199 \n   (14 observations deleted due to missingness)\n\n\nCode show/hide\n# bili\ncoxph(Surv(time, death == 0) ~ log2bili, data = provany)\n\n\nCall:\ncoxph(formula = Surv(time, death == 0) ~ log2bili, data = provany)\n\n            coef exp(coef) se(coef)     z    p\nlog2bili 0.07575   1.07870  0.05649 1.341 0.18\n\nLikelihood ratio test=1.77  on 1 df, p=0.1834\nn= 275, number of events= 202 \n   (11 observations deleted due to missingness)\n\n\nCode show/hide\n# age\ncoxph(Surv(time, death == 0) ~ age, data = provany)\n\n\nCall:\ncoxph(formula = Surv(time, death == 0) ~ age, data = provany)\n\n         coef exp(coef)  se(coef)      z       p\nage -0.017105  0.983040  0.005777 -2.961 0.00307\n\nLikelihood ratio test=8.67  on 1 df, p=0.003242\nn= 286, number of events= 211 \n\n\n\n\n\n\nCode show/hide\nproc phreg data=cens;\n    class beh (ref='0');\n    model time*death(1)=beh;\nrun;\nproc phreg data=cens;\n    class varsize (ref='1');\n    model time*death(1)=varsize;\nrun;\nproc phreg data=cens;\n    class sex (ref='1');\n    model time*death(1)=sex;\nrun;\nproc phreg data=cens;\n    model time*death(1)=coag;\nrun;\nproc phreg data=cens;\n    model time*death(1)=log2bili;\nrun;\nproc phreg data=cens;\n    model time*death(1)=age;\nrun;"
  },
  {
    "objectID": "Ch4.html#recurrent-episodes-in-affective-disorders",
    "href": "Ch4.html#recurrent-episodes-in-affective-disorders",
    "title": "4  Intuition for marginal models",
    "section": "Recurrent episodes in affective disorders",
    "text": "Recurrent episodes in affective disorders\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\naffective <- read.csv(\"data/affective.csv\")\naffective$wait <- with(affective, stop - start)\naffectivewlw <- read.csv(\"data/affectivewlw.csv\")\nlibrary(survival)\n\n\n\n\n\n\nCode show/hide\nproc import out=affective\n    datafile=\"data/affective.csv\"\n    dbms=csv replace;\nrun;\ndata affective; \n    set affective; \n    wait = stop - start; \nrun; \ndata angstprev; \n    set affective;\n    by id;\n    retain prev;\n    if first.id then prev=0; \n    output; \n    if state=1 then prev=start; if state=0 then prev=stop;\nrun;\n\n\n\n\n\n\n\nTable 4.3\n\nRSAS - NA\n\n\n\n\nCode show/hide\n# Make dataset ready for mstate \n# From Out -> In,   trans = 1\n# From Out -> Dead, trans = 2\n# From In -> Out,   trans = 3\n# From In -> Dead,  trans = 4\n# + update status variable\n\nlibrary(dplyr)\naffectivemstate__ <- affective %>% \n  mutate(statusnew = ifelse(status == 3, 0, 1), \n         trans = case_when(state == 0 & status == 1 ~ 1, \n                           state == 0 & status == 2 ~ 2, \n                           state == 1 & status == 0 ~ 3,\n                           state == 1 & status == 2 ~ 4, \n                           state == 0 & status == 3 ~ 1, \n                           state == 1 & status == 3 ~ 3))\n\n# For each transition, we should have a censoring for the trans to the other state\naffectivemstate_ <- affectivemstate__ %>% \n  mutate(statusnew = 0,\n         trans = case_when(trans == 1 ~ 2,\n                           trans == 2 ~ 1, \n                           trans == 3 ~ 4, \n                           trans == 4 ~ 3))\n\naffectivemstate <- rbind(affectivemstate__, affectivemstate_) %>% arrange(id, start)\naffectivemstate <- affectivemstate %>% \n  mutate(from = case_when(trans == 1 ~ 1,\n                          trans == 2 ~ 1, \n                          trans == 3 ~ 2, \n                          trans == 4 ~ 2), \n         to = case_when(trans == 1 ~ 2,\n                        trans == 2 ~ 3, \n                        trans == 3 ~ 1, \n                        trans == 4 ~ 3),\n         starty = start/12, \n         stopy = stop/12\n         )\n\n# Subset data by disease\naffective0 <- subset(affectivemstate, bip == 0)\naffective1 <- subset(affectivemstate, bip == 1)\n\n# Set-up transition matrix\ntmat <- matrix(NA, 3, 3)\ntmat[1, 2:3]    <- 1:2\ntmat[2, c(1,3)] <- 3:4\nstatenames <- c(\"Out of hospital\", \"In hospital\", \"Dead\")\ndimnames(tmat) <- list(from = statenames, to = statenames)\n\nlibrary(mstate)\n## For unipolar (bip = 0) ----------------------------------- ##\nattr(affective0, 'class') <- c(\"msdata\",\"data.frame\")\nattr(affective0, 'trans') <- tmat\n# Fit empty cox model per trans\nc0 <- coxph(Surv(starty, stopy, statusnew) ~ strata(trans), data = affective0)\n# Make a mstate object\nmsf0 <- msfit(object=c0, trans=tmat)\npt0  <- probtrans(msf0, predt=0)\n\n## For bipolar (bip = 1) ----------------------------------- ##\nattr(affective1, 'class') <- c(\"msdata\",\"data.frame\")\nattr(affective1, 'trans') <- tmat\n# Fit empty cox model per trans\nc1 <- coxph(Surv(starty, stopy, statusnew) ~ strata(trans), data = affective1)\n# Make a mstate object\nmsf1 <- msfit(object=c1, trans=tmat)\npt1 <- probtrans(msf1, predt=0)\n\n\nregcoefvec <- function(data, tmat, tau) {\n  cx <- coxph(Surv(starty, stopy, statusnew) ~ strata(trans), data=data)\n  msf0 <- msfit(object = cx, trans = tmat)\n  pt0 <- probtrans(msf0, predt=0)\n  mat <- ELOS(pt0, tau=tau)\n  return(mat[2,])\n}\n\nset.seed(1234)\nres <- msboot(theta=regcoefvec, data=affective0, B=100, id=\"id\", tmat=tmat, tau=15)\nuniest<-regcoefvec(affective0, tmat, 15)\nuniboots<-matrix(c(mean(res[1,]),sqrt(var(res[1,])),\n         mean(res[2,]),sqrt(var(res[2,])),\n         mean(res[3,]),sqrt(var(res[3,]))),\n       nrow = 3, dimnames = list(c(\"Out of hosp\",\"In hosp\",\"Dead\"), c(\"Years\",\"SD\")))\nuni<-list(\"estimate\"=uniest,\"bootstrap\"=uniboots)\nset.seed(1234)\nres <- msboot(theta=regcoefvec, data=affective1, B=100, id=\"id\", tmat=tmat, tau=15)\nbiest<-regcoefvec(affective0, tmat, 15)\nbiboots<-matrix(c(mean(res[1,]),sqrt(var(res[1,])),\n         mean(res[2,]),sqrt(var(res[2,])),\n         mean(res[3,]),sqrt(var(res[3,]))),\n       nrow = 3, dimnames = list(c(\"Out of hosp\",\"In hosp\",\"Dead\"), c(\"Years\",\"SD\")))\nbi<-list(\"estimate\"=biest,\"bootstrap\"=biboots)\nlist(\"Unipolar\"=uni,\"Bipolar\"=bi)\n\n\n$Unipolar\n$Unipolar$estimate\n     in1      in2      in3 \n9.589138 2.202036 3.208826 \n\n$Unipolar$bootstrap\n                Years        SD\nOut of hosp 9.6888785 0.2515182\nIn hosp     0.4962329 3.1828301\nDead        2.1282913 0.4881871\n\n\n$Bipolar\n$Bipolar$estimate\n     in1      in2      in3 \n9.589138 2.202036 3.208826 \n\n$Bipolar$bootstrap\n                 Years        SD\nOut of hosp 12.6037941 0.3523277\nIn hosp      0.7299104 0.8614208\nDead         1.5347851 0.5616117\n\n\n\n\n\n\n\n\n\n\nFigure 4.16\n\nRSAS - NA\n\n\n\n\nCode show/hide\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\n# Make data set with probabilities - predictions from state 2 (in hospital)\n# bip = 0 \nt0 <- data.frame(\n  time = pt0[[2]]$time, \n  pstate1 = pt0[[2]]$pstate1, \n  pstate2 = pt0[[2]]$pstate2, \n  pstate3 = pt0[[2]]$pstate3, \n  bip = rep(\"No\", nrow(pt0[[2]]))\n)\n\n# bip = 1\nt1 <- data.frame(\n  time = pt1[[2]]$time, \n  pstate1 = pt1[[2]]$pstate1, \n  pstate2 = pt1[[2]]$pstate2, \n  pstate3 = pt1[[2]]$pstate3, \n  bip = rep(\"Yes\", nrow(pt1[[2]]))\n)\npstate1 <- data.frame(\n  type = rep(\"Out of hospital\", nrow(pt0[[2]]) + nrow(pt1[[2]])), \n  bip = c(rep(\"No\", nrow(pt0[[2]])), rep(\"Yes\", nrow(pt1[[2]]))),\n  pstate = c(pt0[[2]]$pstate1, pt1[[2]]$pstate1), \n  time = c(pt0[[2]]$time, pt1[[2]]$time))\n\npstate2 <- data.frame(\n  type = rep(\"In hospital\", nrow(pt0[[2]]) + nrow(pt1[[2]])), \n  bip = c(rep(\"No\", nrow(pt0[[2]])), rep(\"Yes\", nrow(pt1[[2]]))),\n  pstate = c(pt0[[2]]$pstate2, pt1[[2]]$pstate2), \n  time = c(pt0[[2]]$time, pt1[[2]]$time))\n\npstate3 <- data.frame(\n  type = rep(\"Dead\", nrow(pt0[[2]]) + nrow(pt1[[2]])),\n  bip = c(rep(\"No\", nrow(pt0[[2]])), rep(\"Yes\", nrow(pt1[[2]]))),\n  pstate = c(pt0[[2]]$pstate3, pt1[[2]]$pstate3), \n  time = c(pt0[[2]]$time, pt1[[2]]$time))\n\nprobs <- rbind(pstate1, pstate2, pstate3)\n\n# A couple of places, a very small negative probability is predicted\n# We fix it + sum here\nt <- probs[probs$pstate <0,]$time #<-0\n\nprobs[probs$bip == \"No\" & probs$time == t[1], \"pstate\"]  <- \n  c(probs[probs$bip == \"No\" & probs$time == t[1], \"pstate\"] %*% c(1,1,0), \n    0, \n    probs[probs$bip == \"No\" & probs$time == t[1], \"pstate\"] %*% c(0,0,1))\n\nprobs[probs$bip == \"No\" & probs$time == t[2], \"pstate\"]  <- \n  c(probs[probs$bip == \"No\" & probs$time == t[2], \"pstate\"] %*% c(1,1,0), \n    0, \n    probs[probs$bip == \"No\" & probs$time == t[2], \"pstate\"] %*% c(0,0,1))\n\nprobs[probs$bip == \"No\" & probs$time == t[3], \"pstate\"]  <- \n  c(probs[probs$bip == \"No\" & probs$time == t[3], \"pstate\"] %*% c(1,1,0), \n    0, \n    probs[probs$bip == \"No\" & probs$time == t[3], \"pstate\"] %*% c(0,0,1))\n\nprobs[probs$bip == \"No\" & probs$time == t[4], \"pstate\"]  <- \n  c(probs[probs$bip == \"No\" & probs$time == t[4], \"pstate\"] %*% c(1,1,0), \n    0, \n    probs[probs$bip == \"No\" & probs$time == t[4], \"pstate\"] %*% c(0,0,1))\n\n\nprobs[probs$bip == \"Yes\" & probs$time == t[5], \"pstate\"]  <- \n  c(probs[probs$bip == \"Yes\" & probs$time == t[5], \"pstate\"] %*% c(1,1,0), \n    0, \n    probs[probs$bip == \"Yes\" & probs$time == t[5], \"pstate\"] %*% c(0,0,1))\n\n\nprobs[probs$bip == \"Yes\" & probs$time == t[6], \"pstate\"]  <- \n  c(probs[probs$bip == \"Yes\" & probs$time == t[6], \"pstate\"] %*% c(1,1,0), \n    0, \n    probs[probs$bip == \"Yes\" & probs$time == t[6], \"pstate\"] %*% c(0,0,1))\n\n\nprobs[probs$bip == \"Yes\" & probs$time == t[7], \"pstate\"]  <- \n  c(probs[probs$bip == \"Yes\" & probs$time == t[7], \"pstate\"] %*% c(1,1,0), \n    0, \n    probs[probs$bip == \"Yes\" & probs$time == t[7], \"pstate\"] %*% c(0,0,1))\n\nprobs[probs$bip == \"Yes\" & probs$time == t[8], \"pstate\"]  <- \n  c(probs[probs$bip == \"Yes\" & probs$time == t[8], \"pstate\"] %*% c(1,1,0), \n    0, \n    probs[probs$bip == \"Yes\" & probs$time == t[8], \"pstate\"] %*% c(0,0,1))\n\nprobs[probs$bip == \"Yes\" & probs$time == t[9], \"pstate\"]  <- \n  c(probs[probs$bip == \"Yes\" & probs$time == t[9], \"pstate\"] %*% c(1,1,0), \n    0, \n    probs[probs$bip == \"Yes\" & probs$time == t[9], \"pstate\"] %*% c(0,0,1))\n\nprobs[probs$bip == \"Yes\" & probs$time == t[10], \"pstate\"]  <- \n  c(probs[probs$bip == \"Yes\" & probs$time == t[10], \"pstate\"] %*% c(1,1,0), \n    0, \n    probs[probs$bip == \"Yes\" & probs$time == t[10], \"pstate\"] %*% c(0,0,1))\n\n\nprobs2 <- probs[order(probs$bip, probs$type, probs$time, probs$pstate, decreasing = F),]\n\nlibrary(ggpattern)\np1 <- ggplot(aes(x = time), data = subset(probs2, bip == \"No\")) +\n  geom_area_pattern(aes(y = pstate, \n                        pattern = type,\n                        pattern_fill = type ), \n                    fill = 'white', \n                    colour = 'black', \n                    #pattern_density = 0.02, \n                    pattern_aspect_ratio = 1,\n                    pattern_fill = 'darkgrey', \n                    pattern_color = 'black', \n                    pattern_spacing = 0.02,\n                    linewidth = 0.7) + \n  ylab(\"Probability\") + \n  xlab(\"Time since first admission (years)\") + \n  scale_pattern_discrete(name = c(\"State\"), \n                         choices = c(\"circle\", \"stripe\", \"crosshatch\")) + \n  scale_pattern_fill_discrete(name = c(\"State\")) + \n  scale_pattern_spacing_discrete(name = c(\"State\")) + \n  theme_general + ggtitle(\"Unipolar\") + \n  theme(legend.key.size = unit(1, 'cm'))\n\np2 <- ggplot(aes(x = time), data = subset(probs2, bip == \"Yes\")) +\n  geom_area_pattern(aes(y = pstate, \n                        pattern = type,\n                        pattern_fill = type ), \n                    fill = 'white', \n                    colour = 'black', \n                    #pattern_density = 0.02, \n                    pattern_aspect_ratio = 1,\n                    pattern_fill = 'darkgrey', \n                    pattern_color = 'black', \n                    pattern_spacing = 0.02,\n                    linewidth = 0.7) + \n  ylab(\"Probability\") + \n  xlab(\"Time since first admission (years)\") + \n  scale_pattern_discrete(name = c(\"State\"),\n                         choices = c(\"circle\", \"stripe\", \"crosshatch\")) + \n  scale_pattern_fill_discrete(name = c(\"State\")) + \n  scale_pattern_spacing_discrete(name = c(\"State\")) + \n  theme_general + ggtitle(\"Bipolar\") + \n  theme(legend.key.size = unit(1, 'cm'))\n\n# common legend\nlibrary(grid)\nlibrary(gridExtra)\nplots <- list(p1, p2)\ng <- ggplotGrob(plots[[1]] + theme(legend.position=\"bottom\"))$grobs\nlegend <- g[[which(sapply(g, function(x) x$name) == \"guide-box\")]]\nlheight <- sum(legend$height)\ntmp <- arrangeGrob(p1 + theme(legend.position = \"none\"), \n                   p2 + theme(legend.position = \"none\"), \n                   layout_matrix = matrix(c(1, 2), nrow = 1))\n\n\nfig4.16<-grid.arrange(tmp, legend, ncol = 1, \n                       heights = unit.c(unit(1, \"npc\") - lheight, lheight))\n\n\n\n\n\n\n\n\n\n\n\n\n\nTable 4.7\n\nRSAS\n\n\n\n\nCode show/hide\n# In years\nlibrary(dplyr)\naffective <- affective %>% mutate(starty = start / 12, stopy = stop / 12) %>% group_by(id) %>% \n                mutate(prevy1 = lag(starty, n = 1, default = 0), \n                       prevy2 = lag(stopy, n = 1, default = 0),\n                       prevy = ifelse(state == 1, prevy2, prevy1))\n\n# LWYY model - Mortality treated as censoring \nsubaff<-subset(affective, state == 0 | status %in% c(2,3))\nfit1 <- coxph(Surv(prevy, stopy, status == 1) ~ bip + cluster(id), \n              data = subaff, ties = \"breslow\")\nsummary(fit1)\n\n\nCall:\ncoxph(formula = Surv(prevy, stopy, status == 1) ~ bip, data = subaff, \n    ties = \"breslow\", cluster = id)\n\n  n= 661, number of events= 542 \n\n       coef exp(coef) se(coef) robust se     z Pr(>|z|)  \nbip 0.42019   1.52225  0.09446   0.18167 2.313   0.0207 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n    exp(coef) exp(-coef) lower .95 upper .95\nbip     1.522     0.6569     1.066     2.173\n\nConcordance= 0.535  (se = 0.019 )\nLikelihood ratio test= 18.62  on 1 df,   p=2e-05\nWald test            = 5.35  on 1 df,   p=0.02\nScore (logrank) test = 20.07  on 1 df,   p=7e-06,   Robust = 4.15  p=0.04\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\nCode show/hide\n# Ghosh-Lin model - Mortality treated as competing risk\n#library(mets)\n#fit2 <- recreg(Event(prevy, stopy, status) ~ bip + cluster(id),\n#               data = subaff, cause = 1, cens.code = 3, death.code = 2)\n#summary(fit2)\n\n\n\n\n\n\n\n\nNote\n\n\n\nCannot fit Ghosh-Lin model we get the following error: Error in xtfrm.data.frame(x) : cannot xtfrm data frames\nEstimates in the book are from SAS.\n\n\n\n\n\n\nCode show/hide\n* LWYY model - Mortality treated as censoring; \nproc phreg covs(aggregate) data=angstprev;\n    where state=0 or status=2 or status=3;\n    class bip (ref='0');\n    model stop*status(2 3)=bip/entry=prev rl;\n    id id;\nrun;\n\n* Ghosh-Lin model - Mortality treated as competing risk; \nproc phreg data=angstprev;\n    where state=0 or status=2 or status=3;\n    class bip (ref='0');\n    model stop*status(3)=bip/entry=prev eventcode=1 rl;\nrun;\n\n\n\n\n\n\n\nFigure 4.18\n\nRSAS\n\n\n\n\nCode show/hide\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\n# Use Nelson-Aalen to estimate marginal mean, incorrectly censoring for death \nnaa_est <- survfit(Surv(prevy, stopy, status == 1) ~ bip + cluster(id), \n    data = subset(affective, stopy > prevy & (state == 0 | status %in% c(2,3))), \n                   ctype = 1)\n# Collect data for plotting\nplotdata <- data.frame(time = naa_est$time, \n                       mu = naa_est$cumhaz, \n                       bip = c(rep(\"No\", naa_est$strata[[1]]), \n                               rep(\"Yes\", naa_est$strata[[2]])))\n\nfig4.18 <- ggplot(aes(x = time, y = mu, linetype = bip), data = plotdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since first admission (years)\") + \n  ylab(\"Expected number of episodes\") + \n  scale_linetype_manual(\"Bipolar\", values = c(\"dashed\", \"solid\"),\n                        labels=c(\"Unipolar\",\"Bipolar\")) + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 30), \n                     breaks = seq(0, 30, by = 5)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 10), \n                     breaks = seq(0, 10, by = 2)) +\n  theme_general + \n  theme(legend.box = \"vertical\",\n        legend.key.size = unit(1.5, 'cm'))\nfig4.18\n\n\n\n\n\n\n\n\n\nCode show/hide\nods graphics on; \nproc phreg plots(overlay=row)=mcf covs(aggregate) data=angstprev;\n    where state=0 or status=2 or status=3;\n    class bip;\n    model stop*status(2 3)=/entry=prev;\n    id id;\n    strata bip;\n    baseline out=mcfdata cmf=naa;\nrun;\ndata mcfdata; set mcfdata;\n    years=stop/12;\nrun;\nproc gplot data=mcfdata;\n    plot naa*years=bip/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 30 by 5 minor=none label=('Years');\n    axis2 order=0 to 12 by 2 minor=none label=(a=90 'Expected number of episodes');\n    symbol1  v=none i=stepjl c=red;\n    symbol2  v=none i=stepjl c=blue;\nrun;\nquit;\n\n\n\n\n\n\n\nFigure 4.19\n\nRSAS\n\n\n\n\nCode show/hide\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\nlibrary(mets)\nxr <- phreg(Surv(prevy, stopy, status == 1) ~ strata(bip) + cluster(id),\n            data = subset(affective, state == 0 | status %in% c(2,3)))\nxd <- phreg(Surv(prevy, stopy, status == 2) ~ strata(bip) + cluster(id),\n            data = subset(affective, state == 0 | status %in% c(2,3)))\n\nout <- recurrentMarginal(xr, xd)\npout <- data.frame(time = out$cumhaz[,1], \n                   mu = out$cumhaz[,2],\n                   bip = as.factor(out$strata))\n\nNAa_fit <- survfit(Surv(prevy, stopy, status == 1) ~ strata(bip),\n                   data = subset(affective, state == 0 | status %in% c(2,3)),\n                   id = id, ctype = 1, timefix = FALSE)\n  \nKM_fit <- survfit(Surv(prevy, stopy, status == 2) ~ strata(bip),\n                  data = subset(affective, state == 0 | status %in% c(2,3)),\n                  id = id, timefix = FALSE)\n  \n# Adjust hat(mu)\nlS0 <- dplyr::lag(KM_fit$surv[1:(KM_fit$strata[1])], default = 1)\ndA0 <- diff(NAa_fit$cumhaz[1:NAa_fit$strata[1]])\nmu_adj0 <- cumsum(lS0 * c(0, dA0))\n\nlS1 <- dplyr::lag(KM_fit$surv[(KM_fit$strata[1]+1):(KM_fit$strata[1] + KM_fit$strata[2])], default = 1)\ndA1 <- diff(NAa_fit$cumhaz[(KM_fit$strata[1]+1):(KM_fit$strata[1] + KM_fit$strata[2])])\nmu_adj1 <- cumsum(lS1 * c(0, dA1))\n\nplotdata2 <- data.frame(time = KM_fit$time, \n                       mu = c(mu_adj0, mu_adj1), \n                       bip = c(rep(\"No\", length(mu_adj0)), \n                               rep(\"Yes\", length(mu_adj1))))\n\nfig4.19 <- ggplot(aes(x = time, y = mu, linetype = bip), data = plotdata2) + \n  geom_step(linewidth = 1) + \n  xlab(\"Time since first admission (years)\") + \n  ylab(\"Expected number of episodes\") + \n  scale_linetype_manual(\"Bipolar\", values = c(\"dashed\", \"solid\"),\n                        labels=c(\"Unipolar\",\"Bipolar\") ) + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 30), breaks = seq(0, 30, by = 5)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0, 10), breaks = seq(0, 10, by = 2)) +\n  theme_general + \n  theme(legend.box = \"vertical\",\n        legend.key.size = unit(1.5, 'cm'))\nfig4.19\n\n\n\n\n\n\n\n\n\nCode show/hide\n/* Using \"fine-gray model\" in PHREG gives an alternative solution to \n  the estimator for CMF using the Breslow type estimator for \n  the baseline mean function (see p. 199 in book). The estimator is not\n    exactly the same as Cook-Lawless because of a different procedures \n    for ties of terminating events and censorings. If no ties \n    (or no censorings) it equals Cook & Lawless */\n\nproc phreg data=angstprev;\n    where state=0 or status=2 or status=3;\n    model stop*status(3)=/entry=prev eventcode=1;\n    strata bip;\n    baseline out=mcfdata1 cif=naa1;\nrun;\ndata mcfdata1;\n    set mcfdata1;\n    cmf=-log(1-naa1);\n    years=stop/12;\nrun;\nproc gplot data=mcfdata1;\n    plot cmf*years=bip/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 30 by 5 minor=none label=('Years');\n    axis2 order=0 to 12 by 2 minor=none label=(a=90 'Expected number of episodes');\n    symbol1  v=none i=stepjl c=red;\n    symbol2  v=none i=stepjl c=blue;\nrun;\nquit;\n\n\n/*** Calc Cook & Lawless or (Ghosh & Lin (GL)) estimator for CMF 'by hand' ***/\n/* First create KM data for death */\nproc phreg data=angstprev noprint;\n    where state=0 or status=2 or status=3;\n  model stop*status(1 3)= / entry=prev; /* status=2=death */\n  strata bip;\n  baseline out=kmdata survival=km / method=pl ;\nrun;\n/* Second create NAa data */\nproc phreg data=angstprev noprint;\n    where state=0 or status=2 or status=3;\n  model stop*status(2 3)= / entry=prev;/* status=1=event */\n  strata bip;\n  baseline out=nadata cumhaz=na;\nrun;\n/* Use NA data to calculate dA(u), i.e., increments in NAa */\ndata na;\n  set nadata;\n  dAu=na-lag(na);\n  if stop=0 then dAu=0;\n  keep bip stop dAu na;\nrun;\n/* merge NAa and KM data */\ndata merged;\n  merge na kmdata;\n  by bip stop;\nrun;\n/* multiply S(u-) and dA(u) */\ndata fill;\n   set merged;\n   retain _km;\n   if not missing(km) then _km=km;\n   else km=_km;\n   /* S(u-) */\n   S_uminus=lag(km);\n   if stop=0 then S_uminus=1;\n\n   if dAu=. then dAu=0;\n   GLfactor=S_uminus*dAu;\n   keep bip stop na dAu S_uminus GLfactor;\nrun;\ndata GLdata;\n  set fill;\n  by bip;\n  if first.bip then GL=0;\n  else GL+GLfactor;\nrun;\nproc sgplot data=GLdata;\n  step x=stop y=GL / group=bip;\n  step x=stop y=na / group=bip;\nrun;\n\n\n\n\n\n\n\nTable 4.9\n\nRSAS\n\n\n\n\nCode show/hide\n# Number of recurrences and death\nwith(subset(affective, episode < 5), table(episode, status))\n\n\n       status\nepisode   0   1   2   3\n      1 116  99  16   4\n      2  91  82  12   5\n      3  74  62  17   3\n      4  56  47  10   5\n\n\nCode show/hide\napply(with(subset(affective, episode < 5), table(episode, status)), 2, cumsum)\n\n\n       status\nepisode   0   1  2  3\n      1 116  99 16  4\n      2 207 181 28  9\n      3 281 243 45 12\n      4 337 290 55 17\n\n\n\n\n\n\nCode show/hide\ndata angstwlw; \n    set affective;\n    if episode<5 and (state=0 or status=2 or status=3);\nrun;\nproc sort data=angstwlw; \n    by id; \nrun;\nproc freq data=angstwlw;\n    tables episode*status; \nrun;\n\n\n\n\n\n\n\nTable 4.10\n\nRSAS\n\n\n\n\nCode show/hide\n# Make WLW data ready using SAS data - see SAS code\naffectivewlw <- read.csv(\"data/affectivewlw.csv\")\naffectivewlw <- affectivewlw %>% mutate(bip1 = bip * (stratum == 1), \n                                        bip2 = bip * (stratum == 2), \n                                        bip3 = bip * (stratum == 3), \n                                        bip4 = bip * (stratum == 4))\n\n# Composite endpoint\nfit1 <- coxph(Surv(time, dc %in% c(1, 2)) ~ bip1 + bip2 + bip3 + bip4 + cluster(id) + strata(stratum), \n              data = affectivewlw, \n              ties = \"breslow\")\nsummary(fit1)\n\n\nCall:\ncoxph(formula = Surv(time, dc %in% c(1, 2)) ~ bip1 + bip2 + bip3 + \n    bip4 + strata(stratum), data = affectivewlw, ties = \"breslow\", \n    cluster = id)\n\n  n= 476, number of events= 434 \n\n         coef exp(coef) se(coef) robust se     z Pr(>|z|)  \nbip1 0.379171  1.461073 0.244976  0.208531 1.818    0.069 .\nbip2 0.290599  1.337228 0.249212  0.255307 1.138    0.255  \nbip3 0.003218  1.003223 0.253766  0.245542 0.013    0.990  \nbip4 0.107276  1.113241 0.255085  0.236751 0.453    0.650  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n     exp(coef) exp(-coef) lower .95 upper .95\nbip1     1.461     0.6844    0.9709     2.199\nbip2     1.337     0.7478    0.8108     2.206\nbip3     1.003     0.9968    0.6200     1.623\nbip4     1.113     0.8983    0.6999     1.771\n\nConcordance= 0.51  (se = 0.017 )\nLikelihood ratio test= 3.67  on 4 df,   p=0.5\nWald test            = 8.7  on 4 df,   p=0.07\nScore (logrank) test = 3.97  on 4 df,   p=0.4,   Robust = 7.94  p=0.09\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\nCode show/hide\nfit2 <- coxph(Surv(time, dc %in% c(1, 2)) ~ bip + cluster(id) + strata(stratum), \n              data = affectivewlw, \n              ties = \"breslow\")\nsummary(fit2)\n\n\nCall:\ncoxph(formula = Surv(time, dc %in% c(1, 2)) ~ bip + strata(stratum), \n    data = affectivewlw, ties = \"breslow\", cluster = id)\n\n  n= 476, number of events= 434 \n\n      coef exp(coef) se(coef) robust se     z Pr(>|z|)\nbip 0.1927    1.2125   0.1254    0.2037 0.946    0.344\n\n    exp(coef) exp(-coef) lower .95 upper .95\nbip     1.212     0.8248    0.8133     1.808\n\nConcordance= 0.51  (se = 0.017 )\nLikelihood ratio test= 2.27  on 1 df,   p=0.1\nWald test            = 0.89  on 1 df,   p=0.3\nScore (logrank) test = 2.37  on 1 df,   p=0.1,   Robust = 0.95  p=0.3\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\nCode show/hide\n# Cause-specific hazard of recurrence\nfit3 <- coxph(Surv(time, dc %in% c(1)) ~ bip1 + bip2 + bip3 + bip4 + cluster(id) + strata(stratum), \n              data = affectivewlw, \n              ties = \"breslow\")\nsummary(fit3)\n\n\nCall:\ncoxph(formula = Surv(time, dc %in% c(1)) ~ bip1 + bip2 + bip3 + \n    bip4 + strata(stratum), data = affectivewlw, ties = \"breslow\", \n    cluster = id)\n\n  n= 476, number of events= 290 \n\n       coef exp(coef) se(coef) robust se     z Pr(>|z|)   \nbip1 0.4951    1.6406   0.2485    0.2017 2.454  0.01412 * \nbip2 0.6395    1.8956   0.2593    0.2420 2.642  0.00823 **\nbip3 0.5342    1.7060   0.2853    0.2694 1.983  0.04741 * \nbip4 0.8793    2.4093   0.3085    0.2832 3.106  0.00190 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n     exp(coef) exp(-coef) lower .95 upper .95\nbip1     1.641     0.6095     1.105     2.436\nbip2     1.896     0.5275     1.180     3.046\nbip3     1.706     0.5862     1.006     2.893\nbip4     2.409     0.4151     1.383     4.197\n\nConcordance= 0.543  (se = 0.021 )\nLikelihood ratio test= 19.5  on 4 df,   p=6e-04\nWald test            = 16.37  on 4 df,   p=0.003\nScore (logrank) test = 22.58  on 4 df,   p=2e-04,   Robust = 12.85  p=0.01\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\nCode show/hide\nfit4 <- coxph(Surv(time, dc %in% c(1)) ~ bip + cluster(id) + strata(stratum), \n              data = affectivewlw, \n              ties = \"breslow\")\nsummary(fit4)\n\n\nCall:\ncoxph(formula = Surv(time, dc %in% c(1)) ~ bip + strata(stratum), \n    data = affectivewlw, ties = \"breslow\", cluster = id)\n\n  n= 476, number of events= 290 \n\n      coef exp(coef) se(coef) robust se     z Pr(>|z|)   \nbip 0.6150    1.8496   0.1359    0.2106 2.921  0.00349 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n    exp(coef) exp(-coef) lower .95 upper .95\nbip      1.85     0.5407     1.224     2.794\n\nConcordance= 0.543  (se = 0.021 )\nLikelihood ratio test= 18.46  on 1 df,   p=2e-05\nWald test            = 8.53  on 1 df,   p=0.003\nScore (logrank) test = 21.13  on 1 df,   p=4e-06,   Robust = 7.89  p=0.005\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\n\n\n\n\nCode show/hide\ndata angstwlw; \n    set affective;\n    where episode<5 and (state=0 or status=2 or status=3);\nrun;\nproc sort data=angstwlw; \n    by id; \nrun;\ndata angstwlw4; \n    set angstwlw;\n    by id;\n    time=stop; dc=status; stratum=episode;\n    output; \n    /* if last episode is not #4 then later episodes are either\n         censored (1 or 3) or the 'end in death' (2) */\n    if last.id then do;\n        if episode=3 then do;\n            time=stop;\n        if status=1 or status=3 then dc=0; \n            if status=2 then dc=2;\n            stratum=4;\n            output;\n    end;\n        if episode=2 then do;\n            time=stop; \n            if status=1 or status=3 then dc=0; \n            if status=2  then dc=2;\n            stratum=3;\n            output; \n            time=stop;\n            if status=1 or status=3 then dc=0; \n            if status=2 then dc=2;\n            stratum=4;\n            output; \n        end;\n        if episode=1 then do; \n            time=stop;\n            if status=1 or status=3 then dc=0; \n            if status=2 then dc=2;\n            stratum=2;\n            output; \n            time=stop; if status=1 or status=3 then dc=0; \n            if status=2  then dc=2;\n            stratum=3;\n            output; \n            time=stop;\n            if status=1 or status=3 then dc=0; \n            if status=2 then dc=2;\n            stratum=4;\n            output; \n        end;\n    end;\nrun;\n/* to use in R */\nproc export data=angstwlw4\n    outfile=\"data/affectivewlw.csv\"\n    dbms=csv replace;\nrun;\ndata angstwlw4; set angstwlw4;\n    bip1=bip*(stratum=1); bip2=bip*(stratum=2);\n    bip3=bip*(stratum=3); bip4=bip*(stratum=4);\nrun;\n\n/* composite end point */ \nproc phreg data=angstwlw4 covs(aggregate);\n    model time*dc(0 3)=bip1 bip2 bip3 bip4;\n    strata stratum;\n    id id;\n    bip: test bip1=bip2=bip3=bip4;\nrun;\n/* Joint model */\nproc phreg data=angstwlw4 covs(aggregate);\n    model time*dc(0 3)=bip;\n    strata stratum;\n    id id;\nrun;\n\n/* Cause-spec. hazards for 1.,2.,3.,4. event */\nproc phreg data=angstwlw4 covs(aggregate);\n    model time*dc(0 2 3)=bip1 bip2 bip3 bip4;\n    strata stratum;\n    id id;\n    bip: test bip1=bip2=bip3=bip4;\nrun;\n/* Joint model */\nproc phreg data=angstwlw4 covs(aggregate);\n    model time*dc(0 2 3)=bip;\n    strata stratum;\n    id id;\nrun;\n\n\n\n\n\n\n\nFigure 4.23\n\nRSAS\n\n\n\n\nCode show/hide\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n# Last observations\ncens <- affective %>% group_by(id) %>% slice(c(n()))\n# Censoring dist, KM\ncensdist <- survfit(Surv(stop, status == 3) ~ 1, \n                    data = cens)\n# Make data ready for plotting\npdata <- data.frame(time = censdist$time,\n                    surv = censdist$surv)\nfig4.23 <- ggplot(aes(x = time / 12, y = surv), data = pdata) +\n  geom_step(size = 1) +\n  xlab(\"Time since first admission (years)\") +\n  ylab('Probability of no censoring') +\n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)),\n                     limits = c(0, 30),\n                     breaks = seq(0, 30, 5)) +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.005)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general\nfig4.23\n\n\n\n\n\n\n\n\n\nCode show/hide\ndata cens; \n    set affective;\n    by id;\n    if last.id;\nrun;\nproc phreg data=cens atrisk noprint;\n    model stop*status(2)=;\n    baseline out=angstcens survival=kmc / method=pl;\nrun;\ndata angstcens; \n    set angstcens; \n    years=stop/12; \nrun;\nproc gplot data=angstcens;\n    plot kmc*years/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 30 by 5 minor=none label=('Years');\n    axis2 order=0 to 1 by 0.1 minor=none\n    label=(a=90 'Probability of no censoring');\n    symbol1  v=none i=stepjl c=black;\nrun;\nquit;\n\n\n\n\n\n\n\nIn-text: Cox for censoring\n\nRSAS\n\n\n\n\nCode show/hide\ncoxph(Surv(stop,status==3)~bip,data=cens)\n\n\nCall:\ncoxph(formula = Surv(stop, status == 3) ~ bip, data = cens)\n\n       coef exp(coef) se(coef)      z     p\nbip -0.4844    0.6161   0.3738 -1.296 0.195\n\nLikelihood ratio test=1.8  on 1 df, p=0.18\nn= 119, number of events= 41 \n\n\n\n\n\n\nCode show/hide\nproc phreg data=cens;\n    model stop*status(2)=bip/rl;\nrun;"
  },
  {
    "objectID": "Ch4.html#leader-cardiovascular-trial-in-type-2-diabetes",
    "href": "Ch4.html#leader-cardiovascular-trial-in-type-2-diabetes",
    "title": "4  Intuition for marginal models",
    "section": "LEADER cardiovascular trial in type 2 diabetes",
    "text": "LEADER cardiovascular trial in type 2 diabetes\n\n\n\n\nRead data\nAssume that the LEADER data set is loaded in data set leader_mi.\n\n\nFigure 4.20\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(\n    legend.position = \"bottom\",\n    text = element_text(size = 20),\n    axis.text.x = element_text(size = 20),\n    axis.text.y = element_text(size = 20)\n  )\n\nghosh_lin_nonpar_mcf <- function(endpointdat) {\n  # Fit NAa\n  NAa_fit <- survfit(\n    Surv(start, stop, status == 1) ~ treat,\n    data = endpointdat,\n    id = id,\n    ctype = 1\n  )\n  \n  # Fit KM\n  KM_fit <- survfit(\n    Surv(start, stop, status == 2) ~ treat,\n    data = endpointdat,\n    id = id,\n    ctype = 1\n  )\n  \n  # Adjust hat(mu)\n  mu_adj <-\n    c(cumsum(KM_fit$surv[1:KM_fit$strata[[1]]] * c(0, diff(NAa_fit$cumhaz[1:NAa_fit$strata[[1]]]))),\n      cumsum(KM_fit$surv[(KM_fit$strata[[1]] + 1):(KM_fit$strata[[1]] + KM_fit$strata[[2]])] *\n               c(0, diff(NAa_fit$cumhaz[(NAa_fit$strata[[1]] + 1):(NAa_fit$strata[[1]] + NAa_fit$strata[[2]])]))))\n  \n  dat_adj <- data.frame(\n    mu = mu_adj,\n    time = NAa_fit$time,\n    treat = c(\n      rep(\"Liraglutide\", NAa_fit$strata[[1]]),\n      rep(\"Placebo\", NAa_fit$strata[[2]])\n    ),\n    type = rep(\n      \"Mortality treated as a competing risk (CL)\",\n      length(NAa_fit$time)\n    )\n  )\n  \n  dat_unadj <- data.frame(\n    mu = NAa_fit$cumhaz,\n    time = NAa_fit$time,\n    treat = c(\n      rep(\"Liraglutide\", NAa_fit$strata[[1]]),\n      rep(\"Placebo\", NAa_fit$strata[[2]])\n    ),\n    type = rep(\"Mortality treated as censoring (NA)\", length(NAa_fit$time))\n  )\n  \n  dat_adj$both <- with(dat_adj, paste(type, treat, sep = \", \"))\n  dat_unadj$both <- with(dat_unadj, paste(type, treat, sep = \", \"))\n  \n  pdat <- rbind(dat_adj, dat_unadj)\n  \n    ggplot(aes(x = time  * 1 / (365.25 / 12), y = mu), data = pdat) +\n    geom_step(aes(linetype = both), linewidth = 1.05) +\n    xlab(\"Time since randomization (months)\") +\n    ylab(\"Expected number of events per subject\") +\n    scale_color_discrete(\"Treatment\") +\n    scale_linetype_manual(\"\", values = c(\"dotdash\", \"dotted\", \"solid\", \"dashed\")) +\n    theme_general +\n    theme(\n      legend.position = \"bottom\",\n      legend.margin = margin(t = -25),\n      legend.direction = \"vertical\",\n      legend.box = \"horizontal\",\n      text = element_text(size = 20),\n      legend.text = element_text(size = 18),\n      legend.key.width = unit(3, \"cm\")\n    ) +\n    scale_x_continuous(\n      expand = expansion(mult = c(0.005, 0.05)),\n      limits = c(0, 65),\n      breaks = seq(0, 65, by = 12)\n    ) +\n    scale_y_continuous(\n      expand = expansion(mult = c(0.005, 0.05)),\n      limits = c(0, 0.13),\n      breaks = seq(0, 0.13, by = 0.02)\n    )\n  \n}\n\nfig4.20 <- ghosh_lin_nonpar_mcf(endpointdat = leader_mi)\nfig4.20\n\n\n\n\n\n\n\n\n\nCode show/hide\n/* Using \"fine-gray model\" in PHREG gives an alternative solution to \n  the estimator for CMF using the Breslow type estimator for \n  the baseline mean function (see p. 199 in book). The estimator is not\n    exactly the same as Cook-Lawless because of a different procedures \n    for ties of terminating events and censorings. If no ties \n    (or no censorings) it equals Cook & Lawless */\n\n* NELSON-AALEN; \nproc phreg data=leader_mi noprint;\n    model stop*status(0 2)=/entry=start;\n    id id;\n    strata treat;\n  baseline out=na_data cumhaz=naa;\nrun;\ndata na_est;\n    set na_data; \n    type = \"Nelson-Aalen\";\n    cumevent = naa; \n    treat_type = trim(treat) || \", \"  || type; \nrun; \n\n* COOK & LAWLESS (GHOSH & LIN);\nproc phreg data=leader_mi noprint;\n  model (start, stop)*status(0)=/eventcode=1; \n  strata treat;\n  baseline out=gl_data cif=cuminc;\nrun;\ndata gl_est;\n    set gl_data; \n    type = \"Ghosh & Lin\";\n    cumevent = -log(1-cuminc); \n    treat_type = trim(treat) || \", \" || type; \nrun; \ndata comb; \n    set na_est gl_est; \n    time = stop/(365.25/12);\n    drop naa cuminc;\nrun;\nproc sgplot data=comb;\n    step x=time y=cumevent/group=treat_type justify=left;\n    xaxis grid values=(0 to 60 by 12);\n    yaxis grid values=(0 to 0.12 by 0.02);\n    label time=\"Time since randomisation (months)\";\n    label cumevent=\"Expected number events per subject\"; \nrun; \n\n\n/*** Calc Cook & Lawless or (Ghosh & Lin (GL)) estimator for CMF by hand ***/\n/* First create KM data for death */\nproc phreg data=leader_mi noprint;\n  model stop*status(0 1)= / entry=start; /* status=2=death */\n  strata treat;\n  baseline out=kmdata survival=km / method=pl ;\nrun;\n/* Second create NAa data */\nproc phreg data=leader_mi noprint;\n  model stop*status(0 2)= / entry=start; /* status=1=event */\n  strata treat;\n  baseline out=nadata cumhaz=na;\nrun;\n/* Use NA data to calculate dA(u), i.e., increments in NAa */\ndata na;\n  set nadata;\n  dAu=na-lag(na);\n  if stop=0 then dAu=0;\n  keep treat stop dAu na;\nrun;\n/* merge NAa and KM data */\ndata merged;\n  merge na kmdata;\n  by treat stop;\nrun;\n/* multiply S(u-) and dA(u) */\ndata fill;\n   set merged;\n   retain _km;\n   if not missing(km) then _km=km;\n   else km=_km;\n   /* S(u-) */\n   S_uminus=lag(km);\n   if stop=0 then S_uminus=1;\n\n   if dAu=. then dAu=0;\n   GLfactor=S_uminus*dAu;\n   keep treat stop na dAu S_uminus GLfactor;\nrun;\ndata GLdata;\n  set fill;\n  by treat;\n  if first.treat then GL=0;\n  else GL+GLfactor;\n    time = stop/(365.25/12);\nrun;\nproc sgplot data=GLdata;\n  step x=time y=na / group=treat;\n  step x=time y=GL / group=treat;\n    xaxis grid values=(0 to 60 by 12);\n    yaxis grid values=(0 to 0.12 by 0.02);\n    label time=\"Time since randomisation (months)\";\n    label na=\"Expected number events per subject\"; \nrun;\n\n\n\n\n\n\n\nIn-text: LWYY and Ghosh-Lin models\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(survival)\nfit1 <- coxph(Surv(start, stop, status == 1) ~ treat + cluster(id), \n              data = leader_mi, ties = \"breslow\")\nsummary(fit1)\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ treat, data = leader_mi, \n    ties = \"breslow\", cluster = id)\n\n  n= 10120, number of events= 780 \n\n          coef exp(coef) se(coef) robust se      z Pr(>|z|)  \ntreat -0.16418   0.84859  0.07184   0.08810 -1.864   0.0624 .\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n      exp(coef) exp(-coef) lower .95 upper .95\ntreat    0.8486      1.178     0.714     1.009\n\nConcordance= 0.524  (se = 0.011 )\nLikelihood ratio test= 5.24  on 1 df,   p=0.02\nWald test            = 3.47  on 1 df,   p=0.06\nScore (logrank) test = 5.23  on 1 df,   p=0.02,   Robust = 3.47  p=0.06\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\nCode show/hide\n# Ghosh-Lin model - Mortality treated as competing risk\nlibrary(mets)\nfit2 <- recreg(Event(start, stop, status) ~ treat + cluster(id),\n               data = leader_mi, cause = 1, cens.code = 0, death.code = 2)\nsummary(fit2)\n\n\n\n     n events\n 10120    780\n\n 9340 clusters\ncoeffients:\n       Estimate      S.E.   dU^-1/2 P-value\ntreat -0.158754  0.087861  0.071839  0.0708\n\nexp(coeffients):\n      Estimate    2.5%  97.5%\ntreat  0.85321 0.71823 1.0135\n\n\n\n\n\n\nCode show/hide\ntitle 'LWYY model';\nproc phreg data=leader_mi covs(aggregate);\n  class treat(ref=\"0\");\n  model (start, stop)*status(0 2) = treat / rl; \n  id id;\nrun;\n\ntitle 'Ghosh-Lin model';\nproc phreg data=leader_mi covs(aggregate);\n  class treat(ref=\"0\");\n  model (start, stop)*status(0) = treat / rl\n        eventcode=1 convergelike=1E-9; \n  id id;\nrun;"
  },
  {
    "objectID": "Ch4.html#bone-marrow-transplantation-in-acute-leukemia",
    "href": "Ch4.html#bone-marrow-transplantation-in-acute-leukemia",
    "title": "4  Intuition for marginal models",
    "section": "Bone marrow transplantation in acute leukemia",
    "text": "Bone marrow transplantation in acute leukemia\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\nbmt <- read.csv(\"data/bmt.csv\")\nbmt$intxsurv<- bmt$timedeath\nbmt$dead <- bmt$death\nbmt$intxrel <- ifelse(bmt$rel == 1, bmt$timerel, bmt$timedeath)\nbmt$trm     <- ifelse(bmt$rel == 0 & bmt$death == 1, 1, 0)\nbmt$tgvhd   <- ifelse(bmt$gvhd == 1, bmt$timegvhd, bmt$intxrel)\nbmt$tanc500 <- ifelse(bmt$anc500 == 1, bmt$timeanc500, bmt$intxrel)\nbmt$state0  <- bmt$rel + 2*bmt$trm\n\n\n\n\n\n\nCode show/hide\nproc import out=bmt\n    datafile=\"data/bmt.csv\" \n    dbms=csv replace;\nrun;\ndata bmt; \n  set bmt;\n    intxsurv=timedeath;\n    dead=death;\n    if rel=1 then intxrel=timerel;\n    if rel=0 then intxrel=timedeath;\n    trm=0;\n    if rel=0 and death=1 then trm=1;\n    state0=rel+2*trm;\n    if gvhd=1 then tgvhd=timegvhd;\n    if gvhd=0 then tgvhd=intxrel;\nrun;\n\n\n\n\n\n\n\nFigure 4.15\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(ggplot2)\n# General theme\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\nlibrary(survival)\n# Relapse-free survival \nfit1 <- survfit(Surv(intxrel, state0 != 0) ~ 1, data = bmt)\n\n# relapse\nrequire(mets)\nfit2 <- cif(Event(intxrel, state0) ~ 1, data = bmt, cause = 1)\n\n# death in remission\nfit3 <- cif(Event(intxrel, state0) ~ 1, data = bmt, cause = 2)\n\n# overall survival\nfit4 <- survfit(Surv(intxsurv, dead == 1) ~ 1, data = bmt)\n\n# We need the same time for all probabilities\nrequire(dplyr)\nrequire(tidyr)\nm1 <- stepfun(x = fit1$time, y = c(1, fit1$surv)) \nm2 <- stepfun(x = fit2$times, y = c(0, fit2$mu))\nm3 <- stepfun(x = fit3$times, y = c(0, fit3$mu))\nm4 <- stepfun(x = fit4$time, y = c(0, 1-fit4$surv))\n\nunitimes <- sort(unique(c(fit1$time, fit2$times, fit3$times, fit4$time)))\nm <- data.frame(time = unitimes, \n                q0 = m1(unitimes),\n                c1 = m2(unitimes), \n                c2 = m3(unitimes), \n                c23 = m4(unitimes))\n\nm$q2 <-m$c2\nm$q3 <- m$c23 - m$c2\nm$q1 <- m$c1 - m$q3\nm$sum <- with(m, q0+q1+q2+q3)\nm$prev <- with(m, q1 / (q0 + q1))\n\n# Prepare data for plotting\nplotdata <- with(m, \n                 data.frame(time = c(time, time), \n                            prob = c(prev, q1),\n                            type = c(rep(\"Prevalence of relapse\", length(time)), \n                                     rep(\"Probability of being alive with relapse\",\n                                         length(time)))))\n\n# Create Figure\nfig4.15 <- ggplot(aes(x = time, y = prob, linetype = type), data = plotdata) + \n  geom_step(linewidth = 1) + \n  scale_linetype_discrete(\"Type\") + \n  xlab(\"Time since bone marrow transplantation (months)\") + \n  ylab(\"Probability\") + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)), \n                     limits = c(0, 156), breaks = seq(0, 156, by = 12)) + \n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)), \n                     limits = c(0, 0.05), \n                     breaks = seq(0, 0.05, 0.01)) +\n  theme_general + \n  theme(legend.box = \"vertical\",\n        text = element_text(size=21), \n        legend.key.size = unit(1, 'cm'))\n\nfig4.15\n\n\n\n\n\n\n\n\n\nCode show/hide\nproc phreg data=bmt noprint; /* Relapse-free surv */\n    model intxrel*state0(0)=;\n    baseline out=surv survival=km;\nrun;\n\nproc phreg data=bmt noprint; /* Relapse */\n    model intxrel*state0(0)=/eventcode=1;\n    baseline out=cif1 cif=cif1;\nrun;\n\nproc phreg data=bmt noprint; /* Death in remission */\n    model intxrel*state0(0)=/eventcode=2;\n    baseline out=cif2 cif=cif2;\nrun;\n\nproc phreg data=bmt noprint; /* Overall surv. */\n    model intxsurv*dead(0)=/eventcode=1;\n    baseline out=dead cif=cif23;\nrun;\n\n/* We need the same time variable for all probabilities */\ndata dead; set dead; time=intxsurv; run;\ndata surv; set surv; time=intxrel; run;\ndata cif1; set cif1; time=intxrel; run;\ndata cif2; set cif2; time=intxrel; run;\ndata all; merge surv cif1 cif2 dead; by time; run;\n\ndata allrev; \n    set all;\n    by time;\n    retain last1 last2 last3 last4;\n    if km=. then rfs=last1; if km ne . then rfs=km; \n    if cif1=. then c1=last2; if cif1 ne . then c1=cif1;\n    if cif2=. then c2=last3; if cif2 ne . then c2=cif2;\n    if cif23=. then c23=last4; if cif23 ne . then c23=cif23;\n    output;\n    last1=rfs; last2=c1; last3=c2; last4=c23;\nrun;\ndata allrev; \nset allrev;\n    q0=rfs; q2=c2; q3=c23-c2; q1=c1-q3; sum=q0+q1+q2+q3; prev=q1/(q0+q1); tment=0;\nrun;\nproc gplot data=allrev;\n    plot prev*time q1*time/overlay haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 150 by 10 minor=none label=('Months');\n    axis2 order=0 to 0.05 by 0.01 minor=none label=(a=90 'Relapse prev. and prob.');\n    symbol1  v=none i=stepjl c=blue;\n    symbol2  v=none i=stepjl c=red;\nrun;\nquit;\n\n\n\n\n\n\n\nIn-text p. 133: Expected time lost\n\n\n\n\n\n\nImportant\n\n\n\nMissing for R - but should be possible with mstate or survival?\n\n\n\nR-NASAS\n\n\n\n\n\n\n\nCode show/hide\n/* Bootstrap */\ndata bootbmt;\n    do sampnum = 1 to 1000; /* nboot=1000*/\n    do i = 1 to 2009; /*nobs=2009*/\n    x=round(ranuni(0)*2009); /*nobs=2009*/\n    set bmt\n    point=x;\n    output;\n    end;\n    end;\n    stop;\nrun;\n\n%macro areastepby(data,byvar,beh,grp,tid,y,tau);\n    data select;\n        set &data;\n        where &beh=&grp;\n    run;\n    data select;\n        set select;\n        by &byvar;\n        retain mu oldt oldy;\n        if first.&byvar then do oldt=0; oldy=1; mu=0;  end;\n        if &tid>&tau then do;\n        &tid=&tau; &y=oldy; end;\n        if not first.&byvar then mu+oldy*(&tid-oldt);\n        if last.&byvar then do;\n        if &tid<&tau then mu+(&tau-&tid)*&y; end;\n        oldy=&y; oldt=&tid;\n    run;\n    data last;\n        set select;\n        by  &byvar;\n        if last.&byvar;\n    run;\n%mend areastepby;\n\nproc phreg data=bootbmt noprint; /* Relapse-free surv */\nby sampnum;\nmodel intxrel*state0(0)=;\nbaseline out=surv survival=km;\nrun;\n\nproc phreg data=bootbmt noprint; /* Relapse */\nby sampnum;\nmodel intxrel*state0(0)=/eventcode=1;\nbaseline out=cif1 cif=cif1;\nrun;\n\nproc phreg data=bootbmt noprint; /* Death in remission */\nby sampnum;\nmodel intxrel*state0(0)=/eventcode=2;\nbaseline out=cif2 cif=cif2;\nrun;\n\nproc phreg data=bootbmt noprint; /* Overall surv. */\nby sampnum;\nmodel intxsurv*dead(0)=/eventcode=1;\nbaseline out=dead cif=cif23;\nrun;\n\ndata dead; set dead; time=intxsurv; drop intxsurv;  run;  \ndata surv; set surv; time=intxrel; drop intxrel; run;\ndata cif1; set cif1; time=intxrel; drop intxrel; run;\ndata cif2; set cif2; time=intxrel; drop intxrel; run;\ndata all; merge surv cif1 cif2 dead ; by sampnum time; run;\n\ndata allrev; set all;\nby sampnum time; \nretain last1 last2 last3 last4;\nif km=. then rfs=last1; if km ne . then rfs=km; \nif cif1=. then c1=last2; if cif1 ne . then c1=cif1;\nif cif2=. then c2=last3; if cif2 ne . then c2=cif2;\nif cif23=. then c23=last4; if cif23 ne . then c23=cif23;\noutput;\nlast1=rfs; last2=c1; last3=c2; last4=c23;\nrun;\n\ndata allrev; set allrev;\nq0=rfs; q2=c2; q3=c23-c2; q1=c1-q3; sum=q0+q1+q2+q3; prev=q1/(q0+q1); tment=0;\nrun;\n\n%areastepby(allrev,sampnum,tment,0,time,q0,120);\nproc means data=last mean stddev;\nvar mu;\nrun;\n\n/* macro need to be changed for cuminc (start in 0) */\n\n%macro areastepby0(data,byvar,beh,grp,tid,y,tau);\n    data select;\n        set &data;\n        where &beh=&grp;\n    run;\n    data select;\n        set select;\n        by &byvar;\n        retain mu oldt oldy;\n        if first.&byvar then do oldt=0; oldy=0; mu=0;  end;\n        if &tid>&tau then do;\n        &tid=&tau; &y=oldy; end;\n        if not first.&byvar then mu+oldy*(&tid-oldt);\n        if last.&byvar then do;\n        if &tid<&tau then mu+(&tau-&tid)*&y; end;\n        oldy=&y; oldt=&tid;\n    run;\n    data last;\n        set select;\n        by  &byvar;\n        if last.&byvar;\n    run;\n%mend areastepby;\n\n%areastepby0(allrev,sampnum,tment,0,time,q1,120);\nproc means data=last mean stddev;\nvar mu;\nrun;\n%areastepby0(allrev,sampnum,tment,0,time,c23,120);\nproc means data=last mean stddev;\nvar mu;\nrun;\n%areastepby0(allrev,sampnum,tment,0,time,q2,120);\nproc means data=last mean stddev;\nvar mu;\nrun;\n%areastepby0(allrev,sampnum,tment,0,time,q3,120);\nproc means data=last mean stddev;\nvar mu;\nrun;\n\n\n\n\n\n\n\nTable 4.8\n\nRSAS\n\n\n\n\nCode show/hide\nbmt$age10<-bmt$age/10\nsummary(coxph(Surv(intxrel, rel == 1) ~ bmonly + all + age, data = bmt, \n      ties = \"breslow\"))\n\n\nCall:\ncoxph(formula = Surv(intxrel, rel == 1) ~ bmonly + all + age, \n    data = bmt, ties = \"breslow\")\n\n  n= 2009, number of events= 259 \n\n            coef exp(coef)  se(coef)      z Pr(>|z|)    \nbmonly -0.107627  0.897962  0.134487 -0.800    0.424    \nall     0.548871  1.731297  0.129307  4.245 2.19e-05 ***\nage    -0.004487  0.995523  0.004440 -1.011    0.312    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n       exp(coef) exp(-coef) lower .95 upper .95\nbmonly    0.8980     1.1136    0.6899     1.169\nall       1.7313     0.5776    1.3437     2.231\nage       0.9955     1.0045    0.9869     1.004\n\nConcordance= 0.576  (se = 0.018 )\nLikelihood ratio test= 20.61  on 3 df,   p=1e-04\nWald test            = 21.57  on 3 df,   p=8e-05\nScore (logrank) test = 22.12  on 3 df,   p=6e-05\n\n\nCode show/hide\nsummary(coxph(Surv(intxrel, rel == 1) ~ bmonly + all + age + cluster(team), \n      data = bmt, \n      ties = \"breslow\"))\n\n\nCall:\ncoxph(formula = Surv(intxrel, rel == 1) ~ bmonly + all + age, \n    data = bmt, ties = \"breslow\", cluster = team)\n\n  n= 2009, number of events= 259 \n\n            coef exp(coef)  se(coef) robust se      z Pr(>|z|)   \nbmonly -0.107627  0.897962  0.134487  0.137880 -0.781   0.4350   \nall     0.548871  1.731297  0.129307  0.173916  3.156   0.0016 **\nage    -0.004487  0.995523  0.004440  0.007486 -0.599   0.5489   \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n       exp(coef) exp(-coef) lower .95 upper .95\nbmonly    0.8980     1.1136    0.6853     1.177\nall       1.7313     0.5776    1.2312     2.434\nage       0.9955     1.0045    0.9810     1.010\n\nConcordance= 0.576  (se = 0.022 )\nLikelihood ratio test= 20.61  on 3 df,   p=1e-04\nWald test            = 16.34  on 3 df,   p=0.001\nScore (logrank) test = 22.12  on 3 df,   p=6e-05,   Robust = 13.19  p=0.004\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\nCode show/hide\n# Relapse-free survival\nsummary(coxph(Surv(intxrel, state0 != 0) ~ bmonly + all + age, data = bmt, \n      ties = \"breslow\"))\n\n\nCall:\ncoxph(formula = Surv(intxrel, state0 != 0) ~ bmonly + all + age, \n    data = bmt, ties = \"breslow\")\n\n  n= 2009, number of events= 764 \n\n            coef exp(coef)  se(coef)      z Pr(>|z|)    \nbmonly -0.161079  0.851225  0.077445 -2.080   0.0375 *  \nall     0.454636  1.575599  0.077733  5.849 4.95e-09 ***\nage     0.016917  1.017061  0.002588  6.537 6.28e-11 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n       exp(coef) exp(-coef) lower .95 upper .95\nbmonly    0.8512     1.1748    0.7313    0.9908\nall       1.5756     0.6347    1.3529    1.8349\nage       1.0171     0.9832    1.0119    1.0222\n\nConcordance= 0.588  (se = 0.011 )\nLikelihood ratio test= 81.95  on 3 df,   p=<2e-16\nWald test            = 81.52  on 3 df,   p=<2e-16\nScore (logrank) test = 82.07  on 3 df,   p=<2e-16\n\n\nCode show/hide\nsummary(coxph(Surv(intxrel, state0 != 0) ~ bmonly + all + age + cluster(team), \n      data = bmt, \n      ties = \"breslow\"))\n\n\nCall:\ncoxph(formula = Surv(intxrel, state0 != 0) ~ bmonly + all + age, \n    data = bmt, ties = \"breslow\", cluster = team)\n\n  n= 2009, number of events= 764 \n\n            coef exp(coef)  se(coef) robust se      z Pr(>|z|)    \nbmonly -0.161079  0.851225  0.077445  0.077240 -2.085    0.037 *  \nall     0.454636  1.575599  0.077733  0.078077  5.823 5.78e-09 ***\nage     0.016917  1.017061  0.002588  0.003328  5.083 3.71e-07 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n       exp(coef) exp(-coef) lower .95 upper .95\nbmonly    0.8512     1.1748    0.7316    0.9904\nall       1.5756     0.6347    1.3520    1.8361\nage       1.0171     0.9832    1.0104    1.0237\n\nConcordance= 0.588  (se = 0.013 )\nLikelihood ratio test= 81.95  on 3 df,   p=<2e-16\nWald test            = 52.58  on 3 df,   p=2e-11\nScore (logrank) test = 82.07  on 3 df,   p=<2e-16,   Robust = 47.68  p=2e-10\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\nCode show/hide\n# overall survival\nsummary(coxph(Surv(intxsurv, dead != 0) ~ bmonly + all + age, data = bmt, \n      ties = \"breslow\"))\n\n\nCall:\ncoxph(formula = Surv(intxsurv, dead != 0) ~ bmonly + all + age, \n    data = bmt, ties = \"breslow\")\n\n  n= 2009, number of events= 737 \n\n            coef exp(coef)  se(coef)      z Pr(>|z|)    \nbmonly -0.160104  0.852055  0.079035 -2.026   0.0428 *  \nall     0.405480  1.500022  0.079556  5.097 3.45e-07 ***\nage     0.017286  1.017437  0.002636  6.558 5.45e-11 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n       exp(coef) exp(-coef) lower .95 upper .95\nbmonly    0.8521     1.1736    0.7298    0.9948\nall       1.5000     0.6667    1.2835    1.7531\nage       1.0174     0.9829    1.0122    1.0227\n\nConcordance= 0.59  (se = 0.011 )\nLikelihood ratio test= 76.65  on 3 df,   p=<2e-16\nWald test            = 76.05  on 3 df,   p=<2e-16\nScore (logrank) test = 76.57  on 3 df,   p=<2e-16\n\n\nCode show/hide\nsummary(coxph(Surv(intxsurv, dead != 0) ~ bmonly + all + age + cluster(team), \n      data = bmt, \n      ties = \"breslow\"))\n\n\nCall:\ncoxph(formula = Surv(intxsurv, dead != 0) ~ bmonly + all + age, \n    data = bmt, ties = \"breslow\", cluster = team)\n\n  n= 2009, number of events= 737 \n\n            coef exp(coef)  se(coef) robust se      z Pr(>|z|)    \nbmonly -0.160104  0.852055  0.079035  0.080788 -1.982   0.0475 *  \nall     0.405480  1.500022  0.079556  0.077594  5.226 1.74e-07 ***\nage     0.017286  1.017437  0.002636  0.003339  5.177 2.26e-07 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n       exp(coef) exp(-coef) lower .95 upper .95\nbmonly    0.8521     1.1736    0.7273    0.9982\nall       1.5000     0.6667    1.2884    1.7464\nage       1.0174     0.9829    1.0108    1.0241\n\nConcordance= 0.59  (se = 0.013 )\nLikelihood ratio test= 76.65  on 3 df,   p=<2e-16\nWald test            = 48.78  on 3 df,   p=1e-10\nScore (logrank) test = 76.57  on 3 df,   p=<2e-16,   Robust = 45.26  p=8e-10\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\n\n\n\n\nCode show/hide\n/* Relapse, relapse-free and overall survival\n   without and with adjustment for center */\nproc phreg data=bmt;\n    class bmonly(ref=\"0\") all(ref=\"0\");\n    model intxrel*rel(0)=bmonly all age;\nrun;\nproc phreg data=bmt covs(aggregate);\n    class bmonly(ref=\"0\") all(ref=\"0\") team;\n    model intxrel*rel(0)=bmonly all age;\n    id team;\nrun;\nproc phreg data=bmt;\n    class bmonly(ref=\"0\") all(ref=\"0\");\n    model intxrel*state0(0)=bmonly all age;\nrun;\nproc phreg data=bmt covs(aggregate);\n    class bmonly(ref=\"0\") all(ref=\"0\");\n    model intxrel*state0(0)=bmonly all age;\n    id team;\nrun;\nproc phreg data=bmt;\n    class bmonly(ref=\"0\") all(ref=\"0\");\n    model intxsurv*dead(0)=bmonly all age;\nrun;\nproc phreg data=bmt covs(aggregate);\n    class bmonly(ref=\"0\") all(ref=\"0\");\n    model intxsurv*dead(0)=bmonly all age;\n    id team;\nrun;\n\n\n\n\n\n\n\nTable 4.11\n\n\n\n\n\n\nImportant\n\n\n\nStill missing to make double data set for R - do we not have this somewhere else?\n\n\n\nRSAS\n\n\n\n\nCode show/hide\n# Relapse-free survival \ncoxph(Surv(intxrel, state0 > 0) ~ bmonly + all + age10, data=bmt, ties=\"breslow\")\n\n\nCall:\ncoxph(formula = Surv(intxrel, state0 > 0) ~ bmonly + all + age10, \n    data = bmt, ties = \"breslow\")\n\n           coef exp(coef) se(coef)      z        p\nbmonly -0.16108   0.85122  0.07745 -2.080   0.0375\nall     0.45464   1.57560  0.07773  5.849 4.95e-09\nage10   0.16917   1.18432  0.02588  6.537 6.28e-11\n\nLikelihood ratio test=81.95  on 3 df, p=< 2.2e-16\nn= 2009, number of events= 764 \n\n\nCode show/hide\n# Overall survival\ncoxph(Surv(intxsurv, dead != 0) ~ bmonly + all + age10, data=bmt, ties=\"breslow\")\n\n\nCall:\ncoxph(formula = Surv(intxsurv, dead != 0) ~ bmonly + all + age10, \n    data = bmt, ties = \"breslow\")\n\n           coef exp(coef) se(coef)      z        p\nbmonly -0.16010   0.85206  0.07904 -2.026   0.0428\nall     0.40548   1.50002  0.07956  5.097 3.45e-07\nage10   0.17286   1.18871  0.02636  6.558 5.45e-11\n\nLikelihood ratio test=76.65  on 3 df, p=< 2.2e-16\nn= 2009, number of events= 737 \n\n\nCode show/hide\nbmt1 <- bmt\nbmt1$gvhdny <- bmt$gvhd\nbmt1$nytgvhd <- ifelse(bmt1$gvhdny == 1, bmt1$tgvhd, bmt1$intxsurv)\nbmt1$gvhdny <- ifelse(bmt1$dead == 1, 1, bmt1$gvhdny)\n\n# gvhd free survival\ncoxph(Surv(nytgvhd, gvhdny != 0) ~ bmonly + all + age10, data=bmt1, ties=\"breslow\")\n\n\nCall:\ncoxph(formula = Surv(nytgvhd, gvhdny != 0) ~ bmonly + all + age10, \n    data = bmt1, ties = \"breslow\")\n\n           coef exp(coef) se(coef)      z        p\nbmonly -0.26024   0.77086  0.05930 -4.388 1.14e-05\nall     0.29235   1.33958  0.06005  4.869 1.12e-06\nage10   0.11699   1.12410  0.01936  6.043 1.51e-09\n\nLikelihood ratio test=97.36  on 3 df, p=< 2.2e-16\nn= 2009, number of events= 1324 \n\n\n\n\n\n\nCode show/hide\ndata double02; set bmt; \n    /* joint analysis of relapse-free and overall survival */\n    version=1; dc=state0>0; time=intxrel; gsource0=bmonly; gsource2=0;\n    disease0=all; disease2=0; age0=age; age2=0; output;\n    version=2; dc=dead; time=intxsurv; gsource2=bmonly; gsource0=0;\n    disease2=all; disease0=0; age2=age; age0=0; output;\nrun;\nproc phreg data=double02 covs(aggregate);\n    /* NB bmonly and all are now binary quantitative */\n    model time*dc(0)=gsource0 gsource2 disease0 disease2 age0 age2 / corrb;\n    strata version;\n    id id;\n    gs:  test gsource0=gsource2;\n    dis: test disease0=disease2;\n    a:   test age0=age2;\nrun;\nproc phreg data=double02 covs(aggregate);\n    model time*dc(0)=bmonly disease0 disease2 age;\n    strata version;\n    id id;\n    dis: test disease0=disease2;\nrun;\ndata bmt; set bmt;\n    gvhdny=gvhd; \n    if gvhdny=1 then nytgvhd=tgvhd;\n    if gvhdny=0 then do; nytgvhd=intxsurv; if dead=1 then gvhdny=1; end; \n    /* NB her tæller både GvHD og død uden GvHD med */\nrun;\ndata triple02G; set bmt; \n    /* joint analysis of relapse-free, GvHD-free and overall survival */\n    version=1; dc=state0>0; time=intxrel; gsource0=bmonly; \n    gsource2=0; gsourceG=0;\n    disease0=all; disease2=0; diseaseG=0; age0=age; age2=0; ageG=0; output;\n    version=2; dc=dead; time=intxsurv; gsource2=bmonly; \n    gsource0=0; gsourceG=0;\n    disease2=all; disease0=0; diseaseG=0; age2=age; age0=0; ageG=0; output;\n    version=3; dc=gvhdny; time=nytgvhd; gsourceG=bmonly; gsource0=0; gsource2=0;\n    diseaseG=all; disease0=0; disease2=0; ageG=age; age0=0; age2=0; output;\nrun;\nproc phreg data=triple02G covs(aggregate) covout outest=params3;\n    /* bmonly and all binary quatitative*/\n    model time*dc(0)=gsource0 gsource2 gsourceG disease0 disease2 diseaseG\n    age0 age2 ageG;\n    strata version;\n    id id;\nrun;"
  },
  {
    "objectID": "Ch5.html#pbc3-trial-in-liver-cirrhosis",
    "href": "Ch5.html#pbc3-trial-in-liver-cirrhosis",
    "title": "5  Marginal models",
    "section": "PBC3 trial in liver cirrhosis",
    "text": "PBC3 trial in liver cirrhosis\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\npbc3 <- data.frame(read.csv(\"data/pbc3.csv\"))\npbc3$log2bili <- with(pbc3, log2(bili))\n\n\n\n\n\n\nCode show/hide\nproc import out=pbc3\n    datafile=\"data/pbc3.csv\"\n    dbms=csv replace;\nrun;\n    \ndata pbc3; \n    set pbc3;\n    log2bili=log2(bili);\nrun;\n\n\n\n\n\n\n\nTable 5.6\n\nRSAS\n\n\n\n\nCode show/hide\nlibrary(mets)\npbcny <- subset(pbc3, !is.na(alb))\n# COLUMN 1: t0 = 2\ndirbin2tment <- binreg(Event(days, status) ~ tment,\n                       data = pbc3, cause = 2, time = 2 * 365.25, cens.code = 0)\nsummary(dirbin2tment)\n\n\n\n   n events\n 349     33\n\n 349 clusters\ncoeffients:\n             Estimate   Std.Err      2.5%     97.5% P-value\n(Intercept) -2.209708  0.264482 -2.728083 -1.691333   0.000\ntment        0.093432  0.370632 -0.632994  0.819858   0.801\n\nexp(coeffients):\n            Estimate     2.5%  97.5%\n(Intercept) 0.109733 0.065344 0.1843\ntment       1.097936 0.530999 2.2702\n\n\nCode show/hide\ndirbin2 <- binreg(Event(days, status) ~ tment + I(alb - 40) + I(log2(bili) - 4.6), \n                  data = pbcny, cause = 2, time = 2 * 365.25, cens.code = 0)\nsummary(dirbin2)\n\n\n\n   n events\n 343     33\n\n 343 clusters\ncoeffients:\n                     Estimate   Std.Err      2.5%     97.5% P-value\n(Intercept)         -2.931782  0.353853 -3.625322 -2.238242  0.0000\ntment               -0.462652  0.438797 -1.322677  0.397374  0.2917\nI(alb - 40)         -0.147338  0.036961 -0.219780 -0.074897  0.0001\nI(log2(bili) - 4.6)  0.639318  0.151149  0.343071  0.935564  0.0000\n\nexp(coeffients):\n                    Estimate     2.5%  97.5%\n(Intercept)         0.053302 0.026641 0.1066\ntment               0.629612 0.266421 1.4879\nI(alb - 40)         0.863002 0.802695 0.9278\nI(log2(bili) - 4.6) 1.895187 1.409269 2.5487\n\n\nCode show/hide\nlibrary(timereg)\n# COLUMN 2: t1,t2,t3 = 1,2,3\ntimereg3 <- comp.risk(\n  Event(days, status) ~ const(tment),\n  data = pbc3, cause = 2, times = c(1,2,3) * 365.25,\n  model = \"logistic\", resample.iid = 1, n.sim = 100, monotone = 1)\n\nsummary(timereg3)$coef\n\n\nCompeting risks Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          8.96                   0\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.505                           0\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                          94.3                           0\n\nParametric terms : \n               Coef.    SE Robust SE       z P-val lower2.5% upper97.5%\nconst(tment) -0.0304 0.323     0.323 -0.0941 0.925    -0.663      0.603\n   \n\n\nNULL\n\n\nCode show/hide\ntimereg3 <- comp.risk(\n  Event(days, status) ~ const(tment) + const(I(alb - 40)) +  const(I(log2(bili) - 4.6)),\n  data = pbcny, cause = 2, times = c(1,2,3) * 365.25,\n  model = \"logistic\", resample.iid = 1, n.sim = 100, monotone = 1)\n\nsummary(timereg3)$coef\n\n\nCompeting risks Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          9.49                   0\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.651                           0\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                           156                           0\n\nParametric terms : \n                            Coef.     SE Robust SE     z    P-val lower2.5%\nconst(tment)               -0.520 0.3730    0.3730 -1.39 1.63e-01    -1.250\nconst(I(alb - 40))         -0.125 0.0349    0.0349 -3.58 3.45e-04    -0.193\nconst(I(log2(bili) - 4.6))  0.579 0.1280    0.1280  4.54 5.74e-06     0.328\n                           upper97.5%\nconst(tment)                   0.2110\nconst(I(alb - 40))            -0.0566\nconst(I(log2(bili) - 4.6))     0.8300\n   \n\n\nNULL\n\n\n\n\nNot available\n\n\n\n\n\nFigure 5.12\n\n\nCode show/hide\n        library(timereg)\nlibrary(ggplot2) \ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\n# Make Cox model fit\npbc3$followup <- pbc3$days / 365.25\nfit <- cox.aalen(Surv(followup, status != 0) ~ prop(tment) + prop(alb) + prop(bili),\n                 data = pbc3, n.sim = 0,\n                 residuals = 1)\n\n# Cumulative martingale residuals\nset.seed(061166)\ncum_res <- cum.residuals(fit, pbc3, cum.resid=1, max.point.func = 50, n.sim = 1000)\n\ncumresdata_alb <- data.frame(\n  alb = unname(cum_res$proc.cumz[[1]][,1]),\n  cum_mg_res = unname(cum_res$proc.cumz[[1]][,2])\n  )\n\ncumresdata_albsim <- data.frame(\n  alb = rep(unname(cum_res$proc.cumz[[1]][,1]),times = 50),\n  cum_mg_res = c(cum_res$sim.test.proccumz[[1]]),\n  sim = rep(1:50,each = length(unname(cum_res$proc.cumz[[1]][,1])))\n  )\n\nfig5.12 <- ggplot(aes(x = alb, y = cum_mg_res), data = cumresdata_alb) +\n  geom_step(aes(x = alb, y = cum_mg_res, group = sim), \n            color = \"grey\", size = 0.8, data = cumresdata_albsim) +\n  geom_step(size = 1) +\n  xlab(\"Albumin\") +\n  ylab(\"Cumulative martingale residuals\") +\n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig5.12\n\n\n\n\n\nCode show/hide\n# p-value\ncum_res$pval.test[1]\n\n\nprop(alb) \n    0.459 \n\n\n\n\nFigure 5.13\n\n\nCode show/hide\n# Figure bili\ncumresdata_bili <- data.frame(\n  bili = unname(cum_res$proc.cumz[[2]][,1]),\n  cum_mg_res = unname(cum_res$proc.cumz[[2]][,2])\n  )\n\ncumresdata_bilisim <- data.frame(\n  bili= rep(unname(cum_res$proc.cumz[[2]][,1]), times = 50),\n  cum_mg_res = c(cum_res$sim.test.proccumz[[2]]),\n  sim = rep(1:50,each = length(unname(cum_res$proc.cumz[[2]][,1])))\n  )\n\nfig5.13 <- ggplot(aes(x = bili, y = cum_mg_res), data = cumresdata_bili) +\n  geom_step(aes(x = bili, y = cum_mg_res, group = sim),\n            color = \"grey\", size = 0.8, data = cumresdata_bilisim) +\n  geom_step(size = 1) +\n  xlab(\"Bilirubin\") +\n  ylab(\"Cumulative martingale residuals\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig5.13\n\n\n\n\n\nCode show/hide\n# p-value\ncum_res$pval.test[2]\n\n\nprop(bili) \n         0 \n\n\n\n\nFigure 5.14\n\n\nCode show/hide\n# Make Cox model fit with log2bili\nfit2 <- cox.aalen(\n  Surv(followup, status != 0) ~ prop(tment) + prop(alb) + prop(log2bili),\n  data = pbc3, n.sim = 0, residuals = 1)\n\n# Cumulative martingale residuals\nset.seed(061166)\ncum_res <- cum.residuals(fit2, pbc3, cum.resid=1, max.point.func = 50, n.sim = 1000)\ncumresdata_log2bili <- data.frame(\n  log2bili = unname(cum_res$proc.cumz[[2]][,1]),\n  cum_mg_res = unname(cum_res$proc.cumz[[2]][,2])\n  )\n\ncumresdata_log2bilisim <- data.frame(\n  log2bili = rep(unname(cum_res$proc.cumz[[2]][,1]),times = 50),\n  cum_mg_res = c(cum_res$sim.test.proccumz[[2]]),\n  sim = rep(1:50, each = length(unname(cum_res$proc.cumz[[2]][,1])))\n  )\n\nfig5.14 <- ggplot(aes(x = log2bili, y = cum_mg_res), \n                  data = cumresdata_log2bili) +\n  geom_step(aes(x = log2bili, y = cum_mg_res, group = sim), \n            color = \"grey\", size = 0.8, data = cumresdata_log2bilisim) +\n  geom_step(size = 1) +\n  xlab(expression(\"log\" [2] * \"(bilirubin)\"))+\n  ylab(\"Cumulative martingale residuals\") +\n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig5.14\n\n\n\n\n\nCode show/hide\ncum_res$pval.test[2]\n\n\nprop(log2bili) \n         0.481 \n\n\n\n\nFigure 5.15\n\n\nCode show/hide\n# Compute Schoenfeld residuals (standardized)\nset.seed(130966)\nfit3 <- cox.aalen(\n  Surv(followup, status != 0) ~ prop(tment) + prop(alb) + prop(log2bili),\n  data = pbc3, n.sim = 1000, residuals = 1, weighted.test = 1)\nsummary(fit3)\n\n\nCox-Aalen Model \n\nTest for Aalen terms \nTest not computed, sim=0 \n\nProportional Cox terms :  \n                 Coef.     SE Robust SE D2log(L)^-1     z    P-val lower2.5%\nprop(tment)    -0.5750 0.2250    0.2240      0.2240 -2.57 1.02e-02    -1.020\nprop(alb)      -0.0909 0.0208    0.0211      0.0216 -4.31 1.62e-05    -0.132\nprop(log2bili)  0.6650 0.0728    0.0696      0.0744  9.56 0.00e+00     0.522\n               upper97.5%\nprop(tment)       -0.1340\nprop(alb)         -0.0501\nprop(log2bili)     0.8080\nTest of Proportionality \n               sup|  hat U(t) | p-value H_0 \nprop(tment)                1.33        0.919\nprop(alb)                  2.04        0.418\nprop(log2bili)             1.89        0.568\n\n\nCode show/hide\npar(mfrow = c(1,1))\nplot(fit3, score = T)\n\n\n\n\n\n\n\n\n\n\n\nCode show/hide\ntime <- fit3$residuals$time\nsim <- fit3$sim.test.procProp\nobs <- fit3$test.procProp\n\ndata_tment_obs <- data.frame(time = time,res = obs[,2])\n\ndata_tment_sim <- data.frame(res = do.call(\"rbind\", sim)[,1],\n                             time = rep(time, times = 50), \n                             sim = rep(1:50, each = length(time)))\n\nfig5.15 <- ggplot(aes(x = time, y = res), data = data_tment_obs) +\n  geom_step(aes(x = time, y = res, group = sim), \n            color = \"grey\", size = 0.8, data = data_tment_sim) +\n  geom_step(size = 1) +\n  xlab(expression(\"Time since randomization (years)\"))+\n  ylab(\"Standardized score process\") +\n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig5.15\n\n\n\n\n\nCode show/hide\nfit3$pval.Prop[1]\n\n\nprop(tment) \n      0.919 \n\n\n\n\nFigure 5.16\n\n\nCode show/hide\n# Same but for albumin\ndata_alb_obs <- data.frame(time = time, \n                           res = obs[,3])\n\ndata_alb_sim <- data.frame(res = do.call(\"rbind\", sim)[,2],\n                           time = rep(time, times = 50), \n                           sim = rep(1:50, each = length(time)))\n\nfig5.16 <- ggplot(aes(x = time, y = res), data = data_alb_obs) +\n  geom_step(aes(x = time, y = res, group = sim), \n            color = \"grey\", size = 0.8, data = data_alb_sim) +\n  geom_step(size = 1) +\n  xlab(expression(\"Time since randomization (years)\"))+\n  ylab(\"Standardized score process\") +\n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig5.16\n\n\n\n\n\nCode show/hide\nfit3$pval.Prop[2]\n\n\nprop(alb) \n    0.418 \n\n\n\n\nFigure 5.17\n\n\nCode show/hide\n# Same but for log2bili\ndata_log2bili_obs <- data.frame(time = time, \n                                res = obs[,4])\n\ndata_log2bili_sim <- data.frame(res = do.call(\"rbind\", sim)[,3],\n                                time = rep(time, times = 50), \n                                sim = rep(1:50, each = length(time)))\n\nfig5.17 <- ggplot(aes(x = time, y = res), data = data_log2bili_obs) +\n  geom_step(aes(x = time, y = res, group = sim), \n            color = \"grey\", size = 0.8, data = data_log2bili_sim) +\n  geom_step(size = 1) +\n  xlab(expression(\"Time since randomization (years)\"))+\n  ylab(\"Standardized score process\") +\n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig5.17\n\n\n\n\n\nCode show/hide\nfit3$pval.Prop[3]\n\n\nprop(log2bili) \n         0.568"
  },
  {
    "objectID": "Ch5.html#prova-trial-in-liver-cirrhosis",
    "href": "Ch5.html#prova-trial-in-liver-cirrhosis",
    "title": "5  Marginal models",
    "section": "PROVA trial in liver cirrhosis",
    "text": "PROVA trial in liver cirrhosis\nTODO: take some runtime"
  },
  {
    "objectID": "Ch5.html#bone-marrow-transplantation-in-acute-leukemia",
    "href": "Ch5.html#bone-marrow-transplantation-in-acute-leukemia",
    "title": "5  Marginal models",
    "section": "Bone marrow transplantation in acute leukemia",
    "text": "Bone marrow transplantation in acute leukemia\n\nRead data\n\n\nCode show/hide\nbmt <- data.frame(read.csv(\"data/bmt.csv\"))\nbmt$intxsurv<- bmt$timedeath\nbmt$dead <- bmt$death\nbmt$intxrel <- ifelse(bmt$rel == 1, bmt$timerel, bmt$timedeath)\nbmt$trm     <- ifelse(bmt$rel == 0 & bmt$death == 1, 1, 0)\nbmt$tgvhd   <- ifelse(bmt$gvhd == 1, bmt$timegvhd, bmt$intxrel)\nbmt$tanc500 <- ifelse(bmt$anc500 == 1, bmt$timeanc500, bmt$intxrel)\nbmt$state0  <- bmt$rel + 2*bmt$trm\nbmt$dytxanc5 <- bmt$timeanc500 * 30\n\n\n\n\nTable 5.1\n\n\nCode show/hide\n# Make landmark data at 0.5, 1, 1.5, 2, 2.5\nrequire(dplyr)\ndat05 <- bmt\ndat05 <- subset(bmt, intxrel >= 0.5) %>%\n  mutate(time = pmin(intxrel, 6.5),\n         status = ifelse(time < 6.5, state0, 0),\n         landmark = 0.5,\n         entry = 0.5,\n         anc = ifelse(anc500 == 1 & timeanc500 <= 0.5, 1, 0),\n         gvh = ifelse(gvhd == 1 & tgvhd <= 0.5, 1, 0))\n# dat05\n\ndat10 <- bmt\ndat10 <- subset(bmt, intxrel >= 1.0) %>%\n  mutate(time = pmin(intxrel, 7),\n         status = ifelse(time < 7, state0, 0),\n         landmark = 1.0,\n         entry = 1.0,\n         anc = ifelse(anc500 == 1 & timeanc500 <= 1, 1, 0),\n         gvh = ifelse(gvhd == 1 & tgvhd <= 1, 1, 0))\n\ndat15 <- bmt\ndat15 <- subset(bmt, intxrel >= 1.5) %>%\n  mutate(time = pmin(intxrel, 7.5),\n         status = ifelse(time < 7.5, state0, 0),\n         landmark = 1.5,\n         entry = 1.5,\n         anc = ifelse(anc500 == 1 & timeanc500 <= 1.5, 1, 0),\n         gvh = ifelse(gvhd == 1 & tgvhd <= 1.5, 1, 0))\n\ndat20 <- bmt\ndat20 <- subset(bmt, intxrel >= 2.0) %>%\n  mutate(time = pmin(intxrel, 8),\n         status = ifelse(time < 8, state0, 0),\n         landmark = 2,\n         entry = 2,\n         anc = ifelse(anc500 == 1 & timeanc500 <= 2, 1, 0),\n         gvh = ifelse(gvhd == 1 & tgvhd <= 2, 1, 0))\n\ndat25 <- bmt\ndat25 <- subset(bmt, intxrel >= 2.5) %>%\n  mutate(time = pmin(intxrel, 8.5),\n         status = ifelse(time < 8.5, state0, 0),\n         landmark = 2.5,\n         entry = 2.5,\n         anc = ifelse(anc500 == 1 & timeanc500 <= 2.5, 1, 0),\n         gvh = ifelse(gvhd == 1 & tgvhd <= 2.5, 1, 0))\n\n\nlandmark <- rbind(dat05, dat10, dat15, dat20, dat25)\n\n# Table 5.1 output\nrowSums(with(landmark, table(landmark, anc > 0 | gvh > 0))) # at risk\n\n\n 0.5    1  1.5    2  2.5 \n1988 1949 1905 1876 1829 \n\n\nCode show/hide\nwith(landmark, table(landmark, anc)) # anc\n\n\n        anc\nlandmark    0    1\n     0.5 1082  906\n     1     37 1912\n     1.5    6 1899\n     2      2 1874\n     2.5    1 1828\n\n\nCode show/hide\nwith(landmark, table(landmark, gvh)) # gvhd\n\n\n        gvh\nlandmark    0    1\n     0.5 1808  180\n     1   1558  391\n     1.5 1424  481\n     2   1377  499\n     2.5 1334  495\n\n\nCode show/hide\n# Drop observations with stoptime = starttime\nlandmark <- subset(landmark, time > entry)\n\n\n\n\nTable 5.2\n\n\nCode show/hide\n# Add time-varying covariates from previous object\nlandmarkw <- landmark %>%\n  mutate(anc05 = (landmark == 0.5) * anc,\n         gvh05 = (landmark == 0.5) * gvh,\n         anc10 = (landmark == 1.0) * anc,\n         gvh10 = (landmark == 1.0) * gvh,\n         anc15 = (landmark == 1.5) * anc,\n         gvh15 = (landmark == 1.5) * gvh,\n         anc20 = (landmark == 2.0) * anc,\n         gvh20 = (landmark == 2.0) * gvh,\n         anc25 = (landmark == 2.5) * anc,\n         gvh25 = (landmark == 2.5) * gvh\n         )\n\n# with(landmarkw, table(landmark, status))\n\n\nlibrary(survival)\ncox_land <- coxph(Surv(entry, time, status != 0) ~ cluster(id) + strata(landmark) +\n                    anc05 + anc10 + anc15 + anc20 + anc25 +\n                    gvh05 + gvh10 + gvh15 + gvh20 + gvh25 ,\n                  data = landmarkw, method = \"breslow\",  eps = 1e-9)\ncox_land\n\n\nCall:\ncoxph(formula = Surv(entry, time, status != 0) ~ strata(landmark) + \n    anc05 + anc10 + anc15 + anc20 + anc25 + gvh05 + gvh10 + gvh15 + \n    gvh20 + gvh25, data = landmarkw, method = \"breslow\", eps = 1e-09, \n    cluster = id)\n\n          coef exp(coef) se(coef) robust se       z        p\nanc05 -0.33460   0.71563  0.10680   0.10680  -3.133  0.00173\nanc10 -0.60851   0.54416  0.30635   0.31981  -1.903  0.05708\nanc15 -1.68452   0.18553  0.50439   0.61065  -2.759  0.00581\nanc20 -2.96384   0.05162  0.71909   0.40406  -7.335 2.21e-13\nanc25 -3.35202   0.03501  1.01558   0.17840 -18.789  < 2e-16\ngvh05  0.70277   2.01934  0.14751   0.14894   4.718 2.38e-06\ngvh10  0.67945   1.97280  0.11489   0.11523   5.897 3.71e-09\ngvh15  0.86339   2.37119  0.11246   0.11254   7.672 1.69e-14\ngvh20  0.80243   2.23095  0.11514   0.11511   6.971 3.15e-12\ngvh25  0.83065   2.29481  0.12151   0.12129   6.848 7.47e-12\n\nLikelihood ratio test=230.2  on 10 df, p=< 2.2e-16\nn= 9542, number of events= 1643 \n\n\n\n\nFigure 5.1\n\n\nCode show/hide\n# General theme\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\",\n        text = element_text(size = 26),\n        axis.text.x = element_text(size = 26),\n        axis.text.y = element_text(size = 26),\n        legend.text = element_text(size = 26))\n\n# Extract estimated survival probabilities\nsurv <- survfit(cox_land,\n                newdata = data.frame(anc05 = 0, anc10 = 0, anc15 = 0, anc20 = 0, anc25 = 0,\n                                     gvh05 = 0, gvh10 = 0, gvh15 = 0, gvh20 = 0, gvh25 = 0))\n\n# Order data for plotting\npdata <- data.frame(surv = surv$surv,\n                    time = surv$time,\n                    landmark = c(rep(\"0.5\", surv$strata[[1]]),\n                                 rep(\"1.0\", surv$strata[[2]]),\n                                 rep(\"1.5\", surv$strata[[3]]),\n                                 rep(\"2.0\", surv$strata[[4]]),\n                                 rep(\"2.5\", surv$strata[[5]]))\n)\n\n# Add prob 1 in beginning for all\npdata2 <- as.data.frame(pdata %>% group_by(landmark) %>%\n  group_modify(~ add_row(.x, surv = 1, time = 0, .before=0)))\n\n\n# Create Figure (a)\nfig5.1a <- ggplot(aes(x = time, y = surv, linetype = landmark), data = pdata2) +\n  geom_step(size = 1) +\n  scale_linetype_discrete(\"Landmark\") +\n  xlab(\"Time since bone marrow transplantation (months)\") +\n  ylab(\"Conditional survival probability\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 9),\n                     breaks = seq(0, 9, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general +\n  theme(legend.key.size = unit(1.5, 'cm')) +\n  guides(linetype = guide_legend(nrow = 1, byrow = TRUE))\n\nfig5.1a\n\n\n\n\n\nCode show/hide\n# For anc = gvh = 1\n# Add LP to data\npdata2$lp <- with(pdata2,\n                  ifelse(landmark == '0.5', coef(cox_land)[1] + coef(cox_land)[6],\n                    ifelse(landmark == '1.0', coef(cox_land)[2] + coef(cox_land)[7],\n                      ifelse(landmark == '1.5', coef(cox_land)[3] + coef(cox_land)[8],\n                        ifelse(landmark == '2.0', coef(cox_land)[4] + coef(cox_land)[9],\n                          ifelse(landmark == '2.5', coef(cox_land)[5] + coef(cox_land)[10],\n                    0))))))\n\npdata2_wc <- pdata2\npdata2_wc$survlp <- with(pdata2, surv ^ exp(lp))\n\n\n# Create Figure 5.1 (b)\nfig5.1b <- ggplot(aes(x = time, y = survlp, linetype = landmark), data = pdata2_wc) +\n  geom_step(size = 1) +\n  scale_linetype_discrete(\"Landmark\") +\n  xlab(\"Time since bone marrow transplantation (months)\") +\n  ylab(\"Conditional survival probability\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 9),\n                     breaks = seq(0, 9, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general +\n  theme(legend.key.size = unit(1.5, 'cm')) +\n  guides(linetype = guide_legend(nrow = 1, byrow = TRUE))\n\nfig5.1b\n\n\n\n\n\n\n\nTable 5.3\n\n\nCode show/hide\n## COLUMN 1 \n# Add extra variables\nlandmarkw2 <- landmark %>%\n  mutate(anctime  = anc * (landmark - 0.5)/2,\n         anctime2 = anc * ((landmark - 0.5)/2)^2,\n         gvhtime  = gvh * (landmark - 0.5)/2,\n         gvhtime2 = gvh * ((landmark - 0.5)/2)^2\n        )\n\n# Fit model\ncox_land2 <- coxph(Surv(entry, time, status != 0) ~ cluster(id) + strata(landmark) +\n                    anc + anctime + anctime2 +\n                    gvh + gvhtime + gvhtime2,\n                  data = landmarkw2,\n                  method = \"breslow\", timefix = FALSE, eps = 1e-9)\nsummary(cox_land2)\n\n\nCall:\ncoxph(formula = Surv(entry, time, status != 0) ~ strata(landmark) + \n    anc + anctime + anctime2 + gvh + gvhtime + gvhtime2, data = landmarkw2, \n    method = \"breslow\", timefix = FALSE, eps = 1e-09, cluster = id)\n\n  n= 9542, number of events= 1643 \n\n            coef exp(coef) se(coef) robust se      z Pr(>|z|)    \nanc      -0.3220    0.7247   0.1061    0.1057 -3.046  0.00232 ** \nanctime  -1.1908    0.3040   1.4081    1.6699 -0.713  0.47581    \nanctime2 -2.2570    0.1047   1.8161    1.7911 -1.260  0.20762    \ngvh       0.6626    1.9398   0.1352    0.1429  4.636 3.55e-06 ***\ngvhtime   0.3913    1.4790   0.5865    0.4304  0.909  0.36323    \ngvhtime2 -0.2264    0.7974   0.5398    0.3421 -0.662  0.50808    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n         exp(coef) exp(-coef) lower .95 upper .95\nanc         0.7247     1.3799  0.589072    0.8915\nanctime     0.3040     3.2896  0.011519    8.0225\nanctime2    0.1047     9.5548  0.003127    3.5025\ngvh         1.9398     0.5155  1.465873    2.5668\ngvhtime     1.4790     0.6762  0.636204    3.4380\ngvhtime2    0.7974     1.2541  0.407813    1.5591\n\nConcordance= 0.581  (se = 0.01 )\nLikelihood ratio test= 228.4  on 6 df,   p=<2e-16\nWald test            = 212.6  on 6 df,   p=<2e-16\nScore (logrank) test = 349.6  on 6 df,   p=<2e-16,   Robust = 56.74  p=2e-10\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\nCode show/hide\n## COLUMN 2\n\n\n# Add extra variables\nlandmarkw3 <- landmarkw2 %>%\n  mutate(strtime = (landmark - 0.5)/2,\n         strtime2 = strtime^2\n  )\n\n# Fit model\ncox_land3 <- coxph(Surv(entry, time, status != 0) ~ cluster(id) +\n                     anc + anctime + anctime2 +\n                     gvh + gvhtime + gvhtime2 +\n                     strtime + strtime2,\n                   data = landmarkw3,\n                   method = \"breslow\")\nsummary(cox_land3)\n\n\nCall:\ncoxph(formula = Surv(entry, time, status != 0) ~ anc + anctime + \n    anctime2 + gvh + gvhtime + gvhtime2 + strtime + strtime2, \n    data = landmarkw3, method = \"breslow\", cluster = id)\n\n  n= 9542, number of events= 1643 \n\n             coef exp(coef) se(coef) robust se      z Pr(>|z|)    \nanc      -0.29798   0.74232  0.09953   0.09402 -3.169  0.00153 ** \nanctime  -1.39312   0.24830  1.38042   1.62961 -0.855  0.39262    \nanctime2 -2.03744   0.13036  1.79663   1.76544 -1.154  0.24847    \ngvh       0.67374   1.96156  0.13323   0.14048  4.796 1.62e-06 ***\ngvhtime   0.33291   1.39502  0.57606   0.41695  0.798  0.42462    \ngvhtime2 -0.17548   0.83906  0.53237   0.33324 -0.527  0.59849    \nstrtime   1.41388   4.11189  1.35613   1.60559  0.881  0.37853    \nstrtime2  1.94032   6.96098  1.78860   1.75102  1.108  0.26781    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n         exp(coef) exp(-coef) lower .95 upper .95\nanc         0.7423     1.3471  0.617386    0.8925\nanctime     0.2483     4.0274  0.010182    6.0548\nanctime2    0.1304     7.6709  0.004096    4.1485\ngvh         1.9616     0.5098  1.489437    2.5833\ngvhtime     1.3950     0.7168  0.616125    3.1586\ngvhtime2    0.8391     1.1918  0.436650    1.6123\nstrtime     4.1119     0.2432  0.176752   95.6575\nstrtime2    6.9610     0.1437  0.225010  215.3469\n\nConcordance= 0.587  (se = 0.012 )\nLikelihood ratio test= 227.9  on 8 df,   p=<2e-16\nWald test            = 233.2  on 8 df,   p=<2e-16\nScore (logrank) test = 348.8  on 8 df,   p=<2e-16,   Robust = 56.74  p=2e-09\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n\n\n\n\nFigure 5.2\n\n\nCode show/hide\n# Extract estimated survival probabilities\nsurv <- survfit(cox_land2,\n                newdata = data.frame(anc = 0, anctime = 0, anctime2 = 0,\n                                     gvh = 0, gvhtime = 0, gvhtime2 = 0))\n\n# Order data for plotting\npdata <- data.frame(surv = surv$surv,\n                    time = surv$time,\n                    landmark = c(rep(\"0.5\", surv$strata[[1]]),\n                                 rep(\"1.0\", surv$strata[[2]]),\n                                 rep(\"1.5\", surv$strata[[3]]),\n                                 rep(\"2.0\", surv$strata[[4]]),\n                                 rep(\"2.5\", surv$strata[[5]]))\n)\n\n# Add prob 1 in beginning for all\npdata2 <- as.data.frame(pdata %>% group_by(landmark) %>%\n                          group_modify(~ add_row(.x, surv = 1, time = 0, .before=0)))\n\n\n# Create Figure (a)\nfig5.2a <- ggplot(aes(x = time, y = surv, linetype = landmark), data = pdata2) +\n  geom_step(size = 1) +\n  scale_linetype_discrete(\"Landmark\") +\n  xlab(\"Time since bone marrow transplantation (months)\") +\n  ylab(\"Conditional survival probability\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 9),\n                     breaks = seq(0, 9, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general +\n  theme(legend.key.size = unit(1.5, 'cm')) +\n  guides(linetype = guide_legend(nrow = 1, byrow = TRUE))\n\nfig5.2a\n\n\n\n\n\nCode show/hide\n# For anc = gvh = 1\n# Add LP to data\npdata2$landmarknum <- as.numeric(pdata2$landmark)\npdata2$lp <- with(pdata2,\n                  coef(cox_land2)[1] +\n                    coef(cox_land2)[2] * (landmarknum - 0.5) / 2 +\n                     coef(cox_land2)[3] * ((landmarknum - 0.5) / 2)^2 +\n                      coef(cox_land2)[4] +\n                       coef(cox_land2)[5] * (landmarknum - 0.5) / 2 +\n                        coef(cox_land2)[6] * ((landmarknum - 0.5) / 2)^2\n                        )\n\n\n\npdata2_wc <- pdata2\npdata2_wc$survlp <- with(pdata2, surv ^ exp(lp))\n\n\n# Create Figure (b)\nfig5.2b <- ggplot(aes(x = time, y = survlp, linetype = landmark), data = pdata2_wc) +\n  geom_step(size = 1) +\n  scale_linetype_discrete(\"Landmark\") +\n  xlab(\"Time since bone marrow transplantation (months)\") +\n  ylab(\"Conditional survival probability\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 9),\n                     breaks = seq(0, 9, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general +\n  theme(legend.key.size = unit(1.5, 'cm')) +\n  guides(linetype = guide_legend(nrow = 1, byrow = TRUE))\n\nfig5.2b\n\n\n\n\n\n\n\nFigure 5.3\n\n\nCode show/hide\n# Extract estimated survival probabilities\nsurv <- survfit(cox_land3,\n                newdata = data.frame(anc = 0, anctime = 0, anctime2 = 0,\n                                     gvh = 0, gvhtime = 0, gvhtime2 = 0 ,\n                                     strtime = 0, strtime2 = 0))\n\n# Order data for plotting\npdata <- data.frame(surv = surv$surv,\n                    time = surv$time)\n\nrequire(dplyr)\nbase305 <- pdata %>% filter(time < 6.5) %>% \n  mutate(landmark = 0.5,\n         km0 = surv, \n         lpt = 0,\n         lpz = coef(cox_land3)[1] + coef(cox_land3)[4],\n         km1 = km0^exp(lpz))\n\n\nbase310 <- pdata %>% filter(time > 1 & time < 7) %>%  \n  mutate(landmark = 1,\n         lpt = coef(cox_land3)[7] * 0.5 / 2 + coef(cox_land3)[8] * (0.5 / 2)^2,\n         km0 = (surv / 0.9784098)^exp(lpt), \n         lpz = coef(cox_land3)[1] + coef(cox_land3)[4] + \n           coef(cox_land3)[2] * 0.5 / 2 + \n           coef(cox_land3)[5] * 0.5 / 2 +\n           coef(cox_land3)[3] * (0.5 / 2)^2 + \n           coef(cox_land3)[6] * (0.5 / 2)^2 ,\n         km1 = km0^exp(lpz))\n\n\nbase315 <- pdata %>% filter(time > 1.5 & time < 7.5) %>%  \n  mutate(landmark = 1.5,\n         lpt = coef(cox_land3)[7] * 1 / 2 + coef(cox_land3)[8] * (1 / 2)^2,\n         km0 = (surv / 0.9554490)^exp(lpt), \n         lpz = coef(cox_land3)[1] + coef(cox_land3)[4] + \n           coef(cox_land3)[2] * 1 / 2 + \n           coef(cox_land3)[5] * 1 / 2 +\n           coef(cox_land3)[3] * (1 / 2)^2 + \n           coef(cox_land3)[6] * (1 / 2)^2 ,\n         km1 = km0^exp(lpz))\n\nbase320 <- pdata %>% filter(time > 2 & time < 8) %>%  \n  mutate(landmark = 2,\n         lpt = coef(cox_land3)[7] * 1.5 / 2 + coef(cox_land3)[8] * (1.5 / 2)^2,\n         km0 = (surv / 0.9395795)^exp(lpt), \n         lpz = coef(cox_land3)[1] + coef(cox_land3)[4] + \n           coef(cox_land3)[2] * 1.5 / 2 + \n           coef(cox_land3)[5] * 1.5 / 2 +\n           coef(cox_land3)[3] * (1.5 / 2)^2 + \n           coef(cox_land3)[6] * (1.5 / 2)^2 ,\n         km1 = km0^exp(lpz))\n\nbase325 <- pdata %>% filter(time > 2.5 & time < 8.5) %>%  \n  mutate(landmark = 2.5,\n         lpt = coef(cox_land3)[7] * 2 / 2 + coef(cox_land3)[8] * (2 / 2)^2,\n         km0 = (surv / 0.9126288)^exp(lpt), \n         lpz = coef(cox_land3)[1] + coef(cox_land3)[4] + \n           coef(cox_land3)[2] * 2 / 2 + \n           coef(cox_land3)[5] * 2 / 2 +\n           coef(cox_land3)[3] * (2 / 2)^2 + \n           coef(cox_land3)[6] * (2 / 2)^2 ,\n         km1 = km0^exp(lpz))\nbase3slut <- as.data.frame(rbind(base305, base310, base315, base320, base325))\n\n\n# Add prob 1 in beginning for all\npdata3 <- as.data.frame(base3slut %>% group_by(landmark) %>%\n                           group_modify(~ add_row(.x, km0 = 1, km1  = 1, time = 0, .before=0)))\n\n# Create Figure (a)\nfig5.3a <- ggplot(aes(x = time, y = km0, linetype = as.factor(landmark)), data = pdata3) +\n  geom_step(size = 1) +\n  scale_linetype_discrete(\"Landmark\",labels=c(\"0.5\",\"1.0\",\"1.5\", \"2.0\",\"2.5\")) +\n  xlab(\"Time since bone marrow transplantation (months)\") +\n  ylab(\"Conditional survival probability\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 9),\n                     breaks = seq(0, 9, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n  theme_general +\n  theme(legend.key.size = unit(1.5, 'cm')) + \n  guides(linetype = guide_legend(nrow = 1, byrow = TRUE))\n\nfig5.3a\n\n\n\n\n\nCode show/hide\n# Create Figure 5.3 (right)\nfig5.3b <- ggplot(aes(x = time, y = km1, linetype = as.factor(landmark)), data = pdata3) +\n  geom_step(size = 1) +\n  scale_linetype_discrete(\"Landmark\",labels=c(\"0.5\",\"1.0\",\"1.5\", \"2.0\",\"2.5\")) +\n  xlab(\"Time since bone marrow transplantation (months)\") +\n  ylab(\"Conditional survival probability\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 9),\n                     breaks = seq(0, 9, 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 1.0),\n                     breaks = seq(0, 1.0, 0.1)) +\n   theme_general +\n   theme(legend.key.size = unit(1.5, 'cm'))  +\n  guides(linetype = guide_legend(nrow = 1, byrow = TRUE))\n\nfig5.3b"
  },
  {
    "objectID": "Ch5.html#missing-tab-5.5-and-figs-5.10-5.11",
    "href": "Ch5.html#missing-tab-5.5-and-figs-5.10-5.11",
    "title": "5  Marginal models",
    "section": "MISSING: Tab 5.5 and Figs 5.10-5.11",
    "text": "MISSING: Tab 5.5 and Figs 5.10-5.11\nTODO: run HNRV’s adapted chapter5_bmt_Eva.qmd (made frome Eva’s bmt230217.R)"
  },
  {
    "objectID": "Ch5.html#exercises",
    "href": "Ch5.html#exercises",
    "title": "5  Marginal models",
    "section": "Exercises",
    "text": "Exercises\n\nExercise 5.1 (*)\nConsider the two-state reversible Markov model, set up the \\(\\mathbf{A}(t)\\) and \\(\\mathbf{P}(s,t)\\) matrices, and express, using the Kolmogorov forward differential equations, the transition probabilities in terms of the transition intensities.\nThe intensity matrix is: \\[{\\bf A}(t)=\\left( \\begin{array}{cc}\n-A_{01}(t)&A_{01}(t)\\\\\nA_{10}(t)&-A_{10}(t)\\\\\n\\end{array} \\right).\n\\] and the transition probability matrix: \\[{\\bf P}(s,t)=\\left( \\begin{array}{cc}\nP_{00}(s,t)&1-P_{00}(s,t)\\\\\n1-P_{11}(s,t)&P_{11}(s,t)\\\\\n\\end{array} \\right)\n\\] or, equivalently \\[{\\bf P}(s,t)=\\left( \\begin{array}{cc}\n1-P_{01}(s,t)&P_{01}(s,t)\\\\\nP_{10}(s,t)&1-P_{10}(s,t)\\\\\n\\end{array} \\right).\n\\] This leads to the Kolmogorov forward differential equations \\[\\frac{\\partial}{\\partial t}P_{01}(s,t)+(\\alpha_{01}(t)+\\alpha_{10}(t))P_{01}(s,t)=\\alpha_{01}(t)\\] and \\[\\frac{\\partial}{\\partial t}P_{10}(s,t)+(\\alpha_{01}(t)+\\alpha_{10}(t))P_{10}(s,t)=\\alpha_{10}(t).\\] These are linear first order differential equations, i.e., of the form \\[f^{\\prime}(t)+g(t)f(t)=h(t)\\] which are known to have the solution \\[f(t)=v(t)\\exp(-G(t))+c\\exp(-G(t))\\] with \\(G^{\\prime}(t)=g(t)\\) and \\(v^{\\prime}(t)=\\exp(G(t))h(t)\\), and the constants \\(c\\) are determined such that \\(P_{01}(s,s)=0\\) and \\(P_{10}(s,s)=0\\). For \\(s=0\\), the solution is \\[P_{01}(0,t)=\\int_0^t\\exp(-\\int_u^t(\\alpha_{01}(x)+\\alpha_{10}(x))dx)\\alpha_{01}(u)du\\] (the constant \\(c=0\\)) and, for a general \\(s\\): \\[P_{01}(s,t)=\\int_s^t\\exp(-\\int_u^t(\\alpha_{01}(x)+\\alpha_{10}(x))dx)\\alpha_{01}(u)du.\\] The expression for \\(P_{10}(s,t)\\) is similar.\n\n\nExercise 5.2 (*)\nConsider the four-state model for the bone marrow transplantation study, set up the \\(\\mathbf{A}(t)\\) and \\(\\mathbf{P}(s,t)\\) matrices, and express, using the Kolmogorov forward differential equations, the transition probabilities in terms of the transition intensities.\nThe intensity matrix is \\[{\\bf A}(t)=\\left( \\begin{array}{cccc}\n-A_{01}(t)-A_{02}(t)-A_{03}(t)&A_{01}(t)&A_{02}(t)&A_{03}(t)\\\\\n0&-A_{12}(t)-A_{13}(t)&A_{12}(t)&A_{13}(t)\\\\\n0&0&-A_{23}(t)&A_{23}(t)\\\\\n0&0&0&0\\\\\n\\end{array} \\right),\n\\] and the transition probability matrix \\[{\\bf P}(s,t)=\\left( \\begin{array}{cccc}\nP_{00}(s,t)&P_{01}(s,t)&P_{02}(s,t)&P_{03}(s,t)\\\\\n0&P_{11}(s,t)&P_{12}(s,t)&P_{13}(s,t)\\\\\n0&0&P_{22}(s,t)&P_{23}(s,t)\\\\\n0&0&0&1\\\\\n\\end{array} \\right),\n\\] with \\(P_{00}=1-P_{01}-P_{02}-P_{03}\\), \\(P_{11}=1-P_{12}-P_{13}\\), and \\(P_{22}=1-P_{23}\\). The Kolmogorov forward equations are \\[\\frac{\\partial}{\\partial t}P_{00}(s,t)=-P_{00}(s,t)(\\alpha_{01}(t)+\\alpha_{02}(t)+\\alpha_{03}(t)),\\] \\[\\frac{\\partial}{\\partial t}P_{01}(s,t)=P_{00}(s,t)\\alpha_{01}(t)-P_{01}(s,t)(\\alpha_{12}(t)+\\alpha_{13}(t)),\\] \\[\\frac{\\partial}{\\partial t}P_{02}(s,t)=P_{00}(s,t)\\alpha_{02}(t)+P_{01}(s,t)\\alpha_{12}(t)-P_{02}(s,t)\\alpha_{23}(t),\\] \\[\\frac{\\partial}{\\partial t}P_{11}(s,t)=-P_{11}(s,t)(\\alpha_{12}(t)+\\alpha_{13}(t)),\\] \\[\\frac{\\partial}{\\partial t}P_{12}(s,t)=P_{11}(s,t)\\alpha_{12}(t)-P_{22}(s,t)\\alpha_{23}(t),\\] \\[\\frac{\\partial}{\\partial t}P_{22}(s,t)=-P_{22}(s,t)\\alpha_{23}(t).\\] For \\(P_{hh}, h=0,1,2,\\) the solutions are the well-known \\[P_{hh}(s,t)=\\exp(-\\int_s^t\\alpha_{h\\cdot}(u)du),\\] where \\(\\alpha_{h\\cdot}(u)\\) is the total transition intensity out of state \\(h\\). For both \\(P_{01}\\) and \\(P_{21}\\), the equation has the same form as that for the Markov illness-death model (Section 5.1.3, except for a misprint there where the r.h.s. of the equation for \\(P_{01}\\) should read \\(P_{00}(s,t)\\alpha_{01}(t)-P_{01}(s,t)\\alpha_{12}(t)\\)) and the solutions are, respectively, \\[P_{01}(s,t)=\\int_s^tP_{00}(s,u)\\alpha_{01}(u)P_{11}(u,t)du, \\quad\nP_{12}(s,t)=\\int_s^tP_{11}(s,u)\\alpha_{12}(u)P_{22}(u,t)du.\\] These results may be verified by direct differentiation or by referring to the fact that the differential equation is linear, as utilized in Exercise 5.1.\nThe equation for \\(P_{02}(s,t)=f(t)\\) is also linear, \\(f^{\\prime}(t)+g(t)f(t)=h(t)\\), with \\(g(t)=\\alpha_{23}(t)\\) and \\(h(t)=P_{00}(s,t)\\alpha_{02}(t)+P_{01}(s,t)\\alpha_{12}(t)\\). As a consequence, the solution (as shown in Section 5.1.5) has two terms \\[P_{02}^{(a)}(s,t)=\\int_s^tP_{00}(s,u)\\alpha_{02}(u)P_{22}(u,t)du\\] corresponding to the probability of a direct \\(0\\rightarrow 2\\) transition, and \\[P_{02}^{(b)}(s,t)=\\int_s^tP_{01}(s,u)\\alpha_{12}(u)P_{22}(u,t)du\\] corresponding to transition via state 1.\n\n\nExercise 5.3 (*)\n\n1.\nConsider the competing risks model and show that the ratio between the cause \\(h\\) sub-distribution hazard and the corresponding cause-specific hazard is \\[\\frac{\\widetilde{\\alpha}_h(t)}{\\alpha_h(t)}=\\frac{S(t)}{1-F_h(t)}.\\]\nLet \\(T_h=\\inf\\{t:V(t)=h\\}\\) be the improper variable denoting time of transition into state \\(h\\). Then \\(P(t\\leq T_h<t+dt)=\\alpha_{0h}(t)P(V(t)=0)dt\\). The cause-specific hazard is the conditional probability of this event given \\(V(t)=0\\), and the conditioning event has probability \\(S(t)=P(V(t)=0)\\). For the sub-distribution hazard the conditioning event is \\(T_h>t\\) with probability \\(1-F_h(t)\\), so, the ratio between the two is \\(S(t)/(1-F_1(t))\\).\n\n\n2.\nShow that, thereby, proportional sub-distribution hazards and proportional cause-specific hazards are incompatible.\nFor a two-sample situation with proportional cause-specific hazards, i.e., \\(\\alpha_{h1}(t)=\\theta\\alpha_{h0}(t)\\), the ratio between the corresponding sub-distribution hazards is, therefore, \\[\\frac{\\widetilde{\\alpha}_{h1}(t)}{\\widetilde{\\alpha}_{h0}(t)}=\\frac{S_1(t)/(1-F_{h1}(t))}{S_0(t)/(1-F_{h0}(t))}\\] \\[=\\frac{\\exp(-A_h(t)(\\theta-1))}{\\theta\\int_0^tS_1(u)\\alpha_h(u)du/\\int_0^tS_0(u)\\alpha_h(u)du}\\] which is constant in \\(t\\) only if \\(\\theta=1\\). A similar argument shows that proportional sub-distribution hazards leads to non-proportional cause-specific hazards.\n\n\n\nExercise 5.4 (*)\nConsider the competing risks model and direct binomial regression for \\(Q_h(t_0)\\), the cause-\\(h\\) cumulative incidence at time \\(t_0\\). The estimating equation (5.18) is \\[\\sum_iD_i(t_0)\\widehat{W}_i(t_0)\\mathbf{A}(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)\\bigl(N_{hi}(t_0)-Q_h(t_0\\mid \\mathbf{Z}_1)\\bigr)\\] with \\(D_i(t_0)\\) the indicator \\(I(T_i\\wedge t_0\\leq C_i)\\) of observing the state occupied at \\(t_0\\) and \\(\\widehat{W}_i(t_0)=1/\\widehat{G}((t_0\\wedge X_i)-)\\) the estimated inverse probability of no censoring (strictly) before the minimum of \\(t_0\\) and the observation time \\(X_i\\) for subject \\(i\\). The alternative estimating equation (5.32) is \\[\\sum_i\\mathbf{A}(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)\\bigl(N_{hi}(t_0)D_i(t_0)\\widehat{W}_i(t_0)-Q_h(t_0\\mid \\mathbf{Z}_i)\\bigr).\\] Show that, replacing \\(\\widehat{G}\\) by the true \\(G\\), both estimating equations are unbiased.\nNote that \\(D_i(t_0)/G(t_0\\wedge X_i)=D_i(t_0)/G(t_0\\wedge T_i)\\) and that, hence, \\[E(D_i(t_0)/G(t_0\\wedge X_i)\\mid T_i)=1.\\] Note, further, that the observed indicator \\(N_{hi}(t_0)=I(X_i\\leq t_0, D_i=h)\\) in both sets of equations, \\(\\mathbf{U}=\\mathbf{0}\\), may be replaced by \\(I(T_i\\leq t_0, D_i=h)\\). This is because \\[\\widehat{W}_i(t_0)N_{hi}(t_0)=\\widehat{W}_i(t_0)I(T_i\\leq t_0, D_i=h).\\] With these remarks in place, unbiasedness of both sets of estimating equations follows by writing the expectation as \\[E(\\mathbf{U})=E_T(E(\\mathbf{U}\\mid T)).\\]\n\n\nExercise 5.5 (*)\nDerive the estimating equations for the landmark model (5.11).\nThe pseudo-likelihood contribution from a single landmark is \\[\\sum_{i=1}^n\\int_{s_j}^{t_{hor}(s_j)}Y_i(s_j)\\log\\bigl(\\frac{\\exp(\\mbox{LP}_{s_j,i})}{\\sum_kY_k(t)\\exp(\\mbox{LP}_{s_j,k})}\\bigr)dN_i(t),\\] however, in contrast to model (5.10), the same regression coefficient appears at all landmarks, so, the resulting pseudo-likelihood is obtained by adding over landmarks, \\(j\\) \\[\\sum_{j=1}^L\\sum_{i=1}^n\\int_{s_j}^{t_{hor}(s_j)}Y_i(s_j)\\log\\bigl(\\frac{\\exp(\\mbox{LP}_{s_j,i})}{\\sum_kY_k(t)\\exp(\\mbox{LP}_{s_j,k})}\\bigr)dN_i(t).\\] There is a baseline hazard for each landmark, and estimation is based on events observed between \\(s_j\\) and \\(t_{hor}(s_j)\\), i.e., the Breslow-type estimator \\[\\widehat{A}_{0s_j}(t)=\\int_{s_j}^t\\frac{\\sum_iY_i(s_j)dN_i(u)}{\\sum_iY_i(u)\\exp(\\widehat{\\mbox{LP}}_{s_j,i})}.\\]"
  },
  {
    "objectID": "Ch6.html#pbc3-trial-in-liver-cirrhosis",
    "href": "Ch6.html#pbc3-trial-in-liver-cirrhosis",
    "title": "6  Pseudo-values",
    "section": "PBC3 trial in liver cirrhosis",
    "text": "PBC3 trial in liver cirrhosis\n\nRead data\n\n\nCode show/hide\npbc3 <- data.frame(read.csv(\"data/pbc3.csv\"))\npbc3$fail <- as.numeric(with(pbc3, status > 0))\npbc3$log2bili <- with(pbc3, log2(bili))\n\n\n\n\n\n\n\n\n\n\n\nFigure 6.1\n\n\nCode show/hide\n# General plotting style\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\", \n        text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20)) \n\n# Calculate pseudo-observations of the survival function for subjects\n# The subjects with ptno=415 and ptno=458 are selected\nlibrary(pseudo)\npseudo_allt <- pseudosurv(pbc3$days, pbc3$fail)\n\n# Re-arrange the data into a long data set\nb <- NULL\nfor(it in 1:length(pseudo_allt$time)){\n  b <- rbind(b,cbind(pbc3,\n                     pseudo = pseudo_allt$pseudo[,it],\n                     tpseudo = pseudo_allt$time[it],\n                     id = 1:nrow(pbc3)))\n}\nb <- b[order(b$id),]\npseudo_alltid <- b\n\n# Subset the two subjects \nsubdat <- subset(pseudo_alltid, id %in% c(\"305\", \"325\"))\n\n# Collect data for plot\npseudodata <- data.frame(tpseudo = subdat$tpseudo / 365.25, \n                         pseudo = subdat$pseudo, \n                         id = as.factor(subdat$id))\n\nfig6.1 <- ggplot(aes(x = tpseudo, y = pseudo, linetype = id), \n                 data = pseudodata) + \n  geom_hline(yintercept = c(0, 1), color = \"darkgrey\", size = 1) + \n  geom_step(linewidth = 1) + \n  scale_linetype_manual(\"Patient number\", values = c(\"dashed\", \"dotted\")) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Pseudo-values\") + \n  scale_x_continuous(expand = expansion(mult = c(0.02, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05))) +\n  theme_general +\n  theme(legend.position = \"none\")\n\nfig6.1\n\n\n\n\n\n\n\nFigure 6.2\n\n(a)\n\n\nCode show/hide\ntheme_general_1 <- theme_bw() +\n  theme(legend.position = \"none\", \n        text = element_text(size = 26), \n        axis.text.x = element_text(size = 26), \n        axis.text.y = element_text(size = 26)) \n\n# Select the pseudo-observations at times \ntimes <- c(366, 743, 1105)\n\n# At 1 year\npseudo_t1 <- subset(pseudo_alltid, tpseudo == times[1])\n\n# Collect data for plot\npseudodata <- data.frame(tpseudo = pseudo_t1$tpseudo / 365.25, \n                         days = pseudo_t1$days,\n                         pseudo = pseudo_t1$pseudo, \n                         failtype = as.factor(pseudo_t1$fail))\n\nfig6.2 <- ggplot(aes(x = days  / 365.25, y = pseudo, shape = failtype), \n                 data = pseudodata) + \n  geom_point(size = 6) + \n  scale_shape_manual(\"Fail\", values = c(4, 1)) + \n  xlab(expression(\"X\"[i]*\" (years)\")) + \n  ylab(\"Pseudo-values\") + \n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(-0.9, 1.1)) +\n  theme_general_1\n\nfig6.2\n\n\n\n\n\n\n\n(b)\n\n\nCode show/hide\n# At 2 years\npseudo_t2 <- subset(pseudo_alltid, tpseudo == times[2])\n\n# Collect data for plot\npseudodata <- data.frame(tpseudo = pseudo_t2$tpseudo / 365.25, \n                         days = pseudo_t2$days,\n                         pseudo = pseudo_t2$pseudo, \n                         failtype = as.factor(pseudo_t2$fail))\n\nfig6.2b <- ggplot(aes(x = days / 365.25, y = pseudo, shape = failtype), \n                  data = pseudodata) + \n  geom_point(size = 6) + \n  scale_shape_manual(\"Fail\", values = c(4, 1)) + \n  xlab(expression(\"X\"[i]*\" (years)\")) +  \n  ylab(\"Pseudo-values\") + \n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(-0.9, 1.1)) +\n  theme_general_1\n\nfig6.2b\n\n\n\n\n\n\n\n(c)\n\n\nCode show/hide\n# At 3 years\npseudo_t3 <- subset(pseudo_alltid, tpseudo == times[3])\n\n# Collect data for plot\npseudodata <- data.frame(tpseudo = pseudo_t3$tpseudo / 365.25, \n                         days = pseudo_t3$days,\n                         pseudo = pseudo_t3$pseudo, \n                         failtype = as.factor(pseudo_t3$fail))\n\nfig6.2c <- ggplot(aes(x = days/365.25, y = pseudo, shape = failtype), \n                  data = pseudodata) + \n  geom_point(size = 6) + \n  scale_shape_manual(\"Fail\", values = c(4, 1)) + \n  xlab(expression(\"X\"[i]*\" (years)\")) + \n  ylab(\"Pseudo-values\") + \n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(-0.9, 1.1)) +\n  theme_general_1 +\n  theme(legend.position=\"none\")\n\nfig6.2c\n\n\n\n\n\n\n\n\nFigure 6.3\n\nLeft\n\n\nCode show/hide\n# Collect data for plot\npseudodata <- data.frame(tpseudo = pseudo_t2$tpseudo / 365.25, \n                         days = pseudo_t2$days,\n                         pseudo = pseudo_t2$pseudo, \n                         log2bili =  pseudo_t2$log2bili, \n                         bili = pseudo_t2$bili,\n                         alb = pseudo_t2$alb,\n                         tment = pseudo_t2$tment,\n                         id = pseudo_t2$id,\n                         failtype = as.factor(pseudo_t2$fail))\n\nbili_loess <- loess(pseudo ~ bili, data = pseudodata, span = 0.8, degree = 1)\npseudodata$loesspred <- predict(bili_loess)\n\npseudodata$t_loesspred <- with(\n  pseudodata, ifelse(loesspred > 0 , log(-log(loesspred)), NA)\n  )\n\nfig6.3left <- ggplot(aes(x = bili, y = pseudo), data = pseudodata) + \n  geom_point(size = 4, shape = 4) + \n  geom_line(aes(x = bili, y = loesspred), size = 1) +\n  xlab(\"Bilirubin\") +  \n  ylab(\"Pseudo-values\") + \n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     breaks = seq(-0.4, 1.2, by = 0.2), \n                     limits = c(-0.4, 1.2)) +\n  theme_general\n\nfig6.3left\n\n\n\n\n\n\n\nRight\n\n\nCode show/hide\nfig6.3right <- ggplot(aes(x = bili, y = t_loesspred), data = pseudodata) + \n  geom_line(size = 1) + \n  xlab(\"Bilirubin\") +  \n  ylab(\"log(-log(predicted pseudo-values))\") + \n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     breaks = seq(-5, 2, by = 1), \n                     limits = c(-5, 2)) +\n  theme_general\n\nfig6.3right\n\n\n\n\n\n\n\n\nFigure 6.4\n\nLeft\n\n\nCode show/hide\n# Loess for log2 bili\nlog2bili_loess <- loess(pseudo ~ log2bili, data = pseudodata, span = 0.8, degree = 1)\npseudodata$log2bili_loesspred <- predict(log2bili_loess)\n\npseudodata$t_log2bili_loesspred <- with(pseudodata,\n                               ifelse(log2bili_loesspred > 0 , log(-log(log2bili_loesspred)), NA))\n\nfig6.4left <- ggplot(aes(x = log2bili, y = pseudo), data = pseudodata) +\n  geom_point(size = 4, shape = 4) +\n  geom_line(aes(x = log2bili, y = log2bili_loesspred), size = 1) +\n  xlab(expression(\"log\" [2] * \"(bilirubin)\")) +\n  ylab(\"Pseudo-values\") +\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), limits = c(1, 9),\n                     breaks = seq(1, 9, by = 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), breaks = seq(-0.4, 1.2, by = 0.2),\n                     limits = c(-0.4, 1.2)) +\n  theme_general\n\nfig6.4left\n\n\n\n\n\n\n\nRight\n\n\nCode show/hide\nfig6.4right <- ggplot(aes(x = log2bili, y = t_log2bili_loesspred), data = pseudodata) +\n  geom_line(size = 1) +\n  xlab(expression(\"log\" [2] * \"(bilirubin)\")) +\n  ylab(\"log(-log(predicted pseudo-values))\") +\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), limits = c(1, 9),\n                     breaks = seq(1, 9, by = 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), breaks = seq(-5, 2, by = 1),\n                     limits = c(-5, 2)) +\n  theme_general\n\nfig6.4right\n\n\n\n\n\n\n\n\nTable 6.1\nTODO: SDs for the three time points model are not as in table in Book\n\n\nCode show/hide\nposumm<-function(pofit,d=6){ \n  round(cbind(\n    Est = pofit$beta, \n    SD = sqrt(diag(pofit$vbeta)), \n    lo.ci = pofit$beta-1.96*sqrt(diag(pofit$vbeta)), \n    up.ci = pofit$beta+1.96*sqrt(diag(pofit$vbeta)), \n    Wald = (pofit$beta/sqrt(diag(pofit$vbeta)))^2, \n    PVal = 2-2*pnorm(abs(pofit$beta/sqrt(diag(pofit$vbeta))))),d) \n}\n\nposummExp<-function(pofit,d=6){\n  round(cbind(\n    est = pofit$beta, \n    SD = sqrt(diag(pofit$vbeta)), \n    exp.est = exp(pofit$beta), \n    exp.lo.ci = exp(pofit$beta-1.96*sqrt(diag(pofit$vbeta))), \n    exp.up.ci = exp(pofit$beta+1.96*sqrt(diag(pofit$vbeta))), \n    PVal = 2-2*pnorm(abs(pofit$beta/sqrt(diag(pofit$vbeta))))),d) \n}\n\n\n# At time year 2\nfit1 <- geese(formula = I(1 - pseudo) ~ tment +alb + log2bili,\n              data = subset(pseudodata, !is.na(alb)),\n              id = id,\n              mean.link = \"cloglog\")\nposummExp(fit1)\n\n\n                  est       SD  exp.est exp.lo.ci exp.up.ci     PVal\n(Intercept) -2.116642 1.326984 0.120435  0.008937  1.622951 0.110695\ntment       -0.705053 0.369341 0.494082  0.239557  1.019035 0.056269\nalb         -0.105069 0.034169 0.900263  0.841946  0.962618 0.002105\nlog2bili     0.835723 0.140429 2.306480  1.751517  3.037282 0.000000\n\n\nCode show/hide\n# At time year c(1, 2, 3)\n# Select the pseudo-observations at times\ntimes <- c(366, 743, 1105)\npseudo_t1 <- subset(pseudo_alltid, tpseudo == times[1])\npseudo_t2 <- subset(pseudo_alltid, tpseudo == times[2])\npseudo_t3 <- subset(pseudo_alltid, tpseudo == times[3])\n\npseudo_t <- rbind(pseudo_t1, pseudo_t2, pseudo_t3)\n\npseudodata_t <- data.frame(tpseudo = pseudo_t$tpseudo / 365.25,\n                         days = pseudo_t$days,\n                         pseudo = pseudo_t$pseudo,\n                         log2bili =  pseudo_t$log2bili,\n                         bili = pseudo_t$bili,\n                         alb = pseudo_t$alb,\n                         tment = pseudo_t$tment,\n                         id = pseudo_t$id,\n                         failtype = as.factor(pseudo_t$fail))\n\n# At time year c(1, 2, 3)\nfit2 <- geese(formula = I(1 - pseudo) ~ tment + alb + log2bili + as.factor(tpseudo) -1,\n              data = subset(pseudodata_t, !is.na(alb)),\n              id = id,\n              mean.link = \"cloglog\",\n              corstr=\"independence\")\nposummExp(fit2)\n\n\n                                         est       SD  exp.est exp.lo.ci\ntment                              -0.598536 0.213046 0.549616  0.362002\nalb                                -0.093907 0.019069 0.910367  0.876970\nlog2bili                            0.684093 0.071818 1.981972  1.721729\nas.factor(tpseudo)1.00205338809035 -2.474620 0.829782 0.084195  0.016556\nas.factor(tpseudo)2.03422313483915 -1.554010 0.810703 0.211399  0.043154\nas.factor(tpseudo)3.02532511978097 -1.123233 0.813730 0.325227  0.065997\n                                   exp.up.ci     PVal\ntment                               0.834464 0.004963\nalb                                 0.945036 0.000001\nlog2bili                            2.281552 0.000000\nas.factor(tpseudo)1.00205338809035  0.428165 0.002861\nas.factor(tpseudo)2.03422313483915  1.035587 0.055255\nas.factor(tpseudo)3.02532511978097  1.602682 0.167479\n\n\n\n\nFigure 6.5\n\n\nCode show/hide\n# At time year c(1, 2, 3) \nfit2 <- geese(formula = I(1 - pseudo) ~ as.factor(tpseudo) + log2bili + alb + tment - 1, \n              data = subset(pseudodata_t, !is.na(alb)), \n              id = id, \n              mean.link = \"cloglog\",\n              variance = \"gaussian\",\n              scale.value = 0, \n              scale.fix = 1)\npseudodata_t$pred <- rep(NA, nrow(pseudodata_t))\n\n# At time 1\npseudodata_t[pseudodata_t$tpseudo == times[1] / 365.25,]$pred <- \n  with(pseudodata_t[pseudodata_t$tpseudo == times[1] / 365.25,],\n        fit2$beta[1] + fit2$beta[4]*log2bili + fit2$beta[5]*alb + fit2$beta[6]*tment)\n\n# At time 2\npseudodata_t[pseudodata_t$tpseudo == times[2] / 365.25,]$pred <- \n  with(pseudodata_t[pseudodata_t$tpseudo == times[2] / 365.25,],\n       fit2$beta[2] + fit2$beta[4]*log2bili + fit2$beta[5]*alb + fit2$beta[6]*tment)\n\n# At time 3\npseudodata_t[pseudodata_t$tpseudo == times[3] / 365.25,]$pred <- \n  with(pseudodata_t[pseudodata_t$tpseudo == times[3] / 365.25,],\n       fit2$beta[3] + fit2$beta[4]*log2bili + fit2$beta[5]*alb + fit2$beta[6]*tment)\n\n# Transform back\npseudodata_t$res <- with(pseudodata_t, pseudo - exp(-exp(pred)))\npseudodata_t$time <- as.factor(pseudodata_t$tpseudo * 365.25)\n\n# Make loess smooth per time\nlog2bili_res_loess_1 <- loess(res ~ log2bili, \n                              data = subset(pseudodata_t, time == 366), span = 0.7, degree = 1)\nlog2bili_res_loess_2 <- loess(res ~ log2bili, \n                              data = subset(pseudodata_t, time == 743), span = 0.7, degree = 1)\nlog2bili_res_loess_3 <- loess(res ~ log2bili, \n                              data = subset(pseudodata_t, time == 1105), span = 0.7, degree = 1)\n\nlog2bili_res_pred_1 <- predict(log2bili_res_loess_1, newdata = subset(pseudodata_t, time == 366))\nlog2bili_res_pred_2 <- predict(log2bili_res_loess_2, newdata = subset(pseudodata_t, time == 743))\nlog2bili_res_pred_3 <- predict(log2bili_res_loess_3, newdata = subset(pseudodata_t, time == 1105))\n\npseudodata_t$log2bili_res_pred <- c(log2bili_res_pred_1, log2bili_res_pred_2, log2bili_res_pred_3)\n\nfig6.5 <- ggplot(aes(x = log2bili, y = res, shape = time), data = pseudodata_t) + \n  geom_line(aes(x = log2bili, y = log2bili_res_pred , linetype = time), size = 1) +\n  geom_point(size = 3) + \n  scale_shape_manual(\"Year\", values = c(4, 2, 0), labels = c(\"1\", \"2\", \"3\")) +\n  scale_linetype_manual(\"Year\", values = c(\"dashed\", \"solid\", \"dotted\"), labels = c(\"1\", \"2\", \"3\")) +\n  xlab(expression(\"log\" [2] * \"(bilirubin)\")) +  \n  ylab(\"Pseudo-residuals\") + \n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), limits = c(1, 9), \n                     breaks = seq(1, 9, by = 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), breaks = seq(-2, 1, by = 1), \n                     limits = c(-2, 1)) +\n  theme_general + \n  theme(legend.box = \"vertical\",\n        text = element_text(size=20), \n        legend.key.size = unit(1.5, 'cm'),\n        legend.text = element_text(size = 20))\n\n\nfig6.5\n\n\n\n\n\n\n\nTable 6.2\n\n\nCode show/hide\n# At time year c(1, 2, 3) using log-link instead\nfit2 <- geese(formula = pseudo ~ as.factor(tpseudo) + bili + alb + tment - 1,\n              data = subset(pseudodata_t, !is.na(alb)),\n              id = id,\n              mean.link = \"log\",\n              variance = \"gaussian\",\n              scale.value = 0,\n              scale.fix = 1, maxit = 50)\nsummary(fit2)\n\n\n\nCall:\ngeese(formula = pseudo ~ as.factor(tpseudo) + bili + alb + tment - \n    1, id = id, data = subset(pseudodata_t, !is.na(alb)), mean.link = \"log\", \n    variance = \"gaussian\", scale.fix = 1, scale.value = 0, maxit = 50)\n\nMean Model:\n Mean Link:                 log \n Variance to Mean Relation: gaussian \n\n Coefficients:\n                                       estimate       san.se      wald\nas.factor(tpseudo)1.00205338809035 -0.340268943 0.1038790249 10.729733\nas.factor(tpseudo)2.03422313483915 -0.412025685 0.1063019966 15.023314\nas.factor(tpseudo)3.02532511978097 -0.507547919 0.1089067608 21.719230\nbili                               -0.004191576 0.0005629232 55.444219\nalb                                 0.009689574 0.0023542035 16.940310\ntment                               0.048389674 0.0227323690  4.531229\n                                              p\nas.factor(tpseudo)1.00205338809035 1.054277e-03\nas.factor(tpseudo)2.03422313483915 1.061912e-04\nas.factor(tpseudo)3.02532511978097 3.156116e-06\nbili                               9.614531e-14\nalb                                3.857371e-05\ntment                              3.328171e-02\n\nScale is fixed.\n\nCorrelation Model:\n Correlation Structure:     independence \n\nReturned Error Value:    0 \nNumber of clusters:   1029   Maximum cluster size: 1 \n\n\nCode show/hide\n## - log scale used as link in Table 6.2 (add \"-\" in front of all estimates)\n# No default \"-log(x)\" link function in R\n\n\n\n\nFigure 6.6\n\nLeft\n\n\nCode show/hide\n# Create Figure 6.6 (a) - done earlier\nfig6.6left <- fig6.3left\nfig6.6left\n\n\n\n\n\n\n\nRight\n\n\nCode show/hide\n# Same as earlier:\nbili_loess <- loess(pseudo ~ bili, data = pseudodata, span = 0.8, degree = 1)\npseudodata$loesspred <- predict(bili_loess)\n\n# Use log-trans instead of cloglog\npseudodata$log_loesspred <- with(pseudodata,\n                               ifelse(loesspred > 0 , -log(loesspred), NA))\n\nfig6.6right <- ggplot(aes(x = bili, y = log_loesspred), data = pseudodata) +\n  geom_line(size = 1) +\n  xlab(\"Bilirubin\") +\n  ylab(\"-log(predicted pseudo-values)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05))) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), breaks = seq(-1, 3, by = 1),\n                     limits = c(-1, 3)) +\n  theme_general\n\nfig6.6right\n\n\n\n\n\n\n\n\nFigure 6.7\n\n\nCode show/hide\n# Use regression estimates from fit2\n\npseudodata_t$pred <- rep(NA, nrow(pseudodata_t))\n\n# At time 1\npseudodata_t[pseudodata_t$tpseudo == times[1] / 365.25,]$pred <-\n  with(pseudodata_t[pseudodata_t$tpseudo == times[1] / 365.25,],\n       fit2$beta[1] + fit2$beta[4]*bili + fit2$beta[5]*alb + fit2$beta[6]*tment)\n\n# At time 2\npseudodata_t[pseudodata_t$tpseudo == times[2] / 365.25,]$pred <-\n  with(pseudodata_t[pseudodata_t$tpseudo == times[2] / 365.25,],\n       fit2$beta[2] + fit2$beta[4]*bili + fit2$beta[5]*alb + fit2$beta[6]*tment)\n\n# At time 3\npseudodata_t[pseudodata_t$tpseudo == times[3] / 365.25,]$pred <-\n  with(pseudodata_t[pseudodata_t$tpseudo == times[3] / 365.25,],\n       fit2$beta[3] + fit2$beta[4]*bili + fit2$beta[5]*alb + fit2$beta[6]*tment)\n\n# Transform back\npseudodata_t$res <- with(pseudodata_t, pseudo - exp(pred))\npseudodata_t$time <- as.factor(pseudodata_t$tpseudo * 365.25)\n\n# Make loess smooth per time\nbili_res_loess_1 <- loess(res ~ bili,\n                          data = subset(pseudodata_t, time == 366), \n                          span = 0.7, degree = 1)\nbili_res_loess_2 <- loess(res ~ bili,\n                          data = subset(pseudodata_t, time == 743), \n                          span = 0.7, degree = 1)\nbili_res_loess_3 <- loess(res ~ bili,\n                          data = subset(pseudodata_t, time == 1105), \n                          span = 0.7, degree = 1)\n\nbili_res_pred_1 <- predict(bili_res_loess_1, \n                           newdata = subset(pseudodata_t, time == 366))\nbili_res_pred_2 <- predict(bili_res_loess_2, \n                           newdata = subset(pseudodata_t, time == 743))\nbili_res_pred_3 <- predict(bili_res_loess_3, \n                           newdata = subset(pseudodata_t, time == 1105))\n\npseudodata_t$bili_res_pred <- c(bili_res_pred_1, \n                                bili_res_pred_2, \n                                bili_res_pred_3)\n\n# Create Figure\nfig6.7 <- ggplot(aes(x = bili, y = res, shape = time), data = pseudodata_t) +\n  geom_line(aes(x = bili, y = bili_res_pred , linetype = time), size = 1) +\n  geom_point(size = 3) +\n  scale_shape_manual(\"Year\", values = c(4, 2, 0), \n                     labels = c(\"1\", \"2\", \"3\")) +\n  scale_linetype_manual(\"Year\", \n                        values = c(\"dashed\", \"solid\", \"dotted\"), \n                        labels = c(\"1\", \"2\", \"3\")) +\n  xlab(expression(\"Bilirubin\")) +\n  ylab(\"Pseudo-residuals\") +\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     limits = c(0, 500),\n                     breaks = seq(0, 500, by = 100)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), \n                     breaks = seq(-2, 1, by = 1),\n                     limits = c(-2, 1)) +\n  theme_general +\n  theme(legend.box = \"vertical\",\n        text = element_text(size=20),\n        legend.key.size = unit(2, 'cm'),\n        legend.text = element_text(size = 20))\n\nfig6.7\n\n\n\n\n\n\n\nTable 6.3\n\n\nCode show/hide\n# Calculate pseudo-observations of the restricted mean for subjects\npseudo_allt <- pseudomean(pbc3$days / 365.25, pbc3$fail, tmax = 3)\n# Re-arrange the data into a long data set\na <- cbind(pbc3, pseudo = pseudo_allt)\noutmean3 <- a\n# Fit model\nfit_resm <- geese(pseudo ~ tment  + alb+ log2bili, id = id,\n                  data = subset(outmean3, !is.na(alb)),\n                  mean.link = \"identity\", corstr = \"independence\",\n                  scale.fix = FALSE,\n                  family = \"gaussian\")\nposumm(fit_resm)\n\n\n                  Est       SD     lo.ci     up.ci      Wald     PVal\n(Intercept)  2.825598 0.346121  2.147201  3.503995 66.644608 0.000000\ntment        0.147813 0.072936  0.004858  0.290769  4.107123 0.042703\nalb          0.022512 0.006811  0.009162  0.035862 10.924256 0.000949\nlog2bili    -0.243093 0.031982 -0.305778 -0.180408 57.773091 0.000000\n\n\n\n\nFigure 6.8\n\n\nCode show/hide\n# Collect data for plot\npseudodata <- data.frame(days = outmean3$days,\n                         pseudo = outmean3$pseudo,\n                         failtype = as.factor(outmean3$fail))\n\nfig6.8 <- ggplot(aes(x = days / 365.25, y = pseudo, shape = failtype), data = pseudodata) +\n  geom_point(size = 6) +\n  scale_shape_manual(\"Fail\", values = c(4, 1)) +\n  xlab(expression(\"X\"[i]*\" (years)\")) +\n  ylab(\"Pseudo-values\") +\n  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05)), limits = c(0, 6),\n                     breaks = seq(0, 6, by = 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), limits = c(0, 4)) +\n  theme_general +\n  theme(legend.position=\"none\")\n\nfig6.8\n\n\n\n\n\n\n\nFigure 6.9\n\n\nCode show/hide\n# Loess for log2 bili\nlog2bili_loess <- loess(pseudo ~ log2bili, data = outmean3, span = 0.8, degree = 1)\noutmean3$log2bili_loesspred <- predict(log2bili_loess)\n\n#outmean3$t_log2bili_loesspred <- with(outmean3,\n#                                        ifelse(log2bili_loesspred > 0 ,\n#                                               log(log2bili_loesspred/(1-log2bili_loesspred)), NA))\n\nfig6.9 <- ggplot(aes(x = log2bili, y = pseudo), data = outmean3) +\n  geom_point(size = 6, shape = 4) +\n  geom_line(aes(x = log2bili, y = log2bili_loesspred), size = 1) +\n  xlab(expression(\"log\" [2] * \"(bilirubin)\")) +\n  ylab(\"Pseudo-values\") +\n  scale_x_continuous(expand = expansion(mult = c(0.01, 0.05)), limits = c(1, 9),\n                     breaks = seq(1, 9, by = 1)) +\n  scale_y_continuous(expand = expansion(mult = c(0.01, 0.05)), breaks = seq(0, 4, by = 1),\n                     limits = c(0, 4)) +\n  theme_general\n\nfig6.9\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nTable 6.6\n\n\nCode show/hide\n# Lost years\npseudolost <- pseudoyl(time = pbc3$days / 365.25,\n                       event = as.integer(pbc3$status),\n                       tmax = 3)\n\na1 <- cbind(pbc3,pseudo = pseudolost$pseudo[[1]],id=1:nrow(pbc3))\n\na2 <- cbind(pbc3,pseudo = pseudolost$pseudo[[2]],id=1:nrow(pbc3))\n\nsummary(fityl1 <- geese(pseudo ~ tment,\n                        data = a1, id = id, jack = TRUE, family = gaussian,\n                        corstr = \"independence\", scale.fix = FALSE))\n\n\n\nCall:\ngeese(formula = pseudo ~ tment, id = id, data = a1, family = gaussian, \n    scale.fix = FALSE, corstr = \"independence\", jack = TRUE)\n\nMean Model:\n Mean Link:                 identity \n Variance to Mean Relation: gaussian \n\n Coefficients:\n               estimate     san.se     ajs.se      wald            p\n(Intercept)  0.14304562 0.04121590 0.04127696 12.045356 0.0005192156\ntment       -0.05638594 0.05102947 0.05110332  1.220955 0.2691733775\n\nScale Model:\n Scale Link:                identity \n\n Estimated Scale Parameters:\n             estimate     san.se    ajs.se     wald            p\n(Intercept) 0.2260261 0.05100506 0.0515204 19.63771 9.360351e-06\n\nCorrelation Model:\n Correlation Structure:     independence \n\nReturned Error Value:    0 \nNumber of clusters:   349   Maximum cluster size: 1 \n\n\nCode show/hide\nsummary(fityl2 <- geese(pseudo ~ tment,\n                        data = a2, id = id, jack = TRUE, family = gaussian,\n                        corstr = \"independence\", scale.fix = FALSE))\n\n\n\nCall:\ngeese(formula = pseudo ~ tment, id = id, data = a2, family = gaussian, \n    scale.fix = FALSE, corstr = \"independence\", jack = TRUE)\n\nMean Model:\n Mean Link:                 identity \n Variance to Mean Relation: gaussian \n\n Coefficients:\n               estimate     san.se     ajs.se        wald            p\n(Intercept)  0.25153053 0.05315608 0.05323484 22.39110068 2.224022e-06\ntment       -0.01520994 0.07291925 0.07302390  0.04350814 8.347714e-01\n\nScale Model:\n Scale Link:                identity \n\n Estimated Scale Parameters:\n             estimate    san.se     ajs.se    wald            p\n(Intercept) 0.4634606 0.0697068 0.07040943 44.2054 2.956646e-11\n\nCorrelation Model:\n Correlation Structure:     independence \n\nReturned Error Value:    0 \nNumber of clusters:   349   Maximum cluster size: 1 \n\n\nCode show/hide\nsummary(fityl1 <- geese(pseudo ~ tment + alb + log2(bili),\n                        data = subset(a1,!is.na(alb)), id = id, jack = TRUE,\n                        family = gaussian,\n                        corstr = \"independence\", scale.fix = FALSE))\n\n\n\nCall:\ngeese(formula = pseudo ~ tment + alb + log2(bili), id = id, data = subset(a1, \n    !is.na(alb)), family = gaussian, scale.fix = FALSE, corstr = \"independence\", \n    jack = TRUE)\n\nMean Model:\n Mean Link:                 identity \n Variance to Mean Relation: gaussian \n\n Coefficients:\n                 estimate      san.se      ajs.se        wald            p\n(Intercept) -0.2925955874 0.214509773 0.219305817  1.86055015 0.1725613190\ntment       -0.0629704571 0.045824402 0.046173406  1.88833949 0.1693893294\nalb         -0.0007479074 0.004088095 0.004166756  0.03346984 0.8548390903\nlog2(bili)   0.1001512112 0.026281542 0.026811333 14.52147461 0.0001385709\n\nScale Model:\n Scale Link:                identity \n\n Estimated Scale Parameters:\n             estimate     san.se     ajs.se     wald            p\n(Intercept) 0.1877829 0.03991555 0.04086088 22.13236 2.544835e-06\n\nCorrelation Model:\n Correlation Structure:     independence \n\nReturned Error Value:    0 \nNumber of clusters:   343   Maximum cluster size: 1 \n\n\nCode show/hide\nsummary(fityl2 <- geese(pseudo ~ tment + alb + log2(bili),\n                        data = subset(a2,!is.na(alb)), id = id, jack = TRUE,\n                        family = gaussian,\n                        corstr = \"independence\", scale.fix = FALSE))\n\n\n\nCall:\ngeese(formula = pseudo ~ tment + alb + log2(bili), id = id, data = subset(a2, \n    !is.na(alb)), family = gaussian, scale.fix = FALSE, corstr = \"independence\", \n    jack = TRUE)\n\nMean Model:\n Mean Link:                 identity \n Variance to Mean Relation: gaussian \n\n Coefficients:\n               estimate      san.se      ajs.se     wald            p\n(Intercept)  0.46699730 0.323932111 0.328438874  2.07836 1.494006e-01\ntment       -0.08484277 0.068542273 0.069039590  1.53219 2.157840e-01\nalb         -0.02176434 0.006549422 0.006642189 11.04295 8.902503e-04\nlog2(bili)   0.14294187 0.032316673 0.032763783 19.56436 9.726692e-06\n\nScale Model:\n Scale Link:                identity \n\n Estimated Scale Parameters:\n             estimate     san.se     ajs.se     wald            p\n(Intercept) 0.3914462 0.05096053 0.05211022 59.00331 1.576517e-14\n\nCorrelation Model:\n Correlation Structure:     independence \n\nReturned Error Value:    0 \nNumber of clusters:   343   Maximum cluster size: 1 \n\n\n\n\nFigure 6.11\n\nleft\n\n\nCode show/hide\n# comp. end point t=2 smlg med IJ\nlibrary(pseudo)\nlibrary(survival)\npbc3$nystatus<-ifelse(pbc3$status > 0, 1, 0)\n\npseudo <- pseudosurv(time = pbc3$days,\n                     event = pbc3$nystatus,\n                     tmax=2 * 365.25)\nfit <- survfit(Surv(days, status > 0) ~ 1, data = pbc3)\n\nIJpseudo <- pseudo(fit, times = 2 * 365.25, addNA = TRUE, data.frame = TRUE, minus1 = TRUE)\n\npdata <- data.frame(IJpseudo = IJpseudo$pseudo,\n                    pseudo = pseudo$pseudo,\n                    diff = IJpseudo$pseudo - pseudo$pseudo)\n\nfig6.11left <- ggplot(aes(x = pseudo, y = IJpseudo), data = pdata) +\n  geom_point(size = 4, shape = 1) +\n  geom_line(size = 1) +\n  ylab(\"IJ pseudo-value\") +\n  xlab(\"Pseudo-value\") +\n  scale_x_continuous(limits = c(-0.2, 1),\n                     breaks = seq(-0.2, 1, by = 0.2)) +\n  scale_y_continuous(limits = c(-0.2, 1),\n                     breaks = seq(-0.2, 1, by = 0.2)) +\n  theme_general\n\nfig6.11left\n\n\n\n\n\n\n\nright\n\n\nleft\n\n\nCode show/hide\nfig6.11right <- ggplot(aes(x = pseudo, y = IJpseudo - pseudo), data = pdata) +\n  geom_point(size = 4, shape = 1) +\n  ylab(\"Difference\") +\n  xlab(\"Pseudo-value\") +\n  scale_x_continuous(limits = c(-0.2, 1),\n                     breaks = seq(-0.2, 1, by = 0.2)) +\n  scale_y_continuous(limits = c(-0.01, 0.01),\n                     breaks = seq(-0.01, 0.01, by = 0.005)) +\n  theme_general\n\nfig6.11right"
  },
  {
    "objectID": "Ch6.html#prova-trial-in-liver-cirrhosis",
    "href": "Ch6.html#prova-trial-in-liver-cirrhosis",
    "title": "6  Pseudo-values",
    "section": "PROVA trial in liver cirrhosis",
    "text": "PROVA trial in liver cirrhosis\n\nRead data\n\n\nCode show/hide\nprova <- data.frame(read.csv(\"data/prova.csv\", na.strings = c(\".\")))\n# Treatment 2x2 factorial\nprova$beh <- with(prova, as.factor(scle + beta*2))\nlibrary(tidyverse)\nprova <- prova %>% mutate(timebleed = ifelse(bleed == 1, timebleed, timedeath),\n                          outof0 = ifelse(bleed ==1, 1, death),\n                          wait = ifelse(bleed ==1, timedeath - timebleed, NA))\n\n# Faster processing\nrequire(data.table)\nprova <- setDT(prova)\n\n# Setting start times, s = 1 year and s = 2 years\ns1 = 365.25\ns2 = 2*365.25\n\n#Censoring times\ncens_outof0 <- 1509\ncens_wait <- 1363\n\n\n\n\nFigure 6.10\nTODO: get program to make data file datafig610.csv\n\n\nCode show/hide\nlibrary(mstate)\nlibrary(survival)\nlibrary(data.table) #Faster aggregation of data\n\n# Creating data frame\n# Converting data to long format\n# Transition matrix for irreversible illness-death model\ntmat <- trans.illdeath(names = c(\"Non-bleeding\", \"Bleeding\", \"Dead\"))\nlong_format_scle0 <- msprep(time = c(NA, \"timebleed\", \"timedeath\"), status = c(NA, \"bleed\", \"death\"), data = subset(as.data.frame(prova), scle ==0), trans = tmat, keep = \"scle\")\nlong_format_scle1 <- msprep(time = c(NA, \"timebleed\", \"timedeath\"), status = c(NA, \"bleed\", \"death\"), data = subset(as.data.frame(prova), scle ==1), trans = tmat, keep = \"scle\")\n\n# Estimation of transition probabilities with the Landmark Aalen-Johansen estimator\n# Warning is not related to the estimate of pstate2\nLMAaJ_scle0 <- LMAJ(long_format_scle0, s = s1, from = 1) #P(V(t) = 1 | V(1) = 0)\nLMAaJ_scle1 <- LMAJ(long_format_scle1, s = s1, from = 1) #P(V(t) = 1 | V(1) = 0)\n\nLMAJ_scle0_data <- as.data.frame(cbind(LMAaJ_scle0$time, LMAaJ_scle0$pstate2, \"No\"))\ncolnames(LMAJ_scle0_data) <- c(\"time\", \"p01\", \"Sclerotherapy\")\nLMAJ_scle1_data <- as.data.frame(cbind(LMAaJ_scle1$time, LMAaJ_scle1$pstate2, \"Yes\"))\ncolnames(LMAJ_scle1_data) <- c(\"time\", \"p01\", \"Sclerotherapy\")\n\nLMAJ_scle <- as.data.frame(rbind(LMAJ_scle0_data, LMAJ_scle1_data))\nLMAJ_scle <- read.csv(\"R/data/datafig610.csv\")\n\nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(legend.position = \"bottom\",\n        text = element_text(size = 20),\n        axis.text.x = element_text(size = 20),\n        axis.text.y = element_text(size = 20))\n\nfig6.10 <- ggplot(LMAJ_scle,aes(x = as.numeric(time)/365.25, y = as.numeric(p01), group = Sclerotherapy)) + \n  geom_step(size = 1) +\n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Probability\") + \n  theme_bw() +\n  scale_x_continuous(expand = expansion(),limits = c(0.94,4.2)) +  \n  aes(linetype=Sclerotherapy) + theme_general + \n  theme(legend.key.width = unit(1,\"cm\"),legend.text = element_text(size = 20)) \nfig6.10\n\n\n\n\n\n\n\nTable 6.7\nNo code available - results are from: Andersen, P. K., Wandall, E. N. S., Pohar Perme, M. (2022). Inference for transition probabilities in non-Markov multi-state models. Lifetime Data Analysis, 28:585–604."
  },
  {
    "objectID": "Ch6.html#exercises",
    "href": "Ch6.html#exercises",
    "title": "6  Pseudo-values",
    "section": "Exercises",
    "text": "Exercises\n\nExercise 6.1 (*)\nThe influence function for the survival function \\(S(t)\\) is \\[\\dot{\\phi}(X_i^*)=-S(t)\\int_0^t\\frac{dM_i(u)}{S(u)G(u)}\\] with \\(M_i(u)=N_i(u)-\\int_0^uY_i(s)dA(s)\\) being the martingale for the failure counting process for subject \\(i\\) (Overgaard et al. 2017). The corresponding `plug-in’ approximation is then \\[\\widehat{\\dot{\\phi}}(X_i^*)=-\\widehat{S}(t)\\left(\\frac{N_i(t)}{Y(t\\wedge X_i)/n}-\\int_0^{t\\wedge X_i}\\frac{dN(u)}{Y(u)^2/n}\\right).\\]\n\n1.\nShow that, writing the estimator in the `\\(\\exp(-\\mbox{Nelson-Aalen})\\)’ form \\(\\widehat{S}^w(t)=\\exp(-\\int_0^t(\\sum_iw_idN_i(u)/\\sum_iw_iY_i(u)))\\), this expression is obtained as \\[\\dot{\\widehat{\\phi}}(X_i^*)=\\frac{\\partial \\widehat{S}^w(t)}{\\partial w_i}\\vert_{\\mathbf{w}=1/n}.\\] The derivative \\(\\frac{\\partial \\widehat{S}^w(t)}{\\partial w_i}\\vert_{\\mathbf{w}=1/n}\\) is \\[-\\widehat{S}(t)\\int_0^t\\frac{(Y(u)/n)dN_i(u)-Y_i(u)dN(u)/n}{(Y(u)/n)^2}\\] \\[=-\\widehat{S}(t)(\\int_0^t\\frac{dN_i(u)}{Y(u)/n}-\\int_0^tY_i(u)\\frac{dN(u)}{Y(u)^2/n}),\\] which equals the desired expression.\n\n\n2.\nShow that for the standard Kaplan-Meier estimator \\[\\widehat{S}^w(t)=\\prod_{[0,t]}(1-\\sum_iw_idN_i(u)/\\sum_iw_iY(u))\\] it holds that \\[\\frac{\\partial \\widehat{S}^w(t)}{\\partial w_i}\\vert_{\\mathbf{w}=1/n}=\n-n\\widehat{S}(t)\\left(\\frac{N_i(t)}{Y(t\\wedge X_i)-dN(t\\wedge X_i)}-\\int_0^{t\\wedge X_i}\\frac{dN(u)}{Y(u)(Y(u)-dN(u))}\\right).\\]\nNote that the factor \\(n\\) is missing in the exercise text in the book.\nThe Kaplan-Meier estimator is a product, say \\(f(\\mathbf{w})=\\prod_jf_j(\\mathbf{w})\\), with a factor for each observation time \\(u=X_j\\) and with derivative \\[f^{\\prime}(\\mathbf{w})=\\sum_jf_j^{\\prime}(\\mathbf{w})\\prod_{k\\neq j}f_k(\\mathbf{w})=f(\\mathbf{w})\\sum_j\\frac{f_j^{\\prime}(\\mathbf{w})}{f_j(\\mathbf{w})}.\\] The \\(j\\)th factor is \\(f_j(\\mathbf{w})=1-\\frac{\\sum_iw_idN_i(u)}{\\sum_iw_iY(u)}\\) with \\(i\\)th derivative, when \\(\\mathbf{w}=1/n\\), \\[-\\frac{(Y(u)/n)dN_i(u)-(dN(u)/n)Y_i(u)}{(Y(u)/n)^2}\\] and, hence, \\[\\frac{f_j^{\\prime}(\\mathbf{w})}{f_j(\\mathbf{w})}=-\\frac{Y(u)dN_i(u)-dN(u)Y_i(u)}{(Y(u)-dN(u))Y(u)/n}.\\] Summing (integrating) over all observation times, the desired expression is obtained.\n\n\n3.\nShow that, in the case of no censoring, the influence function reduces to \\[\\dot{\\phi}(X_i^*)=I(T_i>t)-S(t).\\]\nUsing the infinitesimal jackknife approach on the complete data estimator \\(\\widehat{S}^w(t)={\\sum_iw_iI(T_i>t)}/{\\sum_iw_i}\\), the \\(i\\)th derivative is, when \\(\\mathbf{w}=1/n\\), \\[I(T_i>t)-\\sum_jI(T_j>t)/n=I(T_i>t)-\\widehat{S}(t).\\] Alternatively, evaluating the expression for \\(\\dot{\\phi}(X_i^*)\\) for uncensored data (\\(G(u)=1\\)), we get \\[-S(t)\\int_0^t(dN_i(u)-\\alpha(u)Y_i(u))/S(u)du=-S(t)(\\frac{N_i(t)}{S(t\\wedge T_i)}-\\int_0^tY_i(u)\\alpha(u)/S(u)du,\\] where the latter integral (using that the density \\(\\alpha(u)S(u)\\) is minus the derivative of \\(S(u)\\)) can be evaluated as \\(1-1/S(t\\wedge T_i)\\). All in all, we get \\(-S(t)\\) for \\(T_i\\leq t\\) and \\(1-S(t)\\) for \\(T_i>t\\), i.e., \\(I(T_i>t)-S(t)\\).\n\n\n\nExercise 6.2 (*)\n\n1.\nShow that, for the Aalen-Johansen estimator, the calculation \\[\\dot{\\widehat{\\phi}}(X_i^*)=\\frac{\\partial \\widehat{F}^w_h(t)}{\\partial w_i}\\vert_{\\mathbf{w}=1/n},\\] with \\(\\widehat{F}^w_h(t)\\) given by (6.11), leads to the pseudo-value approximation obtained by plugging-in estimators into (6.10).\nThe \\(i\\)th derivative of \\(\\widehat{F}^w_h(t)\\) when \\(\\mathbf{w}=1/n\\) is \\[\\int_0^t(-\\widehat{S}(u-)(\\sum_j\\int_0^u\\frac{(Y(s)/n)dN_{ji}(s)-(dN_j(s)/n)Y_i(s)}{(Y(s)/n)^2}d\\widehat{A}_h(u))\\] \\[+\\widehat{S}(u-)(\\frac{(Y(u)/n)dN_{hi}(u)-(dN_h(u)/n)Y_i(u)}{(Y(s)/n)^2})).\\] Using the relation \\(\\widehat{S}(u-)\\widehat{G}(u-)=Y(u)/n\\), the second line reduces to \\[\\int_0^t\\frac{dN_{hi}(u)}{\\widehat{G}(u-)}-\\int_0^tY_i(u)\\frac{d\\widehat{A}_h(u)}{\\widehat{G}(u-)}\\] which is the estimate for the first term in (6.10) because \\(M_{hi}(t)=N_{hi}(t)-\\int_0^tY_i(u)dA_h(u)\\). Using the same relation for the first line, this reduces to \\[-\\int_0^t\\widehat{S}(u-)\\left(\\int_0^u\\sum_h(\\frac{dN_{ji}(s)}{\\widehat{S}(s-)\\widehat{G}(s-)}-\nY_i(s)\\frac{dN_h(s)}{\\widehat{S}(s-)\\widehat{G}(s-)Y(s)})\\right)\\] which is the estimate of the second term in (6.10) because \\[M_{i}(t)=\\sum_j (N_{ji}(t)-\\int_0^tY_i(u)dA_j(u)).\\]\n\n\n2.\nShow that, in the case of no censoring, the influence function reduces to \\[\\dot{\\phi}(X_i^*)=I(T_i\\leq t, D=h)-F_h(t).\\]\nLooking at Equation (6.6), the result follows directly because \\(G(u)=1\\) and \\(M_{0i}(t)=0\\). Using, as an alternative, the infinitesimal jackknife approach on the complete data estimator \\(\\widehat{F}_h^w(t)={\\sum_iw_iI(T_i\\leq t, D_i=h)}/{\\sum_iw_i}\\), the \\(i\\)th derivative is, when \\(\\mathbf{w}=1/n\\), \\[I(T_i\\leq t, D_i=h)-\\sum_jI(T_j\\leq t, D_j=h)/n=I(T_i\\leq t, D_i=h)-\\widehat{F}_h(t).\\]"
  },
  {
    "objectID": "Ch7.html#guinea-bissau-childhood-vaccination-study",
    "href": "Ch7.html#guinea-bissau-childhood-vaccination-study",
    "title": "7  Further topics",
    "section": "Guinea-Bissau childhood vaccination study",
    "text": "Guinea-Bissau childhood vaccination study\n\nRead data\n\nRSAS\n\n\n\n\nCode show/hide\nbissau <- data.frame(read.csv(\"data/bissau.csv\"))\nbissau$agem <- as.integer(bissau$age/30.44)\n\n\n\n\n\n\nCode show/hide\nproc import \ndatafile=\"data/bissau.csv\"\n    out=bissau\n    dbms = csv\n    replace;\nrun;\ndata bissau; \n    set bissau; \n    agem = int(age/30.44);\nrun; \n\n\n\n\n\n\n\nTable 8.1\n\nRSAS\n\n\n\n\nCode show/hide\n# Cox model - full cohort\nlibrary(survival)\noptions(contrasts=c(\"contr.treatment\", \"contr.poly\"))\ncoxph(Surv(fuptime, dead != 0) ~ factor(bcg) + factor(agem), data = bissau)\n\n\nCall:\ncoxph(formula = Surv(fuptime, dead != 0) ~ factor(bcg) + factor(agem), \n    data = bissau)\n\n                  coef exp(coef) se(coef)      z      p\nfactor(bcg)1  -0.34678   0.70696  0.14604 -2.374 0.0176\nfactor(agem)1  0.11490   1.12176  0.23205  0.495 0.6205\nfactor(agem)2 -0.25702   0.77335  0.25861 -0.994 0.3203\nfactor(agem)3  0.19875   1.21987  0.24325  0.817 0.4139\nfactor(agem)4  0.34748   1.41550  0.23912  1.453 0.1462\nfactor(agem)5  0.31171   1.36576  0.25325  1.231 0.2184\nfactor(agem)6 -0.01077   0.98929  0.35339 -0.030 0.9757\n\nLikelihood ratio test=12.39  on 7 df, p=0.08834\nn= 5274, number of events= 222 \n\n\nCode show/hide\n# 12.5 pct sub-cohort\nbissau$s <- rbinom(nrow(bissau), 1, prob = 0.125)\nwith(bissau, table(dead, s))\n\n\n    s\ndead    0    1\n   0 4420  632\n   1  195   27\n\n\nCode show/hide\n# Case-cohort data\nbis2 <- subset(bissau, s == 0 & dead != 0 | s == 1)\nccfit <- cch(Surv(fuptime, dead!= 0) ~ factor(bcg) + factor(agem), \n             data = bis2, \n             subcoh=bis2$s, id=bis2$id, cohort.size=nrow(bissau))\nsummary(ccfit)\n\n\nCase-cohort analysis,x$method, Prentice \n with subcohort of 659 from cohort of 5274 \n\nCall: cch(formula = Surv(fuptime, dead != 0) ~ factor(bcg) + factor(agem), \n    data = bis2, subcoh = bis2$s, id = bis2$id, cohort.size = nrow(bissau))\n\nCoefficients:\n                Coef    HR  (95%   CI)     p\nfactor(bcg)1  -0.459 0.632 0.453 0.881 0.007\nfactor(agem)1  0.042 1.043 0.622 1.752 0.872\nfactor(agem)2 -0.141 0.868 0.492 1.534 0.627\nfactor(agem)3  0.249 1.283 0.743 2.217 0.372\nfactor(agem)4  0.549 1.731 0.999 2.999 0.050\nfactor(agem)5  0.459 1.583 0.889 2.819 0.119\nfactor(agem)6  0.159 1.172 0.536 2.563 0.690\n\n\nCode show/hide\n# Nested-case control\nlibrary(multipleNCC)\nlibrary(Epi)\n\n# Add noise to remove ties\n\nbis2$fuptime_noise <- jitter(bis2$fuptime, factor=1, amount = NULL)\n\nnccdata <- Epi::ccwc(exit=fuptime_noise, \n                     fail=dead!=0, \n                     data=bis2, \n                     include=list(bcg, agem), controls=3, silent=TRUE)\nsummary(clogit(Fail ~ factor(bcg) + factor(agem), data=nccdata))\n\n\nCall:\ncoxph(formula = Surv(rep(1, 888L), Fail) ~ factor(bcg) + factor(agem), \n    data = nccdata, method = \"exact\")\n\n  n= 888, number of events= 222 \n\n                  coef exp(coef) se(coef)      z Pr(>|z|)   \nfactor(bcg)1  -0.46553   0.62780  0.17947 -2.594  0.00949 **\nfactor(agem)1  0.10845   1.11455  0.26846  0.404  0.68623   \nfactor(agem)2 -0.08984   0.91407  0.29587 -0.304  0.76138   \nfactor(agem)3  0.41139   1.50891  0.28798  1.429  0.15313   \nfactor(agem)4  0.53956   1.71526  0.29036  1.858  0.06314 . \nfactor(agem)5  0.55564   1.74305  0.30871  1.800  0.07188 . \nfactor(agem)6  0.11164   1.11811  0.40294  0.277  0.78174   \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n              exp(coef) exp(-coef) lower .95 upper .95\nfactor(bcg)1     0.6278     1.5929    0.4416    0.8925\nfactor(agem)1    1.1146     0.8972    0.6585    1.8863\nfactor(agem)2    0.9141     1.0940    0.5118    1.6324\nfactor(agem)3    1.5089     0.6627    0.8581    2.6533\nfactor(agem)4    1.7153     0.5830    0.9709    3.0303\nfactor(agem)5    1.7431     0.5737    0.9518    3.1922\nfactor(agem)6    1.1181     0.8944    0.5076    2.4630\n\nConcordance= 0.578  (se = 0.021 )\nLikelihood ratio test= 12.2  on 7 df,   p=0.09\nWald test            = 11.85  on 7 df,   p=0.1\nScore (logrank) test = 12.04  on 7 df,   p=0.1\n\n\n\n\n\n\nCode show/hide\n/* 1.: Fit Cox model */\nproc phreg data=bissau;\n  class bcg agem;\n  model fuptime*dead(0)=bcg agem / rl;\nrun;\n\n/* 2.: Create a 12.5 pct sub-cohort */\n\ndata bissau; \n    set bissau;\n    seed=260452;\n    s=ranbin(seed,1,0.125);\nrun;\nproc freq; \n    tables s*dead; \nrun;\n\n/* 3.: Fit Cox model to case-cohort data */\ndata casecoho; set bissau;\n    epsilon=0.001;\n    if dead=1 and s=0 then do;\n    d=1; start=fuptime-epsilon; stop=fuptime; w=1; output; end;\n    if dead=0 and s=1 then do;\n    d=0; start=0; stop=fuptime; w=1/0.125; output; end;\n    if dead=1 and s=1 then do;\n    d=0; start=0; stop=fuptime-epsilon; w=1/0.125; output;\n    d=1; start=fuptime-epsilon; stop=fuptime; w=1; output; end;\nrun;\n\nproc phreg data=casecoho covsandwich(aggregate);\n    class bcg agem;\n    model stop*d(0)=bcg agem/rl entry=start;\n    weight w; id id;\nrun;\n\n/* NCC MACRO */\n\ndata source; set bissau;\n    study_id=id;\n    age_entry=0;\n    age_dlo=fuptime;\n    censor=dead;\nrun;\n\n%macro caseset;\n    %let sampling = 1;\n    %let ratio = 3;\n    /* Enumerate Cases */\n    data cases;\n    set source ;\n    if censor = 1;\n    run;\n    data cases;\n    set cases end = eof;\n    if eof then call symput ('ncases', put(_n_,6.));\n    run;\n    /* Create Risk Set */\n    %do iter = 1 %to &ncases;\n    data temp_case;\n    set cases;\n\n    if _n_ = &iter ;\n    call symput ('rs', put(_n_,6.));\n    call symput ('age_rs', put(age_dlo,8.)); call symput ('case_id',\n    put(study_id,8.));\n    run;\n    data temp_control;\n    set source;\n    if age_entry  <= &age_rs  <= age_dlo;\n    /* Exclude Index Case */\n    if study_id = &case_id then delete;\n    number = ranuni(0);\n    age_rs = &age_rs;\n    censor = 0;\n    run;\n    /* Sample Controls */\n    %if &sampling = 1 %then %do;\n    proc sort data = temp_control;\n    by number;\n    data temp_control;\n    set temp_control;\n    by age_rs;\n    retain m;\n    if first.age_rs then m = 0;\n    m=m+1;\n    if m <= &ratio then output temp_control;\n    run;\n    %end; \n    /* End If Sampling = 1 */\n    /* Combine Case with Controls */\n    data rs_&iter;\n    set temp_case\n    temp_control;\n    rs = &rs;\n    age_rs = &age_rs;\n    run;\n    /* DM Output 'Clear'; Log 'Clear'; */\n\n    %end; \n    /* End Loop Creating Risk Set */\n    /* Append Risk Sets */\n    %do j = 2 %to &ncases;\n    proc append base = rs_1 data = rs_&j;\n    run;\n    %end;\n    data final; set rs_1; run;\n%mend ; \n/* End Macro */\n\n/* Invoke Macro */\n%caseset;\n\nproc phreg data=final;\nclass bcg agem;\n  model fuptime*censor(0)=bcg agem / rl;\n  strata rs;\nrun;"
  },
  {
    "objectID": "errata.html#chapter-2",
    "href": "errata.html#chapter-2",
    "title": "Errata",
    "section": "Chapter 2",
    "text": "Chapter 2\n\nP. 45: The in-text Poisson model estimates for baseline hazards should be \\(\\widehat{\\alpha}_1 = 0.090\\) \\((0.064, 0.127)\\), \\(\\widehat{\\alpha}_2 = 0.132\\) \\((0.089, 0.194)\\), \\(\\widehat{\\alpha}_3 = 0.092\\) \\((0.034, 0.251)\\). See also code and output."
  },
  {
    "objectID": "errata.html#chapter-3",
    "href": "errata.html#chapter-3",
    "title": "Errata",
    "section": "Chapter 3",
    "text": "Chapter 3\n\nSection 3.3, p. 78: A right bracket was missing before \\(dt\\) in \\[\\sum_i\\left(\\int_0^{\\infty}\\log\\bigl(Y_i(t)\\alpha_0(t)\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)\\bigr)dN_i(t)-\\int_0^{\\infty}Y_i(t)\\alpha_0(t)\\exp(\\mathbf{\\beta}^{\\sf T}\\mathbf{Z}_i)dt\\right)\\]\nExercise 3.12, p. 119: Replace Table 2.12 by Table 3.2"
  },
  {
    "objectID": "errata.html#chapter-5",
    "href": "errata.html#chapter-5",
    "title": "Errata",
    "section": "Chapter 5",
    "text": "Chapter 5\n\nSection 5.1.3, p. 172: The equation for \\(\\frac{\\partial}{\\partial t}P_{01}(s,t)\\) should read \\[\\frac{\\partial}{\\partial t}P_{01}(s,t)=P_{00}(s,t)\\alpha_{01}(t)-P_{01}(s,t)\\alpha_{12}(t)\\]"
  },
  {
    "objectID": "errata.html#chapter-6",
    "href": "errata.html#chapter-6",
    "title": "Errata",
    "section": "Chapter 6",
    "text": "Chapter 6\n\nExercise 6.1.2, p. 249: A right bracket is missing after \\(dN(u)\\) in the second denominator\nExercise 6.1.2, p. 249: a factor \\(n\\) is missing on the r.h.s. of the equation for \\(\\frac{\\partial \\widehat{S}^w(t)}{\\partial w_i}\\vert_{\\mathbf{w}=1/n}\\)\nExercise 6.5, p. 250: It makes no sense to compare with Exercise 5.8"
  }
]