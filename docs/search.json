[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Models for Multi-State Survival Data",
    "section": "",
    "text": "This is the code companion website to our book published by Chapman & Hall.\nR code with output for analyses and plots presented in the book is provided. Corresponding code in SAS with no output is given. When using bootstrap small deviations from the book will occur as no fixed seeds have been used.\nPlease note, that code often depends on previous code in the same chapter.\nSolution to the exercises is available at the end of each chapter using R for the practicals.\nThis code and output was created using R version 4.3.1 and SAS/Stat version 15.1."
  },
  {
    "objectID": "index.html#acknowledgements",
    "href": "index.html#acknowledgements",
    "title": "Models for Multi-State Survival Data",
    "section": "Acknowledgements",
    "text": "Acknowledgements\nThanks to Julie K. Furberg who created figures and validated analyses quoted in the book. Thanks to Eva N.S. Wandall who created solutions to practical exercises and contributed to some of the examples."
  },
  {
    "objectID": "Ch2.html#pbc3-trial",
    "href": "Ch2.html#pbc3-trial",
    "title": "1  Intuition for intensity models",
    "section": "PBC3 trial",
    "text": "PBC3 trial\n\nRead data\n\nRSAS\n\n\n\n\nCode hide/show\npbc3 <- data.frame(read.csv(\"data/pbc3.csv\"))\npbc3$fail <- ifelse(pbc3$status != 0, 1, 0) # event/failure indicator\npbc3$tment_char <- ifelse(pbc3$tment == 0, \"Placebo\", \"CyA\")\n\n# Add transformations of covariates \npbc3$albnorm <- with(pbc3, (alb-35)*(alb>35))\npbc3$alb10 <- with(pbc3, alb/10)\npbc3$alb2 <- with(pbc3, alb10*alb10)\n\npbc3$bilihigh <- with(pbc3, (bili-17.1)*(bili>17.1))\npbc3$bilitoohigh <- with(pbc3, (bili-34.2)*(bili>34.2))\npbc3$bilimuchtoohigh <- with(pbc3, (bili-51.3)*(bili>51.3))\npbc3$bili100 <- with(pbc3, bili/100)\npbc3$bili2 <- with(pbc3, bili100*bili100)\n\npbc3$log2bili <- with(pbc3, log2(bili))\npbc3$log2bili2 <- with(pbc3, log2bili*log2bili)\n\npbc3$logbilihigh <- with(pbc3, (log2bili-log2(17.1))*(bili>17.1))\npbc3$logbilitoohigh <- with(pbc3, (log2bili-log2(34.2))*(bili>34.2))\npbc3$logbilimuchtoohigh <- with(pbc3, (log2bili-log2(51.3))*(bili>51.3))\n\n\n\n\n\n\nCode hide/show\nproc import out=pbc3\n    datafile=\"data/pbc3.csv\"\n    dbms=csv replace;\nrun;\n    \ndata pbc3; \n    set pbc3;\n    albnorm=(alb-35)*(alb>35);\n    alb10=alb/10;\n    alb2=alb*alb;\n    bilihigh=(bili-17.1)*(bili>17.1);\n    bilitoohigh=(bili-34.2)*(bili>34.2);\n    bilimuchtoohigh=(bili-51.3)*(bili>51.3);\n    bili100=bili/100;\n    bili2=bili*bili;\n    log2bili=log2(bili);\n    logbilihigh=(log2bili-log2(17.1))*(bili>17.1);\n    logbilitoohigh=(log2bili-log2(34.2))*(bili>34.2);\n    logbilimuchtoohigh=(log2bili-log2(51.3))*(bili>51.3);\n    log2bili2=log2bili*log2bili;\nrun;\n\n\n\n\n\n\n\nFigure 2.1\n\nRSAS\n\n\n\n\nCode hide/show\n# General plotting style \nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20),\n        legend.position = \"bottom\", \n        legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        legend.key.size = unit(2,\"line\"))\n\n# Nelson Aalen estimate by treatment\nlibrary(survival)\nnafit <- survfit(Surv(days, status != 0) ~ tment, data = pbc3)\n# Collect data for plot\nnadata <- data.frame(cumhaz = nafit$cumhaz, time = nafit$time, \n                     tment = c(rep(names(nafit$strata)[1], nafit$strata[1]), \n                               rep(names(nafit$strata)[2], nafit$strata[2])))\n\n# Create Figure 2.1\nlibrary(ggplot2)\nfig2.1 <- ggplot(aes(x = time / 365.25, y = cumhaz, linetype = tment),\n                 data = nadata) + \n  geom_step(size = 1) + \n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\", \"CyA\")) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6), breaks = seq(0, 6, 1))  + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general \n\nfig2.1\n\n\n\n\n\n\n\n\n\nCode hide/show\nproc phreg data=pbc3; \n    model days*status(0)=;\n    strata tment;\n    baseline out=hazdat cumhaz=naa stdcumhaz=sdnaa;\nrun;\ndata hazdat; \n    set hazdat; \n    daysyears = days/365.25; \nrun; \nproc gplot data=hazdat;\n    plot naa*daysyears=tment/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none\n    label=('Years');\n    axis2 order=0 to 0.7 by 0.1 minor=none\n    label=(a=90 'Cumulative hazard');\n    symbol1  v=none i=stepjl c=red;\n    symbol2  v=none i=stepjl c=blue;\nrun;\n\n\n\n\n\n\n\nIn-text: Nelson-Aalen estimates at 2 years\n\nRSAS\n\n\n\n\nCode hide/show\ntail(subset(nadata, nadata$time <= 2*365.25 & nadata$tment == \"tment=0\"),1)\n\n\n     cumhaz time   tment\n60 0.183065  724 tment=0\n\n\nCode hide/show\ntail(subset(nadata, nadata$time <= 2*365.25 & nadata$tment == \"tment=1\"),1)\n\n\n       cumhaz time   tment\n209 0.1668539  725 tment=1\n\n\n\n\n\n\nCode hide/show\nproc print data=hazdat;\n    where 1.5<daysyears<=2; \nrun;\n\n\n\n\n\n\n\nTable 2.1\n\nRSAS\n\n\n\n\nCode hide/show\n# Data for Table 2.1\ncuts <- c(0, 2, 4) * 365.25\n# Make the data ready using survSplit from survival package\nlibrary(survival)\npbc3mult <- as.data.frame(survSplit(Surv(days, fail) ~ ., pbc3,\n                      cut = cuts[-1], \n                      episode = \"timegroup\"))\npbc3mult$risktime <- pbc3mult$days - cuts[pbc3mult$timegroup] \npbc3mult$timegroup <- as.factor(pbc3mult$timegroup)\n\nlibrary(dplyr)\npcwdata <- pbc3mult %>% \n  group_by(tment, timegroup) %>% \n  summarise(fail = sum(fail), risktime = sum(days - cuts[timegroup]))\npcwdata$risktimeyrs <- pcwdata$risktime/365.25\npcwdata$hazard <- 36525*pcwdata$fail/pcwdata$risktime\npcwdata$SD <- 36525*sqrt(pcwdata$fail)/pcwdata$risktime\ndata.frame(pcwdata)\n\n\n  tment timegroup fail risktime risktimeyrs    hazard       SD\n1     0         1   27 104856.0   287.08008  9.405041 1.810001\n2     0         2   17  49673.0   135.99726 12.500252 3.031756\n3     0         3    2   8642.0    23.66051  8.452904 5.977106\n4     1         1   24 107931.5   295.50034  8.121818 1.657859\n5     1         2   18  50284.5   137.67146 13.074605 3.081714\n6     1         3    2   7599.0    20.80493  9.613107 6.797493\n\n\n\n\n\n\nCode hide/show\n/* prepare for poisson model */\ndata pbc3mult; \n    set pbc3;\n    fail=(days<=2 * 365.25)*(status ne 0);\n    risktime=min(2 * 365.25, days);\n    logrisk=log(risktime); interv=1; output;  \n    if days>2 * 365.25 then do;\n    fail=(days<=4 * 365.25)*(status ne 0);\n    risktime=min(2 * 365.25 ,days-2 * 365.25);\n    logrisk=log(risktime); interv=2; output; end;\n    if days>4 * 365.25  then do;\n    fail=status ne 0; \n    risktime=days-4 * 365.25;\n    logrisk=log(risktime); interv=3; output; end;\nrun;\nproc means sum  data=pbc3mult;\n    class tment interv;\n    var fail risktime;\nrun;\n\nproc genmod data=pbc3mult;\n    where tment=1;\n    class interv;\n    model fail=interv/dist=poi offset=logrisk;\n    estimate '0-2 years' intercept 1  interv 1 0 0/exp;\n    estimate '2-4 years' intercept 1  interv 0 1 0/exp;\n    estimate '4-6 years' intercept 1  interv 0 0 1/exp;\nrun;\nproc genmod data=pbc3mult;\n    where tment=0;\n    class interv;\n    model fail=interv/dist=poi offset=logrisk;\n    estimate '0-2 years' intercept 1  interv 1 0 0/exp;\n    estimate '2-4 years' intercept 1  interv 0 1 0/exp;\n    estimate '4-6 years' intercept 1  interv 0 0 1/exp;\nrun;\n\n\n\n\n\n\n\nFigure 2.2\n\n\nCode hide/show\n# Rates + cuts from Table 2.1\nrateCyA <- c(8.1,13.1,9.6)\nratePbo <- c(9.4,12.5,8.5)\npcwtime <- c(0,2,4,5)\n# Collect data\nplotdata <- data.frame(rates = c(rateCyA, ratePbo),\n                       tment = c(rep(\"CyA\", length(rateCyA)), \n                                 rep(\"Placebo\", length(ratePbo))),\n                       times_s = rep(pcwtime[-4], 2),\n                       times = rep(pcwtime[-1], 2))\n\n# Create Figure 2.2\nfig2.2 <- ggplot(aes(x = time, y = rates, linetype = tment), data = plotdata) +\n  geom_segment(aes(x = times_s, y = rates, xend = times, yend = rates),size=1) +\n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\", \"CyA\"))  +\n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Estimated hazard function (per 100 years)\") +\n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 5),\n                     breaks = seq(0, 5, 1))  +\n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     limits = c(0,14), breaks = seq(0, 14, 2)) +\n  theme_general\n\nfig2.2\n\n\n\n\n\n\n\nIn-text: LRT test piece-wise exponential model\n\nSAS\n\n\n\n\nCode hide/show\nods output modelfit=full;\nproc genmod data=pbc3mult;\n    class interv tment;\n    model fail=interv|tment /dist=poi offset=logrisk;\nrun;\ndata full;\n  set full;\n     where Criterion=\"Deviance\";\n     full_like=value;\n     full_df=df;\n     keep full_like full_df;\nrun;\nproc print;run;\nods output modelfit=reduced;\nproc genmod data=pbc3mult;\n    class interv tment;\n    model fail=interv /dist=poi offset=logrisk;\nrun;\ndata reduced;\n  set reduced;\n     where Criterion=\"Deviance\";\n     reduced_like=value;\n     reduced_df=df;\n     keep reduced_like reduced_df;\nrun;\ndata lrt_pval;\n merge full reduced;\n  lrt = reduced_like - full_like;\n    df  = reduced_df - full_df;\n  p_value = 1 - probchi(lrt,df);\nrun;\nproc print data=lrt_pval;\n  title \"LR test statistic and p-value\";\nrun;\n\n\n\n\n\n\n\nIn-text: Logrank test and p-value\n\nRSAS\n\n\n\n\nCode hide/show\nlibrary(survival)\nlr<-survdiff(Surv(days, status != 0) ~ tment, data = pbc3)\nc(lr$chisq,lr$pvalue)\n\n\n[1] 0.07708002 0.78129419\n\n\n\n\n\n\nCode hide/show\nproc lifetest data=pbc3 notable; \n    time days*status(0);\n    strata tment;\nrun;\n\n\n\n\n\n\n\nFigure 2.3\n\nRSAS\n\n\n\n\nCode hide/show\n# NA data from figure 2.1 model fit\ntment1 <- subset(nadata, tment == \"tment=1\")\n# Estimated hazard per time group\npcwdata$hazard_timegroup <- pcwdata$fail / pcwdata$risktime\n# Add a numeric version of the treatment to the NA estimates\nnadata$tmentnum <- ifelse(nadata$tment == \"tment=1\", 1, 0)\n# Add piecewise constant hazard to data\nnadata$pwch <- NULL\n# Between time 0 and 2\nnadata$pwch[nadata$time <= 2 * 365.25] <- nadata$time[nadata$time <= 2 * 365.25] *\n  (pcwdata$hazard_timegroup[1] * (1-nadata$tmentnum[nadata$time <= 2 * 365.25]) +\n     pcwdata$hazard_timegroup[4] * (nadata$tmentnum[nadata$time <= 2 * 365.25]))\n# Between time 2 and 4\nnadata$pwch[nadata$time > 2 * 365.25 & nadata$time <= 4* 365.25 ] <- 2 * 365.25 * \n  (pcwdata$hazard_timegroup[1] * (1-nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25]) + \n     pcwdata$hazard_timegroup[4] * (nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25])) + \n  (nadata$time[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25] - 2 * 365.25) * \n  (pcwdata$hazard_timegroup[2] * (1-nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25]) + \n     pcwdata$hazard_timegroup[5] * (nadata$tmentnum[nadata$time > 2 * 365.25 & nadata$time <= 4 * 365.25]))\n# After time 4\nnadata$pwch[nadata$time > 4 * 365.25] <- 2 * 365.25 * \n  (pcwdata$hazard_timegroup[1] * (1-nadata$tmentnum[nadata$time > 4 * 365.25]) + \n     pcwdata$hazard_timegroup[4] * (nadata$tmentnum[nadata$time > 4 * 365.25])) + \n   2 * 365.25 * \n  (pcwdata$hazard_timegroup[2] * (1-nadata$tmentnum[nadata$time > 4 * 365.25]) + \n     pcwdata$hazard_timegroup[5] * (nadata$tmentnum[nadata$time > 4 * 365.25])) + \n  (nadata$time[nadata$time > 4 * 365.25] - 4 * 365.25) * \n  (pcwdata$hazard_timegroup[3] * (1-nadata$tmentnum[nadata$time > 4 * 365.25]) + \n     pcwdata$hazard_timegroup[6] * (nadata$tmentnum[nadata$time > 4 * 365.25]))\n# Reformat for plot\npiecepdata <- data.frame(cumhaz = c(nadata$cumhaz, nadata$pwch), \n                         time = rep(nadata$time, 2),\n                         tmentnum = rep(nadata$tmentnum, 2),\n                         type = c(rep(\"Nelson-Aalen\", length(nadata$time)), \n                                  rep(\"Piece-wise exponential\", length(nadata$time))))\n# Only for treatment 1\npiecepdata1 <- subset(piecepdata, tmentnum == 1)\n\n# Create Figure 2.3\nfig2.3 <- ggplot(aes(x = time / 365.25, y = cumhaz, linetype = type), \n                data = subset(piecepdata1, type == \"Nelson-Aalen\")) + \n  geom_step(size = 1) + \n  geom_line(aes(x = time / 365.25, y = cumhaz, linetype = type), size = 1,\n            data = subset(piecepdata1, type == \"Piece-wise exponential\")) + \n  labs(linetype = \"Type\") + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1))  + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general+\n  theme(legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        legend.key.size = unit(2,\"line\"))\n\nfig2.3\n\n\n\n\n\n\n\n\n\nCode hide/show\ndata hazdat; \n    set hazdat;\n    if days<=2 * 365.25 then \n        pwch=days*(27.0000000/104856*(1-tment)+24.0000000/107931.5*tment);\n\n    if 2 * 365.25 <days<=4 * 365.25 then\n        pwch=2* 365.25*(27.0000000/104856*(1-tment)+24.0000000/107931.5*tment)\n        +(days-2* 365.25)*(17.0000000/49673*(1-tment)+18.0000000/50284*tment);\n\n    if 4 * 365.25 <days then\n        pwch=2* 365.25 *(27.0000000/104856*(1-tment)+24.0000000/107931.5*tment)\n        +(2* 365.25)*(17.0000000/49673*(1-tment)+18.0000000/50284*tment)\n        +(days-4* 365.25)*(2.0000000/8642*(1-tment)+2.0000000/7599*tment);\n    daysyears = days/365.25; \nrun; \n\nproc gplot data=hazdat; where tment=1;\n    plot (naa pwch)*daysyears/overlay haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 0.7 by 0.1 minor=none\n      label=(a=90 'Cumulative hazard');\n    symbol1  v=none i=stepjl r=1 c=red;\n    symbol2 v=none i=join r=1 c=blue;\nrun;\n\n\n\n\n\n\n\nIn-text: Cox model with treatment only\n\nRSAS\n\n\n\n\nCode hide/show\n# Fit a Cox model using the pbc3 data with treatment as a covariate\nlibrary(survival)\ncoxfit <- coxph(Surv(days, status != 0) ~ tment, data = pbc3, method = \"breslow\")\ncoxfit\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment, data = pbc3, \n    method = \"breslow\")\n\n          coef exp(coef) se(coef)      z     p\ntment -0.05854   0.94314  0.21092 -0.278 0.781\n\nLikelihood ratio test=0.08  on 1 df, p=0.7813\nn= 349, number of events= 90 \n\n\n\n\n\n\nCode hide/show\nproc phreg data=pbc3;\n    model days*status(0)=tment/rl;\nrun;\n\n\n\n\n\n\n\nFigure 2.5\n\nRSAS\n\n\n\n\nCode hide/show\n# Extract cumulative baseline hazard\ncoxcumhaz <- basehaz(coxfit, centered = FALSE)\n# Collect data for plot (Breslow estimate)\ncoxdata <- data.frame(cumhaz = coxcumhaz$hazard, \n                      time = coxcumhaz$time, \n                      tment = rep(\"0\", nrow(coxcumhaz)), \n                      type = rep(\"Breslow estimate\", nrow(coxcumhaz)))\n\nfig2.5 <- ggplot(aes(x = time / 365.25, y = cumhaz, linetype = tment),\n                 data = coxdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") + \n  ylab(\"Cumulative baseline hazard\") + \n  scale_linetype_discrete(\"Treatment\", labels = c(\"Placebo\")) + \n  scale_x_continuous(expand = expansion(mult = c(0.001, 0.05)),\n                     limits = c(0, 6),\n                     breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general+theme(legend.position = \"none\")\n\nfig2.5\n\n\n\n\n\n\n\n\n\nCode hide/show\ndata cov;\n    tment=0;\nrun;\nproc phreg data=pbc3;\n    model days*status(0)=tment/rl;\n    baseline out=breslow cumhaz=breslow covariates=cov;\nrun;\ndata breslow; \n    set breslow; \n    daysyears = days/365.25; \nrun; \nproc gplot data=breslow;\n    plot breslow*daysyears=tment/haxis=axis1 vaxis=axis2;\n    axis1 order=0 to 6 by 1 minor=none label=('Years');\n    axis2 order=0 to 0.7 by 0.1 minor=none label=(a=90 'Cumulative baseline hazard');\n    symbol1  v=none i=stepjl c=blue;\nrun;\n\n\n\n\n\n\n\nTable 2.3\n\nRSAS\n\n\n\n\nCode hide/show\n# Average covariate values of albumin and bilirubin per treatment \nlibrary(dplyr)\ntabledata <- pbc3 %>% \n  group_by(tment, tment_char) %>% \n  summarise(n = sum(id != 0),  \n            average_albumin = mean(alb, na.rm = TRUE), \n            # NOTE: Removes missing observations from mean computation\n            average_bilirubin = mean(bili, na.rm = TRUE), \n            )\ndata.frame(tabledata)\n\n\n  tment tment_char   n average_albumin average_bilirubin\n1     0    Placebo 173        39.26101          42.33674\n2     1        CyA 176        37.50731          48.55540\n\n\n\n\n\n\nCode hide/show\nproc means data=pbc3 mean;\n  class tment;\n    var alb bili;\nrun;\n\n\n\n\n\n\n\nTable 2.4\n\nRSAS\n\n\n\n\nCode hide/show\n# Cox model with treatment, albumin and bilirubin as covariates \nlibrary(survival)\ncoxfit <- coxph(Surv(days, status != 0) ~ tment + alb + bili,\n                data = pbc3)\ncoxfit\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili, \n    data = pbc3)\n\n            coef  exp(coef)   se(coef)      z        p\ntment -0.4965639  0.6086184  0.2256162 -2.201   0.0277\nalb   -0.1156596  0.8907784  0.0212810 -5.435 5.48e-08\nbili   0.0089494  1.0089895  0.0009801  9.131  < 2e-16\n\nLikelihood ratio test=99.06  on 3 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\n\n\n\n\nCode hide/show\nproc phreg data=pbc3;\n    model days*status(0)=tment alb bili / rl;\nrun;\n\n\n\n\n\n\n\nIn-text: Poisson model with treatment only (and time)\n\nRSAS\n\n\n\n\nCode hide/show\nlibrary(stats)\nlibrary(broom) # For using tidy() function to get exp(beta)\npoism <- glm(fail ~ tment + timegroup-1 +\n               offset(log(risktime/365.25)), data = pbc3mult,family = poisson)\ntidy(poism, exponentiate = T, conf.int = T)\n\n\n# A tibble: 4 × 7\n  term       estimate std.error statistic  p.value conf.low conf.high\n  <chr>         <dbl>     <dbl>     <dbl>    <dbl>    <dbl>     <dbl>\n1 tment        0.942      0.211    -0.284 7.76e- 1   0.622      1.43 \n2 timegroup1   0.0902     0.174   -13.8   2.51e-43   0.0631     0.125\n3 timegroup2   0.132      0.198   -10.2   1.29e-24   0.0876     0.191\n4 timegroup3   0.0925     0.509    -4.68  2.91e- 6   0.0283     0.220\n\n\n\n\n\n\nCode hide/show\nproc genmod data=pbc3mult;\n    class interv tment;\n    model fail = interv tment / dist=poi offset=logrisk;\n    estimate 'CyA  vs placebo' tment -1 1 / exp;\nrun;\n\n\n\n\n\n\n\nTable 2.5\n\nRSAS\n\n\n\n\nCode hide/show\n# Poisson model with treatment, albumin and bilirubin as covariates\npoismod_t25 <- glm(fail ~ tment + alb + bili+ timegroup-1 +\n                     offset(log(risktime/365.25)),data=pbc3mult,family=poisson)\ntidy(poismod_t25)\n\n\n# A tibble: 6 × 5\n  term       estimate std.error statistic  p.value\n  <chr>         <dbl>     <dbl>     <dbl>    <dbl>\n1 tment      -0.475    0.224        -2.12 3.39e- 2\n2 alb        -0.112    0.0213       -5.28 1.30e- 7\n3 bili        0.00846  0.000939      9.01 2.12e-19\n4 timegroup1  1.29     0.806         1.60 1.10e- 1\n5 timegroup2  2.15     0.833         2.58 9.99e- 3\n6 timegroup3  1.61     1.01          1.59 1.12e- 1\n\n\n\n\n\n\nCode hide/show\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= tment interv alb  bili / dist=poi offset=logrisk ;\nrun;\n\n\n\n\n\n\n\nTable 2.6\n\nRSAS\n\n\n\n\nCode hide/show\n#------------------------------------------------------------------#\n# Table 2.6 Cox models \n#------------------------------------------------------------------#\n\n# Models for LR tests\nlibrary(lmtest)\nbase_coxmod <- coxph(Surv(days, status != 0) ~ tment + alb + bili, \n                     eps = 1e-8, method = \"breslow\", data = pbc3)\nbase_coxmod_log <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                         eps = 1e-8, method = \"breslow\", data = pbc3)\n\n# Splines Cox 1\ncoxmod_t26_l1 <- coxph(Surv(days, status != 0) ~ tment + alb + albnorm + bili,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_l1\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + albnorm + \n    bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n              coef  exp(coef)   se(coef)      z      p\ntment   -0.4750722  0.6218402  0.2261462 -2.101 0.0357\nalb     -0.0854244  0.9181225  0.0453150 -1.885 0.0594\nalbnorm -0.0557001  0.9458228  0.0726447 -0.767 0.4432\nbili     0.0089810  1.0090214  0.0009843  9.124 <2e-16\n\nLikelihood ratio test=99.66  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode hide/show\nlrtest(coxmod_t26_l1, base_coxmod)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + albnorm + bili\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -413.12                     \n2   3 -413.42 -1 0.6001     0.4386\n\n\nCode hide/show\n# Quadratic Cox 1\ncoxmod_t26_q1 <- coxph(Surv(days, status != 0) ~ tment + alb + I(alb*alb) + bili,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_q1\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + I(alb * \n    alb) + bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n                   coef  exp(coef)   se(coef)      z      p\ntment        -0.4983093  0.6075570  0.2274284 -2.191 0.0284\nalb          -0.1295361  0.8785029  0.2130539 -0.608 0.5432\nI(alb * alb)  0.0001944  1.0001945  0.0029754  0.065 0.9479\nbili          0.0089499  1.0089901  0.0009801  9.132 <2e-16\n\nLikelihood ratio test=99.07  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode hide/show\nlrtest(coxmod_t26_q1, base_coxmod)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + I(alb * alb) + bili\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -413.41                     \n2   3 -413.42 -1 0.0042      0.948\n\n\nCode hide/show\n# Splines Cox 2\ncoxmod_t26_l2 <- coxph(Surv(days, status != 0) ~ tment + alb + \n                         bili + bilihigh + bilitoohigh + bilimuchtoohigh,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_l2\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili + \n    bilihigh + bilitoohigh + bilimuchtoohigh, data = pbc3, method = \"breslow\", \n    eps = 1e-08)\n\n                     coef exp(coef)  se(coef)      z        p\ntment           -0.598494  0.549639  0.229637 -2.606  0.00915\nalb             -0.090970  0.913045  0.021894 -4.155 3.25e-05\nbili             0.062425  1.064414  0.062296  1.002  0.31631\nbilihigh        -0.014631  0.985476  0.085327 -0.171  0.86386\nbilitoohigh     -0.002584  0.997419  0.052961 -0.049  0.96109\nbilimuchtoohigh -0.040017  0.960773  0.026486 -1.511  0.13082\n\nLikelihood ratio test=123.5  on 6 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode hide/show\nlrtest(coxmod_t26_l2, base_coxmod)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + bili + bilihigh + bilitoohigh + \n    bilimuchtoohigh\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   6 -401.22                         \n2   3 -413.42 -3 24.396  2.064e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode hide/show\n# Quadratic Cox 2\ncoxmod_t26_q2 <- coxph(Surv(days, status != 0) ~ tment+alb+bili + I(bili*bili),\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_q2\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili + \n    I(bili * bili), data = pbc3, method = \"breslow\", eps = 1e-08)\n\n                     coef  exp(coef)   se(coef)      z        p\ntment          -5.210e-01  5.939e-01  2.233e-01 -2.333 0.019640\nalb            -1.019e-01  9.031e-01  2.168e-02 -4.703 2.56e-06\nbili            1.998e-02  1.020e+00  3.263e-03  6.122 9.21e-10\nI(bili * bili) -3.051e-05  1.000e+00  9.098e-06 -3.354 0.000798\n\nLikelihood ratio test=111.4  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode hide/show\nlrtest(coxmod_t26_q2, base_coxmod)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + bili + I(bili * bili)\nModel 2: Surv(days, status != 0) ~ tment + alb + bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   4 -407.24                         \n2   3 -413.42 -1 12.351  0.0004408 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode hide/show\n# Splines Cox 3\ncoxmod_t26_l3 <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili +\n                         logbilihigh + logbilitoohigh + logbilimuchtoohigh,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_l3\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili + \n    logbilihigh + logbilitoohigh + logbilimuchtoohigh, data = pbc3, \n    method = \"breslow\", eps = 1e-08)\n\n                       coef exp(coef) se(coef)      z        p\ntment              -0.58019   0.55979  0.22957 -2.527   0.0115\nalb                -0.08852   0.91528  0.02182 -4.056 4.99e-05\nlog2bili            0.20135   1.22306  0.46511  0.433   0.6651\nlogbilihigh         0.93567   2.54893  0.91503  1.023   0.3065\nlogbilitoohigh     -0.38647   0.67945  1.29333 -0.299   0.7651\nlogbilimuchtoohigh -0.18140   0.83410  0.98801 -0.184   0.8543\n\nLikelihood ratio test=121.6  on 6 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode hide/show\nlrtest(coxmod_t26_l3, base_coxmod_log)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + log2bili + logbilihigh + \n    logbilitoohigh + logbilimuchtoohigh\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -402.13                     \n2   3 -402.94 -3 1.6144     0.6561\n\n\nCode hide/show\n# Quadratic Cox 3\ncoxmod_t26_q3 <- coxph(Surv(days, status != 0) ~ tment+alb+log2bili + log2bili2,\n                       eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t26_q3\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili + \n    log2bili2, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n              coef exp(coef) se(coef)      z        p\ntment     -0.57408   0.56323  0.22454 -2.557   0.0106\nalb       -0.09150   0.91256  0.02192 -4.175 2.98e-05\nlog2bili   0.58231   1.79017  0.49992  1.165   0.2441\nlog2bili2  0.00715   1.00717  0.04277  0.167   0.8672\n\nLikelihood ratio test=120  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode hide/show\nlrtest(coxmod_t26_q3, base_coxmod_log)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + log2bili + log2bili2\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -402.93                     \n2   3 -402.94 -1 0.0277     0.8677\n\n\nCode hide/show\n#------------------------------------------------------------------#\n# Table 2.6 Poisson models \n#------------------------------------------------------------------#\n\n# Make the data ready for Poisson models using survSplit from survival package\nlibrary(survival)\npbc3mult <- as.data.frame(survSplit(Surv(days, fail) ~ ., pbc3,\n                                    cut = cuts[-1], \n                                    episode = \"timegroup\"))\npbc3mult$risktime <- pbc3mult$days - cuts[pbc3mult$timegroup] \npbc3mult$timegroup <- as.factor(pbc3mult$timegroup)\n\n# Models for LR test\nbase_poismod <- glm(fail ~ timegroup + tment + alb + bili +\n                      offset(log(risktime)), data = pbc3mult, family = poisson)\nbase_poismod_log <- glm(fail ~ timegroup + tment + alb + log2bili +\n                          offset(log(risktime)), data=pbc3mult,family=poisson)\n\n# Splines Poisson 1\npoismod_t26_l1 <- glm(fail ~ timegroup + tment + alb + albnorm + bili +\n                        offset(log(risktime)), data=pbc3mult, family=poisson)\ntidy(poismod_t26_l1)\n\n\n# A tibble: 7 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept) -5.12     1.63        -3.14  1.66e- 3\n2 timegroup1  -0.311    0.604       -0.514 6.07e- 1\n3 timegroup2   0.543    0.602        0.902 3.67e- 1\n4 tment       -0.458    0.225       -2.04  4.17e- 2\n5 alb         -0.0864   0.0452      -1.91  5.57e- 2\n6 albnorm     -0.0474   0.0720      -0.658 5.11e- 1\n7 bili         0.00848  0.000942     9.00  2.24e-19\n\n\nCode hide/show\nlrtest(poismod_t26_l1, base_poismod)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + albnorm + bili + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   7 -263.14                     \n2   6 -263.36 -1 0.4404     0.5069\n\n\nCode hide/show\n# Quadratic Poisson 1\npoismod_t26_q1 <- glm(fail ~ timegroup + tment + alb + I(alb*alb) + bili +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_q1)\n\n\n# A tibble: 7 × 5\n  term          estimate std.error statistic  p.value\n  <chr>            <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -3.83      3.81        -1.00  3.16e- 1\n2 timegroup1   -0.323     0.605       -0.534 5.94e- 1\n3 timegroup2    0.536     0.602        0.890 3.73e- 1\n4 tment        -0.479     0.226       -2.12  3.41e- 2\n5 alb          -0.139     0.210       -0.660 5.09e- 1\n6 I(alb * alb)  0.000371  0.00293      0.126 8.99e- 1\n7 bili          0.00846   0.000939     9.01  2.05e-19\n\n\nCode hide/show\nlrtest(poismod_t26_q1, base_poismod)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + I(alb * alb) + bili + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   7 -263.36                     \n2   6 -263.36 -1 0.0158     0.8999\n\n\nCode hide/show\n# Splines Poisson 2\npoismod_t26_l2 <- glm(fail ~ timegroup + tment + alb + \n                        bili + bilihigh + bilitoohigh + bilimuchtoohigh +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_l2)\n\n\n# A tibble: 9 × 5\n  term            estimate std.error statistic    p.value\n  <chr>              <dbl>     <dbl>     <dbl>      <dbl>\n1 (Intercept)     -6.45       1.37     -4.72   0.00000240\n2 timegroup1      -0.427      0.605    -0.707  0.480     \n3 timegroup2       0.425      0.604     0.705  0.481     \n4 tment           -0.569      0.227    -2.51   0.0121    \n5 alb             -0.0865     0.0219   -3.95   0.0000770 \n6 bili             0.0617     0.0623    0.989  0.322     \n7 bilihigh        -0.0168     0.0852   -0.197  0.844     \n8 bilitoohigh      0.00265    0.0526    0.0504 0.960     \n9 bilimuchtoohigh -0.0428     0.0262   -1.63   0.102     \n\n\nCode hide/show\nlrtest(poismod_t26_l2, base_poismod)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + bili + bilihigh + bilitoohigh + \n    bilimuchtoohigh + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   9 -251.09                         \n2   6 -263.36 -3 24.545  1.922e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode hide/show\n# Quadratic Poisson 2\npoismod_t26_q2 <- glm(fail ~ timegroup + tment + alb + bili + I(bili*bili) +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_q2)\n\n\n# A tibble: 7 × 5\n  term             estimate  std.error statistic  p.value\n  <chr>               <dbl>      <dbl>     <dbl>    <dbl>\n1 (Intercept)    -5.16      1.05          -4.90  9.47e- 7\n2 timegroup1     -0.382     0.605         -0.631 5.28e- 1\n3 timegroup2      0.455     0.603          0.755 4.50e- 1\n4 tment          -0.499     0.222         -2.25  2.45e- 2\n5 alb            -0.0977    0.0216        -4.52  6.24e- 6\n6 bili            0.0200    0.00327        6.12  9.49e-10\n7 I(bili * bili) -0.0000315 0.00000907    -3.48  5.10e- 4\n\n\nCode hide/show\nlrtest(poismod_t26_q2, base_poismod)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + bili + I(bili * bili) + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)    \n1   7 -256.69                         \n2   6 -263.36 -1 13.345  0.0002591 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nCode hide/show\n# Splines Poisson 3\npoismod_t26_l3 <- glm(fail ~ timegroup + tment + alb + \n                        log2bili + logbilihigh + logbilitoohigh + logbilimuchtoohigh +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_l3)\n\n\n# A tibble: 9 × 5\n  term               estimate std.error statistic  p.value\n  <chr>                 <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)         -6.52      2.00      -3.27  0.00109 \n2 timegroup1          -0.407     0.604     -0.674 0.501   \n3 timegroup2           0.418     0.604      0.693 0.488   \n4 tment               -0.556     0.227     -2.45  0.0144  \n5 alb                 -0.0844    0.0218    -3.87  0.000109\n6 log2bili             0.198     0.465      0.425 0.671   \n7 logbilihigh          0.882     0.912      0.967 0.334   \n8 logbilitoohigh      -0.234     1.28      -0.183 0.855   \n9 logbilimuchtoohigh  -0.314     0.971     -0.323 0.746   \n\n\nCode hide/show\nlrtest(poismod_t26_l3, base_poismod_log)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + logbilihigh + logbilitoohigh + \n    logbilimuchtoohigh + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   9 -251.77                     \n2   6 -252.62 -3 1.7135     0.6339\n\n\nCode hide/show\n# Quadratic Poisson 3\npoismod_t26_q3 <- glm(fail ~ timegroup + tment + alb + log2bili + log2bili2 +\n                        offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t26_q3)\n\n\n# A tibble: 7 × 5\n  term        estimate std.error statistic   p.value\n  <chr>          <dbl>     <dbl>     <dbl>     <dbl>\n1 (Intercept) -7.86       1.85     -4.25   0.0000218\n2 timegroup1  -0.406      0.605    -0.672  0.502    \n3 timegroup2   0.439      0.603     0.728  0.467    \n4 tment       -0.545      0.223    -2.45   0.0143   \n5 alb         -0.0871     0.0219   -3.98   0.0000692\n6 log2bili     0.628      0.497     1.26   0.207    \n7 log2bili2    0.00164    0.0424    0.0387 0.969    \n\n\nCode hide/show\nlrtest(poismod_t26_q3, base_poismod_log)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + log2bili2 + offset(log(risktime))\nModel 2: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   7 -252.62                     \n2   6 -252.62 -1 0.0015     0.9691\n\n\n\n\n\n\nCode hide/show\n** Cox models **;\n\n* Base models for LR tests; \nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb bili/rl ties=breslow CONVERGELIKE=1E-8 type3(lr);\nrun;\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili/rl ties=breslow CONVERGELIKE=1E-8 type3(lr);\nrun;\n\n* Splines Cox 1; \n* LRT can here be read of type3 test result; \nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb albnorm bili/rl ties=breslow CONVERGELIKE=1E-8 type3(lr);\nrun;\n\n* Quadratic Cox 1; \n* LRT can here be read of type3 test result; \nproc phreg data=pbc3;\n  alb2=alb*alb;\n    class tment (ref='0');\n    model days*status(0)=tment alb10 alb2 bili100/rl type3(LR);\nrun;\n\n* Splines Cox 2;\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb bili bilihigh bilitoohigh \n                             bilimuchtoohigh/rl type3(lr) ties=breslow CONVERGELIKE=1E-8;\nrun;\n* LRT; \ndata p;\n    chi2=826.830-802.434;\n    p=1-probchi(chi2,3);\nproc print;\nrun;\n\n* Quadratic Cox 2; \n* LRT can here be read of type3 test result; \nproc phreg data=pbc3;\n  bili2=bili*bili;\n    class tment (ref='0');\n    model days*status(0)=tment alb10 bili bili2 / rl type3(LR);\nrun;\n\n* Splines Cox 3;\nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb log2bili logbilihigh \n                             logbilitoohigh logbilimuchtoohigh/rl ties=breslow CONVERGELIKE=1E-8;\n*linbili: test  logbilihigh=logbilitoohigh=logbilimuchtoohigh=0;\nrun;\n* LRT; \ndata p;\n    chi2=805.881-804.267;\n    p=1-probchi(chi2,3);\nproc print;\nrun;\n\n* Quadratic Cox 3; \n* LRT can here be read of type3 test result; \nproc phreg data=pbc3;\n    class tment (ref='0');\n    model days*status(0)=tment alb10 log2bili log2bili2/rl type3(LR);\nrun;\n\n* Split data into timegroups for Poisson models; \ndata pbc3mult; \n    set pbc3;\n    fail=(days<=2 * 365.25)*(status ne 0);\n    risktime=min(2 * 365.25,days);\n    logrisk=log(risktime); interv=1; output;  \n    if days>2* 365.25 then do;\n    fail=(days<=4* 365.25)*(status ne 0);\n    risktime=min(2* 365.25,days-2* 365.25);\n    logrisk=log(risktime); interv=2; output; end;\n    if days>4* 365.25 then do;\n    fail=status ne 0; \n    risktime=days-4* 365.25;\n    logrisk=log(risktime); interv=3; output; end;\nrun;\n\n\n** Possion models **;\n\n* Models to compare with for the LR tests; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb bili/ dist=poi offset=logrisk type3;\nrun;\n\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb log2bili/ dist=poi offset=logrisk type3;\nrun;\n\n* Splines Poisson 1; \n* LRT can here be read of type3 test result; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb albnorm bili/ dist=poi offset=logrisk type3;\nrun;\n\n* Quadratic Poisson 1;\n* LRT can here be read of type3 test result; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb10 alb2 bili100/ dist=poi offset=logrisk type3;\nrun;\n\n* Splines Poisson 2; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb bili bilihigh bilitoohigh  \n                 bilimuchtoohigh/ dist=poi offset=logrisk type3;\nrun;\n* LRT; \ndata p;\n    chi2=350.7253-326.1805;\n    p=1-probchi(chi2,3);\nproc print;\nrun;\n\n* Quadratic Poisson 2;\n* LRT can here be read of type3 test result; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb10 bili100 bili2/ dist=poi offset=logrisk type3;\nrun;\n\n* Splines Poisson 3;\nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb log2bili logbilihigh logbilitoohigh \n                 logbilimuchtoohigh / dist=poi offset=logrisk type3;\nrun;\n* LRT; \ndata p;\n    chi2=329.2509-327.5375;\n    p=1-probchi(chi2,3);\nproc print;\nrun;\n\n* Quadratic Poisson 3;\n* LRT can here be read of type3 test result; \nproc genmod data=pbc3mult;\n    class tment (ref='0') interv;\n    model fail= interv tment alb10 log2bili log2bili2/ dist=poi offset=logrisk type3;\nrun;\n\n\n\n\n\n\n\nFigure 2.6\n\n\nCode hide/show\n# The below linear predictors include estimates from the following models\npbc3mult$timegroup <- relevel(as.factor(pbc3mult$timegroup), ref = \"3\")\npbc3mult$tment_char <- as.factor(pbc3mult$tment_char)\npbc3mult$tment_char <- relevel(pbc3mult$tment_char, ref = \"Placebo\")\nbase_poismod <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                      tment_char + alb + bili,\n                    data = pbc3mult, family = poisson)\npoismod_t26_l1 <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                        tment_char + alb + bili + albnorm,\n                      data = pbc3mult, family = poisson)\npoismod_t26_l3 <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                        tment_char + alb + \n                        bili + bilihigh + bilitoohigh + bilimuchtoohigh,\n                      data = pbc3mult,family = poisson)\n# Make a dataset with linear predictor information\nlin2 <- pbc3\nlin2$lp1 <- with(pbc3, 1.6076-0.1123*alb)\nlin2$lp2 <- with(pbc3, 0.7828-0.0864*alb-0.0474*albnorm)\nlin2$lp3 <- with(pbc3, 1.6076+0.0085*bili-38.7*0.1123)\nlin2$lp4 <- with(pbc3, -0.5534+0.0617*bili-0.0168*bilihigh+\n                   0.0027*bilitoohigh-0.0428*bilimuchtoohigh-0.0865*38.7)\nlin2row <- data.frame(effect = c(rep(\"Linear effect\", nrow(lin2)),\n                                 rep(\"Effect as linear spline\", nrow(lin2))), \n                      lp = c(lin2$lp1, lin2$lp2), alb = c(lin2$alb, lin2$alb))\nlibrary(ggplot2)\nfig2.6 <- ggplot(aes(x = alb, y = lp, linetype = effect), data = lin2row) +\n  geom_line(size = 1) + \n  xlab(\"Albumin\") + \n  ylab(\"Linear predictor\") + \n  scale_linetype_discrete(\"Effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.6\n\n\n\n\n\n\n\nFigure 2.7\n\n\nCode hide/show\n# bilirubin and the two last linear predictors\nlin2row2 <- data.frame(effect = c(rep(\"Linear effect\", nrow(lin2)),\n                                  rep(\"Effect as linear spline\", nrow(lin2))), \n                      lp = c(lin2$lp3, lin2$lp4),\n                      bili = c(lin2$bili, lin2$bili))\n\nfig2.7 <- ggplot(aes(x = bili, y = lp, linetype = effect), data = lin2row2) + \n  geom_line(size = 1) + \n  xlab(\"Bilirubin\") + \n  ylab(\"Linear predictor\") + \n  scale_linetype_discrete(\"Effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.7\n\n\n\n\n\n\n\nFigure 2.8\n\n\nCode hide/show\n# The below linear predictors include estimates from the following models\nbase_poismod2_log <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                           tment_char + alb + log2bili,\n                         data = pbc3mult, family = poisson)\npoismod_t26_l3 <- glm(fail ~ offset(log(risktime)) + as.factor(timegroup) + \n                        tment_char + alb + log2bili + \n                        logbilihigh + logbilitoohigh + logbilimuchtoohigh,\n                        data = pbc3mult, family = poisson)\n# Make a dataset with linear predictor information\nlog2 <- pbc3\nlog2$lp3 <- with(pbc3, -2.0162+0.6469*log2bili-38.7*0.087)\nlog2$lp4 <- with(pbc3, -0.6194+0.198*log2bili\n                 +0.8815*logbilihigh-0.2336*logbilitoohigh\n                 -0.3139*logbilimuchtoohigh-0.0844*38.7)\nlog2row <- data.frame(effect = c(rep(\"Linear effect\", nrow(log2)),\n                                 rep(\"Effect as linear spline\", nrow(log2))), \n                      lp = c(log2$lp3, log2$lp4),\n                      log2bili = c(log2$log2bili, log2$log2bili)\n                      )\n\nfig2.8 <- ggplot(aes(x = log2bili, y = lp, linetype = effect), data = log2row) + \n  geom_line(size = 1) + \n  xlab(expression(log[2] * \"(bilirubin)\")) +\n  ylab(\"Linear predictor\") + \n  scale_linetype_discrete(\"Effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.8\n\n\n\n\n\n\n\nTable 2.7\n\n\nCode hide/show\n# Cox model\ncoxmod_t27 <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                    eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t27\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili, \n    data = pbc3, method = \"breslow\", eps = 1e-08)\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.57406   0.56323  0.22447 -2.557   0.0105\nalb      -0.09093   0.91308  0.02164 -4.201 2.65e-05\nlog2bili  0.66500   1.94449  0.07443  8.935  < 2e-16\n\nLikelihood ratio test=120  on 3 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode hide/show\n# Poisson model\npoismod_t27 <- glm(fail ~ tment + alb + log2bili + timegroup + \n                     offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t27) \n\n\n# A tibble: 6 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.48      0.976     -7.66  1.81e-14\n2 tment        -0.545     0.223     -2.45  1.43e- 2\n3 alb          -0.0870    0.0216    -4.02  5.73e- 5\n4 log2bili      0.647     0.0733     8.83  1.04e-18\n5 timegroup3   -0.439     0.603     -0.727 4.67e- 1\n6 timegroup1   -0.844     0.229     -3.69  2.23e- 4\n\n\n\n\nTable 2.8\n\n\nCode hide/show\n# Cox models\n# Model for LR comparison\ncoxmod_t28_base <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\n# Cox model 1\npbc3$alb0 <- (pbc3$tment==0)*pbc3$alb\npbc3$alb1 <- (pbc3$tment==1)*pbc3$alb\ncoxmod_t28_1 <- coxph(Surv(days, status != 0) ~ tment + alb0 + alb1 + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t28_1\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb0 + alb1 + \n    log2bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n              coef exp(coef)  se(coef)      z        p\ntment    -0.009736  0.990312  1.559670 -0.006 0.995020\nalb0     -0.081319  0.921900  0.034031 -2.390 0.016869\nalb1     -0.097043  0.907517  0.027344 -3.549 0.000387\nlog2bili  0.664413  1.943350  0.074494  8.919  < 2e-16\n\nLikelihood ratio test=120.2  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode hide/show\nlrtest(coxmod_t28_1, coxmod_t28_base)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb0 + alb1 + log2bili\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -402.87                     \n2   3 -402.94 -1 0.1338     0.7145\n\n\nCode hide/show\n# Cox model 2\npbc3$bili0 <- (pbc3$tment==0)*pbc3$log2bili\npbc3$bili1 <- (pbc3$tment==1)*pbc3$log2bili\ncoxmod_t28_2 <- coxph(Surv(days, status != 0) ~ tment + alb + bili0 + bili1,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_t28_2\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + bili0 + \n    bili1, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n          coef exp(coef) se(coef)      z        p\ntment  0.19880   1.21994  0.85653  0.232    0.816\nalb   -0.09331   0.91091  0.02191 -4.260 2.05e-05\nbili0  0.72558   2.06593  0.09865  7.355 1.91e-13\nbili1  0.59345   1.81022  0.10604  5.596 2.19e-08\n\nLikelihood ratio test=120.9  on 4 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\nCode hide/show\nlrtest(coxmod_t28_2, coxmod_t28_base)\n\n\nLikelihood ratio test\n\nModel 1: Surv(days, status != 0) ~ tment + alb + bili0 + bili1\nModel 2: Surv(days, status != 0) ~ tment + alb + log2bili\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   4 -402.51                     \n2   3 -402.94 -1 0.8644     0.3525\n\n\nCode hide/show\n# Poisson models\n# Model for LR comparison - no interaction\npoismod_t28_base <- glm(fail ~ timegroup + tment + alb + log2bili+\n                          offset(log(risktime)), data=pbc3mult, family=poisson)\n\n# Poisson model 1\npbc3mult$alb0 <- (pbc3mult$tment==0)*pbc3mult$alb\npbc3mult$alb1 <- (pbc3mult$tment==1)*pbc3mult$alb\npoismod_t28_1 <- glm(fail ~ tment + alb0 + alb1 + log2bili + timegroup +\n                       offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t28_1) \n\n\n# A tibble: 7 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.87      1.36     -5.78   7.54e- 9\n2 tment         0.0920    1.55      0.0593 9.53e- 1\n3 alb0         -0.0763    0.0336   -2.27   2.32e- 2\n4 alb1         -0.0941    0.0275   -3.41   6.39e- 4\n5 log2bili      0.646     0.0733    8.81   1.23e-18\n6 timegroup3   -0.431     0.604    -0.714  4.75e- 1\n7 timegroup1   -0.844     0.229    -3.69   2.20e- 4\n\n\nCode hide/show\nlrtest(poismod_t28_base, poismod_t28_1)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\nModel 2: fail ~ tment + alb0 + alb1 + log2bili + timegroup + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   7 -252.54  1 0.1723      0.678\n\n\nCode hide/show\n# Poisson model 2\npbc3mult$bili0 <- (pbc3mult$tment==0)*pbc3mult$log2bili\npbc3mult$bili1 <- (pbc3mult$tment==1)*pbc3mult$log2bili\npoismod_t28_2 <- glm(fail ~ tment + alb + bili0 + bili1 + timegroup +\n                       offset(log(risktime)), data = pbc3mult, family = poisson)\ntidy(poismod_t28_2) \n\n\n# A tibble: 7 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.72      1.02      -7.59  3.10e-14\n2 tment         0.181     0.848      0.213 8.31e- 1\n3 alb          -0.0891    0.0218    -4.08  4.54e- 5\n4 bili0         0.704     0.0972     7.24  4.42e-13\n5 bili1         0.580     0.105      5.54  3.08e- 8\n6 timegroup3   -0.417     0.604     -0.691 4.90e- 1\n7 timegroup1   -0.857     0.229     -3.74  1.86e- 4\n\n\nCode hide/show\nlrtest(poismod_t28_base, poismod_t28_2)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ timegroup + tment + alb + log2bili + offset(log(risktime))\nModel 2: fail ~ tment + alb + bili0 + bili1 + timegroup + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   7 -252.24  1 0.7787     0.3775\n\n\n\n\nTable 2.9\n\n\nCode hide/show\npbc3mult$tment1 <- (pbc3mult$timegroup==1)*pbc3mult$tment\npbc3mult$tment2 <- (pbc3mult$timegroup==2)*pbc3mult$tment\npbc3mult$tment3 <- (pbc3mult$timegroup==3)*pbc3mult$tment\npbc3mult$alb1 <- (pbc3mult$timegroup==1)*pbc3mult$alb\npbc3mult$alb2 <- (pbc3mult$timegroup==2)*pbc3mult$alb\npbc3mult$alb3 <- (pbc3mult$timegroup==3)*pbc3mult$alb\npbc3mult$bili1 <- (pbc3mult$timegroup==1)*pbc3mult$log2bili\npbc3mult$bili2 <- (pbc3mult$timegroup==2)*pbc3mult$log2bili\npbc3mult$bili3 <- (pbc3mult$timegroup==3)*pbc3mult$log2bili\n\npoismod_t29_base <- glm(fail~tment+alb+log2bili+timegroup+offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\n\n# Treatment\npoismod_t29_tment <- glm(fail ~ tment1 + tment2 + tment3 + alb + log2bili+\n                       timegroup + offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\ntidy(poismod_t29_tment) \n\n\n# A tibble: 8 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.55      0.983     -7.68  1.62e-14\n2 tment1       -0.562     0.291     -1.93  5.35e- 2\n3 tment2       -0.462     0.345     -1.34  1.80e- 1\n4 tment3       -1.27      1.23      -1.03  3.03e- 1\n5 alb          -0.0864    0.0217    -3.99  6.65e- 5\n6 log2bili      0.649     0.0737     8.81  1.30e-18\n7 timegroup3   -0.0954    0.750     -0.127 8.99e- 1\n8 timegroup1   -0.794     0.319     -2.49  1.29e- 2\n\n\nCode hide/show\nlrtest(poismod_t29_base, poismod_t29_tment)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ tment + alb + log2bili + timegroup + offset(log(risktime))\nModel 2: fail ~ tment1 + tment2 + tment3 + alb + log2bili + timegroup + \n    offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   8 -252.41  2 0.4312     0.8061\n\n\nCode hide/show\n# Albumin\npoismod_t29_alb <- glm(fail ~ tment + alb1 + alb2 + alb3 + log2bili+\n                       timegroup + offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\ntidy(poismod_t29_alb) \n\n\n# A tibble: 8 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -8.75      1.42    -6.18    6.41e-10\n2 tment        -0.561     0.223   -2.52    1.18e- 2\n3 alb1         -0.110     0.0279  -3.95    7.79e- 5\n4 alb2         -0.0523    0.0347  -1.51    1.32e- 1\n5 alb3         -0.0654    0.153   -0.427   6.70e- 1\n6 log2bili      0.646     0.0736   8.78    1.68e-18\n7 timegroup3    0.0143    6.09     0.00235 9.98e- 1\n8 timegroup1    1.24      1.60     0.776   4.38e- 1\n\n\nCode hide/show\nlrtest(poismod_t29_base, poismod_t29_alb)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ tment + alb + log2bili + timegroup + offset(log(risktime))\nModel 2: fail ~ tment + alb1 + alb2 + alb3 + log2bili + timegroup + offset(log(risktime))\n  #Df  LogLik Df Chisq Pr(>Chisq)\n1   6 -252.62                    \n2   8 -251.72  2 1.803      0.406\n\n\nCode hide/show\n# Bilirubin\npoismod_t29_bili <- glm(fail ~ tment + alb + bili1 + bili2 + bili3 +\n                       timegroup + offset(log(risktime)),\n                     data = pbc3mult, family = poisson)\ntidy(poismod_t29_bili) \n\n\n# A tibble: 8 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept)  -7.06      1.10      -6.40  1.55e-10\n2 tment        -0.515     0.224     -2.30  2.15e- 2\n3 alb          -0.0857    0.0217    -3.94  8.10e- 5\n4 bili1         0.710     0.0926     7.67  1.69e-14\n5 bili2         0.557     0.121      4.60  4.18e- 6\n6 bili3         0.305     0.482      0.633 5.26e- 1\n7 timegroup3    0.696     2.32       0.300 7.64e- 1\n8 timegroup1   -1.72      0.888     -1.94  5.21e- 2\n\n\nCode hide/show\nlrtest(poismod_t29_base, poismod_t29_bili)\n\n\nLikelihood ratio test\n\nModel 1: fail ~ tment + alb + log2bili + timegroup + offset(log(risktime))\nModel 2: fail ~ tment + alb + bili1 + bili2 + bili3 + timegroup + offset(log(risktime))\n  #Df  LogLik Df  Chisq Pr(>Chisq)\n1   6 -252.62                     \n2   8 -251.84  2 1.5777     0.4544\n\n\n\n\nIn-text: stratified Cox model\n\n\nCode hide/show\ncoxmod_f29 <- coxph(Surv(days, status != 0) ~ strata(tment) + alb + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\ncoxmod_f29\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ strata(tment) + alb + \n    log2bili, data = pbc3, method = \"breslow\", eps = 1e-08)\n\n             coef exp(coef) se(coef)      z        p\nalb      -0.09002   0.91391  0.02168 -4.153 3.28e-05\nlog2bili  0.66328   1.94114  0.07531  8.807  < 2e-16\n\nLikelihood ratio test=119.3  on 2 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)\n\n\n\n\nFigure 2.10\n\n\nCode hide/show\n# Extracting cumulative baseline hazards per treatment\ncumhaz_treat <- basehaz(coxmod_f29, centered = FALSE)\ncumhaz_treat <- as.data.frame(cumhaz_treat)\n# Per treatment\nhazard_t0 <- cumhaz_treat[cumhaz_treat$strata == \"tment=0\",]\nhazard_t0[1,] <- c(0, 0, \"tment=0\")\nhazard_t0$time<- as.numeric(hazard_t0$time)\nhazard_t0$hazard <- as.numeric(hazard_t0$hazard)\nhazard_t1 <- cumhaz_treat[cumhaz_treat$strata == \"tment=1\",]\n# Match times\nalltimes <- sort(unique(cumhaz_treat$time))\nhazard_t0_allt <- as.numeric(sapply(1:length(alltimes),function(k) \n  tail(hazard_t0$hazard[hazard_t0$time <= alltimes[k]], 1)))\nhazard_t1_allt <- as.numeric(sapply(1:length(alltimes), function(k)\n  tail(hazard_t1$hazard[hazard_t1$time <= alltimes[k]], 1))) \nhazards <- data.frame(hazard_t0_allt, hazard_t1_allt)\n# Extract coefficient\ncoxmod_f29_t <- coxph(Surv(days, status != 0) ~ tment + alb + log2bili,\n                      eps = 1e-8, method = \"breslow\", data = pbc3)\n# Make plot\nfig2.10 <- ggplot(aes(x = hazard_t0_allt, y = hazard_t1_allt), data = hazards) + \n  geom_step(size = 1) + \n  geom_abline(intercept = 0, slope = exp(coef(coxmod_f29_t)[[\"tment\"]]), \n              linetype = \"dashed\", size = 1) + \n  xlab(\"Cumulative baseline hazard: placebo\") +\n  ylab(\"Cumulative baseline hazard: CyA\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05))) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.10\n\n\n\n\n\n\n\nFigure 2.11\n\n\nCode hide/show\n# Additive Aalen models - available with timereg\nlibrary(timereg)\nnonparmod <- aalen(Surv(days, status != 0) ~ tment, data = pbc3)\nsummary(nonparmod)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          5.96               0.000\ntment                                1.60               0.731\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.107                       0.592\ntment                               0.136                       0.613\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                          7.62                       0.449\ntment                                4.54                       0.722\n\n   \n   \n  Call: \naalen(formula = Surv(days, status != 0) ~ tment, data = pbc3)\n\n\nCode hide/show\ncumhazdata <- data.frame(eventtimes = nonparmod$cum[,1],\n                         basecumhaz = nonparmod$cum[,2], \n                         cumhaztreat = nonparmod$cum[,3], \n                         cumhaztreat_ll = nonparmod$cum[,3]\n                                          -1.96*sqrt(nonparmod$var.cum[,3]),\n                         cumhaztreat_ul = nonparmod$cum[,3]\n                                          +1.96*sqrt(nonparmod$var.cum[,3]))\n# Extend lines to last observed time\ncumhazdata[nrow(cumhazdata)+1,] <- c(max(pbc3$days), tail(cumhazdata, 1)[-1])\n\n# Left figure\nfig2.11.left <- ggplot(aes(x = eventtimes / 365.25, y = basecumhaz), \n                       data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative baseline hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6),breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.11.left\n\n\n\n\n\nCode hide/show\n# Right figure\nfig2.11.right <- ggplot(aes(x = eventtimes / 365.25, y = cumhaztreat), \n                        data = cumhazdata) + \n  geom_step(size = 1) + \n  geom_step(size = 1, aes(x = eventtimes / 365.25, y = cumhaztreat_ll), \n            linetype = \"dashed\") +  \n  geom_step(size = 1, aes(x = eventtimes / 365.25, y = cumhaztreat_ul), \n            linetype = \"dashed\") +\n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative treatment effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.11.right\n\n\n\n\n\n\n\nFigure 2.12\n\n\nCode hide/show\n# Make Aalen model fit\nlibrary(timereg)\nnonparmod2 <- aalen(Surv(days, status != 0) ~ tment + alb + bili, data = pbc3) \ncumhazdata <- data.frame(eventtimes = nonparmod2$cum[,1],\n                         basecumhaz = nonparmod2$cum[,2], \n                         cumhaztreat = nonparmod2$cum[,3], \n                         cumhazalb = nonparmod2$cum[,4], \n                         cumhazbili= nonparmod2$cum[,5])\n# Extend lines to last observed time\ncumhazdata[nrow(cumhazdata)+1,] <- c(max(pbc3$days), tail(cumhazdata, 1)[-1])\n\n# Figure treatment\nfig2.12.1 <- ggplot(aes(x = eventtimes / 365.25, y = cumhaztreat), \n                    data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative treatment effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\n# Figure albumin\nfig2.12.2 <- ggplot(aes(x = eventtimes / 365.25, y = cumhazalb), \n                    data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative albumin effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)), \n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\n# Figure bilirubin\nfig2.12.3 <- ggplot(aes(x = eventtimes / 365.25, y = cumhazbili), \n                    data = cumhazdata) + \n  geom_step(size = 1) + \n  xlab(\"Time since randomization (years)\") +\n  ylab(\"Cumulative bilirubin effect\") + \n  scale_x_continuous(expand = expansion(mult = c(0.03, 0.05)),\n                     limits = c(0, 6), breaks = seq(0, 6, 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.03, 0.05))) +\n  theme_general\n\nfig2.12.1\n\n\n\n\n\nCode hide/show\nfig2.12.2\n\n\n\n\n\nCode hide/show\nfig2.12.3\n\n\n\n\n\n\n\nTable 2.10\n\n\nCode hide/show\n#------------------------------------------------------------------#\n# Table 2.10 and in-text results\n#------------------------------------------------------------------#\n\n# Additive model treatment only\n# p-values not exactly as in book because seed changes\nnonparmod0 <- aalen(Surv(days, status != 0) ~ tment, data = pbc3) \nsummary(nonparmod0)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          5.96               0.000\ntment                                1.60               0.719\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.107                       0.575\ntment                               0.136                       0.624\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                          7.62                       0.431\ntment                                4.54                       0.728\n\n   \n   \n  Call: \naalen(formula = Surv(days, status != 0) ~ tment, data = pbc3)\n\n\nCode hide/show\n# Constant effect of treatment per year\nnonparmod01 <- aalen(Surv(days/365.25, status != 0) ~ const(tment), data = pbc3) \nsummary(nonparmod01)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          6.62                   0\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                        0.0914                        0.41\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0136                       0.286\n\nParametric terms :     \n                Coef.    SE Robust SE     z P-val lower2.5% upper97.5%\nconst(tment) -0.00587 0.021     0.021 -0.28 0.779    -0.047     0.0353\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment), \n    data = pbc3)\n\n\nCode hide/show\n# Additive model with treatment, albumin, bilirubin\n# Table 2.10, first two columns\n# p-values not exactly as in book because seed changes\nnonparmod1 <- aalen(Surv(days, status != 0) ~ tment + alb + bili, data = pbc3) \nsummary(nonparmod1)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          3.62               0.008\ntment                                2.66               0.120\nalb                                  3.82               0.003\nbili                                 4.83               0.000\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                       0.30300                       0.924\ntment                             0.12100                       0.700\nalb                               0.00666                       0.962\nbili                              0.00301                       0.174\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                      14.20000                       0.987\ntment                             3.29000                       0.808\nalb                               0.00826                       0.989\nbili                              0.00203                       0.318\n\n   \n   \n  Call: \naalen(formula = Surv(days, status != 0) ~ tment + alb + bili, \n    data = pbc3)\n\n\nCode hide/show\n# Table 2.10, last columns\nnonparmod2 <- aalen(Surv(days/365.25, status != 0) ~ \n                      const(tment) + const(alb) + const(bili), data = pbc3) \nsummary(nonparmod2)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          4.03                   0\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.119                       0.177\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0263                       0.106\n\nParametric terms :     \n                Coef.       SE Robust SE     z    P-val lower2.5% upper97.5%\nconst(tment) -0.04130 0.021600  0.020100 -2.05 4.02e-02  -0.08360    0.00104\nconst(alb)   -0.00842 0.002290  0.002230 -3.77 1.63e-04  -0.01290   -0.00393\nconst(bili)   0.00230 0.000483  0.000384  5.98 2.17e-09   0.00135    0.00325\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    const(alb) + const(bili), data = pbc3)\n\n\nCode hide/show\n# In-text\n# Constant effect of treatment, adjusted for albumin and bilirubin\nnonparmod3 <- aalen(Surv(days/365.25, status != 0) ~ \n                      const(tment) + alb + bili, data = pbc3) \nsummary(nonparmod3)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          3.60               0.008\nalb                                  3.80               0.004\nbili                                 4.83               0.000\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                       0.28500                       0.951\nalb                               0.00954                       0.813\nbili                              0.00315                       0.149\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                      3.16e-02                       0.997\nalb                              5.26e-05                       0.907\nbili                             6.52e-06                       0.270\n\nParametric terms :     \n               Coef.     SE Robust SE     z P-val lower2.5% upper97.5%\nconst(tment) -0.0401 0.0216    0.0204 -1.97 0.049   -0.0824    0.00224\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    alb + bili, data = pbc3)\n\n\nCode hide/show\n# Quadratic effect for albumin; p-values not exactly as in book because seed changes\nnonparmod44 <- aalen(Surv(days/365.25, status != 0) ~ const(tment)\n                       + I(alb/10) + I(bili/100) + I((alb/10)^2), data = pbc3) \nsummary(nonparmod44)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n              Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                            3.23               0.019\nI(alb/10)                              3.00               0.039\nI(bili/100)                            4.88               0.000\nI((alb/10)^2)                          2.77               0.080\n\nTest for time invariant effects \n                    Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                           9.420                       0.240\nI(alb/10)                             4.950                       0.246\nI(bili/100)                           0.365                       0.074\nI((alb/10)^2)                         0.635                       0.247\n                      Cramer von Mises test p-value H_0:constant effect\n(Intercept)                         83.6000                       0.341\nI(alb/10)                           24.4000                       0.336\nI(bili/100)                          0.0949                       0.180\nI((alb/10)^2)                        0.4160                       0.332\n\nParametric terms :     \n               Coef.     SE Robust SE     z  P-val lower2.5% upper97.5%\nconst(tment) -0.0421 0.0215    0.0201 -2.09 0.0366   -0.0842   3.92e-05\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    I(alb/10) + I(bili/100) + I((alb/10)^2), data = pbc3)\n\n\nCode hide/show\n# Quadratic effect for bilirubin; p-values not exactly as in book as seed changes\nnonparmod43 <- aalen(Surv(days/365.25, status != 0) ~ const(tment)\n                       + I(alb/10) + I(bili/100) + I((bili/100)^2), data = pbc3) \nsummary(nonparmod43)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n                Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                              3.82               0.004\nI(alb/10)                                4.02               0.003\nI(bili/100)                              3.85               0.001\nI((bili/100)^2)                          3.01               0.053\n\nTest for time invariant effects \n                      Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                             0.440                       0.668\nI(alb/10)                               0.117                       0.609\nI(bili/100)                             0.612                       0.408\nI((bili/100)^2)                         0.515                       0.150\n                        Cramer von Mises test p-value H_0:constant effect\n(Intercept)                            0.1320                       0.750\nI(alb/10)                              0.0124                       0.616\nI(bili/100)                            0.4640                       0.309\nI((bili/100)^2)                        0.2880                       0.156\n\nParametric terms :     \n               Coef.     SE Robust SE     z  P-val lower2.5% upper97.5%\nconst(tment) -0.0395 0.0213    0.0208 -1.89 0.0582   -0.0812    0.00225\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    I(alb/10) + I(bili/100) + I((bili/100)^2), data = pbc3)\n\n\nCode hide/show\n# Interactions\nnonparmod51 <- aalen(Surv(days/365.25, status != 0) ~ const(tment) + const(alb)\n                     + const(bili) + const(tment * bili),data = pbc3) \nsummary(nonparmod51)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          4.03                   0\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                         0.123                       0.189\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0287                       0.115\n\nParametric terms :     \n                       Coef.       SE Robust SE       z    P-val lower2.5%\nconst(tment)        -0.00194 0.029400  0.022800 -0.0851 9.32e-01  -0.05960\nconst(alb)          -0.00859 0.002260  0.002200 -3.9000 9.69e-05  -0.01300\nconst(bili)          0.00299 0.000869  0.000437  6.8400 7.77e-12   0.00129\nconst(tment * bili) -0.00116 0.001020  0.000658 -1.7600 7.92e-02  -0.00316\n                    upper97.5%\nconst(tment)          0.055700\nconst(alb)           -0.004160\nconst(bili)           0.004690\nconst(tment * bili)   0.000839\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    const(alb) + const(bili) + const(tment * bili), data = pbc3)\n\n\nCode hide/show\nnonparmod52 <- aalen(Surv(days/365.25, status != 0) ~ const(tment) + const(bili) \n                     + const(alb) + const(tment * alb), data = pbc3) \nsummary(nonparmod52)\n\n\nAdditive Aalen Model \n\nTest for nonparametric terms \n\nTest for non-significant effects \n            Supremum-test of significance p-value H_0: B(t)=0\n(Intercept)                          3.06               0.007\n\nTest for time invariant effects \n                  Kolmogorov-Smirnov test p-value H_0:constant effect\n(Intercept)                          0.12                       0.192\n                    Cramer von Mises test p-value H_0:constant effect\n(Intercept)                        0.0265                       0.118\n\nParametric terms :     \n                      Coef.       SE Robust SE       z    P-val lower2.5%\nconst(tment)        0.01010 0.199000  0.176000  0.0576 9.54e-01  -0.38000\nconst(bili)         0.00230 0.000482  0.000385  5.9600 2.45e-09   0.00136\nconst(alb)         -0.00771 0.003150  0.002780 -2.7700 5.54e-03  -0.01390\nconst(tment * alb) -0.00132 0.004790  0.004300 -0.3060 7.59e-01  -0.01070\n                   upper97.5%\nconst(tment)          0.40000\nconst(bili)           0.00324\nconst(alb)           -0.00154\nconst(tment * alb)    0.00807\n   \n  Call: \naalen(formula = Surv(days/365.25, status != 0) ~ const(tment) + \n    const(bili) + const(alb) + const(tment * alb), data = pbc3)\n\n\n\n\nTable 2.11\n\n\nCode hide/show\n#------------------------------------------------------------------#\n# Table 2.11 and in-text results\n#------------------------------------------------------------------#\n\n# Additive hazards model with piecewise constant baseline hazards\n# Model with only treatment as covariate\n# update data set\npbc3add <- pbc3mult\npbc3add$time1 <-  with(pbc3add, (timegroup == 1)*risktime/365.25)\npbc3add$time2 <-  with(pbc3add, (timegroup == 2)*risktime/365.25)\npbc3add$time3 <-  with(pbc3add, (timegroup == 3)*risktime/365.25)\npbc3add$tment0 <- with(pbc3add, (tment == 0)*risktime/365.25)\npbc3add$tment1 <- with(pbc3add, (tment == 1)*risktime/365.25)\npbc3add$albny <-  with(pbc3add, ((alb-35)/100)*risktime/365.25)\npbc3add$biliny <- with(pbc3add, ((bili-50)/1000)*risktime/365.25)\n\n# In-text\nadditive_pcw <- glm(fail ~ time1 + time2 + time3 + tment1 - 1,\n                    data = pbc3add, start = c(0.1, 0.1, 0.1, 0),\n                    family = poisson(link = \"identity\"))\ntidy(additive_pcw)\n\n\n# A tibble: 4 × 5\n  term   estimate std.error statistic      p.value\n  <chr>     <dbl>     <dbl>     <dbl>        <dbl>\n1 time1   0.0911     0.0164     5.55  0.0000000293\n2 time2   0.132      0.0241     5.46  0.0000000487\n3 time3   0.0937     0.0462     2.03  0.0423      \n4 tment1 -0.00726    0.0208    -0.350 0.726       \n\n\nCode hide/show\n# Table 2.11 - questionable fit\nadditive_pcw2.11 <- glm(fail ~ time1 + time2 + time3 + tment1 + albny + biliny -1,\n                    data = pbc3add, start = c(0.3, 0.35, 0.4, -0.05, -0.8, 2),\n                    family = poisson(link = \"identity\"))\ntidy(additive_pcw2.11)\n\n\n# A tibble: 6 × 5\n  term   estimate std.error statistic  p.value\n  <chr>     <dbl>     <dbl>     <dbl>    <dbl>\n1 time1    0.185     0.0213      8.67 4.46e-18\n2 time2    0.241     0.0258      9.32 1.21e-20\n3 time3    0.229     0.0544      4.22 2.48e- 5\n4 tment1  -0.0224    0.0173     -1.30 1.95e- 1\n5 albny   -0.436     0.128      -3.40 6.79e- 4\n6 biliny   2.22      0.408       5.45 4.98e- 8\n\n\nCode hide/show\nadditive_pcw2.11 <- glm(fail ~ time1 + time2 + time3 + tment1 + albny + biliny -1,\n                        data = pbc3add, start = c(0.3, 0.35, 0.4, -0.05, -0.8, 2.1),\n                        family = poisson(link = \"identity\"))\ntidy(additive_pcw2.11)\n\n\n# A tibble: 6 × 5\n  term   estimate std.error statistic  p.value\n  <chr>     <dbl>     <dbl>     <dbl>    <dbl>\n1 time1    0.186     0.0214      8.68 4.08e-18\n2 time2    0.242     0.0259      9.32 1.14e-20\n3 time3    0.231     0.0548      4.22 2.45e- 5\n4 tment1  -0.0223    0.0174     -1.28 2.00e- 1\n5 albny   -0.436     0.129      -3.37 7.63e- 4\n6 biliny   2.25      0.411       5.48 4.21e- 8\n\n\n\n\nTable 2.13\n\n\nCode hide/show\n# Death without transplantation\ncoxph(Surv(days, status == 2) ~ tment + alb + log2bili + sex + age,\n           method = \"breslow\", data = pbc3)\n\n\nCall:\ncoxph(formula = Surv(days, status == 2) ~ tment + alb + log2bili + \n    sex + age, data = pbc3, method = \"breslow\")\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.42049   0.65672  0.26822 -1.568   0.1169\nalb      -0.06992   0.93247  0.02906 -2.406   0.0161\nlog2bili  0.69178   1.99726  0.09303  7.436 1.04e-13\nsex       0.48557   1.62510  0.31943  1.520   0.1285\nage       0.07335   1.07611  0.01621  4.524 6.06e-06\n\nLikelihood ratio test=98.71  on 5 df, p=< 2.2e-16\nn= 343, number of events= 60 \n   (6 observations deleted due to missingness)\n\n\nCode hide/show\n# Transplantation\ncoxph(Surv(days, status == 1) ~ tment + alb + log2bili + sex + age,\n           method = \"breslow\", data = pbc3) \n\n\nCall:\ncoxph(formula = Surv(days, status == 1) ~ tment + alb + log2bili + \n    sex + age, data = pbc3, method = \"breslow\")\n\n             coef exp(coef) se(coef)      z        p\ntment    -0.67305   0.51015  0.41318 -1.629   0.1033\nalb      -0.09400   0.91029  0.03871 -2.428   0.0152\nlog2bili  0.83213   2.29820  0.14655  5.678 1.36e-08\nsex       0.20378   1.22602  0.56329  0.362   0.7175\nage      -0.04805   0.95309  0.02138 -2.247   0.0246\n\nLikelihood ratio test=64.95  on 5 df, p=1.15e-12\nn= 343, number of events= 28 \n   (6 observations deleted due to missingness)\n\n\nCode hide/show\n# Failure of medical treatment\ncoxph(Surv(days, status != 0) ~ tment + alb + log2bili + sex + age,\n           method = \"breslow\", data = pbc3)\n\n\nCall:\ncoxph(formula = Surv(days, status != 0) ~ tment + alb + log2bili + \n    sex + age, data = pbc3, method = \"breslow\")\n\n             coef exp(coef) se(coef)      z       p\ntment    -0.50964   0.60071  0.22339 -2.281 0.02252\nalb      -0.07136   0.93112  0.02293 -3.112 0.00186\nlog2bili  0.73778   2.09128  0.07768  9.497 < 2e-16\nsex       0.58536   1.79563  0.26738  2.189 0.02858\nage       0.03077   1.03125  0.01199  2.566 0.01029\n\nLikelihood ratio test=134.3  on 5 df, p=< 2.2e-16\nn= 343, number of events= 88 \n   (6 observations deleted due to missingness)"
  },
  {
    "objectID": "Ch2.html#guinea-bissau-study",
    "href": "Ch2.html#guinea-bissau-study",
    "title": "1  Intuition for intensity models",
    "section": "Guinea-Bissau study",
    "text": "Guinea-Bissau study\n\nRead data\n\n\nCode hide/show\nbissau <- data.frame(read.csv(\"data/bissau.csv\"))\nbissau$agem <- as.integer(bissau$age/30.44)\n\n\n\n\nTable 2.12\n\n\nCode hide/show\nlibrary(survival)\n# Cox model in column 1\ncoxfit0 <- coxph(Surv(fuptime, dead) ~ bcg, \n                 data = bissau, method = \"breslow\")\ncoxfit0\n\n\nCall:\ncoxph(formula = Surv(fuptime, dead) ~ bcg, data = bissau, method = \"breslow\")\n\n       coef exp(coef) se(coef)      z      p\nbcg -0.2821    0.7542   0.1353 -2.085 0.0371\n\nLikelihood ratio test=4.28  on 1 df, p=0.03851\nn= 5274, number of events= 222 \n\n\nCode hide/show\n# Cox model in column 1\ncoxfit1 <- coxph(Surv(fuptime, dead) ~ bcg + agem, \n                 data = bissau, method = \"breslow\")\ncoxfit1\n\n\nCall:\ncoxph(formula = Surv(fuptime, dead) ~ bcg + agem, data = bissau, \n    method = \"breslow\")\n\n         coef exp(coef) se(coef)      z      p\nbcg  -0.35203   0.70326  0.14424 -2.441 0.0147\nagem  0.05376   1.05523  0.03856  1.394 0.1633\n\nLikelihood ratio test=6.21  on 2 df, p=0.04481\nn= 5274, number of events= 222 \n\n\nCode hide/show\n# Make age the time variable instead\nbissau$agein <- bissau$age/(365.24/12)\nbissau$ageout <- bissau$agein + bissau$fuptime/(365.24/12)\n\n# Cox model in column 2\n# option timefix=F aligns to SAS calculation\n# see vignette 'Roundoff error and tied times' for survival package\ncoxfit2 <- coxph(Surv(agein, ageout, dead) ~ bcg, \n                 data = bissau, method = \"breslow\",timefix=F)\ncoxfit2\n\n\nCall:\ncoxph(formula = Surv(agein, ageout, dead) ~ bcg, data = bissau, \n    method = \"breslow\", timefix = F)\n\n       coef exp(coef) se(coef)      z      p\nbcg -0.3558    0.7006   0.1407 -2.529 0.0114\n\nLikelihood ratio test=6.28  on 1 df, p=0.01218\nn= 5274, number of events= 222 \n\n\n\n\nFigure 2.13\n\n\nCode hide/show\n# General plotting style \nlibrary(ggplot2)\ntheme_general <- theme_bw() +\n  theme(text = element_text(size = 20), \n        axis.text.x = element_text(size = 20), \n        axis.text.y = element_text(size = 20),\n        legend.position = \"bottom\", \n        legend.title=element_blank(),\n        legend.text = element_text(size = 20),\n        legend.key.size = unit(2,\"line\")) \n\n\n# Extract cumulative baseline hazard\ncoxcumhaz <- basehaz(coxfit1, centered = FALSE)\n# Collect data for plot\ncoxdata <- data.frame(cumhaz = coxcumhaz$hazard, \n                      time = coxcumhaz$time, \n                      bcg = rep(\"1\", nrow(coxcumhaz)), \n                      type = rep(\"Breslow estimate\", nrow(coxcumhaz)))\n\n# Create figure\nfig2.13 <- ggplot(aes(x = time / (365.24/12), y = cumhaz), data = coxdata) + \n  geom_step(size = 1) + \n  xlab(\"Follow-up time (months)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     breaks = seq(0, 7, by = 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.05))) +\n  theme_general\n\nfig2.13\n\n\n\n\n\n\n\nFigure 2.14\n\n\nCode hide/show\n# Extract cumulative baseline hazard\ncoxcumhaz <- basehaz(coxfit2, centered = FALSE)\n# Collect data for plot\ncoxdata <- data.frame(cumhaz = coxcumhaz$hazard, \n                      time = coxcumhaz$time, \n                      bcg = rep(\"1\", nrow(coxcumhaz)), \n                      type = rep(\"Breslow estimate\", nrow(coxcumhaz)))\n\n# Create figure\nfig2.14 <- ggplot(aes(x = time, y = cumhaz), data = coxdata) + \n  geom_step(size = 1) + \n  xlab(\"Age (months)\") + \n  ylab(\"Cumulative hazard\") + \n  scale_x_continuous(expand = expansion(mult = c(0.005, 0.05)), \n                     breaks = seq(0, 15, by = 1)) + \n  scale_y_continuous(expand = expansion(mult = c(0.005, 0.1)), \n                     breaks = seq(0, 0.15, by = 0.05), \n                     labels = c(\"0\", \"0.05\", \"0.10\", \"0.15\")) +\n  theme_general\n\nfig2.14"
  },
  {
    "objectID": "Ch2.html#recurrent-episodes-in-affective-disorders",
    "href": "Ch2.html#recurrent-episodes-in-affective-disorders",
    "title": "1  Intuition for intensity models",
    "section": "Recurrent episodes in affective disorders",
    "text": "Recurrent episodes in affective disorders\n\nRead data\n\n\nCode hide/show\naffective <- data.frame(read.csv(\"data/affective.csv\"))\naffective$wait <- with(affective, stop - start)\n\n\n\n\nTable 2.14\n\n\nCode hide/show\n# Cox model for 1., 2., 3., 4. episode 'Markov': Column 1\nlibrary(survival)\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 1 & state == 0))\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 1 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.3552    1.4264   0.2500 1.421 0.155\n\nLikelihood ratio test=1.89  on 1 df, p=0.1692\nn= 116, number of events= 99 \n\n\nCode hide/show\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 2 & state == 0))\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 2 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.1890    1.2080   0.2604 0.726 0.468\n\nLikelihood ratio test=0.51  on 1 df, p=0.4751\nn= 91, number of events= 82 \n\n\nCode hide/show\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 3 & state == 0)) \n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 3 & state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)      z     p\nbip -0.1175    0.8891   0.3005 -0.391 0.696\n\nLikelihood ratio test=0.16  on 1 df, p=0.6936\nn= 74, number of events= 62 \n\n\nCode hide/show\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 4 & state == 0)) \n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    episode == 4 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z       p\nbip 1.1500    3.1581   0.3536 3.252 0.00114\n\nLikelihood ratio test=9.93  on 1 df, p=0.001623\nn= 56, number of events= 47 \n\n\nCode hide/show\n# Cox model for 1., 2., 3., 4. episode 'Gap time': Column 2\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, episode == 1 & state == 0)) \n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 1 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.3991    1.4905   0.2487 1.605 0.109\n\nLikelihood ratio test=2.39  on 1 df, p=0.1222\nn= 116, number of events= 99 \n\n\nCode hide/show\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                     data = subset(affective, episode == 2 & state == 0))\n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 2 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)    z     p\nbip 0.2165    1.2418   0.2579 0.84 0.401\n\nLikelihood ratio test=0.68  on 1 df, p=0.41\nn= 91, number of events= 82 \n\n\nCode hide/show\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                     data = subset(affective, episode == 3 & state == 0)) \n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 3 & state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)      z     p\nbip -0.1114    0.8946   0.2867 -0.389 0.698\n\nLikelihood ratio test=0.15  on 1 df, p=0.6953\nn= 74, number of events= 62 \n\n\nCode hide/show\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                     data = subset(affective, episode == 4 & state == 0)) \n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    episode == 4 & state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.5964    1.8155   0.3183 1.874 0.061\n\nLikelihood ratio test=3.31  on 1 df, p=0.06905\nn= 56, number of events= 47 \n\n\nCode hide/show\n# AG cox model, total time\ncoxph(Surv(start, stop, status == 1) ~ bip, method = \"breslow\",\n                        data = subset(affective, state == 0))\n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ bip, data = subset(affective, \n    state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)     z        p\nbip 0.36593   1.44186  0.09448 3.873 0.000107\n\nLikelihood ratio test=14.24  on 1 df, p=0.0001612\nn= 626, number of events= 542 \n\n\nCode hide/show\n# AG cox model, gap time\ncoxph(Surv(wait, status == 1) ~ bip, method = \"breslow\",\n                   data = subset(affective, state == 0))\n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ bip, data = subset(affective, \n    state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)     z     p\nbip 0.12555   1.13377  0.09445 1.329 0.184\n\nLikelihood ratio test=1.74  on 1 df, p=0.1875\nn= 626, number of events= 542 \n\n\nCode hide/show\n# PWP cox model, total time\ncoxph(Surv(start, stop, status == 1) ~ strata(episode) + bip, method = \"breslow\",\n                   data = subset(affective, state == 0)) \n\n\nCall:\ncoxph(formula = Surv(start, stop, status == 1) ~ strata(episode) + \n    bip, data = subset(affective, state == 0), method = \"breslow\")\n\n      coef exp(coef) se(coef)     z     p\nbip 0.2418    1.2736   0.1121 2.157 0.031\n\nLikelihood ratio test=4.54  on 1 df, p=0.03312\nn= 626, number of events= 542 \n\n\nCode hide/show\n# PWP cox model, gap time\ncoxph(Surv(wait, status == 1) ~ strata(episode) + bip, method = \"breslow\", \n                    data = subset(affective, state == 0)) \n\n\nCall:\ncoxph(formula = Surv(wait, status == 1) ~ strata(episode) + bip, \n    data = subset(affective, state == 0), method = \"breslow\")\n\n       coef exp(coef) se(coef)     z     p\nbip 0.02781   1.02820  0.10040 0.277 0.782\n\nLikelihood ratio test=0.08  on 1 df, p=0.7821\nn= 626, number of events= 542"
  },
  {
    "objectID": "Ch2.html#exercises",
    "href": "Ch2.html#exercises",
    "title": "1  Intuition for intensity models",
    "section": "Exercises",
    "text": "Exercises\n\nExercise 2.1"
  }
]