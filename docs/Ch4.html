<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Models for Multi-State Survival Data - 4&nbsp; Intuition for marginal models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Ch5.html" rel="next">
<link href="./Ch3.html" rel="prev">
<link href="./corvos.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Intuition for marginal models</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./MSBfrontbirds.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./"></a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/multi-state-book/companion" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction and data sets</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch2.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Intuition for intensity models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Intensity models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch4.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Intuition for marginal models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch5.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Marginal models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch6.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Pseudo-values</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Ch7.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Further topics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./errata.html" class="sidebar-item-text sidebar-link">Errata</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#pbc3-trial-in-liver-cirrhosis" id="toc-pbc3-trial-in-liver-cirrhosis" class="nav-link active" data-scroll-target="#pbc3-trial-in-liver-cirrhosis">PBC3 trial in liver cirrhosis</a>
  <ul>
  <li><a href="#read-data" id="toc-read-data" class="nav-link" data-scroll-target="#read-data">Read data</a></li>
  <li><a href="#figure-4.2" id="toc-figure-4.2" class="nav-link" data-scroll-target="#figure-4.2">Figure 4.2</a></li>
  <li><a href="#in-text-kaplan-meier-estimates-at-2-years" id="toc-in-text-kaplan-meier-estimates-at-2-years" class="nav-link" data-scroll-target="#in-text-kaplan-meier-estimates-at-2-years">In-text: Kaplan-Meier estimates at 2 years</a></li>
  <li><a href="#figure-4.4" id="toc-figure-4.4" class="nav-link" data-scroll-target="#figure-4.4">Figure 4.4</a></li>
  <li><a href="#figure-4.5" id="toc-figure-4.5" class="nav-link" data-scroll-target="#figure-4.5">Figure 4.5</a></li>
  <li><a href="#figure-4.6" id="toc-figure-4.6" class="nav-link" data-scroll-target="#figure-4.6">Figure 4.6</a></li>
  <li><a href="#figure-4.7" id="toc-figure-4.7" class="nav-link" data-scroll-target="#figure-4.7">Figure 4.7</a></li>
  <li><a href="#in-text-g-formula-from-cox" id="toc-in-text-g-formula-from-cox" class="nav-link" data-scroll-target="#in-text-g-formula-from-cox">In-text: g-formula from Cox</a></li>
  <li><a href="#figure-4.8" id="toc-figure-4.8" class="nav-link" data-scroll-target="#figure-4.8">Figure 4.8</a></li>
  <li><a href="#table-4.1" id="toc-table-4.1" class="nav-link" data-scroll-target="#table-4.1">Table 4.1</a></li>
  <li><a href="#figure-4.10" id="toc-figure-4.10" class="nav-link" data-scroll-target="#figure-4.10">Figure 4.10</a></li>
  <li><a href="#figure-4.11" id="toc-figure-4.11" class="nav-link" data-scroll-target="#figure-4.11">Figure 4.11</a></li>
  <li><a href="#figure-4.12" id="toc-figure-4.12" class="nav-link" data-scroll-target="#figure-4.12">Figure 4.12</a></li>
  <li><a href="#table-4.2" id="toc-table-4.2" class="nav-link" data-scroll-target="#table-4.2">Table 4.2</a></li>
  <li><a href="#table-4.4" id="toc-table-4.4" class="nav-link" data-scroll-target="#table-4.4">Table 4.4</a></li>
  <li><a href="#in-text-rmst-g-formula-and-bootstrap" id="toc-in-text-rmst-g-formula-and-bootstrap" class="nav-link" data-scroll-target="#in-text-rmst-g-formula-and-bootstrap">In-text: RMST g-formula and bootstrap</a></li>
  <li><a href="#table-4.5" id="toc-table-4.5" class="nav-link" data-scroll-target="#table-4.5">Table 4.5</a></li>
  <li><a href="#in-text-fine-gray-and-g-formula" id="toc-in-text-fine-gray-and-g-formula" class="nav-link" data-scroll-target="#in-text-fine-gray-and-g-formula">In-text: Fine-Gray and g-formula</a></li>
  <li><a href="#figure-4.17" id="toc-figure-4.17" class="nav-link" data-scroll-target="#figure-4.17">Figure 4.17</a></li>
  <li><a href="#table-4.6" id="toc-table-4.6" class="nav-link" data-scroll-target="#table-4.6">Table 4.6</a></li>
  <li><a href="#in-text-time-lost-g-formula-and-bootstrap" id="toc-in-text-time-lost-g-formula-and-bootstrap" class="nav-link" data-scroll-target="#in-text-time-lost-g-formula-and-bootstrap">In-text: Time lost g-formula and bootstrap</a></li>
  <li><a href="#figure-4.21" id="toc-figure-4.21" class="nav-link" data-scroll-target="#figure-4.21">Figure 4.21</a></li>
  <li><a href="#in-text-cox-for-censoring" id="toc-in-text-cox-for-censoring" class="nav-link" data-scroll-target="#in-text-cox-for-censoring">In-text: Cox for censoring</a></li>
  </ul></li>
  <li><a href="#prova-trial-in-liver-cirrhosis" id="toc-prova-trial-in-liver-cirrhosis" class="nav-link" data-scroll-target="#prova-trial-in-liver-cirrhosis">PROVA trial in liver cirrhosis</a>
  <ul>
  <li><a href="#read-data-1" id="toc-read-data-1" class="nav-link" data-scroll-target="#read-data-1">Read data</a></li>
  <li><a href="#figure-4.22" id="toc-figure-4.22" class="nav-link" data-scroll-target="#figure-4.22">Figure 4.22</a></li>
  <li><a href="#table-4.12" id="toc-table-4.12" class="nav-link" data-scroll-target="#table-4.12">Table 4.12</a></li>
  </ul></li>
  <li><a href="#recurrent-episodes-in-affective-disorders" id="toc-recurrent-episodes-in-affective-disorders" class="nav-link" data-scroll-target="#recurrent-episodes-in-affective-disorders">Recurrent episodes in affective disorders</a>
  <ul>
  <li><a href="#read-data-2" id="toc-read-data-2" class="nav-link" data-scroll-target="#read-data-2">Read data</a></li>
  <li><a href="#table-4.3" id="toc-table-4.3" class="nav-link" data-scroll-target="#table-4.3">Table 4.3</a></li>
  <li><a href="#figure-4.16" id="toc-figure-4.16" class="nav-link" data-scroll-target="#figure-4.16">Figure 4.16</a></li>
  <li><a href="#table-4.7" id="toc-table-4.7" class="nav-link" data-scroll-target="#table-4.7">Table 4.7</a></li>
  <li><a href="#figure-4.18" id="toc-figure-4.18" class="nav-link" data-scroll-target="#figure-4.18">Figure 4.18</a></li>
  <li><a href="#figure-4.19" id="toc-figure-4.19" class="nav-link" data-scroll-target="#figure-4.19">Figure 4.19</a></li>
  <li><a href="#table-4.9" id="toc-table-4.9" class="nav-link" data-scroll-target="#table-4.9">Table 4.9</a></li>
  <li><a href="#table-4.10" id="toc-table-4.10" class="nav-link" data-scroll-target="#table-4.10">Table 4.10</a></li>
  <li><a href="#figure-4.23" id="toc-figure-4.23" class="nav-link" data-scroll-target="#figure-4.23">Figure 4.23</a></li>
  <li><a href="#in-text-cox-for-censoring-1" id="toc-in-text-cox-for-censoring-1" class="nav-link" data-scroll-target="#in-text-cox-for-censoring-1">In-text: Cox for censoring</a></li>
  </ul></li>
  <li><a href="#leader-cardiovascular-trial-in-type-2-diabetes" id="toc-leader-cardiovascular-trial-in-type-2-diabetes" class="nav-link" data-scroll-target="#leader-cardiovascular-trial-in-type-2-diabetes">LEADER cardiovascular trial in type 2 diabetes</a>
  <ul>
  <li><a href="#figure-4.20" id="toc-figure-4.20" class="nav-link" data-scroll-target="#figure-4.20">Figure 4.20</a></li>
  <li><a href="#in-text-lwyy-and-ghosh-lin-models" id="toc-in-text-lwyy-and-ghosh-lin-models" class="nav-link" data-scroll-target="#in-text-lwyy-and-ghosh-lin-models">In-text: LWYY and Ghosh-Lin models</a></li>
  </ul></li>
  <li><a href="#bone-marrow-transplantation-in-acute-leukemia" id="toc-bone-marrow-transplantation-in-acute-leukemia" class="nav-link" data-scroll-target="#bone-marrow-transplantation-in-acute-leukemia">Bone marrow transplantation in acute leukemia</a>
  <ul>
  <li><a href="#read-data-3" id="toc-read-data-3" class="nav-link" data-scroll-target="#read-data-3">Read data</a></li>
  <li><a href="#figure-4.15" id="toc-figure-4.15" class="nav-link" data-scroll-target="#figure-4.15">Figure 4.15</a></li>
  <li><a href="#in-text-p.-133-expected-time-lost" id="toc-in-text-p.-133-expected-time-lost" class="nav-link" data-scroll-target="#in-text-p.-133-expected-time-lost">In-text p.&nbsp;133: Expected time lost</a></li>
  <li><a href="#table-4.8" id="toc-table-4.8" class="nav-link" data-scroll-target="#table-4.8">Table 4.8</a></li>
  <li><a href="#table-4.11" id="toc-table-4.11" class="nav-link" data-scroll-target="#table-4.11">Table 4.11</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul>
  <li><a href="#exercise-4.1" id="toc-exercise-4.1" class="nav-link" data-scroll-target="#exercise-4.1">Exercise 4.1</a></li>
  <li><a href="#exercise-4.2" id="toc-exercise-4.2" class="nav-link" data-scroll-target="#exercise-4.2">Exercise 4.2</a>
  <ul>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section">1.</a></li>
  <li><a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1">2.</a></li>
  </ul></li>
  <li><a href="#exercise-4.3" id="toc-exercise-4.3" class="nav-link" data-scroll-target="#exercise-4.3">Exercise 4.3</a></li>
  <li><a href="#exercise-4.4" id="toc-exercise-4.4" class="nav-link" data-scroll-target="#exercise-4.4">Exercise 4.4</a></li>
  <li><a href="#exercise-4.5" id="toc-exercise-4.5" class="nav-link" data-scroll-target="#exercise-4.5">Exercise 4.5</a>
  <ul>
  <li><a href="#section-2" id="toc-section-2" class="nav-link" data-scroll-target="#section-2">1.</a></li>
  <li><a href="#section-3" id="toc-section-3" class="nav-link" data-scroll-target="#section-3">2.</a></li>
  </ul></li>
  <li><a href="#exercise-4.6" id="toc-exercise-4.6" class="nav-link" data-scroll-target="#exercise-4.6">Exercise 4.6</a></li>
  <li><a href="#exercise-4.7" id="toc-exercise-4.7" class="nav-link" data-scroll-target="#exercise-4.7">Exercise 4.7</a>
  <ul>
  <li><a href="#section-4" id="toc-section-4" class="nav-link" data-scroll-target="#section-4">1.</a></li>
  <li><a href="#section-5" id="toc-section-5" class="nav-link" data-scroll-target="#section-5">2.</a></li>
  <li><a href="#section-6" id="toc-section-6" class="nav-link" data-scroll-target="#section-6">3.</a></li>
  </ul></li>
  <li><a href="#exercise-4.8" id="toc-exercise-4.8" class="nav-link" data-scroll-target="#exercise-4.8">Exercise 4.8</a>
  <ul>
  <li><a href="#section-7" id="toc-section-7" class="nav-link" data-scroll-target="#section-7">1.</a></li>
  <li><a href="#section-8" id="toc-section-8" class="nav-link" data-scroll-target="#section-8">2.</a></li>
  </ul></li>
  <li><a href="#exercise-4.9" id="toc-exercise-4.9" class="nav-link" data-scroll-target="#exercise-4.9">Exercise 4.9</a>
  <ul>
  <li><a href="#section-9" id="toc-section-9" class="nav-link" data-scroll-target="#section-9">1.</a></li>
  <li><a href="#section-10" id="toc-section-10" class="nav-link" data-scroll-target="#section-10">2.</a></li>
  </ul></li>
  <li><a href="#exercise-4.10" id="toc-exercise-4.10" class="nav-link" data-scroll-target="#exercise-4.10">Exercise 4.10</a>
  <ul>
  <li><a href="#section-11" id="toc-section-11" class="nav-link" data-scroll-target="#section-11">1.</a></li>
  <li><a href="#section-12" id="toc-section-12" class="nav-link" data-scroll-target="#section-12">2.</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/multi-state-book/companion/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Intuition for marginal models</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Show/hide all code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- {{< include R/chapter4_figure_4_3.qmd >}} -->
<section id="pbc3-trial-in-liver-cirrhosis" class="level2">
<h2 class="anchored" data-anchor-id="pbc3-trial-in-liver-cirrhosis">PBC3 trial in liver cirrhosis</h2>
<section id="read-data" class="level3">
<h3 class="anchored" data-anchor-id="read-data">Read data</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell" data-hash="Ch4_cache/html/read-pbc3-r_7c1fcd153f83632c61310ea0ae1e9000">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pbc3 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/pbc3.csv"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>followup<span class="ot">&lt;-</span>pbc3<span class="sc">$</span>days<span class="sc">/</span><span class="fl">365.25</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>fail <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pbc3<span class="sc">$</span>status <span class="sc">!=</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="co"># event/failure indicator</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>tment_char <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pbc3<span class="sc">$</span>tment <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"Placebo"</span>, <span class="st">"CyA"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add transformations of covariates </span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>albnorm <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, (alb<span class="dv">-35</span>)<span class="sc">*</span>(alb<span class="sc">&gt;</span><span class="dv">35</span>))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>alb10 <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, alb<span class="sc">/</span><span class="dv">10</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>alb2 <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, alb10<span class="sc">*</span>alb10)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>bilihigh <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, (bili<span class="fl">-17.1</span>)<span class="sc">*</span>(bili<span class="sc">&gt;</span><span class="fl">17.1</span>))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>bilitoohigh <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, (bili<span class="fl">-34.2</span>)<span class="sc">*</span>(bili<span class="sc">&gt;</span><span class="fl">34.2</span>))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>bilimuchtoohigh <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, (bili<span class="fl">-51.3</span>)<span class="sc">*</span>(bili<span class="sc">&gt;</span><span class="fl">51.3</span>))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>bili100 <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, bili<span class="sc">/</span><span class="dv">100</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>bili2 <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, bili100<span class="sc">*</span>bili100)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>log2bili <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, <span class="fu">log2</span>(bili))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>log2bili2 <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, log2bili<span class="sc">*</span>log2bili)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>logbilihigh <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, (log2bili<span class="sc">-</span><span class="fu">log2</span>(<span class="fl">17.1</span>))<span class="sc">*</span>(bili<span class="sc">&gt;</span><span class="fl">17.1</span>))</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>logbilitoohigh <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, (log2bili<span class="sc">-</span><span class="fu">log2</span>(<span class="fl">34.2</span>))<span class="sc">*</span>(bili<span class="sc">&gt;</span><span class="fl">34.2</span>))</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>logbilimuchtoohigh <span class="ot">&lt;-</span> <span class="fu">with</span>(pbc3, (log2bili<span class="sc">-</span><span class="fu">log2</span>(<span class="fl">51.3</span>))<span class="sc">*</span>(bili<span class="sc">&gt;</span><span class="fl">51.3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell" data-hash="Ch4_cache/html/read-pbc3-sas_12b0a8e0426e6a8092e27dd260051eff">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> import out=pbc3</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    datafile=<span class="st">"data/pbc3.csv"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    dbms=csv <span class="kw">replace</span>;</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> pbc3; </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> pbc3;</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    followup=days/<span class="dv">365.25</span>; <span class="co">/* time in years */</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    albnorm=(alb<span class="dv">-35</span>)*(alb&gt;<span class="dv">35</span>);</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    alb10=alb/<span class="dv">10</span>; alb2=alb10*alb10;</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    bilihigh=(bili<span class="dv">-17.1</span>)*(bili&gt;<span class="dv">17.1</span>);</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    bilitoohigh=(bili<span class="dv">-34.2</span>)*(bili&gt;<span class="dv">34.2</span>);</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    bilimuchtoohigh=(bili<span class="dv">-51.3</span>)*(bili&gt;<span class="dv">51.3</span>);</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    bili100=bili/<span class="dv">100</span>; bili2=bili100*bili100;</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    log2bili=<span class="fu">log2</span>(bili);</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    logbilihigh=(log2bili-<span class="fu">log2</span>(<span class="dv">17.1</span>))*(bili&gt;<span class="dv">17.1</span>);</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    logbilitoohigh=(log2bili-<span class="fu">log2</span>(<span class="dv">34.2</span>))*(bili&gt;<span class="dv">34.2</span>);</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    logbilimuchtoohigh=(log2bili-<span class="fu">log2</span>(<span class="dv">51.3</span>))*(bili&gt;<span class="dv">51.3</span>);</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    log2bili2=log2bili*log2bili;</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.2" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.2">Figure 4.2</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.2-r_6bfd041db598a506f548be9946ea8136">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># General plotting style </span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>, </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title=</span><span class="fu">element_blank</span>(),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">2</span>,<span class="st">"line"</span>))</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Kaplan-Meier estimate per treatment</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Please note conf.type="log-log"</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>kmfit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(days, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> tment, <span class="at">data =</span> pbc3, <span class="at">conf.type=</span><span class="st">"log-log"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect data for plot</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the standard errors produced by survfit are for the cumulative hazard</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>kmdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">surv =</span> kmfit<span class="sc">$</span>surv, </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">time =</span> kmfit<span class="sc">$</span>time, </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                     <span class="at">tment =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">names</span>(kmfit<span class="sc">$</span>strata)[<span class="dv">1</span>], kmfit<span class="sc">$</span>strata[<span class="dv">1</span>]), </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">rep</span>(<span class="fu">names</span>(kmfit<span class="sc">$</span>strata)[<span class="dv">2</span>], kmfit<span class="sc">$</span>strata[<span class="dv">2</span>])))</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure 4.2</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> surv, <span class="at">linetype =</span> tment), <span class="at">data =</span> kmdata) <span class="sc">+</span> </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Treatment"</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Placebo"</span>, <span class="st">"CyA"</span>)) <span class="sc">+</span> </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Survival probability"</span>) <span class="sc">+</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.2-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.2-sas_5f1f8c0e12299e5153a6688482b03a82">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">* Kaplan-Meier plot per treatment;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">* Using proc lifetest;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> lifetest<span class="kw"> data</span>=pbc3 notable plots=(survival(nocensor));</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">time</span> followup*status(<span class="dv">0</span>);</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    strata tment;</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">* Using proc phreg;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span>)=;</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    strata tment;</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    baseline out=survdat survival=km / method=pl;</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> survdat;</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> survdat; </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    daysyears = days/<span class="dv">365.25</span>; </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=survdat;</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>plot km*daysyears=tment/haxis=axis1 vaxis=axis2;</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Survival probability'</span>);</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=red;</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=blue;</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="in-text-kaplan-meier-estimates-at-2-years" class="level3">
<h3 class="anchored" data-anchor-id="in-text-kaplan-meier-estimates-at-2-years">In-text: Kaplan-Meier estimates at 2 years</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-KM2yr-r_23e30eafcab5270ec6387387b085b5a6">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 95 c.i. uses conf.type="log-log" - see above</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(kmfit,<span class="at">times=</span><span class="dv">2</span><span class="sc">*</span><span class="fl">365.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(days, status != 0) ~ tment, data = pbc3, 
    conf.type = "log-log")

                tment=0 
        time       n.risk      n.event     survival      std.err lower 95% CI 
    730.5000     106.0000      27.0000       0.8322       0.0296       0.7645 
upper 95% CI 
      0.8819 

                tment=1 
        time       n.risk      n.event     survival      std.err lower 95% CI 
    730.5000     111.0000      24.0000       0.8458       0.0292       0.7782 
upper 95% CI 
      0.8941 </code></pre>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-KM2yr-sas_fa48a0f18a59177a50fe7c95de6c3bba">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> lifetest<span class="kw"> data</span>=pbc3 timelist=<span class="dv">2</span>;</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">time</span> followup*status(<span class="dv">0</span>);</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  strata tment;</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> print<span class="kw"> data</span>=survdat;</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> days&lt;=<span class="dv">2</span>*<span class="dv">365.25</span>;</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.4" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.4">Figure 4.4</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.4-r_e412851031a773eb45daef2a5a42110b">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Poisson model fit (like in Chapter 2)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Cuts</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>cuts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>) <span class="sc">*</span> <span class="fl">365.25</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># event/failure indicator</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>fail <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pbc3<span class="sc">$</span>status <span class="sc">!=</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the data ready using survSplit</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>pbc3mult <span class="ot">&lt;-</span> <span class="fu">survSplit</span>(<span class="fu">Surv</span>(days, fail) <span class="sc">~</span> ., </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                      pbc3,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cut =</span> cuts[<span class="sc">-</span><span class="dv">1</span>], </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">episode =</span> <span class="st">"timegroup"</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Risk time</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>pbc3mult<span class="sc">$</span>risktime <span class="ot">&lt;-</span> pbc3mult<span class="sc">$</span>days <span class="sc">-</span> cuts[pbc3mult<span class="sc">$</span>timegroup] </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>sumdata <span class="ot">&lt;-</span> pbc3mult <span class="sc">%&gt;%</span> </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(tment, timegroup) <span class="sc">%&gt;%</span> </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">fail =</span> <span class="fu">sum</span>(fail), </span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">risktime =</span> <span class="fu">sum</span>(days <span class="sc">-</span> cuts[timegroup])<span class="co">#,</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>            <span class="co">#logrisktime = sum(log(days))</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>sumdata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(sumdata)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Placebo KM data from figure 4.2 model fit</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>tment1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(kmdata, tment <span class="sc">==</span> <span class="st">"tment=1"</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated hazard per time group</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>sumdata<span class="sc">$</span>hazard_timegroup <span class="ot">&lt;-</span> sumdata<span class="sc">$</span>fail <span class="sc">/</span> sumdata<span class="sc">$</span>risktime</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a numeric version of the treatment to the NA estimates</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>kmdata<span class="sc">$</span>tmentnum <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(kmdata<span class="sc">$</span>tment <span class="sc">==</span> <span class="st">"tment=0"</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Add piecewise constant hazard to data</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>kmdata<span class="sc">$</span>pwch <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Between time 0 and 2</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>kmdata<span class="sc">$</span>pwch[kmdata<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">365.25</span>] <span class="ot">&lt;-</span> kmdata<span class="sc">$</span>time[kmdata<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">2</span>  <span class="sc">*</span> <span class="fl">365.25</span>] <span class="sc">*</span> </span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  (sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">1</span>] <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">2</span>  <span class="sc">*</span> <span class="fl">365.25</span>]) <span class="sc">+</span> </span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>     sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">4</span>] <span class="sc">*</span> (kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">365.25</span>]))</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Between time 2 and 4</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>kmdata<span class="sc">$</span>pwch[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">2</span>  <span class="sc">*</span> <span class="fl">365.25</span> <span class="sc">&amp;</span> kmdata<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>] <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="sc">*</span> <span class="fl">365.25</span> <span class="sc">*</span> </span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>  (sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">1</span>]</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>   <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">2</span>  <span class="sc">*</span> <span class="fl">365.25</span><span class="sc">&amp;</span> kmdata<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>]) <span class="sc">+</span> </span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>     sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">4</span>] </span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>   <span class="sc">*</span> (kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">2</span>  <span class="sc">*</span> <span class="fl">365.25</span><span class="sc">&amp;</span> kmdata<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>])) <span class="sc">+</span> </span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>  (kmdata<span class="sc">$</span>time[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">365.25</span> <span class="sc">&amp;</span> kmdata<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>] <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">365.25</span>) <span class="sc">*</span> </span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>  (sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">2</span>] </span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>   <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">2</span>  <span class="sc">*</span> <span class="fl">365.25</span><span class="sc">&amp;</span> kmdata<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>]) <span class="sc">+</span> </span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>     sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">5</span>] </span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>   <span class="sc">*</span> (kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">365.25</span> <span class="sc">&amp;</span> kmdata<span class="sc">$</span>time <span class="sc">&lt;=</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>]))</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="co"># After time 4</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>kmdata<span class="sc">$</span>pwch[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>] <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">365.25</span> <span class="sc">*</span> </span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>  (sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">1</span>] <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>]) <span class="sc">+</span> </span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>     sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">4</span>] <span class="sc">*</span> (kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>])) <span class="sc">+</span> </span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span> <span class="sc">*</span> <span class="fl">365.25</span> <span class="sc">*</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>  (sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">2</span>] <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>]) <span class="sc">+</span> </span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>     sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">5</span>] <span class="sc">*</span> (kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>])) <span class="sc">+</span> </span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>  (kmdata<span class="sc">$</span>time[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>] <span class="sc">-</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>) <span class="sc">*</span> </span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>  (sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">3</span>] <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>]) <span class="sc">+</span> </span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>     sumdata<span class="sc">$</span>hazard_timegroup[<span class="dv">6</span>] <span class="sc">*</span> (kmdata<span class="sc">$</span>tmentnum[kmdata<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">*</span> <span class="fl">365.25</span>]))</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Change to estimated survival (plug-in formula)</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>kmdata<span class="sc">$</span>pwcs <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>kmdata<span class="sc">$</span>pwch)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Reformat for plot</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>piecepdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">surv =</span> <span class="fu">c</span>(kmdata<span class="sc">$</span>surv, kmdata<span class="sc">$</span>pwcs), </span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>                         <span class="at">time =</span> <span class="fu">rep</span>(kmdata<span class="sc">$</span>time, <span class="dv">2</span>),</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>                         <span class="at">tmentnum =</span> <span class="fu">rep</span>(kmdata<span class="sc">$</span>tmentnum, <span class="dv">2</span>),</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Kaplan-Meier"</span>, <span class="fu">length</span>(kmdata<span class="sc">$</span>time)), </span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">rep</span>(<span class="st">"Piece-wise exponential"</span>, <span class="fu">length</span>(kmdata<span class="sc">$</span>time))))</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Only for treatment 1</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>piecepdata1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(piecepdata, tmentnum <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure 4.4</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.4</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> surv, <span class="at">linetype =</span> type), </span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> <span class="fu">subset</span>(piecepdata1, type <span class="sc">==</span> <span class="st">"Kaplan-Meier"</span>)) <span class="sc">+</span> </span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time<span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> surv, <span class="at">linetype =</span> type), <span class="at">linewidth =</span> <span class="dv">1</span>,</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> <span class="fu">subset</span>(piecepdata1, type <span class="sc">==</span> <span class="st">"Piece-wise exponential"</span>)) <span class="sc">+</span> </span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">linetype =</span> <span class="st">"Type"</span>) <span class="sc">+</span> </span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Survival probability"</span>) <span class="sc">+</span> </span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>),</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.4-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.4-sas_f0c2166e42bb25af952d951cc2275efd">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> survdat; </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> survdat;</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> days&lt;=<span class="dv">2</span> * <span class="dv">365.25</span> <span class="kw">then</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    pwch=<span class="fu">exp</span>(-(days*(<span class="dv">27.0000000</span>/<span class="dv">104856</span>*(<span class="dv">1</span>-tment)+<span class="dv">24.0000000</span>/<span class="dv">107931.5</span>*tment)));</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="dv">2</span> * <span class="dv">365.25</span> &lt;days&lt;=<span class="dv">4</span> * <span class="dv">365.25</span> <span class="kw">then</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    pwch=<span class="fu">exp</span>(-(<span class="dv">2</span>* <span class="dv">365.25</span>*(<span class="dv">27.0000000</span>/<span class="dv">104856</span>*(<span class="dv">1</span>-tment)+<span class="dv">24.0000000</span>/<span class="dv">107931.5</span>*tment)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    +(days<span class="dv">-2</span>* <span class="dv">365.25</span>)*(<span class="dv">17.0000000</span>/<span class="dv">49673</span>*(<span class="dv">1</span>-tment)+<span class="dv">18.0000000</span>/<span class="dv">50284</span>*tment)));</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="dv">4</span> * <span class="dv">365.25</span> &lt;days <span class="kw">then</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    pwch=<span class="fu">exp</span>(-(<span class="dv">2</span>* <span class="dv">365.25</span> *(<span class="dv">27.0000000</span>/<span class="dv">104856</span>*(<span class="dv">1</span>-tment)+<span class="dv">24.0000000</span>/<span class="dv">107931.5</span>*tment)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    +(<span class="dv">2</span>* <span class="dv">365.25</span>)*(<span class="dv">17.0000000</span>/<span class="dv">49673</span>*(<span class="dv">1</span>-tment)+<span class="dv">18.0000000</span>/<span class="dv">50284</span>*tment)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    +(days<span class="dv">-4</span>* <span class="dv">365.25</span>)*(<span class="dv">2.0000000</span>/<span class="dv">8642</span>*(<span class="dv">1</span>-tment)+<span class="dv">2.0000000</span>/<span class="dv">7599</span>*tment)));</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> survdat;</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> survdat; </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    daysyears = days/<span class="dv">365.25</span>; </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=survdat; </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> tment=<span class="dv">1</span>;</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    plot (km pwch)*daysyears/overlay haxis=axis1 vaxis=axis2;</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Survival probability'</span>);</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl r=<span class="dv">1</span> c=red;</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    symbol2 v=none i=join r=<span class="dv">1</span> c=blue;</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.5" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.5">Figure 4.5</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.5-r_7dceccd5492ae45fe9d4c992aa024cdb">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>coxfit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili, <span class="at">data =</span> pbc3, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Unique days times </span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>fu <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(pbc3<span class="sc">$</span>days))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Data for prediction</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>preddata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(fu)), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(fu))), </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alb =</span> <span class="fu">rep</span>(<span class="dv">38</span>, <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">log2bili =</span> <span class="fu">rep</span>(<span class="fu">log2</span>(<span class="dv">45</span>), <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>), </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">days =</span> <span class="fu">c</span>(fu, fu),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">status =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>))</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear predictor</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(coxfit, <span class="at">newdata =</span> preddata, <span class="at">type =</span> <span class="st">"survival"</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>preddata<span class="sc">$</span>preds <span class="ot">&lt;-</span> preds</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure 4.5</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.5</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> days <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> preds, <span class="at">linetype =</span> <span class="fu">as.factor</span>(tment)), </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> preddata) <span class="sc">+</span> </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Treatment"</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Placebo"</span>, <span class="st">"CyA"</span>)) <span class="sc">+</span> </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Estimated survival function"</span>) <span class="sc">+</span> </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>),</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  theme_general </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.5-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.5-sas_c14c4c587ded004a7ce1b7723efa9790">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    tment=<span class="dv">0</span>; alb=<span class="dv">38</span>; log2bili=<span class="fu">log2</span>(<span class="dv">45</span>); <span class="kw">output</span>;</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    tment=<span class="dv">1</span>; alb=<span class="dv">38</span>; log2bili=<span class="fu">log2</span>(<span class="dv">45</span>); <span class="kw">output</span>;</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span>)=tment alb log2bili/rl;</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    baseline out=predsurv survival=surv covariates=cov/ method=breslow;</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> predsurv;</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> predsurv; </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    daysyears = days/<span class="dv">365.25</span>; </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=predsurv;</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    plot surv*daysyears=tment/haxis=axis1 vaxis=axis2;</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Estimated survival function'</span>);</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.6" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.6">Figure 4.6</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.6-r_3cd503b5daf57c26c736452faa023ecb">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add log(-log(S(t)))</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>preddata<span class="sc">$</span>logminlogsurv <span class="ot">&lt;-</span> <span class="fu">with</span>(preddata, <span class="fu">log</span>(<span class="sc">-</span><span class="fu">log</span>(preds)))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure 4.6</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.6</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> days <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> logminlogsurv, <span class="at">linetype =</span> <span class="fu">as.factor</span>(tment)), </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> preddata) <span class="sc">+</span> </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Treatment"</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Placebo"</span>, <span class="st">"CyA"</span>)) <span class="sc">+</span> </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"log(-log(survival function))"</span>) <span class="sc">+</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>),</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>))) <span class="sc">+</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.6-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.6-sas_4ba8935174429a11f2fd670bf014af26">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> predsurv2; </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> predsurv; </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    logminlogsurv = <span class="fu">log</span>(-<span class="fu">log</span>(surv)); </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> predsurv2;</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> predsurv2; </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    daysyears = days/<span class="dv">365.25</span>; </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=predsurv2;</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    plot logminlogsurv*daysyears=tment/haxis=axis1 vaxis=axis2;</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=-<span class="dv">7</span> <span class="kw">to</span> <span class="dv">0</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'log(-log(survival function))'</span>);</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.7" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.7">Figure 4.7</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" role="tab" aria-controls="tabset-7-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" role="tab" aria-controls="tabset-7-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-7-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-7-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.7-r_cce69d7b17baec283b3edcdce866e079">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># g-formula</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We want to predict responses if all subjects had been given both CyA and placebo (tment = 0,1)</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to have n survival curves * 2</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># make a double data set with extra Z</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>pbc3_counterfact <span class="ot">&lt;-</span> pbc3</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>pbc3_counterfact<span class="sc">$</span>tment <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pbc3_counterfact<span class="sc">$</span>tment <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># opposite treatment</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>pbc3_double <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pbc3, pbc3_counterfact)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline survival</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>coxfit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili, <span class="at">data =</span> pbc3, </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">survfit</span>(coxfit, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="dv">0</span>, <span class="at">alb =</span> <span class="dv">0</span>, <span class="at">log2bili =</span> <span class="dv">0</span>))</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>allsurv <span class="ot">&lt;-</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pbc3_double),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>       <span class="cf">function</span>(i)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>         pred<span class="sc">$</span>surv <span class="sc">^</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>         <span class="fu">exp</span>(<span class="fu">coef</span>(coxfit)[<span class="dv">1</span>] <span class="sc">*</span> pbc3_double<span class="sc">$</span>tment[i] <span class="sc">+</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>               <span class="fu">coef</span>(coxfit)[<span class="dv">2</span>] <span class="sc">*</span> pbc3_double<span class="sc">$</span>alb[i] <span class="sc">+</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>               <span class="fu">coef</span>(coxfit)[<span class="dv">3</span>] <span class="sc">*</span> pbc3_double<span class="sc">$</span>log2bili[i]))</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>potout <span class="ot">&lt;-</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">surv =</span> <span class="fu">unlist</span>(allsurv),</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">tment =</span> <span class="fu">rep</span>(pbc3_double<span class="sc">$</span>tment, <span class="at">each =</span> <span class="fu">length</span>(pred<span class="sc">$</span>time)),</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>           <span class="at">time =</span> <span class="fu">rep</span>(pred<span class="sc">$</span>time, <span class="at">times =</span> <span class="fu">nrow</span>(pbc3)<span class="sc">*</span><span class="dv">2</span>))</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Average over values</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>sumdata <span class="ot">&lt;-</span> potout <span class="sc">%&gt;%</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(tment, time) <span class="sc">%&gt;%</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_pred =</span> <span class="fu">mean</span>(surv, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="fu">c</span>(<span class="st">"keep"</span>))</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>sumdata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(sumdata)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure 4.7</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.7</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> average_pred, <span class="at">linetype =</span> <span class="fu">as.factor</span>(tment)),</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> sumdata) <span class="sc">+</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Treatment"</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Placebo"</span>, <span class="st">"CyA"</span>)) <span class="sc">+</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Estimated survival function (g-formula)"</span>) <span class="sc">+</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>),</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  theme_general </span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.7</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.7-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-7-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-7-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.7-sas_513acdd6ab2a6015b9892c363e5b036a">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    class tment;</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span>)=tment alb log2bili / rl;</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    baseline out=gsurv survival=surv <span class="fu">stderr</span>=sd /</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    method=breslow diradj <span class="kw">group</span>=tment;</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> gsurv;</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> gsurv; </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    daysyears = days/<span class="dv">365.25</span>; </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=gsurv;</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    plot surv*daysyears=tment / haxis=axis1 vaxis=axis2;</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Estimated survival function (g-formula)'</span>);</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="in-text-g-formula-from-cox" class="level3">
<h3 class="anchored" data-anchor-id="in-text-g-formula-from-cox">In-text: g-formula from Cox</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-8-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-1" role="tab" aria-controls="tabset-8-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-2" role="tab" aria-controls="tabset-8-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-8-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-8-1-tab">
<section id="using-riskregression-package" class="level4">
<h4 class="anchored" data-anchor-id="using-riskregression-package">Using riskRegression package</h4>
<div class="cell" data-hash="Ch4_cache/html/in-text-cox-gform-riskregression_2d10ef127f4b265b37a94c3b586cda69">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(riskRegression)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>subpbc<span class="ot">&lt;-</span><span class="fu">subset</span>(pbc3, <span class="sc">!</span><span class="fu">is.na</span>(alb))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>subpbc<span class="sc">$</span>tment<span class="ot">&lt;-</span><span class="fu">relevel</span>(<span class="fu">factor</span>(subpbc<span class="sc">$</span>tment),<span class="at">ref=</span><span class="st">"0"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>cfit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, fail) <span class="sc">~</span> tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili, <span class="at">data =</span> subpbc, </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">method =</span> <span class="st">"breslow"</span>,<span class="at">y=</span><span class="cn">TRUE</span>,<span class="at">x=</span><span class="cn">TRUE</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>atecfit<span class="ot">&lt;-</span><span class="fu">ate</span>(cfit, <span class="at">data =</span> subpbc, <span class="at">treatment =</span> <span class="st">"tment"</span>, <span class="at">times =</span> <span class="dv">2</span><span class="sc">*</span><span class="fl">365.25</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">cause=</span><span class="dv">1</span>, <span class="at">verbose=</span>F)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(atecfit,<span class="at">type=</span><span class="st">"meanRisk"</span>,<span class="at">se=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     Average treatment effect 

 - Treatment            : tment (2 levels: "0" "1")
 - Event                : fail (cause: 1, censoring: 0)
 - Time  [min;max]      : days [1;2150]
 - Eval. time          : 730.5
      number at risk 0     102
      number at risk 1     110

 Estimation procedure 
 - Estimator  : G-formula
 - Uncertainty: Gaussian approximation 
                where the variance is estimated via the influence function 

 Testing procedure
 - Null hypothesis     : given two treatments (A,B) and a specific timepoint, equal risks 
 - Confidence level    : 0.95

 Results: 
 - Standardized risk between time zero and 'time', reported on the scale [0;1] (probability scale)
   (average risk when treating all subjects with one treatment)

 time tment  risk     se          ci
  730     0 0.201 0.0271 [0.15;0.25]
  730     1 0.133 0.0217 [0.09;0.18]

 risk            : estimated standardized risk 
 ci              : pointwise confidence intervals </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(atecfit,<span class="at">type=</span><span class="st">"diffRisk"</span>,<span class="at">se=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     Average treatment effect 

 - Treatment            : tment (2 levels: "0" "1")
 - Event                : fail (cause: 1, censoring: 0)
 - Time  [min;max]      : days [1;2150]
 - Eval. time          : 730.5
      number at risk 0     102
      number at risk 1     110

 Estimation procedure 
 - Estimator  : G-formula
 - Uncertainty: Gaussian approximation 
                where the variance is estimated via the influence function 

 Testing procedure
 - Null hypothesis     : given two treatments (A,B) and a specific timepoint, equal risks 
 - Confidence level    : 0.95

 Results: 
 - Difference in standardized risk (B-A) between time zero and 'time' 
                reported on the scale [-1;1] (difference between two probabilities)
 (difference in average risks when treating all subjects with the experimental treatment (B),
                                vs. treating all subjects with the reference treatment (A))

 time tment=A tment=B difference     se            ci p.value
  730       0       1    -0.0681 0.0259 [-0.12;-0.02] 0.00855

 difference      : estimated difference in standardized risks 
 ci              : pointwise confidence intervals 
 p.value         : (unadjusted) p-value </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Survival instead of failure risk</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span><span class="sc">-</span>atecfit<span class="sc">$</span>meanRisk<span class="sc">$</span>estimate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7989143 0.8670633</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>atecfitB<span class="ot">&lt;-</span><span class="fu">ate</span>(cfit, <span class="at">data =</span> subpbc, <span class="at">treatment =</span> <span class="st">"tment"</span>, <span class="at">times =</span> <span class="dv">2</span><span class="sc">*</span><span class="fl">365.25</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">cause=</span><span class="dv">1</span>, <span class="at">verbose=</span>F, <span class="at">B=</span><span class="dv">100</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(atecfitB,<span class="at">type=</span><span class="st">"meanRisk"</span>,<span class="at">se=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     Average treatment effect 

 - Treatment            : tment (2 levels: "0" "1")
 - Event                : fail (cause: 1, censoring: 0)
 - Time  [min;max]      : days [1;2150]
 - Eval. time          : 730.5
      number at risk 0     102
      number at risk 1     110

 Estimation procedure 
 - Estimator  : G-formula
 - Uncertainty: Percentile bootstrap based on 100 bootstrap samples
                that were drawn with replacement from the original data.

 Testing procedure
 - Null hypothesis     : given two treatments (A,B) and a specific timepoint, equal risks 
 - Confidence level    : 0.95

 Results: 
 - Standardized risk between time zero and 'time', reported on the scale [0;1] (probability scale)
   (average risk when treating all subjects with one treatment)

 time tment  risk risk.boot     se          ci
  730     0 0.201     0.199 0.0261 [0.15;0.26]
  730     1 0.133     0.132 0.0192 [0.10;0.17]

 risk            : estimated standardized risk 
 risk.boot       : average value over the bootstrap samples 
 ci              : pointwise confidence intervals </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(atecfitB,<span class="at">type=</span><span class="st">"diffRisk"</span>,<span class="at">se=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>     Average treatment effect 

 - Treatment            : tment (2 levels: "0" "1")
 - Event                : fail (cause: 1, censoring: 0)
 - Time  [min;max]      : days [1;2150]
 - Eval. time          : 730.5
      number at risk 0     102
      number at risk 1     110

 Estimation procedure 
 - Estimator  : G-formula
 - Uncertainty: Percentile bootstrap based on 100 bootstrap samples
                that were drawn with replacement from the original data.

 Testing procedure
 - Null hypothesis     : given two treatments (A,B) and a specific timepoint, equal risks 
 - Confidence level    : 0.95

 Results: 
 - Difference in standardized risk (B-A) between time zero and 'time' 
                reported on the scale [-1;1] (difference between two probabilities)
 (difference in average risks when treating all subjects with the experimental treatment (B),
                                vs. treating all subjects with the reference treatment (A))

 time tment=A tment=B difference difference.boot     se            ci p.value
  730       0       1    -0.0681         -0.0668 0.0239 [-0.12;-0.02]       0

 difference      : estimated difference in standardized risks 
 difference.boot : average value over the bootstrap samples 
 ci              : pointwise confidence intervals 
 p.value         : (unadjusted) p-value </code></pre>
</div>
</div>
</section>
<section id="using-mets-package" class="level4">
<h4 class="anchored" data-anchor-id="using-mets-package">Using mets package</h4>
<div class="cell" data-hash="Ch4_cache/html/in-text-cox-gform-mets_c4bc3ca11e39234cfb8c00065a680d22">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>cfitmets <span class="ot">&lt;-</span> <span class="fu">phreg</span>(<span class="fu">Surv</span>(days, fail) <span class="sc">~</span> tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili, <span class="at">data =</span> subpbc)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">survivalG</span>(cfitmets, subpbc, <span class="at">time =</span> <span class="dv">2</span><span class="sc">*</span><span class="fl">365.25</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>risk:
      Estimate Std.Err   2.5%  97.5%    P-value
risk0   0.7989 0.02722 0.7455 0.8522 2.325e-189
risk1   0.8671 0.02171 0.8245 0.9096  0.000e+00

Average Treatment effects (G-estimator) :
   Estimate Std.Err    2.5%  97.5%  P-value
p1   0.0682 0.02622 0.01681 0.1196 0.009297

Average Treatment effect ratio (G-estimator) :
     Estimate    Std.Err     2.5%    97.5%    P-value
[p1] 1.085375 0.03484226 1.017085 1.153664 0.01427275</code></pre>
</div>
</div>
</section>
</div>
<div id="tabset-8-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-2-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-cox-gform-sas_0af5a0eac4e18d1a2b3d57f3ebf6f07a">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> print<span class="kw"> data</span>=gsurv;</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span> days=<span class="dv">714</span>;</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.8" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.8">Figure 4.8</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-9-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-1" role="tab" aria-controls="tabset-9-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-2" role="tab" aria-controls="tabset-9-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-9-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-9-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.8-r_a356d1aed6bdb601e87bdb363b3bdf8a">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Product representation based on Breslow estimator</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Survival prediction</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(coxfit, <span class="at">centered =</span> F)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># For tment=0, alb=38, log2bili=log2(45)</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>dA_tment0 <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, preds<span class="sc">$</span>hazard </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>                    <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">coef</span>(coxfit)[<span class="dv">1</span>]<span class="sc">*</span><span class="dv">0</span> <span class="sc">+</span> <span class="fu">coef</span>(coxfit)[<span class="dv">2</span>]<span class="sc">*</span><span class="dv">38</span> <span class="sc">+</span> <span class="fu">coef</span>(coxfit)[<span class="dv">3</span>] <span class="sc">*</span> <span class="fu">log2</span>(<span class="dv">45</span>) )))</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>surv_tment0 <span class="ot">&lt;-</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> dA_tment0)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># For tment=1, alb=38, log2bili=log2(45)</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>dA_tment1 <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, preds<span class="sc">$</span>hazard </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>                    <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">coef</span>(coxfit)[<span class="dv">1</span>]<span class="sc">*</span><span class="dv">1</span> <span class="sc">+</span> <span class="fu">coef</span>(coxfit)[<span class="dv">2</span>]<span class="sc">*</span><span class="dv">38</span> <span class="sc">+</span> <span class="fu">coef</span>(coxfit)[<span class="dv">3</span>] <span class="sc">*</span> <span class="fu">log2</span>(<span class="dv">45</span>) )))</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>surv_tment1 <span class="ot">&lt;-</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> dA_tment1)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>pdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">surv =</span> <span class="fu">c</span>(surv_tment0, surv_tment1),</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>                    <span class="at">time =</span> <span class="fu">c</span>(preds<span class="sc">$</span>time, preds<span class="sc">$</span>time), </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>                    <span class="at">tment =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"0"</span>, <span class="fu">length</span>(preds<span class="sc">$</span>time)),</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rep</span>(<span class="st">"1"</span>, <span class="fu">length</span>(preds<span class="sc">$</span>time))))</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure 4.8</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.8</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> surv, <span class="at">linetype =</span> <span class="fu">as.factor</span>(tment)), </span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> pdata) <span class="sc">+</span> </span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Treatment"</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Placebo"</span>, <span class="st">"CyA"</span>)) <span class="sc">+</span> </span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Estimated survival function"</span>) <span class="sc">+</span> </span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>),</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.8-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-9-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.8-sas_883cdedad3d2af3ba03d610c4e3db639">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co">    *class tment;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span>)=tment alb log2bili/rl;</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    baseline out=predsurvpl survival=surv covariates=cov / method=pl;</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> predsurvpl;</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> predsurvpl; </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    daysyears = days/<span class="dv">365.25</span>; </span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=predsurvpl;</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    plot surv*daysyears=tment/haxis=axis1 vaxis=axis2;</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Estimated survival function'</span>);</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-4.1" class="level3">
<h3 class="anchored" data-anchor-id="table-4.1">Table 4.1</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-10-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-1" role="tab" aria-controls="tabset-10-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-10-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-2" role="tab" aria-controls="tabset-10-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-10-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-10-1-tab">
<section id="non-parametric-using-survival-package" class="level4">
<h4 class="anchored" data-anchor-id="non-parametric-using-survival-package">Non-parametric using survival package</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-r-nonparm_3533f37ba31fc9e4c06fab3d754733cc">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>np_km <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(days<span class="sc">/</span><span class="fl">365.25</span>, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> tment, <span class="at">data =</span> pbc3)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(np_km,<span class="at">rmean=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(days/365.25, status != 0) ~ tment, data = pbc3)

          n events rmean* se(rmean) median 0.95LCL 0.95UCL
tment=0 173     46   2.61    0.0633     NA    4.51      NA
tment=1 176     44   2.68    0.0565     NA    4.66      NA
    * restricted mean with upper limit =  3 </code></pre>
</div>
</div>
</section>
<section id="non-parametric-using-mets-package" class="level4">
<h4 class="anchored" data-anchor-id="non-parametric-using-mets-package">Non-parametric using mets package</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-r-mets_749aff17390df1128e8877644c3e39e8">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># non-parametric could also be done using mets package</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>out1 <span class="ot">&lt;-</span> <span class="fu">phreg</span>(<span class="fu">Surv</span>(days<span class="sc">/</span><span class="fl">365.25</span>,fail)<span class="sc">~</span><span class="fu">strata</span>(tment),<span class="at">data=</span>pbc3)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>rm1 <span class="ot">&lt;-</span> <span class="fu">resmean.phreg</span>(out1,<span class="at">times=</span><span class="dv">3</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  strata times    rmean   se.rmean years.lost
1      0     3 2.606095 0.06325665  0.3939052
2      1     3 2.677657 0.05654602  0.3223425</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">resmeanIPCW</span>(<span class="fu">Event</span>(days<span class="sc">/</span><span class="fl">365.25</span>,fail)<span class="sc">~</span><span class="dv">1</span>, <span class="at">data=</span><span class="fu">subset</span>(pbc3,tment<span class="sc">==</span><span class="dv">0</span>),<span class="at">time=</span><span class="dv">3</span>,<span class="at">model=</span><span class="st">"linear"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 173     36

 173 clusters
coeffients:
            Estimate  Std.Err     2.5%    97.5% P-value
(Intercept) 2.605894 0.063305 2.481818 2.729969       0

exp(coeffients):
            Estimate   2.5%  97.5%
(Intercept)   13.543 11.963 15.332</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">resmeanIPCW</span>(<span class="fu">Event</span>(days<span class="sc">/</span><span class="fl">365.25</span>,fail)<span class="sc">~</span><span class="dv">1</span>, <span class="at">data=</span><span class="fu">subset</span>(pbc3,tment<span class="sc">==</span><span class="dv">1</span>),<span class="at">time=</span><span class="dv">3</span>,<span class="at">model=</span><span class="st">"linear"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 176     32

 176 clusters
coeffients:
            Estimate  Std.Err     2.5%    97.5% P-value
(Intercept) 2.677458 0.056607 2.566511 2.788405       0

exp(coeffients):
            Estimate   2.5%  97.5%
(Intercept)   14.548 13.020 16.255</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">contrasts=</span><span class="fu">c</span>(<span class="st">"contr.treatment"</span>, <span class="st">"contr.poly"</span>))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>out<span class="ot">&lt;-</span><span class="fu">resmeanIPCW</span>(<span class="fu">Event</span>(days<span class="sc">/</span><span class="fl">365.25</span>,fail)<span class="sc">~-</span><span class="dv">1</span><span class="sc">+</span><span class="fu">factor</span>(tment),<span class="at">data=</span>pbc3,<span class="at">time=</span><span class="dv">3</span>,<span class="at">model=</span><span class="st">"linear"</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">cens.model =</span> <span class="sc">~</span><span class="fu">strata</span>(tment))</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">estimate</span>(out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>               Estimate Std.Err  2.5% 97.5% P-value
factor(tment)0    2.606 0.06330 2.482 2.730       0
factor(tment)1    2.677 0.05661 2.567 2.788       0</code></pre>
</div>
</div>
</section>
<section id="code-for-rest-of-table" class="level4">
<h4 class="anchored" data-anchor-id="code-for-rest-of-table">Code for rest of table</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-r-boot_1a72c4ab078c0a2289b8f1205b9f4db4">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Non-parametric using RISCA package</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>kmdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">surv =</span> np_km<span class="sc">$</span>surv, </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">time =</span> np_km<span class="sc">$</span>time, </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">names</span>(np_km<span class="sc">$</span>strata[<span class="dv">1</span>]), np_km<span class="sc">$</span>strata[[<span class="dv">1</span>]]), </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rep</span>(<span class="fu">names</span>(np_km<span class="sc">$</span>strata[<span class="dv">2</span>]), np_km<span class="sc">$</span>strata[[<span class="dv">2</span>]])))</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Restrict to each treat</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>kmdata0 <span class="ot">&lt;-</span> <span class="fu">subset</span>(kmdata, strata <span class="sc">==</span> <span class="st">"tment=0"</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>kmdata1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(kmdata, strata <span class="sc">==</span> <span class="st">"tment=1"</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co"># rmst</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RISCA)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>rmst0 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> kmdata0<span class="sc">$</span>time, <span class="at">surv.rates =</span> kmdata0<span class="sc">$</span>surv, <span class="at">max.time =</span> <span class="dv">3</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>rmst1 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> kmdata1<span class="sc">$</span>time, <span class="at">surv.rates =</span> kmdata1<span class="sc">$</span>surv, <span class="at">max.time =</span> <span class="dv">3</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model, alb = 38, bili = 45</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model fit with covariates tment, alb and log2bili</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>coxfit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili, <span class="at">data =</span> pbc3, </span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>                <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Unique followup times </span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>fu <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(pbc3<span class="sc">$</span>days))</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Data for prediction</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>preddata1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(fu)), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(fu))), </span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alb =</span> <span class="fu">rep</span>(<span class="dv">38</span>, <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>),</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>                       <span class="at">log2bili =</span> <span class="fu">rep</span>(<span class="fu">log2</span>(<span class="dv">45</span>), <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>), </span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">days =</span> <span class="fu">c</span>(fu, fu),</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>                       <span class="at">status =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear predictor</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>preds1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(coxfit, <span class="at">newdata =</span> preddata1, <span class="at">type =</span> <span class="st">"survival"</span>)</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>preddata1<span class="sc">$</span>preds <span class="ot">&lt;-</span> preds1</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>cox10 <span class="ot">&lt;-</span> <span class="fu">subset</span>(preddata1, tment <span class="sc">==</span> <span class="st">"0"</span>)</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>cox11 <span class="ot">&lt;-</span> <span class="fu">subset</span>(preddata1, tment <span class="sc">==</span> <span class="st">"1"</span>)</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Rmst </span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>rmstcox10 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> cox10<span class="sc">$</span>days, <span class="at">surv.rates =</span> cox10<span class="sc">$</span>preds, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>rmstcox11 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> cox11<span class="sc">$</span>days, <span class="at">surv.rates =</span> cox11<span class="sc">$</span>preds, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox for alb = 20 and bili = 90 </span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Data for prediction</span></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>preddata2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(fu)), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(fu))), </span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>                        <span class="at">alb =</span> <span class="fu">rep</span>(<span class="dv">20</span>, <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>),</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>                        <span class="at">log2bili =</span> <span class="fu">rep</span>(<span class="fu">log2</span>(<span class="dv">90</span>), <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>), </span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>                        <span class="at">days =</span> <span class="fu">c</span>(fu, fu),</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>                        <span class="at">status =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear predictor</span></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>preds2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(coxfit, <span class="at">newdata =</span> preddata2, <span class="at">type =</span> <span class="st">"survival"</span>)</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>preddata2<span class="sc">$</span>preds <span class="ot">&lt;-</span> preds2</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>cox20 <span class="ot">&lt;-</span> <span class="fu">subset</span>(preddata2, tment <span class="sc">==</span> <span class="st">"0"</span>)</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>cox21 <span class="ot">&lt;-</span> <span class="fu">subset</span>(preddata2, tment <span class="sc">==</span> <span class="st">"1"</span>)</span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Rmst </span></span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>rmstcox20 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> cox20<span class="sc">$</span>days, <span class="at">surv.rates =</span> cox20<span class="sc">$</span>preds, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>rmstcox21 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> cox21<span class="sc">$</span>days, <span class="at">surv.rates =</span> cox21<span class="sc">$</span>preds, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model, g-formula</span></span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a><span class="co"># We want to predict responses if all subjects had been given both CyA and placebo (tment = 0,1)</span></span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to have n survival curves * 2</span></span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a><span class="co"># make a double data set with extra Z</span></span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>pbc3_counterfact <span class="ot">&lt;-</span> pbc3</span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>pbc3_counterfact<span class="sc">$</span>tment <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pbc3_counterfact<span class="sc">$</span>tment <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># opposite treatment</span></span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>pbc3_double <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pbc3, pbc3_counterfact)</span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Baseline survival</span></span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">survfit</span>(coxfit, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="dv">0</span>, <span class="at">alb =</span> <span class="dv">0</span>, <span class="at">log2bili =</span> <span class="dv">0</span>))</span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a>allsurv <span class="ot">&lt;-</span></span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pbc3_double),</span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a>         <span class="cf">function</span>(i)</span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>           pred<span class="sc">$</span>surv <span class="sc">^</span></span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a>           <span class="fu">exp</span>(<span class="fu">coef</span>(coxfit)[<span class="dv">1</span>] <span class="sc">*</span> pbc3_double<span class="sc">$</span>tment[i] <span class="sc">+</span></span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">coef</span>(coxfit)[<span class="dv">2</span>] <span class="sc">*</span> pbc3_double<span class="sc">$</span>alb[i] <span class="sc">+</span></span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">coef</span>(coxfit)[<span class="dv">3</span>] <span class="sc">*</span> pbc3_double<span class="sc">$</span>log2bili[i]))</span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true" tabindex="-1"></a>potout <span class="ot">&lt;-</span></span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">surv =</span> <span class="fu">unlist</span>(allsurv),</span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true" tabindex="-1"></a>             <span class="at">tment =</span> <span class="fu">rep</span>(pbc3_double<span class="sc">$</span>tment, <span class="at">each =</span> <span class="fu">length</span>(pred<span class="sc">$</span>time)),</span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true" tabindex="-1"></a>             <span class="at">time =</span> <span class="fu">rep</span>(pred<span class="sc">$</span>time, <span class="at">times =</span> <span class="fu">nrow</span>(pbc3)<span class="sc">*</span><span class="dv">2</span>)</span>
<span id="cb41-89"><a href="#cb41-89" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-90"><a href="#cb41-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Average over values</span></span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(dplyr)</span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true" tabindex="-1"></a>sumdata <span class="ot">&lt;-</span> potout <span class="sc">%&gt;%</span></span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(tment, time) <span class="sc">%&gt;%</span></span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_pred =</span> <span class="fu">mean</span>(surv, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="fu">c</span>(<span class="st">"keep"</span>))</span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true" tabindex="-1"></a>sumdata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(sumdata)</span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-100"><a href="#cb41-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data per group</span></span>
<span id="cb41-101"><a href="#cb41-101" aria-hidden="true" tabindex="-1"></a>coxg0 <span class="ot">&lt;-</span> <span class="fu">subset</span>(sumdata, tment <span class="sc">==</span> <span class="st">"0"</span>)</span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true" tabindex="-1"></a>coxg1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(sumdata, tment <span class="sc">==</span> <span class="st">"1"</span>)</span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Rmst </span></span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true" tabindex="-1"></a>rmstcoxg0 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> coxg0<span class="sc">$</span>time, <span class="at">surv.rates =</span> coxg0<span class="sc">$</span>average_pred, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true" tabindex="-1"></a>rmstcoxg1 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> coxg1<span class="sc">$</span>time, <span class="at">surv.rates =</span> coxg1<span class="sc">$</span>average_pred, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true" tabindex="-1"></a><span class="do">##### BOOTSTRAP FOR SE'S #####</span></span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Resample data sets </span></span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true" tabindex="-1"></a>B<span class="ot">&lt;-</span><span class="dv">200</span></span>
<span id="cb41-113"><a href="#cb41-113" aria-hidden="true" tabindex="-1"></a>bootdata <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb41-114"><a href="#cb41-114" aria-hidden="true" tabindex="-1"></a>kmres <span class="ot">&lt;-</span> cox1res <span class="ot">&lt;-</span> cox2res <span class="ot">&lt;-</span> coxgres <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb41-115"><a href="#cb41-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-116"><a href="#cb41-116" aria-hidden="true" tabindex="-1"></a><span class="co">#colnames(kmres) &lt;- colnames(cox1res) &lt;- colnames(cox2res) &lt;- colnames(coxgres) &lt;- c("rmst0", "rmst1")</span></span>
<span id="cb41-117"><a href="#cb41-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-118"><a href="#cb41-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-119"><a href="#cb41-119" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb41-120"><a href="#cb41-120" aria-hidden="true" tabindex="-1"></a>  bootdata[[b]] <span class="ot">&lt;-</span> pbc3[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pbc3), <span class="at">size =</span> <span class="fu">nrow</span>(pbc3), <span class="at">replace =</span> T),]</span>
<span id="cb41-121"><a href="#cb41-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-122"><a href="#cb41-122" aria-hidden="true" tabindex="-1"></a>  <span class="do">###### KM #######</span></span>
<span id="cb41-123"><a href="#cb41-123" aria-hidden="true" tabindex="-1"></a>  np_km <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(days, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> tment, <span class="at">data =</span> bootdata[[b]])</span>
<span id="cb41-124"><a href="#cb41-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-125"><a href="#cb41-125" aria-hidden="true" tabindex="-1"></a>  kmdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">surv =</span> np_km<span class="sc">$</span>surv, </span>
<span id="cb41-126"><a href="#cb41-126" aria-hidden="true" tabindex="-1"></a>                       <span class="at">time =</span> np_km<span class="sc">$</span>time, </span>
<span id="cb41-127"><a href="#cb41-127" aria-hidden="true" tabindex="-1"></a>                       <span class="at">strata =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">names</span>(np_km<span class="sc">$</span>strata[<span class="dv">1</span>]), np_km<span class="sc">$</span>strata[[<span class="dv">1</span>]]), </span>
<span id="cb41-128"><a href="#cb41-128" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">rep</span>(<span class="fu">names</span>(np_km<span class="sc">$</span>strata[<span class="dv">2</span>]), np_km<span class="sc">$</span>strata[[<span class="dv">2</span>]])))</span>
<span id="cb41-129"><a href="#cb41-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restrict to each treat</span></span>
<span id="cb41-130"><a href="#cb41-130" aria-hidden="true" tabindex="-1"></a>  kmdata0 <span class="ot">&lt;-</span> <span class="fu">subset</span>(kmdata, strata <span class="sc">==</span> <span class="st">"tment=0"</span>)</span>
<span id="cb41-131"><a href="#cb41-131" aria-hidden="true" tabindex="-1"></a>  kmdata1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(kmdata, strata <span class="sc">==</span> <span class="st">"tment=1"</span>)</span>
<span id="cb41-132"><a href="#cb41-132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-133"><a href="#cb41-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rmst</span></span>
<span id="cb41-134"><a href="#cb41-134" aria-hidden="true" tabindex="-1"></a>  rmst0 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> kmdata0<span class="sc">$</span>time, <span class="at">surv.rates =</span> kmdata0<span class="sc">$</span>surv, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-135"><a href="#cb41-135" aria-hidden="true" tabindex="-1"></a>  rmst1 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> kmdata1<span class="sc">$</span>time, <span class="at">surv.rates =</span> kmdata1<span class="sc">$</span>surv, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-136"><a href="#cb41-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-137"><a href="#cb41-137" aria-hidden="true" tabindex="-1"></a>  kmres[[b]] <span class="ot">&lt;-</span> <span class="fu">c</span>(rmst0, rmst1)</span>
<span id="cb41-138"><a href="#cb41-138" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-139"><a href="#cb41-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-140"><a href="#cb41-140" aria-hidden="true" tabindex="-1"></a>  <span class="do">###### Cox 1 #######</span></span>
<span id="cb41-141"><a href="#cb41-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-142"><a href="#cb41-142" aria-hidden="true" tabindex="-1"></a>  coxfit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili, <span class="at">data =</span> bootdata[[b]], </span>
<span id="cb41-143"><a href="#cb41-143" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb41-144"><a href="#cb41-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-145"><a href="#cb41-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unique followup times </span></span>
<span id="cb41-146"><a href="#cb41-146" aria-hidden="true" tabindex="-1"></a>  fu <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(pbc3<span class="sc">$</span>days))</span>
<span id="cb41-147"><a href="#cb41-147" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-148"><a href="#cb41-148" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data for prediction</span></span>
<span id="cb41-149"><a href="#cb41-149" aria-hidden="true" tabindex="-1"></a>  preddata1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(fu)), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(fu))), </span>
<span id="cb41-150"><a href="#cb41-150" aria-hidden="true" tabindex="-1"></a>                          <span class="at">alb =</span> <span class="fu">rep</span>(<span class="dv">38</span>, <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>),</span>
<span id="cb41-151"><a href="#cb41-151" aria-hidden="true" tabindex="-1"></a>                          <span class="at">log2bili =</span> <span class="fu">rep</span>(<span class="fu">log2</span>(<span class="dv">45</span>), <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>), </span>
<span id="cb41-152"><a href="#cb41-152" aria-hidden="true" tabindex="-1"></a>                          <span class="at">days =</span> <span class="fu">c</span>(fu, fu),</span>
<span id="cb41-153"><a href="#cb41-153" aria-hidden="true" tabindex="-1"></a>                          <span class="at">status =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>))</span>
<span id="cb41-154"><a href="#cb41-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-155"><a href="#cb41-155" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Linear predictor</span></span>
<span id="cb41-156"><a href="#cb41-156" aria-hidden="true" tabindex="-1"></a>  preds1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(coxfit, <span class="at">newdata =</span> preddata1, <span class="at">type =</span> <span class="st">"survival"</span>)</span>
<span id="cb41-157"><a href="#cb41-157" aria-hidden="true" tabindex="-1"></a>  preddata1<span class="sc">$</span>preds <span class="ot">&lt;-</span> preds1</span>
<span id="cb41-158"><a href="#cb41-158" aria-hidden="true" tabindex="-1"></a>  cox10 <span class="ot">&lt;-</span> <span class="fu">subset</span>(preddata1, tment <span class="sc">==</span> <span class="st">"0"</span>)</span>
<span id="cb41-159"><a href="#cb41-159" aria-hidden="true" tabindex="-1"></a>  cox11 <span class="ot">&lt;-</span> <span class="fu">subset</span>(preddata1, tment <span class="sc">==</span> <span class="st">"1"</span>)</span>
<span id="cb41-160"><a href="#cb41-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-161"><a href="#cb41-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rmst </span></span>
<span id="cb41-162"><a href="#cb41-162" aria-hidden="true" tabindex="-1"></a>  rmstcox10 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> cox10<span class="sc">$</span>days, <span class="at">surv.rates =</span> cox10<span class="sc">$</span>preds, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-163"><a href="#cb41-163" aria-hidden="true" tabindex="-1"></a>  rmstcox11 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> cox11<span class="sc">$</span>days, <span class="at">surv.rates =</span> cox11<span class="sc">$</span>preds, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-164"><a href="#cb41-164" aria-hidden="true" tabindex="-1"></a>    cox1res[[b]] <span class="ot">&lt;-</span> <span class="fu">c</span>(rmstcox10, rmstcox11)</span>
<span id="cb41-165"><a href="#cb41-165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-166"><a href="#cb41-166" aria-hidden="true" tabindex="-1"></a>  <span class="do">###### Cox 2 #######</span></span>
<span id="cb41-167"><a href="#cb41-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-168"><a href="#cb41-168" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cox for alb = 20 and bili = 90   </span></span>
<span id="cb41-169"><a href="#cb41-169" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data for prediction</span></span>
<span id="cb41-170"><a href="#cb41-170" aria-hidden="true" tabindex="-1"></a>  preddata2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(fu)), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(fu))), </span>
<span id="cb41-171"><a href="#cb41-171" aria-hidden="true" tabindex="-1"></a>                          <span class="at">alb =</span> <span class="fu">rep</span>(<span class="dv">20</span>, <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>),</span>
<span id="cb41-172"><a href="#cb41-172" aria-hidden="true" tabindex="-1"></a>                          <span class="at">log2bili =</span> <span class="fu">rep</span>(<span class="fu">log2</span>(<span class="dv">90</span>), <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>), </span>
<span id="cb41-173"><a href="#cb41-173" aria-hidden="true" tabindex="-1"></a>                          <span class="at">days =</span> <span class="fu">c</span>(fu, fu),</span>
<span id="cb41-174"><a href="#cb41-174" aria-hidden="true" tabindex="-1"></a>                          <span class="at">status =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(fu) <span class="sc">*</span> <span class="dv">2</span>))</span>
<span id="cb41-175"><a href="#cb41-175" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-176"><a href="#cb41-176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Linear predictor</span></span>
<span id="cb41-177"><a href="#cb41-177" aria-hidden="true" tabindex="-1"></a>  preds2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(coxfit, <span class="at">newdata =</span> preddata2, <span class="at">type =</span> <span class="st">"survival"</span>)</span>
<span id="cb41-178"><a href="#cb41-178" aria-hidden="true" tabindex="-1"></a>  preddata2<span class="sc">$</span>preds <span class="ot">&lt;-</span> preds2</span>
<span id="cb41-179"><a href="#cb41-179" aria-hidden="true" tabindex="-1"></a>  cox20 <span class="ot">&lt;-</span> <span class="fu">subset</span>(preddata2, tment <span class="sc">==</span> <span class="st">"0"</span>)</span>
<span id="cb41-180"><a href="#cb41-180" aria-hidden="true" tabindex="-1"></a>  cox21 <span class="ot">&lt;-</span> <span class="fu">subset</span>(preddata2, tment <span class="sc">==</span> <span class="st">"1"</span>)</span>
<span id="cb41-181"><a href="#cb41-181" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-182"><a href="#cb41-182" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rmst </span></span>
<span id="cb41-183"><a href="#cb41-183" aria-hidden="true" tabindex="-1"></a>  rmstcox20 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> cox20<span class="sc">$</span>days, <span class="at">surv.rates =</span> cox20<span class="sc">$</span>preds, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-184"><a href="#cb41-184" aria-hidden="true" tabindex="-1"></a>  rmstcox21 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> cox21<span class="sc">$</span>days, <span class="at">surv.rates =</span> cox21<span class="sc">$</span>preds, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-185"><a href="#cb41-185" aria-hidden="true" tabindex="-1"></a>  cox2res[[b]] <span class="ot">&lt;-</span> <span class="fu">c</span>(rmstcox20, rmstcox21) </span>
<span id="cb41-186"><a href="#cb41-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-187"><a href="#cb41-187" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-188"><a href="#cb41-188" aria-hidden="true" tabindex="-1"></a>  <span class="do">##### Cox - g formula #######</span></span>
<span id="cb41-189"><a href="#cb41-189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-190"><a href="#cb41-190" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We want to predict responses if all subjects had been given both CyA and placebo (tment = 0,1)</span></span>
<span id="cb41-191"><a href="#cb41-191" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We need to have n survival curves * 2</span></span>
<span id="cb41-192"><a href="#cb41-192" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make a double data set with extra Z</span></span>
<span id="cb41-193"><a href="#cb41-193" aria-hidden="true" tabindex="-1"></a>  pbc3_counterfact <span class="ot">&lt;-</span> bootdata[[b]]</span>
<span id="cb41-194"><a href="#cb41-194" aria-hidden="true" tabindex="-1"></a>  pbc3_counterfact<span class="sc">$</span>tment <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pbc3_counterfact<span class="sc">$</span>tment <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># opposite treatment</span></span>
<span id="cb41-195"><a href="#cb41-195" aria-hidden="true" tabindex="-1"></a>  pbc3_double <span class="ot">&lt;-</span> <span class="fu">rbind</span>(bootdata[[b]], pbc3_counterfact)</span>
<span id="cb41-196"><a href="#cb41-196" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-197"><a href="#cb41-197" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Baseline survival</span></span>
<span id="cb41-198"><a href="#cb41-198" aria-hidden="true" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="fu">survfit</span>(coxfit, <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="dv">0</span>, <span class="at">alb =</span> <span class="dv">0</span>, <span class="at">log2bili =</span> <span class="dv">0</span>))</span>
<span id="cb41-199"><a href="#cb41-199" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-200"><a href="#cb41-200" aria-hidden="true" tabindex="-1"></a>  allsurv <span class="ot">&lt;-</span></span>
<span id="cb41-201"><a href="#cb41-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pbc3_double),</span>
<span id="cb41-202"><a href="#cb41-202" aria-hidden="true" tabindex="-1"></a>           <span class="cf">function</span>(i)</span>
<span id="cb41-203"><a href="#cb41-203" aria-hidden="true" tabindex="-1"></a>             pred<span class="sc">$</span>surv <span class="sc">^</span></span>
<span id="cb41-204"><a href="#cb41-204" aria-hidden="true" tabindex="-1"></a>             <span class="fu">exp</span>(<span class="fu">coef</span>(coxfit)[<span class="dv">1</span>] <span class="sc">*</span> pbc3_double<span class="sc">$</span>tment[i] <span class="sc">+</span></span>
<span id="cb41-205"><a href="#cb41-205" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">coef</span>(coxfit)[<span class="dv">2</span>] <span class="sc">*</span> pbc3_double<span class="sc">$</span>alb[i] <span class="sc">+</span></span>
<span id="cb41-206"><a href="#cb41-206" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">coef</span>(coxfit)[<span class="dv">3</span>] <span class="sc">*</span> pbc3_double<span class="sc">$</span>log2bili[i]))</span>
<span id="cb41-207"><a href="#cb41-207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-208"><a href="#cb41-208" aria-hidden="true" tabindex="-1"></a>  potout <span class="ot">&lt;-</span></span>
<span id="cb41-209"><a href="#cb41-209" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">surv =</span> <span class="fu">unlist</span>(allsurv),</span>
<span id="cb41-210"><a href="#cb41-210" aria-hidden="true" tabindex="-1"></a>               <span class="at">tment =</span> <span class="fu">rep</span>(pbc3_double<span class="sc">$</span>tment, <span class="at">each =</span> <span class="fu">length</span>(pred<span class="sc">$</span>time)),</span>
<span id="cb41-211"><a href="#cb41-211" aria-hidden="true" tabindex="-1"></a>               <span class="at">time =</span> <span class="fu">rep</span>(pred<span class="sc">$</span>time, <span class="at">times =</span> <span class="fu">nrow</span>(pbc3)<span class="sc">*</span><span class="dv">2</span>)</span>
<span id="cb41-212"><a href="#cb41-212" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-213"><a href="#cb41-213" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-214"><a href="#cb41-214" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Average over values</span></span>
<span id="cb41-215"><a href="#cb41-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(dplyr)</span>
<span id="cb41-216"><a href="#cb41-216" aria-hidden="true" tabindex="-1"></a>  sumdata <span class="ot">&lt;-</span> potout <span class="sc">%&gt;%</span></span>
<span id="cb41-217"><a href="#cb41-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(tment, time) <span class="sc">%&gt;%</span></span>
<span id="cb41-218"><a href="#cb41-218" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">average_pred =</span> <span class="fu">mean</span>(surv, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb41-219"><a href="#cb41-219" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="fu">c</span>(<span class="st">"keep"</span>))</span>
<span id="cb41-220"><a href="#cb41-220" aria-hidden="true" tabindex="-1"></a>  sumdata <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(sumdata)</span>
<span id="cb41-221"><a href="#cb41-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-222"><a href="#cb41-222" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Split data per group</span></span>
<span id="cb41-223"><a href="#cb41-223" aria-hidden="true" tabindex="-1"></a>  coxg0 <span class="ot">&lt;-</span> <span class="fu">subset</span>(sumdata, tment <span class="sc">==</span> <span class="st">"0"</span>)</span>
<span id="cb41-224"><a href="#cb41-224" aria-hidden="true" tabindex="-1"></a>  coxg1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(sumdata, tment <span class="sc">==</span> <span class="st">"1"</span>)</span>
<span id="cb41-225"><a href="#cb41-225" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-226"><a href="#cb41-226" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Rmst </span></span>
<span id="cb41-227"><a href="#cb41-227" aria-hidden="true" tabindex="-1"></a>  rmstcoxg0 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> coxg0<span class="sc">$</span>time, <span class="at">surv.rates =</span> coxg0<span class="sc">$</span>average_pred, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-228"><a href="#cb41-228" aria-hidden="true" tabindex="-1"></a>  rmstcoxg1 <span class="ot">&lt;-</span> <span class="fu">rmst</span>(<span class="at">times =</span> coxg1<span class="sc">$</span>time, <span class="at">surv.rates =</span> coxg1<span class="sc">$</span>average_pred, <span class="at">max.time =</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>, <span class="at">type =</span> <span class="st">"s"</span>)</span>
<span id="cb41-229"><a href="#cb41-229" aria-hidden="true" tabindex="-1"></a>  coxgres[[b]] <span class="ot">&lt;-</span> <span class="fu">c</span>(rmstcoxg0, rmstcoxg1)</span>
<span id="cb41-230"><a href="#cb41-230" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-231"><a href="#cb41-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-232"><a href="#cb41-232" aria-hidden="true" tabindex="-1"></a>kmreso <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, kmres)</span>
<span id="cb41-233"><a href="#cb41-233" aria-hidden="true" tabindex="-1"></a>cox1reso <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, cox1res)</span>
<span id="cb41-234"><a href="#cb41-234" aria-hidden="true" tabindex="-1"></a>cox2reso <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, cox2res)</span>
<span id="cb41-235"><a href="#cb41-235" aria-hidden="true" tabindex="-1"></a>coxgreso <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">"rbind"</span>, coxgres)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="cox-3845" class="level4">
<h4 class="anchored" data-anchor-id="cox-3845">Cox (38,45)</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-r-cox1_5b397c75d792be4083015289ddecd650">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(cox1reso, <span class="dv">2</span>, mean)<span class="sc">/</span><span class="fl">365.25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.527231 2.720892</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(cox1reso, <span class="dv">2</span>, sd)<span class="sc">/</span><span class="fl">365.25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.06340501 0.04929527</code></pre>
</div>
</div>
</section>
<section id="cox-2090" class="level4">
<h4 class="anchored" data-anchor-id="cox-2090">Cox (20,90)</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-r-cox2_27f84ff2678ca5f27418646db5ec671a">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(cox2reso, <span class="dv">2</span>, mean)<span class="sc">/</span><span class="fl">365.25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9566561 1.3641107</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(cox2reso, <span class="dv">2</span>, sd)<span class="sc">/</span><span class="fl">365.25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2510078 0.2445435</code></pre>
</div>
</div>
</section>
<section id="cox-g-formula" class="level4">
<h4 class="anchored" data-anchor-id="cox-g-formula">Cox g-formula</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-r-gform_1b9ab500d996eed0eee03768f8b11b75">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(coxgreso, <span class="dv">2</span>, mean)<span class="sc">/</span><span class="fl">365.25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.548957 2.703833</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(coxgreso, <span class="dv">2</span>, sd)<span class="sc">/</span><span class="fl">365.25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.05726278 0.04401984</code></pre>
</div>
</div>
</section>
<section id="cox-g-formula-using-risca-package" class="level4">
<h4 class="anchored" data-anchor-id="cox-g-formula-using-risca-package">Cox g-formula using RISCA package</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-r-gform-risca_4a4b98eafc534ac05b6ac1cec181b306">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>pbc3<span class="sc">$</span>followup<span class="ot">&lt;-</span>pbc3<span class="sc">$</span>days<span class="sc">/</span><span class="fl">365.25</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>coxf <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(followup, fail) <span class="sc">~</span> tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> pbc3, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RISCA)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>gc.ate <span class="ot">&lt;-</span> <span class="fu">gc.survival</span>(<span class="at">object=</span>coxf, <span class="at">data=</span>pbc3, </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">group=</span><span class="st">"tment"</span>, <span class="at">times=</span><span class="st">"followup"</span>, <span class="at">failures=</span><span class="st">"fail"</span>,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                      <span class="at">max.time=</span><span class="dv">3</span>, <span class="at">iterations=</span><span class="dv">1000</span>, <span class="at">effect=</span><span class="st">"ATE"</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">Placebo=</span>gc.ate<span class="sc">$</span>RMST0,<span class="at">CyA=</span>gc.ate<span class="sc">$</span>RMST1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        estimate  std.error ci.lower ci.upper
Placebo 2.553795 0.05834140 2.439448 2.668142
CyA     2.705696 0.04488675 2.617719 2.793672</code></pre>
</div>
</div>
</section>
</div>
<div id="tabset-10-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-10-2-tab">
<section id="non-parametric-using-proc-rmstreg" class="level4">
<h4 class="anchored" data-anchor-id="non-parametric-using-proc-rmstreg">Non-parametric using PROC RMSTREG</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-sas-proc-rmstreg_cc5b38dabda8d0e7fa048eb205b9956d">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sort<span class="kw"> data</span>=pbc3 out=pbc3sorted;</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> tment;</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> rmstreg<span class="kw"> data</span>=pbc3sorted tau=<span class="dv">3</span>;</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">by</span> tment;</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> followup*status(<span class="dv">0</span>)= / </span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">link</span>=linear method=ipcw(strata=tment);</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="co">* Bootstrapping using 'point=';</span> </span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> bootpbc;</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="kw">    do</span> sampnum = <span class="dv">1</span> <span class="kw">to</span> <span class="dv">1000</span>; <span class="co">/* nboot=1000*/</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="kw">        do</span> i = <span class="dv">1</span> <span class="kw">to</span> <span class="dv">349</span>;      <span class="co">/*nobs=349*/</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">x</span>=<span class="fu">round</span>(<span class="fu">ranuni</span>(<span class="dv">0</span>)*<span class="dv">349</span>); </span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>            <span class="kw">set</span> pbc3</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">point</span>=<span class="kw">x</span>;</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">output</span>;</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="kw">        end</span>;</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">stop</span>;</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sort<span class="kw"> data</span>=bootpbc out=boot;</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">by</span> sampnum tment;</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> rmstreg<span class="kw"> data</span>=boot tau=<span class="dv">3</span>;</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">by</span> sampnum tment;</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> followup*status(<span class="dv">0</span>)= / </span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">link</span>=linear method=ipcw(strata=tment);</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>    ods <span class="kw">output</span> parameterestimates=pe;</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=pe <span class="fu">mean</span> stddev;</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>  class tment;</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">var</span> estimate;</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="macro-and-bootstrap-data-set" class="level4">
<h4 class="anchored" data-anchor-id="macro-and-bootstrap-data-set">Macro and bootstrap data set</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-macro_7daab935235ece94914f6383f63f96a6">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">* Bootstrapping using 'point=';</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> bootpbc;</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="kw">    do</span> sampnum = <span class="dv">1</span> <span class="kw">to</span> <span class="dv">1000</span>; <span class="co">/* nboot=1000*/</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="kw">        do</span> i = <span class="dv">1</span> <span class="kw">to</span> <span class="dv">349</span>;      <span class="co">/*nobs=349*/</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>            <span class="kw">x</span>=<span class="fu">round</span>(<span class="fu">ranuni</span>(<span class="dv">0</span>)*<span class="dv">349</span>); </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">set</span> pbc3</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">point</span>=<span class="kw">x</span>;</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">output</span>;</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="kw">        end</span>;</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">stop</span>;</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="co">* AUC under stepcurves;</span> </span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="kw">%macro</span> areastepby(data,byvar,trt,grp,time,y,tau);</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> <span class="kw">select</span>;</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">set</span> <span class="kw">&amp;data;</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">where</span> <span class="kw">&amp;trt=&amp;grp;</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> <span class="kw">select</span>;</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">set</span> <span class="kw">select</span>;</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">by</span> <span class="kw">&amp;byvar;</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">retain</span> mu oldt oldy;</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> first.<span class="kw">&amp;byvar then do</span>;</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>            oldt=<span class="dv">0</span>; oldy=<span class="dv">1</span>; mu=<span class="dv">0</span>;</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a><span class="kw">        end</span>;</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="kw">&amp;time&gt;&amp;tau then do</span>;</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&amp;time=&amp;tau;</span> <span class="kw">&amp;y=</span>oldy;</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a><span class="kw">        end</span>;</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="kw">not</span> first.<span class="kw">&amp;byvar then</span> mu+oldy*(<span class="kw">&amp;time-</span>oldt);</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> last.<span class="kw">&amp;byvar then do</span>;</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="kw">&amp;time&lt;&amp;tau then</span> mu+(<span class="kw">&amp;tau-&amp;time)</span>*<span class="kw">&amp;y; end</span>;</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>        oldy=<span class="kw">&amp;y;</span> oldt=<span class="kw">&amp;time;</span></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> last; <span class="kw">set</span> <span class="kw">select</span>;</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">by</span>  <span class="kw">&amp;byvar;</span></span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> last.<span class="kw">&amp;byvar;</span></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a><span class="kw">%mend</span> areastepby;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="non-parametric-using-macro" class="level4">
<h4 class="anchored" data-anchor-id="non-parametric-using-macro">Non-parametric using macro</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-nonparm_4a9715d0eb0cd8a9a0f94ccfc65bafcf">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bootpbc noprint;</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> sampnum;</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> followup*status(<span class="dv">0</span>)=;</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    strata tment;</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    baseline out=survdat survival=km / method=pl;</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>%areastepby(survdat,sampnum,tment,0,followup,km,3);</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"Placebo"</span>;</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">var</span> mu;</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>%areastepby(survdat,sampnum,tment,1,followup,km,3);</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"CyA"</span>;</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">var</span> mu;</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="cox-3845-using-macro" class="level4">
<h4 class="anchored" data-anchor-id="cox-3845-using-macro">Cox (38,45) using macro</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-sas-38-45_2732b4012e3f6b2c85a24b67c9cf455b">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    tment=<span class="dv">0</span>; alb=<span class="dv">38</span>; log2bili=<span class="fu">log2</span>(<span class="dv">45</span>); <span class="kw">output</span>;</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    tment=<span class="dv">1</span>; alb=<span class="dv">38</span>; log2bili=<span class="fu">log2</span>(<span class="dv">45</span>); <span class="kw">output</span>;</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bootpbc noprint;</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> sampnum;</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> followup*status(<span class="dv">0</span>)=tment alb log2bili/rl;</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    baseline out=predsurv survival=surv covariates=cov/ method=breslow;</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>%areastepby(predsurv,sampnum,tment,0,followup,surv,3);</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"Placebo"</span>;</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">var</span> mu;</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>%areastepby(predsurv,sampnum,tment,1,followup,surv,3);</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"CyA"</span>;</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">var</span> mu;</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="cox-2090-using-macro" class="level4">
<h4 class="anchored" data-anchor-id="cox-2090-using-macro">Cox (20,90) using macro</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-sas-20-90_0e5364fa0ed959df3e38a5aa7731e637">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    tment=<span class="dv">0</span>; alb=<span class="dv">20</span>; log2bili=<span class="fu">log2</span>(<span class="dv">90</span>); <span class="kw">output</span>;</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    tment=<span class="dv">1</span>; alb=<span class="dv">20</span>; log2bili=<span class="fu">log2</span>(<span class="dv">90</span>); <span class="kw">output</span>;</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bootpbc noprint;</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> sampnum;</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> followup*status(<span class="dv">0</span>)=tment alb log2bili/rl;</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    baseline out=predsurv2 survival=surv covariates=cov/ method=breslow;</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>%areastepby(predsurv2,sampnum,tment,0,followup,surv,3);</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"Placebo"</span>;</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">var</span> mu;</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>%areastepby(predsurv2,sampnum,tment,1,followup,surv,3);</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"CyA"</span>;</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">var</span> mu;</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="cox-g-formula-using-macro" class="level4">
<h4 class="anchored" data-anchor-id="cox-g-formula-using-macro">Cox g-formula using macro</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.1-sas-gform_4c2595f01ab3f416ad2902e83bcb9913">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bootpbc noprint;</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> sampnum;</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    class tment (ref=<span class="st">'0'</span>);</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> followup*status(<span class="dv">0</span>)=tment alb log2bili/rl;</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    baseline out=gsurv survival=surv <span class="fu">stderr</span>=se/ method=breslow diradj <span class="kw">group</span>=tment;</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>%areastepby(gsurv,sampnum,tment,0,followup,surv,3);</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"Placebo"</span>;</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">var</span> mu;</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>%areastepby(gsurv,sampnum,tment,1,followup,surv,3);</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"CyA"</span>;</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">var</span> mu;</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</div>
</div>
</div>
</section>
<section id="figure-4.10" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.10">Figure 4.10</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-11-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-1" role="tab" aria-controls="tabset-11-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-11-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-2" role="tab" aria-controls="tabset-11-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-11-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-11-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.10-r_4fe982178a0244cc0241322649e587d7">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative incidences are estimated using Aalen-Johansen</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall survival </span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>overall_surv <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(days, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> <span class="fu">subset</span>(pbc3, tment_char <span class="sc">==</span> <span class="st">"Placebo"</span>))</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Cause 1 survival: transplantation</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>cause1_cif <span class="ot">&lt;-</span> <span class="fu">cif</span>(<span class="fu">Event</span>(days, status) <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> <span class="fu">subset</span>(pbc3, tment_char <span class="sc">==</span> <span class="st">"Placebo"</span>), </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cause =</span> <span class="dv">1</span>)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Cause 2 survival: death w/o transplantation</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>cause2_cif <span class="ot">&lt;-</span> <span class="fu">cif</span>(<span class="fu">Event</span>(days, status) <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> <span class="fu">subset</span>(pbc3, tment_char <span class="sc">==</span> <span class="st">"Placebo"</span>), </span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cause =</span> <span class="dv">2</span>)</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Get them on the same time scale - book keeping</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>alltimes <span class="ot">&lt;-</span> overall_surv<span class="sc">$</span>time</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>cause1st <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(<span class="at">x =</span> cause1_cif<span class="sc">$</span>cumhaz[,<span class="dv">1</span>], <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, cause1_cif<span class="sc">$</span>cumhaz[,<span class="dv">2</span>]))</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>cause1times <span class="ot">&lt;-</span> <span class="fu">cause1st</span>(<span class="at">v =</span> alltimes)</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>cause2st <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(<span class="at">x =</span> cause2_cif<span class="sc">$</span>cumhaz[,<span class="dv">1</span>], <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, cause2_cif<span class="sc">$</span>cumhaz[,<span class="dv">2</span>]))</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>cause2times <span class="ot">&lt;-</span> <span class="fu">cause2st</span>(<span class="at">v =</span> alltimes)</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect the data </span></span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>data_comb <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">cif =</span> <span class="fu">c</span>(overall_surv<span class="sc">$</span>surv <span class="sc">+</span> cause1times <span class="sc">+</span> cause2times, </span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>                                cause1times <span class="sc">+</span> cause2times, </span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>                                cause1times),</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>                        <span class="at">time =</span> <span class="fu">c</span>(alltimes, alltimes, alltimes),</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Overall"</span>, <span class="fu">length</span>(alltimes)), </span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"Transplantation + death without transplantation"</span>, <span class="fu">length</span>(alltimes)), </span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"Transplantation"</span>, <span class="fu">length</span>(alltimes)))</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure 4.10</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.10</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> cif, <span class="at">linetype =</span> type), </span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> data_comb) <span class="sc">+</span> </span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Type"</span>) <span class="sc">+</span> </span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Stacked cumulative incidence and survival"</span>) <span class="sc">+</span> </span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)), </span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>), </span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)), </span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>), </span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span> </span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>,</span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box=</span><span class="st">"vertical"</span>,</span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">21</span>), </span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>))</span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-58"><a href="#cb62-58" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.10-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-11-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-11-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.10-sas_8015915955e7fde7ff33bbedc41788ac">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3 noprint;</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> days*status(<span class="dv">0</span>)=;</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>baseline out=overallsurv survival=surv / method=;</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sort;<span class="kw">by</span> tment days<span class="kw">;run</span>;</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3 noprint;</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> days*status(<span class="dv">0</span>)=/eventcode=<span class="dv">1</span>;</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>strata tment;</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>baseline out=cuminc1 cif=cif1;</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sort;<span class="kw">by</span> tment days<span class="kw">;run</span>;</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3 noprint;</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> days*status(<span class="dv">0</span>)=/eventcode=<span class="dv">2</span>;</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>strata tment;</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>baseline out=cuminc2 cif=cif2;</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sort;<span class="kw">by</span> tment days<span class="kw">;run</span>;</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot0; </span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> overallsurv cuminc1 cuminc2; </span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> tment days;</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> tment=<span class="dv">0</span>;</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>fail=<span class="dv">1</span>-surv;</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot0ok; </span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> plot0;</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> days;</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a><span class="kw">retain</span> last0 last1 last2;</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> fail=. <span class="kw">then</span> c0=last0; <span class="kw">if</span> fail ne . <span class="kw">then</span> c0=fail;</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> cif1=. <span class="kw">then</span> c1=last1; <span class="kw">if</span> cif1 ne . <span class="kw">then</span> c1=cif1;</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> cif2=. <span class="kw">then</span> c2=last2; <span class="kw">if</span> cif2 ne . <span class="kw">then</span> c2=cif2;</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a><span class="kw">output</span>;</span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>last0=c0; last1=c1; last2=c2;</span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot0ok; </span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> plot0ok;</span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>cum1=c1; </span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>cum2=c1+c2; </span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>cum3=c1+c2+(<span class="dv">1</span>-c0);</span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> print<span class="kw">;run</span>;</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot0ok; </span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> plot0ok; </span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>daysyears = days/<span class="dv">365.25</span>; </span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot </span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span>=plot0ok;</span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a>plot cum1*daysyears cum2*daysyears cum3*daysyears /overlay haxis=axis1 vaxis=axis2;</span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a>axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Stacked cumulative incidence and survival'</span>);</span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a>symbol1  v=none i=stepjl c=blue;</span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>symbol2  v=none i=stepjl c=red;</span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a>symbol3  v=none i=stepjl c=black;</span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.11" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.11">Figure 4.11</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-12-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-1" role="tab" aria-controls="tabset-12-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-12-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-2" role="tab" aria-controls="tabset-12-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-12-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-12-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.11-r_1a435fdab959ad86156aa1508427cc37">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative incidences are (wrongly) estimated using Kaplan-Meier</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall survival </span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>overall_surv <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(days, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> <span class="fu">subset</span>(pbc3, tment_char <span class="sc">==</span> <span class="st">"Placebo"</span>))</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Cause 1 survival: transplantation, KM</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>cause1_cif_w <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> <span class="fu">subset</span>(pbc3, tment_char <span class="sc">==</span> <span class="st">"Placebo"</span>))</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Cause 2 survival: death w/o transplantation, KM</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>cause2_cif_w <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> <span class="fu">subset</span>(pbc3, tment_char <span class="sc">==</span> <span class="st">"Placebo"</span>))</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Get them on the same time scale - book keeping</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>alltimes <span class="ot">&lt;-</span> overall_surv<span class="sc">$</span>time</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>cause1st <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(<span class="at">x =</span> cause1_cif_w<span class="sc">$</span>time, <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, cause1_cif_w<span class="sc">$</span>surv))</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>cause1times <span class="ot">&lt;-</span> <span class="fu">cause1st</span>(<span class="at">v =</span> alltimes)</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>cause2st <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(<span class="at">x =</span> cause2_cif_w<span class="sc">$</span>time, <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, cause2_cif_w<span class="sc">$</span>surv))</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>cause2times <span class="ot">&lt;-</span> <span class="fu">cause2st</span>(<span class="at">v =</span> alltimes)</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect the data </span></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>data_comb <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">cif_w =</span> <span class="fu">c</span>(overall_surv<span class="sc">$</span>surv <span class="sc">+</span> <span class="dv">1</span><span class="sc">-</span>cause1times <span class="sc">+</span> <span class="dv">1</span><span class="sc">-</span>cause2times, </span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">1</span><span class="sc">-</span>cause1times <span class="sc">+</span> <span class="dv">1</span><span class="sc">-</span>cause2times, </span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">1</span><span class="sc">-</span>cause1times),</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>                        <span class="at">time =</span> <span class="fu">c</span>(alltimes, alltimes, alltimes),</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Overall"</span>, <span class="fu">length</span>(alltimes)), </span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"Transplantation + death without transplantation"</span>, <span class="fu">length</span>(alltimes)), </span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"Transplantation"</span>, <span class="fu">length</span>(alltimes)))</span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure</span></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> cif_w, <span class="at">linetype =</span> type), </span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> data_comb) <span class="sc">+</span> </span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Type"</span>) <span class="sc">+</span> </span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Stacked cumulative incidence and survival"</span>) <span class="sc">+</span> </span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)), </span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>), </span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)), </span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.1</span>), </span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.1</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb64-48"><a href="#cb64-48" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb64-49"><a href="#cb64-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span> </span>
<span id="cb64-50"><a href="#cb64-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.box=</span><span class="st">"vertical"</span>,</span>
<span id="cb64-51"><a href="#cb64-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">21</span>), </span>
<span id="cb64-52"><a href="#cb64-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>))</span>
<span id="cb64-53"><a href="#cb64-53" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.11</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.11-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-12-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-12-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.11-sas_e4286ccb21032ba673355365c714dcae">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3 noprint;</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span> <span class="dv">2</span>)=;</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    strata tment;</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    baseline out=cuminc1wrng survival=s1wrng;</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3 noprint;</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span> <span class="dv">1</span>)=;</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    baseline out=cuminc2wrng survival=s2wrng;</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    strata tment;</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot0wrng; </span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">merge</span> overallsurv cuminc1wrng cuminc2wrng; </span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> tment=<span class="dv">0</span>; <span class="kw">by</span> days;</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot0wrng; </span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> plot0wrng;</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> days;</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> last1 last2;</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> s1wrng=. <span class="kw">then</span> c1=last1; <span class="kw">if</span> s1wrng ne . <span class="kw">then</span> c1=<span class="dv">1</span>-s1wrng;</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> s2wrng=. <span class="kw">then</span> c2=last2; <span class="kw">if</span> s2wrng ne . <span class="kw">then</span> c2=<span class="dv">1</span>-s2wrng;</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output</span>;</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>    last1=c1; last2=c2;</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot0wrng; </span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> plot0wrng;</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>    cum1=c1; cum2=c1+c2; cum3=c1+c2+surv; one=<span class="dv">1</span>;</span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot0wrng; </span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> plot0wrng; </span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>    daysyears = days/<span class="dv">365.25</span>; </span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot </span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span>=plot0wrng;</span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a>    plot cum1*daysyears cum2*daysyears cum3*daysyears one*daysyears</span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>         /overlay haxis=axis1 vaxis=axis2;</span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1.1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Stacked cumulative incidence and survival'</span>);</span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>    symbol3  v=none i=stepjl c=black;</span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>    symbol4  v=none i=stepjl l=<span class="dv">2</span> c=black;</span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.12" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.12">Figure 4.12</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-13-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-1" role="tab" aria-controls="tabset-13-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-13-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-2" role="tab" aria-controls="tabset-13-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-13-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-13-1-tab">
<section id="figure-4.12-a" class="level4">
<h4 class="anchored" data-anchor-id="figure-4.12-a">Figure 4.12 (a)</h4>
<div class="cell" data-hash="Ch4_cache/html/figure-4.12a-r_d6976e43e686028fa4feb4776d8fc66e">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>overall_cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili <span class="sc">+</span> sex <span class="sc">+</span> age,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> <span class="fu">subset</span>(pbc3, <span class="sc">!</span><span class="fu">is.na</span>(alb)),</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">method =</span> <span class="st">"breslow"</span>, <span class="at">eps=</span><span class="fl">1e-9</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Cause 1: transplantation</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>cause1_cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili <span class="sc">+</span> sex <span class="sc">+</span> age,</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> <span class="fu">subset</span>(pbc3, <span class="sc">!</span><span class="fu">is.na</span>(alb)), </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">method =</span> <span class="st">"breslow"</span>, <span class="at">eps=</span><span class="fl">1e-9</span>)</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Cause 2: death w/o transplantation</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>cause2_cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">~</span> tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili <span class="sc">+</span> sex <span class="sc">+</span> age,</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> <span class="fu">subset</span>(pbc3, <span class="sc">!</span><span class="fu">is.na</span>(alb)), </span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">method =</span> <span class="st">"breslow"</span>, <span class="at">eps=</span><span class="fl">1e-9</span>)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="co"># for tment = placebo, age = 40, alb = 38, bili = log2(45) and sex = F</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>newd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="dv">0</span>, <span class="at">age =</span> <span class="dv">40</span>, </span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>                   <span class="at">alb =</span> <span class="dv">38</span>, <span class="at">log2bili =</span> <span class="fu">log2</span>(<span class="dv">45</span>), </span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sex =</span> <span class="dv">0</span>)</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>est_cause1 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cause1_cox, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd)<span class="sc">$</span>cumhaz </span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>est_cause2 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cause2_cox, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd)<span class="sc">$</span>cumhaz </span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>est_overall <span class="ot">&lt;-</span> <span class="fu">survfit</span>(overall_cox, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd)<span class="sc">$</span>surv</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate S, and F1 and F2</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>alltimes <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(overall_cox, <span class="at">centered =</span> F)<span class="sc">$</span>time</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, est_cause1 <span class="sc">+</span> est_cause2)))</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>dA <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, A))</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">-</span>dA) <span class="co">#exp(-cumsum(dA)) </span></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>A1 <span class="ot">&lt;-</span> est_cause1</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>A2 <span class="ot">&lt;-</span> est_cause2</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(alltimes, A, dA, S, A1, A2))</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>dat2 <span class="ot">&lt;-</span> <span class="fu">subset</span>(dat, dA <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>dat2<span class="sc">$</span>lagS <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, <span class="fu">c</span>(<span class="dv">0</span>, S[<span class="sc">-</span><span class="fu">length</span>(S)])) </span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>dat2<span class="sc">$</span>F1 <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, <span class="fu">cumsum</span>(lagS <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, A1))))</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>dat2<span class="sc">$</span>F2 <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, <span class="fu">cumsum</span>(lagS <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, A2))))</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect the data</span></span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>data_comb <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, </span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">data.frame</span>(<span class="at">cif_w =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(alltimes)),</span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a>                                       F1 <span class="sc">+</span> F2,</span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a>                                       F1),</span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a>                             <span class="at">time =</span> <span class="fu">c</span>(alltimes, alltimes, alltimes),</span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a>                             <span class="at">type =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Overall"</span>, <span class="fu">length</span>(alltimes)),</span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rep</span>(<span class="st">"Transplantation + death without transplantation"</span>, <span class="fu">length</span>(alltimes)),</span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rep</span>(<span class="st">"Transplantation"</span>, <span class="fu">length</span>(alltimes)))</span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a>                  ))</span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure</span></span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.12</span>a <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> cif_w, <span class="at">linetype =</span> type),</span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> data_comb) <span class="sc">+</span></span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Type"</span>) <span class="sc">+</span></span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span></span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Stacked cumulative incidence and survival"</span>) <span class="sc">+</span></span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>),</span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span></span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span> </span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.box=</span><span class="st">"vertical"</span>,</span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">22</span>), </span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>))</span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-75"><a href="#cb66-75" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.12</span>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.12a-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</section>
<section id="figure-4.12-b" class="level4">
<h4 class="anchored" data-anchor-id="figure-4.12-b">Figure 4.12 (b)</h4>
<div class="cell" data-hash="Ch4_cache/html/figure-4.12b-r_de8ffe65679874abd8ff0eb68d6fc5ff">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for tment = placebo, age = 40, alb = 20, bili = log2(90) and sex = F</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>newd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="dv">0</span>, <span class="at">age =</span> <span class="dv">40</span>, </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">alb =</span> <span class="dv">20</span>, <span class="at">log2bili =</span> <span class="fu">log2</span>(<span class="dv">90</span>), </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">sex =</span> <span class="dv">0</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>est_cause1 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cause1_cox, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd)<span class="sc">$</span>cumhaz</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>est_cause2 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cause2_cox, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd)<span class="sc">$</span>cumhaz</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>est_overall <span class="ot">&lt;-</span> <span class="fu">survfit</span>(overall_cox, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd)<span class="sc">$</span>surv</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate S, and F1 and F2</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>alltimes <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(overall_cox, <span class="at">centered =</span> F)<span class="sc">$</span>time</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, est_cause1 <span class="sc">+</span> est_cause2)))</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>dA <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, A))</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">-</span>dA) <span class="co">#exp(-cumsum(dA)) </span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>A1 <span class="ot">&lt;-</span> est_cause1</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>A2 <span class="ot">&lt;-</span> est_cause2</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(alltimes, A, dA, S, A1, A2))</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>dat2 <span class="ot">&lt;-</span> <span class="fu">subset</span>(dat, dA <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>dat2<span class="sc">$</span>lagS <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, <span class="fu">c</span>(<span class="dv">0</span>, S[<span class="sc">-</span><span class="fu">length</span>(S)])) </span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>dat2<span class="sc">$</span>F1 <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, <span class="fu">cumsum</span>(lagS <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, A1))))</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>dat2<span class="sc">$</span>F2 <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, <span class="fu">cumsum</span>(lagS <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, A2))))</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect the data</span></span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>data_comb <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, </span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">data.frame</span>(<span class="at">cif_w =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(alltimes)),</span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>                                  F1 <span class="sc">+</span> F2,</span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a>                                  F1),</span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a>                        <span class="at">time =</span> <span class="fu">c</span>(alltimes, alltimes, alltimes),</span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Overall"</span>, <span class="fu">length</span>(alltimes)),</span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"Transplantation + death without transplantation"</span>, <span class="fu">length</span>(alltimes)),</span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">rep</span>(<span class="st">"Transplantation"</span>, <span class="fu">length</span>(alltimes)))))</span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure</span></span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.12</span>b <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> cif_w, <span class="at">linetype =</span> type),</span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> data_comb) <span class="sc">+</span></span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Type"</span>) <span class="sc">+</span></span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span></span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Stacked cumulative incidence and survival"</span>) <span class="sc">+</span></span>
<span id="cb67-47"><a href="#cb67-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb67-48"><a href="#cb67-48" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>),</span>
<span id="cb67-49"><a href="#cb67-49" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb67-50"><a href="#cb67-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb67-51"><a href="#cb67-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb67-52"><a href="#cb67-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb67-53"><a href="#cb67-53" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span></span>
<span id="cb67-54"><a href="#cb67-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span> </span>
<span id="cb67-55"><a href="#cb67-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.box=</span><span class="st">"vertical"</span>,</span>
<span id="cb67-56"><a href="#cb67-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">22</span>), </span>
<span id="cb67-57"><a href="#cb67-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>))</span>
<span id="cb67-58"><a href="#cb67-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-59"><a href="#cb67-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-60"><a href="#cb67-60" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.12</span>b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.12b-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</section>
<section id="figure-4.12-c" class="level4">
<h4 class="anchored" data-anchor-id="figure-4.12-c">Figure 4.12 (c)</h4>
<div class="cell" data-hash="Ch4_cache/html/figure-4.12c-r_ec19f8ca8cc17c805dfe84ebdc7eee63">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for tment = placebo, age = 60, alb = 38, bili = log2(45) and sex = F</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>newd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="dv">0</span>, <span class="at">age =</span> <span class="dv">60</span>, </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">alb =</span> <span class="dv">38</span>, <span class="at">log2bili =</span> <span class="fu">log2</span>(<span class="dv">45</span>), </span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sex =</span> <span class="dv">0</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>est_cause1 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cause1_cox, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd)<span class="sc">$</span>cumhaz</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>est_cause2 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cause2_cox, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd)<span class="sc">$</span>cumhaz</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>est_overall <span class="ot">&lt;-</span> <span class="fu">survfit</span>(overall_cox, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd)<span class="sc">$</span>surv</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate S, and F1 and F2</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>alltimes <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(overall_cox, <span class="at">centered =</span> F)<span class="sc">$</span>time</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, est_cause1 <span class="sc">+</span> est_cause2)))</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>dA <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, A))</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">cumprod</span>(<span class="dv">1</span><span class="sc">-</span>dA) <span class="co">#exp(-cumsum(dA)) </span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>A1 <span class="ot">&lt;-</span> est_cause1</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>A2 <span class="ot">&lt;-</span> est_cause2</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(alltimes, A, dA, S, A1, A2))</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>dat2 <span class="ot">&lt;-</span> <span class="fu">subset</span>(dat, dA <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>dat2<span class="sc">$</span>lagS <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, <span class="fu">c</span>(<span class="dv">0</span>, S[<span class="sc">-</span><span class="fu">length</span>(S)])) </span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>dat2<span class="sc">$</span>F1 <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, <span class="fu">cumsum</span>(lagS <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, A1))))</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>dat2<span class="sc">$</span>F2 <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, <span class="fu">cumsum</span>(lagS <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, A2))))</span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect the data</span></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>data_comb <span class="ot">&lt;-</span> <span class="fu">with</span>(dat2, </span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">data.frame</span>(<span class="at">cif_w =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(alltimes)), F1 <span class="sc">+</span> F2, F1),</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>                             <span class="at">time =</span> <span class="fu">c</span>(alltimes, alltimes, alltimes),</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>                             <span class="at">type =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Overall"</span>, <span class="fu">length</span>(alltimes)),</span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rep</span>(<span class="st">"Transplantation + death without transplantation"</span>,</span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>                                          <span class="fu">length</span>(alltimes)),</span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">rep</span>(<span class="st">"Transplantation"</span>, <span class="fu">length</span>(alltimes)))))</span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure</span></span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.12</span>c <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> cif_w, <span class="at">linetype =</span> type),</span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> data_comb) <span class="sc">+</span></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Type"</span>) <span class="sc">+</span></span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Stacked cumulative incidence and survival"</span>) <span class="sc">+</span></span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>),</span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)),</span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span> </span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>,</span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.box=</span><span class="st">"vertical"</span>,</span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">22</span>), </span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"cm"</span>))</span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.12</span>c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.12c-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</section>
</div>
<div id="tabset-13-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-13-2-tab">
<section id="macro-and-double-data-set" class="level4">
<h4 class="anchored" data-anchor-id="macro-and-double-data-set">Macro and double data set</h4>
<p>The SAS macro below can alternatively be loaded using this code:</p>
<div class="cell" data-hash="Ch4_cache/html/sas-macro-cuminc_aa879d646811e3e13662ae53476fbc9d">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">filename</span> cumincpr url <span class="st">'http://publicifsv.sund.ku.dk/~pka/CumInc.sas'</span>;</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>%inc cumincpr;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="Ch4_cache/html/figure-4.12-sas-macro_eb06dbbec3e1195fc37ab3b233ac703b">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">%macro</span> CumInc(Data,Strata,Time,Surv);</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co">/* Number of Stratas */</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="kw">  proc</span> sort<span class="kw"> data</span>=<span class="kw">&amp;Data;</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> <span class="kw">&amp;Strata;</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> nstrat;</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="kw">&amp;Data end</span>=last;</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> <span class="kw">&amp;Strata;</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>firstS=first.<span class="kw">&amp;Strata;</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="kw">retain</span> nStrata <span class="dv">0</span>;</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>nStrata+firstS;</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> last <span class="kw">then</span> <span class="kw">call</span> symput(<span class="st">'nStrata'</span>,nStrata);</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> firstS;</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="co">/* Observations in ciData are deleted */</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a><span class="kw">  data</span> newData; </span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> <span class="kw">&amp;Data;</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>start=(<span class="kw">&amp;Time </span>eq <span class="dv">0</span>);   </span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a><span class="kw">retain</span> komb <span class="dv">0</span>;</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>komb+start;</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>med=<span class="dv">0</span>;</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="kw">%do</span> k=<span class="dv">0</span> <span class="kw">%to</span> (<span class="kw">&amp;nStrata-</span><span class="dv">1</span>) %by 1;</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>med=med+(komb eq (<span class="dv">1</span>+<span class="kw">&amp;k*</span>(<span class="kw">&amp;nStrata+</span><span class="dv">1</span>)));</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a><span class="kw">%end</span>;</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> (med eq <span class="dv">1</span>);  </span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> start med komb;</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a><span class="co">/* Time vector */</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a><span class="kw">  proc</span> sort<span class="kw"> data</span>=newData;</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> <span class="kw">&amp;Time;</span></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="fu">Time</span> (<span class="kw">keep</span>=<span class="kw">&amp;Time)</span>; </span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> newData;</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a><span class="kw">%do</span> i=<span class="dv">1</span> <span class="kw">%to</span> <span class="kw">&amp;nStrata </span>%by 1;</span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="kw">&amp;Time=</span><span class="fu">lag</span>(<span class="kw">&amp;Time)</span> <span class="kw">then</span> <span class="kw">delete</span>;</span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a><span class="kw">%end</span>;</span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a><span class="co">/* Strata vector */</span></span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a><span class="kw">  proc</span> sort<span class="kw"> data</span>=newData;</span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> <span class="kw">&amp;Strata &amp;Time;</span></span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> temp1;</span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> newData; <span class="kw">by</span> <span class="kw">&amp;Strata;</span></span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a><span class="kw">retain</span> stratum <span class="dv">0</span>;</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a>stratum+first.<span class="kw">&amp;Strata;</span></span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a><span class="co">/*  A=sum(A_1,...,A_nStrata) */</span></span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>  <span class="kw">%do</span> i=<span class="dv">1</span> <span class="kw">%to</span> <span class="kw">&amp;nStrata </span>%by 1;</span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a><span class="kw">data data&amp;i;</span></span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> temp1;</span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> stratum=<span class="kw">&amp;i;</span></span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a><span class="kw">data data&amp;i </span>(<span class="kw">keep</span> = <span class="kw">&amp;Time </span>A<span class="kw">&amp;i)</span>;</span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a><span class="kw">merge data&amp;i </span><span class="fu">Time</span>; <span class="kw">by</span> <span class="kw">&amp;Time;</span>  </span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a><span class="kw">retain</span> Surv<span class="kw">&amp;i;</span></span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="kw">not</span> (<span class="kw">&amp;Surv=</span>.) <span class="kw">then</span> Surv<span class="kw">&amp;i=&amp;Surv;</span></span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a>A<span class="kw">&amp;i=</span>-<span class="fu">log</span>(Surv<span class="kw">&amp;i)</span>;</span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a><span class="kw">%end</span>;</span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> A_and_S;</span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a>A=<span class="dv">0</span>;</span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a><span class="kw">%do</span> i=<span class="dv">1</span> <span class="kw">%to</span> <span class="kw">&amp;nStrata </span>%by 1;</span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a><span class="kw">merge data&amp;i;</span> <span class="kw">by</span> <span class="kw">&amp;Time;</span></span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a>A+A<span class="kw">&amp;i;</span></span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a><span class="kw">%end</span>;</span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a>dA=A-<span class="fu">lag</span>(A);</span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> dA eq . <span class="kw">then</span> dA=<span class="dv">0</span>;</span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a><span class="kw">retain</span> S <span class="dv">1</span>;</span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a>S+S*(<span class="dv">1</span>-dA)-S;</span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a>lagS=<span class="fu">lag</span>(S);</span>
<span id="cb70-86"><a href="#cb70-86" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb70-87"><a href="#cb70-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-88"><a href="#cb70-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-89"><a href="#cb70-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-90"><a href="#cb70-90" aria-hidden="true" tabindex="-1"></a><span class="co">/* Output */</span></span>
<span id="cb70-91"><a href="#cb70-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-92"><a href="#cb70-92" aria-hidden="true" tabindex="-1"></a><span class="kw">  data</span> temp2 (<span class="kw">keep</span> = <span class="kw">&amp;Strata &amp;Time)</span>;</span>
<span id="cb70-93"><a href="#cb70-93" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> temp1; </span>
<span id="cb70-94"><a href="#cb70-94" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sort<span class="kw"> data</span>=temp2; <span class="kw">by</span> <span class="kw">&amp;Time;</span></span>
<span id="cb70-95"><a href="#cb70-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-96"><a href="#cb70-96" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> temp3;</span>
<span id="cb70-97"><a href="#cb70-97" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> temp2 A_and_S; <span class="kw">by</span> <span class="kw">&amp;Time;</span></span>
<span id="cb70-98"><a href="#cb70-98" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sort<span class="kw"> data</span>=temp3; <span class="kw">by</span> <span class="kw">&amp;Strata &amp;Time;</span></span>
<span id="cb70-99"><a href="#cb70-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-100"><a href="#cb70-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-101"><a href="#cb70-101" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> data0 (<span class="kw">keep</span> = <span class="kw">&amp;Time </span>p stratum);</span>
<span id="cb70-102"><a href="#cb70-102" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> temp3; <span class="kw">by</span> <span class="kw">&amp;Strata;</span></span>
<span id="cb70-103"><a href="#cb70-103" aria-hidden="true" tabindex="-1"></a><span class="co">*   lagS=lag(S);</span></span>
<span id="cb70-104"><a href="#cb70-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-105"><a href="#cb70-105" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> first.<span class="kw">&amp;Strata then do</span>;</span>
<span id="cb70-106"><a href="#cb70-106" aria-hidden="true" tabindex="-1"></a>lagS=<span class="dv">1</span><span class="kw">; end</span>;</span>
<span id="cb70-107"><a href="#cb70-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-108"><a href="#cb70-108" aria-hidden="true" tabindex="-1"></a><span class="kw">retain</span> stratum <span class="dv">0</span>;</span>
<span id="cb70-109"><a href="#cb70-109" aria-hidden="true" tabindex="-1"></a>stratum+first.<span class="kw">&amp;Strata;</span></span>
<span id="cb70-110"><a href="#cb70-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-111"><a href="#cb70-111" aria-hidden="true" tabindex="-1"></a><span class="kw">%do</span> i=<span class="dv">1</span> <span class="kw">%to</span> <span class="kw">&amp;nStrata </span>%by 1;</span>
<span id="cb70-112"><a href="#cb70-112" aria-hidden="true" tabindex="-1"></a>lagA<span class="kw">&amp;i=</span><span class="fu">lag</span>(A<span class="kw">&amp;i)</span>;</span>
<span id="cb70-113"><a href="#cb70-113" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> ((stratum eq <span class="kw">&amp;i)</span> <span class="kw">and</span> (first.<span class="kw">&amp;Strata)</span>) <span class="kw">then</span> lagA<span class="kw">&amp;i=</span><span class="dv">0</span>;</span>
<span id="cb70-114"><a href="#cb70-114" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> (stratum ne <span class="kw">&amp;i)</span> <span class="kw">then</span> lagA<span class="kw">&amp;i=</span><span class="dv">0</span>;</span>
<span id="cb70-115"><a href="#cb70-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-116"><a href="#cb70-116" aria-hidden="true" tabindex="-1"></a>l<span class="kw">&amp;i=</span>(stratum=<span class="kw">&amp;i)</span>*(lagS*(A<span class="kw">&amp;i-</span>lagA<span class="kw">&amp;i)</span>);</span>
<span id="cb70-117"><a href="#cb70-117" aria-hidden="true" tabindex="-1"></a><span class="kw">retain</span> p<span class="kw">&amp;i </span><span class="dv">0</span>;</span>
<span id="cb70-118"><a href="#cb70-118" aria-hidden="true" tabindex="-1"></a>p<span class="kw">&amp;i+</span>l<span class="kw">&amp;i;</span> </span>
<span id="cb70-119"><a href="#cb70-119" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> (stratum ne <span class="kw">&amp;i)</span> <span class="kw">then</span> p<span class="kw">&amp;i=</span><span class="dv">0</span>;</span>
<span id="cb70-120"><a href="#cb70-120" aria-hidden="true" tabindex="-1"></a><span class="kw">%end</span>;</span>
<span id="cb70-121"><a href="#cb70-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-122"><a href="#cb70-122" aria-hidden="true" tabindex="-1"></a>p=<span class="dv">0</span>;</span>
<span id="cb70-123"><a href="#cb70-123" aria-hidden="true" tabindex="-1"></a><span class="kw">%do</span> i=<span class="dv">1</span> <span class="kw">%to</span> <span class="kw">&amp;nStrata </span>%by 1;</span>
<span id="cb70-124"><a href="#cb70-124" aria-hidden="true" tabindex="-1"></a>p=p+p<span class="kw">&amp;i;</span> <span class="kw">%end</span>;</span>
<span id="cb70-125"><a href="#cb70-125" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb70-126"><a href="#cb70-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-127"><a href="#cb70-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-128"><a href="#cb70-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-129"><a href="#cb70-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-130"><a href="#cb70-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-131"><a href="#cb70-131" aria-hidden="true" tabindex="-1"></a><span class="co">/* put data into the right form */</span></span>
<span id="cb70-132"><a href="#cb70-132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-133"><a href="#cb70-133" aria-hidden="true" tabindex="-1"></a>  <span class="kw">%do</span> i=<span class="dv">1</span> <span class="kw">%to</span> <span class="kw">&amp;nStrata;</span></span>
<span id="cb70-134"><a href="#cb70-134" aria-hidden="true" tabindex="-1"></a><span class="kw">data data&amp;i;</span></span>
<span id="cb70-135"><a href="#cb70-135" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> data0;</span>
<span id="cb70-136"><a href="#cb70-136" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> (stratum eq <span class="kw">&amp;i)</span>;</span>
<span id="cb70-137"><a href="#cb70-137" aria-hidden="true" tabindex="-1"></a>p0<span class="kw">&amp;i=</span>p; <span class="kw">drop</span> p stratum;</span>
<span id="cb70-138"><a href="#cb70-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-139"><a href="#cb70-139" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sort<span class="kw"> data</span>=<span class="kw">data&amp;i;</span></span>
<span id="cb70-140"><a href="#cb70-140" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> <span class="kw">&amp;Time;</span></span>
<span id="cb70-141"><a href="#cb70-141" aria-hidden="true" tabindex="-1"></a><span class="kw">%end</span>;</span>
<span id="cb70-142"><a href="#cb70-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-143"><a href="#cb70-143" aria-hidden="true" tabindex="-1"></a><span class="kw">data data</span>;</span>
<span id="cb70-144"><a href="#cb70-144" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> data1;</span>
<span id="cb70-145"><a href="#cb70-145" aria-hidden="true" tabindex="-1"></a><span class="kw">%do</span> i=<span class="dv">1</span> <span class="kw">%to</span> <span class="kw">&amp;nStrata;</span></span>
<span id="cb70-146"><a href="#cb70-146" aria-hidden="true" tabindex="-1"></a><span class="kw">data data</span>;</span>
<span id="cb70-147"><a href="#cb70-147" aria-hidden="true" tabindex="-1"></a><span class="kw">merge data data&amp;i;</span></span>
<span id="cb70-148"><a href="#cb70-148" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> <span class="kw">&amp;Time;</span></span>
<span id="cb70-149"><a href="#cb70-149" aria-hidden="true" tabindex="-1"></a><span class="kw">%end</span>;</span>
<span id="cb70-150"><a href="#cb70-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-151"><a href="#cb70-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-152"><a href="#cb70-152" aria-hidden="true" tabindex="-1"></a><span class="co">* and complete the p-s;</span></span>
<span id="cb70-153"><a href="#cb70-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-154"><a href="#cb70-154" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sort<span class="kw"> data</span>=<span class="kw">data</span>;</span>
<span id="cb70-155"><a href="#cb70-155" aria-hidden="true" tabindex="-1"></a> <span class="kw">by</span> <span class="kw">&amp;Time;</span></span>
<span id="cb70-156"><a href="#cb70-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-157"><a href="#cb70-157" aria-hidden="true" tabindex="-1"></a><span class="kw">data data</span>; </span>
<span id="cb70-158"><a href="#cb70-158" aria-hidden="true" tabindex="-1"></a> <span class="kw">set data end</span>=last;</span>
<span id="cb70-159"><a href="#cb70-159" aria-hidden="true" tabindex="-1"></a>  <span class="kw">by</span> <span class="kw">&amp;Time;</span></span>
<span id="cb70-160"><a href="#cb70-160" aria-hidden="true" tabindex="-1"></a>   <span class="fu">n</span>=_N_;</span>
<span id="cb70-161"><a href="#cb70-161" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> last <span class="kw">then</span> <span class="kw">call</span> symput(<span class="st">'nobs'</span>,<span class="fu">n</span>);</span>
<span id="cb70-162"><a href="#cb70-162" aria-hidden="true" tabindex="-1"></a>  <span class="kw">drop</span> <span class="fu">n</span>;</span>
<span id="cb70-163"><a href="#cb70-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-164"><a href="#cb70-164" aria-hidden="true" tabindex="-1"></a><span class="kw">data data</span>;</span>
<span id="cb70-165"><a href="#cb70-165" aria-hidden="true" tabindex="-1"></a> <span class="kw">set data</span>;</span>
<span id="cb70-166"><a href="#cb70-166" aria-hidden="true" tabindex="-1"></a>  <span class="kw">%do</span> i=<span class="dv">1</span> <span class="kw">%to</span> <span class="kw">&amp;nStrata;</span></span>
<span id="cb70-167"><a href="#cb70-167" aria-hidden="true" tabindex="-1"></a>   <span class="kw">%do</span> j=<span class="dv">1</span> <span class="kw">%to</span> <span class="kw">&amp;nobs;</span></span>
<span id="cb70-168"><a href="#cb70-168" aria-hidden="true" tabindex="-1"></a>    dummy=<span class="fu">lag</span>(p0<span class="kw">&amp;i)</span>;</span>
<span id="cb70-169"><a href="#cb70-169" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> (p0<span class="kw">&amp;i </span>eq .) <span class="kw">then</span> p0<span class="kw">&amp;i=</span>dummy;</span>
<span id="cb70-170"><a href="#cb70-170" aria-hidden="true" tabindex="-1"></a>   <span class="kw">%end</span>;</span>
<span id="cb70-171"><a href="#cb70-171" aria-hidden="true" tabindex="-1"></a>  <span class="kw">%end</span>;</span>
<span id="cb70-172"><a href="#cb70-172" aria-hidden="true" tabindex="-1"></a>  <span class="kw">drop</span> dummy;</span>
<span id="cb70-173"><a href="#cb70-173" aria-hidden="true" tabindex="-1"></a>  p00=<span class="dv">1</span>;</span>
<span id="cb70-174"><a href="#cb70-174" aria-hidden="true" tabindex="-1"></a>  <span class="kw">%do</span> i=<span class="dv">1</span> <span class="kw">%to</span> <span class="kw">&amp;nStrata;</span></span>
<span id="cb70-175"><a href="#cb70-175" aria-hidden="true" tabindex="-1"></a>   p00=p00-p0<span class="kw">&amp;i;</span></span>
<span id="cb70-176"><a href="#cb70-176" aria-hidden="true" tabindex="-1"></a>  <span class="kw">%end</span>;</span>
<span id="cb70-177"><a href="#cb70-177" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb70-178"><a href="#cb70-178" aria-hidden="true" tabindex="-1"></a><span class="kw">%mend</span> CumInc;</span>
<span id="cb70-179"><a href="#cb70-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-180"><a href="#cb70-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-181"><a href="#cb70-181" aria-hidden="true" tabindex="-1"></a><span class="co">* Cuminc macro requires duplication;</span> </span>
<span id="cb70-182"><a href="#cb70-182" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> pbc32; </span>
<span id="cb70-183"><a href="#cb70-183" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> pbc3 pbc3;</span>
<span id="cb70-184"><a href="#cb70-184" aria-hidden="true" tabindex="-1"></a>    h=<span class="dv">1</span>+(_N_ gt <span class="dv">349</span>);</span>
<span id="cb70-185"><a href="#cb70-185" aria-hidden="true" tabindex="-1"></a>    <span class="fu">time</span>=days;</span>
<span id="cb70-186"><a href="#cb70-186" aria-hidden="true" tabindex="-1"></a>    d=(status=<span class="dv">1</span>)*(h=<span class="dv">1</span>)+(status=<span class="dv">2</span>)*(h=<span class="dv">2</span>);</span>
<span id="cb70-187"><a href="#cb70-187" aria-hidden="true" tabindex="-1"></a>    tment1=tment*(h=<span class="dv">1</span>); tment2=tment*(h=<span class="dv">2</span>);</span>
<span id="cb70-188"><a href="#cb70-188" aria-hidden="true" tabindex="-1"></a>    sex1=sex*(h=<span class="dv">1</span>); sex2=sex*(h=<span class="dv">2</span>);</span>
<span id="cb70-189"><a href="#cb70-189" aria-hidden="true" tabindex="-1"></a>    age1=age*(h=<span class="dv">1</span>); age2=age*(h=<span class="dv">2</span>);</span>
<span id="cb70-190"><a href="#cb70-190" aria-hidden="true" tabindex="-1"></a>    alb1=alb*(h=<span class="dv">1</span>); alb2=alb*(h=<span class="dv">2</span>);</span>
<span id="cb70-191"><a href="#cb70-191" aria-hidden="true" tabindex="-1"></a>    log2bili1=log2bili*(h=<span class="dv">1</span>); log2bili2=log2bili*(h=<span class="dv">2</span>);</span>
<span id="cb70-192"><a href="#cb70-192" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="figure-4.12-a-1" class="level4">
<h4 class="anchored" data-anchor-id="figure-4.12-a-1">Figure 4.12 (a)</h4>
<div class="cell" data-hash="Ch4_cache/html/figure-4.12a-sas_557c463a6bbd2e3a5c6076d8934b207b">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">input</span> tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  datalines; </span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  0 0 0 0 40 0 38 0 45 0</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="ot">  0 0 0 0 0 40 0 38 0 45</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="ot">  ;</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov; </span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> cov;</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili1&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili1=<span class="fu">log2</span>(log2bili1);</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili2&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili2=<span class="fu">log2</span>(log2bili2);</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc32 noprint;</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*d(<span class="dv">0</span>)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 </span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>                    log2bili1 log2bili2/rl;</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    strata h;</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    baseline out=cidata covariates=cov survival=surv/nomean method=ch;</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>%cuminc(cidata,h,time,surv);</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a><span class="kw">data data</span>; <span class="kw">set data</span>; tment=<span class="dv">0</span><span class="kw">; run</span>;</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot1; </span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set data</span>; </span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>    cum1=p01; cum2=p01+p02; cum3=<span class="dv">1</span>;</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>    p = p01+p02+p00;</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot1; </span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> plot1; </span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>    daysyears = <span class="fu">time</span>/<span class="dv">365.25</span>; </span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=plot1;</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>    plot cum1*daysyears cum2*daysyears cum3*daysyears/overlay haxis=axis1 vaxis=axis2;</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Stacked cumulative incidence and survival'</span>);</span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>    symbol3  v=none i=stepjl c=black;</span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="figure-4.12-b-1" class="level4">
<h4 class="anchored" data-anchor-id="figure-4.12-b-1">Figure 4.12 (b)</h4>
<div class="cell" data-hash="Ch4_cache/html/figure-4.12b-sas_1d84591478c027b01c184ed4bc2c5df7">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">input</span> tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    datalines; </span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 0 0 0 40 0 20 0 90 0</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 0 0 0 0 40 0 20 0 90</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="ot">    ;</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov; </span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> cov;</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili1&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili1=<span class="fu">log2</span>(log2bili1);</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili2&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili2=<span class="fu">log2</span>(log2bili2);</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc32 noprint;</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*d(<span class="dv">0</span>)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 </span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>                    log2bili1 log2bili2/rl;</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>    strata h;</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    baseline out=cidata covariates=cov survival=surv/nomean method=ch;</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>%cuminc(cidata,h,time,surv);</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a><span class="kw">data data</span>; <span class="kw">set data</span>; tment=<span class="dv">0</span><span class="kw">; run</span>;</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot2plac; <span class="kw">set data</span>; </span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>    cum1=p01; cum2=p01+p02; cum3=<span class="dv">1</span>;</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot2plac; </span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> plot2plac; </span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>    daysyears = <span class="fu">time</span>/<span class="dv">365.25</span>; </span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=plot2plac;</span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>    plot cum1*daysyears cum2*daysyears cum3*daysyears/overlay haxis=axis1 vaxis=axis2;</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Stacked cumulative incidence and survival'</span>);</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>    symbol3  v=none i=stepjl c=black;</span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="figure-4.12-c-1" class="level4">
<h4 class="anchored" data-anchor-id="figure-4.12-c-1">Figure 4.12 (c)</h4>
<div class="cell" data-hash="Ch4_cache/html/figure-4.12c-sas_61a9cb7f4dfcf7939b45f6a325823a41">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">input</span> tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    datalines; </span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 0 0 0 60 0 38 0 45 0</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 0 0 0 0 60 0 38 0 45</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="ot">    ;</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> cov;</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili1&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili1=<span class="fu">log2</span>(log2bili1);</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili2&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili2=<span class="fu">log2</span>(log2bili2);</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc32 noprint;</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*d(<span class="dv">0</span>)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 </span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>                    log2bili1 log2bili2/rl;</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    strata h;</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    baseline out=cidata covariates=cov survival=surv/nomean method=ch;</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>%cuminc(cidata,h,time,surv);</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a><span class="kw">data data</span>; <span class="kw">set data</span>; tment=<span class="dv">0</span><span class="kw">; run</span>;</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot3plac; <span class="kw">set data</span>; </span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    cum1=p01; cum2=p01+p02; cum3=<span class="dv">1</span>;</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plot3plac; </span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> plot3plac; </span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>    daysyears = <span class="fu">time</span>/<span class="dv">365.25</span>; </span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=plot3plac;</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>    plot cum1*daysyears cum2*daysyears cum3*daysyears/overlay haxis=axis1 vaxis=axis2;</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Stacked cumulative incidence and survival'</span>);</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>    symbol3  v=none i=stepjl c=black;</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</div>
</div>
</div>
</section>
<section id="table-4.2" class="level3">
<h3 class="anchored" data-anchor-id="table-4.2">Table 4.2</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-14-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-1" role="tab" aria-controls="tabset-14-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-14-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-2" role="tab" aria-controls="tabset-14-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-14-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-14-1-tab">
<section id="scenario-1-no-adjustment" class="level4">
<h4 class="anchored" data-anchor-id="scenario-1-no-adjustment">Scenario 1 (no adjustment)</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.2-r-1_79d7e577ad0eeb1d60141a0c62fc89ac">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"survRM2"</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="co"># No adjustment </span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>coxsurv <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="fu">strata</span>(tment), <span class="at">data =</span> pbc3, </span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="co"># death w/o transplant</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>cox1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">~</span> <span class="fu">strata</span>(tment), <span class="at">data =</span> pbc3, </span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="co"># transplant</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>cox2 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="fu">strata</span>(tment), <span class="at">data =</span> pbc3, </span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox1, <span class="at">center =</span> F)<span class="sc">$</span>time</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>surv <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">basehaz</span>(coxsurv, <span class="at">center =</span> F)<span class="sc">$</span>hazard)</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>lamd1 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox1, <span class="at">center =</span> F)<span class="sc">$</span>hazard</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>lamd2 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox2, <span class="at">center =</span> F)<span class="sc">$</span>hazard</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>strat <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox1, <span class="at">center =</span> F)<span class="sc">$</span>strata</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative incidence</span></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>F01_plac <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv[strat <span class="sc">==</span> <span class="st">"tment=0"</span>] <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd1[strat <span class="sc">==</span> <span class="st">"tment=0"</span>])))</span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>F01_cya <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv[strat <span class="sc">==</span> <span class="st">"tment=1"</span>] <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd1[strat <span class="sc">==</span> <span class="st">"tment=1"</span>])))</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>F02_plac <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv[strat <span class="sc">==</span> <span class="st">"tment=0"</span>] <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd2[strat <span class="sc">==</span> <span class="st">"tment=0"</span>])))</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>F02_cya <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv[strat <span class="sc">==</span> <span class="st">"tment=1"</span>] <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd2[strat <span class="sc">==</span> <span class="st">"tment=1"</span>])))</span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>timep <span class="ot">&lt;-</span> time[strat <span class="sc">==</span> <span class="st">"tment=0"</span>]</span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>timec <span class="ot">&lt;-</span> time[strat <span class="sc">==</span> <span class="st">"tment=1"</span>]</span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Transplantation</span></span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>scenario1.T <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Placebo=</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timep[timep <span class="sc">&lt;=</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>])) <span class="sc">*</span> F02_plac[timep <span class="sc">&lt;=</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>])<span class="sc">/</span><span class="fl">365.25</span>,</span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a><span class="at">CyA=</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timec[timec <span class="sc">&lt;=</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>])) <span class="sc">*</span> F02_cya[timec <span class="sc">&lt;=</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>])<span class="sc">/</span><span class="fl">365.25</span>)</span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Death without transplantation</span></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>scenario1.D <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Placebo=</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timep[timep <span class="sc">&lt;=</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>])) <span class="sc">*</span> F01_plac[timep <span class="sc">&lt;=</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>])<span class="sc">/</span><span class="fl">365.25</span>,</span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a><span class="at">CyA=</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timec[timec <span class="sc">&lt;=</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>])) <span class="sc">*</span> F01_cya[timec <span class="sc">&lt;=</span> <span class="dv">3</span> <span class="sc">*</span> <span class="fl">365.25</span>])<span class="sc">/</span><span class="fl">365.25</span>)</span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>scenario1.T;scenario1.D </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Placebo        CyA 
0.14268790 0.08567096 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Placebo       CyA 
0.2499754 0.2365865 </code></pre>
</div>
</div>
</section>
<section id="scenario-1-no-adjustment-using-mets-package" class="level4">
<h4 class="anchored" data-anchor-id="scenario-1-no-adjustment-using-mets-package">Scenario 1 (no adjustment) using mets package</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.2-r-mets_d89d088c1e8a16a8dc3341807407a34f">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>rmc1 <span class="ot">&lt;-</span> <span class="fu">cif.yearslost</span>(<span class="fu">Event</span>(days<span class="sc">/</span><span class="fl">365.25</span>,status)<span class="sc">~</span><span class="fu">strata</span>(tment), </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data=</span>pbc3, <span class="at">time=</span><span class="dv">3</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rmc1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  strata times     intF11    intF12  se.intF11  se.intF12 total.years.lost
1      0     3 0.14274534 0.2511599 0.04083718 0.05260692        0.3939052
2      1     3 0.08637516 0.2359673 0.03029502 0.05031025        0.3223425</code></pre>
</div>
</div>
</section>
<section id="scenario-2" class="level4">
<h4 class="anchored" data-anchor-id="scenario-2">Scenario 2</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.2-r-2_1dfecabf415ed72291f4676db03bb917">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>coxsurv <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days<span class="sc">/</span><span class="fl">365.25</span>, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> tment <span class="sc">+</span> sex <span class="sc">+</span> age <span class="sc">+</span> alb <span class="sc">+</span> log2bili,</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> pbc3, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># death w/o transplant</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>cox1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days<span class="sc">/</span><span class="fl">365.25</span>, status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">~</span> tment <span class="sc">+</span> sex <span class="sc">+</span> age <span class="sc">+</span> alb <span class="sc">+</span> log2bili,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> pbc3, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="co"># transplant</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>cox2 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days<span class="sc">/</span><span class="fl">365.25</span>, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> tment <span class="sc">+</span> sex <span class="sc">+</span> age <span class="sc">+</span> alb <span class="sc">+</span> log2bili,</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> pbc3, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Sex = F, age = 40, alb = 38, bili = 45</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions </span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>newd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sex =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">age =</span> <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">40</span>),</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">alb =</span> <span class="fu">c</span>(<span class="dv">38</span>, <span class="dv">38</span>), </span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>                   <span class="at">log2bili =</span> <span class="fu">log2</span>(<span class="fu">c</span>(<span class="dv">45</span>, <span class="dv">45</span>)))</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a><span class="co"># predictions</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox1, <span class="at">center =</span> F)<span class="sc">$</span>time</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>surv <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">basehaz</span>(coxsurv, <span class="at">center =</span> F)<span class="sc">$</span>hazard)</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>lamd1 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox1, <span class="at">center =</span> F)<span class="sc">$</span>hazard</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>lamd2 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox2, <span class="at">center =</span> F)<span class="sc">$</span>hazard</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>lpsurv <span class="ot">&lt;-</span> <span class="fu">predict</span>(coxsurv, newd, <span class="at">type =</span> <span class="st">"lp"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>lpcox1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cox1, newd, <span class="at">type =</span> <span class="st">"lp"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>lpcox2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cox2, newd, <span class="at">type =</span> <span class="st">"lp"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear predictors</span></span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>surv_plac <span class="ot">&lt;-</span> surv<span class="sc">^</span><span class="fu">exp</span>(lpsurv[<span class="dv">1</span>])</span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a>surv_cya <span class="ot">&lt;-</span> surv<span class="sc">^</span><span class="fu">exp</span>(lpsurv[<span class="dv">2</span>])</span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>lamd1_plac <span class="ot">&lt;-</span> lamd1 <span class="sc">*</span> <span class="fu">exp</span>(lpcox1[<span class="dv">1</span>])</span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a>lamd1_cya <span class="ot">&lt;-</span> lamd1 <span class="sc">*</span> <span class="fu">exp</span>(lpcox1[<span class="dv">2</span>])</span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a>lamd2_plac <span class="ot">&lt;-</span> lamd2 <span class="sc">*</span> <span class="fu">exp</span>(lpcox2[<span class="dv">1</span>])</span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a>lamd2_cya <span class="ot">&lt;-</span> lamd2 <span class="sc">*</span> <span class="fu">exp</span>(lpcox2[<span class="dv">2</span>])</span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative incidence</span></span>
<span id="cb79-39"><a href="#cb79-39" aria-hidden="true" tabindex="-1"></a>F01_plac <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_plac <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd1_plac)))</span>
<span id="cb79-40"><a href="#cb79-40" aria-hidden="true" tabindex="-1"></a>F01_cya  <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_cya <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd1_cya)))</span>
<span id="cb79-41"><a href="#cb79-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-42"><a href="#cb79-42" aria-hidden="true" tabindex="-1"></a>F02_plac <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_plac <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd2_plac)))</span>
<span id="cb79-43"><a href="#cb79-43" aria-hidden="true" tabindex="-1"></a>F02_cya  <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_cya <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd2_cya)))</span>
<span id="cb79-44"><a href="#cb79-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-45"><a href="#cb79-45" aria-hidden="true" tabindex="-1"></a>timep <span class="ot">&lt;-</span> timec <span class="ot">&lt;-</span> time</span>
<span id="cb79-46"><a href="#cb79-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-47"><a href="#cb79-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Transplantation</span></span>
<span id="cb79-48"><a href="#cb79-48" aria-hidden="true" tabindex="-1"></a>scenario2.T <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Placebo=</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timep[timep <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F02_plac[timep <span class="sc">&lt;=</span> <span class="dv">3</span>]),</span>
<span id="cb79-49"><a href="#cb79-49" aria-hidden="true" tabindex="-1"></a><span class="at">CyA=</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timec[timec <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F02_cya[timec <span class="sc">&lt;=</span> <span class="dv">3</span>]))</span>
<span id="cb79-50"><a href="#cb79-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-51"><a href="#cb79-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Death without transplantation</span></span>
<span id="cb79-52"><a href="#cb79-52" aria-hidden="true" tabindex="-1"></a>scenario2.D <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Placebo=</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timep[timep <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F01_plac[timep <span class="sc">&lt;=</span> <span class="dv">3</span>]),</span>
<span id="cb79-53"><a href="#cb79-53" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CyA    =</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timec[timec <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F01_cya[timec  <span class="sc">&lt;=</span> <span class="dv">3</span>])</span>
<span id="cb79-54"><a href="#cb79-54" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb79-55"><a href="#cb79-55" aria-hidden="true" tabindex="-1"></a>scenario2.T;scenario2.D </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Placebo       CyA 
0.2204065 0.1161289 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   Placebo        CyA 
0.09008897 0.06091087 </code></pre>
</div>
</div>
</section>
<section id="scenario-3" class="level4">
<h4 class="anchored" data-anchor-id="scenario-3">Scenario 3</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.2-r-3_9aa9ce742af9cc2fb78dafbdd1bc9d09">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sex = F, age = 40, alb = 20, bili = 90 #</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions </span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>newd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sex =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">age =</span> <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">40</span>),</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">alb =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">20</span>), </span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">log2bili =</span> <span class="fu">log2</span>(<span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">90</span>)))</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="co"># predictions</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox1, <span class="at">center =</span> F)<span class="sc">$</span>time</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>surv <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">basehaz</span>(coxsurv, <span class="at">center =</span> F)<span class="sc">$</span>hazard)</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>lamd1 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox1, <span class="at">center =</span> F)<span class="sc">$</span>hazard</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>lamd2 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox2, <span class="at">center =</span> F)<span class="sc">$</span>hazard</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>lpsurv <span class="ot">&lt;-</span> <span class="fu">predict</span>(coxsurv, newd, <span class="at">type =</span> <span class="st">"lp"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>lpcox1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cox1, newd, <span class="at">type =</span> <span class="st">"lp"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>lpcox2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cox2, newd, <span class="at">type =</span> <span class="st">"lp"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear predictors</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>surv_plac <span class="ot">&lt;-</span> surv<span class="sc">^</span><span class="fu">exp</span>(lpsurv[<span class="dv">1</span>])</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>surv_cya <span class="ot">&lt;-</span> surv<span class="sc">^</span><span class="fu">exp</span>(lpsurv[<span class="dv">2</span>])</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>lamd1_plac <span class="ot">&lt;-</span> lamd1 <span class="sc">*</span> <span class="fu">exp</span>(lpcox1[<span class="dv">1</span>])</span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>lamd1_cya <span class="ot">&lt;-</span> lamd1 <span class="sc">*</span> <span class="fu">exp</span>(lpcox1[<span class="dv">2</span>])</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>lamd2_plac <span class="ot">&lt;-</span> lamd2 <span class="sc">*</span> <span class="fu">exp</span>(lpcox2[<span class="dv">1</span>])</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>lamd2_cya <span class="ot">&lt;-</span> lamd2 <span class="sc">*</span> <span class="fu">exp</span>(lpcox2[<span class="dv">2</span>])</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative incidence</span></span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>F01_plac <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_plac <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd1_plac)))</span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>F01_cya <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_cya <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd1_cya)))</span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>F02_plac <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_plac <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd2_plac)))</span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>F02_cya <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_cya <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd2_cya)))</span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>timep <span class="ot">&lt;-</span> timec <span class="ot">&lt;-</span> time</span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Transplantation</span></span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>scenario3.T <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Placebo=</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timep[timep <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F02_plac[timep <span class="sc">&lt;=</span> <span class="dv">3</span>]),</span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CyA    =</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timec[timec <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F02_cya[timec  <span class="sc">&lt;=</span> <span class="dv">3</span>])</span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Death without transplantation</span></span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a>scenario3.D <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Placebo=</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timep[timep <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F01_plac[timep <span class="sc">&lt;=</span> <span class="dv">3</span>]),</span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CyA    =</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timec[timec <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F01_cya[timec  <span class="sc">&lt;=</span> <span class="dv">3</span>]))</span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a>scenario3.T;scenario3.D</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Placebo     CyA 
1.69057 1.06836 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Placebo       CyA 
0.4232820 0.3293008 </code></pre>
</div>
</div>
</section>
<section id="scenario-4" class="level4">
<h4 class="anchored" data-anchor-id="scenario-4">Scenario 4</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.2-r-4_407293ad035b85c2c557c3bf6e60c5bc">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="do">##### Sex = F, age = 60, alb = 38, bili = 45 #####</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions </span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>newd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">sex =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">age =</span> <span class="fu">c</span>(<span class="dv">60</span>, <span class="dv">60</span>),</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">alb =</span> <span class="fu">c</span>(<span class="dv">38</span>, <span class="dv">38</span>), </span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">log2bili =</span> <span class="fu">log2</span>(<span class="fu">c</span>(<span class="dv">45</span>, <span class="dv">45</span>)))</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="co"># predictions</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>lpsurv <span class="ot">&lt;-</span> <span class="fu">predict</span>(coxsurv, newd, <span class="at">type =</span> <span class="st">"lp"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>lpcox1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cox1, newd, <span class="at">type =</span> <span class="st">"lp"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>lpcox2 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cox2, newd, <span class="at">type =</span> <span class="st">"lp"</span>, <span class="at">reference =</span> <span class="st">"zero"</span>)</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox1, <span class="at">center =</span> F)<span class="sc">$</span>time</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>surv <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">basehaz</span>(coxsurv, <span class="at">center =</span> F)<span class="sc">$</span>hazard)</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>lamd1 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox1, <span class="at">center =</span> F)<span class="sc">$</span>hazard</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>lamd2 <span class="ot">&lt;-</span> <span class="fu">basehaz</span>(cox2, <span class="at">center =</span> F)<span class="sc">$</span>hazard</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear predictors</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>surv_plac <span class="ot">&lt;-</span> surv<span class="sc">^</span><span class="fu">exp</span>(lpsurv[<span class="dv">1</span>])</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>surv_cya <span class="ot">&lt;-</span> surv<span class="sc">^</span><span class="fu">exp</span>(lpsurv[<span class="dv">2</span>])</span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>lamd1_plac <span class="ot">&lt;-</span> lamd1 <span class="sc">*</span> <span class="fu">exp</span>(lpcox1[<span class="dv">1</span>])</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>lamd1_cya <span class="ot">&lt;-</span> lamd1 <span class="sc">*</span> <span class="fu">exp</span>(lpcox1[<span class="dv">2</span>])</span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>lamd2_plac <span class="ot">&lt;-</span> lamd2 <span class="sc">*</span> <span class="fu">exp</span>(lpcox2[<span class="dv">1</span>])</span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>lamd2_cya <span class="ot">&lt;-</span> lamd2 <span class="sc">*</span> <span class="fu">exp</span>(lpcox2[<span class="dv">2</span>])</span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative incidence</span></span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>F01_plac <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_plac <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd1_plac)))</span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a>F01_cya <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_cya <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd1_cya)))</span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a>F02_plac <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_plac <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd2_plac)))</span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a>F02_cya <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(surv_cya <span class="sc">*</span> <span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>,lamd2_cya)))</span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a>timep <span class="ot">&lt;-</span> timec <span class="ot">&lt;-</span> time</span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Transplantation</span></span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a>scenario4.T <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Placebo=</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timep[timep <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F02_plac[timep <span class="sc">&lt;=</span> <span class="dv">3</span>]), </span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CyA    =</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timec[timec <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F02_cya[timec  <span class="sc">&lt;=</span> <span class="dv">3</span>])</span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Death without transplantation</span></span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a>scenario4.D <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Placebo=</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timep[timep <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F01_plac[timep <span class="sc">&lt;=</span> <span class="dv">3</span>]),</span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CyA    =</span><span class="fu">sum</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">0</span>, timec[timec <span class="sc">&lt;=</span> <span class="dv">3</span>])) <span class="sc">*</span> F01_cya[timec  <span class="sc">&lt;=</span> <span class="dv">3</span>])</span>
<span id="cb85-47"><a href="#cb85-47" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb85-48"><a href="#cb85-48" aria-hidden="true" tabindex="-1"></a>scenario4.T;scenario4.D</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Placebo        CyA 
0.07879677 0.04263005 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Placebo       CyA 
0.3678765 0.2544924 </code></pre>
</div>
</div>
</section>
</div>
<div id="tabset-14-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-14-2-tab">
<section id="macro-for-area-under-cif" class="level4">
<h4 class="anchored" data-anchor-id="macro-for-area-under-cif">Macro for area under CIF</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.2-macro_3919114a9f9dc934f1730acc12b5c4a2">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">%macro</span> areastep(data,trt,grp,time,y,tau);</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> <span class="kw">select</span>; <span class="kw">set</span> <span class="kw">&amp;data;</span> <span class="kw">where</span> <span class="kw">&amp;trt=&amp;grp;</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> <span class="kw">select</span>; <span class="kw">set</span> <span class="kw">select</span>;<span class="kw">by</span> <span class="kw">&amp;trt;</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">retain</span> mu;</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> first.<span class="kw">&amp;trt then</span> mu=<span class="dv">0</span>;</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="kw">&amp;time&gt;&amp;tau then do</span>;</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&amp;time=&amp;tau;</span> <span class="kw">&amp;y=</span><span class="fu">lag</span>(<span class="kw">&amp;y); end</span>;</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>        mu+<span class="fu">lag</span>(<span class="kw">&amp;y)</span>*(<span class="kw">&amp;time-</span><span class="fu">lag</span>(<span class="kw">&amp;time)</span>);</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> last.<span class="kw">&amp;trt then do</span>;</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="kw">&amp;time&lt;&amp;tau then</span> mu+(<span class="kw">&amp;tau-&amp;time)</span>*<span class="kw">&amp;y; end</span>;</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> last;</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">set</span> <span class="kw">select</span>;</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">by</span> <span class="kw">&amp;trt;</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> last.<span class="kw">&amp;trt;</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a><span class="kw">    proc</span> print<span class="kw">; run</span>;</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="kw">%mend</span> areastep;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="scenario-1-no-adjustment-1" class="level4">
<h4 class="anchored" data-anchor-id="scenario-1-no-adjustment-1">Scenario 1 (no adjustment)</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.2-sas-1_4fb622804933eb281e81e5a6f307d8fa">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">* No adjustment: Transplantation;</span> </span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3 noprint;</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> followup*status(<span class="dv">0</span>)=/eventcode=<span class="dv">1</span>;</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    strata tment;</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    baseline out=cuminc1 cif=cif1 stdcif=std1;</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"Placebo"</span>;</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>%areastep(cuminc1,tment,0,followup,cif1,3);</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"CyA"</span>;</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>%areastep(cuminc1,tment,1,followup,cif1,3);</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a><span class="co">* No adjustment: Death wo transplant;</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3 noprint;</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> followup*status(<span class="dv">0</span>)=/eventcode=<span class="dv">2</span>;</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>    strata tment;</span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    baseline out=cuminc2 cif=cif2 stdcif=std2;</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"Placebo"</span>;</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>%areastep(cuminc2,tment,0,followup,cif2,3);</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"CyA"</span>;</span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>%areastep(cuminc2,tment,1,followup,cif2,3);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="scenario-2-1" class="level4">
<h4 class="anchored" data-anchor-id="scenario-2-1">Scenario 2</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.2-sas-2_996e6b45e231e61adf8499c1e568ad38">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co">*** age=40 alb=38 bili=45 ***;</span> </span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="co">* CyA;</span> </span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">input</span> tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="ot">    datalines; </span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="ot">    1 0 0 0 40 0 38 0 45 0</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 1 0 0 0 40 0 38 0 45</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="ot">    ;</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov; <span class="kw">set</span> cov;</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili1&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili1=<span class="fu">log2</span>(log2bili1);</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili2&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili2=<span class="fu">log2</span>(log2bili2);</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc32 noprint;</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*d(<span class="dv">0</span>)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 </span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>    log2bili1 log2bili2/rl;</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>    strata h;</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>    baseline out=cidata covariates=cov survival=surv/nomean method=ch;</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>%cuminc(cidata,h,time,surv);</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> dataC; </span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set data</span>; </span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>    tment=<span class="dv">1</span>; </span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>%areastep(dataC,tment,1,time,p01,3);</span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>%areastep(dataC,tment,1,time,p02,3);</span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a><span class="co">* Placebo;</span> </span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">input</span> tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;</span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a><span class="ot">    datalines; </span></span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 0 0 0 40 0 38 0 45 0</span></span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 0 0 0 0 40 0 38 0 45</span></span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a><span class="ot">    ;</span></span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov; <span class="kw">set</span> cov;</span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili1&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili1=<span class="fu">log2</span>(log2bili1);</span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili2&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili2=<span class="fu">log2</span>(log2bili2);</span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc32 noprint;</span>
<span id="cb90-43"><a href="#cb90-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*d(<span class="dv">0</span>)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 </span>
<span id="cb90-44"><a href="#cb90-44" aria-hidden="true" tabindex="-1"></a>                                    log2bili1 log2bili2;</span>
<span id="cb90-45"><a href="#cb90-45" aria-hidden="true" tabindex="-1"></a>    strata h;</span>
<span id="cb90-46"><a href="#cb90-46" aria-hidden="true" tabindex="-1"></a>    baseline out=cidata covariates=cov survival=surv/nomean method=ch;</span>
<span id="cb90-47"><a href="#cb90-47" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb90-48"><a href="#cb90-48" aria-hidden="true" tabindex="-1"></a>%cuminc(cidata,h,time,surv);</span>
<span id="cb90-49"><a href="#cb90-49" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> dataP; </span>
<span id="cb90-50"><a href="#cb90-50" aria-hidden="true" tabindex="-1"></a><span class="kw">set data</span>; </span>
<span id="cb90-51"><a href="#cb90-51" aria-hidden="true" tabindex="-1"></a>tment=<span class="dv">0</span>; </span>
<span id="cb90-52"><a href="#cb90-52" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb90-53"><a href="#cb90-53" aria-hidden="true" tabindex="-1"></a>%areastep(dataP,tment,0,time,p01,3);</span>
<span id="cb90-54"><a href="#cb90-54" aria-hidden="true" tabindex="-1"></a>%areastep(dataP,tment,0,time,p02,3);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="scenario-3-1" class="level4">
<h4 class="anchored" data-anchor-id="scenario-3-1">Scenario 3</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.2-sas-3_1f427dbe886b94f988b78fdec5376f81">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">*** age=40 alb=20 bili=90 ***;</span> </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="co">* CyA;</span> </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">input</span> tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="ot">    datalines; </span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="ot">    1 0 0 0 40 0 20 0 90 0</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 1 0 0 0 40 0 20 0 90</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="ot">    ;</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov; <span class="kw">set</span> cov;</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili1&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili1=<span class="fu">log2</span>(log2bili1);</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili2&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili2=<span class="fu">log2</span>(log2bili2);</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc32 noprint;</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*d(<span class="dv">0</span>)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 </span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>    log2bili1 log2bili2/rl;</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>    strata h;</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>    baseline out=cidata covariates=cov survival=surv/nomean method=ch;</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>%cuminc(cidata,h,time,surv);</span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> dataC; </span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set data</span>; </span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a>    tment=<span class="dv">1</span>; </span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>%areastep(dataC,tment,1,time,p01,3);</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a>%areastep(dataC,tment,1,time,p02,3);</span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a><span class="co">* Placebo;</span> </span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">input</span> tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;</span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a><span class="ot">    datalines; </span></span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 0 0 0 40 0 20 0 90 0</span></span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 0 0 0 0 40 0 20 0 90</span></span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a><span class="ot">    ;</span></span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov; <span class="kw">set</span> cov;</span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili1&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili1=<span class="fu">log2</span>(log2bili1);</span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili2&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili2=<span class="fu">log2</span>(log2bili2);</span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc32 noprint;</span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*d(<span class="dv">0</span>)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 </span>
<span id="cb91-48"><a href="#cb91-48" aria-hidden="true" tabindex="-1"></a>    log2bili1 log2bili2/rl;</span>
<span id="cb91-49"><a href="#cb91-49" aria-hidden="true" tabindex="-1"></a>    strata h;</span>
<span id="cb91-50"><a href="#cb91-50" aria-hidden="true" tabindex="-1"></a>    baseline out=cidata covariates=cov survival=surv/nomean method=ch;</span>
<span id="cb91-51"><a href="#cb91-51" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb91-52"><a href="#cb91-52" aria-hidden="true" tabindex="-1"></a>%cuminc(cidata,h,time,surv);</span>
<span id="cb91-53"><a href="#cb91-53" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> dataP; </span>
<span id="cb91-54"><a href="#cb91-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set data</span>; </span>
<span id="cb91-55"><a href="#cb91-55" aria-hidden="true" tabindex="-1"></a>    tment=<span class="dv">0</span>; </span>
<span id="cb91-56"><a href="#cb91-56" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb91-57"><a href="#cb91-57" aria-hidden="true" tabindex="-1"></a>%areastep(dataP,tment,0,time,p01,3);</span>
<span id="cb91-58"><a href="#cb91-58" aria-hidden="true" tabindex="-1"></a>%areastep(dataP,tment,0,time,p02,3);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="scenario-4-1" class="level4">
<h4 class="anchored" data-anchor-id="scenario-4-1">Scenario 4</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.2-sas-4_bdbee5608225896fdb8fe01f821445c6">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co">*** age=60 alb=38 bili=45 ***;</span> </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="co">* CyA;</span> </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">input</span> tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="ot">    datalines; </span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="ot">    1 0 0 0 60 0 38 0 45 0</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 1 0 0 0 60 0 38 0 45</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="ot">    ;</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov; <span class="kw">set</span> cov;</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili1&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili1=<span class="fu">log2</span>(log2bili1);</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili2&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili2=<span class="fu">log2</span>(log2bili2);</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc32 noprint;</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*d(<span class="dv">0</span>)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 </span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    log2bili1 log2bili2/rl;</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>    strata h;</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>    baseline out=cidata covariates=cov survival=surv/nomean method=ch;</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>%cuminc(cidata,h,time,surv);</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> dataC; </span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set data</span>; </span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>    tment=<span class="dv">1</span>; </span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>%areastep(dataC,tment,1,time,p01,3);</span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>%areastep(dataC,tment,1,time,p02,3);</span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a><span class="co">* Placebo;</span> </span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">input</span> tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 log2bili1 log2bili2;</span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a><span class="ot">    datalines; </span></span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 0 0 0 60 0 38 0 45 0</span></span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 0 0 0 0 60 0 38 0 45</span></span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a><span class="ot">    ;</span></span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov; <span class="kw">set</span> cov;</span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili1&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili1=<span class="fu">log2</span>(log2bili1);</span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> log2bili2&gt;<span class="dv">0</span> <span class="kw">then</span> log2bili2=<span class="fu">log2</span>(log2bili2);</span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc32 noprint;</span>
<span id="cb92-41"><a href="#cb92-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*d(<span class="dv">0</span>)=tment1 tment2 sex1 sex2 age1 age2 alb1 alb2 </span>
<span id="cb92-42"><a href="#cb92-42" aria-hidden="true" tabindex="-1"></a>    log2bili1 log2bili2/rl;</span>
<span id="cb92-43"><a href="#cb92-43" aria-hidden="true" tabindex="-1"></a>    strata h;</span>
<span id="cb92-44"><a href="#cb92-44" aria-hidden="true" tabindex="-1"></a>    baseline out=cidata covariates=cov survival=surv/nomean method=ch;</span>
<span id="cb92-45"><a href="#cb92-45" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb92-46"><a href="#cb92-46" aria-hidden="true" tabindex="-1"></a>%cuminc(cidata,h,time,surv);</span>
<span id="cb92-47"><a href="#cb92-47" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> dataP; </span>
<span id="cb92-48"><a href="#cb92-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set data</span>; </span>
<span id="cb92-49"><a href="#cb92-49" aria-hidden="true" tabindex="-1"></a>    tment=<span class="dv">0</span>; </span>
<span id="cb92-50"><a href="#cb92-50" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb92-51"><a href="#cb92-51" aria-hidden="true" tabindex="-1"></a>%areastep(dataP,tment,0,time,p01,3);</span>
<span id="cb92-52"><a href="#cb92-52" aria-hidden="true" tabindex="-1"></a>%areastep(dataP,tment,0,time,p02,3);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</div>
</div>
</div>
</section>
<section id="table-4.4" class="level3">
<h3 class="anchored" data-anchor-id="table-4.4">Table 4.4</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-15-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-1" role="tab" aria-controls="tabset-15-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-15-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-2" role="tab" aria-controls="tabset-15-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-15-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-15-1-tab">
<section id="using-survrm2-package" class="level4">
<h4 class="anchored" data-anchor-id="using-survrm2-package">Using survRM2 package</h4>
<p>Here we get the same as in SAS PROC RMSTREG</p>
<div class="cell" data-hash="Ch4_cache/html/table-4.4-r_2745a49d5afdd537c016197e93dd5660">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"survRM2"</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>pbcsub <span class="ot">&lt;-</span> <span class="fu">subset</span>(pbc3,<span class="sc">!</span><span class="fu">is.na</span>(alb))</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>time   <span class="ot">&lt;-</span> pbcsub<span class="sc">$</span>days<span class="sc">/</span><span class="fl">365.25</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>status <span class="ot">&lt;-</span> pbcsub<span class="sc">$</span>status<span class="sc">!=</span><span class="dv">0</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>arm    <span class="ot">&lt;-</span> pbcsub<span class="sc">$</span>tment<span class="sc">==</span><span class="st">"1"</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>alb    <span class="ot">&lt;-</span> pbcsub<span class="sc">$</span>alb</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>logbili<span class="ot">&lt;-</span> <span class="fu">log2</span>(pbcsub<span class="sc">$</span>bili)</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">cbind</span>(alb, logbili)</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rmst2</span>(time, status, arm, <span class="at">tau=</span><span class="dv">3</span>, <span class="at">covariates=</span>xx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
The truncation time: tau = 3  was specified. 

Summary of between-group contrast (adjusted for the covariates) 
                      Est. lower .95 upper .95     p
RMST (arm=1)-(arm=0) 0.168     0.016     0.320 0.031
RMST (arm=1)/(arm=0) 1.065     1.004     1.130 0.037
RMTL (arm=1)/(arm=0) 0.548     0.364     0.823 0.004


Model summary (difference of RMST) 
            coef se(coef)      z     p lower .95 upper .95
intercept  2.376    0.381  6.241 0.000     1.630     3.122
arm        0.168    0.078  2.160 0.031     0.016     0.320
alb        0.031    0.008  4.058 0.000     0.016     0.045
logbili   -0.214    0.034 -6.207 0.000    -0.281    -0.146


Model summary (ratio of RMST) 
            coef se(coef)      z     p exp(coef) lower .95 upper .95
intercept  0.882    0.151  5.827 0.000     2.415     1.795     3.249
arm        0.063    0.030  2.089 0.037     1.065     1.004     1.130
alb        0.011    0.003  3.859 0.000     1.012     1.006     1.017
logbili   -0.085    0.016 -5.499 0.000     0.918     0.891     0.947


Model summary (ratio of time-lost) 
            coef se(coef)      z     p exp(coef) lower .95 upper .95
intercept -0.142    0.802 -0.177 0.860     0.868     0.180     4.183
arm       -0.602    0.208 -2.895 0.004     0.548     0.364     0.823
alb       -0.095    0.017 -5.469 0.000     0.909     0.878     0.941
logbili    0.524    0.061  8.540 0.000     1.689     1.498     1.906</code></pre>
</div>
</div>
</section>
<section id="using-mets-package-1" class="level4">
<h4 class="anchored" data-anchor-id="using-mets-package-1">Using mets package</h4>
<p>However, this does not align exactly with survRM2 package?</p>
<div class="cell" data-hash="Ch4_cache/html/table-4.4-r-mets_7c7d87ccb33577a735369752570a68a4">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">contrasts=</span><span class="fu">c</span>(<span class="st">"contr.treatment"</span>, <span class="st">"contr.poly"</span>))</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="fu">resmeanIPCW</span>(<span class="fu">Event</span>(followup,fail)<span class="sc">~</span><span class="fu">factor</span>(tment)<span class="sc">+</span>alb<span class="sc">+</span>log2bili,</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span>pbcsub, <span class="at">time=</span><span class="dv">3</span>, <span class="at">model=</span><span class="st">"lin"</span>,</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">cens.model=</span><span class="sc">~</span><span class="fu">strata</span>(tment))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 343     67

 343 clusters
coeffients:
                Estimate   Std.Err      2.5%     97.5% P-value
(Intercept)     2.722803  1.326849  0.122227  5.323380  0.0402
factor(tment)1  0.144855  0.085063 -0.021866  0.311576  0.0886
alb             0.022829  0.027178 -0.030438  0.076096  0.4009
log2bili       -0.223035  0.093775 -0.406830 -0.039240  0.0174

exp(coeffients):
               Estimate     2.5%    97.5%
(Intercept)    15.22293  1.13001 205.0758
factor(tment)1  1.15587  0.97837   1.3656
alb             1.02309  0.97002   1.0791
log2bili        0.80009  0.66576   0.9615</code></pre>
</div>
</div>
</section>
</div>
<div id="tabset-15-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-15-2-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.4-sas_803a95f44d2cfa8af628b7cb7cdec0fa">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> rmstreg<span class="kw"> data</span>=pbc3 tau=<span class="dv">3</span>;</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> followup*status(<span class="dv">0</span>)=tment alb log2bili / </span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">link</span>=linear method=ipcw(strata=tment);</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="in-text-rmst-g-formula-and-bootstrap" class="level3">
<h3 class="anchored" data-anchor-id="in-text-rmst-g-formula-and-bootstrap">In-text: RMST g-formula and bootstrap</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-16-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-1" role="tab" aria-controls="tabset-16-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-16-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-2" role="tab" aria-controls="tabset-16-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-16-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-16-1-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-r-rmst-gform_748918c255047bde9cb010bce0fff267">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>pbcsub <span class="ot">&lt;-</span> <span class="fu">subset</span>(pbc3,<span class="sc">!</span><span class="fu">is.na</span>(alb))</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>time   <span class="ot">&lt;-</span> pbcsub<span class="sc">$</span>days<span class="sc">/</span><span class="fl">365.25</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>status <span class="ot">&lt;-</span> pbcsub<span class="sc">$</span>status<span class="sc">!=</span><span class="dv">0</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>arm    <span class="ot">&lt;-</span> pbcsub<span class="sc">$</span>tment<span class="sc">==</span><span class="st">"1"</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>alb    <span class="ot">&lt;-</span> pbcsub<span class="sc">$</span>alb</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>logbili<span class="ot">&lt;-</span> <span class="fu">log2</span>(pbcsub<span class="sc">$</span>bili)</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>xx <span class="ot">&lt;-</span> <span class="fu">cbind</span>(alb, logbili)</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>trydata<span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(arm,time,status,xx))</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>boot.fun <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, index){</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>bdata <span class="ot">&lt;-</span> dat[index,]</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>obj<span class="ot">&lt;-</span><span class="fu">rmst2</span>(bdata<span class="sc">$</span>time,bdata<span class="sc">$</span>status,bdata<span class="sc">$</span>arm,<span class="at">tau=</span><span class="dv">3</span>,</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">covariates=</span><span class="fu">cbind</span>(bdata<span class="sc">$</span>alb,bdata<span class="sc">$</span>logbili))</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>rmst0<span class="ot">&lt;-</span>obj<span class="sc">$</span>RMST.difference.adjusted[<span class="dv">1</span>,<span class="dv">1</span>]<span class="sc">+</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>  obj<span class="sc">$</span>RMST.difference.adjusted[<span class="dv">2</span>,<span class="dv">1</span>]<span class="sc">*</span><span class="dv">0</span><span class="sc">+</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>  obj<span class="sc">$</span>RMST.difference.adjusted[<span class="dv">3</span>,<span class="dv">1</span>]<span class="sc">*</span>bdata<span class="sc">$</span>alb<span class="sc">+</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>  obj<span class="sc">$</span>RMST.difference.adjusted[<span class="dv">4</span>,<span class="dv">1</span>]<span class="sc">*</span>bdata<span class="sc">$</span>logbili</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>rmst1<span class="ot">&lt;-</span>obj<span class="sc">$</span>RMST.difference.adjusted[<span class="dv">1</span>,<span class="dv">1</span>]<span class="sc">+</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>  obj<span class="sc">$</span>RMST.difference.adjusted[<span class="dv">2</span>,<span class="dv">1</span>]<span class="sc">*</span><span class="dv">1</span><span class="sc">+</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>  obj<span class="sc">$</span>RMST.difference.adjusted[<span class="dv">3</span>,<span class="dv">1</span>]<span class="sc">*</span>bdata<span class="sc">$</span>alb<span class="sc">+</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>  obj<span class="sc">$</span>RMST.difference.adjusted[<span class="dv">4</span>,<span class="dv">1</span>]<span class="sc">*</span>bdata<span class="sc">$</span>logbili</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>diff<span class="ot">&lt;-</span>rmst1<span class="sc">-</span>rmst0</span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>res<span class="ot">&lt;-</span><span class="fu">cbind</span>(<span class="fu">mean</span>(rmst0),<span class="fu">mean</span>(rmst1),<span class="fu">mean</span>(diff))</span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(res)</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>B<span class="ot">&lt;-</span><span class="dv">200</span></span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>bootres <span class="ot">&lt;-</span> <span class="fu">boot</span>(trydata, boot.fun, <span class="at">R =</span> B)</span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a><span class="co"># mean and SD</span></span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(</span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">Placebo=</span><span class="fu">mean</span>(bootres<span class="sc">$</span>t[,<span class="dv">1</span>]),</span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">CyA=</span><span class="fu">mean</span>(bootres<span class="sc">$</span>t[,<span class="dv">2</span>]),</span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">Diff=</span><span class="fu">mean</span>(bootres<span class="sc">$</span>t[,<span class="dv">3</span>])),</span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">Placebo=</span><span class="fu">sqrt</span>(<span class="fu">var</span>(bootres<span class="sc">$</span>t[,<span class="dv">1</span>])),</span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">CyA=</span><span class="fu">sqrt</span>(<span class="fu">var</span>(bootres<span class="sc">$</span>t[,<span class="dv">2</span>])),</span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">Diff=</span><span class="fu">sqrt</span>(<span class="fu">var</span>(bootres<span class="sc">$</span>t[,<span class="dv">3</span>])))</span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        Placebo        CyA       Diff
[1,] 2.56815001 2.72999845 0.16184844
[2,] 0.06209124 0.05416741 0.07844583</code></pre>
</div>
</div>
</div>
<div id="tabset-16-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-16-2-tab">

</div>
</div>
</div>
</section>
<section id="table-4.5" class="level3">
<h3 class="anchored" data-anchor-id="table-4.5">Table 4.5</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-17-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-1" role="tab" aria-controls="tabset-17-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-17-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-2" role="tab" aria-controls="tabset-17-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-17-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-17-1-tab">
<section id="using-mets-package-2" class="level4">
<h4 class="anchored" data-anchor-id="using-mets-package-2">Using mets package</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.5-r-mets_713f8f671bfacd3c2e1a88dac3f189da">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">contrasts=</span><span class="fu">c</span>(<span class="st">"contr.treatment"</span>, <span class="st">"contr.poly"</span>))</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>subpbc<span class="ot">&lt;-</span><span class="fu">subset</span>(pbc3, <span class="sc">!</span><span class="fu">is.na</span>(alb))</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>subpbc<span class="sc">$</span>tment<span class="ot">&lt;-</span><span class="fu">factor</span>(subpbc<span class="sc">$</span>tment)</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Death w/o transplant</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>fgdeath<span class="ot">&lt;-</span><span class="fu">cifreg</span>(<span class="fu">Event</span>(days,status)<span class="sc">~</span><span class="fu">factor</span>(tment)<span class="sc">+</span>alb<span class="sc">+</span>log2bili<span class="sc">+</span>sex<span class="sc">+</span>age, <span class="at">cause=</span><span class="dv">2</span>, </span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> subpbc, <span class="at">propodds=</span><span class="cn">NULL</span>)</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>fgdeath</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
cifreg(formula = Event(days, status) ~ factor(tment) + alb + 
    log2bili + sex + age, data = subpbc, cause = 2, propodds = NULL)

   n events
 343     60

 343 clusters
coeffients:
                Estimate      S.E.   dU^-1/2 P-value
factor(tment)1 -0.352775  0.260075  0.267053  0.1750
alb            -0.061245  0.030848  0.028700  0.0471
log2bili        0.615653  0.088872  0.090387  0.0000
sex             0.414735  0.316821  0.312520  0.1905
age             0.087488  0.015744  0.016208  0.0000

exp(coeffients):
               Estimate    2.5%  97.5%
factor(tment)1  0.70274 0.42210 1.1700
alb             0.94059 0.88541 0.9992
log2bili        1.85087 1.55499 2.2030
sex             1.51397 0.81365 2.8171
age             1.09143 1.05826 1.1256</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transplant</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>fgtrans<span class="ot">&lt;-</span><span class="fu">cifreg</span>(<span class="fu">Event</span>(days,status)<span class="sc">~</span><span class="fu">factor</span>(tment)<span class="sc">+</span>alb<span class="sc">+</span>log2bili<span class="sc">+</span>sex<span class="sc">+</span>age, <span class="at">cause=</span><span class="dv">1</span>, </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> subpbc, <span class="at">propodds=</span><span class="cn">NULL</span>, <span class="at">cox.prep=</span><span class="cn">TRUE</span>)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>fgtrans</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
cifreg(formula = Event(days, status) ~ factor(tment) + alb + 
    log2bili + sex + age, data = subpbc, cause = 1, propodds = NULL, 
    cox.prep = TRUE)

   n events
 343     28

 343 clusters
coeffients:
                Estimate      S.E.   dU^-1/2 P-value
factor(tment)1 -0.407479  0.368430  0.403161  0.2687
alb            -0.069736  0.032685  0.038429  0.0329
log2bili        0.619024  0.101177  0.128955  0.0000
sex             0.087804  0.579890  0.551723  0.8796
age            -0.075062  0.017119  0.020770  0.0000

exp(coeffients):
               Estimate    2.5%  97.5%
factor(tment)1  0.66533 0.32317 1.3698
alb             0.93264 0.87477 0.9943
log2bili        1.85711 1.52306 2.2644
sex             1.09177 0.35037 3.4020
age             0.92769 0.89708 0.9593</code></pre>
</div>
</div>
</section>
<section id="using-survival-package" class="level4">
<h4 class="anchored" data-anchor-id="using-survival-package">Using survival package</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.5-r-survival_0be0644f27c68af7120edcd22acfd10c">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Death w/o transplant</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Two step</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>fg_c2 <span class="ot">&lt;-</span> <span class="fu">finegray</span>(<span class="fu">Surv</span>(days, <span class="fu">as.factor</span>(status)) <span class="sc">~</span> ., <span class="at">etype =</span> <span class="dv">2</span>,</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> <span class="fu">subset</span>(pbc3, <span class="sc">!</span><span class="fu">is.na</span>(alb)))</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>fg_cox2 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(fgstart, fgstop, fgstatus) <span class="sc">~</span> </span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>                   tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili <span class="sc">+</span> sex <span class="sc">+</span> age, </span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">weight =</span> fgwt, <span class="at">data =</span> fg_c2, <span class="at">eps=</span><span class="fl">1e-9</span>)</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fg_cox2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(fgstart, fgstop, fgstatus) ~ tment + alb + 
    log2bili + sex + age, data = fg_c2, weights = fgwt, eps = 1e-09)

  n= 1004, number of events= 60 

             coef exp(coef) se(coef) robust se      z Pr(&gt;|z|)    
tment    -0.35282   0.70270  0.26705   0.25111 -1.405   0.1600    
alb      -0.06122   0.94062  0.02870   0.02933 -2.087   0.0369 *  
log2bili  0.61556   1.85069  0.09038   0.08521  7.224 5.06e-13 ***
sex       0.41484   1.51412  0.31251   0.30590  1.356   0.1751    
age       0.08748   1.09142  0.01621   0.01507  5.804 6.47e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

         exp(coef) exp(-coef) lower .95 upper .95
tment       0.7027     1.4231    0.4296    1.1495
alb         0.9406     1.0631    0.8881    0.9963
log2bili    1.8507     0.5403    1.5660    2.1871
sex         1.5141     0.6604    0.8313    2.7577
age         1.0914     0.9162    1.0597    1.1241

Concordance= 0.829  (se = 0.024 )
Likelihood ratio test= 89.68  on 5 df,   p=&lt;2e-16
Wald test            = 111.5  on 5 df,   p=&lt;2e-16
Score (logrank) test = 93.71  on 5 df,   p=&lt;2e-16,   Robust = 43.86  p=2e-08

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transplant</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Two step</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>fg_c1 <span class="ot">&lt;-</span> <span class="fu">finegray</span>(<span class="fu">Surv</span>(days, <span class="fu">as.factor</span>(status)) <span class="sc">~</span> ., <span class="at">etype =</span> <span class="dv">1</span>,</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> <span class="fu">subset</span>(pbc3, <span class="sc">!</span><span class="fu">is.na</span>(alb)))</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>fg_cox1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(fgstart, fgstop, fgstatus) <span class="sc">~</span> </span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>                   tment <span class="sc">+</span> alb <span class="sc">+</span> log2bili <span class="sc">+</span> sex <span class="sc">+</span> age, </span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">weight =</span> fgwt, <span class="at">data =</span> fg_c1, <span class="at">eps=</span><span class="fl">1e-9</span>)</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fg_cox1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(fgstart, fgstop, fgstatus) ~ tment + alb + 
    log2bili + sex + age, data = fg_c1, weights = fgwt, eps = 1e-09)

  n= 1068, number of events= 28 

             coef exp(coef) se(coef) robust se      z Pr(&gt;|z|)    
tment    -0.40756   0.66527  0.40311   0.34977 -1.165   0.2439    
alb      -0.06960   0.93276  0.03844   0.03005 -2.316   0.0205 *  
log2bili  0.61867   1.85646  0.12892   0.09119  6.785 1.16e-11 ***
sex       0.09043   1.09465  0.55193   0.55524  0.163   0.8706    
age      -0.07507   0.92768  0.02077   0.01590 -4.720 2.36e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

         exp(coef) exp(-coef) lower .95 upper .95
tment       0.6653     1.5031    0.3352    1.3205
alb         0.9328     1.0721    0.8794    0.9894
log2bili    1.8565     0.5387    1.5526    2.2198
sex         1.0946     0.9135    0.3687    3.2501
age         0.9277     1.0780    0.8992    0.9570

Concordance= 0.858  (se = 0.025 )
Likelihood ratio test= 52.17  on 5 df,   p=5e-10
Wald test            = 78.57  on 5 df,   p=2e-15
Score (logrank) test = 56.42  on 5 df,   p=7e-11,   Robust = 21.26  p=7e-04

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
</div>
</section>
</div>
<div id="tabset-17-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-17-2-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.5-sas_2aecf0a9a888dfb5f4f9346e4fbec27c">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co">* Death without transplantation;</span> </span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    class sex (ref=<span class="st">'1'</span>) tment (ref=<span class="st">'0'</span>);</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span>)=sex tment age log2bili alb / rl eventcode=<span class="dv">2</span>;</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="co">* Transplantation;</span> </span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>    class sex (ref=<span class="st">'1'</span>) tment (ref=<span class="st">'0'</span>);</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span>)=sex tment age log2bili alb / rl eventcode=<span class="dv">1</span>;</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="in-text-fine-gray-and-g-formula" class="level3">
<h3 class="anchored" data-anchor-id="in-text-fine-gray-and-g-formula">In-text: Fine-Gray and g-formula</h3>
<p>Using mets package and not bootstrap as in book.</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-18-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-1" role="tab" aria-controls="tabset-18-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-18-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-2" role="tab" aria-controls="tabset-18-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-18-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-18-1-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-fg-gform-r_c034388bdc315b9503199c1864f49800">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fine-Gray models using package mets</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">contrasts=</span><span class="fu">c</span>(<span class="st">"contr.treatment"</span>, <span class="st">"contr.poly"</span>))</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Transplant</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>subpbc<span class="ot">&lt;-</span><span class="fu">subset</span>(pbc3, <span class="sc">!</span><span class="fu">is.na</span>(alb))</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>subpbc<span class="sc">$</span>trt<span class="ot">&lt;-</span><span class="fu">factor</span>(subpbc<span class="sc">$</span>tment)</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>fgtrans<span class="ot">&lt;-</span><span class="fu">cifreg</span>(<span class="fu">Event</span>(days,status)<span class="sc">~</span>trt<span class="sc">+</span>alb<span class="sc">+</span>log2bili<span class="sc">+</span>sex<span class="sc">+</span>age, <span class="at">cause=</span><span class="dv">1</span>, </span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> subpbc, <span class="at">propodds=</span><span class="cn">NULL</span>, <span class="at">cox.prep=</span><span class="cn">TRUE</span>)</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">survivalG</span>(fgtrans, subpbc, <span class="dv">2</span><span class="sc">*</span><span class="fl">365.25</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>risk:
      Estimate Std.Err    2.5%   97.5%   P-value
risk0  0.06890 0.01994 0.02983 0.10798 0.0005477
risk1  0.04895 0.01310 0.02327 0.07464 0.0001875

Average Treatment effects (G-estimator) :
   Estimate Std.Err     2.5%   97.5% P-value
p1 -0.01995 0.01915 -0.05748 0.01758  0.2975

Average Treatment effect ratio (G-estimator) :
      Estimate Std.Err      2.5%    97.5%   P-value
[p1] 0.7104376 0.21938 0.2804607 1.140415 0.1868643</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Death w/o transplant</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>fgdeath<span class="ot">&lt;-</span><span class="fu">cifreg</span>(<span class="fu">Event</span>(days,status)<span class="sc">~</span>trt<span class="sc">+</span>alb<span class="sc">+</span>log2bili<span class="sc">+</span>sex<span class="sc">+</span>age, <span class="at">cause=</span><span class="dv">2</span>, </span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> subpbc, <span class="at">propodds=</span><span class="cn">NULL</span>, <span class="at">cox.prep=</span><span class="cn">TRUE</span>)</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">survivalG</span>(fgdeath, subpbc, <span class="dv">2</span><span class="sc">*</span><span class="fl">365.25</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>risk:
      Estimate Std.Err    2.5%  97.5%   P-value
risk0  0.11694 0.02164 0.07453 0.1594 6.520e-08
risk1  0.08815 0.01890 0.05111 0.1252 3.107e-06

Average Treatment effects (G-estimator) :
   Estimate Std.Err     2.5%   97.5% P-value
p1 -0.02879 0.02126 -0.07046 0.01289  0.1758

Average Treatment effect ratio (G-estimator) :
      Estimate   Std.Err      2.5%    97.5%   P-value
[p1] 0.7538432 0.1581281 0.4439178 1.063769 0.1195436</code></pre>
</div>
</div>
</div>
<div id="tabset-18-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-18-2-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-fg-gform-sas_2718bbbd53732928e2fe0dc70aa3e0e5">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.17" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.17">Figure 4.17</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-19-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-19-1" role="tab" aria-controls="tabset-19-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-19-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-19-2" role="tab" aria-controls="tabset-19-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-19-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-19-1-tab">
<section id="figure-4.17-a" class="level4">
<h4 class="anchored" data-anchor-id="figure-4.17-a">Figure 4.17 (a)</h4>
<div class="cell" data-hash="Ch4_cache/html/figure-4.17a-r_3d19cacf63418875ef9f541030e06100">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fine-Gray model for death w/o transplant</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions </span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Placebo</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>newd_t0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="dv">0</span>, <span class="at">age =</span> <span class="dv">40</span>, </span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">alb =</span> <span class="dv">38</span>, <span class="at">log2bili =</span> <span class="fu">log2</span>(<span class="dv">45</span>), </span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sex =</span> <span class="dv">0</span>)</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>C2_t0 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(fg_cox2, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd_t0)<span class="sc">$</span>cumhaz </span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a><span class="co"># CyA</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>newd_t1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">tment =</span> <span class="dv">1</span>, <span class="at">age =</span> <span class="dv">40</span>, </span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">alb =</span> <span class="dv">38</span>, <span class="at">log2bili =</span> <span class="fu">log2</span>(<span class="dv">45</span>), </span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sex =</span> <span class="dv">0</span>)</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>C2_t1 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(fg_cox2, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd_t1)<span class="sc">$</span>cumhaz </span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">survfit</span>(fg_cox2, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd_t1)<span class="sc">$</span>time</span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Make data ready for plotting </span></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>pdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">c</span>(time, time), </span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>                    <span class="at">cif =</span> <span class="fu">c</span>(C2_t0, C2_t1), </span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a>                    <span class="at">tment =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Placebo"</span>, <span class="fu">length</span>(time)), </span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rep</span>(<span class="st">"CyA"</span>, <span class="fu">length</span>(time))))</span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure</span></span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.17</span>a <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> cif, <span class="at">linetype =</span> tment), </span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> pdata) <span class="sc">+</span> </span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="st">"Treatment"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dashed"</span>, <span class="st">"solid"</span>),<span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span> </span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Cumulative incidence for death w/o transplantation'</span>) <span class="sc">+</span> </span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>), </span>
<span id="cb114-32"><a href="#cb114-32" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb114-33"><a href="#cb114-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.05</span>)), </span>
<span id="cb114-34"><a href="#cb114-34" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>), </span>
<span id="cb114-35"><a href="#cb114-35" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb114-36"><a href="#cb114-36" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb114-37"><a href="#cb114-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>, <span class="at">legend.box =</span> <span class="st">"vertical"</span>)</span>
<span id="cb114-38"><a href="#cb114-38" aria-hidden="true" tabindex="-1"></a>      <span class="co">#  legend.key.size = unit(1.5, 'cm'))</span></span>
<span id="cb114-39"><a href="#cb114-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-40"><a href="#cb114-40" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.17</span>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.17a-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</section>
<section id="figure-4.17-b" class="level4">
<h4 class="anchored" data-anchor-id="figure-4.17-b">Figure 4.17 (b)</h4>
<div class="cell" data-hash="Ch4_cache/html/figure-4.17b_fec039eb80e4ed08b33d3c4ed7e957b2">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fine-Gray model for transplant</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions </span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Placebo</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>C1_t0 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(fg_cox1, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd_t0)<span class="sc">$</span>cumhaz </span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a><span class="co"># CyA</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>C1_t1 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(fg_cox1, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd_t1)<span class="sc">$</span>cumhaz </span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">survfit</span>(fg_cox1, <span class="at">ctype =</span> <span class="dv">2</span>, <span class="at">newdata =</span> newd_t1)<span class="sc">$</span>time</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Make data ready for plotting </span></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>pdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">c</span>(time, time), </span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">cif =</span> <span class="fu">c</span>(C1_t0, C1_t1), </span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">tment =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Placebo"</span>, <span class="fu">length</span>(time)), </span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rep</span>(<span class="st">"CyA"</span>, <span class="fu">length</span>(time))))</span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure</span></span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.17</span>b <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> cif, <span class="at">linetype =</span> tment), </span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> pdata) <span class="sc">+</span> </span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="st">"Treatment"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dashed"</span>, <span class="st">"solid"</span>),<span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span> </span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Cumulative incidence for transplantation'</span>) <span class="sc">+</span> </span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>), </span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.05</span>)), </span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>), </span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>))</span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-35"><a href="#cb115-35" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.17</span>b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.17b-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</section>
</div>
<div id="tabset-19-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-19-2-tab">
<section id="covariate-values" class="level4">
<h4 class="anchored" data-anchor-id="covariate-values">Covariate values</h4>
<div class="cell" data-hash="Ch4_cache/html/figure-4.17-sas-covs_9318bcccc430833ba782b700c93eb3db">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov0;</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">input</span> sex tment age alb log2bili;</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    log2bili=<span class="fu">log2</span>(log2bili);</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    datalines;</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 0 40 38 45</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="ot">    ;</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov1;</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">input</span> sex tment age alb log2bili;</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>    log2bili=<span class="fu">log2</span>(log2bili);</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a><span class="ot">    datalines;</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a><span class="ot">    0 1 40 38 45</span></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a><span class="ot">    ;</span></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="figure-4.17-a-1" class="level4">
<h4 class="anchored" data-anchor-id="figure-4.17-a-1">Figure 4.17 (a)</h4>
<div class="cell" data-hash="Ch4_cache/html/figure-4.17a-sas_d9d8155628f93e5091be9c1e577bfcd5">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">* For death without transplantation;</span> </span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span>)=sex tment age log2bili alb/eventcode=<span class="dv">2</span>;</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    baseline out=cuminc20 covariates=cov0 cif=cif20;</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span>)=sex tment age log2bili alb/eventcode=<span class="dv">2</span>;</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>    baseline out=cuminc21 covariates=cov1 cif=cif21;</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cuminc2; </span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">merge</span> cuminc20 cuminc21; </span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> days; </span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cuminc2; </span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> cuminc2; </span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>    daysyears = days / <span class="dv">365.25</span>; </span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=cuminc2;</span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>    plot cif20*daysyears cif21*daysyears/overlay haxis=axis1 vaxis=axis2;</span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Cumulative incidences for death'</span>);</span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="figure-4.17-b-1" class="level4">
<h4 class="anchored" data-anchor-id="figure-4.17-b-1">Figure 4.17 (b)</h4>
<div class="cell" data-hash="Ch4_cache/html/figure-4.17b-sas_e0d3b918662242d73b9b6b2f09b9bb1f">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co">* For transplantation;</span> </span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="co">    *class sex tment (ref='0');</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span>)=sex tment age log2bili alb/eventcode=<span class="dv">1</span>;</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    baseline out=cuminc10 covariates=cov0 cif=cif10;</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="co">    *class sex tment (ref='0');</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> days*status(<span class="dv">0</span>)=sex tment age log2bili alb/eventcode=<span class="dv">1</span>;</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    baseline out=cuminc11 covariates=cov1 cif=cif11;</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cuminc1; </span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">merge</span> cuminc10 cuminc11; </span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> days; </span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cuminc1; </span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> cuminc1; </span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>    daysyears = days / <span class="dv">365.25</span>; </span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=cuminc1;</span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>    plot cif10*daysyears cif11*daysyears/overlay haxis=axis1 vaxis=axis2;</span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Cumulative incidence for transpl.'</span>);</span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</div>
</div>
</div>
</section>
<section id="table-4.6" class="level3">
<h3 class="anchored" data-anchor-id="table-4.6">Table 4.6</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-20-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-20-1" role="tab" aria-controls="tabset-20-1" aria-selected="true">R</a></li></ul>
<div class="tab-content">
<div id="tabset-20-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-20-1-tab">
<section id="create-r-function-rmtl.ipcw" class="level4">
<h4 class="anchored" data-anchor-id="create-r-function-rmtl.ipcw">Create R function rmtl.ipcw()</h4>
<p>The function rmtl.ipcw() fit a restricted mean time lost regression model using IPCW with competing risks data.</p>
<div class="cell" data-hash="Ch4_cache/html/rmtl.ipcw-function_2571620431ec6adf6c7b403a7cdb31af">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Note: This code is modified from the original 'rmst2reg function' of the</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="do">### survRM2 package, which was authored by Hajime Uno, Lu Tian, Angel Cronin, </span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="do">### Chakib Battioui, and Miki Horiguchi, in order to account for competing risks.</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="do">### Last updated by Sarah Conner on October 22, 2020</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>rmtl.ipcw <span class="ot">&lt;-</span> <span class="cf">function</span>(times, event, <span class="at">eoi=</span><span class="dv">1</span>, tau, <span class="at">cov=</span><span class="cn">NULL</span>, <span class="at">strata=</span><span class="cn">FALSE</span>, <span class="at">group=</span><span class="cn">NULL</span>){</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(group) <span class="sc">&amp;</span> strata<span class="sc">==</span><span class="cn">TRUE</span>){<span class="fu">stop</span>(<span class="st">'Please specify a factor variable to statify weights.'</span>)}</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(cov)){<span class="fu">print</span>(<span class="st">'Warning: Fitting intercept-only model.'</span>)}</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Round event times to avoid issues with survival() package rounding differently</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">round</span>(times,<span class="dv">4</span>)</span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>  id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(y)</span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recode so delta1 reflects event of interest, delta2 reflects all competing events. Assumes 0=censoring.</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>  delta1 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(event<span class="sc">==</span>eoi, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>  delta2 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(event<span class="sc">!=</span><span class="dv">0</span> <span class="sc">&amp;</span> event<span class="sc">!=</span>eoi, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Overall quantities</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">int=</span><span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(y)), cov)</span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">length</span>(x[<span class="dv">1</span>,])</span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(group)){group <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(y)))}</span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recode event indicators to reflect status at chosen tau</span></span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>  delta1[y<span class="sc">&gt;</span>tau] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>  delta2[y<span class="sc">&gt;</span>tau] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">pmin</span>(y, tau)</span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y<span class="sc">*</span>delta1</span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>  d0 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (delta1 <span class="sc">+</span> delta2) <span class="co"># censoring indicator</span></span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>  d0[y<span class="sc">==</span>tau] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># If follow-up lasts til tau, the event will not count as 'censored' in IPCW weights</span></span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>  weights <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate IPCW weights (option to stratify by group) ## </span></span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(strata<span class="sc">==</span><span class="cn">TRUE</span>){</span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(aa <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(group))){</span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Subset the group</span></span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a>      a <span class="ot">&lt;-</span> <span class="fu">unique</span>(group)[aa]</span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a>      d0.a <span class="ot">&lt;-</span> d0[group<span class="sc">==</span>a]</span>
<span id="cb119-44"><a href="#cb119-44" aria-hidden="true" tabindex="-1"></a>      delta1.a <span class="ot">&lt;-</span> delta1[group<span class="sc">==</span>a]</span>
<span id="cb119-45"><a href="#cb119-45" aria-hidden="true" tabindex="-1"></a>      y.a <span class="ot">&lt;-</span> y[group<span class="sc">==</span>a]</span>
<span id="cb119-46"><a href="#cb119-46" aria-hidden="true" tabindex="-1"></a>      x.a <span class="ot">&lt;-</span> x[group<span class="sc">==</span>a,]</span>
<span id="cb119-47"><a href="#cb119-47" aria-hidden="true" tabindex="-1"></a>      n.a <span class="ot">&lt;-</span> <span class="fu">length</span>(d0.a)</span>
<span id="cb119-48"><a href="#cb119-48" aria-hidden="true" tabindex="-1"></a>      orig.id.a0 <span class="ot">&lt;-</span> orig.id.a <span class="ot">&lt;-</span> id[group<span class="sc">==</span>a]</span>
<span id="cb119-49"><a href="#cb119-49" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb119-50"><a href="#cb119-50" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Order the event times</span></span>
<span id="cb119-51"><a href="#cb119-51" aria-hidden="true" tabindex="-1"></a>      id.a <span class="ot">&lt;-</span> <span class="fu">order</span>(y.a)</span>
<span id="cb119-52"><a href="#cb119-52" aria-hidden="true" tabindex="-1"></a>      y.a <span class="ot">&lt;-</span> y.a[id.a]</span>
<span id="cb119-53"><a href="#cb119-53" aria-hidden="true" tabindex="-1"></a>      d0.a <span class="ot">&lt;-</span> d0.a[id.a]</span>
<span id="cb119-54"><a href="#cb119-54" aria-hidden="true" tabindex="-1"></a>      delta1.a <span class="ot">&lt;-</span> delta1.a[id.a]</span>
<span id="cb119-55"><a href="#cb119-55" aria-hidden="true" tabindex="-1"></a>      x.a <span class="ot">&lt;-</span> x.a[id.a,]</span>
<span id="cb119-56"><a href="#cb119-56" aria-hidden="true" tabindex="-1"></a>      orig.id.a <span class="ot">&lt;-</span> orig.id.a[id.a]</span>
<span id="cb119-57"><a href="#cb119-57" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb119-58"><a href="#cb119-58" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Derive IPCW</span></span>
<span id="cb119-59"><a href="#cb119-59" aria-hidden="true" tabindex="-1"></a>      fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(y.a, d0.a) <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb119-60"><a href="#cb119-60" aria-hidden="true" tabindex="-1"></a>      weights.a <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>d0.a)<span class="sc">/</span><span class="fu">rep</span>(fit<span class="sc">$</span>surv, <span class="fu">table</span>(y.a))</span>
<span id="cb119-61"><a href="#cb119-61" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb119-62"><a href="#cb119-62" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Need to assign weights accordig to original ID, not ordered by event time</span></span>
<span id="cb119-63"><a href="#cb119-63" aria-hidden="true" tabindex="-1"></a>      linked.weights.a <span class="ot">&lt;-</span> <span class="fu">cbind</span>(orig.id.a, weights.a, delta1.a, d0.a, y.a)</span>
<span id="cb119-64"><a href="#cb119-64" aria-hidden="true" tabindex="-1"></a>      weights <span class="ot">&lt;-</span> <span class="fu">rbind</span>(weights, linked.weights.a)</span>
<span id="cb119-65"><a href="#cb119-65" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb119-66"><a href="#cb119-66" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb119-67"><a href="#cb119-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-68"><a href="#cb119-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Order the event times</span></span>
<span id="cb119-69"><a href="#cb119-69" aria-hidden="true" tabindex="-1"></a>    id.a <span class="ot">&lt;-</span> <span class="fu">order</span>(y)</span>
<span id="cb119-70"><a href="#cb119-70" aria-hidden="true" tabindex="-1"></a>    y.a <span class="ot">&lt;-</span> y[id.a]</span>
<span id="cb119-71"><a href="#cb119-71" aria-hidden="true" tabindex="-1"></a>    d0.a <span class="ot">&lt;-</span> d0[id.a]</span>
<span id="cb119-72"><a href="#cb119-72" aria-hidden="true" tabindex="-1"></a>    delta1.a <span class="ot">&lt;-</span> delta1[id.a]</span>
<span id="cb119-73"><a href="#cb119-73" aria-hidden="true" tabindex="-1"></a>    x.a <span class="ot">&lt;-</span> x[id.a,]</span>
<span id="cb119-74"><a href="#cb119-74" aria-hidden="true" tabindex="-1"></a>    orig.id.a <span class="ot">&lt;-</span> id[id.a]</span>
<span id="cb119-75"><a href="#cb119-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-76"><a href="#cb119-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Derive IPCW</span></span>
<span id="cb119-77"><a href="#cb119-77" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(y.a, d0.a) <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb119-78"><a href="#cb119-78" aria-hidden="true" tabindex="-1"></a>    weights.a <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>d0.a)<span class="sc">/</span><span class="fu">rep</span>(fit<span class="sc">$</span>surv, <span class="fu">table</span>(y.a))</span>
<span id="cb119-79"><a href="#cb119-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-80"><a href="#cb119-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Need to assign weights accordig to original ID, not ordered by event time</span></span>
<span id="cb119-81"><a href="#cb119-81" aria-hidden="true" tabindex="-1"></a>    linked.weights.a <span class="ot">&lt;-</span> <span class="fu">cbind</span>(orig.id.a, weights.a, delta1.a, d0.a, y.a)</span>
<span id="cb119-82"><a href="#cb119-82" aria-hidden="true" tabindex="-1"></a>    weights <span class="ot">&lt;-</span> <span class="fu">rbind</span>(weights, linked.weights.a)</span>
<span id="cb119-83"><a href="#cb119-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb119-84"><a href="#cb119-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-85"><a href="#cb119-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-86"><a href="#cb119-86" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Fit linear model ## </span></span>
<span id="cb119-87"><a href="#cb119-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-88"><a href="#cb119-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Link weights to original data frame</span></span>
<span id="cb119-89"><a href="#cb119-89" aria-hidden="true" tabindex="-1"></a>  <span class="co">#colnames(weights) &lt;- c('id', 'weights')</span></span>
<span id="cb119-90"><a href="#cb119-90" aria-hidden="true" tabindex="-1"></a>  <span class="co">#data &lt;- merge(data0, weights, by='id')</span></span>
<span id="cb119-91"><a href="#cb119-91" aria-hidden="true" tabindex="-1"></a>  <span class="co">#summary(lm(tau-y ~ x-1, weights=weights, data=data))</span></span>
<span id="cb119-92"><a href="#cb119-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-93"><a href="#cb119-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Or, sort weights and use vectors</span></span>
<span id="cb119-94"><a href="#cb119-94" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> weights[<span class="fu">order</span>(weights[, <span class="dv">1</span>]),<span class="dv">2</span>]</span>
<span id="cb119-95"><a href="#cb119-95" aria-hidden="true" tabindex="-1"></a>  lm.fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(delta1<span class="sc">*</span>(tau<span class="sc">-</span>y) <span class="sc">~</span> x<span class="dv">-1</span>, <span class="at">weights=</span>w)</span>
<span id="cb119-96"><a href="#cb119-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-97"><a href="#cb119-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-98"><a href="#cb119-98" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Derive SE ##</span></span>
<span id="cb119-99"><a href="#cb119-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-100"><a href="#cb119-100" aria-hidden="true" tabindex="-1"></a>  beta0 <span class="ot">&lt;-</span> lm.fit<span class="sc">$</span>coef</span>
<span id="cb119-101"><a href="#cb119-101" aria-hidden="true" tabindex="-1"></a>  error <span class="ot">&lt;-</span> tau <span class="sc">-</span> y <span class="sc">-</span> <span class="fu">as.vector</span>(x <span class="sc">%*%</span> beta0)</span>
<span id="cb119-102"><a href="#cb119-102" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> x <span class="sc">*</span> w <span class="sc">*</span> error</span>
<span id="cb119-103"><a href="#cb119-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-104"><a href="#cb119-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Kappa (sandwich variance components) stratified by group</span></span>
<span id="cb119-105"><a href="#cb119-105" aria-hidden="true" tabindex="-1"></a>  kappa <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb119-106"><a href="#cb119-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-107"><a href="#cb119-107" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(aa <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(group))){</span>
<span id="cb119-108"><a href="#cb119-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-109"><a href="#cb119-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset the group</span></span>
<span id="cb119-110"><a href="#cb119-110" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">unique</span>(group)[aa]</span>
<span id="cb119-111"><a href="#cb119-111" aria-hidden="true" tabindex="-1"></a>    d0.a <span class="ot">&lt;-</span> d0[group<span class="sc">==</span>a]</span>
<span id="cb119-112"><a href="#cb119-112" aria-hidden="true" tabindex="-1"></a>    delta1.a <span class="ot">&lt;-</span> delta1[group<span class="sc">==</span>a]</span>
<span id="cb119-113"><a href="#cb119-113" aria-hidden="true" tabindex="-1"></a>    y.a <span class="ot">&lt;-</span> y[group<span class="sc">==</span>a]</span>
<span id="cb119-114"><a href="#cb119-114" aria-hidden="true" tabindex="-1"></a>    x.a <span class="ot">&lt;-</span> x[group<span class="sc">==</span>a,]</span>
<span id="cb119-115"><a href="#cb119-115" aria-hidden="true" tabindex="-1"></a>    n.a <span class="ot">&lt;-</span> <span class="fu">length</span>(d0.a)</span>
<span id="cb119-116"><a href="#cb119-116" aria-hidden="true" tabindex="-1"></a>    orig.id.a0 <span class="ot">&lt;-</span> orig.id.a <span class="ot">&lt;-</span> id[group<span class="sc">==</span>a]</span>
<span id="cb119-117"><a href="#cb119-117" aria-hidden="true" tabindex="-1"></a>    score.a <span class="ot">&lt;-</span> score[group<span class="sc">==</span>a,]</span>
<span id="cb119-118"><a href="#cb119-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-119"><a href="#cb119-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Kappa calculations for sandwich variance</span></span>
<span id="cb119-120"><a href="#cb119-120" aria-hidden="true" tabindex="-1"></a>    kappa.a <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n.a, p)</span>
<span id="cb119-121"><a href="#cb119-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-122"><a href="#cb119-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.a){</span>
<span id="cb119-123"><a href="#cb119-123" aria-hidden="true" tabindex="-1"></a>      kappa1 <span class="ot">&lt;-</span> score.a[i,]</span>
<span id="cb119-124"><a href="#cb119-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-125"><a href="#cb119-125" aria-hidden="true" tabindex="-1"></a>      kappa2 <span class="ot">&lt;-</span> <span class="fu">apply</span>(score.a[y.a<span class="sc">&gt;=</span>y.a[i],,<span class="at">drop=</span>F], <span class="dv">2</span>, sum)<span class="sc">*</span>(d0.a[i])<span class="sc">/</span><span class="fu">sum</span>(y.a<span class="sc">&gt;=</span>y.a[i])</span>
<span id="cb119-126"><a href="#cb119-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-127"><a href="#cb119-127" aria-hidden="true" tabindex="-1"></a>      kappa3 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, p)</span>
<span id="cb119-128"><a href="#cb119-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb119-129"><a href="#cb119-129" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.a){</span>
<span id="cb119-130"><a href="#cb119-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(y.a[k]<span class="sc">&lt;=</span>y.a[i]){</span>
<span id="cb119-131"><a href="#cb119-131" aria-hidden="true" tabindex="-1"></a>          kappa3 <span class="ot">&lt;-</span> kappa3<span class="sc">+</span><span class="fu">apply</span>(score.a[y.a<span class="sc">&gt;=</span>y.a[k],,<span class="at">drop=</span>F], <span class="dv">2</span>, sum)<span class="sc">*</span>(d0.a[k])<span class="sc">/</span>(<span class="fu">sum</span>(y.a<span class="sc">&gt;=</span>y.a[k]))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb119-132"><a href="#cb119-132" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb119-133"><a href="#cb119-133" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb119-134"><a href="#cb119-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-135"><a href="#cb119-135" aria-hidden="true" tabindex="-1"></a>      kappa.a[i,] <span class="ot">&lt;-</span> kappa1<span class="sc">+</span>kappa2<span class="sc">-</span>kappa3</span>
<span id="cb119-136"><a href="#cb119-136" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb119-137"><a href="#cb119-137" aria-hidden="true" tabindex="-1"></a>    kappa <span class="ot">&lt;-</span> <span class="fu">rbind</span>(kappa, kappa.a)</span>
<span id="cb119-138"><a href="#cb119-138" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb119-139"><a href="#cb119-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-140"><a href="#cb119-140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transpose the kappas rbinded from each group gives pxp matrix</span></span>
<span id="cb119-141"><a href="#cb119-141" aria-hidden="true" tabindex="-1"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">t</span>(kappa) <span class="sc">%*%</span> kappa</span>
<span id="cb119-142"><a href="#cb119-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-143"><a href="#cb119-143" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">t</span>(x) <span class="sc">%*%</span> x</span>
<span id="cb119-144"><a href="#cb119-144" aria-hidden="true" tabindex="-1"></a>  varbeta <span class="ot">&lt;-</span> <span class="fu">solve</span>(A) <span class="sc">%*%</span> gamma <span class="sc">%*%</span> <span class="fu">solve</span>(A)</span>
<span id="cb119-145"><a href="#cb119-145" aria-hidden="true" tabindex="-1"></a>  se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(varbeta))</span>
<span id="cb119-146"><a href="#cb119-146" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-147"><a href="#cb119-147" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-148"><a href="#cb119-148" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- Return results ---</span></span>
<span id="cb119-149"><a href="#cb119-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-150"><a href="#cb119-150" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">beta=</span>lm.fit<span class="sc">$</span>coef, <span class="at">se=</span>se, <span class="at">cil=</span>lm.fit<span class="sc">$</span>coef<span class="sc">-</span>(<span class="fl">1.96</span><span class="sc">*</span>se), <span class="at">ciu=</span>lm.fit<span class="sc">$</span>coef<span class="sc">+</span>(<span class="fl">1.96</span><span class="sc">*</span>se), </span>
<span id="cb119-151"><a href="#cb119-151" aria-hidden="true" tabindex="-1"></a>               <span class="at">z=</span>lm.fit<span class="sc">$</span>coef<span class="sc">/</span>se, <span class="at">p=</span><span class="dv">2</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">pnorm</span>(<span class="fu">abs</span>(lm.fit<span class="sc">$</span>coef<span class="sc">/</span>se))))</span>
<span id="cb119-152"><a href="#cb119-152" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rownames(res) &lt;- c("Intercept", colnames(x[,-1])) FJERNET! PKA 030621</span></span>
<span id="cb119-153"><a href="#cb119-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb119-154"><a href="#cb119-154" aria-hidden="true" tabindex="-1"></a>  allres <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">res=</span>res, <span class="at">varbeta=</span>varbeta)</span>
<span id="cb119-155"><a href="#cb119-155" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(round(res, 3))</span></span>
<span id="cb119-156"><a href="#cb119-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(allres)</span>
<span id="cb119-157"><a href="#cb119-157" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(res[,<span class="dv">1</span>]) <span class="co">#tilfjet 040322</span></span>
<span id="cb119-158"><a href="#cb119-158" aria-hidden="true" tabindex="-1"></a>}  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="using-rmtl.ipcw-function" class="level4">
<h4 class="anchored" data-anchor-id="using-rmtl.ipcw-function">Using rmtl.ipcw() function</h4>
<div class="cell" data-hash="Ch4_cache/html/table-4.6-r_394a5d8a8e15805a532533cfb1f2ed5a">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rmtl.ipcw</span>(pbc3<span class="sc">$</span>days<span class="sc">/</span><span class="fl">365.25</span>,pbc3<span class="sc">$</span>status,<span class="at">eoi=</span><span class="dv">2</span>,<span class="at">tau=</span><span class="dv">3</span>,<span class="at">cov=</span>pbc3<span class="sc">$</span>tment)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        xint         xcov 
0.2438698018 0.0001853217 </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rmtl.ipcw</span>(pbc3<span class="sc">$</span>days<span class="sc">/</span><span class="fl">365.25</span>,pbc3<span class="sc">$</span>status,<span class="at">eoi=</span><span class="dv">1</span>,<span class="at">tau=</span><span class="dv">3</span>,<span class="at">cov=</span>pbc3<span class="sc">$</span>tment)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       xint        xcov 
 0.13827426 -0.04885493 </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>pbcny   <span class="ot">&lt;-</span> <span class="fu">subset</span>(pbc3,<span class="sc">!</span><span class="fu">is.na</span>(alb))</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>time    <span class="ot">&lt;-</span> pbcny<span class="sc">$</span>days<span class="sc">/</span><span class="fl">365.25</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>status  <span class="ot">&lt;-</span> pbcny<span class="sc">$</span>status</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>arm     <span class="ot">&lt;-</span> pbcny<span class="sc">$</span>tment</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>sex     <span class="ot">&lt;-</span> pbcny<span class="sc">$</span>sex</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>age     <span class="ot">&lt;-</span> pbcny<span class="sc">$</span>age</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>alb     <span class="ot">&lt;-</span> pbcny<span class="sc">$</span>alb</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>logbili <span class="ot">&lt;-</span> <span class="fu">log2</span>(pbcny<span class="sc">$</span>bili)</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">cbind</span>(arm, alb, logbili, sex, age)</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rmtl.ipcw</span>(time, status, <span class="at">eoi=</span><span class="dv">2</span>, <span class="at">tau=</span><span class="dv">3</span>, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       xint        xarm        xalb    xlogbili        xsex        xage 
-0.47710972 -0.08191763 -0.01872268  0.15948703  0.12945255  0.01324603 </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rmtl.ipcw</span>(time, status, <span class="at">eoi=</span><span class="dv">1</span>, <span class="at">tau=</span><span class="dv">3</span>, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        xint         xarm         xalb     xlogbili         xsex         xage 
 0.595880668 -0.066527285 -0.006567316  0.071836632  0.131691403 -0.010132691 </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(arm, alb, logbili)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rmtl.ipcw</span>(time, status, <span class="at">eoi=</span><span class="dv">2</span>, <span class="at">tau=</span><span class="dv">3</span>, x1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       xint        xarm        xalb    xlogbili 
 0.79996123 -0.07930867 -0.02829702  0.12396009 </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rmtl.ipcw</span>(time, status, <span class="at">eoi=</span><span class="dv">1</span>, <span class="at">tau=</span><span class="dv">3</span>, x1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        xint         xarm         xalb     xlogbili 
-0.201485168 -0.068452390 -0.002058876  0.091436591 </code></pre>
</div>
</div>
</section>
<section id="using-mets-package-3" class="level4">
<h4 class="anchored" data-anchor-id="using-mets-package-3">Using mets package</h4>
<p>However, does not give exactly same results as hard code</p>
<div class="cell" data-hash="Ch4_cache/html/table-4.6-r-mets_891e4fc119ad999c1694454c2eb213b2">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Death without transplantation</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="fu">resmeanIPCW</span>(<span class="fu">Event</span>(days<span class="sc">/</span><span class="fl">365.25</span>,status)<span class="sc">~</span><span class="fu">factor</span>(tment),<span class="at">cause=</span><span class="dv">2</span>,</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span>pbc3, <span class="at">time=</span><span class="dv">3</span>, <span class="at">model=</span><span class="st">"linear"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 349     47

 349 clusters
coeffients:
                Estimate   Std.Err      2.5%     97.5% P-value
(Intercept)     0.253900  0.053258  0.149517  0.358284  0.0000
factor(tment)1 -0.019753  0.073194 -0.163211  0.123704  0.7873

exp(coeffients):
               Estimate    2.5%  97.5%
(Intercept)     1.28904 1.16127 1.4309
factor(tment)1  0.98044 0.84941 1.1317</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">resmeanIPCW</span>(<span class="fu">Event</span>(days<span class="sc">/</span><span class="fl">365.25</span>,status)<span class="sc">~</span><span class="fu">factor</span>(tment)<span class="sc">+</span>alb<span class="sc">+</span>log2bili<span class="sc">+</span>sex<span class="sc">+</span>age,<span class="at">cause=</span><span class="dv">2</span>,</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span><span class="fu">subset</span>(pbc3,<span class="sc">!</span><span class="fu">is.na</span>(alb)), <span class="at">time=</span><span class="dv">3</span>, <span class="at">model=</span><span class="st">"linear"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 343     47

 343 clusters
coeffients:
                 Estimate    Std.Err       2.5%      97.5% P-value
(Intercept)    -0.7249855  0.4048719 -1.5185199  0.0685489  0.0733
factor(tment)1 -0.0804114  0.0668270 -0.2113898  0.0505670  0.2289
alb            -0.0151672  0.0063347 -0.0275830 -0.0027514  0.0167
log2bili        0.1729104  0.0323201  0.1095641  0.2362567  0.0000
sex             0.2071442  0.1068157 -0.0022107  0.4164990  0.0525
age             0.0141707  0.0030794  0.0081351  0.0202063  0.0000

exp(coeffients):
               Estimate    2.5%  97.5%
(Intercept)     0.48433 0.21904 1.0710
factor(tment)1  0.92274 0.80946 1.0519
alb             0.98495 0.97279 0.9973
log2bili        1.18876 1.11579 1.2665
sex             1.23016 0.99779 1.5166
age             1.01427 1.00817 1.0204</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">resmeanIPCW</span>(<span class="fu">Event</span>(days<span class="sc">/</span><span class="fl">365.25</span>,status)<span class="sc">~</span><span class="fu">factor</span>(tment)<span class="sc">+</span>alb<span class="sc">+</span>log2bili,<span class="at">cause=</span><span class="dv">2</span>,</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span><span class="fu">subset</span>(pbc3,<span class="sc">!</span><span class="fu">is.na</span>(alb)), <span class="at">time=</span><span class="dv">3</span>, <span class="at">model=</span><span class="st">"linear"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 343     47

 343 clusters
coeffients:
                 Estimate    Std.Err       2.5%      97.5% P-value
(Intercept)     0.4548449  0.3266548 -0.1853868  1.0950766  0.1638
factor(tment)1 -0.0888451  0.0688834 -0.2238542  0.0461640  0.1971
alb            -0.0215121  0.0066239 -0.0344947 -0.0085294  0.0012
log2bili        0.1439391  0.0323606  0.0805134  0.2073648  0.0000

exp(coeffients):
               Estimate    2.5%  97.5%
(Intercept)     1.57593 0.83078 2.9894
factor(tment)1  0.91499 0.79943 1.0472
alb             0.97872 0.96609 0.9915
log2bili        1.15481 1.08384 1.2304</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transplantation</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="fu">resmeanIPCW</span>(<span class="fu">Event</span>(days<span class="sc">/</span><span class="fl">365.25</span>,status)<span class="sc">~</span><span class="fu">factor</span>(tment),<span class="at">cause=</span><span class="dv">1</span>,</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span>pbc3, <span class="at">time=</span><span class="dv">3</span>, <span class="at">model=</span><span class="st">"lin"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 349     21

 349 clusters
coeffients:
                Estimate   Std.Err      2.5%     97.5% P-value
(Intercept)     0.143960  0.041249  0.063114  0.224806  0.0005
factor(tment)1 -0.058157  0.051128 -0.158365  0.042052  0.2553

exp(coeffients):
               Estimate    2.5%  97.5%
(Intercept)     1.15484 1.06515 1.2521
factor(tment)1  0.94350 0.85354 1.0429</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="fu">resmeanIPCW</span>(<span class="fu">Event</span>(days<span class="sc">/</span><span class="fl">365.25</span>,status)<span class="sc">~</span><span class="fu">factor</span>(tment)<span class="sc">+</span>alb<span class="sc">+</span>log2bili<span class="sc">+</span>sex<span class="sc">+</span>age,<span class="at">cause=</span><span class="dv">1</span>,</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span><span class="fu">subset</span>(pbc3,<span class="sc">!</span><span class="fu">is.na</span>(alb)), <span class="at">time=</span><span class="dv">3</span>, <span class="at">model=</span><span class="st">"lin"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 343     20

 343 clusters
coeffients:
                 Estimate    Std.Err       2.5%      97.5% P-value
(Intercept)     0.3224456  0.2826487 -0.2315356  0.8764268  0.2540
factor(tment)1 -0.0688959  0.0453965 -0.1578714  0.0200796  0.1291
alb            -0.0038059  0.0042657 -0.0121665  0.0045546  0.3723
log2bili        0.0868250  0.0236530  0.0404659  0.1331841  0.0002
sex             0.1010467  0.0785489 -0.0529064  0.2549998  0.1983
age            -0.0082742  0.0028017 -0.0137653 -0.0027831  0.0031

exp(coeffients):
               Estimate    2.5%  97.5%
(Intercept)     1.38050 0.79331 2.4023
factor(tment)1  0.93342 0.85396 1.0203
alb             0.99620 0.98791 1.0046
log2bili        1.09071 1.04130 1.1425
sex             1.10633 0.94847 1.2905
age             0.99176 0.98633 0.9972</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="fu">resmeanIPCW</span>(<span class="fu">Event</span>(days<span class="sc">/</span><span class="fl">365.25</span>,status)<span class="sc">~</span><span class="fu">factor</span>(tment)<span class="sc">+</span>alb<span class="sc">+</span>log2bili,<span class="at">cause=</span><span class="dv">1</span>,</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span><span class="fu">subset</span>(pbc3,<span class="sc">!</span><span class="fu">is.na</span>(alb)), <span class="at">time=</span><span class="dv">3</span>, <span class="at">model=</span><span class="st">"lin"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
   n events
 343     20

 343 clusters
coeffients:
                  Estimate     Std.Err        2.5%       97.5% P-value
(Intercept)    -0.29824097  0.21529398 -0.72020941  0.12372746  0.1660
factor(tment)1 -0.06453816  0.04593998 -0.15457888  0.02550255  0.1601
alb            -0.00067397  0.00410667 -0.00872290  0.00737496  0.8696
log2bili        0.10093806  0.02632894  0.04933429  0.15254183  0.0001

exp(coeffients):
               Estimate    2.5%  97.5%
(Intercept)     0.74212 0.48665 1.1317
factor(tment)1  0.93750 0.85678 1.0258
alb             0.99933 0.99132 1.0074
log2bili        1.10621 1.05057 1.1648</code></pre>
</div>
</div>
</section>
</div>
</div>
</div>
</section>
<section id="in-text-time-lost-g-formula-and-bootstrap" class="level3">
<h3 class="anchored" data-anchor-id="in-text-time-lost-g-formula-and-bootstrap">In-text: Time lost g-formula and bootstrap</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-21-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-21-1" role="tab" aria-controls="tabset-21-1" aria-selected="true">R</a></li></ul>
<div class="tab-content">
<div id="tabset-21-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-21-1-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-r-time-lost-gform_22c8322612e193ae66abeea67e7ac0c6">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(boot)</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Transplantation</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>boot.fun <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, index){</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>bdata <span class="ot">&lt;-</span> dat[index,]</span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>obj<span class="ot">&lt;-</span><span class="fu">rmtl.ipcw</span>(bdata<span class="sc">$</span>time,bdata<span class="sc">$</span>status,<span class="at">eoi=</span><span class="dv">1</span>,<span class="at">tau=</span><span class="dv">3</span>,<span class="fu">cbind</span>(bdata<span class="sc">$</span>arm,bdata<span class="sc">$</span>alb,bdata<span class="sc">$</span>logbili))</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>rmst0<span class="ot">&lt;-</span>obj[<span class="dv">1</span>]<span class="sc">+</span>obj[<span class="dv">2</span>]<span class="sc">*</span><span class="dv">0</span><span class="sc">+</span>obj[<span class="dv">3</span>]<span class="sc">*</span>bdata<span class="sc">$</span>alb<span class="sc">+</span>obj[<span class="dv">4</span>]<span class="sc">*</span>bdata<span class="sc">$</span>logbili</span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>rmst1<span class="ot">&lt;-</span>obj[<span class="dv">1</span>]<span class="sc">+</span>obj[<span class="dv">2</span>]<span class="sc">*</span><span class="dv">1</span><span class="sc">+</span>obj[<span class="dv">3</span>]<span class="sc">*</span>bdata<span class="sc">$</span>alb<span class="sc">+</span>obj[<span class="dv">4</span>]<span class="sc">*</span>bdata<span class="sc">$</span>logbili</span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>diff<span class="ot">&lt;-</span>rmst1<span class="sc">-</span>rmst0</span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>res<span class="ot">&lt;-</span><span class="fu">cbind</span>(<span class="fu">mean</span>(rmst0),<span class="fu">mean</span>(rmst1),<span class="fu">mean</span>(diff))</span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(res)</span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>B<span class="ot">&lt;-</span><span class="dv">200</span> </span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>trydata<span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(time,status,x1))</span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>bootres <span class="ot">&lt;-</span> <span class="fu">boot</span>(trydata, boot.fun, <span class="at">R =</span> B)</span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a><span class="co"># mean and SD</span></span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Transplantation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Transplantation"</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">Placebo=</span><span class="fu">mean</span>(bootres<span class="sc">$</span>t[,<span class="dv">1</span>]),</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">CyA=</span><span class="fu">mean</span>(bootres<span class="sc">$</span>t[,<span class="dv">2</span>]),</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">Diff=</span><span class="fu">mean</span>(bootres<span class="sc">$</span>t[,<span class="dv">3</span>])),</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">Placebo=</span><span class="fu">sqrt</span>(<span class="fu">var</span>(bootres<span class="sc">$</span>t[,<span class="dv">1</span>])),</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">CyA=</span><span class="fu">sqrt</span>(<span class="fu">var</span>(bootres<span class="sc">$</span>t[,<span class="dv">2</span>])),</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">Diff=</span><span class="fu">sqrt</span>(<span class="fu">var</span>(bootres<span class="sc">$</span>t[,<span class="dv">3</span>])))</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        Placebo        CyA        Diff
[1,] 0.14211202 0.07317405 -0.06893798
[2,] 0.04101209 0.02876443  0.04993619</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Death without transplantation</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>boot.fun <span class="ot">&lt;-</span> <span class="cf">function</span>(dat, index){</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>bdata <span class="ot">&lt;-</span> dat[index,]</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>obj<span class="ot">&lt;-</span><span class="fu">rmtl.ipcw</span>(bdata<span class="sc">$</span>time,bdata<span class="sc">$</span>status,<span class="at">eoi=</span><span class="dv">2</span>,<span class="at">tau=</span><span class="dv">3</span>,<span class="fu">cbind</span>(bdata<span class="sc">$</span>arm,bdata<span class="sc">$</span>alb,bdata<span class="sc">$</span>logbili))</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>rmst0<span class="ot">&lt;-</span>obj[<span class="dv">1</span>]<span class="sc">+</span>obj[<span class="dv">2</span>]<span class="sc">*</span><span class="dv">0</span><span class="sc">+</span>obj[<span class="dv">3</span>]<span class="sc">*</span>bdata<span class="sc">$</span>alb<span class="sc">+</span>obj[<span class="dv">4</span>]<span class="sc">*</span>bdata<span class="sc">$</span>logbili</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>rmst1<span class="ot">&lt;-</span>obj[<span class="dv">1</span>]<span class="sc">+</span>obj[<span class="dv">2</span>]<span class="sc">*</span><span class="dv">1</span><span class="sc">+</span>obj[<span class="dv">3</span>]<span class="sc">*</span>bdata<span class="sc">$</span>alb<span class="sc">+</span>obj[<span class="dv">4</span>]<span class="sc">*</span>bdata<span class="sc">$</span>logbili</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>diff<span class="ot">&lt;-</span>rmst1<span class="sc">-</span>rmst0</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>res<span class="ot">&lt;-</span><span class="fu">cbind</span>(<span class="fu">mean</span>(rmst0),<span class="fu">mean</span>(rmst1),<span class="fu">mean</span>(diff))</span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(res)</span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>trydata<span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(time,status,x1))</span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>bootres <span class="ot">&lt;-</span> <span class="fu">boot</span>(trydata, boot.fun, <span class="at">R =</span> B)</span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a><span class="co"># mean and SD</span></span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Death without transplantation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Death without transplantation"</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">Placebo=</span><span class="fu">mean</span>(bootres<span class="sc">$</span>t[,<span class="dv">1</span>]),</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">CyA=</span><span class="fu">mean</span>(bootres<span class="sc">$</span>t[,<span class="dv">2</span>]),</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">Diff=</span><span class="fu">mean</span>(bootres<span class="sc">$</span>t[,<span class="dv">3</span>])),</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(<span class="at">Placebo=</span><span class="fu">sqrt</span>(<span class="fu">var</span>(bootres<span class="sc">$</span>t[,<span class="dv">1</span>])),</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">CyA=</span><span class="fu">sqrt</span>(<span class="fu">var</span>(bootres<span class="sc">$</span>t[,<span class="dv">2</span>])),</span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">Diff=</span><span class="fu">sqrt</span>(<span class="fu">var</span>(bootres<span class="sc">$</span>t[,<span class="dv">3</span>])))</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        Placebo        CyA        Diff
[1,] 0.28945212 0.21368521 -0.07576691
[2,] 0.05330835 0.05003825  0.07054484</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.21" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.21">Figure 4.21</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-22-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-22-1" role="tab" aria-controls="tabset-22-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-22-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-22-2" role="tab" aria-controls="tabset-22-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-22-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-22-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.21-r_b92442848e5f873762f18b4c04ea3831">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall survival </span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>overall_surv <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(days, status <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> pbc3)</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Censoring</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>cens_surv <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> pbc3)</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Make data ready for plotting </span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>pdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">c</span>(overall_surv<span class="sc">$</span>time, cens_surv<span class="sc">$</span>time), </span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">surv =</span> <span class="fu">c</span>(overall_surv<span class="sc">$</span>surv, cens_surv<span class="sc">$</span>surv), </span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">type =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Treatment failure"</span>, <span class="fu">length</span>(overall_surv<span class="sc">$</span>time)), </span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">rep</span>(<span class="st">"Censoring"</span>, <span class="fu">length</span>(overall_surv<span class="sc">$</span>time))))</span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure</span></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.21</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> surv, <span class="at">linetype =</span> type), </span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> pdata) <span class="sc">+</span> </span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="st">"Type"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dashed"</span>, <span class="st">"solid"</span>)) <span class="sc">+</span> </span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Probability'</span>) <span class="sc">+</span> </span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>), </span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.05</span>)), </span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>), </span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>))</span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-30"><a href="#cb152-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-31"><a href="#cb152-31" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.21</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.21-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-22-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-22-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.21-sas_7062b4fb5658ffa84bccd7535cd22909">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3 atrisk noprint;</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> followup*status(<span class="dv">1</span> <span class="dv">2</span>)=;</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>    baseline out=survcens survival=kmc / method=pl;</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3 atrisk noprint;</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> followup*status(<span class="dv">0</span>)=;</span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>    baseline out=survdat survival=kms / method=pl;</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plotsurv; </span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">merge</span> survcens survdat; </span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> followup;</span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plotfin; <span class="kw">set</span> plotsurv;</span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> followup;</span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> lastc lasts;</span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> kmc=. <span class="kw">then do</span> c=lastc; s=kms<span class="kw">; end</span>; </span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> kms=. <span class="kw">then do</span> s=lasts; c=kmc<span class="kw">; end</span>;</span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> kmc ne . <span class="kw">and</span> kms ne . <span class="kw">then do</span>; c=kmc; s=kms<span class="kw">; end</span>;</span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output</span>;</span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>    lastc=c; lasts=s;</span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=plotfin;</span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>    plot c*followup s*followup/haxis=axis1 vaxis=axis2 overlay;</span>
<span id="cb153-24"><a href="#cb153-24" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb153-25"><a href="#cb153-25" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none</span>
<span id="cb153-26"><a href="#cb153-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'"Survival" probability'</span>);</span>
<span id="cb153-27"><a href="#cb153-27" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb153-28"><a href="#cb153-28" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb153-29"><a href="#cb153-29" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb153-30"><a href="#cb153-30" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="in-text-cox-for-censoring" class="level3">
<h3 class="anchored" data-anchor-id="in-text-cox-for-censoring">In-text: Cox for censoring</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-23-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-23-1" role="tab" aria-controls="tabset-23-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-23-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-23-2" role="tab" aria-controls="tabset-23-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-23-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-23-1-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-cox-cens-r_d9549a5e19ff59ea1f0f89872897759e">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">~</span> tment, <span class="at">data =</span> pbc3, <span class="at">method =</span> <span class="st">"breslow"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(days, status == 0) ~ tment, data = pbc3, 
    method = "breslow")

  n= 349, number of events= 259 

         coef exp(coef) se(coef)     z Pr(&gt;|z|)
tment 0.08402   1.08765  0.12550 0.669    0.503

      exp(coef) exp(-coef) lower .95 upper .95
tment     1.088     0.9194    0.8505     1.391

Concordance= 0.507  (se = 0.018 )
Likelihood ratio test= 0.45  on 1 df,   p=0.5
Wald test            = 0.45  on 1 df,   p=0.5
Score (logrank) test = 0.45  on 1 df,   p=0.5</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">~</span> alb, <span class="at">data =</span> pbc3, <span class="at">method =</span> <span class="st">"breslow"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(days, status == 0) ~ alb, data = pbc3, method = "breslow")

  n= 343, number of events= 255 
   (6 observations deleted due to missingness)

        coef exp(coef) se(coef)     z Pr(&gt;|z|)
alb 0.001017  1.001017 0.012818 0.079    0.937

    exp(coef) exp(-coef) lower .95 upper .95
alb     1.001      0.999    0.9762     1.026

Concordance= 0.496  (se = 0.021 )
Likelihood ratio test= 0.01  on 1 df,   p=0.9
Wald test            = 0.01  on 1 df,   p=0.9
Score (logrank) test = 0.01  on 1 df,   p=0.9</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">~</span> bili, <span class="at">data =</span> pbc3, <span class="at">method =</span> <span class="st">"breslow"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(days, status == 0) ~ bili, data = pbc3, 
    method = "breslow")

  n= 349, number of events= 259 

          coef exp(coef)  se(coef)      z Pr(&gt;|z|)
bili -0.002524  0.997479  0.001817 -1.389    0.165

     exp(coef) exp(-coef) lower .95 upper .95
bili    0.9975      1.003    0.9939     1.001

Concordance= 0.49  (se = 0.021 )
Likelihood ratio test= 2.18  on 1 df,   p=0.1
Wald test            = 1.93  on 1 df,   p=0.2
Score (logrank) test = 1.93  on 1 df,   p=0.2</code></pre>
</div>
</div>
</div>
<div id="tabset-23-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-23-2-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-cox-cens-sas_9f109741495df062ddf265eda4fa005f">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>    class tment (ref=<span class="st">'0'</span>);</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> followup*status(<span class="dv">1</span> <span class="dv">2</span>)=tment/rl;</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> followup*status(<span class="dv">1</span> <span class="dv">2</span>)=alb/rl;</span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=pbc3;</span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> followup*status(<span class="dv">1</span> <span class="dv">2</span>)=bili/rl;</span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="prova-trial-in-liver-cirrhosis" class="level2">
<h2 class="anchored" data-anchor-id="prova-trial-in-liver-cirrhosis">PROVA trial in liver cirrhosis</h2>
<section id="read-data-1" class="level3">
<h3 class="anchored" data-anchor-id="read-data-1">Read data</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-24-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-24-1" role="tab" aria-controls="tabset-24-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-24-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-24-2" role="tab" aria-controls="tabset-24-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-24-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-24-1-tab">
<div class="cell" data-hash="Ch4_cache/html/read-prova-r_313c612d5f5ff3c2f6854bf10e4e90ca">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>prova <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/prova.csv"</span>, <span class="at">na.strings =</span> <span class="fu">c</span>(<span class="st">"."</span>))</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Treatment 2x2 factorial</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>prova<span class="sc">$</span>beh <span class="ot">&lt;-</span> <span class="fu">with</span>(prova, <span class="fu">as.factor</span>(scle <span class="sc">+</span> beta<span class="sc">*</span><span class="dv">2</span>))</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extra variables</span></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>provany <span class="ot">&lt;-</span> prova</span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>provany<span class="sc">$</span>log2bili <span class="ot">&lt;-</span> <span class="fu">with</span>(provany, <span class="fu">log2</span>(bili))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-24-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-24-2-tab">
<div class="cell" data-hash="Ch4_cache/html/read-prova-sas_5578e6c6ac458765439ac6d20aad79fb">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> import out=prova</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>    datafile=<span class="st">"data/prova.csv"</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>    dbms=csv <span class="kw">replace</span>;</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cens;</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> prova;</span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> timebleed=. <span class="kw">then</span> <span class="fu">time</span>=timedeath;</span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="fu">time</span>= timebleed + timedeath;</span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>    beh = scle + beta*<span class="dv">2</span>; </span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>    log2bili = <span class="fu">log2</span>(bili);</span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.22" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.22">Figure 4.22</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-25-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-25-1" role="tab" aria-controls="tabset-25-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-25-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-25-2" role="tab" aria-controls="tabset-25-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-25-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-25-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.22-r_30faa4d76e0c55bcc4d3941f5cc14642">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>))</span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Make KM estimate of censoring distribution</span></span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>provany<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="fu">with</span>(provany, <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(timebleed), timebleed <span class="sc">+</span> timedeath, timedeath))</span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a>censdist <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, death <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> provany)</span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a>censdist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(time, death == 0) ~ 1, data = provany)

       n events median 0.95LCL 0.95UCL
[1,] 286    211    905     796    1082</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make data ready for plotting</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>pdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> censdist<span class="sc">$</span>time,</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">surv =</span> censdist<span class="sc">$</span>surv)</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure</span></span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.22</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="fl">365.25</span>, <span class="at">y =</span> surv),</span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> pdata) <span class="sc">+</span></span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span></span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Probability of no censoring'</span>) <span class="sc">+</span></span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.005</span>)),</span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">7</span>),</span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">7</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.005</span>)),</span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span></span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>))</span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-22"><a href="#cb165-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-23"><a href="#cb165-23" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.22</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.22-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-25-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-25-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.22-sas_e9219ebafb72ca08d8ded5eb9dd185f6">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=cens atrisk noprint;</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*death(<span class="dv">1</span>)=;</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>    baseline out=survcens survival=kmc / method=pl;</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> survcens; </span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> survcens; </span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>    timey = <span class="fu">time</span>/<span class="dv">365.25</span>; </span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=survcens;</span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>    plot kmc*timey/haxis=axis1 vaxis=axis2;</span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">1</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Probability of no censoring'</span>);</span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=black;</span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-4.12" class="level3">
<h3 class="anchored" data-anchor-id="table-4.12">Table 4.12</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-26-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-26-1" role="tab" aria-controls="tabset-26-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-26-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-26-2" role="tab" aria-controls="tabset-26-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-26-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-26-1-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.12-r_d749dcdf74f99b4bd33b306bfd7ffe23">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">contrasts=</span><span class="fu">c</span>(<span class="st">"contr.treatment"</span>, <span class="st">"contr.poly"</span>))</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a><span class="co"># treat</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(time, death <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">~</span> beh, <span class="at">data =</span> provany)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, death == 0) ~ beh, data = provany)

         coef exp(coef) se(coef)      z     p
beh1  0.03074   1.03122  0.19080  0.161 0.872
beh2 -0.04113   0.95970  0.18910 -0.218 0.828
beh3  0.04131   1.04218  0.20386  0.203 0.839

Likelihood ratio test=0.22  on 3 df, p=0.9751
n= 286, number of events= 211 </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># size </span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(time, death <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="fu">factor</span>(varsize), <span class="at">data =</span> provany)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, death == 0) ~ factor(varsize), data = provany)

                    coef exp(coef) se(coef)      z      p
factor(varsize)2 -0.2324    0.7926   0.1465 -1.586 0.1127
factor(varsize)3 -0.4386    0.6449   0.2327 -1.885 0.0594

Likelihood ratio test=4.77  on 2 df, p=0.0922
n= 286, number of events= 211 </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sex</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(time, death <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">~</span> sex, <span class="at">data =</span> provany)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, death == 0) ~ sex, data = provany)

       coef exp(coef) se(coef)    z     p
sex 0.07847   1.08163  0.14542 0.54 0.589

Likelihood ratio test=0.29  on 1 df, p=0.588
n= 286, number of events= 211 </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co"># coag</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(time, death <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">~</span> coag, <span class="at">data =</span> provany)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, death == 0) ~ coag, data = provany)

          coef exp(coef)  se(coef)      z     p
coag -0.002827  0.997177  0.002635 -1.073 0.283

Likelihood ratio test=1.18  on 1 df, p=0.2775
n= 272, number of events= 199 
   (14 observations deleted due to missingness)</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># bili</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(time, death <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">~</span> log2bili, <span class="at">data =</span> provany)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, death == 0) ~ log2bili, data = provany)

            coef exp(coef) se(coef)     z    p
log2bili 0.07575   1.07870  0.05649 1.341 0.18

Likelihood ratio test=1.77  on 1 df, p=0.1834
n= 275, number of events= 202 
   (11 observations deleted due to missingness)</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co"># age</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(time, death <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">~</span> age, <span class="at">data =</span> provany)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, death == 0) ~ age, data = provany)

         coef exp(coef)  se(coef)      z       p
age -0.017105  0.983040  0.005777 -2.961 0.00307

Likelihood ratio test=8.67  on 1 df, p=0.003242
n= 286, number of events= 211 </code></pre>
</div>
</div>
</div>
<div id="tabset-26-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-26-2-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.12-sas_b218584b82b847dab98d47c56c802af7">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=cens;</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>    class beh (ref=<span class="st">'0'</span>);</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*death(<span class="dv">1</span>)=beh;</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=cens;</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>    class varsize (ref=<span class="st">'1'</span>);</span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*death(<span class="dv">1</span>)=varsize;</span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=cens;</span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>    class sex (ref=<span class="st">'1'</span>);</span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*death(<span class="dv">1</span>)=sex;</span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=cens;</span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*death(<span class="dv">1</span>)=coag;</span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=cens;</span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*death(<span class="dv">1</span>)=log2bili;</span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb179-19"><a href="#cb179-19" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=cens;</span>
<span id="cb179-20"><a href="#cb179-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*death(<span class="dv">1</span>)=age;</span>
<span id="cb179-21"><a href="#cb179-21" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="recurrent-episodes-in-affective-disorders" class="level2">
<h2 class="anchored" data-anchor-id="recurrent-episodes-in-affective-disorders">Recurrent episodes in affective disorders</h2>
<section id="read-data-2" class="level3">
<h3 class="anchored" data-anchor-id="read-data-2">Read data</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-27-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-27-1" role="tab" aria-controls="tabset-27-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-27-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-27-2" role="tab" aria-controls="tabset-27-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-27-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-27-1-tab">
<div class="cell" data-hash="Ch4_cache/html/read-affective_d514b6518fd669118ec60565288a72bb">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>affective <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/affective.csv"</span>)</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>affective<span class="sc">$</span>wait <span class="ot">&lt;-</span> <span class="fu">with</span>(affective, stop <span class="sc">-</span> start)</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>affectivewlw <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/affectivewlw.csv"</span>)</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-27-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-27-2-tab">
<div class="cell" data-hash="Ch4_cache/html/read-affective-sas_dfa2bdfb0290989a33a0e016653c4a84">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> import out=affective</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>    datafile=<span class="st">"data/affective.csv"</span></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>    dbms=csv <span class="kw">replace</span>;</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> affective; </span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> affective; </span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a>    wait = <span class="kw">stop</span> - start; </span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> angstprev; </span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> affective;</span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> id;</span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> prev;</span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> first.id <span class="kw">then</span> prev=<span class="dv">0</span>; </span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output</span>; </span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> state=<span class="dv">1</span> <span class="kw">then</span> prev=start; <span class="kw">if</span> state=<span class="dv">0</span> <span class="kw">then</span> prev=<span class="kw">stop</span>;</span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-4.3" class="level3">
<h3 class="anchored" data-anchor-id="table-4.3">Table 4.3</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-28-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-28-1" role="tab" aria-controls="tabset-28-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-28-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-28-2" role="tab" aria-controls="tabset-28-2" aria-selected="false">SAS - NA</a></li></ul>
<div class="tab-content">
<div id="tabset-28-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-28-1-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.3-r_520167e8d6172b7069b8d1642bc57623">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make dataset ready for mstate </span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="co"># From Out -&gt; In,   trans = 1</span></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="co"># From Out -&gt; Dead, trans = 2</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a><span class="co"># From In -&gt; Out,   trans = 3</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a><span class="co"># From In -&gt; Dead,  trans = 4</span></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a><span class="co"># + update status variable</span></span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a>affectivemstate__ <span class="ot">&lt;-</span> affective <span class="sc">%&gt;%</span> </span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">statusnew =</span> <span class="fu">ifelse</span>(status <span class="sc">==</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">trans =</span> <span class="fu">case_when</span>(state <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a>                           state <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">2</span>, </span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a>                           state <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a>                           state <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">4</span>, </span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a>                           state <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a>                           state <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> status <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">3</span>))</span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a><span class="co"># For each transition, we should have a censoring for the trans to the other state</span></span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a>affectivemstate_ <span class="ot">&lt;-</span> affectivemstate__ <span class="sc">%&gt;%</span> </span>
<span id="cb182-20"><a href="#cb182-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">statusnew =</span> <span class="dv">0</span>,</span>
<span id="cb182-21"><a href="#cb182-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">trans =</span> <span class="fu">case_when</span>(trans <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb182-22"><a href="#cb182-22" aria-hidden="true" tabindex="-1"></a>                           trans <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb182-23"><a href="#cb182-23" aria-hidden="true" tabindex="-1"></a>                           trans <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">4</span>, </span>
<span id="cb182-24"><a href="#cb182-24" aria-hidden="true" tabindex="-1"></a>                           trans <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="dv">3</span>))</span>
<span id="cb182-25"><a href="#cb182-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-26"><a href="#cb182-26" aria-hidden="true" tabindex="-1"></a>affectivemstate <span class="ot">&lt;-</span> <span class="fu">rbind</span>(affectivemstate__, affectivemstate_) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(id, start)</span>
<span id="cb182-27"><a href="#cb182-27" aria-hidden="true" tabindex="-1"></a>affectivemstate <span class="ot">&lt;-</span> affectivemstate <span class="sc">%&gt;%</span> </span>
<span id="cb182-28"><a href="#cb182-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">from =</span> <span class="fu">case_when</span>(trans <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb182-29"><a href="#cb182-29" aria-hidden="true" tabindex="-1"></a>                          trans <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb182-30"><a href="#cb182-30" aria-hidden="true" tabindex="-1"></a>                          trans <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">2</span>, </span>
<span id="cb182-31"><a href="#cb182-31" aria-hidden="true" tabindex="-1"></a>                          trans <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="dv">2</span>), </span>
<span id="cb182-32"><a href="#cb182-32" aria-hidden="true" tabindex="-1"></a>         <span class="at">to =</span> <span class="fu">case_when</span>(trans <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb182-33"><a href="#cb182-33" aria-hidden="true" tabindex="-1"></a>                        trans <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">3</span>, </span>
<span id="cb182-34"><a href="#cb182-34" aria-hidden="true" tabindex="-1"></a>                        trans <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb182-35"><a href="#cb182-35" aria-hidden="true" tabindex="-1"></a>                        trans <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="dv">3</span>),</span>
<span id="cb182-36"><a href="#cb182-36" aria-hidden="true" tabindex="-1"></a>         <span class="at">starty =</span> start<span class="sc">/</span><span class="dv">12</span>, </span>
<span id="cb182-37"><a href="#cb182-37" aria-hidden="true" tabindex="-1"></a>         <span class="at">stopy =</span> stop<span class="sc">/</span><span class="dv">12</span></span>
<span id="cb182-38"><a href="#cb182-38" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb182-39"><a href="#cb182-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-40"><a href="#cb182-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset data by disease</span></span>
<span id="cb182-41"><a href="#cb182-41" aria-hidden="true" tabindex="-1"></a>affective0 <span class="ot">&lt;-</span> <span class="fu">subset</span>(affectivemstate, bip <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb182-42"><a href="#cb182-42" aria-hidden="true" tabindex="-1"></a>affective1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(affectivemstate, bip <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb182-43"><a href="#cb182-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-44"><a href="#cb182-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Set-up transition matrix</span></span>
<span id="cb182-45"><a href="#cb182-45" aria-hidden="true" tabindex="-1"></a>tmat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb182-46"><a href="#cb182-46" aria-hidden="true" tabindex="-1"></a>tmat[<span class="dv">1</span>, <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>]    <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span></span>
<span id="cb182-47"><a href="#cb182-47" aria-hidden="true" tabindex="-1"></a>tmat[<span class="dv">2</span>, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)] <span class="ot">&lt;-</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">4</span></span>
<span id="cb182-48"><a href="#cb182-48" aria-hidden="true" tabindex="-1"></a>statenames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Out of hospital"</span>, <span class="st">"In hospital"</span>, <span class="st">"Dead"</span>)</span>
<span id="cb182-49"><a href="#cb182-49" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(tmat) <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">from =</span> statenames, <span class="at">to =</span> statenames)</span>
<span id="cb182-50"><a href="#cb182-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-51"><a href="#cb182-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mstate)</span>
<span id="cb182-52"><a href="#cb182-52" aria-hidden="true" tabindex="-1"></a><span class="do">## For unipolar (bip = 0) ----------------------------------- ##</span></span>
<span id="cb182-53"><a href="#cb182-53" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(affective0, <span class="st">'class'</span>) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"msdata"</span>,<span class="st">"data.frame"</span>)</span>
<span id="cb182-54"><a href="#cb182-54" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(affective0, <span class="st">'trans'</span>) <span class="ot">&lt;-</span> tmat</span>
<span id="cb182-55"><a href="#cb182-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit empty cox model per trans</span></span>
<span id="cb182-56"><a href="#cb182-56" aria-hidden="true" tabindex="-1"></a>c0 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(starty, stopy, statusnew) <span class="sc">~</span> <span class="fu">strata</span>(trans), <span class="at">data =</span> affective0)</span>
<span id="cb182-57"><a href="#cb182-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a mstate object</span></span>
<span id="cb182-58"><a href="#cb182-58" aria-hidden="true" tabindex="-1"></a>msf0 <span class="ot">&lt;-</span> <span class="fu">msfit</span>(<span class="at">object=</span>c0, <span class="at">trans=</span>tmat)</span>
<span id="cb182-59"><a href="#cb182-59" aria-hidden="true" tabindex="-1"></a>pt0  <span class="ot">&lt;-</span> <span class="fu">probtrans</span>(msf0, <span class="at">predt=</span><span class="dv">0</span>)</span>
<span id="cb182-60"><a href="#cb182-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-61"><a href="#cb182-61" aria-hidden="true" tabindex="-1"></a><span class="do">## For bipolar (bip = 1) ----------------------------------- ##</span></span>
<span id="cb182-62"><a href="#cb182-62" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(affective1, <span class="st">'class'</span>) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"msdata"</span>,<span class="st">"data.frame"</span>)</span>
<span id="cb182-63"><a href="#cb182-63" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(affective1, <span class="st">'trans'</span>) <span class="ot">&lt;-</span> tmat</span>
<span id="cb182-64"><a href="#cb182-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit empty cox model per trans</span></span>
<span id="cb182-65"><a href="#cb182-65" aria-hidden="true" tabindex="-1"></a>c1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(starty, stopy, statusnew) <span class="sc">~</span> <span class="fu">strata</span>(trans), <span class="at">data =</span> affective1)</span>
<span id="cb182-66"><a href="#cb182-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a mstate object</span></span>
<span id="cb182-67"><a href="#cb182-67" aria-hidden="true" tabindex="-1"></a>msf1 <span class="ot">&lt;-</span> <span class="fu">msfit</span>(<span class="at">object=</span>c1, <span class="at">trans=</span>tmat)</span>
<span id="cb182-68"><a href="#cb182-68" aria-hidden="true" tabindex="-1"></a>pt1 <span class="ot">&lt;-</span> <span class="fu">probtrans</span>(msf1, <span class="at">predt=</span><span class="dv">0</span>)</span>
<span id="cb182-69"><a href="#cb182-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-70"><a href="#cb182-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-71"><a href="#cb182-71" aria-hidden="true" tabindex="-1"></a>regcoefvec <span class="ot">&lt;-</span> <span class="cf">function</span>(data, tmat, tau) {</span>
<span id="cb182-72"><a href="#cb182-72" aria-hidden="true" tabindex="-1"></a>  cx <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(starty, stopy, statusnew) <span class="sc">~</span> <span class="fu">strata</span>(trans), <span class="at">data=</span>data)</span>
<span id="cb182-73"><a href="#cb182-73" aria-hidden="true" tabindex="-1"></a>  msf0 <span class="ot">&lt;-</span> <span class="fu">msfit</span>(<span class="at">object =</span> cx, <span class="at">trans =</span> tmat)</span>
<span id="cb182-74"><a href="#cb182-74" aria-hidden="true" tabindex="-1"></a>  pt0 <span class="ot">&lt;-</span> <span class="fu">probtrans</span>(msf0, <span class="at">predt=</span><span class="dv">0</span>)</span>
<span id="cb182-75"><a href="#cb182-75" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> <span class="fu">ELOS</span>(pt0, <span class="at">tau=</span>tau)</span>
<span id="cb182-76"><a href="#cb182-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(mat[<span class="dv">2</span>,])</span>
<span id="cb182-77"><a href="#cb182-77" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb182-78"><a href="#cb182-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-79"><a href="#cb182-79" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb182-80"><a href="#cb182-80" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">msboot</span>(<span class="at">theta=</span>regcoefvec, <span class="at">data=</span>affective0, <span class="at">B=</span><span class="dv">100</span>, <span class="at">id=</span><span class="st">"id"</span>, <span class="at">tmat=</span>tmat, <span class="at">tau=</span><span class="dv">15</span>)</span>
<span id="cb182-81"><a href="#cb182-81" aria-hidden="true" tabindex="-1"></a>uniest<span class="ot">&lt;-</span><span class="fu">regcoefvec</span>(affective0, tmat, <span class="dv">15</span>)</span>
<span id="cb182-82"><a href="#cb182-82" aria-hidden="true" tabindex="-1"></a>uniboots<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fu">mean</span>(res[<span class="dv">1</span>,]),<span class="fu">sqrt</span>(<span class="fu">var</span>(res[<span class="dv">1</span>,])),</span>
<span id="cb182-83"><a href="#cb182-83" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mean</span>(res[<span class="dv">2</span>,]),<span class="fu">sqrt</span>(<span class="fu">var</span>(res[<span class="dv">2</span>,])),</span>
<span id="cb182-84"><a href="#cb182-84" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mean</span>(res[<span class="dv">3</span>,]),<span class="fu">sqrt</span>(<span class="fu">var</span>(res[<span class="dv">3</span>,]))),</span>
<span id="cb182-85"><a href="#cb182-85" aria-hidden="true" tabindex="-1"></a>       <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"Out of hosp"</span>,<span class="st">"In hosp"</span>,<span class="st">"Dead"</span>), <span class="fu">c</span>(<span class="st">"Years"</span>,<span class="st">"SD"</span>)))</span>
<span id="cb182-86"><a href="#cb182-86" aria-hidden="true" tabindex="-1"></a>uni<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="st">"estimate"</span><span class="ot">=</span>uniest,<span class="st">"bootstrap"</span><span class="ot">=</span>uniboots)</span>
<span id="cb182-87"><a href="#cb182-87" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb182-88"><a href="#cb182-88" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">msboot</span>(<span class="at">theta=</span>regcoefvec, <span class="at">data=</span>affective1, <span class="at">B=</span><span class="dv">100</span>, <span class="at">id=</span><span class="st">"id"</span>, <span class="at">tmat=</span>tmat, <span class="at">tau=</span><span class="dv">15</span>)</span>
<span id="cb182-89"><a href="#cb182-89" aria-hidden="true" tabindex="-1"></a>biest<span class="ot">&lt;-</span><span class="fu">regcoefvec</span>(affective0, tmat, <span class="dv">15</span>)</span>
<span id="cb182-90"><a href="#cb182-90" aria-hidden="true" tabindex="-1"></a>biboots<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fu">mean</span>(res[<span class="dv">1</span>,]),<span class="fu">sqrt</span>(<span class="fu">var</span>(res[<span class="dv">1</span>,])),</span>
<span id="cb182-91"><a href="#cb182-91" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mean</span>(res[<span class="dv">2</span>,]),<span class="fu">sqrt</span>(<span class="fu">var</span>(res[<span class="dv">2</span>,])),</span>
<span id="cb182-92"><a href="#cb182-92" aria-hidden="true" tabindex="-1"></a>         <span class="fu">mean</span>(res[<span class="dv">3</span>,]),<span class="fu">sqrt</span>(<span class="fu">var</span>(res[<span class="dv">3</span>,]))),</span>
<span id="cb182-93"><a href="#cb182-93" aria-hidden="true" tabindex="-1"></a>       <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">"Out of hosp"</span>,<span class="st">"In hosp"</span>,<span class="st">"Dead"</span>), <span class="fu">c</span>(<span class="st">"Years"</span>,<span class="st">"SD"</span>)))</span>
<span id="cb182-94"><a href="#cb182-94" aria-hidden="true" tabindex="-1"></a>bi<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="st">"estimate"</span><span class="ot">=</span>biest,<span class="st">"bootstrap"</span><span class="ot">=</span>biboots)</span>
<span id="cb182-95"><a href="#cb182-95" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="st">"Unipolar"</span><span class="ot">=</span>uni,<span class="st">"Bipolar"</span><span class="ot">=</span>bi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$Unipolar
$Unipolar$estimate
     in1      in2      in3 
9.589138 2.202036 3.208826 

$Unipolar$bootstrap
                Years        SD
Out of hosp 9.6888785 0.2515182
In hosp     0.4962329 3.1828301
Dead        2.1282913 0.4881871


$Bipolar
$Bipolar$estimate
     in1      in2      in3 
9.589138 2.202036 3.208826 

$Bipolar$bootstrap
                 Years        SD
Out of hosp 12.6037941 0.3523277
In hosp      0.7299104 0.8614208
Dead         1.5347851 0.5616117</code></pre>
</div>
</div>
</div>
<div id="tabset-28-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-28-2-tab">

</div>
</div>
</div>
</section>
<section id="figure-4.16" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.16">Figure 4.16</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-29-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-29-1" role="tab" aria-controls="tabset-29-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-29-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-29-2" role="tab" aria-controls="tabset-29-2" aria-selected="false">SAS - NA</a></li></ul>
<div class="tab-content">
<div id="tabset-29-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-29-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.16-r_770f9d9e7c26b6d199d6a3300dba3440">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, </span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) </span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Make data set with probabilities - predictions from state 2 (in hospital)</span></span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a><span class="co"># bip = 0 </span></span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a>t0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> pt0[[<span class="dv">2</span>]]<span class="sc">$</span>time, </span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">pstate1 =</span> pt0[[<span class="dv">2</span>]]<span class="sc">$</span>pstate1, </span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">pstate2 =</span> pt0[[<span class="dv">2</span>]]<span class="sc">$</span>pstate2, </span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">pstate3 =</span> pt0[[<span class="dv">2</span>]]<span class="sc">$</span>pstate3, </span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">bip =</span> <span class="fu">rep</span>(<span class="st">"No"</span>, <span class="fu">nrow</span>(pt0[[<span class="dv">2</span>]]))</span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a><span class="co"># bip = 1</span></span>
<span id="cb184-19"><a href="#cb184-19" aria-hidden="true" tabindex="-1"></a>t1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb184-20"><a href="#cb184-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> pt1[[<span class="dv">2</span>]]<span class="sc">$</span>time, </span>
<span id="cb184-21"><a href="#cb184-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">pstate1 =</span> pt1[[<span class="dv">2</span>]]<span class="sc">$</span>pstate1, </span>
<span id="cb184-22"><a href="#cb184-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">pstate2 =</span> pt1[[<span class="dv">2</span>]]<span class="sc">$</span>pstate2, </span>
<span id="cb184-23"><a href="#cb184-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">pstate3 =</span> pt1[[<span class="dv">2</span>]]<span class="sc">$</span>pstate3, </span>
<span id="cb184-24"><a href="#cb184-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">bip =</span> <span class="fu">rep</span>(<span class="st">"Yes"</span>, <span class="fu">nrow</span>(pt1[[<span class="dv">2</span>]]))</span>
<span id="cb184-25"><a href="#cb184-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb184-26"><a href="#cb184-26" aria-hidden="true" tabindex="-1"></a>pstate1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb184-27"><a href="#cb184-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="fu">rep</span>(<span class="st">"Out of hospital"</span>, <span class="fu">nrow</span>(pt0[[<span class="dv">2</span>]]) <span class="sc">+</span> <span class="fu">nrow</span>(pt1[[<span class="dv">2</span>]])), </span>
<span id="cb184-28"><a href="#cb184-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">bip =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"No"</span>, <span class="fu">nrow</span>(pt0[[<span class="dv">2</span>]])), <span class="fu">rep</span>(<span class="st">"Yes"</span>, <span class="fu">nrow</span>(pt1[[<span class="dv">2</span>]]))),</span>
<span id="cb184-29"><a href="#cb184-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">pstate =</span> <span class="fu">c</span>(pt0[[<span class="dv">2</span>]]<span class="sc">$</span>pstate1, pt1[[<span class="dv">2</span>]]<span class="sc">$</span>pstate1), </span>
<span id="cb184-30"><a href="#cb184-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">c</span>(pt0[[<span class="dv">2</span>]]<span class="sc">$</span>time, pt1[[<span class="dv">2</span>]]<span class="sc">$</span>time))</span>
<span id="cb184-31"><a href="#cb184-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-32"><a href="#cb184-32" aria-hidden="true" tabindex="-1"></a>pstate2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb184-33"><a href="#cb184-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="fu">rep</span>(<span class="st">"In hospital"</span>, <span class="fu">nrow</span>(pt0[[<span class="dv">2</span>]]) <span class="sc">+</span> <span class="fu">nrow</span>(pt1[[<span class="dv">2</span>]])), </span>
<span id="cb184-34"><a href="#cb184-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">bip =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"No"</span>, <span class="fu">nrow</span>(pt0[[<span class="dv">2</span>]])), <span class="fu">rep</span>(<span class="st">"Yes"</span>, <span class="fu">nrow</span>(pt1[[<span class="dv">2</span>]]))),</span>
<span id="cb184-35"><a href="#cb184-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">pstate =</span> <span class="fu">c</span>(pt0[[<span class="dv">2</span>]]<span class="sc">$</span>pstate2, pt1[[<span class="dv">2</span>]]<span class="sc">$</span>pstate2), </span>
<span id="cb184-36"><a href="#cb184-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">c</span>(pt0[[<span class="dv">2</span>]]<span class="sc">$</span>time, pt1[[<span class="dv">2</span>]]<span class="sc">$</span>time))</span>
<span id="cb184-37"><a href="#cb184-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-38"><a href="#cb184-38" aria-hidden="true" tabindex="-1"></a>pstate3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb184-39"><a href="#cb184-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="fu">rep</span>(<span class="st">"Dead"</span>, <span class="fu">nrow</span>(pt0[[<span class="dv">2</span>]]) <span class="sc">+</span> <span class="fu">nrow</span>(pt1[[<span class="dv">2</span>]])),</span>
<span id="cb184-40"><a href="#cb184-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">bip =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"No"</span>, <span class="fu">nrow</span>(pt0[[<span class="dv">2</span>]])), <span class="fu">rep</span>(<span class="st">"Yes"</span>, <span class="fu">nrow</span>(pt1[[<span class="dv">2</span>]]))),</span>
<span id="cb184-41"><a href="#cb184-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">pstate =</span> <span class="fu">c</span>(pt0[[<span class="dv">2</span>]]<span class="sc">$</span>pstate3, pt1[[<span class="dv">2</span>]]<span class="sc">$</span>pstate3), </span>
<span id="cb184-42"><a href="#cb184-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">c</span>(pt0[[<span class="dv">2</span>]]<span class="sc">$</span>time, pt1[[<span class="dv">2</span>]]<span class="sc">$</span>time))</span>
<span id="cb184-43"><a href="#cb184-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-44"><a href="#cb184-44" aria-hidden="true" tabindex="-1"></a>probs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pstate1, pstate2, pstate3)</span>
<span id="cb184-45"><a href="#cb184-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-46"><a href="#cb184-46" aria-hidden="true" tabindex="-1"></a><span class="co"># A couple of places, a very small negative probability is predicted</span></span>
<span id="cb184-47"><a href="#cb184-47" aria-hidden="true" tabindex="-1"></a><span class="co"># We fix it + sum here</span></span>
<span id="cb184-48"><a href="#cb184-48" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> probs[probs<span class="sc">$</span>pstate <span class="sc">&lt;</span><span class="dv">0</span>,]<span class="sc">$</span>time <span class="co">#&lt;-0</span></span>
<span id="cb184-49"><a href="#cb184-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-50"><a href="#cb184-50" aria-hidden="true" tabindex="-1"></a>probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">1</span>], <span class="st">"pstate"</span>]  <span class="ot">&lt;-</span> </span>
<span id="cb184-51"><a href="#cb184-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">1</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb184-52"><a href="#cb184-52" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, </span>
<span id="cb184-53"><a href="#cb184-53" aria-hidden="true" tabindex="-1"></a>    probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">1</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb184-54"><a href="#cb184-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-55"><a href="#cb184-55" aria-hidden="true" tabindex="-1"></a>probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">2</span>], <span class="st">"pstate"</span>]  <span class="ot">&lt;-</span> </span>
<span id="cb184-56"><a href="#cb184-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">2</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb184-57"><a href="#cb184-57" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, </span>
<span id="cb184-58"><a href="#cb184-58" aria-hidden="true" tabindex="-1"></a>    probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">2</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb184-59"><a href="#cb184-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-60"><a href="#cb184-60" aria-hidden="true" tabindex="-1"></a>probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">3</span>], <span class="st">"pstate"</span>]  <span class="ot">&lt;-</span> </span>
<span id="cb184-61"><a href="#cb184-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">3</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb184-62"><a href="#cb184-62" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, </span>
<span id="cb184-63"><a href="#cb184-63" aria-hidden="true" tabindex="-1"></a>    probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">3</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb184-64"><a href="#cb184-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-65"><a href="#cb184-65" aria-hidden="true" tabindex="-1"></a>probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">4</span>], <span class="st">"pstate"</span>]  <span class="ot">&lt;-</span> </span>
<span id="cb184-66"><a href="#cb184-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">4</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb184-67"><a href="#cb184-67" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, </span>
<span id="cb184-68"><a href="#cb184-68" aria-hidden="true" tabindex="-1"></a>    probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">4</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb184-69"><a href="#cb184-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-70"><a href="#cb184-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-71"><a href="#cb184-71" aria-hidden="true" tabindex="-1"></a>probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">5</span>], <span class="st">"pstate"</span>]  <span class="ot">&lt;-</span> </span>
<span id="cb184-72"><a href="#cb184-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">5</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb184-73"><a href="#cb184-73" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, </span>
<span id="cb184-74"><a href="#cb184-74" aria-hidden="true" tabindex="-1"></a>    probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">5</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb184-75"><a href="#cb184-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-76"><a href="#cb184-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-77"><a href="#cb184-77" aria-hidden="true" tabindex="-1"></a>probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">6</span>], <span class="st">"pstate"</span>]  <span class="ot">&lt;-</span> </span>
<span id="cb184-78"><a href="#cb184-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">6</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb184-79"><a href="#cb184-79" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, </span>
<span id="cb184-80"><a href="#cb184-80" aria-hidden="true" tabindex="-1"></a>    probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">6</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb184-81"><a href="#cb184-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-82"><a href="#cb184-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-83"><a href="#cb184-83" aria-hidden="true" tabindex="-1"></a>probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">7</span>], <span class="st">"pstate"</span>]  <span class="ot">&lt;-</span> </span>
<span id="cb184-84"><a href="#cb184-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">7</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb184-85"><a href="#cb184-85" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, </span>
<span id="cb184-86"><a href="#cb184-86" aria-hidden="true" tabindex="-1"></a>    probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">7</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb184-87"><a href="#cb184-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-88"><a href="#cb184-88" aria-hidden="true" tabindex="-1"></a>probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">8</span>], <span class="st">"pstate"</span>]  <span class="ot">&lt;-</span> </span>
<span id="cb184-89"><a href="#cb184-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">8</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb184-90"><a href="#cb184-90" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, </span>
<span id="cb184-91"><a href="#cb184-91" aria-hidden="true" tabindex="-1"></a>    probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">8</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb184-92"><a href="#cb184-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-93"><a href="#cb184-93" aria-hidden="true" tabindex="-1"></a>probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">9</span>], <span class="st">"pstate"</span>]  <span class="ot">&lt;-</span> </span>
<span id="cb184-94"><a href="#cb184-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">9</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb184-95"><a href="#cb184-95" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, </span>
<span id="cb184-96"><a href="#cb184-96" aria-hidden="true" tabindex="-1"></a>    probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">9</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb184-97"><a href="#cb184-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-98"><a href="#cb184-98" aria-hidden="true" tabindex="-1"></a>probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">10</span>], <span class="st">"pstate"</span>]  <span class="ot">&lt;-</span> </span>
<span id="cb184-99"><a href="#cb184-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">10</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </span>
<span id="cb184-100"><a href="#cb184-100" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, </span>
<span id="cb184-101"><a href="#cb184-101" aria-hidden="true" tabindex="-1"></a>    probs[probs<span class="sc">$</span>bip <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">&amp;</span> probs<span class="sc">$</span>time <span class="sc">==</span> t[<span class="dv">10</span>], <span class="st">"pstate"</span>] <span class="sc">%*%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb184-102"><a href="#cb184-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-103"><a href="#cb184-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-104"><a href="#cb184-104" aria-hidden="true" tabindex="-1"></a>probs2 <span class="ot">&lt;-</span> probs[<span class="fu">order</span>(probs<span class="sc">$</span>bip, probs<span class="sc">$</span>type, probs<span class="sc">$</span>time, probs<span class="sc">$</span>pstate, <span class="at">decreasing =</span> F),]</span>
<span id="cb184-105"><a href="#cb184-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-106"><a href="#cb184-106" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpattern)</span>
<span id="cb184-107"><a href="#cb184-107" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time), <span class="at">data =</span> <span class="fu">subset</span>(probs2, bip <span class="sc">==</span> <span class="st">"No"</span>)) <span class="sc">+</span></span>
<span id="cb184-108"><a href="#cb184-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area_pattern</span>(<span class="fu">aes</span>(<span class="at">y =</span> pstate, </span>
<span id="cb184-109"><a href="#cb184-109" aria-hidden="true" tabindex="-1"></a>                        <span class="at">pattern =</span> type,</span>
<span id="cb184-110"><a href="#cb184-110" aria-hidden="true" tabindex="-1"></a>                        <span class="at">pattern_fill =</span> type ), </span>
<span id="cb184-111"><a href="#cb184-111" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fill =</span> <span class="st">'white'</span>, </span>
<span id="cb184-112"><a href="#cb184-112" aria-hidden="true" tabindex="-1"></a>                    <span class="at">colour =</span> <span class="st">'black'</span>, </span>
<span id="cb184-113"><a href="#cb184-113" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#pattern_density = 0.02, </span></span>
<span id="cb184-114"><a href="#cb184-114" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pattern_aspect_ratio =</span> <span class="dv">1</span>,</span>
<span id="cb184-115"><a href="#cb184-115" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pattern_fill =</span> <span class="st">'darkgrey'</span>, </span>
<span id="cb184-116"><a href="#cb184-116" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pattern_color =</span> <span class="st">'black'</span>, </span>
<span id="cb184-117"><a href="#cb184-117" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pattern_spacing =</span> <span class="fl">0.02</span>,</span>
<span id="cb184-118"><a href="#cb184-118" aria-hidden="true" tabindex="-1"></a>                    <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb184-119"><a href="#cb184-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability"</span>) <span class="sc">+</span> </span>
<span id="cb184-120"><a href="#cb184-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since first admission (years)"</span>) <span class="sc">+</span> </span>
<span id="cb184-121"><a href="#cb184-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_pattern_discrete</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"State"</span>), </span>
<span id="cb184-122"><a href="#cb184-122" aria-hidden="true" tabindex="-1"></a>                         <span class="at">choices =</span> <span class="fu">c</span>(<span class="st">"circle"</span>, <span class="st">"stripe"</span>, <span class="st">"crosshatch"</span>)) <span class="sc">+</span> </span>
<span id="cb184-123"><a href="#cb184-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_pattern_fill_discrete</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"State"</span>)) <span class="sc">+</span> </span>
<span id="cb184-124"><a href="#cb184-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_pattern_spacing_discrete</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"State"</span>)) <span class="sc">+</span> </span>
<span id="cb184-125"><a href="#cb184-125" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Unipolar"</span>) <span class="sc">+</span> </span>
<span id="cb184-126"><a href="#cb184-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">'cm'</span>))</span>
<span id="cb184-127"><a href="#cb184-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-128"><a href="#cb184-128" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time), <span class="at">data =</span> <span class="fu">subset</span>(probs2, bip <span class="sc">==</span> <span class="st">"Yes"</span>)) <span class="sc">+</span></span>
<span id="cb184-129"><a href="#cb184-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_area_pattern</span>(<span class="fu">aes</span>(<span class="at">y =</span> pstate, </span>
<span id="cb184-130"><a href="#cb184-130" aria-hidden="true" tabindex="-1"></a>                        <span class="at">pattern =</span> type,</span>
<span id="cb184-131"><a href="#cb184-131" aria-hidden="true" tabindex="-1"></a>                        <span class="at">pattern_fill =</span> type ), </span>
<span id="cb184-132"><a href="#cb184-132" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fill =</span> <span class="st">'white'</span>, </span>
<span id="cb184-133"><a href="#cb184-133" aria-hidden="true" tabindex="-1"></a>                    <span class="at">colour =</span> <span class="st">'black'</span>, </span>
<span id="cb184-134"><a href="#cb184-134" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#pattern_density = 0.02, </span></span>
<span id="cb184-135"><a href="#cb184-135" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pattern_aspect_ratio =</span> <span class="dv">1</span>,</span>
<span id="cb184-136"><a href="#cb184-136" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pattern_fill =</span> <span class="st">'darkgrey'</span>, </span>
<span id="cb184-137"><a href="#cb184-137" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pattern_color =</span> <span class="st">'black'</span>, </span>
<span id="cb184-138"><a href="#cb184-138" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pattern_spacing =</span> <span class="fl">0.02</span>,</span>
<span id="cb184-139"><a href="#cb184-139" aria-hidden="true" tabindex="-1"></a>                    <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span> </span>
<span id="cb184-140"><a href="#cb184-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability"</span>) <span class="sc">+</span> </span>
<span id="cb184-141"><a href="#cb184-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since first admission (years)"</span>) <span class="sc">+</span> </span>
<span id="cb184-142"><a href="#cb184-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_pattern_discrete</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"State"</span>),</span>
<span id="cb184-143"><a href="#cb184-143" aria-hidden="true" tabindex="-1"></a>                         <span class="at">choices =</span> <span class="fu">c</span>(<span class="st">"circle"</span>, <span class="st">"stripe"</span>, <span class="st">"crosshatch"</span>)) <span class="sc">+</span> </span>
<span id="cb184-144"><a href="#cb184-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_pattern_fill_discrete</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"State"</span>)) <span class="sc">+</span> </span>
<span id="cb184-145"><a href="#cb184-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_pattern_spacing_discrete</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"State"</span>)) <span class="sc">+</span> </span>
<span id="cb184-146"><a href="#cb184-146" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Bipolar"</span>) <span class="sc">+</span> </span>
<span id="cb184-147"><a href="#cb184-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">'cm'</span>))</span>
<span id="cb184-148"><a href="#cb184-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-149"><a href="#cb184-149" aria-hidden="true" tabindex="-1"></a><span class="co"># common legend</span></span>
<span id="cb184-150"><a href="#cb184-150" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grid)</span>
<span id="cb184-151"><a href="#cb184-151" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb184-152"><a href="#cb184-152" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>(p1, p2)</span>
<span id="cb184-153"><a href="#cb184-153" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">ggplotGrob</span>(plots[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"bottom"</span>))<span class="sc">$</span>grobs</span>
<span id="cb184-154"><a href="#cb184-154" aria-hidden="true" tabindex="-1"></a>legend <span class="ot">&lt;-</span> g[[<span class="fu">which</span>(<span class="fu">sapply</span>(g, <span class="cf">function</span>(x) x<span class="sc">$</span>name) <span class="sc">==</span> <span class="st">"guide-box"</span>)]]</span>
<span id="cb184-155"><a href="#cb184-155" aria-hidden="true" tabindex="-1"></a>lheight <span class="ot">&lt;-</span> <span class="fu">sum</span>(legend<span class="sc">$</span>height)</span>
<span id="cb184-156"><a href="#cb184-156" aria-hidden="true" tabindex="-1"></a>tmp <span class="ot">&lt;-</span> <span class="fu">arrangeGrob</span>(p1 <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>), </span>
<span id="cb184-157"><a href="#cb184-157" aria-hidden="true" tabindex="-1"></a>                   p2 <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>), </span>
<span id="cb184-158"><a href="#cb184-158" aria-hidden="true" tabindex="-1"></a>                   <span class="at">layout_matrix =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">nrow =</span> <span class="dv">1</span>))</span>
<span id="cb184-159"><a href="#cb184-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-160"><a href="#cb184-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-161"><a href="#cb184-161" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.16</span><span class="ot">&lt;-</span><span class="fu">grid.arrange</span>(tmp, legend, <span class="at">ncol =</span> <span class="dv">1</span>, </span>
<span id="cb184-162"><a href="#cb184-162" aria-hidden="true" tabindex="-1"></a>                       <span class="at">heights =</span> <span class="fu">unit.c</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>) <span class="sc">-</span> lheight, lheight))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.16-r-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-29-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-29-2-tab">

</div>
</div>
</div>
</section>
<section id="table-4.7" class="level3">
<h3 class="anchored" data-anchor-id="table-4.7">Table 4.7</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-30-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-30-1" role="tab" aria-controls="tabset-30-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-30-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-30-2" role="tab" aria-controls="tabset-30-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-30-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-30-1-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.7-r_12157eb2078fde9ebf7515c58984f389">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In years</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>affective <span class="ot">&lt;-</span> affective <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">starty =</span> start <span class="sc">/</span> <span class="dv">12</span>, <span class="at">stopy =</span> stop <span class="sc">/</span> <span class="dv">12</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(<span class="at">prevy1 =</span> <span class="fu">lag</span>(starty, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>), </span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prevy2 =</span> <span class="fu">lag</span>(stopy, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),</span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prevy =</span> <span class="fu">ifelse</span>(state <span class="sc">==</span> <span class="dv">1</span>, prevy2, prevy1))</span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a><span class="co"># LWYY model - Mortality treated as censoring </span></span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>subaff<span class="ot">&lt;-</span><span class="fu">subset</span>(affective, state <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>))</span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(prevy, stopy, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> bip <span class="sc">+</span> <span class="fu">cluster</span>(id), </span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> subaff, <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(prevy, stopy, status == 1) ~ bip, data = subaff, 
    ties = "breslow", cluster = id)

  n= 661, number of events= 542 

       coef exp(coef) se(coef) robust se     z Pr(&gt;|z|)  
bip 0.42019   1.52225  0.09446   0.18167 2.313   0.0207 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

    exp(coef) exp(-coef) lower .95 upper .95
bip     1.522     0.6569     1.066     2.173

Concordance= 0.535  (se = 0.019 )
Likelihood ratio test= 18.62  on 1 df,   p=2e-05
Wald test            = 5.35  on 1 df,   p=0.02
Score (logrank) test = 20.07  on 1 df,   p=7e-06,   Robust = 4.15  p=0.04

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ghosh-Lin model - Mortality treated as competing risk</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="co">#library(mets)</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a><span class="co">#fit2 &lt;- recreg(Event(prevy, stopy, status) ~ bip + cluster(id),</span></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a><span class="co">#               data = subaff, cause = 1, cens.code = 3, death.code = 2)</span></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(fit2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Cannot fit Ghosh-Lin model we get the following error: <span style="color:red;">Error in xtfrm.data.frame(x) : cannot xtfrm data frames</span></p>
<p>Estimates in the book are from SAS.</p>
</div>
</div>
</div>
<div id="tabset-30-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-30-2-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.7_979bfca85268ccab63d30598e77b172f">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="co">* LWYY model - Mortality treated as censoring;</span> </span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg covs(aggregate)<span class="kw"> data</span>=angstprev;</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> state=<span class="dv">0</span> <span class="kw">or</span> status=<span class="dv">2</span> <span class="kw">or</span> status=<span class="dv">3</span>;</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>    class bip (ref=<span class="st">'0'</span>);</span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">2</span> <span class="dv">3</span>)=bip/entry=prev rl;</span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a><span class="co">* Ghosh-Lin model - Mortality treated as competing risk;</span> </span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=angstprev;</span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> state=<span class="dv">0</span> <span class="kw">or</span> status=<span class="dv">2</span> <span class="kw">or</span> status=<span class="dv">3</span>;</span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>    class bip (ref=<span class="st">'0'</span>);</span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">3</span>)=bip/entry=prev eventcode=<span class="dv">1</span> rl;</span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.18" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.18">Figure 4.18</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-31-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-31-1" role="tab" aria-controls="tabset-31-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-31-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-31-2" role="tab" aria-controls="tabset-31-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-31-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-31-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.18-r_88e4303f2a88e761b96d2ba45c837368">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, </span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title=</span><span class="fu">element_blank</span>(),</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) </span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Nelson-Aalen to estimate marginal mean, incorrectly censoring for death </span></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>naa_est <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(prevy, stopy, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> bip <span class="sc">+</span> <span class="fu">cluster</span>(id), </span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">subset</span>(affective, stopy <span class="sc">&gt;</span> prevy <span class="sc">&amp;</span> (state <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>))), </span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ctype =</span> <span class="dv">1</span>)</span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect data for plotting</span></span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>plotdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> naa_est<span class="sc">$</span>time, </span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mu =</span> naa_est<span class="sc">$</span>cumhaz, </span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">bip =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"No"</span>, naa_est<span class="sc">$</span>strata[[<span class="dv">1</span>]]), </span>
<span id="cb189-17"><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">rep</span>(<span class="st">"Yes"</span>, naa_est<span class="sc">$</span>strata[[<span class="dv">2</span>]])))</span>
<span id="cb189-18"><a href="#cb189-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-19"><a href="#cb189-19" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.18</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mu, <span class="at">linetype =</span> bip), <span class="at">data =</span> plotdata) <span class="sc">+</span> </span>
<span id="cb189-20"><a href="#cb189-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb189-21"><a href="#cb189-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since first admission (years)"</span>) <span class="sc">+</span> </span>
<span id="cb189-22"><a href="#cb189-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Expected number of episodes"</span>) <span class="sc">+</span> </span>
<span id="cb189-23"><a href="#cb189-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="st">"Bipolar"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dashed"</span>, <span class="st">"solid"</span>),</span>
<span id="cb189-24"><a href="#cb189-24" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Unipolar"</span>,<span class="st">"Bipolar"</span>)) <span class="sc">+</span> </span>
<span id="cb189-25"><a href="#cb189-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb189-26"><a href="#cb189-26" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">30</span>), </span>
<span id="cb189-27"><a href="#cb189-27" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="at">by =</span> <span class="dv">5</span>)) <span class="sc">+</span> </span>
<span id="cb189-28"><a href="#cb189-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb189-29"><a href="#cb189-29" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), </span>
<span id="cb189-30"><a href="#cb189-30" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb189-31"><a href="#cb189-31" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb189-32"><a href="#cb189-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb189-33"><a href="#cb189-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>))</span>
<span id="cb189-34"><a href="#cb189-34" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.18</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.18-r-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-31-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-31-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.18-sas_e5a37baaa9f0cafac68a1fbc6453672d">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>ods graphics <span class="kw">on</span>; </span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg plots(overlay=row)=mcf covs(aggregate)<span class="kw"> data</span>=angstprev;</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> state=<span class="dv">0</span> <span class="kw">or</span> status=<span class="dv">2</span> <span class="kw">or</span> status=<span class="dv">3</span>;</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>    class bip;</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">2</span> <span class="dv">3</span>)=/entry=prev;</span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>    strata bip;</span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>    baseline out=mcfdata cmf=naa;</span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> mcfdata; <span class="kw">set</span> mcfdata;</span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>    years=<span class="kw">stop</span>/<span class="dv">12</span>;</span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=mcfdata;</span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>    plot naa*years=bip/haxis=axis1 vaxis=axis2;</span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">30</span> <span class="kw">by</span> <span class="dv">5</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">12</span> <span class="kw">by</span> <span class="dv">2</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Expected number of episodes'</span>);</span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=red;</span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=blue;</span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.19" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.19">Figure 4.19</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-32-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-32-1" role="tab" aria-controls="tabset-32-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-32-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-32-2" role="tab" aria-controls="tabset-32-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-32-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-32-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.19-r_f1da66ebfc109773a9664ca69a8ddabf">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, </span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title=</span><span class="fu">element_blank</span>(),</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) </span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>xr <span class="ot">&lt;-</span> <span class="fu">phreg</span>(<span class="fu">Surv</span>(prevy, stopy, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="fu">strata</span>(bip) <span class="sc">+</span> <span class="fu">cluster</span>(id),</span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> <span class="fu">subset</span>(affective, state <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)))</span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>xd <span class="ot">&lt;-</span> <span class="fu">phreg</span>(<span class="fu">Surv</span>(prevy, stopy, status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">~</span> <span class="fu">strata</span>(bip) <span class="sc">+</span> <span class="fu">cluster</span>(id),</span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> <span class="fu">subset</span>(affective, state <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)))</span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">recurrentMarginal</span>(xr, xd)</span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>pout <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> out<span class="sc">$</span>cumhaz[,<span class="dv">1</span>], </span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a>                   <span class="at">mu =</span> out<span class="sc">$</span>cumhaz[,<span class="dv">2</span>],</span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>                   <span class="at">bip =</span> <span class="fu">as.factor</span>(out<span class="sc">$</span>strata))</span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a>NAa_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(prevy, stopy, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="fu">strata</span>(bip),</span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> <span class="fu">subset</span>(affective, state <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)),</span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a>                   <span class="at">id =</span> id, <span class="at">ctype =</span> <span class="dv">1</span>, <span class="at">timefix =</span> <span class="cn">FALSE</span>)</span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb191-24"><a href="#cb191-24" aria-hidden="true" tabindex="-1"></a>KM_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(prevy, stopy, status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">~</span> <span class="fu">strata</span>(bip),</span>
<span id="cb191-25"><a href="#cb191-25" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> <span class="fu">subset</span>(affective, state <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)),</span>
<span id="cb191-26"><a href="#cb191-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">id =</span> id, <span class="at">timefix =</span> <span class="cn">FALSE</span>)</span>
<span id="cb191-27"><a href="#cb191-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb191-28"><a href="#cb191-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust hat(mu)</span></span>
<span id="cb191-29"><a href="#cb191-29" aria-hidden="true" tabindex="-1"></a>lS0 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(KM_fit<span class="sc">$</span>surv[<span class="dv">1</span><span class="sc">:</span>(KM_fit<span class="sc">$</span>strata[<span class="dv">1</span>])], <span class="at">default =</span> <span class="dv">1</span>)</span>
<span id="cb191-30"><a href="#cb191-30" aria-hidden="true" tabindex="-1"></a>dA0 <span class="ot">&lt;-</span> <span class="fu">diff</span>(NAa_fit<span class="sc">$</span>cumhaz[<span class="dv">1</span><span class="sc">:</span>NAa_fit<span class="sc">$</span>strata[<span class="dv">1</span>]])</span>
<span id="cb191-31"><a href="#cb191-31" aria-hidden="true" tabindex="-1"></a>mu_adj0 <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(lS0 <span class="sc">*</span> <span class="fu">c</span>(<span class="dv">0</span>, dA0))</span>
<span id="cb191-32"><a href="#cb191-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-33"><a href="#cb191-33" aria-hidden="true" tabindex="-1"></a>lS1 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(KM_fit<span class="sc">$</span>surv[(KM_fit<span class="sc">$</span>strata[<span class="dv">1</span>]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(KM_fit<span class="sc">$</span>strata[<span class="dv">1</span>] <span class="sc">+</span> KM_fit<span class="sc">$</span>strata[<span class="dv">2</span>])], <span class="at">default =</span> <span class="dv">1</span>)</span>
<span id="cb191-34"><a href="#cb191-34" aria-hidden="true" tabindex="-1"></a>dA1 <span class="ot">&lt;-</span> <span class="fu">diff</span>(NAa_fit<span class="sc">$</span>cumhaz[(KM_fit<span class="sc">$</span>strata[<span class="dv">1</span>]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(KM_fit<span class="sc">$</span>strata[<span class="dv">1</span>] <span class="sc">+</span> KM_fit<span class="sc">$</span>strata[<span class="dv">2</span>])])</span>
<span id="cb191-35"><a href="#cb191-35" aria-hidden="true" tabindex="-1"></a>mu_adj1 <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(lS1 <span class="sc">*</span> <span class="fu">c</span>(<span class="dv">0</span>, dA1))</span>
<span id="cb191-36"><a href="#cb191-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-37"><a href="#cb191-37" aria-hidden="true" tabindex="-1"></a>plotdata2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> KM_fit<span class="sc">$</span>time, </span>
<span id="cb191-38"><a href="#cb191-38" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mu =</span> <span class="fu">c</span>(mu_adj0, mu_adj1), </span>
<span id="cb191-39"><a href="#cb191-39" aria-hidden="true" tabindex="-1"></a>                       <span class="at">bip =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"No"</span>, <span class="fu">length</span>(mu_adj0)), </span>
<span id="cb191-40"><a href="#cb191-40" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">rep</span>(<span class="st">"Yes"</span>, <span class="fu">length</span>(mu_adj1))))</span>
<span id="cb191-41"><a href="#cb191-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-42"><a href="#cb191-42" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.19</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mu, <span class="at">linetype =</span> bip), <span class="at">data =</span> plotdata2) <span class="sc">+</span> </span>
<span id="cb191-43"><a href="#cb191-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb191-44"><a href="#cb191-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since first admission (years)"</span>) <span class="sc">+</span> </span>
<span id="cb191-45"><a href="#cb191-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Expected number of episodes"</span>) <span class="sc">+</span> </span>
<span id="cb191-46"><a href="#cb191-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="st">"Bipolar"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dashed"</span>, <span class="st">"solid"</span>),</span>
<span id="cb191-47"><a href="#cb191-47" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"Unipolar"</span>,<span class="st">"Bipolar"</span>) ) <span class="sc">+</span> </span>
<span id="cb191-48"><a href="#cb191-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb191-49"><a href="#cb191-49" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">30</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="at">by =</span> <span class="dv">5</span>)) <span class="sc">+</span> </span>
<span id="cb191-50"><a href="#cb191-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)), </span>
<span id="cb191-51"><a href="#cb191-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb191-52"><a href="#cb191-52" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb191-53"><a href="#cb191-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb191-54"><a href="#cb191-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">1.5</span>, <span class="st">'cm'</span>))</span>
<span id="cb191-55"><a href="#cb191-55" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.19</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.19-r-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-32-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-32-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.19-sas_7c03f530fbee5c701c8909980e4da532">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Using "fine-gray model" in PHREG gives an alternative solution to </span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="co">  the estimator for CMF using the Breslow type estimator for </span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a><span class="co">  the baseline mean function (see p. 199 in book). The estimator is not</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a><span class="co">    exactly the same as Cook-Lawless because of a different procedures </span></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a><span class="co">    for ties of terminating events and censorings. If no ties </span></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a><span class="co">    (or no censorings) it equals Cook &amp; Lawless */</span></span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=angstprev;</span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> state=<span class="dv">0</span> <span class="kw">or</span> status=<span class="dv">2</span> <span class="kw">or</span> status=<span class="dv">3</span>;</span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">3</span>)=/entry=prev eventcode=<span class="dv">1</span>;</span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a>    strata bip;</span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a>    baseline out=mcfdata1 cif=naa1;</span>
<span id="cb192-13"><a href="#cb192-13" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb192-14"><a href="#cb192-14" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> mcfdata1;</span>
<span id="cb192-15"><a href="#cb192-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> mcfdata1;</span>
<span id="cb192-16"><a href="#cb192-16" aria-hidden="true" tabindex="-1"></a>    cmf=-<span class="fu">log</span>(<span class="dv">1</span>-naa1);</span>
<span id="cb192-17"><a href="#cb192-17" aria-hidden="true" tabindex="-1"></a>    years=<span class="kw">stop</span>/<span class="dv">12</span>;</span>
<span id="cb192-18"><a href="#cb192-18" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb192-19"><a href="#cb192-19" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=mcfdata1;</span>
<span id="cb192-20"><a href="#cb192-20" aria-hidden="true" tabindex="-1"></a>    plot cmf*years=bip/haxis=axis1 vaxis=axis2;</span>
<span id="cb192-21"><a href="#cb192-21" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">30</span> <span class="kw">by</span> <span class="dv">5</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb192-22"><a href="#cb192-22" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">12</span> <span class="kw">by</span> <span class="dv">2</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Expected number of episodes'</span>);</span>
<span id="cb192-23"><a href="#cb192-23" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=red;</span>
<span id="cb192-24"><a href="#cb192-24" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=blue;</span>
<span id="cb192-25"><a href="#cb192-25" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb192-26"><a href="#cb192-26" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span>
<span id="cb192-27"><a href="#cb192-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-28"><a href="#cb192-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-29"><a href="#cb192-29" aria-hidden="true" tabindex="-1"></a><span class="co">/*** Calc Cook &amp; Lawless or (Ghosh &amp; Lin (GL)) estimator for CMF 'by hand' ***/</span></span>
<span id="cb192-30"><a href="#cb192-30" aria-hidden="true" tabindex="-1"></a><span class="co">/* First create KM data for death */</span></span>
<span id="cb192-31"><a href="#cb192-31" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=angstprev noprint;</span>
<span id="cb192-32"><a href="#cb192-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> state=<span class="dv">0</span> <span class="kw">or</span> status=<span class="dv">2</span> <span class="kw">or</span> status=<span class="dv">3</span>;</span>
<span id="cb192-33"><a href="#cb192-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">1</span> <span class="dv">3</span>)= / entry=prev; <span class="co">/* status=2=death */</span></span>
<span id="cb192-34"><a href="#cb192-34" aria-hidden="true" tabindex="-1"></a>  strata bip;</span>
<span id="cb192-35"><a href="#cb192-35" aria-hidden="true" tabindex="-1"></a>  baseline out=kmdata survival=km / method=pl ;</span>
<span id="cb192-36"><a href="#cb192-36" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb192-37"><a href="#cb192-37" aria-hidden="true" tabindex="-1"></a><span class="co">/* Second create NAa data */</span></span>
<span id="cb192-38"><a href="#cb192-38" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=angstprev noprint;</span>
<span id="cb192-39"><a href="#cb192-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> state=<span class="dv">0</span> <span class="kw">or</span> status=<span class="dv">2</span> <span class="kw">or</span> status=<span class="dv">3</span>;</span>
<span id="cb192-40"><a href="#cb192-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">2</span> <span class="dv">3</span>)= / entry=prev;<span class="co">/* status=1=event */</span></span>
<span id="cb192-41"><a href="#cb192-41" aria-hidden="true" tabindex="-1"></a>  strata bip;</span>
<span id="cb192-42"><a href="#cb192-42" aria-hidden="true" tabindex="-1"></a>  baseline out=nadata cumhaz=na;</span>
<span id="cb192-43"><a href="#cb192-43" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb192-44"><a href="#cb192-44" aria-hidden="true" tabindex="-1"></a><span class="co">/* Use NA data to calculate dA(u), i.e., increments in NAa */</span></span>
<span id="cb192-45"><a href="#cb192-45" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> na;</span>
<span id="cb192-46"><a href="#cb192-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> nadata;</span>
<span id="cb192-47"><a href="#cb192-47" aria-hidden="true" tabindex="-1"></a>  dAu=na-<span class="fu">lag</span>(na);</span>
<span id="cb192-48"><a href="#cb192-48" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> <span class="kw">stop</span>=<span class="dv">0</span> <span class="kw">then</span> dAu=<span class="dv">0</span>;</span>
<span id="cb192-49"><a href="#cb192-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">keep</span> bip <span class="kw">stop</span> dAu na;</span>
<span id="cb192-50"><a href="#cb192-50" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb192-51"><a href="#cb192-51" aria-hidden="true" tabindex="-1"></a><span class="co">/* merge NAa and KM data */</span></span>
<span id="cb192-52"><a href="#cb192-52" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> merged;</span>
<span id="cb192-53"><a href="#cb192-53" aria-hidden="true" tabindex="-1"></a>  <span class="kw">merge</span> na kmdata;</span>
<span id="cb192-54"><a href="#cb192-54" aria-hidden="true" tabindex="-1"></a>  <span class="kw">by</span> bip <span class="kw">stop</span>;</span>
<span id="cb192-55"><a href="#cb192-55" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb192-56"><a href="#cb192-56" aria-hidden="true" tabindex="-1"></a><span class="co">/* multiply S(u-) and dA(u) */</span></span>
<span id="cb192-57"><a href="#cb192-57" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> fill;</span>
<span id="cb192-58"><a href="#cb192-58" aria-hidden="true" tabindex="-1"></a>   <span class="kw">set</span> merged;</span>
<span id="cb192-59"><a href="#cb192-59" aria-hidden="true" tabindex="-1"></a>   <span class="kw">retain</span> _km;</span>
<span id="cb192-60"><a href="#cb192-60" aria-hidden="true" tabindex="-1"></a>   <span class="kw">if</span> <span class="kw">not</span> missing(km) <span class="kw">then</span> _km=km;</span>
<span id="cb192-61"><a href="#cb192-61" aria-hidden="true" tabindex="-1"></a>   <span class="kw">else</span> km=_km;</span>
<span id="cb192-62"><a href="#cb192-62" aria-hidden="true" tabindex="-1"></a>   <span class="co">/* S(u-) */</span></span>
<span id="cb192-63"><a href="#cb192-63" aria-hidden="true" tabindex="-1"></a>   S_uminus=<span class="fu">lag</span>(km);</span>
<span id="cb192-64"><a href="#cb192-64" aria-hidden="true" tabindex="-1"></a>   <span class="kw">if</span> <span class="kw">stop</span>=<span class="dv">0</span> <span class="kw">then</span> S_uminus=<span class="dv">1</span>;</span>
<span id="cb192-65"><a href="#cb192-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-66"><a href="#cb192-66" aria-hidden="true" tabindex="-1"></a>   <span class="kw">if</span> dAu=. <span class="kw">then</span> dAu=<span class="dv">0</span>;</span>
<span id="cb192-67"><a href="#cb192-67" aria-hidden="true" tabindex="-1"></a>   GLfactor=S_uminus*dAu;</span>
<span id="cb192-68"><a href="#cb192-68" aria-hidden="true" tabindex="-1"></a>   <span class="kw">keep</span> bip <span class="kw">stop</span> na dAu S_uminus GLfactor;</span>
<span id="cb192-69"><a href="#cb192-69" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb192-70"><a href="#cb192-70" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> GLdata;</span>
<span id="cb192-71"><a href="#cb192-71" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> fill;</span>
<span id="cb192-72"><a href="#cb192-72" aria-hidden="true" tabindex="-1"></a>  <span class="kw">by</span> bip;</span>
<span id="cb192-73"><a href="#cb192-73" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> first.bip <span class="kw">then</span> GL=<span class="dv">0</span>;</span>
<span id="cb192-74"><a href="#cb192-74" aria-hidden="true" tabindex="-1"></a>  <span class="kw">else</span> GL+GLfactor;</span>
<span id="cb192-75"><a href="#cb192-75" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb192-76"><a href="#cb192-76" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sgplot<span class="kw"> data</span>=GLdata;</span>
<span id="cb192-77"><a href="#cb192-77" aria-hidden="true" tabindex="-1"></a>  step <span class="kw">x</span>=<span class="kw">stop</span> y=GL / <span class="kw">group</span>=bip;</span>
<span id="cb192-78"><a href="#cb192-78" aria-hidden="true" tabindex="-1"></a>  step <span class="kw">x</span>=<span class="kw">stop</span> y=na / <span class="kw">group</span>=bip;</span>
<span id="cb192-79"><a href="#cb192-79" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-4.9" class="level3">
<h3 class="anchored" data-anchor-id="table-4.9">Table 4.9</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-33-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-33-1" role="tab" aria-controls="tabset-33-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-33-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-33-2" role="tab" aria-controls="tabset-33-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-33-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-33-1-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.9-r_2f31da01c30738425b962a9428ed75d7">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of recurrences and death</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">subset</span>(affective, episode <span class="sc">&lt;</span> <span class="dv">5</span>), <span class="fu">table</span>(episode, status))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       status
episode   0   1   2   3
      1 116  99  16   4
      2  91  82  12   5
      3  74  62  17   3
      4  56  47  10   5</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(<span class="fu">with</span>(<span class="fu">subset</span>(affective, episode <span class="sc">&lt;</span> <span class="dv">5</span>), <span class="fu">table</span>(episode, status)), <span class="dv">2</span>, cumsum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       status
episode   0   1  2  3
      1 116  99 16  4
      2 207 181 28  9
      3 281 243 45 12
      4 337 290 55 17</code></pre>
</div>
</div>
</div>
<div id="tabset-33-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-33-2-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.9-sas_4467ad2ec197aed7a4031ebbe5d070d6">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> angstwlw; </span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> affective;</span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> episode&lt;<span class="dv">5</span> <span class="kw">and</span> (state=<span class="dv">0</span> <span class="kw">or</span> status=<span class="dv">2</span> <span class="kw">or</span> status=<span class="dv">3</span>);</span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sort<span class="kw"> data</span>=angstwlw; </span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> id; </span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> freq<span class="kw"> data</span>=angstwlw;</span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>    tables episode*status; </span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-4.10" class="level3">
<h3 class="anchored" data-anchor-id="table-4.10">Table 4.10</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-34-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-34-1" role="tab" aria-controls="tabset-34-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-34-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-34-2" role="tab" aria-controls="tabset-34-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-34-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-34-1-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.10-r_fd1ecd6f8d7ce734f9ae5817eddb180c">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make WLW data ready using SAS data - see SAS code</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>affectivewlw <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/affectivewlw.csv"</span>)</span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>affectivewlw <span class="ot">&lt;-</span> affectivewlw <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">bip1 =</span> bip <span class="sc">*</span> (stratum <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">bip2 =</span> bip <span class="sc">*</span> (stratum <span class="sc">==</span> <span class="dv">2</span>), </span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">bip3 =</span> bip <span class="sc">*</span> (stratum <span class="sc">==</span> <span class="dv">3</span>), </span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">bip4 =</span> bip <span class="sc">*</span> (stratum <span class="sc">==</span> <span class="dv">4</span>))</span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Composite endpoint</span></span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, dc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)) <span class="sc">~</span> bip1 <span class="sc">+</span> bip2 <span class="sc">+</span> bip3 <span class="sc">+</span> bip4 <span class="sc">+</span> <span class="fu">cluster</span>(id) <span class="sc">+</span> <span class="fu">strata</span>(stratum), </span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> affectivewlw, </span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb198-12"><a href="#cb198-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, dc %in% c(1, 2)) ~ bip1 + bip2 + bip3 + 
    bip4 + strata(stratum), data = affectivewlw, ties = "breslow", 
    cluster = id)

  n= 476, number of events= 434 

         coef exp(coef) se(coef) robust se     z Pr(&gt;|z|)  
bip1 0.379171  1.461073 0.244976  0.208531 1.818    0.069 .
bip2 0.290599  1.337228 0.249212  0.255307 1.138    0.255  
bip3 0.003218  1.003223 0.253766  0.245542 0.013    0.990  
bip4 0.107276  1.113241 0.255085  0.236751 0.453    0.650  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

     exp(coef) exp(-coef) lower .95 upper .95
bip1     1.461     0.6844    0.9709     2.199
bip2     1.337     0.7478    0.8108     2.206
bip3     1.003     0.9968    0.6200     1.623
bip4     1.113     0.8983    0.6999     1.771

Concordance= 0.51  (se = 0.017 )
Likelihood ratio test= 3.67  on 4 df,   p=0.5
Wald test            = 8.7  on 4 df,   p=0.07
Score (logrank) test = 3.97  on 4 df,   p=0.4,   Robust = 7.94  p=0.09

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, dc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)) <span class="sc">~</span> bip <span class="sc">+</span> <span class="fu">cluster</span>(id) <span class="sc">+</span> <span class="fu">strata</span>(stratum), </span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> affectivewlw, </span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, dc %in% c(1, 2)) ~ bip + strata(stratum), 
    data = affectivewlw, ties = "breslow", cluster = id)

  n= 476, number of events= 434 

      coef exp(coef) se(coef) robust se     z Pr(&gt;|z|)
bip 0.1927    1.2125   0.1254    0.2037 0.946    0.344

    exp(coef) exp(-coef) lower .95 upper .95
bip     1.212     0.8248    0.8133     1.808

Concordance= 0.51  (se = 0.017 )
Likelihood ratio test= 2.27  on 1 df,   p=0.1
Wald test            = 0.89  on 1 df,   p=0.3
Score (logrank) test = 2.37  on 1 df,   p=0.1,   Robust = 0.95  p=0.3

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cause-specific hazard of recurrence</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, dc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>)) <span class="sc">~</span> bip1 <span class="sc">+</span> bip2 <span class="sc">+</span> bip3 <span class="sc">+</span> bip4 <span class="sc">+</span> <span class="fu">cluster</span>(id) <span class="sc">+</span> <span class="fu">strata</span>(stratum), </span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> affectivewlw, </span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, dc %in% c(1)) ~ bip1 + bip2 + bip3 + 
    bip4 + strata(stratum), data = affectivewlw, ties = "breslow", 
    cluster = id)

  n= 476, number of events= 290 

       coef exp(coef) se(coef) robust se     z Pr(&gt;|z|)   
bip1 0.4951    1.6406   0.2485    0.2017 2.454  0.01412 * 
bip2 0.6395    1.8956   0.2593    0.2420 2.642  0.00823 **
bip3 0.5342    1.7060   0.2853    0.2694 1.983  0.04741 * 
bip4 0.8793    2.4093   0.3085    0.2832 3.106  0.00190 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

     exp(coef) exp(-coef) lower .95 upper .95
bip1     1.641     0.6095     1.105     2.436
bip2     1.896     0.5275     1.180     3.046
bip3     1.706     0.5862     1.006     2.893
bip4     2.409     0.4151     1.383     4.197

Concordance= 0.543  (se = 0.021 )
Likelihood ratio test= 19.5  on 4 df,   p=6e-04
Wald test            = 16.37  on 4 df,   p=0.003
Score (logrank) test = 22.58  on 4 df,   p=2e-04,   Robust = 12.85  p=0.01

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>fit4 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, dc <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>)) <span class="sc">~</span> bip <span class="sc">+</span> <span class="fu">cluster</span>(id) <span class="sc">+</span> <span class="fu">strata</span>(stratum), </span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> affectivewlw, </span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, dc %in% c(1)) ~ bip + strata(stratum), 
    data = affectivewlw, ties = "breslow", cluster = id)

  n= 476, number of events= 290 

      coef exp(coef) se(coef) robust se     z Pr(&gt;|z|)   
bip 0.6150    1.8496   0.1359    0.2106 2.921  0.00349 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

    exp(coef) exp(-coef) lower .95 upper .95
bip      1.85     0.5407     1.224     2.794

Concordance= 0.543  (se = 0.021 )
Likelihood ratio test= 18.46  on 1 df,   p=2e-05
Wald test            = 8.53  on 1 df,   p=0.003
Score (logrank) test = 21.13  on 1 df,   p=4e-06,   Robust = 7.89  p=0.005

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
</div>
</div>
<div id="tabset-34-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-34-2-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.10-sas_8b2f6c5b315f09587396e2b92566d57d">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> angstwlw; </span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> affective;</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> episode&lt;<span class="dv">5</span> <span class="kw">and</span> (state=<span class="dv">0</span> <span class="kw">or</span> status=<span class="dv">2</span> <span class="kw">or</span> status=<span class="dv">3</span>);</span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sort<span class="kw"> data</span>=angstwlw; </span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> id; </span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> angstwlw4; </span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> angstwlw;</span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> id;</span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">time</span>=<span class="kw">stop</span>; dc=status; stratum=episode;</span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output</span>; </span>
<span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* if last episode is not #4 then later episodes are either</span></span>
<span id="cb206-14"><a href="#cb206-14" aria-hidden="true" tabindex="-1"></a><span class="co">         censored (1 or 3) or the 'end in death' (2) */</span></span>
<span id="cb206-15"><a href="#cb206-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> last.id <span class="kw">then do</span>;</span>
<span id="cb206-16"><a href="#cb206-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> episode=<span class="dv">3</span> <span class="kw">then do</span>;</span>
<span id="cb206-17"><a href="#cb206-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">time</span>=<span class="kw">stop</span>;</span>
<span id="cb206-18"><a href="#cb206-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> status=<span class="dv">1</span> <span class="kw">or</span> status=<span class="dv">3</span> <span class="kw">then</span> dc=<span class="dv">0</span>; </span>
<span id="cb206-19"><a href="#cb206-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> status=<span class="dv">2</span> <span class="kw">then</span> dc=<span class="dv">2</span>;</span>
<span id="cb206-20"><a href="#cb206-20" aria-hidden="true" tabindex="-1"></a>            stratum=<span class="dv">4</span>;</span>
<span id="cb206-21"><a href="#cb206-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">output</span>;</span>
<span id="cb206-22"><a href="#cb206-22" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb206-23"><a href="#cb206-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> episode=<span class="dv">2</span> <span class="kw">then do</span>;</span>
<span id="cb206-24"><a href="#cb206-24" aria-hidden="true" tabindex="-1"></a>            <span class="fu">time</span>=<span class="kw">stop</span>; </span>
<span id="cb206-25"><a href="#cb206-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> status=<span class="dv">1</span> <span class="kw">or</span> status=<span class="dv">3</span> <span class="kw">then</span> dc=<span class="dv">0</span>; </span>
<span id="cb206-26"><a href="#cb206-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> status=<span class="dv">2</span>  <span class="kw">then</span> dc=<span class="dv">2</span>;</span>
<span id="cb206-27"><a href="#cb206-27" aria-hidden="true" tabindex="-1"></a>            stratum=<span class="dv">3</span>;</span>
<span id="cb206-28"><a href="#cb206-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">output</span>; </span>
<span id="cb206-29"><a href="#cb206-29" aria-hidden="true" tabindex="-1"></a>            <span class="fu">time</span>=<span class="kw">stop</span>;</span>
<span id="cb206-30"><a href="#cb206-30" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> status=<span class="dv">1</span> <span class="kw">or</span> status=<span class="dv">3</span> <span class="kw">then</span> dc=<span class="dv">0</span>; </span>
<span id="cb206-31"><a href="#cb206-31" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> status=<span class="dv">2</span> <span class="kw">then</span> dc=<span class="dv">2</span>;</span>
<span id="cb206-32"><a href="#cb206-32" aria-hidden="true" tabindex="-1"></a>            stratum=<span class="dv">4</span>;</span>
<span id="cb206-33"><a href="#cb206-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">output</span>; </span>
<span id="cb206-34"><a href="#cb206-34" aria-hidden="true" tabindex="-1"></a><span class="kw">        end</span>;</span>
<span id="cb206-35"><a href="#cb206-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> episode=<span class="dv">1</span> <span class="kw">then do</span>; </span>
<span id="cb206-36"><a href="#cb206-36" aria-hidden="true" tabindex="-1"></a>            <span class="fu">time</span>=<span class="kw">stop</span>;</span>
<span id="cb206-37"><a href="#cb206-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> status=<span class="dv">1</span> <span class="kw">or</span> status=<span class="dv">3</span> <span class="kw">then</span> dc=<span class="dv">0</span>; </span>
<span id="cb206-38"><a href="#cb206-38" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> status=<span class="dv">2</span> <span class="kw">then</span> dc=<span class="dv">2</span>;</span>
<span id="cb206-39"><a href="#cb206-39" aria-hidden="true" tabindex="-1"></a>            stratum=<span class="dv">2</span>;</span>
<span id="cb206-40"><a href="#cb206-40" aria-hidden="true" tabindex="-1"></a>            <span class="kw">output</span>; </span>
<span id="cb206-41"><a href="#cb206-41" aria-hidden="true" tabindex="-1"></a>            <span class="fu">time</span>=<span class="kw">stop</span>; <span class="kw">if</span> status=<span class="dv">1</span> <span class="kw">or</span> status=<span class="dv">3</span> <span class="kw">then</span> dc=<span class="dv">0</span>; </span>
<span id="cb206-42"><a href="#cb206-42" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> status=<span class="dv">2</span>  <span class="kw">then</span> dc=<span class="dv">2</span>;</span>
<span id="cb206-43"><a href="#cb206-43" aria-hidden="true" tabindex="-1"></a>            stratum=<span class="dv">3</span>;</span>
<span id="cb206-44"><a href="#cb206-44" aria-hidden="true" tabindex="-1"></a>            <span class="kw">output</span>; </span>
<span id="cb206-45"><a href="#cb206-45" aria-hidden="true" tabindex="-1"></a>            <span class="fu">time</span>=<span class="kw">stop</span>;</span>
<span id="cb206-46"><a href="#cb206-46" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> status=<span class="dv">1</span> <span class="kw">or</span> status=<span class="dv">3</span> <span class="kw">then</span> dc=<span class="dv">0</span>; </span>
<span id="cb206-47"><a href="#cb206-47" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> status=<span class="dv">2</span> <span class="kw">then</span> dc=<span class="dv">2</span>;</span>
<span id="cb206-48"><a href="#cb206-48" aria-hidden="true" tabindex="-1"></a>            stratum=<span class="dv">4</span>;</span>
<span id="cb206-49"><a href="#cb206-49" aria-hidden="true" tabindex="-1"></a>            <span class="kw">output</span>; </span>
<span id="cb206-50"><a href="#cb206-50" aria-hidden="true" tabindex="-1"></a><span class="kw">        end</span>;</span>
<span id="cb206-51"><a href="#cb206-51" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb206-52"><a href="#cb206-52" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb206-53"><a href="#cb206-53" aria-hidden="true" tabindex="-1"></a><span class="co">/* to use in R */</span></span>
<span id="cb206-54"><a href="#cb206-54" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> export<span class="kw"> data</span>=angstwlw4</span>
<span id="cb206-55"><a href="#cb206-55" aria-hidden="true" tabindex="-1"></a>    outfile=<span class="st">"data/affectivewlw.csv"</span></span>
<span id="cb206-56"><a href="#cb206-56" aria-hidden="true" tabindex="-1"></a>    dbms=csv <span class="kw">replace</span>;</span>
<span id="cb206-57"><a href="#cb206-57" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb206-58"><a href="#cb206-58" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> angstwlw4; <span class="kw">set</span> angstwlw4;</span>
<span id="cb206-59"><a href="#cb206-59" aria-hidden="true" tabindex="-1"></a>    bip1=bip*(stratum=<span class="dv">1</span>); bip2=bip*(stratum=<span class="dv">2</span>);</span>
<span id="cb206-60"><a href="#cb206-60" aria-hidden="true" tabindex="-1"></a>    bip3=bip*(stratum=<span class="dv">3</span>); bip4=bip*(stratum=<span class="dv">4</span>);</span>
<span id="cb206-61"><a href="#cb206-61" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb206-62"><a href="#cb206-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-63"><a href="#cb206-63" aria-hidden="true" tabindex="-1"></a><span class="co">/* composite end point */</span> </span>
<span id="cb206-64"><a href="#cb206-64" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=angstwlw4 covs(aggregate);</span>
<span id="cb206-65"><a href="#cb206-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*dc(<span class="dv">0</span> <span class="dv">3</span>)=bip1 bip2 bip3 bip4;</span>
<span id="cb206-66"><a href="#cb206-66" aria-hidden="true" tabindex="-1"></a>    strata stratum;</span>
<span id="cb206-67"><a href="#cb206-67" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb206-68"><a href="#cb206-68" aria-hidden="true" tabindex="-1"></a>    bip: test bip1=bip2=bip3=bip4;</span>
<span id="cb206-69"><a href="#cb206-69" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb206-70"><a href="#cb206-70" aria-hidden="true" tabindex="-1"></a><span class="co">/* Joint model */</span></span>
<span id="cb206-71"><a href="#cb206-71" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=angstwlw4 covs(aggregate);</span>
<span id="cb206-72"><a href="#cb206-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*dc(<span class="dv">0</span> <span class="dv">3</span>)=bip;</span>
<span id="cb206-73"><a href="#cb206-73" aria-hidden="true" tabindex="-1"></a>    strata stratum;</span>
<span id="cb206-74"><a href="#cb206-74" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb206-75"><a href="#cb206-75" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb206-76"><a href="#cb206-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-77"><a href="#cb206-77" aria-hidden="true" tabindex="-1"></a><span class="co">/* Cause-spec. hazards for 1.,2.,3.,4. event */</span></span>
<span id="cb206-78"><a href="#cb206-78" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=angstwlw4 covs(aggregate);</span>
<span id="cb206-79"><a href="#cb206-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*dc(<span class="dv">0</span> <span class="dv">2</span> <span class="dv">3</span>)=bip1 bip2 bip3 bip4;</span>
<span id="cb206-80"><a href="#cb206-80" aria-hidden="true" tabindex="-1"></a>    strata stratum;</span>
<span id="cb206-81"><a href="#cb206-81" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb206-82"><a href="#cb206-82" aria-hidden="true" tabindex="-1"></a>    bip: test bip1=bip2=bip3=bip4;</span>
<span id="cb206-83"><a href="#cb206-83" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb206-84"><a href="#cb206-84" aria-hidden="true" tabindex="-1"></a><span class="co">/* Joint model */</span></span>
<span id="cb206-85"><a href="#cb206-85" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=angstwlw4 covs(aggregate);</span>
<span id="cb206-86"><a href="#cb206-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*dc(<span class="dv">0</span> <span class="dv">2</span> <span class="dv">3</span>)=bip;</span>
<span id="cb206-87"><a href="#cb206-87" aria-hidden="true" tabindex="-1"></a>    strata stratum;</span>
<span id="cb206-88"><a href="#cb206-88" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb206-89"><a href="#cb206-89" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.23" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.23">Figure 4.23</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-35-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-1" role="tab" aria-controls="tabset-35-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-35-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-2" role="tab" aria-controls="tabset-35-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-35-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-35-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.23-r_3279f16e14765a97f3755f0ae215544a">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, </span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) </span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Last observations</span></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>cens <span class="ot">&lt;-</span> affective <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> <span class="fu">slice</span>(<span class="fu">c</span>(<span class="fu">n</span>()))</span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Censoring dist, KM</span></span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>censdist <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(stop, status <span class="sc">==</span> <span class="dv">3</span>) <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> cens)</span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Make data ready for plotting</span></span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a>pdata <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> censdist<span class="sc">$</span>time,</span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">surv =</span> censdist<span class="sc">$</span>surv)</span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.23</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time <span class="sc">/</span> <span class="dv">12</span>, <span class="at">y =</span> surv), <span class="at">data =</span> pdata) <span class="sc">+</span></span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since first admission (years)"</span>) <span class="sc">+</span></span>
<span id="cb207-17"><a href="#cb207-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">'Probability of no censoring'</span>) <span class="sc">+</span></span>
<span id="cb207-18"><a href="#cb207-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)),</span>
<span id="cb207-19"><a href="#cb207-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">30</span>),</span>
<span id="cb207-20"><a href="#cb207-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">30</span>, <span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb207-21"><a href="#cb207-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.005</span>)),</span>
<span id="cb207-22"><a href="#cb207-22" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>),</span>
<span id="cb207-23"><a href="#cb207-23" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb207-24"><a href="#cb207-24" aria-hidden="true" tabindex="-1"></a>  theme_general</span>
<span id="cb207-25"><a href="#cb207-25" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.23</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.23-r-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-35-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-35-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.23-sas_687e2d20de6603f2d349389f23c3d300">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cens; </span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> affective;</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> id;</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> last.id;</span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=cens atrisk noprint;</span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">2</span>)=;</span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>    baseline out=angstcens survival=kmc / method=pl;</span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> angstcens; </span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> angstcens; </span>
<span id="cb208-12"><a href="#cb208-12" aria-hidden="true" tabindex="-1"></a>    years=<span class="kw">stop</span>/<span class="dv">12</span>; </span>
<span id="cb208-13"><a href="#cb208-13" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb208-14"><a href="#cb208-14" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=angstcens;</span>
<span id="cb208-15"><a href="#cb208-15" aria-hidden="true" tabindex="-1"></a>    plot kmc*years/haxis=axis1 vaxis=axis2;</span>
<span id="cb208-16"><a href="#cb208-16" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">30</span> <span class="kw">by</span> <span class="dv">5</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb208-17"><a href="#cb208-17" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none</span>
<span id="cb208-18"><a href="#cb208-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Probability of no censoring'</span>);</span>
<span id="cb208-19"><a href="#cb208-19" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=black;</span>
<span id="cb208-20"><a href="#cb208-20" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb208-21"><a href="#cb208-21" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="in-text-cox-for-censoring-1" class="level3">
<h3 class="anchored" data-anchor-id="in-text-cox-for-censoring-1">In-text: Cox for censoring</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-36-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-36-1" role="tab" aria-controls="tabset-36-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-36-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-36-2" role="tab" aria-controls="tabset-36-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-36-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-36-1-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-censoring-r_9541fc6e195c320add6761fbdddcad73">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(stop,status<span class="sc">==</span><span class="dv">3</span>)<span class="sc">~</span>bip,<span class="at">data=</span>cens)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(stop, status == 3) ~ bip, data = cens)

       coef exp(coef) se(coef)      z     p
bip -0.4844    0.6161   0.3738 -1.296 0.195

Likelihood ratio test=1.8  on 1 df, p=0.18
n= 119, number of events= 41 </code></pre>
</div>
</div>
</div>
<div id="tabset-36-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-36-2-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-censoring-sas_1d122a63a25b4152bbbaf5ec0df4cc73">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=cens;</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">2</span>)=bip/rl;</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="leader-cardiovascular-trial-in-type-2-diabetes" class="level2">
<h2 class="anchored" data-anchor-id="leader-cardiovascular-trial-in-type-2-diabetes">LEADER cardiovascular trial in type 2 diabetes</h2>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-101_f49a1e87c3ba7596e0cd6cb9eed84e7a">

</div>
<p>Assume that the LEADER data set is loaded in data set <code>leader_mi</code>.</p>
<section id="figure-4.20" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.20">Figure 4.20</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-37-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-37-1" role="tab" aria-controls="tabset-37-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-37-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-37-2" role="tab" aria-controls="tabset-37-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-37-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-37-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.20-r_2fa35b393ca967c9eb394f7a725c5f7b">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)</span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a>ghosh_lin_nonpar_mcf <span class="ot">&lt;-</span> <span class="cf">function</span>(endpointdat) {</span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit NAa</span></span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a>  NAa_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(</span>
<span id="cb212-13"><a href="#cb212-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Surv</span>(start, stop, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> treat,</span>
<span id="cb212-14"><a href="#cb212-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> endpointdat,</span>
<span id="cb212-15"><a href="#cb212-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> id,</span>
<span id="cb212-16"><a href="#cb212-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">ctype =</span> <span class="dv">1</span></span>
<span id="cb212-17"><a href="#cb212-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb212-18"><a href="#cb212-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-19"><a href="#cb212-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit KM</span></span>
<span id="cb212-20"><a href="#cb212-20" aria-hidden="true" tabindex="-1"></a>  KM_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(</span>
<span id="cb212-21"><a href="#cb212-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Surv</span>(start, stop, status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">~</span> treat,</span>
<span id="cb212-22"><a href="#cb212-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> endpointdat,</span>
<span id="cb212-23"><a href="#cb212-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> id,</span>
<span id="cb212-24"><a href="#cb212-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">ctype =</span> <span class="dv">1</span></span>
<span id="cb212-25"><a href="#cb212-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb212-26"><a href="#cb212-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-27"><a href="#cb212-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Adjust hat(mu)</span></span>
<span id="cb212-28"><a href="#cb212-28" aria-hidden="true" tabindex="-1"></a>  mu_adj <span class="ot">&lt;-</span></span>
<span id="cb212-29"><a href="#cb212-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fu">cumsum</span>(KM_fit<span class="sc">$</span>surv[<span class="dv">1</span><span class="sc">:</span>KM_fit<span class="sc">$</span>strata[[<span class="dv">1</span>]]] <span class="sc">*</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(NAa_fit<span class="sc">$</span>cumhaz[<span class="dv">1</span><span class="sc">:</span>NAa_fit<span class="sc">$</span>strata[[<span class="dv">1</span>]]]))),</span>
<span id="cb212-30"><a href="#cb212-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cumsum</span>(KM_fit<span class="sc">$</span>surv[(KM_fit<span class="sc">$</span>strata[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(KM_fit<span class="sc">$</span>strata[[<span class="dv">1</span>]] <span class="sc">+</span> KM_fit<span class="sc">$</span>strata[[<span class="dv">2</span>]])] <span class="sc">*</span></span>
<span id="cb212-31"><a href="#cb212-31" aria-hidden="true" tabindex="-1"></a>               <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(NAa_fit<span class="sc">$</span>cumhaz[(NAa_fit<span class="sc">$</span>strata[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(NAa_fit<span class="sc">$</span>strata[[<span class="dv">1</span>]] <span class="sc">+</span> NAa_fit<span class="sc">$</span>strata[[<span class="dv">2</span>]])]))))</span>
<span id="cb212-32"><a href="#cb212-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-33"><a href="#cb212-33" aria-hidden="true" tabindex="-1"></a>  dat_adj <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb212-34"><a href="#cb212-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu =</span> mu_adj,</span>
<span id="cb212-35"><a href="#cb212-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> NAa_fit<span class="sc">$</span>time,</span>
<span id="cb212-36"><a href="#cb212-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat =</span> <span class="fu">c</span>(</span>
<span id="cb212-37"><a href="#cb212-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rep</span>(<span class="st">"Liraglutide"</span>, NAa_fit<span class="sc">$</span>strata[[<span class="dv">1</span>]]),</span>
<span id="cb212-38"><a href="#cb212-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rep</span>(<span class="st">"Placebo"</span>, NAa_fit<span class="sc">$</span>strata[[<span class="dv">2</span>]])</span>
<span id="cb212-39"><a href="#cb212-39" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb212-40"><a href="#cb212-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">rep</span>(</span>
<span id="cb212-41"><a href="#cb212-41" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Mortality treated as a competing risk (CL)"</span>,</span>
<span id="cb212-42"><a href="#cb212-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">length</span>(NAa_fit<span class="sc">$</span>time)</span>
<span id="cb212-43"><a href="#cb212-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb212-44"><a href="#cb212-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb212-45"><a href="#cb212-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-46"><a href="#cb212-46" aria-hidden="true" tabindex="-1"></a>  dat_unadj <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb212-47"><a href="#cb212-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu =</span> NAa_fit<span class="sc">$</span>cumhaz,</span>
<span id="cb212-48"><a href="#cb212-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> NAa_fit<span class="sc">$</span>time,</span>
<span id="cb212-49"><a href="#cb212-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat =</span> <span class="fu">c</span>(</span>
<span id="cb212-50"><a href="#cb212-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rep</span>(<span class="st">"Liraglutide"</span>, NAa_fit<span class="sc">$</span>strata[[<span class="dv">1</span>]]),</span>
<span id="cb212-51"><a href="#cb212-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rep</span>(<span class="st">"Placebo"</span>, NAa_fit<span class="sc">$</span>strata[[<span class="dv">2</span>]])</span>
<span id="cb212-52"><a href="#cb212-52" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb212-53"><a href="#cb212-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">rep</span>(<span class="st">"Mortality treated as censoring (NA)"</span>, <span class="fu">length</span>(NAa_fit<span class="sc">$</span>time))</span>
<span id="cb212-54"><a href="#cb212-54" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb212-55"><a href="#cb212-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-56"><a href="#cb212-56" aria-hidden="true" tabindex="-1"></a>  dat_adj<span class="sc">$</span>both <span class="ot">&lt;-</span> <span class="fu">with</span>(dat_adj, <span class="fu">paste</span>(type, treat, <span class="at">sep =</span> <span class="st">", "</span>))</span>
<span id="cb212-57"><a href="#cb212-57" aria-hidden="true" tabindex="-1"></a>  dat_unadj<span class="sc">$</span>both <span class="ot">&lt;-</span> <span class="fu">with</span>(dat_unadj, <span class="fu">paste</span>(type, treat, <span class="at">sep =</span> <span class="st">", "</span>))</span>
<span id="cb212-58"><a href="#cb212-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-59"><a href="#cb212-59" aria-hidden="true" tabindex="-1"></a>  pdat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat_adj, dat_unadj)</span>
<span id="cb212-60"><a href="#cb212-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-61"><a href="#cb212-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time  <span class="sc">*</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="fl">365.25</span> <span class="sc">/</span> <span class="dv">12</span>), <span class="at">y =</span> mu), <span class="at">data =</span> pdat) <span class="sc">+</span></span>
<span id="cb212-62"><a href="#cb212-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> both), <span class="at">linewidth =</span> <span class="fl">1.05</span>) <span class="sc">+</span></span>
<span id="cb212-63"><a href="#cb212-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Time since randomization (months)"</span>) <span class="sc">+</span></span>
<span id="cb212-64"><a href="#cb212-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Expected number of events per subject"</span>) <span class="sc">+</span></span>
<span id="cb212-65"><a href="#cb212-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_discrete</span>(<span class="st">"Treatment"</span>) <span class="sc">+</span></span>
<span id="cb212-66"><a href="#cb212-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="st">""</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"dotdash"</span>, <span class="st">"dotted"</span>, <span class="st">"solid"</span>, <span class="st">"dashed"</span>)) <span class="sc">+</span></span>
<span id="cb212-67"><a href="#cb212-67" aria-hidden="true" tabindex="-1"></a>    theme_general <span class="sc">+</span></span>
<span id="cb212-68"><a href="#cb212-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb212-69"><a href="#cb212-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb212-70"><a href="#cb212-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="sc">-</span><span class="dv">25</span>),</span>
<span id="cb212-71"><a href="#cb212-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.direction =</span> <span class="st">"vertical"</span>,</span>
<span id="cb212-72"><a href="#cb212-72" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.box =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb212-73"><a href="#cb212-73" aria-hidden="true" tabindex="-1"></a>      <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>),</span>
<span id="cb212-74"><a href="#cb212-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb212-75"><a href="#cb212-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="dv">3</span>, <span class="st">"cm"</span>)</span>
<span id="cb212-76"><a href="#cb212-76" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb212-77"><a href="#cb212-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(</span>
<span id="cb212-78"><a href="#cb212-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)),</span>
<span id="cb212-79"><a href="#cb212-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">65</span>),</span>
<span id="cb212-80"><a href="#cb212-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">65</span>, <span class="at">by =</span> <span class="dv">12</span>)</span>
<span id="cb212-81"><a href="#cb212-81" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb212-82"><a href="#cb212-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb212-83"><a href="#cb212-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.005</span>, <span class="fl">0.05</span>)),</span>
<span id="cb212-84"><a href="#cb212-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.13</span>),</span>
<span id="cb212-85"><a href="#cb212-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.13</span>, <span class="at">by =</span> <span class="fl">0.02</span>)</span>
<span id="cb212-86"><a href="#cb212-86" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb212-87"><a href="#cb212-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-88"><a href="#cb212-88" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb212-89"><a href="#cb212-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-90"><a href="#cb212-90" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.20</span> <span class="ot">&lt;-</span> <span class="fu">ghosh_lin_nonpar_mcf</span>(<span class="at">endpointdat =</span> leader_mi)</span>
<span id="cb212-91"><a href="#cb212-91" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.20</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.20-r-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-37-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-37-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.20-sas_3b20906a40a381d322a6f30f2903a1f6">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Using "fine-gray model" in PHREG gives an alternative solution to </span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a><span class="co">  the estimator for CMF using the Breslow type estimator for </span></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a><span class="co">  the baseline mean function (see p. 199 in book). The estimator is not</span></span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a><span class="co">    exactly the same as Cook-Lawless because of a different procedures </span></span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a><span class="co">    for ties of terminating events and censorings. If no ties </span></span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a><span class="co">    (or no censorings) it equals Cook &amp; Lawless */</span></span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a><span class="co">* NELSON-AALEN;</span> </span>
<span id="cb213-9"><a href="#cb213-9" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=leader_mi noprint;</span>
<span id="cb213-10"><a href="#cb213-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">0</span> <span class="dv">2</span>)=/entry=start;</span>
<span id="cb213-11"><a href="#cb213-11" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb213-12"><a href="#cb213-12" aria-hidden="true" tabindex="-1"></a>    strata treat;</span>
<span id="cb213-13"><a href="#cb213-13" aria-hidden="true" tabindex="-1"></a>  baseline out=na_<span class="kw">data</span> cumhaz=naa;</span>
<span id="cb213-14"><a href="#cb213-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb213-15"><a href="#cb213-15" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> na_est;</span>
<span id="cb213-16"><a href="#cb213-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> na_<span class="kw">data</span>; </span>
<span id="cb213-17"><a href="#cb213-17" aria-hidden="true" tabindex="-1"></a>    type = <span class="st">"Nelson-Aalen"</span>;</span>
<span id="cb213-18"><a href="#cb213-18" aria-hidden="true" tabindex="-1"></a>    cumevent = naa; </span>
<span id="cb213-19"><a href="#cb213-19" aria-hidden="true" tabindex="-1"></a>    treat_type = <span class="fu">trim</span>(treat) || <span class="st">", "</span>  || type; </span>
<span id="cb213-20"><a href="#cb213-20" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb213-21"><a href="#cb213-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-22"><a href="#cb213-22" aria-hidden="true" tabindex="-1"></a><span class="co">* COOK &amp; LAWLESS (GHOSH &amp; LIN);</span></span>
<span id="cb213-23"><a href="#cb213-23" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=leader_mi noprint;</span>
<span id="cb213-24"><a href="#cb213-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> (start, <span class="kw">stop</span>)*status(<span class="dv">0</span>)=/eventcode=<span class="dv">1</span>; </span>
<span id="cb213-25"><a href="#cb213-25" aria-hidden="true" tabindex="-1"></a>  strata treat;</span>
<span id="cb213-26"><a href="#cb213-26" aria-hidden="true" tabindex="-1"></a>  baseline out=gl_<span class="kw">data</span> cif=cuminc;</span>
<span id="cb213-27"><a href="#cb213-27" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb213-28"><a href="#cb213-28" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> gl_est;</span>
<span id="cb213-29"><a href="#cb213-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> gl_<span class="kw">data</span>; </span>
<span id="cb213-30"><a href="#cb213-30" aria-hidden="true" tabindex="-1"></a>    type = <span class="st">"Ghosh &amp; Lin"</span>;</span>
<span id="cb213-31"><a href="#cb213-31" aria-hidden="true" tabindex="-1"></a>    cumevent = -<span class="fu">log</span>(<span class="dv">1</span>-cuminc); </span>
<span id="cb213-32"><a href="#cb213-32" aria-hidden="true" tabindex="-1"></a>    treat_type = <span class="fu">trim</span>(treat) || <span class="st">", "</span> || type; </span>
<span id="cb213-33"><a href="#cb213-33" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb213-34"><a href="#cb213-34" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> comb; </span>
<span id="cb213-35"><a href="#cb213-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> na_est gl_est; </span>
<span id="cb213-36"><a href="#cb213-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">time</span> = <span class="kw">stop</span>/(<span class="dv">365.25</span>/<span class="dv">12</span>);</span>
<span id="cb213-37"><a href="#cb213-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">drop</span> naa cuminc;</span>
<span id="cb213-38"><a href="#cb213-38" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb213-39"><a href="#cb213-39" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sgplot<span class="kw"> data</span>=comb;</span>
<span id="cb213-40"><a href="#cb213-40" aria-hidden="true" tabindex="-1"></a>    step <span class="kw">x</span>=<span class="fu">time</span> y=cumevent/<span class="kw">group</span>=treat_type justify=<span class="fu">left</span>;</span>
<span id="cb213-41"><a href="#cb213-41" aria-hidden="true" tabindex="-1"></a>    xaxis grid values=(<span class="dv">0</span> <span class="kw">to</span> <span class="dv">60</span> <span class="kw">by</span> <span class="dv">12</span>);</span>
<span id="cb213-42"><a href="#cb213-42" aria-hidden="true" tabindex="-1"></a>    yaxis grid values=(<span class="dv">0</span> <span class="kw">to</span> <span class="dv">0.12</span> <span class="kw">by</span> <span class="dv">0.02</span>);</span>
<span id="cb213-43"><a href="#cb213-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span> <span class="fu">time</span>=<span class="st">"Time since randomisation (months)"</span>;</span>
<span id="cb213-44"><a href="#cb213-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span> cumevent=<span class="st">"Expected number events per subject"</span>; </span>
<span id="cb213-45"><a href="#cb213-45" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>; </span>
<span id="cb213-46"><a href="#cb213-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-47"><a href="#cb213-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-48"><a href="#cb213-48" aria-hidden="true" tabindex="-1"></a><span class="co">/*** Calc Cook &amp; Lawless or (Ghosh &amp; Lin (GL)) estimator for CMF by hand ***/</span></span>
<span id="cb213-49"><a href="#cb213-49" aria-hidden="true" tabindex="-1"></a><span class="co">/* First create KM data for death */</span></span>
<span id="cb213-50"><a href="#cb213-50" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=leader_mi noprint;</span>
<span id="cb213-51"><a href="#cb213-51" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">0</span> <span class="dv">1</span>)= / entry=start; <span class="co">/* status=2=death */</span></span>
<span id="cb213-52"><a href="#cb213-52" aria-hidden="true" tabindex="-1"></a>  strata treat;</span>
<span id="cb213-53"><a href="#cb213-53" aria-hidden="true" tabindex="-1"></a>  baseline out=kmdata survival=km / method=pl ;</span>
<span id="cb213-54"><a href="#cb213-54" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb213-55"><a href="#cb213-55" aria-hidden="true" tabindex="-1"></a><span class="co">/* Second create NAa data */</span></span>
<span id="cb213-56"><a href="#cb213-56" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=leader_mi noprint;</span>
<span id="cb213-57"><a href="#cb213-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">0</span> <span class="dv">2</span>)= / entry=start; <span class="co">/* status=1=event */</span></span>
<span id="cb213-58"><a href="#cb213-58" aria-hidden="true" tabindex="-1"></a>  strata treat;</span>
<span id="cb213-59"><a href="#cb213-59" aria-hidden="true" tabindex="-1"></a>  baseline out=nadata cumhaz=na;</span>
<span id="cb213-60"><a href="#cb213-60" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb213-61"><a href="#cb213-61" aria-hidden="true" tabindex="-1"></a><span class="co">/* Use NA data to calculate dA(u), i.e., increments in NAa */</span></span>
<span id="cb213-62"><a href="#cb213-62" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> na;</span>
<span id="cb213-63"><a href="#cb213-63" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> nadata;</span>
<span id="cb213-64"><a href="#cb213-64" aria-hidden="true" tabindex="-1"></a>  dAu=na-<span class="fu">lag</span>(na);</span>
<span id="cb213-65"><a href="#cb213-65" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> <span class="kw">stop</span>=<span class="dv">0</span> <span class="kw">then</span> dAu=<span class="dv">0</span>;</span>
<span id="cb213-66"><a href="#cb213-66" aria-hidden="true" tabindex="-1"></a>  <span class="kw">keep</span> treat <span class="kw">stop</span> dAu na;</span>
<span id="cb213-67"><a href="#cb213-67" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb213-68"><a href="#cb213-68" aria-hidden="true" tabindex="-1"></a><span class="co">/* merge NAa and KM data */</span></span>
<span id="cb213-69"><a href="#cb213-69" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> merged;</span>
<span id="cb213-70"><a href="#cb213-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">merge</span> na kmdata;</span>
<span id="cb213-71"><a href="#cb213-71" aria-hidden="true" tabindex="-1"></a>  <span class="kw">by</span> treat <span class="kw">stop</span>;</span>
<span id="cb213-72"><a href="#cb213-72" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb213-73"><a href="#cb213-73" aria-hidden="true" tabindex="-1"></a><span class="co">/* multiply S(u-) and dA(u) */</span></span>
<span id="cb213-74"><a href="#cb213-74" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> fill;</span>
<span id="cb213-75"><a href="#cb213-75" aria-hidden="true" tabindex="-1"></a>   <span class="kw">set</span> merged;</span>
<span id="cb213-76"><a href="#cb213-76" aria-hidden="true" tabindex="-1"></a>   <span class="kw">retain</span> _km;</span>
<span id="cb213-77"><a href="#cb213-77" aria-hidden="true" tabindex="-1"></a>   <span class="kw">if</span> <span class="kw">not</span> missing(km) <span class="kw">then</span> _km=km;</span>
<span id="cb213-78"><a href="#cb213-78" aria-hidden="true" tabindex="-1"></a>   <span class="kw">else</span> km=_km;</span>
<span id="cb213-79"><a href="#cb213-79" aria-hidden="true" tabindex="-1"></a>   <span class="co">/* S(u-) */</span></span>
<span id="cb213-80"><a href="#cb213-80" aria-hidden="true" tabindex="-1"></a>   S_uminus=<span class="fu">lag</span>(km);</span>
<span id="cb213-81"><a href="#cb213-81" aria-hidden="true" tabindex="-1"></a>   <span class="kw">if</span> <span class="kw">stop</span>=<span class="dv">0</span> <span class="kw">then</span> S_uminus=<span class="dv">1</span>;</span>
<span id="cb213-82"><a href="#cb213-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-83"><a href="#cb213-83" aria-hidden="true" tabindex="-1"></a>   <span class="kw">if</span> dAu=. <span class="kw">then</span> dAu=<span class="dv">0</span>;</span>
<span id="cb213-84"><a href="#cb213-84" aria-hidden="true" tabindex="-1"></a>   GLfactor=S_uminus*dAu;</span>
<span id="cb213-85"><a href="#cb213-85" aria-hidden="true" tabindex="-1"></a>   <span class="kw">keep</span> treat <span class="kw">stop</span> na dAu S_uminus GLfactor;</span>
<span id="cb213-86"><a href="#cb213-86" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb213-87"><a href="#cb213-87" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> GLdata;</span>
<span id="cb213-88"><a href="#cb213-88" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> fill;</span>
<span id="cb213-89"><a href="#cb213-89" aria-hidden="true" tabindex="-1"></a>  <span class="kw">by</span> treat;</span>
<span id="cb213-90"><a href="#cb213-90" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> first.treat <span class="kw">then</span> GL=<span class="dv">0</span>;</span>
<span id="cb213-91"><a href="#cb213-91" aria-hidden="true" tabindex="-1"></a>  <span class="kw">else</span> GL+GLfactor;</span>
<span id="cb213-92"><a href="#cb213-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">time</span> = <span class="kw">stop</span>/(<span class="dv">365.25</span>/<span class="dv">12</span>);</span>
<span id="cb213-93"><a href="#cb213-93" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb213-94"><a href="#cb213-94" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sgplot<span class="kw"> data</span>=GLdata;</span>
<span id="cb213-95"><a href="#cb213-95" aria-hidden="true" tabindex="-1"></a>  step <span class="kw">x</span>=<span class="fu">time</span> y=na / <span class="kw">group</span>=treat;</span>
<span id="cb213-96"><a href="#cb213-96" aria-hidden="true" tabindex="-1"></a>  step <span class="kw">x</span>=<span class="fu">time</span> y=GL / <span class="kw">group</span>=treat;</span>
<span id="cb213-97"><a href="#cb213-97" aria-hidden="true" tabindex="-1"></a>    xaxis grid values=(<span class="dv">0</span> <span class="kw">to</span> <span class="dv">60</span> <span class="kw">by</span> <span class="dv">12</span>);</span>
<span id="cb213-98"><a href="#cb213-98" aria-hidden="true" tabindex="-1"></a>    yaxis grid values=(<span class="dv">0</span> <span class="kw">to</span> <span class="dv">0.12</span> <span class="kw">by</span> <span class="dv">0.02</span>);</span>
<span id="cb213-99"><a href="#cb213-99" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span> <span class="fu">time</span>=<span class="st">"Time since randomisation (months)"</span>;</span>
<span id="cb213-100"><a href="#cb213-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">label</span> na=<span class="st">"Expected number events per subject"</span>; </span>
<span id="cb213-101"><a href="#cb213-101" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="in-text-lwyy-and-ghosh-lin-models" class="level3">
<h3 class="anchored" data-anchor-id="in-text-lwyy-and-ghosh-lin-models">In-text: LWYY and Ghosh-Lin models</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-38-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-38-1" role="tab" aria-controls="tabset-38-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-38-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-38-2" role="tab" aria-controls="tabset-38-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-38-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-38-1-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-lwyy-ghoshlin-r_e1fd14b63dddfde28ecd53846c305908">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(start, stop, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> treat <span class="sc">+</span> <span class="fu">cluster</span>(id), </span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">data =</span> leader_mi, <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(start, stop, status == 1) ~ treat, data = leader_mi, 
    ties = "breslow", cluster = id)

  n= 10120, number of events= 780 

          coef exp(coef) se(coef) robust se      z Pr(&gt;|z|)  
treat -0.16418   0.84859  0.07184   0.08810 -1.864   0.0624 .
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

      exp(coef) exp(-coef) lower .95 upper .95
treat    0.8486      1.178     0.714     1.009

Concordance= 0.524  (se = 0.011 )
Likelihood ratio test= 5.24  on 1 df,   p=0.02
Wald test            = 3.47  on 1 df,   p=0.06
Score (logrank) test = 5.23  on 1 df,   p=0.02,   Robust = 3.47  p=0.06

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ghosh-Lin model - Mortality treated as competing risk</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">recreg</span>(<span class="fu">Event</span>(start, stop, status) <span class="sc">~</span> treat <span class="sc">+</span> <span class="fu">cluster</span>(id),</span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> leader_mi, <span class="at">cause =</span> <span class="dv">1</span>, <span class="at">cens.code =</span> <span class="dv">0</span>, <span class="at">death.code =</span> <span class="dv">2</span>)</span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
     n events
 10120    780

 9340 clusters
coeffients:
       Estimate      S.E.   dU^-1/2 P-value
treat -0.158754  0.087861  0.071839  0.0708

exp(coeffients):
      Estimate    2.5%  97.5%
treat  0.85321 0.71823 1.0135</code></pre>
</div>
</div>
</div>
<div id="tabset-38-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-38-2-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-lwyy-ghoshlin-sas_145fd954849329860fa5f34e6126913c">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'LWYY model'</span>;</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=leader_mi covs(aggregate);</span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>  class treat(ref=<span class="st">"0"</span>);</span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> (start, <span class="kw">stop</span>)*status(<span class="dv">0</span> <span class="dv">2</span>) = treat / rl; </span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>  id id;</span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'Ghosh-Lin model'</span>;</span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=leader_mi covs(aggregate);</span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a>  class treat(ref=<span class="st">"0"</span>);</span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">model</span> (start, <span class="kw">stop</span>)*status(<span class="dv">0</span>) = treat / rl</span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a>        eventcode=<span class="dv">1</span> convergelike=<span class="dv">1E-9</span>; </span>
<span id="cb218-13"><a href="#cb218-13" aria-hidden="true" tabindex="-1"></a>  id id;</span>
<span id="cb218-14"><a href="#cb218-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="bone-marrow-transplantation-in-acute-leukemia" class="level2">
<h2 class="anchored" data-anchor-id="bone-marrow-transplantation-in-acute-leukemia">Bone marrow transplantation in acute leukemia</h2>
<section id="read-data-3" class="level3">
<h3 class="anchored" data-anchor-id="read-data-3">Read data</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-39-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-39-1" role="tab" aria-controls="tabset-39-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-39-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-39-2" role="tab" aria-controls="tabset-39-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-39-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-39-1-tab">
<div class="cell" data-hash="Ch4_cache/html/read-bmt-r_016ab491de9c56c45f745c19e65613a4">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>bmt <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/bmt.csv"</span>)</span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>intxsurv<span class="ot">&lt;-</span> bmt<span class="sc">$</span>timedeath</span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>dead <span class="ot">&lt;-</span> bmt<span class="sc">$</span>death</span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>intxrel <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>rel <span class="sc">==</span> <span class="dv">1</span>, bmt<span class="sc">$</span>timerel, bmt<span class="sc">$</span>timedeath)</span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>trm     <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>rel <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> bmt<span class="sc">$</span>death <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>tgvhd   <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>gvhd <span class="sc">==</span> <span class="dv">1</span>, bmt<span class="sc">$</span>timegvhd, bmt<span class="sc">$</span>intxrel)</span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>tanc500 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bmt<span class="sc">$</span>anc500 <span class="sc">==</span> <span class="dv">1</span>, bmt<span class="sc">$</span>timeanc500, bmt<span class="sc">$</span>intxrel)</span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>state0  <span class="ot">&lt;-</span> bmt<span class="sc">$</span>rel <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>bmt<span class="sc">$</span>trm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-39-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-39-2-tab">
<div class="cell" data-hash="Ch4_cache/html/read-bmt-sas_0ab81e3b1102717a0c209f9ffaff9f5a">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> import out=bmt</span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>    datafile=<span class="st">"data/bmt.csv"</span> </span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>    dbms=csv <span class="kw">replace</span>;</span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> bmt; </span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set</span> bmt;</span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>    intxsurv=timedeath;</span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>    dead=death;</span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> rel=<span class="dv">1</span> <span class="kw">then</span> intxrel=timerel;</span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> rel=<span class="dv">0</span> <span class="kw">then</span> intxrel=timedeath;</span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a>    trm=<span class="dv">0</span>;</span>
<span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> rel=<span class="dv">0</span> <span class="kw">and</span> death=<span class="dv">1</span> <span class="kw">then</span> trm=<span class="dv">1</span>;</span>
<span id="cb220-13"><a href="#cb220-13" aria-hidden="true" tabindex="-1"></a>    state0=rel+<span class="dv">2</span>*trm;</span>
<span id="cb220-14"><a href="#cb220-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> gvhd=<span class="dv">1</span> <span class="kw">then</span> tgvhd=timegvhd;</span>
<span id="cb220-15"><a href="#cb220-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> gvhd=<span class="dv">0</span> <span class="kw">then</span> tgvhd=intxrel;</span>
<span id="cb220-16"><a href="#cb220-16" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="figure-4.15" class="level3">
<h3 class="anchored" data-anchor-id="figure-4.15">Figure 4.15</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-40-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-40-1" role="tab" aria-controls="tabset-40-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-40-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-40-2" role="tab" aria-controls="tabset-40-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-40-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-40-1-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.15_c065889276ea68d1ba698436f1fee6cd">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a><span class="co"># General theme</span></span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a>theme_general <span class="ot">&lt;-</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>, </span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>), </span>
<span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) </span>
<span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Relapse-free survival </span></span>
<span id="cb221-11"><a href="#cb221-11" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(intxrel, state0 <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> bmt)</span>
<span id="cb221-12"><a href="#cb221-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-13"><a href="#cb221-13" aria-hidden="true" tabindex="-1"></a><span class="co"># relapse</span></span>
<span id="cb221-14"><a href="#cb221-14" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(mets)</span>
<span id="cb221-15"><a href="#cb221-15" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">cif</span>(<span class="fu">Event</span>(intxrel, state0) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> bmt, <span class="at">cause =</span> <span class="dv">1</span>)</span>
<span id="cb221-16"><a href="#cb221-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-17"><a href="#cb221-17" aria-hidden="true" tabindex="-1"></a><span class="co"># death in remission</span></span>
<span id="cb221-18"><a href="#cb221-18" aria-hidden="true" tabindex="-1"></a>fit3 <span class="ot">&lt;-</span> <span class="fu">cif</span>(<span class="fu">Event</span>(intxrel, state0) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> bmt, <span class="at">cause =</span> <span class="dv">2</span>)</span>
<span id="cb221-19"><a href="#cb221-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-20"><a href="#cb221-20" aria-hidden="true" tabindex="-1"></a><span class="co"># overall survival</span></span>
<span id="cb221-21"><a href="#cb221-21" aria-hidden="true" tabindex="-1"></a>fit4 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(intxsurv, dead <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> bmt)</span>
<span id="cb221-22"><a href="#cb221-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-23"><a href="#cb221-23" aria-hidden="true" tabindex="-1"></a><span class="co"># We need the same time for all probabilities</span></span>
<span id="cb221-24"><a href="#cb221-24" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(dplyr)</span>
<span id="cb221-25"><a href="#cb221-25" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(tidyr)</span>
<span id="cb221-26"><a href="#cb221-26" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(<span class="at">x =</span> fit1<span class="sc">$</span>time, <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">1</span>, fit1<span class="sc">$</span>surv)) </span>
<span id="cb221-27"><a href="#cb221-27" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(<span class="at">x =</span> fit2<span class="sc">$</span>times, <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, fit2<span class="sc">$</span>mu))</span>
<span id="cb221-28"><a href="#cb221-28" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(<span class="at">x =</span> fit3<span class="sc">$</span>times, <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, fit3<span class="sc">$</span>mu))</span>
<span id="cb221-29"><a href="#cb221-29" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">stepfun</span>(<span class="at">x =</span> fit4<span class="sc">$</span>time, <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span><span class="sc">-</span>fit4<span class="sc">$</span>surv))</span>
<span id="cb221-30"><a href="#cb221-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-31"><a href="#cb221-31" aria-hidden="true" tabindex="-1"></a>unitimes <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">c</span>(fit1<span class="sc">$</span>time, fit2<span class="sc">$</span>times, fit3<span class="sc">$</span>times, fit4<span class="sc">$</span>time)))</span>
<span id="cb221-32"><a href="#cb221-32" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> unitimes, </span>
<span id="cb221-33"><a href="#cb221-33" aria-hidden="true" tabindex="-1"></a>                <span class="at">q0 =</span> <span class="fu">m1</span>(unitimes),</span>
<span id="cb221-34"><a href="#cb221-34" aria-hidden="true" tabindex="-1"></a>                <span class="at">c1 =</span> <span class="fu">m2</span>(unitimes), </span>
<span id="cb221-35"><a href="#cb221-35" aria-hidden="true" tabindex="-1"></a>                <span class="at">c2 =</span> <span class="fu">m3</span>(unitimes), </span>
<span id="cb221-36"><a href="#cb221-36" aria-hidden="true" tabindex="-1"></a>                <span class="at">c23 =</span> <span class="fu">m4</span>(unitimes))</span>
<span id="cb221-37"><a href="#cb221-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-38"><a href="#cb221-38" aria-hidden="true" tabindex="-1"></a>m<span class="sc">$</span>q2 <span class="ot">&lt;-</span>m<span class="sc">$</span>c2</span>
<span id="cb221-39"><a href="#cb221-39" aria-hidden="true" tabindex="-1"></a>m<span class="sc">$</span>q3 <span class="ot">&lt;-</span> m<span class="sc">$</span>c23 <span class="sc">-</span> m<span class="sc">$</span>c2</span>
<span id="cb221-40"><a href="#cb221-40" aria-hidden="true" tabindex="-1"></a>m<span class="sc">$</span>q1 <span class="ot">&lt;-</span> m<span class="sc">$</span>c1 <span class="sc">-</span> m<span class="sc">$</span>q3</span>
<span id="cb221-41"><a href="#cb221-41" aria-hidden="true" tabindex="-1"></a>m<span class="sc">$</span>sum <span class="ot">&lt;-</span> <span class="fu">with</span>(m, q0<span class="sc">+</span>q1<span class="sc">+</span>q2<span class="sc">+</span>q3)</span>
<span id="cb221-42"><a href="#cb221-42" aria-hidden="true" tabindex="-1"></a>m<span class="sc">$</span>prev <span class="ot">&lt;-</span> <span class="fu">with</span>(m, q1 <span class="sc">/</span> (q0 <span class="sc">+</span> q1))</span>
<span id="cb221-43"><a href="#cb221-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-44"><a href="#cb221-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for plotting</span></span>
<span id="cb221-45"><a href="#cb221-45" aria-hidden="true" tabindex="-1"></a>plotdata <span class="ot">&lt;-</span> <span class="fu">with</span>(m, </span>
<span id="cb221-46"><a href="#cb221-46" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="fu">c</span>(time, time), </span>
<span id="cb221-47"><a href="#cb221-47" aria-hidden="true" tabindex="-1"></a>                            <span class="at">prob =</span> <span class="fu">c</span>(prev, q1),</span>
<span id="cb221-48"><a href="#cb221-48" aria-hidden="true" tabindex="-1"></a>                            <span class="at">type =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Prevalence of relapse"</span>, <span class="fu">length</span>(time)), </span>
<span id="cb221-49"><a href="#cb221-49" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">rep</span>(<span class="st">"Probability of being alive with relapse"</span>,</span>
<span id="cb221-50"><a href="#cb221-50" aria-hidden="true" tabindex="-1"></a>                                         <span class="fu">length</span>(time)))))</span>
<span id="cb221-51"><a href="#cb221-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-52"><a href="#cb221-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Create Figure</span></span>
<span id="cb221-53"><a href="#cb221-53" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.15</span> <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> prob, <span class="at">linetype =</span> type), <span class="at">data =</span> plotdata) <span class="sc">+</span> </span>
<span id="cb221-54"><a href="#cb221-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb221-55"><a href="#cb221-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_discrete</span>(<span class="st">"Type"</span>) <span class="sc">+</span> </span>
<span id="cb221-56"><a href="#cb221-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since bone marrow transplantation (months)"</span>) <span class="sc">+</span> </span>
<span id="cb221-57"><a href="#cb221-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability"</span>) <span class="sc">+</span> </span>
<span id="cb221-58"><a href="#cb221-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)), </span>
<span id="cb221-59"><a href="#cb221-59" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">156</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">156</span>, <span class="at">by =</span> <span class="dv">12</span>)) <span class="sc">+</span> </span>
<span id="cb221-60"><a href="#cb221-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.05</span>)), </span>
<span id="cb221-61"><a href="#cb221-61" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.05</span>), </span>
<span id="cb221-62"><a href="#cb221-62" aria-hidden="true" tabindex="-1"></a>                     <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.05</span>, <span class="fl">0.01</span>)) <span class="sc">+</span></span>
<span id="cb221-63"><a href="#cb221-63" aria-hidden="true" tabindex="-1"></a>  theme_general <span class="sc">+</span> </span>
<span id="cb221-64"><a href="#cb221-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.box =</span> <span class="st">"vertical"</span>,</span>
<span id="cb221-65"><a href="#cb221-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">21</span>), </span>
<span id="cb221-66"><a href="#cb221-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">'cm'</span>))</span>
<span id="cb221-67"><a href="#cb221-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-68"><a href="#cb221-68" aria-hidden="true" tabindex="-1"></a>fig4<span class="fl">.15</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/figure-4.15-1.png" class="img-fluid" style="width:90.0%"></p>
</div>
</div>
</div>
<div id="tabset-40-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-40-2-tab">
<div class="cell" data-hash="Ch4_cache/html/figure-4.15-sas_e971ca3a9c4df93d4b29f82bfe47b633">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bmt noprint; <span class="co">/* Relapse-free surv */</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> intxrel*state0(<span class="dv">0</span>)=;</span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>    baseline out=surv survival=km;</span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bmt noprint; <span class="co">/* Relapse */</span></span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> intxrel*state0(<span class="dv">0</span>)=/eventcode=<span class="dv">1</span>;</span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a>    baseline out=cif1 cif=cif1;</span>
<span id="cb222-9"><a href="#cb222-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb222-10"><a href="#cb222-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-11"><a href="#cb222-11" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bmt noprint; <span class="co">/* Death in remission */</span></span>
<span id="cb222-12"><a href="#cb222-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> intxrel*state0(<span class="dv">0</span>)=/eventcode=<span class="dv">2</span>;</span>
<span id="cb222-13"><a href="#cb222-13" aria-hidden="true" tabindex="-1"></a>    baseline out=cif2 cif=cif2;</span>
<span id="cb222-14"><a href="#cb222-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb222-15"><a href="#cb222-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-16"><a href="#cb222-16" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bmt noprint; <span class="co">/* Overall surv. */</span></span>
<span id="cb222-17"><a href="#cb222-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> intxsurv*dead(<span class="dv">0</span>)=/eventcode=<span class="dv">1</span>;</span>
<span id="cb222-18"><a href="#cb222-18" aria-hidden="true" tabindex="-1"></a>    baseline out=dead cif=cif23;</span>
<span id="cb222-19"><a href="#cb222-19" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb222-20"><a href="#cb222-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-21"><a href="#cb222-21" aria-hidden="true" tabindex="-1"></a><span class="co">/* We need the same time variable for all probabilities */</span></span>
<span id="cb222-22"><a href="#cb222-22" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> dead; <span class="kw">set</span> dead; <span class="fu">time</span>=intxsurv<span class="kw">; run</span>;</span>
<span id="cb222-23"><a href="#cb222-23" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> surv; <span class="kw">set</span> surv; <span class="fu">time</span>=intxrel<span class="kw">; run</span>;</span>
<span id="cb222-24"><a href="#cb222-24" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cif1; <span class="kw">set</span> cif1; <span class="fu">time</span>=intxrel<span class="kw">; run</span>;</span>
<span id="cb222-25"><a href="#cb222-25" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cif2; <span class="kw">set</span> cif2; <span class="fu">time</span>=intxrel<span class="kw">; run</span>;</span>
<span id="cb222-26"><a href="#cb222-26" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> all; <span class="kw">merge</span> surv cif1 cif2 dead; <span class="kw">by</span> <span class="fu">time</span><span class="kw">; run</span>;</span>
<span id="cb222-27"><a href="#cb222-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-28"><a href="#cb222-28" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> allrev; </span>
<span id="cb222-29"><a href="#cb222-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> all;</span>
<span id="cb222-30"><a href="#cb222-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> <span class="fu">time</span>;</span>
<span id="cb222-31"><a href="#cb222-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> last1 last2 last3 last4;</span>
<span id="cb222-32"><a href="#cb222-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> km=. <span class="kw">then</span> rfs=last1; <span class="kw">if</span> km ne . <span class="kw">then</span> rfs=km; </span>
<span id="cb222-33"><a href="#cb222-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> cif1=. <span class="kw">then</span> c1=last2; <span class="kw">if</span> cif1 ne . <span class="kw">then</span> c1=cif1;</span>
<span id="cb222-34"><a href="#cb222-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> cif2=. <span class="kw">then</span> c2=last3; <span class="kw">if</span> cif2 ne . <span class="kw">then</span> c2=cif2;</span>
<span id="cb222-35"><a href="#cb222-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> cif23=. <span class="kw">then</span> c23=last4; <span class="kw">if</span> cif23 ne . <span class="kw">then</span> c23=cif23;</span>
<span id="cb222-36"><a href="#cb222-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output</span>;</span>
<span id="cb222-37"><a href="#cb222-37" aria-hidden="true" tabindex="-1"></a>    last1=rfs; last2=c1; last3=c2; last4=c23;</span>
<span id="cb222-38"><a href="#cb222-38" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb222-39"><a href="#cb222-39" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> allrev; </span>
<span id="cb222-40"><a href="#cb222-40" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> allrev;</span>
<span id="cb222-41"><a href="#cb222-41" aria-hidden="true" tabindex="-1"></a>    q0=rfs; q2=c2; q3=c23-c2; q1=c1-q3; <span class="fu">sum</span>=q0+q1+q2+q3; prev=q1/(q0+q1); tment=<span class="dv">0</span>;</span>
<span id="cb222-42"><a href="#cb222-42" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb222-43"><a href="#cb222-43" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=allrev;</span>
<span id="cb222-44"><a href="#cb222-44" aria-hidden="true" tabindex="-1"></a>    plot prev*<span class="fu">time</span> q1*<span class="fu">time</span>/overlay haxis=axis1 vaxis=axis2;</span>
<span id="cb222-45"><a href="#cb222-45" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">150</span> <span class="kw">by</span> <span class="dv">10</span> minor=none <span class="kw">label</span>=(<span class="st">'Months'</span>);</span>
<span id="cb222-46"><a href="#cb222-46" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">0.05</span> <span class="kw">by</span> <span class="dv">0.01</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Relapse prev. and prob.'</span>);</span>
<span id="cb222-47"><a href="#cb222-47" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb222-48"><a href="#cb222-48" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb222-49"><a href="#cb222-49" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb222-50"><a href="#cb222-50" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="in-text-p.-133-expected-time-lost" class="level3">
<h3 class="anchored" data-anchor-id="in-text-p.-133-expected-time-lost">In-text p.&nbsp;133: Expected time lost</h3>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Missing for R - but should be possible with mstate or survival?</p>
</div>
</div>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-41-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-41-1" role="tab" aria-controls="tabset-41-1" aria-selected="true">R-NA</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-41-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-41-2" role="tab" aria-controls="tabset-41-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-41-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-41-1-tab">

</div>
<div id="tabset-41-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-41-2-tab">
<div class="cell" data-hash="Ch4_cache/html/in-text-mu-sas_cf7c63c21269d8a4cabe5e69ca25c5c6">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Bootstrap */</span></span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> bootbmt;</span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a><span class="kw">    do</span> sampnum = <span class="dv">1</span> <span class="kw">to</span> <span class="dv">1000</span>; <span class="co">/* nboot=1000*/</span></span>
<span id="cb223-4"><a href="#cb223-4" aria-hidden="true" tabindex="-1"></a><span class="kw">    do</span> i = <span class="dv">1</span> <span class="kw">to</span> <span class="dv">2009</span>; <span class="co">/*nobs=2009*/</span></span>
<span id="cb223-5"><a href="#cb223-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">x</span>=<span class="fu">round</span>(<span class="fu">ranuni</span>(<span class="dv">0</span>)*<span class="dv">2009</span>); <span class="co">/*nobs=2009*/</span></span>
<span id="cb223-6"><a href="#cb223-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> bmt</span>
<span id="cb223-7"><a href="#cb223-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">point</span>=<span class="kw">x</span>;</span>
<span id="cb223-8"><a href="#cb223-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output</span>;</span>
<span id="cb223-9"><a href="#cb223-9" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb223-10"><a href="#cb223-10" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb223-11"><a href="#cb223-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">stop</span>;</span>
<span id="cb223-12"><a href="#cb223-12" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb223-13"><a href="#cb223-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-14"><a href="#cb223-14" aria-hidden="true" tabindex="-1"></a><span class="kw">%macro</span> areastepby(data,byvar,beh,grp,tid,y,tau);</span>
<span id="cb223-15"><a href="#cb223-15" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> <span class="kw">select</span>;</span>
<span id="cb223-16"><a href="#cb223-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">set</span> <span class="kw">&amp;data;</span></span>
<span id="cb223-17"><a href="#cb223-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">where</span> <span class="kw">&amp;beh=&amp;grp;</span></span>
<span id="cb223-18"><a href="#cb223-18" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb223-19"><a href="#cb223-19" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> <span class="kw">select</span>;</span>
<span id="cb223-20"><a href="#cb223-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">set</span> <span class="kw">select</span>;</span>
<span id="cb223-21"><a href="#cb223-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">by</span> <span class="kw">&amp;byvar;</span></span>
<span id="cb223-22"><a href="#cb223-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">retain</span> mu oldt oldy;</span>
<span id="cb223-23"><a href="#cb223-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> first.<span class="kw">&amp;byvar then do</span> oldt=<span class="dv">0</span>; oldy=<span class="dv">1</span>; mu=<span class="dv">0</span><span class="kw">;  end</span>;</span>
<span id="cb223-24"><a href="#cb223-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="kw">&amp;tid&gt;&amp;tau then do</span>;</span>
<span id="cb223-25"><a href="#cb223-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&amp;tid=&amp;tau;</span> <span class="kw">&amp;y=</span>oldy<span class="kw">; end</span>;</span>
<span id="cb223-26"><a href="#cb223-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="kw">not</span> first.<span class="kw">&amp;byvar then</span> mu+oldy*(<span class="kw">&amp;tid-</span>oldt);</span>
<span id="cb223-27"><a href="#cb223-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> last.<span class="kw">&amp;byvar then do</span>;</span>
<span id="cb223-28"><a href="#cb223-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="kw">&amp;tid&lt;&amp;tau then</span> mu+(<span class="kw">&amp;tau-&amp;tid)</span>*<span class="kw">&amp;y; end</span>;</span>
<span id="cb223-29"><a href="#cb223-29" aria-hidden="true" tabindex="-1"></a>        oldy=<span class="kw">&amp;y;</span> oldt=<span class="kw">&amp;tid;</span></span>
<span id="cb223-30"><a href="#cb223-30" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb223-31"><a href="#cb223-31" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> last;</span>
<span id="cb223-32"><a href="#cb223-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">set</span> <span class="kw">select</span>;</span>
<span id="cb223-33"><a href="#cb223-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">by</span>  <span class="kw">&amp;byvar;</span></span>
<span id="cb223-34"><a href="#cb223-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> last.<span class="kw">&amp;byvar;</span></span>
<span id="cb223-35"><a href="#cb223-35" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb223-36"><a href="#cb223-36" aria-hidden="true" tabindex="-1"></a><span class="kw">%mend</span> areastepby;</span>
<span id="cb223-37"><a href="#cb223-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-38"><a href="#cb223-38" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bootbmt noprint; <span class="co">/* Relapse-free surv */</span></span>
<span id="cb223-39"><a href="#cb223-39" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> sampnum;</span>
<span id="cb223-40"><a href="#cb223-40" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> intxrel*state0(<span class="dv">0</span>)=;</span>
<span id="cb223-41"><a href="#cb223-41" aria-hidden="true" tabindex="-1"></a>baseline out=surv survival=km;</span>
<span id="cb223-42"><a href="#cb223-42" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb223-43"><a href="#cb223-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-44"><a href="#cb223-44" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bootbmt noprint; <span class="co">/* Relapse */</span></span>
<span id="cb223-45"><a href="#cb223-45" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> sampnum;</span>
<span id="cb223-46"><a href="#cb223-46" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> intxrel*state0(<span class="dv">0</span>)=/eventcode=<span class="dv">1</span>;</span>
<span id="cb223-47"><a href="#cb223-47" aria-hidden="true" tabindex="-1"></a>baseline out=cif1 cif=cif1;</span>
<span id="cb223-48"><a href="#cb223-48" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb223-49"><a href="#cb223-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-50"><a href="#cb223-50" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bootbmt noprint; <span class="co">/* Death in remission */</span></span>
<span id="cb223-51"><a href="#cb223-51" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> sampnum;</span>
<span id="cb223-52"><a href="#cb223-52" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> intxrel*state0(<span class="dv">0</span>)=/eventcode=<span class="dv">2</span>;</span>
<span id="cb223-53"><a href="#cb223-53" aria-hidden="true" tabindex="-1"></a>baseline out=cif2 cif=cif2;</span>
<span id="cb223-54"><a href="#cb223-54" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb223-55"><a href="#cb223-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-56"><a href="#cb223-56" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bootbmt noprint; <span class="co">/* Overall surv. */</span></span>
<span id="cb223-57"><a href="#cb223-57" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> sampnum;</span>
<span id="cb223-58"><a href="#cb223-58" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> intxsurv*dead(<span class="dv">0</span>)=/eventcode=<span class="dv">1</span>;</span>
<span id="cb223-59"><a href="#cb223-59" aria-hidden="true" tabindex="-1"></a>baseline out=dead cif=cif23;</span>
<span id="cb223-60"><a href="#cb223-60" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb223-61"><a href="#cb223-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-62"><a href="#cb223-62" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> dead; <span class="kw">set</span> dead; <span class="fu">time</span>=intxsurv; <span class="kw">drop</span> intxsurv<span class="kw">;  run</span>;  </span>
<span id="cb223-63"><a href="#cb223-63" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> surv; <span class="kw">set</span> surv; <span class="fu">time</span>=intxrel; <span class="kw">drop</span> intxrel<span class="kw">; run</span>;</span>
<span id="cb223-64"><a href="#cb223-64" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cif1; <span class="kw">set</span> cif1; <span class="fu">time</span>=intxrel; <span class="kw">drop</span> intxrel<span class="kw">; run</span>;</span>
<span id="cb223-65"><a href="#cb223-65" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cif2; <span class="kw">set</span> cif2; <span class="fu">time</span>=intxrel; <span class="kw">drop</span> intxrel<span class="kw">; run</span>;</span>
<span id="cb223-66"><a href="#cb223-66" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> all; <span class="kw">merge</span> surv cif1 cif2 dead ; <span class="kw">by</span> sampnum <span class="fu">time</span><span class="kw">; run</span>;</span>
<span id="cb223-67"><a href="#cb223-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-68"><a href="#cb223-68" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> allrev; <span class="kw">set</span> all;</span>
<span id="cb223-69"><a href="#cb223-69" aria-hidden="true" tabindex="-1"></a><span class="kw">by</span> sampnum <span class="fu">time</span>; </span>
<span id="cb223-70"><a href="#cb223-70" aria-hidden="true" tabindex="-1"></a><span class="kw">retain</span> last1 last2 last3 last4;</span>
<span id="cb223-71"><a href="#cb223-71" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> km=. <span class="kw">then</span> rfs=last1; <span class="kw">if</span> km ne . <span class="kw">then</span> rfs=km; </span>
<span id="cb223-72"><a href="#cb223-72" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> cif1=. <span class="kw">then</span> c1=last2; <span class="kw">if</span> cif1 ne . <span class="kw">then</span> c1=cif1;</span>
<span id="cb223-73"><a href="#cb223-73" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> cif2=. <span class="kw">then</span> c2=last3; <span class="kw">if</span> cif2 ne . <span class="kw">then</span> c2=cif2;</span>
<span id="cb223-74"><a href="#cb223-74" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> cif23=. <span class="kw">then</span> c23=last4; <span class="kw">if</span> cif23 ne . <span class="kw">then</span> c23=cif23;</span>
<span id="cb223-75"><a href="#cb223-75" aria-hidden="true" tabindex="-1"></a><span class="kw">output</span>;</span>
<span id="cb223-76"><a href="#cb223-76" aria-hidden="true" tabindex="-1"></a>last1=rfs; last2=c1; last3=c2; last4=c23;</span>
<span id="cb223-77"><a href="#cb223-77" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb223-78"><a href="#cb223-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-79"><a href="#cb223-79" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> allrev; <span class="kw">set</span> allrev;</span>
<span id="cb223-80"><a href="#cb223-80" aria-hidden="true" tabindex="-1"></a>q0=rfs; q2=c2; q3=c23-c2; q1=c1-q3; <span class="fu">sum</span>=q0+q1+q2+q3; prev=q1/(q0+q1); tment=<span class="dv">0</span>;</span>
<span id="cb223-81"><a href="#cb223-81" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb223-82"><a href="#cb223-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-83"><a href="#cb223-83" aria-hidden="true" tabindex="-1"></a>%areastepby(allrev,sampnum,tment,0,time,q0,120);</span>
<span id="cb223-84"><a href="#cb223-84" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb223-85"><a href="#cb223-85" aria-hidden="true" tabindex="-1"></a><span class="fu">var</span> mu;</span>
<span id="cb223-86"><a href="#cb223-86" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb223-87"><a href="#cb223-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-88"><a href="#cb223-88" aria-hidden="true" tabindex="-1"></a><span class="co">/* macro need to be changed for cuminc (start in 0) */</span></span>
<span id="cb223-89"><a href="#cb223-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-90"><a href="#cb223-90" aria-hidden="true" tabindex="-1"></a><span class="kw">%macro</span> areastepby0(data,byvar,beh,grp,tid,y,tau);</span>
<span id="cb223-91"><a href="#cb223-91" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> <span class="kw">select</span>;</span>
<span id="cb223-92"><a href="#cb223-92" aria-hidden="true" tabindex="-1"></a>        <span class="kw">set</span> <span class="kw">&amp;data;</span></span>
<span id="cb223-93"><a href="#cb223-93" aria-hidden="true" tabindex="-1"></a>        <span class="kw">where</span> <span class="kw">&amp;beh=&amp;grp;</span></span>
<span id="cb223-94"><a href="#cb223-94" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb223-95"><a href="#cb223-95" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> <span class="kw">select</span>;</span>
<span id="cb223-96"><a href="#cb223-96" aria-hidden="true" tabindex="-1"></a>        <span class="kw">set</span> <span class="kw">select</span>;</span>
<span id="cb223-97"><a href="#cb223-97" aria-hidden="true" tabindex="-1"></a>        <span class="kw">by</span> <span class="kw">&amp;byvar;</span></span>
<span id="cb223-98"><a href="#cb223-98" aria-hidden="true" tabindex="-1"></a>        <span class="kw">retain</span> mu oldt oldy;</span>
<span id="cb223-99"><a href="#cb223-99" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> first.<span class="kw">&amp;byvar then do</span> oldt=<span class="dv">0</span>; oldy=<span class="dv">0</span>; mu=<span class="dv">0</span><span class="kw">;  end</span>;</span>
<span id="cb223-100"><a href="#cb223-100" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="kw">&amp;tid&gt;&amp;tau then do</span>;</span>
<span id="cb223-101"><a href="#cb223-101" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&amp;tid=&amp;tau;</span> <span class="kw">&amp;y=</span>oldy<span class="kw">; end</span>;</span>
<span id="cb223-102"><a href="#cb223-102" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="kw">not</span> first.<span class="kw">&amp;byvar then</span> mu+oldy*(<span class="kw">&amp;tid-</span>oldt);</span>
<span id="cb223-103"><a href="#cb223-103" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> last.<span class="kw">&amp;byvar then do</span>;</span>
<span id="cb223-104"><a href="#cb223-104" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="kw">&amp;tid&lt;&amp;tau then</span> mu+(<span class="kw">&amp;tau-&amp;tid)</span>*<span class="kw">&amp;y; end</span>;</span>
<span id="cb223-105"><a href="#cb223-105" aria-hidden="true" tabindex="-1"></a>        oldy=<span class="kw">&amp;y;</span> oldt=<span class="kw">&amp;tid;</span></span>
<span id="cb223-106"><a href="#cb223-106" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb223-107"><a href="#cb223-107" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> last;</span>
<span id="cb223-108"><a href="#cb223-108" aria-hidden="true" tabindex="-1"></a>        <span class="kw">set</span> <span class="kw">select</span>;</span>
<span id="cb223-109"><a href="#cb223-109" aria-hidden="true" tabindex="-1"></a>        <span class="kw">by</span>  <span class="kw">&amp;byvar;</span></span>
<span id="cb223-110"><a href="#cb223-110" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> last.<span class="kw">&amp;byvar;</span></span>
<span id="cb223-111"><a href="#cb223-111" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;</span>
<span id="cb223-112"><a href="#cb223-112" aria-hidden="true" tabindex="-1"></a><span class="kw">%mend</span> areastepby;</span>
<span id="cb223-113"><a href="#cb223-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-114"><a href="#cb223-114" aria-hidden="true" tabindex="-1"></a>%areastepby0(allrev,sampnum,tment,0,time,q1,120);</span>
<span id="cb223-115"><a href="#cb223-115" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb223-116"><a href="#cb223-116" aria-hidden="true" tabindex="-1"></a><span class="fu">var</span> mu;</span>
<span id="cb223-117"><a href="#cb223-117" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb223-118"><a href="#cb223-118" aria-hidden="true" tabindex="-1"></a>%areastepby0(allrev,sampnum,tment,0,time,c23,120);</span>
<span id="cb223-119"><a href="#cb223-119" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb223-120"><a href="#cb223-120" aria-hidden="true" tabindex="-1"></a><span class="fu">var</span> mu;</span>
<span id="cb223-121"><a href="#cb223-121" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb223-122"><a href="#cb223-122" aria-hidden="true" tabindex="-1"></a>%areastepby0(allrev,sampnum,tment,0,time,q2,120);</span>
<span id="cb223-123"><a href="#cb223-123" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb223-124"><a href="#cb223-124" aria-hidden="true" tabindex="-1"></a><span class="fu">var</span> mu;</span>
<span id="cb223-125"><a href="#cb223-125" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb223-126"><a href="#cb223-126" aria-hidden="true" tabindex="-1"></a>%areastepby0(allrev,sampnum,tment,0,time,q3,120);</span>
<span id="cb223-127"><a href="#cb223-127" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=last <span class="fu">mean</span> stddev;</span>
<span id="cb223-128"><a href="#cb223-128" aria-hidden="true" tabindex="-1"></a><span class="fu">var</span> mu;</span>
<span id="cb223-129"><a href="#cb223-129" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-4.8" class="level3">
<h3 class="anchored" data-anchor-id="table-4.8">Table 4.8</h3>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-42-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-42-1" role="tab" aria-controls="tabset-42-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-42-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-42-2" role="tab" aria-controls="tabset-42-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-42-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-42-1-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.8_4ece66c36ab25a46067f4772eba2625c">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>bmt<span class="sc">$</span>age10<span class="ot">&lt;-</span>bmt<span class="sc">$</span>age<span class="sc">/</span><span class="dv">10</span></span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">coxph</span>(<span class="fu">Surv</span>(intxrel, rel <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> bmonly <span class="sc">+</span> all <span class="sc">+</span> age, <span class="at">data =</span> bmt, </span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">ties =</span> <span class="st">"breslow"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(intxrel, rel == 1) ~ bmonly + all + age, 
    data = bmt, ties = "breslow")

  n= 2009, number of events= 259 

            coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
bmonly -0.107627  0.897962  0.134487 -0.800    0.424    
all     0.548871  1.731297  0.129307  4.245 2.19e-05 ***
age    -0.004487  0.995523  0.004440 -1.011    0.312    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

       exp(coef) exp(-coef) lower .95 upper .95
bmonly    0.8980     1.1136    0.6899     1.169
all       1.7313     0.5776    1.3437     2.231
age       0.9955     1.0045    0.9869     1.004

Concordance= 0.576  (se = 0.018 )
Likelihood ratio test= 20.61  on 3 df,   p=1e-04
Wald test            = 21.57  on 3 df,   p=8e-05
Score (logrank) test = 22.12  on 3 df,   p=6e-05</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">coxph</span>(<span class="fu">Surv</span>(intxrel, rel <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> bmonly <span class="sc">+</span> all <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">cluster</span>(team), </span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> bmt, </span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">ties =</span> <span class="st">"breslow"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(intxrel, rel == 1) ~ bmonly + all + age, 
    data = bmt, ties = "breslow", cluster = team)

  n= 2009, number of events= 259 

            coef exp(coef)  se(coef) robust se      z Pr(&gt;|z|)   
bmonly -0.107627  0.897962  0.134487  0.137880 -0.781   0.4350   
all     0.548871  1.731297  0.129307  0.173916  3.156   0.0016 **
age    -0.004487  0.995523  0.004440  0.007486 -0.599   0.5489   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

       exp(coef) exp(-coef) lower .95 upper .95
bmonly    0.8980     1.1136    0.6853     1.177
all       1.7313     0.5776    1.2312     2.434
age       0.9955     1.0045    0.9810     1.010

Concordance= 0.576  (se = 0.022 )
Likelihood ratio test= 20.61  on 3 df,   p=1e-04
Wald test            = 16.34  on 3 df,   p=0.001
Score (logrank) test = 22.12  on 3 df,   p=6e-05,   Robust = 13.19  p=0.004

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Relapse-free survival</span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">coxph</span>(<span class="fu">Surv</span>(intxrel, state0 <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> bmonly <span class="sc">+</span> all <span class="sc">+</span> age, <span class="at">data =</span> bmt, </span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">ties =</span> <span class="st">"breslow"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(intxrel, state0 != 0) ~ bmonly + all + age, 
    data = bmt, ties = "breslow")

  n= 2009, number of events= 764 

            coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
bmonly -0.161079  0.851225  0.077445 -2.080   0.0375 *  
all     0.454636  1.575599  0.077733  5.849 4.95e-09 ***
age     0.016917  1.017061  0.002588  6.537 6.28e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

       exp(coef) exp(-coef) lower .95 upper .95
bmonly    0.8512     1.1748    0.7313    0.9908
all       1.5756     0.6347    1.3529    1.8349
age       1.0171     0.9832    1.0119    1.0222

Concordance= 0.588  (se = 0.011 )
Likelihood ratio test= 81.95  on 3 df,   p=&lt;2e-16
Wald test            = 81.52  on 3 df,   p=&lt;2e-16
Score (logrank) test = 82.07  on 3 df,   p=&lt;2e-16</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">coxph</span>(<span class="fu">Surv</span>(intxrel, state0 <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> bmonly <span class="sc">+</span> all <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">cluster</span>(team), </span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> bmt, </span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">ties =</span> <span class="st">"breslow"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(intxrel, state0 != 0) ~ bmonly + all + age, 
    data = bmt, ties = "breslow", cluster = team)

  n= 2009, number of events= 764 

            coef exp(coef)  se(coef) robust se      z Pr(&gt;|z|)    
bmonly -0.161079  0.851225  0.077445  0.077240 -2.085    0.037 *  
all     0.454636  1.575599  0.077733  0.078077  5.823 5.78e-09 ***
age     0.016917  1.017061  0.002588  0.003328  5.083 3.71e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

       exp(coef) exp(-coef) lower .95 upper .95
bmonly    0.8512     1.1748    0.7316    0.9904
all       1.5756     0.6347    1.3520    1.8361
age       1.0171     0.9832    1.0104    1.0237

Concordance= 0.588  (se = 0.013 )
Likelihood ratio test= 81.95  on 3 df,   p=&lt;2e-16
Wald test            = 52.58  on 3 df,   p=2e-11
Score (logrank) test = 82.07  on 3 df,   p=&lt;2e-16,   Robust = 47.68  p=2e-10

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="co"># overall survival</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">coxph</span>(<span class="fu">Surv</span>(intxsurv, dead <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> bmonly <span class="sc">+</span> all <span class="sc">+</span> age, <span class="at">data =</span> bmt, </span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">ties =</span> <span class="st">"breslow"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(intxsurv, dead != 0) ~ bmonly + all + age, 
    data = bmt, ties = "breslow")

  n= 2009, number of events= 737 

            coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
bmonly -0.160104  0.852055  0.079035 -2.026   0.0428 *  
all     0.405480  1.500022  0.079556  5.097 3.45e-07 ***
age     0.017286  1.017437  0.002636  6.558 5.45e-11 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

       exp(coef) exp(-coef) lower .95 upper .95
bmonly    0.8521     1.1736    0.7298    0.9948
all       1.5000     0.6667    1.2835    1.7531
age       1.0174     0.9829    1.0122    1.0227

Concordance= 0.59  (se = 0.011 )
Likelihood ratio test= 76.65  on 3 df,   p=&lt;2e-16
Wald test            = 76.05  on 3 df,   p=&lt;2e-16
Score (logrank) test = 76.57  on 3 df,   p=&lt;2e-16</code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb234"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">coxph</span>(<span class="fu">Surv</span>(intxsurv, dead <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> bmonly <span class="sc">+</span> all <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">cluster</span>(team), </span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> bmt, </span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">ties =</span> <span class="st">"breslow"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(intxsurv, dead != 0) ~ bmonly + all + age, 
    data = bmt, ties = "breslow", cluster = team)

  n= 2009, number of events= 737 

            coef exp(coef)  se(coef) robust se      z Pr(&gt;|z|)    
bmonly -0.160104  0.852055  0.079035  0.080788 -1.982   0.0475 *  
all     0.405480  1.500022  0.079556  0.077594  5.226 1.74e-07 ***
age     0.017286  1.017437  0.002636  0.003339  5.177 2.26e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

       exp(coef) exp(-coef) lower .95 upper .95
bmonly    0.8521     1.1736    0.7273    0.9982
all       1.5000     0.6667    1.2884    1.7464
age       1.0174     0.9829    1.0108    1.0241

Concordance= 0.59  (se = 0.013 )
Likelihood ratio test= 76.65  on 3 df,   p=&lt;2e-16
Wald test            = 48.78  on 3 df,   p=1e-10
Score (logrank) test = 76.57  on 3 df,   p=&lt;2e-16,   Robust = 45.26  p=8e-10

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
</div>
</div>
<div id="tabset-42-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-42-2-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.8-sas_a9d13a0ff4f60f0d20b12efcffa7eee5">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Relapse, relapse-free and overall survival</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a><span class="co">   without and with adjustment for center */</span></span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bmt;</span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a>    class bmonly(ref=<span class="st">"0"</span>) all(ref=<span class="st">"0"</span>);</span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> intxrel*rel(<span class="dv">0</span>)=bmonly all age;</span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bmt covs(aggregate);</span>
<span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a>    class bmonly(ref=<span class="st">"0"</span>) all(ref=<span class="st">"0"</span>) team;</span>
<span id="cb236-9"><a href="#cb236-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> intxrel*rel(<span class="dv">0</span>)=bmonly all age;</span>
<span id="cb236-10"><a href="#cb236-10" aria-hidden="true" tabindex="-1"></a>    id team;</span>
<span id="cb236-11"><a href="#cb236-11" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb236-12"><a href="#cb236-12" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bmt;</span>
<span id="cb236-13"><a href="#cb236-13" aria-hidden="true" tabindex="-1"></a>    class bmonly(ref=<span class="st">"0"</span>) all(ref=<span class="st">"0"</span>);</span>
<span id="cb236-14"><a href="#cb236-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> intxrel*state0(<span class="dv">0</span>)=bmonly all age;</span>
<span id="cb236-15"><a href="#cb236-15" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb236-16"><a href="#cb236-16" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bmt covs(aggregate);</span>
<span id="cb236-17"><a href="#cb236-17" aria-hidden="true" tabindex="-1"></a>    class bmonly(ref=<span class="st">"0"</span>) all(ref=<span class="st">"0"</span>);</span>
<span id="cb236-18"><a href="#cb236-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> intxrel*state0(<span class="dv">0</span>)=bmonly all age;</span>
<span id="cb236-19"><a href="#cb236-19" aria-hidden="true" tabindex="-1"></a>    id team;</span>
<span id="cb236-20"><a href="#cb236-20" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb236-21"><a href="#cb236-21" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bmt;</span>
<span id="cb236-22"><a href="#cb236-22" aria-hidden="true" tabindex="-1"></a>    class bmonly(ref=<span class="st">"0"</span>) all(ref=<span class="st">"0"</span>);</span>
<span id="cb236-23"><a href="#cb236-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> intxsurv*dead(<span class="dv">0</span>)=bmonly all age;</span>
<span id="cb236-24"><a href="#cb236-24" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb236-25"><a href="#cb236-25" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bmt covs(aggregate);</span>
<span id="cb236-26"><a href="#cb236-26" aria-hidden="true" tabindex="-1"></a>    class bmonly(ref=<span class="st">"0"</span>) all(ref=<span class="st">"0"</span>);</span>
<span id="cb236-27"><a href="#cb236-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> intxsurv*dead(<span class="dv">0</span>)=bmonly all age;</span>
<span id="cb236-28"><a href="#cb236-28" aria-hidden="true" tabindex="-1"></a>    id team;</span>
<span id="cb236-29"><a href="#cb236-29" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="table-4.11" class="level3">
<h3 class="anchored" data-anchor-id="table-4.11">Table 4.11</h3>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Still missing to make double data set for R - do we not have this somewhere else?</p>
</div>
</div>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-43-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-43-1" role="tab" aria-controls="tabset-43-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-43-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-43-2" role="tab" aria-controls="tabset-43-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-43-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-43-1-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.11_52c5e7171490b0993b796c41dccb925b">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Relapse-free survival </span></span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(intxrel, state0 <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">~</span> bmonly <span class="sc">+</span> all <span class="sc">+</span> age10, <span class="at">data=</span>bmt, <span class="at">ties=</span><span class="st">"breslow"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(intxrel, state0 &gt; 0) ~ bmonly + all + age10, 
    data = bmt, ties = "breslow")

           coef exp(coef) se(coef)      z        p
bmonly -0.16108   0.85122  0.07745 -2.080   0.0375
all     0.45464   1.57560  0.07773  5.849 4.95e-09
age10   0.16917   1.18432  0.02588  6.537 6.28e-11

Likelihood ratio test=81.95  on 3 df, p=&lt; 2.2e-16
n= 2009, number of events= 764 </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Overall survival</span></span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(intxsurv, dead <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> bmonly <span class="sc">+</span> all <span class="sc">+</span> age10, <span class="at">data=</span>bmt, <span class="at">ties=</span><span class="st">"breslow"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(intxsurv, dead != 0) ~ bmonly + all + age10, 
    data = bmt, ties = "breslow")

           coef exp(coef) se(coef)      z        p
bmonly -0.16010   0.85206  0.07904 -2.026   0.0428
all     0.40548   1.50002  0.07956  5.097 3.45e-07
age10   0.17286   1.18871  0.02636  6.558 5.45e-11

Likelihood ratio test=76.65  on 3 df, p=&lt; 2.2e-16
n= 2009, number of events= 737 </code></pre>
</div>
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>bmt1 <span class="ot">&lt;-</span> bmt</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>bmt1<span class="sc">$</span>gvhdny <span class="ot">&lt;-</span> bmt<span class="sc">$</span>gvhd</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>bmt1<span class="sc">$</span>nytgvhd <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bmt1<span class="sc">$</span>gvhdny <span class="sc">==</span> <span class="dv">1</span>, bmt1<span class="sc">$</span>tgvhd, bmt1<span class="sc">$</span>intxsurv)</span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a>bmt1<span class="sc">$</span>gvhdny <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bmt1<span class="sc">$</span>dead <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, bmt1<span class="sc">$</span>gvhdny)</span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a><span class="co"># gvhd free survival</span></span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(nytgvhd, gvhdny <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">~</span> bmonly <span class="sc">+</span> all <span class="sc">+</span> age10, <span class="at">data=</span>bmt1, <span class="at">ties=</span><span class="st">"breslow"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(nytgvhd, gvhdny != 0) ~ bmonly + all + age10, 
    data = bmt1, ties = "breslow")

           coef exp(coef) se(coef)      z        p
bmonly -0.26024   0.77086  0.05930 -4.388 1.14e-05
all     0.29235   1.33958  0.06005  4.869 1.12e-06
age10   0.11699   1.12410  0.01936  6.043 1.51e-09

Likelihood ratio test=97.36  on 3 df, p=&lt; 2.2e-16
n= 2009, number of events= 1324 </code></pre>
</div>
</div>
</div>
<div id="tabset-43-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-43-2-tab">
<div class="cell" data-hash="Ch4_cache/html/table-4.11-sas_1180e7372a40317d78b2d3cca66805d8">
<details>
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> double02; <span class="kw">set</span> bmt; </span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* joint analysis of relapse-free and overall survival */</span></span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>    version=<span class="dv">1</span>; dc=state0&gt;<span class="dv">0</span>; <span class="fu">time</span>=intxrel; gsource0=bmonly; gsource2=<span class="dv">0</span>;</span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>    disease0=all; disease2=<span class="dv">0</span>; age0=age; age2=<span class="dv">0</span>; <span class="kw">output</span>;</span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>    version=<span class="dv">2</span>; dc=dead; <span class="fu">time</span>=intxsurv; gsource2=bmonly; gsource0=<span class="dv">0</span>;</span>
<span id="cb243-6"><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a>    disease2=all; disease0=<span class="dv">0</span>; age2=age; age0=<span class="dv">0</span>; <span class="kw">output</span>;</span>
<span id="cb243-7"><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb243-8"><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=double02 covs(aggregate);</span>
<span id="cb243-9"><a href="#cb243-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* NB bmonly and all are now binary quantitative */</span></span>
<span id="cb243-10"><a href="#cb243-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*dc(<span class="dv">0</span>)=gsource0 gsource2 disease0 disease2 age0 age2 / corrb;</span>
<span id="cb243-11"><a href="#cb243-11" aria-hidden="true" tabindex="-1"></a>    strata version;</span>
<span id="cb243-12"><a href="#cb243-12" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb243-13"><a href="#cb243-13" aria-hidden="true" tabindex="-1"></a>    gs:  test gsource0=gsource2;</span>
<span id="cb243-14"><a href="#cb243-14" aria-hidden="true" tabindex="-1"></a>    dis: test disease0=disease2;</span>
<span id="cb243-15"><a href="#cb243-15" aria-hidden="true" tabindex="-1"></a>    a:   test age0=age2;</span>
<span id="cb243-16"><a href="#cb243-16" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb243-17"><a href="#cb243-17" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=double02 covs(aggregate);</span>
<span id="cb243-18"><a href="#cb243-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*dc(<span class="dv">0</span>)=bmonly disease0 disease2 age;</span>
<span id="cb243-19"><a href="#cb243-19" aria-hidden="true" tabindex="-1"></a>    strata version;</span>
<span id="cb243-20"><a href="#cb243-20" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb243-21"><a href="#cb243-21" aria-hidden="true" tabindex="-1"></a>    dis: test disease0=disease2;</span>
<span id="cb243-22"><a href="#cb243-22" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb243-23"><a href="#cb243-23" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> bmt; <span class="kw">set</span> bmt;</span>
<span id="cb243-24"><a href="#cb243-24" aria-hidden="true" tabindex="-1"></a>    gvhdny=gvhd; </span>
<span id="cb243-25"><a href="#cb243-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> gvhdny=<span class="dv">1</span> <span class="kw">then</span> nytgvhd=tgvhd;</span>
<span id="cb243-26"><a href="#cb243-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> gvhdny=<span class="dv">0</span> <span class="kw">then do</span>; nytgvhd=intxsurv; <span class="kw">if</span> dead=<span class="dv">1</span> <span class="kw">then</span> gvhdny=<span class="dv">1</span><span class="kw">; end</span>; </span>
<span id="cb243-27"><a href="#cb243-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* NB her tller bde GvHD og dd uden GvHD med */</span></span>
<span id="cb243-28"><a href="#cb243-28" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb243-29"><a href="#cb243-29" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> triple02G; <span class="kw">set</span> bmt; </span>
<span id="cb243-30"><a href="#cb243-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* joint analysis of relapse-free, GvHD-free and overall survival */</span></span>
<span id="cb243-31"><a href="#cb243-31" aria-hidden="true" tabindex="-1"></a>    version=<span class="dv">1</span>; dc=state0&gt;<span class="dv">0</span>; <span class="fu">time</span>=intxrel; gsource0=bmonly; </span>
<span id="cb243-32"><a href="#cb243-32" aria-hidden="true" tabindex="-1"></a>    gsource2=<span class="dv">0</span>; gsourceG=<span class="dv">0</span>;</span>
<span id="cb243-33"><a href="#cb243-33" aria-hidden="true" tabindex="-1"></a>    disease0=all; disease2=<span class="dv">0</span>; diseaseG=<span class="dv">0</span>; age0=age; age2=<span class="dv">0</span>; ageG=<span class="dv">0</span>; <span class="kw">output</span>;</span>
<span id="cb243-34"><a href="#cb243-34" aria-hidden="true" tabindex="-1"></a>    version=<span class="dv">2</span>; dc=dead; <span class="fu">time</span>=intxsurv; gsource2=bmonly; </span>
<span id="cb243-35"><a href="#cb243-35" aria-hidden="true" tabindex="-1"></a>    gsource0=<span class="dv">0</span>; gsourceG=<span class="dv">0</span>;</span>
<span id="cb243-36"><a href="#cb243-36" aria-hidden="true" tabindex="-1"></a>    disease2=all; disease0=<span class="dv">0</span>; diseaseG=<span class="dv">0</span>; age2=age; age0=<span class="dv">0</span>; ageG=<span class="dv">0</span>; <span class="kw">output</span>;</span>
<span id="cb243-37"><a href="#cb243-37" aria-hidden="true" tabindex="-1"></a>    version=<span class="dv">3</span>; dc=gvhdny; <span class="fu">time</span>=nytgvhd; gsourceG=bmonly; gsource0=<span class="dv">0</span>; gsource2=<span class="dv">0</span>;</span>
<span id="cb243-38"><a href="#cb243-38" aria-hidden="true" tabindex="-1"></a>    diseaseG=all; disease0=<span class="dv">0</span>; disease2=<span class="dv">0</span>; ageG=age; age0=<span class="dv">0</span>; age2=<span class="dv">0</span>; <span class="kw">output</span>;</span>
<span id="cb243-39"><a href="#cb243-39" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb243-40"><a href="#cb243-40" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=triple02G covs(aggregate) covout outest=params3;</span>
<span id="cb243-41"><a href="#cb243-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* bmonly and all binary quatitative*/</span></span>
<span id="cb243-42"><a href="#cb243-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="fu">time</span>*dc(<span class="dv">0</span>)=gsource0 gsource2 gsourceG disease0 disease2 diseaseG</span>
<span id="cb243-43"><a href="#cb243-43" aria-hidden="true" tabindex="-1"></a>    age0 age2 ageG;</span>
<span id="cb243-44"><a href="#cb243-44" aria-hidden="true" tabindex="-1"></a>    strata version;</span>
<span id="cb243-45"><a href="#cb243-45" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb243-46"><a href="#cb243-46" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<p>The SAS solutions are available as single files for download:</p>
<ul>
<li><p><a href="./SAS/chapter4_solutions_cphholter.sas">Exercises 4.1 - 4.7 and 4.10 (The Copenhagen Holter study)</a></p></li>
<li><p><a href="./SAS/chapter4_solutions_bissau.sas">Exercise 4.8 (Guinea-Bissau childhood vaccination study)</a></p></li>
<li><p><a href="./SAS/chapter4_solutions_affective.sas">Exercise 4.9 (Recurrent episodes in affective disorders)</a></p></li>
</ul>
<section id="exercise-4.1" class="level3">
<h3 class="anchored" data-anchor-id="exercise-4.1">Exercise 4.1</h3>
<p><em>Consider the data from the Copenhagen Holter study and estimate the probabilities of stroke-free survival for subjects with or without ESVEA using the Kaplan-Meier estimator.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-44-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-44-1" role="tab" aria-controls="tabset-44-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-44-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-44-2" role="tab" aria-controls="tabset-44-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-44-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-44-1-tab">
<p>The data should be loaded as <strong>chs_data</strong></p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-115_976f1e7abcd060449dd9315350f247db">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>chs_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/cphholter.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We then load the relevant packages</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-116_f47cb803230311f38d29d7885e148115">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co">#Data manipulations and plots</span></span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival) <span class="co">#Core survival analysis routines</span></span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer) <span class="co">#Plots of survival curves</span></span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survRM2) <span class="co">#RMST </span></span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mstate) <span class="co">#probtrans, ELOS</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, we will convert the time variables to years and add a time variable and status indicator for the composite end-point stroke-free survival.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-117_a1ebbdb727de04701c740f1ec3b90b55">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>chs_data <span class="ot">&lt;-</span> chs_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">timeafib =</span> timeafib<span class="sc">/</span><span class="fl">365.25</span>,</span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">timestroke =</span> timestroke<span class="sc">/</span><span class="fl">365.25</span>,</span>
<span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">timedeath =</span> timedeath<span class="sc">/</span><span class="fl">365.25</span>,</span>
<span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">timestrokeordeath =</span> <span class="fu">ifelse</span>(stroke <span class="sc">==</span> <span class="dv">1</span>, timestroke, timedeath),</span>
<span id="cb246-5"><a href="#cb246-5" aria-hidden="true" tabindex="-1"></a>                                <span class="at">strokeordeath =</span> <span class="fu">ifelse</span>(stroke <span class="sc">==</span><span class="dv">1</span>, <span class="dv">1</span>, death))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To estimate the probability of stroke-free survival for subjects with or without ESVEA using the Kaplan-Meier estimator we use the <strong>survfit</strong> function from the <em>survival</em> package.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-118_a48a6bd4bcca0bd6e665c9a72ea9cfeb">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Kaplan-Meier estimate of the survival functions</span></span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>km41 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(timestrokeordeath, strokeordeath) <span class="sc">~</span> esvea, <span class="at">data =</span> chs_data)</span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>kmdata41 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> km41<span class="sc">$</span>time,</span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">surv =</span> km41<span class="sc">$</span>surv, </span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">esvea =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fu">names</span>(km41<span class="sc">$</span>strata)[<span class="dv">1</span>], km41<span class="sc">$</span>strata[<span class="dv">1</span>]),</span>
<span id="cb247-7"><a href="#cb247-7" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">rep</span>(<span class="fu">names</span>(km41<span class="sc">$</span>strata)[<span class="dv">2</span>], km41<span class="sc">$</span>strata[<span class="dv">2</span>])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then, we can plot the Kaplan-Meier estimates of the survival probabilities against time.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-119_4d87c94f1e9d1ec416c09d080edaaf6a">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the Kaplan-Meier estimate</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>(fig41 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> kmdata41) <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> surv, <span class="at">linetype =</span> esvea), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>          <span class="fu">scale_linetype_discrete</span>(<span class="st">"ESVEA"</span>, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"0"</span>, <span class="st">"1"</span>)) <span class="sc">+</span> </span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>          <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>          <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">ylab</span>(<span class="st">"Probability of stroke-free survival"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-119-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-44-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-44-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-120_faa222255d9bbecd2173df37cabdd241">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb249"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="co">* We must first load the data;</span></span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> import out = chs_<span class="kw">data</span></span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>    datafile = <span class="st">'data/cphholter.csv'</span></span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a>    dbms= csv <span class="kw">replace</span>;</span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a>    getnames=yes;</span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb249-7"><a href="#cb249-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-8"><a href="#cb249-8" aria-hidden="true" tabindex="-1"></a><span class="co">* We will convert the time variables (timeafib, timestroke, and timedeath) from days to years;</span></span>
<span id="cb249-9"><a href="#cb249-9" aria-hidden="true" tabindex="-1"></a><span class="co">* Furthermore, we add variables for the composite end-point of stroke or death without stroke;</span></span>
<span id="cb249-10"><a href="#cb249-10" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> chs_<span class="kw">data</span>;</span>
<span id="cb249-11"><a href="#cb249-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> chs_<span class="kw">data</span>;</span>
<span id="cb249-12"><a href="#cb249-12" aria-hidden="true" tabindex="-1"></a>    timeafib = timeafib/<span class="dv">365.25</span>;</span>
<span id="cb249-13"><a href="#cb249-13" aria-hidden="true" tabindex="-1"></a>    timestroke = timestroke/<span class="dv">365.25</span>;</span>
<span id="cb249-14"><a href="#cb249-14" aria-hidden="true" tabindex="-1"></a>    timedeath = timedeath/<span class="dv">365.25</span>;</span>
<span id="cb249-15"><a href="#cb249-15" aria-hidden="true" tabindex="-1"></a>    timestrokeordeath = timedeath;</span>
<span id="cb249-16"><a href="#cb249-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> stroke = <span class="dv">1</span> <span class="kw">then</span> timestrokeordeath = timestroke;</span>
<span id="cb249-17"><a href="#cb249-17" aria-hidden="true" tabindex="-1"></a>    strokeordeath = death;</span>
<span id="cb249-18"><a href="#cb249-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> stroke = <span class="dv">1</span> <span class="kw">then</span> strokeordeath = <span class="dv">1</span>;</span>
<span id="cb249-19"><a href="#cb249-19" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb249-20"><a href="#cb249-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-21"><a href="#cb249-21" aria-hidden="true" tabindex="-1"></a><span class="co">* We estimate the Kaplan-Meier survival function for subjects with or without ESVEA with the phreg procedure where 'esvea' is added</span></span>
<span id="cb249-22"><a href="#cb249-22" aria-hidden="true" tabindex="-1"></a><span class="co">  in the strata statement. The result is saved as 'survdat'.;</span></span>
<span id="cb249-23"><a href="#cb249-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-24"><a href="#cb249-24" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"4.1: Stroke-free survival probabilities estimated with the Kaplan-Meier estimator"</span>;</span>
<span id="cb249-25"><a href="#cb249-25" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=chs_<span class="kw">data</span>;</span>
<span id="cb249-26"><a href="#cb249-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timestrokeordeath*strokeordeath(<span class="dv">0</span>)=;</span>
<span id="cb249-27"><a href="#cb249-27" aria-hidden="true" tabindex="-1"></a>    strata esvea;</span>
<span id="cb249-28"><a href="#cb249-28" aria-hidden="true" tabindex="-1"></a>    baseline out=survdat survival=km;</span>
<span id="cb249-29"><a href="#cb249-29" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb249-30"><a href="#cb249-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-31"><a href="#cb249-31" aria-hidden="true" tabindex="-1"></a><span class="co">* Then the estimates are plotted using the gplot procedure;</span></span>
<span id="cb249-32"><a href="#cb249-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-33"><a href="#cb249-33" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=survdat;</span>
<span id="cb249-34"><a href="#cb249-34" aria-hidden="true" tabindex="-1"></a>plot km*timestrokeordeath=esvea/haxis=axis1 vaxis=axis2;</span>
<span id="cb249-35"><a href="#cb249-35" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">16</span> <span class="kw">by</span> <span class="dv">2</span> <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb249-36"><a href="#cb249-36" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Survival probability'</span>);</span>
<span id="cb249-37"><a href="#cb249-37" aria-hidden="true" tabindex="-1"></a>    symbol1 i=stepjl c=red;</span>
<span id="cb249-38"><a href="#cb249-38" aria-hidden="true" tabindex="-1"></a>    symbol2 i=stepjl c=blue;</span>
<span id="cb249-39"><a href="#cb249-39" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb249-40"><a href="#cb249-40" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="exercise-4.2" class="level3">
<h3 class="anchored" data-anchor-id="exercise-4.2">Exercise 4.2</h3>
<p><em>Consider the Cox model for stroke-free survival in the Copenhagen Holter study including the covariates ESVEA, sex, age, and systolic blood pressure (Exercise 2.4).</em></p>
<section id="section" class="level4">
<h4 class="anchored" data-anchor-id="section">1.</h4>
<p><em>Estimate the survival functions for a female subject aged 65 years and with systolic blood pressure equal to 150 mmHg  either with or without ESVEA.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-45-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-45-1" role="tab" aria-controls="tabset-45-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-45-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-45-2" role="tab" aria-controls="tabset-45-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-45-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-45-1-tab">
<p>The Cox model including ESVEA, sex, age, and systolic blood pressure is fitted using the <strong>coxph</strong> function from the <em>survival</em> package as first done in exercise 2.4.1.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-121_83e55b958464dd0cfb4b1cfddc73deae">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model for the composite end-point stroke or death with covariates ESVEA, sex, age, and systolic blood pressure</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a>cox241 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(timestrokeordeath, strokeordeath) <span class="sc">~</span> esvea <span class="sc">+</span> sex <span class="sc">+</span> age <span class="sc">+</span> sbp , <span class="at">data =</span> chs_data, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox241)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(timestrokeordeath, strokeordeath) ~ esvea + 
    sex + age + sbp, data = chs_data, method = "breslow")

  n= 675, number of events= 285 
   (3 observations deleted due to missingness)

          coef exp(coef) se(coef)     z Pr(&gt;|z|)    
esvea 0.318284  1.374767 0.152587 2.086   0.0370 *  
sex   0.577585  1.781731 0.126946 4.550 5.37e-06 ***
age   0.076658  1.079673 0.009362 8.189 2.64e-16 ***
sbp   0.005152  1.005165 0.002438 2.113   0.0346 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

      exp(coef) exp(-coef) lower .95 upper .95
esvea     1.375     0.7274     1.019     1.854
sex       1.782     0.5613     1.389     2.285
age       1.080     0.9262     1.060     1.100
sbp       1.005     0.9949     1.000     1.010

Concordance= 0.672  (se = 0.016 )
Likelihood ratio test= 99.45  on 4 df,   p=&lt;2e-16
Wald test            = 104.1  on 4 df,   p=&lt;2e-16
Score (logrank) test = 110  on 4 df,   p=&lt;2e-16</code></pre>
</div>
</div>
<p>We will now estimate the survival functions for a 65-year-old female (sex = 0) with a systolic blood pressure of 150mmHg with or without ESVEA. The values of the covariates are stored in the data frame <strong>covar</strong>. The survival function is then found using the <strong>survfit</strong> function with the formula argument given by the Cox model and the newdata argument given by the data frame <strong>covar</strong>.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-122_6c02e5d0f993ef5d91f16803e9c9b9b4">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Defining the covariates</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>covar <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">esvea =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">sex =</span> <span class="dv">0</span>, <span class="at">age =</span> <span class="dv">65</span>, <span class="at">sbp =</span> <span class="dv">150</span>)</span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate of the survival function given the covariate values</span></span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a>surv421 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox241, <span class="at">newdata =</span> covar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, the survival functions are plotted</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-123_b36adb9774759a9724184fcaacc139f2">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the predicted survival probabilities.</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>(plot421 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> surv421<span class="sc">$</span>time, <span class="at">y =</span> surv421<span class="sc">$</span>surv[,<span class="dv">1</span>], <span class="at">color =</span> <span class="st">"ESVEA=0"</span>)) <span class="sc">+</span></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> surv421<span class="sc">$</span>time, <span class="at">y =</span> surv421<span class="sc">$</span>surv[,<span class="dv">2</span>], <span class="at">color =</span> <span class="st">"ESVEA=1"</span>)) <span class="sc">+</span></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title=</span><span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Stroke-free survival for a 65-year-old woman with a sbp of 150mmHg"</span>)  <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-123-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-45-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-45-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-124_6c16ce624c28c504e5027b7d52aa83a8">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="co">* To estimate the stroke-free survival functions for a 65-year old woman with a systolic blood pressure of 150mmHg with or without</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a><span class="co">  ESVEA we will first create a data frame 'cov' with the desired values of the covariate.;</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> cov;</span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a>    esvea = <span class="dv">0</span>; sex = <span class="dv">0</span>; age = <span class="dv">65</span>; sbp = <span class="dv">150</span>; <span class="kw">output</span>;</span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a>    esvea = <span class="dv">1</span>; sex = <span class="dv">0</span>; age = <span class="dv">65</span>; sbp = <span class="dv">150</span>; <span class="kw">output</span>;</span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a><span class="co">* Then, a Cox model including ESVEA, sex, age, and systolic blood pressure is fitted with the phreg procedure and the stroke-free</span></span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a><span class="co">  survival functions for subjects with values according to 'cov' are saved as 'survdata'.;</span></span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"4.2: Stroke-free survival for a 65-year old woman with sbp = 150mmHg"</span>;</span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=chs_<span class="kw">data</span>;</span>
<span id="cb254-14"><a href="#cb254-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timestrokeordeath*strokeordeath(<span class="dv">0</span>)=esvea sex age sbp;</span>
<span id="cb254-15"><a href="#cb254-15" aria-hidden="true" tabindex="-1"></a>    baseline out=survdata survival=surv covariates = cov;</span>
<span id="cb254-16"><a href="#cb254-16" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb254-17"><a href="#cb254-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-18"><a href="#cb254-18" aria-hidden="true" tabindex="-1"></a><span class="co">* Finally, the survival functions are plotted using the gplot procedure;</span></span>
<span id="cb254-19"><a href="#cb254-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-20"><a href="#cb254-20" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=survdata;</span>
<span id="cb254-21"><a href="#cb254-21" aria-hidden="true" tabindex="-1"></a>    plot surv*timestrokeordeath=esvea/haxis=axis1 vaxis=axis2;</span>
<span id="cb254-22"><a href="#cb254-22" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">16</span> <span class="kw">by</span> <span class="dv">2</span> <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb254-23"><a href="#cb254-23" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Stroke-free survival probability'</span>);</span>
<span id="cb254-24"><a href="#cb254-24" aria-hidden="true" tabindex="-1"></a>    symbol1  i=stepjl c=blue;</span>
<span id="cb254-25"><a href="#cb254-25" aria-hidden="true" tabindex="-1"></a>    symbol2  i=stepjl c=red;</span>
<span id="cb254-26"><a href="#cb254-26" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb254-27"><a href="#cb254-27" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="section-1" class="level4">
<h4 class="anchored" data-anchor-id="section-1">2.</h4>
<p><em>Estimate the survival functions for patients with or without ESVEA using the g-formula.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-46-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-46-1" role="tab" aria-controls="tabset-46-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-46-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-46-2" role="tab" aria-controls="tabset-46-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-46-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-46-1-tab">
<p>To estimate the survival functions using the g-formula, two predictions are made for each subject, i: one setting ESVEA <span class="math inline">\((Z_1)\)</span> to 0, and one setting ESVEA to 1, while keeping the observed values of sex, age, and systolic blood pressure <span class="math inline">\((Z_2, Z_3, Z_4)\)</span>. The g-formula estimate is then</p>
<p><span class="math display">\[
\hat{S}_j(t) = \frac{1}{n}\sum_{i}\hat{S}(t|Z_1 = j, Z_{2i}, Z_{3i}, Z_{4i}), j = 0,1
\]</span> Thus, we will make two new data frames corresponding to the two settings, i.e.&nbsp;ESVEA = 0 (<strong>chs_covar0</strong>) or ESVEA = 1 (<strong>chs_covar1</strong>) and all other covariates equal to the observed values. Then, the two predictions of the survival functions for each subject are found using the <strong>survfit</strong> function, and the average of these predictions with or without ESVEA are taken to obtaian the g-formula estimate.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-125_96c2520829762cb00e3210e835b566d6">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating data sets with or without ESVEA while keeping the observed values of sex, age, and sbp for all subjects</span></span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>chs_covar0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">esvea =</span> <span class="dv">0</span>, <span class="at">sex =</span> chs_data<span class="sc">$</span>sex, <span class="at">age =</span> chs_data<span class="sc">$</span>age, <span class="at">sbp =</span> chs_data<span class="sc">$</span>sbp)</span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a>chs_covar1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">esvea =</span> <span class="dv">1</span>, <span class="at">sex =</span> chs_data<span class="sc">$</span>sex, <span class="at">age =</span> chs_data<span class="sc">$</span>age, <span class="at">sbp =</span> chs_data<span class="sc">$</span>sbp)</span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicting the survival functions for all rows in chs_covar0 and chs_covar1</span></span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a>pred0_422 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox241, <span class="at">newdata =</span> chs_covar0)</span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a>pred1_422 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox241, <span class="at">newdata =</span> chs_covar1)</span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-9"><a href="#cb255-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Taking the average prediction at each transition time</span></span>
<span id="cb255-10"><a href="#cb255-10" aria-hidden="true" tabindex="-1"></a>surv0_422 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(pred0_422<span class="sc">$</span>surv, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb255-11"><a href="#cb255-11" aria-hidden="true" tabindex="-1"></a>surv1_422 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(pred1_422<span class="sc">$</span>surv, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The survival functions estimated using the g-formula are then plotted against time.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-126_2c8b246376fc7a366b176fcec0d0fced">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the predicted survival probabilities (g-formula).</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>(plot422 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> pred0_422<span class="sc">$</span>time, <span class="at">y =</span> surv0_422, <span class="at">color =</span> <span class="st">"ESVEA=0"</span>)) <span class="sc">+</span></span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span>pred1_422<span class="sc">$</span>time, <span class="at">y =</span> surv1_422, <span class="at">color =</span> <span class="st">"ESVEA=1"</span>)) <span class="sc">+</span>  <span class="fu">theme</span>(<span class="at">legend.title=</span><span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Probability"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Survival function for stroke-free survival (g-formula)"</span>)) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-126-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-46-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-46-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-127_21a1c432339a97c41b599b06bcb9ef12">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="co">* A Cox model including ESVEA, sex, age, and systolic blood pressure is fitted and 'diradj group = esvea' is added to obtain the</span></span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a><span class="co">  predicted survival functions for patients with or without ESVEA using the g-formula. The data is saved as 'gsurv'.;</span></span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"4.2: Cox model for the outcome stroke-free survival including ESVEA, sex, age, and systolic blood pressure"</span>;</span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=chs_<span class="kw">data</span>;</span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>    class esvea (ref = <span class="st">'0'</span>);</span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timestrokeordeath*strokeordeath(<span class="dv">0</span>)=esvea sex age sbp;</span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a>    baseline out=gsurv survival=surv / diradj <span class="kw">group</span>=esvea;</span>
<span id="cb257-9"><a href="#cb257-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb257-10"><a href="#cb257-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-11"><a href="#cb257-11" aria-hidden="true" tabindex="-1"></a><span class="co">* The survival functions are then plotted using the gplot procedure;</span></span>
<span id="cb257-12"><a href="#cb257-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-13"><a href="#cb257-13" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"4.2: Stroke-free survival probabilities estimated using the G-formula"</span>;</span>
<span id="cb257-14"><a href="#cb257-14" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=gsurv;</span>
<span id="cb257-15"><a href="#cb257-15" aria-hidden="true" tabindex="-1"></a>    plot surv*timestrokeordeath=esvea/haxis=axis1 vaxis=axis2;</span>
<span id="cb257-16"><a href="#cb257-16" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">16</span> <span class="kw">by</span> <span class="dv">2</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb257-17"><a href="#cb257-17" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Estimated survival function (g-formula)'</span>);</span>
<span id="cb257-18"><a href="#cb257-18" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=blue;</span>
<span id="cb257-19"><a href="#cb257-19" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=red;</span>
<span id="cb257-20"><a href="#cb257-20" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb257-21"><a href="#cb257-21" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-4.3" class="level3">
<h3 class="anchored" data-anchor-id="exercise-4.3">Exercise 4.3</h3>
<p><em>Consider the data from the Copenhagen Holter study and fit a linear model for the 3-year restricted mean time to the composite end-point stroke or death including ESVEA, sex, age, and systolic blood pressure.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-47-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-47-1" role="tab" aria-controls="tabset-47-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-47-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-47-2" role="tab" aria-controls="tabset-47-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-47-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-47-1-tab">
<p>We will use the <strong>rmst2</strong> function from the <em>survRM2</em> package to fit a linear model for the 3-year restricted mean time to the composite end-point stroke or death including ESVEA, sex, age, and systolic blood pressure. We must include the arguments time, status, arm, tau and covariates which in this case are <strong>timestrokeordeath</strong>, <strong>strokeordeath</strong>, <strong>esvea</strong>, <strong>3</strong> and <strong>sex,age, and systolic blood pressure</strong> respectively.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-128_fa607d44de41eb548e39a82d4f0082d6">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3-year restricted mean time to the composite end-point stroke or death</span></span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Attention must be restricted to subjects with complete covariate data (sbp).</span></span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>newchs <span class="ot">&lt;-</span> <span class="fu">subset</span>(chs_data,<span class="sc">!</span><span class="fu">is.na</span>(sbp))</span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a>rmst <span class="ot">&lt;-</span> <span class="fu">rmst2</span>(<span class="at">time =</span> newchs<span class="sc">$</span>timestrokeordeath, <span class="at">status =</span> newchs<span class="sc">$</span>strokeordeath, <span class="at">arm =</span> newchs<span class="sc">$</span>esvea, <span class="at">tau =</span> <span class="dv">3</span>,  <span class="at">covariates =</span> newchs[, <span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">17</span>)] )</span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>rmst<span class="sc">$</span>RMST.difference.adjusted</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                   coef     se(coef)          z          p     lower .95
intercept  3.3551746975 0.2078355430 16.1434115 0.00000000  2.9478245185
arm       -0.0273741987 0.0527081358 -0.5193543 0.60351367 -0.1306802466
sex       -0.0540324232 0.0352191476 -1.5341775 0.12498600 -0.1230606841
age       -0.0073221791 0.0028486997 -2.5703583 0.01015934 -0.0129055280
sbp        0.0005144224 0.0006748332  0.7622955 0.44588365 -0.0008082265
             upper .95
intercept  3.762524877
arm        0.075931849
sex        0.014995838
age       -0.001738830
sbp        0.001837071</code></pre>
</div>
</div>
<p>Thus, we obtain the following model for the 3-year restricted mean time to the composite end-point stroke or death</p>
<p><span class="math display">\[\varepsilon(3|Z) = 3.3552 -0.0274\cdot Z_1 -0.054\cdot Z_2 -0.0073\cdot Z_3 + 0.0005\cdot Z_4,\]</span></p>
<p>where <span class="math inline">\((Z_1,Z_2,Z_3,Z_4)\)</span> are ESVEA, sex, age, and systolic blood pressure.</p>
<p>We will finally estimate the 3-year resticted mean time to the composite end-point stroke or death for subjects with or without ESVEA non-parametrically using the area under the Kaplan-Meier curve. We use the object from Exercise 4.1.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-129_c5440b1f2953b375f1f6d9cbf490d97e">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(km41,<span class="at">rmean=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(timestrokeordeath, strokeordeath) ~ esvea, 
    data = chs_data)

          n events rmean* se(rmean) median 0.95LCL 0.95UCL
esvea=0 579    230   2.93    0.0151     NA      NA      NA
esvea=1  99     57   2.87    0.0487     11    8.93      NA
    * restricted mean with upper limit =  3 </code></pre>
</div>
</div>
</div>
<div id="tabset-47-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-47-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-130_106a1ed15b7c171e0068f40a500cc0ce">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="co">* We will estimate the 3-year restricted mean time survival to the composite end-point strokke or death including ESVEA, sex, age, </span></span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a><span class="co">  and systolic blood pressure using the rmstreg procedure. We specify 'tau = 3' in the rmstreg statement to obtain a 3 year time </span></span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a><span class="co">  limit and 'link = linear' in the model statement to get a linear model. NB: requires SAS STAT 15.1;</span></span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"4.3"</span>;</span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> rmstreg<span class="kw"> data</span>=chs_<span class="kw">data</span> tau=<span class="dv">3</span>;</span>
<span id="cb262-7"><a href="#cb262-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">model</span> timestrokeordeath*strokeordeath(<span class="dv">0</span>)=esvea sex age sbp / <span class="kw">link</span>=linear;</span>
<span id="cb262-8"><a href="#cb262-8" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb262-9"><a href="#cb262-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-10"><a href="#cb262-10" aria-hidden="true" tabindex="-1"></a><span class="co">* Thus, we obtain the following model for the 3-year restricted mean time to the composite end-point stroke or death</span></span>
<span id="cb262-11"><a href="#cb262-11" aria-hidden="true" tabindex="-1"></a><span class="co">  epsilon(3|Z) = 3.3552 - 0.0274*Z1 - 0.0540*Z2 - 0.0073*Z3 + 0.0005*Z4, where (Z1,Z2,Z3,Z4) are ESVEA, age, sex, and systolic blood </span></span>
<span id="cb262-12"><a href="#cb262-12" aria-hidden="true" tabindex="-1"></a><span class="co">  pressure;</span></span>
<span id="cb262-13"><a href="#cb262-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-14"><a href="#cb262-14" aria-hidden="true" tabindex="-1"></a><span class="co">* We will also present the non-parametric estimates. We restrict the data set at tau=3.  NB: requires SAS STAT 15.1;</span></span>
<span id="cb262-15"><a href="#cb262-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-16"><a href="#cb262-16" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> lifetest<span class="kw"> data</span>=chs_<span class="kw">data</span> rmst(tau=<span class="dv">3</span>);</span>
<span id="cb262-17"><a href="#cb262-17" aria-hidden="true" tabindex="-1"></a><span class="fu">time</span> timestrokeordeath*strokeordeath(<span class="dv">0</span>);</span>
<span id="cb262-18"><a href="#cb262-18" aria-hidden="true" tabindex="-1"></a>strata esvea;</span>
<span id="cb262-19"><a href="#cb262-19" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="exercise-4.4" class="level3">
<h3 class="anchored" data-anchor-id="exercise-4.4">Exercise 4.4</h3>
<p><em>Consider the Cox models for the cause-specific hazards for the outcomes stroke and death without stroke in the Copenhagen Holter study including ESVEA, sex, age, and systolic blood pressure (Exercise 2.7). Estimate (using plug-in) the cumulative incidences for both end-points for a female subject aged 65 years and with systolic blood pressure equal to 150 mmHg  either with or without ESVEA.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-48-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-48-1" role="tab" aria-controls="tabset-48-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-48-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-48-2" role="tab" aria-controls="tabset-48-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-48-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-48-1-tab">
<p>The cumulative incidence functions for cause <span class="math inline">\(h\)</span> for a subject with covariates <span class="math inline">\(Z\)</span> is calculated using the formula <span class="math inline">\(F_{h}(t|Z) = \int_0^t S(u|Z)\alpha_{h}(u|Z)du\)</span>, where <span class="math inline">\(S(u|Z) = \prod\limits_{j} \exp(-\int_0^u \alpha_j(x|Z) dx)\)</span>.</p>
<p>We will first fit Cox models for the cause-specific outcomes. For the outcome stroke we will use <strong>timestrokeordeath</strong> as time variable and <strong>stroke</strong> as status indicator in the <strong>Surv</strong> object. For the outcome death without stroke we will also use <strong>timestrokeordeath</strong> as time variable, but we must create a new status indicator, which will be named <strong>death_wo_stroke</strong>.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-131_9290bf69db92a4079be3b14f03d0c5be">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model with stroke as outcome</span></span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>cox44_stroke <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(timestrokeordeath, stroke) <span class="sc">~</span> esvea <span class="sc">+</span> sex <span class="sc">+</span> age <span class="sc">+</span> sbp , <span class="at">data =</span> chs_data)</span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox44_stroke)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(timestrokeordeath, stroke) ~ esvea + sex + 
    age + sbp, data = chs_data)

  n= 675, number of events= 72 
   (3 observations deleted due to missingness)

          coef exp(coef) se(coef)     z Pr(&gt;|z|)    
esvea 0.702407  2.018606 0.269968 2.602  0.00927 ** 
sex   0.491881  1.635389 0.248634 1.978  0.04789 *  
age   0.078980  1.082183 0.019054 4.145  3.4e-05 ***
sbp   0.011340  1.011404 0.004651 2.438  0.01477 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

      exp(coef) exp(-coef) lower .95 upper .95
esvea     2.019     0.4954     1.189     3.426
sex       1.635     0.6115     1.005     2.662
age       1.082     0.9241     1.043     1.123
sbp       1.011     0.9887     1.002     1.021

Concordance= 0.728  (se = 0.028 )
Likelihood ratio test= 41.22  on 4 df,   p=2e-08
Wald test            = 43.26  on 4 df,   p=9e-09
Score (logrank) test = 47.2  on 4 df,   p=1e-09</code></pre>
</div>
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Status indicator for death without stroke</span></span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a>chs_data<span class="sc">$</span>death_wo_stroke <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(chs_data<span class="sc">$</span>stroke <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, chs_data<span class="sc">$</span>death)</span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model with death without stroke as outcome</span></span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a>cox44_death <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="at">formula =</span> <span class="fu">Surv</span>(timestrokeordeath, death_wo_stroke) <span class="sc">~</span> esvea <span class="sc">+</span> sex <span class="sc">+</span> age <span class="sc">+</span> sbp , <span class="at">data =</span> chs_data)</span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox44_death)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(timestrokeordeath, death_wo_stroke) ~ esvea + 
    sex + age + sbp, data = chs_data)

  n= 675, number of events= 213 
   (3 observations deleted due to missingness)

          coef exp(coef) se(coef)     z Pr(&gt;|z|)    
esvea 0.160110  1.173640 0.186795 0.857    0.391    
sex   0.605186  1.831592 0.147665 4.098 4.16e-05 ***
age   0.076075  1.079043 0.010758 7.071 1.54e-12 ***
sbp   0.002955  1.002960 0.002867 1.031    0.303    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

      exp(coef) exp(-coef) lower .95 upper .95
esvea     1.174     0.8521    0.8138     1.693
sex       1.832     0.5460    1.3713     2.446
age       1.079     0.9267    1.0565     1.102
sbp       1.003     0.9970    0.9973     1.009

Concordance= 0.657  (se = 0.019 )
Likelihood ratio test= 64.38  on 4 df,   p=3e-13
Wald test            = 67.44  on 4 df,   p=8e-14
Score (logrank) test = 70.93  on 4 df,   p=1e-14</code></pre>
</div>
</div>
<p>Then, the hazard, <span class="math inline">\(\alpha_h(t|Z)\)</span> and <span class="math inline">\(\exp(-\int_0^ta_{h}(t|Z))\)</span> are extracted for a 65-year-old female with systolic blood pressure of 150mmHg with or without ESVEA for each cause-specific Cox model using the <strong>survfit</strong> function.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-132_1635c35ce33f91bbde874988f813cfda">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Survfit for the cause-specific hazard stroke given covariates Z</span></span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>survfit_stroke44 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox44_stroke, <span class="at">newdata =</span> covar)</span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate of exp(-A_02(t|Z))</span></span>
<span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a>S0_stroke44 <span class="ot">&lt;-</span> survfit_stroke44<span class="sc">$</span>surv[,<span class="dv">1</span>]</span>
<span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a>S1_stroke44 <span class="ot">&lt;-</span> survfit_stroke44<span class="sc">$</span>surv[,<span class="dv">2</span>]</span>
<span id="cb267-6"><a href="#cb267-6" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimate of the hazard for stroke, alpha_02(t|Z)</span></span>
<span id="cb267-7"><a href="#cb267-7" aria-hidden="true" tabindex="-1"></a>haz0_stroke44 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(survfit_stroke44<span class="sc">$</span>cumhaz[,<span class="dv">1</span>]))</span>
<span id="cb267-8"><a href="#cb267-8" aria-hidden="true" tabindex="-1"></a>haz1_stroke44 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(survfit_stroke44<span class="sc">$</span>cumhaz[,<span class="dv">2</span>]))</span>
<span id="cb267-9"><a href="#cb267-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-10"><a href="#cb267-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Survfit for the cause specific hazard death without stroke given covariates Z</span></span>
<span id="cb267-11"><a href="#cb267-11" aria-hidden="true" tabindex="-1"></a>survfit_death44 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox44_death, <span class="at">newdata =</span> covar)</span>
<span id="cb267-12"><a href="#cb267-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate of exp(-A_03(t|Z))</span></span>
<span id="cb267-13"><a href="#cb267-13" aria-hidden="true" tabindex="-1"></a>S0_death44 <span class="ot">&lt;-</span> survfit_death44<span class="sc">$</span>surv[,<span class="dv">1</span>]</span>
<span id="cb267-14"><a href="#cb267-14" aria-hidden="true" tabindex="-1"></a>S1_death44 <span class="ot">&lt;-</span> survfit_death44<span class="sc">$</span>surv[,<span class="dv">2</span>]</span>
<span id="cb267-15"><a href="#cb267-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate of the hazard for death without stroke, alpha_03(t|Z)</span></span>
<span id="cb267-16"><a href="#cb267-16" aria-hidden="true" tabindex="-1"></a>haz0_death44 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(survfit_death44<span class="sc">$</span>cumhaz[,<span class="dv">1</span>]))</span>
<span id="cb267-17"><a href="#cb267-17" aria-hidden="true" tabindex="-1"></a>haz1_death44 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">diff</span>(survfit_death44<span class="sc">$</span>cumhaz[,<span class="dv">2</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-133_b21bef66a38dbbb3f6fd033cd368a171">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate of cumulative incidence functions for stroke</span></span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a>cif0_stroke44 <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(S0_stroke44<span class="sc">*</span>S0_death44<span class="sc">*</span>haz0_stroke44)</span>
<span id="cb268-3"><a href="#cb268-3" aria-hidden="true" tabindex="-1"></a>cif1_stroke44 <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(S1_stroke44<span class="sc">*</span>S1_death44<span class="sc">*</span>haz1_stroke44)</span>
<span id="cb268-4"><a href="#cb268-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-5"><a href="#cb268-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Plotting the cumulative incidence function with stroke as outcome for a 65-year-old female with sbp of 150mmHg</span></span>
<span id="cb268-6"><a href="#cb268-6" aria-hidden="true" tabindex="-1"></a>(plot44_stroke <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> survfit_stroke44<span class="sc">$</span>time, <span class="at">y =</span> cif0_stroke44, <span class="at">color =</span> <span class="st">"ESVEA=0"</span>)) <span class="sc">+</span></span>
<span id="cb268-7"><a href="#cb268-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span>survfit_stroke44<span class="sc">$</span>time, <span class="at">y =</span> cif1_stroke44, <span class="at">color =</span> <span class="st">"ESVEA=1"</span>)) <span class="sc">+</span>  <span class="fu">theme</span>(<span class="at">legend.title=</span><span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb268-8"><a href="#cb268-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative incidence"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Cox: CIF for stroke for a 65-year-old female with sbp 150mmHg"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-133-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>Likewise, we can estimate and plot the cumulative incidence functions for the outcome death without stroke.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-134_25307bc849b9f603bded6e34f42abf06">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate of cumulative incidence functions for death without stroke</span></span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a>cif0_death44 <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(S0_stroke44<span class="sc">*</span>S0_death44<span class="sc">*</span>haz0_death44)</span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a>cif1_death44 <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(S1_stroke44<span class="sc">*</span>S1_death44<span class="sc">*</span>haz1_death44)</span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-5"><a href="#cb269-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Plotting the cumulative incidence function with stroke as outcome for a 65-year-old female with sbp of 150mmHg</span></span>
<span id="cb269-6"><a href="#cb269-6" aria-hidden="true" tabindex="-1"></a>(plot44_death <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> survfit_death44<span class="sc">$</span>time, <span class="at">y =</span> cif0_death44, <span class="at">color =</span> <span class="st">"ESVEA=0"</span>)) <span class="sc">+</span></span>
<span id="cb269-7"><a href="#cb269-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span>survfit_death44<span class="sc">$</span>time, <span class="at">y =</span> cif1_death44, <span class="at">color =</span> <span class="st">"ESVEA=1"</span>)) <span class="sc">+</span>  <span class="fu">theme</span>(<span class="at">legend.title=</span><span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb269-8"><a href="#cb269-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative incidence"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb269-9"><a href="#cb269-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Cox: CIF for death for a 65-year-old female with sbp 150mmHg"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-134-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-48-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-48-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-135_3b48d4b35e99429edd410929440907ad">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="co">* We must first create a variable for the competing risks which we will call 'event'. 0 is censored, 1 is stroke, and 2 is death </span></span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a><span class="co">  without stroke;</span></span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-4"><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> chs_<span class="kw">data</span>;</span>
<span id="cb270-5"><a href="#cb270-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> chs_<span class="kw">data</span>;</span>
<span id="cb270-6"><a href="#cb270-6" aria-hidden="true" tabindex="-1"></a>    death_wo_stroke = death;</span>
<span id="cb270-7"><a href="#cb270-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> stroke = <span class="dv">1</span> <span class="kw">then</span> death_wo_stroke = <span class="dv">0</span>;</span>
<span id="cb270-8"><a href="#cb270-8" aria-hidden="true" tabindex="-1"></a>    event = <span class="dv">0</span>;</span>
<span id="cb270-9"><a href="#cb270-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> stroke = <span class="dv">1</span> <span class="kw">then</span> event = <span class="dv">1</span>;</span>
<span id="cb270-10"><a href="#cb270-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> death_wo_stroke = <span class="dv">1</span> <span class="kw">then</span> event = <span class="dv">2</span>;</span>
<span id="cb270-11"><a href="#cb270-11" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb270-12"><a href="#cb270-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-13"><a href="#cb270-13" aria-hidden="true" tabindex="-1"></a><span class="co">* Then we will fit a Cox model returning the predicted cumulative incidence functions with the specified covariates. </span></span>
<span id="cb270-14"><a href="#cb270-14" aria-hidden="true" tabindex="-1"></a><span class="co">  This is done by adding the argument eventcode(cox) to the model statement and adding the 'cif' argument in the baseline </span></span>
<span id="cb270-15"><a href="#cb270-15" aria-hidden="true" tabindex="-1"></a><span class="co">  statement.  NB: requires SAS STAT 15.1;</span></span>
<span id="cb270-16"><a href="#cb270-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-17"><a href="#cb270-17" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span> = chs_<span class="kw">data</span> noprint; </span>
<span id="cb270-18"><a href="#cb270-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timestrokeordeath*event(<span class="dv">0</span>) =esvea sex age sbp / eventcode(cox) = <span class="dv">1</span>;</span>
<span id="cb270-19"><a href="#cb270-19" aria-hidden="true" tabindex="-1"></a>    baseline covariates = cov out=cif44_stroke cif = cif;</span>
<span id="cb270-20"><a href="#cb270-20" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb270-21"><a href="#cb270-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-22"><a href="#cb270-22" aria-hidden="true" tabindex="-1"></a><span class="co">* Finally, the cumulative incidence functions are plotted using the gplot procedure;</span></span>
<span id="cb270-23"><a href="#cb270-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-24"><a href="#cb270-24" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'4.4: CIF for the outcome stroke (based on Cox model)'</span>;</span>
<span id="cb270-25"><a href="#cb270-25" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=cif44_stroke;</span>
<span id="cb270-26"><a href="#cb270-26" aria-hidden="true" tabindex="-1"></a>    plot cif*timestrokeordeath=esvea/haxis=axis1 vaxis=axis2;</span>
<span id="cb270-27"><a href="#cb270-27" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">16</span> <span class="kw">by</span> <span class="dv">2</span> <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb270-28"><a href="#cb270-28" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">0.2</span> <span class="kw">by</span> <span class="dv">0.02</span> <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'CIF for stroke'</span>);</span>
<span id="cb270-29"><a href="#cb270-29" aria-hidden="true" tabindex="-1"></a>    symbol1  i=stepjl c=blue;</span>
<span id="cb270-30"><a href="#cb270-30" aria-hidden="true" tabindex="-1"></a>    symbol2  i=stepjl c=red;</span>
<span id="cb270-31"><a href="#cb270-31" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb270-32"><a href="#cb270-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-33"><a href="#cb270-33" aria-hidden="true" tabindex="-1"></a><span class="co">* Then, we repeat the procedure for the outcome death without stroke;</span></span>
<span id="cb270-34"><a href="#cb270-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-35"><a href="#cb270-35" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span> = chs_<span class="kw">data</span> noprint; </span>
<span id="cb270-36"><a href="#cb270-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timestrokeordeath*event(<span class="dv">0</span>) =esvea sex age sbp / eventcode(cox) = <span class="dv">2</span>;</span>
<span id="cb270-37"><a href="#cb270-37" aria-hidden="true" tabindex="-1"></a>    baseline covariates = cov out=cif44_death cif = cif;</span>
<span id="cb270-38"><a href="#cb270-38" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb270-39"><a href="#cb270-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-40"><a href="#cb270-40" aria-hidden="true" tabindex="-1"></a><span class="co">* We can now plot the cumulative incidence functions gpt death without stroke using the gplot procedure;</span></span>
<span id="cb270-41"><a href="#cb270-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-42"><a href="#cb270-42" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'4.4: CIF for the outcome death without stroke (based on Cox model)'</span>;</span>
<span id="cb270-43"><a href="#cb270-43" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=cif44_death;</span>
<span id="cb270-44"><a href="#cb270-44" aria-hidden="true" tabindex="-1"></a>    plot cif*timestrokeordeath=esvea/haxis=axis1 vaxis=axis2;</span>
<span id="cb270-45"><a href="#cb270-45" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">16</span> <span class="kw">by</span> <span class="dv">2</span> <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb270-46"><a href="#cb270-46" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">0.3</span> <span class="kw">by</span> <span class="dv">0.03</span> <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'CIF for death w/o stroke'</span>);</span>
<span id="cb270-47"><a href="#cb270-47" aria-hidden="true" tabindex="-1"></a>    symbol1  i=stepjl c=blue;</span>
<span id="cb270-48"><a href="#cb270-48" aria-hidden="true" tabindex="-1"></a>    symbol2  i=stepjl c=red;</span>
<span id="cb270-49"><a href="#cb270-49" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb270-50"><a href="#cb270-50" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="exercise-4.5" class="level3">
<h3 class="anchored" data-anchor-id="exercise-4.5">Exercise 4.5</h3>
<section id="section-2" class="level4">
<h4 class="anchored" data-anchor-id="section-2">1.</h4>
<p><em>Repeat the previous question using instead Fine-Gray models.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-49-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-49-1" role="tab" aria-controls="tabset-49-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-49-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-49-2" role="tab" aria-controls="tabset-49-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-49-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-49-1-tab">
<p>We will fit the Fine-Gray models using the <strong>finegray</strong> function from the <em>survival</em> package. We must make a new status indicator with one level for each possible outcome, which we will call <strong>fg_event</strong>. The value 0 must indicate stroke-free survival and we let 1 indicate stroke and 2 indicate death without stroke.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-136_2cd082d4939bb8a679bd57a0b414cd91">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Creating event variable, 0 = censored, 1 = stroke, 2 = death w/o stroke</span></span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a>fg_event <span class="ot">&lt;-</span> <span class="fu">with</span>(chs_data, <span class="fu">ifelse</span>(death_wo_stroke <span class="sc">==</span> <span class="dv">0</span>, stroke, death_wo_stroke<span class="sc">*</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <strong>finegray</strong> function takes a formula argument with a <strong>Surv</strong> object on the left of ~ and . on the right. The cause of interest is specified by the <strong>etype</strong> argument.</p>
<p>Afterwards the model is fitted using the <strong>coxph</strong> function with the data frame created by the <strong>finegray</strong> function. The formula argument should have <strong>Surv(fgstart,fgstop,fgstatus)</strong> on the left side of ~ and as usual the covariates of interest (ESVEA, age, sex, and sbp) on the right. The argument <strong>weigth = fgwt</strong> must also be included.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-137_5fb23e0d8647071b9946d511a52ef86c">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Fitting Fine-Gray model for stroke</span></span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a>fgdata_stroke <span class="ot">&lt;-</span> <span class="fu">finegray</span>(<span class="fu">Surv</span>(timestrokeordeath, <span class="fu">factor</span>(fg_event)) <span class="sc">~</span> ., <span class="at">etype =</span> <span class="dv">1</span>, <span class="at">data =</span>chs_data)</span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a>fg45_stroke <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(fgstart, fgstop, fgstatus) <span class="sc">~</span> esvea <span class="sc">+</span> sex <span class="sc">+</span> age <span class="sc">+</span> sbp, <span class="at">weight =</span> fgwt, <span class="at">data =</span> fgdata_stroke)</span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fg45_stroke)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(fgstart, fgstop, fgstatus) ~ esvea + sex + 
    age + sbp, data = fgdata_stroke, weights = fgwt)

  n= 888, number of events= 72 
   (4 observations deleted due to missingness)

          coef exp(coef) se(coef) robust se     z Pr(&gt;|z|)    
esvea 0.593921  1.811075 0.271675  0.275526 2.156 0.031116 *  
sex   0.379189  1.461099 0.248427  0.243020 1.560 0.118684    
age   0.063347  1.065397 0.019072  0.018469 3.430 0.000604 ***
sbp   0.010629  1.010686 0.004608  0.004196 2.533 0.011305 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

      exp(coef) exp(-coef) lower .95 upper .95
esvea     1.811     0.5522    1.0554     3.108
sex       1.461     0.6844    0.9074     2.353
age       1.065     0.9386    1.0275     1.105
sbp       1.011     0.9894    1.0024     1.019

Concordance= 0.699  (se = 0.029 )
Likelihood ratio test= 30.7  on 4 df,   p=4e-06
Wald test            = 37.72  on 4 df,   p=1e-07
Score (logrank) test = 34.45  on 4 df,   p=6e-07,   Robust = 24.82  p=5e-05

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
</div>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-138_e2ba20c69ecb70705425bc3b1e0ad0e9">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Fitting Fine-Gray for death without stroke</span></span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a>fgdata_death <span class="ot">&lt;-</span> <span class="fu">finegray</span>(<span class="fu">Surv</span>(timestrokeordeath, <span class="fu">factor</span>(fg_event)) <span class="sc">~</span> ., <span class="at">etype =</span> <span class="dv">2</span>, <span class="at">data =</span>chs_data)</span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a>fg45_death <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(fgstart, fgstop, fgstatus) <span class="sc">~</span> esvea <span class="sc">+</span> sex <span class="sc">+</span> age <span class="sc">+</span> sbp, <span class="at">weight =</span> fgwt, <span class="at">data =</span> fgdata_death)</span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fg45_death)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(fgstart, fgstop, fgstatus) ~ esvea + sex + 
    age + sbp, data = fgdata_death, weights = fgwt)

  n= 1172, number of events= 213 
   (10 observations deleted due to missingness)

           coef exp(coef)  se(coef) robust se      z Pr(&gt;|z|)    
esvea -0.006269  0.993751  0.188059  0.193559 -0.032 0.974164    
sex    0.530219  1.699304  0.148362  0.146047  3.630 0.000283 ***
age    0.066495  1.068756  0.010812  0.010673  6.230 4.65e-10 ***
sbp    0.001601  1.001602  0.002927  0.002917  0.549 0.583197    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

      exp(coef) exp(-coef) lower .95 upper .95
esvea    0.9938     1.0063    0.6800     1.452
sex      1.6993     0.5885    1.2763     2.262
age      1.0688     0.9357    1.0466     1.091
sbp      1.0016     0.9984    0.9959     1.007

Concordance= 0.636  (se = 0.019 )
Likelihood ratio test= 46.38  on 4 df,   p=2e-09
Wald test            = 50.97  on 4 df,   p=2e-10
Score (logrank) test = 49.87  on 4 df,   p=4e-10,   Robust = 41  p=3e-08

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
</div>
<p>As described in Section 4.2.2, the Fine-Gray model has a simple expression for the cumulative incidence function for cause <span class="math inline">\(h\)</span> since</p>
<p><span class="math display">\[
\log(-\log(1-F_h(t|Z))) = \log(\tilde{A}_{0h}(t)) + LP_h \\
\iff F_h(t|Z) = 1-\exp(-\tilde{A}_{0h}(t)\exp(LP_h))
\]</span></p>
<p>Thus, we can use the <strong>survfit</strong> function to obtain the estimate for <span class="math inline">\(\exp(-\tilde{A}_{0h}(t)\exp(\beta Z))\)</span>, given <span class="math inline">\(Z_1 = 0,1\)</span> and <span class="math inline">\((Z_2,Z_3,Z_4) = (0,65,150)\)</span> for the outcome stroke.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-139_894962dc2f46ce98c194e0eadafa5312">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative incidence functions for the outcome stroke given covariates Z</span></span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>cif_stroke451 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span> <span class="fu">survfit</span>(fg45_stroke, <span class="at">newdata =</span> covar)<span class="sc">$</span>surv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The Fine-Gray estimate of the cumulative incidence function for stroke can then be plotted.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-140_0baac1c7dc532af4f7110b330f88727e">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the predicted cumulative incidence functions.</span></span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a>(plot451_stroke <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">survfit</span>(fg45_stroke, <span class="at">newdata =</span> covar)<span class="sc">$</span>time, <span class="at">y =</span> cif_stroke451[,<span class="dv">1</span>], <span class="at">color =</span> <span class="st">"ESVEA=0"</span>)) <span class="sc">+</span></span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span><span class="fu">survfit</span>(fg45_stroke, <span class="at">newdata =</span> covar)<span class="sc">$</span>time, <span class="at">y =</span> cif_stroke451[,<span class="dv">2</span>], <span class="at">color =</span> <span class="st">"ESVEA=1"</span>)) <span class="sc">+</span>  <span class="fu">theme</span>(<span class="at">legend.title=</span><span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative incidence"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Fine-Gray: CIF for stroke for a 65-year-old woman with sbp 150 mmHg"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-140-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>We repeat the procedure above for the outcome death without stroke</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-141_d52e6a7f67637d2f620ad4866fe11e3b">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative incidence functions for the outcome death without stroke given covariates Z</span></span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>cif_death451 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span> <span class="fu">survfit</span>(fg45_death, <span class="at">newdata =</span> covar)<span class="sc">$</span>surv</span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the predicted cumulative incidence functions.</span></span>
<span id="cb278-5"><a href="#cb278-5" aria-hidden="true" tabindex="-1"></a>(plot451_death <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">survfit</span>(fg45_death, <span class="at">newdata =</span> covar)<span class="sc">$</span>time, <span class="at">y =</span> cif_death451[,<span class="dv">1</span>], <span class="at">color =</span> <span class="st">"ESVEA=0"</span>)) <span class="sc">+</span></span>
<span id="cb278-6"><a href="#cb278-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span><span class="fu">survfit</span>(fg45_death, <span class="at">newdata =</span> covar)<span class="sc">$</span>time, <span class="at">y =</span> cif_death451[,<span class="dv">2</span>], <span class="at">color =</span> <span class="st">"ESVEA=1"</span>)) <span class="sc">+</span>  <span class="fu">theme</span>(<span class="at">legend.title=</span><span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb278-7"><a href="#cb278-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative incidence"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) </span>
<span id="cb278-8"><a href="#cb278-8" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Fine-Gray: CIF for death w/o stroke for a 65-year-old woman with sbp 150 mmHg"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-141-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-49-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-49-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-142_7c5bca1f28b5a847ae9d82a4cd31ed2a">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="co">* To obtain the CIF for the outcomes stroke and death without stroke using the Fine-Gray model, 'eventcode' is added instead of</span></span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a><span class="co">  'eventcode(cox)' in the model statement of the phreg procedure;</span></span>
<span id="cb279-3"><a href="#cb279-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-4"><a href="#cb279-4" aria-hidden="true" tabindex="-1"></a><span class="co">* We will first estimate the CIF for the outcome stroke;</span></span>
<span id="cb279-5"><a href="#cb279-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-6"><a href="#cb279-6" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span> = chs_<span class="kw">data</span>; </span>
<span id="cb279-7"><a href="#cb279-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timestrokeordeath*event(<span class="dv">0</span>) =esvea sex age sbp / eventcode = <span class="dv">1</span>;</span>
<span id="cb279-8"><a href="#cb279-8" aria-hidden="true" tabindex="-1"></a>    baseline covariates = cov out=cif451_stroke cif = cif;</span>
<span id="cb279-9"><a href="#cb279-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb279-10"><a href="#cb279-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-11"><a href="#cb279-11" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'4.5.1: CIF for the outcome stroke (based on Fine-Gray model)'</span>;</span>
<span id="cb279-12"><a href="#cb279-12" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=cif451_stroke;</span>
<span id="cb279-13"><a href="#cb279-13" aria-hidden="true" tabindex="-1"></a>    plot cif*timestrokeordeath=esvea/haxis=axis1 vaxis=axis2;</span>
<span id="cb279-14"><a href="#cb279-14" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">16</span> <span class="kw">by</span> <span class="dv">2</span> <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb279-15"><a href="#cb279-15" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">0.125</span> <span class="kw">by</span> <span class="dv">0.0125</span> <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'CIF for stroke'</span>);</span>
<span id="cb279-16"><a href="#cb279-16" aria-hidden="true" tabindex="-1"></a>    symbol1  i=stepjl c=blue;</span>
<span id="cb279-17"><a href="#cb279-17" aria-hidden="true" tabindex="-1"></a>    symbol2  i=stepjl c=red;</span>
<span id="cb279-18"><a href="#cb279-18" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb279-19"><a href="#cb279-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-20"><a href="#cb279-20" aria-hidden="true" tabindex="-1"></a><span class="co">* Then we will estimate the CIF for the outcome death without stroke;</span></span>
<span id="cb279-21"><a href="#cb279-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-22"><a href="#cb279-22" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span> = chs_<span class="kw">data</span>; </span>
<span id="cb279-23"><a href="#cb279-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timestrokeordeath*event(<span class="dv">0</span>) =esvea sex age sbp / eventcode = <span class="dv">2</span>;</span>
<span id="cb279-24"><a href="#cb279-24" aria-hidden="true" tabindex="-1"></a>    baseline covariates = cov out=cif451_death cif = cif;</span>
<span id="cb279-25"><a href="#cb279-25" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb279-26"><a href="#cb279-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-27"><a href="#cb279-27" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'4.5.1: CIF for the outcome stroke (based on Fine-Gray model)'</span>;</span>
<span id="cb279-28"><a href="#cb279-28" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=cif451_death;</span>
<span id="cb279-29"><a href="#cb279-29" aria-hidden="true" tabindex="-1"></a>    plot cif*timestrokeordeath=esvea/haxis=axis1 vaxis=axis2;</span>
<span id="cb279-30"><a href="#cb279-30" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">16</span> <span class="kw">by</span> <span class="dv">2</span> <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb279-31"><a href="#cb279-31" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">0.25</span> <span class="kw">by</span> <span class="dv">0.025</span> <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'CIF for death w/o stroke'</span>);</span>
<span id="cb279-32"><a href="#cb279-32" aria-hidden="true" tabindex="-1"></a>    symbol1  i=stepjl c=blue;</span>
<span id="cb279-33"><a href="#cb279-33" aria-hidden="true" tabindex="-1"></a>    symbol2  i=stepjl c=red;</span>
<span id="cb279-34"><a href="#cb279-34" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb279-35"><a href="#cb279-35" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="section-3" class="level4">
<h4 class="anchored" data-anchor-id="section-3">2.</h4>
<p><em>Estimate the cumulative incidence functions for patients with or without ESVEA using the g-formula.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-50-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-50-1" role="tab" aria-controls="tabset-50-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-50-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-50-2" role="tab" aria-controls="tabset-50-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-50-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-50-1-tab">
<p>To obtain an estimate of the cumulative incidence functions with or without ESVEA using the g-formula we will exploit the simple expression of the CIF in the Fine-Gray model and simply use <strong>survfit</strong> and the data frames <strong>chs_covar0</strong> and <strong>chs_covar1</strong> from exercise 4.2.2 to make two predictions of <span class="math inline">\(1 -\exp(-\tilde{A}_{0h}(t)\exp(LP_h))\)</span> for each subject, one with ESVEA and one without ESVEA. Then, the g-formula estimate is the average of the predictions with or without ESVEA.</p>
<p>We will find the g-formula estimate of the cumulative incidence functions for the outcome stroke.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-143_f9b500521782b50670d8f06f2e04aeb6">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating the CIFs for stroke for all subjects with ESVEA = 0 or ESVEA = 1</span></span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a>cifs0_stroke452 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span> <span class="fu">survfit</span>(fg45_stroke, <span class="at">newdata =</span> chs_covar0)<span class="sc">$</span>surv</span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a>cifs1_stroke452 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span> <span class="fu">survfit</span>(fg45_stroke, <span class="at">newdata =</span> chs_covar1)<span class="sc">$</span>surv</span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-5"><a href="#cb280-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Taking the average of the CIFs</span></span>
<span id="cb280-6"><a href="#cb280-6" aria-hidden="true" tabindex="-1"></a>cif0_stroke452 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(cifs0_stroke452)</span>
<span id="cb280-7"><a href="#cb280-7" aria-hidden="true" tabindex="-1"></a>cif1_stroke452 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(cifs1_stroke452)</span>
<span id="cb280-8"><a href="#cb280-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-9"><a href="#cb280-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the predicted cumulative incidence functions for death without stroke.</span></span>
<span id="cb280-10"><a href="#cb280-10" aria-hidden="true" tabindex="-1"></a>(plot452_stroke <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">survfit</span>(fg45_stroke, <span class="at">newdata =</span> covar)<span class="sc">$</span>time, <span class="at">y =</span> cif0_stroke452, <span class="at">color =</span> <span class="st">"ESVEA=0"</span>)) <span class="sc">+</span></span>
<span id="cb280-11"><a href="#cb280-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span><span class="fu">survfit</span>(fg45_stroke, <span class="at">newdata =</span> covar)<span class="sc">$</span>time, <span class="at">y =</span> cif1_stroke452, <span class="at">color =</span> <span class="st">"ESVEA=1"</span>)) <span class="sc">+</span>  <span class="fu">theme</span>(<span class="at">legend.title=</span><span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb280-12"><a href="#cb280-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative incidence"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) <span class="sc">+</span> </span>
<span id="cb280-13"><a href="#cb280-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Fine-Gray: CIF for stroke (g-formula)"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-143-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>Then, we repeat the procedure for the outcome death without stroke.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-144_5cb4f7d402fe38eb9ea26354d64a5490">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating the CIFs for death without stroke for all subjects with ESVEA = 0 or ESVEA = 1</span></span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a>cifs0_death452 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span> <span class="fu">survfit</span>(fg45_death, <span class="at">newdata =</span> chs_covar0)<span class="sc">$</span>surv</span>
<span id="cb281-3"><a href="#cb281-3" aria-hidden="true" tabindex="-1"></a>cifs1_death452 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span> <span class="fu">survfit</span>(fg45_death, <span class="at">newdata =</span> chs_covar1)<span class="sc">$</span>surv</span>
<span id="cb281-4"><a href="#cb281-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-5"><a href="#cb281-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Taking the average of the CIFs</span></span>
<span id="cb281-6"><a href="#cb281-6" aria-hidden="true" tabindex="-1"></a>cif0_death452 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(cifs0_death452)</span>
<span id="cb281-7"><a href="#cb281-7" aria-hidden="true" tabindex="-1"></a>cif1_death452 <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(cifs1_death452)</span>
<span id="cb281-8"><a href="#cb281-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-9"><a href="#cb281-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the predicted cumulative incidence functions for death without stroke.</span></span>
<span id="cb281-10"><a href="#cb281-10" aria-hidden="true" tabindex="-1"></a>(plot452_death <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">survfit</span>(fg45_death, <span class="at">newdata =</span> covar)<span class="sc">$</span>time, <span class="at">y =</span> cif0_death452, <span class="at">color =</span> <span class="st">"ESVEA=0"</span>)) <span class="sc">+</span></span>
<span id="cb281-11"><a href="#cb281-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span><span class="fu">survfit</span>(fg45_death, <span class="at">newdata =</span> covar)<span class="sc">$</span>time, <span class="at">y =</span> cif1_death452, <span class="at">color =</span> <span class="st">"ESVEA=1"</span>)) <span class="sc">+</span>  <span class="fu">theme</span>(<span class="at">legend.title=</span><span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb281-12"><a href="#cb281-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Cumulative incidence"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"Time since randomization (years)"</span>) </span>
<span id="cb281-13"><a href="#cb281-13" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Fine-Gray: CIF for death w/o stroke (g-formula)"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-144-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>We will finally compare the estimates obtained using the g-formula with the non-parametric estimates obtained using the Aalen-Johansen estimator. The latter are obtained using <strong>survfit</strong>.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-145_d2cc6fc8aff061b891f4d0238e7c5804">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>aj <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(timestrokeordeath,<span class="fu">factor</span>(fg_event),<span class="at">type=</span><span class="st">'mstate'</span>)<span class="sc">~</span>esvea,<span class="at">data=</span>chs_data,<span class="at">influence =</span> <span class="cn">TRUE</span>)</span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(aj,<span class="at">col=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topleft"</span>,<span class="at">legend=</span><span class="fu">c</span>(<span class="st">"esvea=0"</span>, <span class="st">"esvea=1"</span>),<span class="at">col=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="at">lty=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-145-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-50-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-50-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-146_5d6d252224e7062e01d8d66475416615">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="co">* We will then make a macro function taking the cause of interest (stroke or death without stroke) and value of ESVEA as arguments;</span></span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a><span class="kw">%macro</span> cif452(cause, esvea);</span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a><span class="co">* Creating modified covariates. Observed values for sex, age, and sbp, while ESVEA is either 0 or 1 for all subjects;</span></span>
<span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> covar_temp;</span>
<span id="cb283-6"><a href="#cb283-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> chs_<span class="kw">data</span>;</span>
<span id="cb283-7"><a href="#cb283-7" aria-hidden="true" tabindex="-1"></a>    esvea = <span class="kw">&amp;esvea;</span></span>
<span id="cb283-8"><a href="#cb283-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">keep</span> id esvea sex age sbp;</span>
<span id="cb283-9"><a href="#cb283-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb283-10"><a href="#cb283-10" aria-hidden="true" tabindex="-1"></a><span class="co">* Fine-Gray model returning the predicted cumulative incidence functions for the modified covariates for all patients;</span></span>
<span id="cb283-11"><a href="#cb283-11" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span> = chs_<span class="kw">data</span> noprint; </span>
<span id="cb283-12"><a href="#cb283-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timestrokeordeath*event(<span class="dv">0</span>) =esvea sex age sbp / eventcode = <span class="kw">&amp;cause;</span></span>
<span id="cb283-13"><a href="#cb283-13" aria-hidden="true" tabindex="-1"></a>    baseline covariates = covar_temp out=ciftest cif = cif;</span>
<span id="cb283-14"><a href="#cb283-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb283-15"><a href="#cb283-15" aria-hidden="true" tabindex="-1"></a><span class="co">* Splitting the data set ciftest and returning one data set per patient containing the predicted cumulative incidence function;</span></span>
<span id="cb283-16"><a href="#cb283-16" aria-hidden="true" tabindex="-1"></a><span class="kw">%do</span> i = <span class="dv">1</span> <span class="kw">%to</span> <span class="dv">678</span>;</span>
<span id="cb283-17"><a href="#cb283-17" aria-hidden="true" tabindex="-1"></a><span class="kw">    data</span> cif<span class="kw">&amp;i;</span></span>
<span id="cb283-18"><a href="#cb283-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">set</span> ciftest;</span>
<span id="cb283-19"><a href="#cb283-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> id = <span class="kw">&amp;i;</span></span>
<span id="cb283-20"><a href="#cb283-20" aria-hidden="true" tabindex="-1"></a>        cif<span class="kw">&amp;i </span>= cif;</span>
<span id="cb283-21"><a href="#cb283-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">keep</span> id timestrokeordeath cif<span class="kw">&amp;i;</span>  </span>
<span id="cb283-22"><a href="#cb283-22" aria-hidden="true" tabindex="-1"></a><span class="kw">    run</span>;    </span>
<span id="cb283-23"><a href="#cb283-23" aria-hidden="true" tabindex="-1"></a><span class="kw">%end</span>;</span>
<span id="cb283-24"><a href="#cb283-24" aria-hidden="true" tabindex="-1"></a><span class="co">* Calculating the average of the cumulative incidence functions;</span></span>
<span id="cb283-25"><a href="#cb283-25" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> res<span class="kw">&amp;esvea;</span></span>
<span id="cb283-26"><a href="#cb283-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> cif1-cif678 ;</span>
<span id="cb283-27"><a href="#cb283-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">merge</span> cif1-cif678;</span>
<span id="cb283-28"><a href="#cb283-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> timestrokeordeath;</span>
<span id="cb283-29"><a href="#cb283-29" aria-hidden="true" tabindex="-1"></a>    ESVEA<span class="kw">&amp;esvea </span>= <span class="fu">mean</span>(of cif1-cif678);</span>
<span id="cb283-30"><a href="#cb283-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">keep</span> timestrokeordeath ESVEA<span class="kw">&amp;esvea;</span></span>
<span id="cb283-31"><a href="#cb283-31" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb283-32"><a href="#cb283-32" aria-hidden="true" tabindex="-1"></a><span class="kw">%mend</span>;</span>
<span id="cb283-33"><a href="#cb283-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-34"><a href="#cb283-34" aria-hidden="true" tabindex="-1"></a><span class="co">*We call the function for the outcome stroke and ESVEA = 0,1;</span></span>
<span id="cb283-35"><a href="#cb283-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-36"><a href="#cb283-36" aria-hidden="true" tabindex="-1"></a>%cif452(1,1);</span>
<span id="cb283-37"><a href="#cb283-37" aria-hidden="true" tabindex="-1"></a>%cif452(1,0);</span>
<span id="cb283-38"><a href="#cb283-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-39"><a href="#cb283-39" aria-hidden="true" tabindex="-1"></a><span class="co">* Then we create a data set containing the cumulative incidence function for both ESVEA = 0 and ESVEA = 1 and plot the result.;</span></span>
<span id="cb283-40"><a href="#cb283-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-41"><a href="#cb283-41" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> stroke452;</span>
<span id="cb283-42"><a href="#cb283-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> res0 res1;</span>
<span id="cb283-43"><a href="#cb283-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">merge</span> res0 res1;</span>
<span id="cb283-44"><a href="#cb283-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> timestrokeordeath;</span>
<span id="cb283-45"><a href="#cb283-45" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb283-46"><a href="#cb283-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-47"><a href="#cb283-47" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sgplot<span class="kw"> data</span>=stroke452;</span>
<span id="cb283-48"><a href="#cb283-48" aria-hidden="true" tabindex="-1"></a>title1<span class="st">'4.5.2 - Cumulative incidence function for stroke predicted with Fine-Gray models using the g-formula'</span>;</span>
<span id="cb283-49"><a href="#cb283-49" aria-hidden="true" tabindex="-1"></a>   step y=ESVEA0 <span class="kw">x</span>=timestrokeordeath;</span>
<span id="cb283-50"><a href="#cb283-50" aria-hidden="true" tabindex="-1"></a>   step y=ESVEA1 <span class="kw">x</span>=timestrokeordeath;</span>
<span id="cb283-51"><a href="#cb283-51" aria-hidden="true" tabindex="-1"></a>   xaxis <span class="kw">label</span>= <span class="st">"Time (Years since randomization)"</span>;</span>
<span id="cb283-52"><a href="#cb283-52" aria-hidden="true" tabindex="-1"></a>   yaxis <span class="kw">label</span>= <span class="st">"Cumulative incidence"</span>;</span>
<span id="cb283-53"><a href="#cb283-53" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb283-54"><a href="#cb283-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-55"><a href="#cb283-55" aria-hidden="true" tabindex="-1"></a><span class="co">* We repeat for the outcome death without stroke. First we call our macro function;</span></span>
<span id="cb283-56"><a href="#cb283-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-57"><a href="#cb283-57" aria-hidden="true" tabindex="-1"></a>%cif452(2,1);</span>
<span id="cb283-58"><a href="#cb283-58" aria-hidden="true" tabindex="-1"></a>%cif452(2,0);</span>
<span id="cb283-59"><a href="#cb283-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-60"><a href="#cb283-60" aria-hidden="true" tabindex="-1"></a><span class="co">*Then the data is collected in one data set and afterwards we plot the result;</span></span>
<span id="cb283-61"><a href="#cb283-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-62"><a href="#cb283-62" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> death452;</span>
<span id="cb283-63"><a href="#cb283-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> res0 res1;</span>
<span id="cb283-64"><a href="#cb283-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">merge</span> res0 res1;</span>
<span id="cb283-65"><a href="#cb283-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> timestrokeordeath;</span>
<span id="cb283-66"><a href="#cb283-66" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb283-67"><a href="#cb283-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-68"><a href="#cb283-68" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> sgplot<span class="kw"> data</span>=death452;</span>
<span id="cb283-69"><a href="#cb283-69" aria-hidden="true" tabindex="-1"></a>title1<span class="st">'4.5.2 - Cumulative incidence function for death predicted with Fine-Gray models using the g-formula'</span>;</span>
<span id="cb283-70"><a href="#cb283-70" aria-hidden="true" tabindex="-1"></a>   step y=ESVEA0 <span class="kw">x</span>=timestrokeordeath;</span>
<span id="cb283-71"><a href="#cb283-71" aria-hidden="true" tabindex="-1"></a>   step y=ESVEA1 <span class="kw">x</span>=timestrokeordeath;</span>
<span id="cb283-72"><a href="#cb283-72" aria-hidden="true" tabindex="-1"></a>   xaxis <span class="kw">label</span>= <span class="st">"Time (Years since randomization)"</span>;</span>
<span id="cb283-73"><a href="#cb283-73" aria-hidden="true" tabindex="-1"></a>   yaxis <span class="kw">label</span>= <span class="st">"Cumulative incidence"</span>;</span>
<span id="cb283-74"><a href="#cb283-74" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb283-75"><a href="#cb283-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-76"><a href="#cb283-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-77"><a href="#cb283-77" aria-hidden="true" tabindex="-1"></a><span class="co">/* For comparison, we also estimate the cumulative incidences non-parametrically. */</span></span>
<span id="cb283-78"><a href="#cb283-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-79"><a href="#cb283-79" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> lifetest<span class="kw"> data</span>=chs_<span class="kw">data</span> plots=(cif);</span>
<span id="cb283-80"><a href="#cb283-80" aria-hidden="true" tabindex="-1"></a><span class="fu">time</span> timestrokeordeath*event(<span class="dv">0</span>)/eventcode=<span class="dv">1</span>;</span>
<span id="cb283-81"><a href="#cb283-81" aria-hidden="true" tabindex="-1"></a>strata esvea;</span>
<span id="cb283-82"><a href="#cb283-82" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb283-83"><a href="#cb283-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-84"><a href="#cb283-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-85"><a href="#cb283-85" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> lifetest<span class="kw"> data</span>=chs_<span class="kw">data</span> plots=(cif);</span>
<span id="cb283-86"><a href="#cb283-86" aria-hidden="true" tabindex="-1"></a><span class="fu">time</span> timestrokeordeath*event(<span class="dv">0</span>)/eventcode=<span class="dv">2</span>;</span>
<span id="cb283-87"><a href="#cb283-87" aria-hidden="true" tabindex="-1"></a>strata esvea;</span>
<span id="cb283-88"><a href="#cb283-88" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-4.6" class="level3">
<h3 class="anchored" data-anchor-id="exercise-4.6">Exercise 4.6</h3>
<p><em>Consider the data from the Copenhagen Holter study and fit linear models for the expected time lost (numbers of years) before 3 years due to either stroke or death without stroke including ESVEA, sex, age, and systolic blood pressure.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-51-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-51-1" role="tab" aria-controls="tabset-51-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-51-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-51-2" role="tab" aria-controls="tabset-51-2" aria-selected="false">SAS-NA</a></li></ul>
<div class="tab-content">
<div id="tabset-51-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-51-1-tab">
<p>There are currently no packages in R where a function estimating linear models for the time lost due to cause-specific outcomes are implemented.</p>
<p>However, Conner and Trinquart (2021) have made their code available online. Thus, the following code chunk which implements such a function is adapted from their code on <a href="https://github.com/s-conner/rmtl/blob/master/functions/rmtl_ipcw_function.R" target="_blank">github</a></p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-147_385924047ebeda11d6c3cf75c18c1994">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>rmtl.ipcw <span class="ot">&lt;-</span> <span class="cf">function</span>(times, event, <span class="at">eoi=</span><span class="dv">1</span>, tau, <span class="at">cov=</span><span class="cn">NULL</span>, <span class="at">strata=</span><span class="cn">FALSE</span>, <span class="at">group=</span><span class="cn">NULL</span>){</span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-3"><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(group) <span class="sc">&amp;</span> strata<span class="sc">==</span><span class="cn">TRUE</span>){<span class="fu">stop</span>(<span class="st">'Please specify a factor variable to statify weights.'</span>)}</span>
<span id="cb284-4"><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(cov)){<span class="fu">print</span>(<span class="st">'Warning: Fitting intercept-only model.'</span>)}</span>
<span id="cb284-5"><a href="#cb284-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-6"><a href="#cb284-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Round event times to avoid issues with survival() package rounding differently</span></span>
<span id="cb284-7"><a href="#cb284-7" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">round</span>(times,<span class="dv">4</span>)</span>
<span id="cb284-8"><a href="#cb284-8" aria-hidden="true" tabindex="-1"></a>  id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(y)</span>
<span id="cb284-9"><a href="#cb284-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-10"><a href="#cb284-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recode so delta1 reflects event of interest, delta2 reflects all competing events. Assumes 0=censoring.</span></span>
<span id="cb284-11"><a href="#cb284-11" aria-hidden="true" tabindex="-1"></a>  delta1 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(event<span class="sc">==</span>eoi, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb284-12"><a href="#cb284-12" aria-hidden="true" tabindex="-1"></a>  delta2 <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(event<span class="sc">!=</span><span class="dv">0</span> <span class="sc">&amp;</span> event<span class="sc">!=</span>eoi, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb284-13"><a href="#cb284-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-14"><a href="#cb284-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Overall quantities</span></span>
<span id="cb284-15"><a href="#cb284-15" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">int=</span><span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(y)), cov)</span>
<span id="cb284-16"><a href="#cb284-16" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">length</span>(x[<span class="dv">1</span>,])</span>
<span id="cb284-17"><a href="#cb284-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(group)){group <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(y)))}</span>
<span id="cb284-18"><a href="#cb284-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-19"><a href="#cb284-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Recode event indicators to reflect status at chosen tau</span></span>
<span id="cb284-20"><a href="#cb284-20" aria-hidden="true" tabindex="-1"></a>  delta1[y<span class="sc">&gt;</span>tau] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb284-21"><a href="#cb284-21" aria-hidden="true" tabindex="-1"></a>  delta2[y<span class="sc">&gt;</span>tau] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb284-22"><a href="#cb284-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-23"><a href="#cb284-23" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">pmin</span>(y, tau)</span>
<span id="cb284-24"><a href="#cb284-24" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y<span class="sc">*</span>delta1</span>
<span id="cb284-25"><a href="#cb284-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-26"><a href="#cb284-26" aria-hidden="true" tabindex="-1"></a>  d0 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> (delta1 <span class="sc">+</span> delta2) <span class="co"># censoring indicator</span></span>
<span id="cb284-27"><a href="#cb284-27" aria-hidden="true" tabindex="-1"></a>  d0[y<span class="sc">==</span>tau] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># If follow-up lasts til tau, the event will not count as 'censored' in IPCW weights</span></span>
<span id="cb284-28"><a href="#cb284-28" aria-hidden="true" tabindex="-1"></a>  weights <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb284-29"><a href="#cb284-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-30"><a href="#cb284-30" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Calculate IPCW weights (option to stratify by group) ## </span></span>
<span id="cb284-31"><a href="#cb284-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-32"><a href="#cb284-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(strata<span class="sc">==</span><span class="cn">TRUE</span>){</span>
<span id="cb284-33"><a href="#cb284-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(aa <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(group))){</span>
<span id="cb284-34"><a href="#cb284-34" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Subset the group</span></span>
<span id="cb284-35"><a href="#cb284-35" aria-hidden="true" tabindex="-1"></a>      a <span class="ot">&lt;-</span> <span class="fu">unique</span>(group)[aa]</span>
<span id="cb284-36"><a href="#cb284-36" aria-hidden="true" tabindex="-1"></a>      d0.a <span class="ot">&lt;-</span> d0[group<span class="sc">==</span>a]</span>
<span id="cb284-37"><a href="#cb284-37" aria-hidden="true" tabindex="-1"></a>      delta1.a <span class="ot">&lt;-</span> delta1[group<span class="sc">==</span>a]</span>
<span id="cb284-38"><a href="#cb284-38" aria-hidden="true" tabindex="-1"></a>      y.a <span class="ot">&lt;-</span> y[group<span class="sc">==</span>a]</span>
<span id="cb284-39"><a href="#cb284-39" aria-hidden="true" tabindex="-1"></a>      x.a <span class="ot">&lt;-</span> x[group<span class="sc">==</span>a,]</span>
<span id="cb284-40"><a href="#cb284-40" aria-hidden="true" tabindex="-1"></a>      n.a <span class="ot">&lt;-</span> <span class="fu">length</span>(d0.a)</span>
<span id="cb284-41"><a href="#cb284-41" aria-hidden="true" tabindex="-1"></a>      orig.id.a0 <span class="ot">&lt;-</span> orig.id.a <span class="ot">&lt;-</span> id[group<span class="sc">==</span>a]</span>
<span id="cb284-42"><a href="#cb284-42" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb284-43"><a href="#cb284-43" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Order the event times</span></span>
<span id="cb284-44"><a href="#cb284-44" aria-hidden="true" tabindex="-1"></a>      id.a <span class="ot">&lt;-</span> <span class="fu">order</span>(y.a)</span>
<span id="cb284-45"><a href="#cb284-45" aria-hidden="true" tabindex="-1"></a>      y.a <span class="ot">&lt;-</span> y.a[id.a]</span>
<span id="cb284-46"><a href="#cb284-46" aria-hidden="true" tabindex="-1"></a>      d0.a <span class="ot">&lt;-</span> d0.a[id.a]</span>
<span id="cb284-47"><a href="#cb284-47" aria-hidden="true" tabindex="-1"></a>      delta1.a <span class="ot">&lt;-</span> delta1.a[id.a]</span>
<span id="cb284-48"><a href="#cb284-48" aria-hidden="true" tabindex="-1"></a>      x.a <span class="ot">&lt;-</span> x.a[id.a,]</span>
<span id="cb284-49"><a href="#cb284-49" aria-hidden="true" tabindex="-1"></a>      orig.id.a <span class="ot">&lt;-</span> orig.id.a[id.a]</span>
<span id="cb284-50"><a href="#cb284-50" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb284-51"><a href="#cb284-51" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Derive IPCW</span></span>
<span id="cb284-52"><a href="#cb284-52" aria-hidden="true" tabindex="-1"></a>      fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(y.a, d0.a) <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb284-53"><a href="#cb284-53" aria-hidden="true" tabindex="-1"></a>      weights.a <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>d0.a)<span class="sc">/</span><span class="fu">rep</span>(fit<span class="sc">$</span>surv, <span class="fu">table</span>(y.a))</span>
<span id="cb284-54"><a href="#cb284-54" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb284-55"><a href="#cb284-55" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Need to assign weights accordig to original ID, not ordered by event time</span></span>
<span id="cb284-56"><a href="#cb284-56" aria-hidden="true" tabindex="-1"></a>      linked.weights.a <span class="ot">&lt;-</span> <span class="fu">cbind</span>(orig.id.a, weights.a, delta1.a, d0.a, y.a)</span>
<span id="cb284-57"><a href="#cb284-57" aria-hidden="true" tabindex="-1"></a>      weights <span class="ot">&lt;-</span> <span class="fu">rbind</span>(weights, linked.weights.a)</span>
<span id="cb284-58"><a href="#cb284-58" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb284-59"><a href="#cb284-59" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb284-60"><a href="#cb284-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb284-61"><a href="#cb284-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Order the event times</span></span>
<span id="cb284-62"><a href="#cb284-62" aria-hidden="true" tabindex="-1"></a>    id.a <span class="ot">&lt;-</span> <span class="fu">order</span>(y)</span>
<span id="cb284-63"><a href="#cb284-63" aria-hidden="true" tabindex="-1"></a>    y.a <span class="ot">&lt;-</span> y[id.a]</span>
<span id="cb284-64"><a href="#cb284-64" aria-hidden="true" tabindex="-1"></a>    d0.a <span class="ot">&lt;-</span> d0[id.a]</span>
<span id="cb284-65"><a href="#cb284-65" aria-hidden="true" tabindex="-1"></a>    delta1.a <span class="ot">&lt;-</span> delta1[id.a]</span>
<span id="cb284-66"><a href="#cb284-66" aria-hidden="true" tabindex="-1"></a>    x.a <span class="ot">&lt;-</span> x[id.a,]</span>
<span id="cb284-67"><a href="#cb284-67" aria-hidden="true" tabindex="-1"></a>    orig.id.a <span class="ot">&lt;-</span> id[id.a]</span>
<span id="cb284-68"><a href="#cb284-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb284-69"><a href="#cb284-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Derive IPCW</span></span>
<span id="cb284-70"><a href="#cb284-70" aria-hidden="true" tabindex="-1"></a>    fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(y.a, d0.a) <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb284-71"><a href="#cb284-71" aria-hidden="true" tabindex="-1"></a>    weights.a <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>d0.a)<span class="sc">/</span><span class="fu">rep</span>(fit<span class="sc">$</span>surv, <span class="fu">table</span>(y.a))</span>
<span id="cb284-72"><a href="#cb284-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb284-73"><a href="#cb284-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Need to assign weights accordig to original ID, not ordered by event time</span></span>
<span id="cb284-74"><a href="#cb284-74" aria-hidden="true" tabindex="-1"></a>    linked.weights.a <span class="ot">&lt;-</span> <span class="fu">cbind</span>(orig.id.a, weights.a, delta1.a, d0.a, y.a)</span>
<span id="cb284-75"><a href="#cb284-75" aria-hidden="true" tabindex="-1"></a>    weights <span class="ot">&lt;-</span> <span class="fu">rbind</span>(weights, linked.weights.a)</span>
<span id="cb284-76"><a href="#cb284-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb284-77"><a href="#cb284-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-78"><a href="#cb284-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-79"><a href="#cb284-79" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Fit linear model ## </span></span>
<span id="cb284-80"><a href="#cb284-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-81"><a href="#cb284-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Link weights to original data frame</span></span>
<span id="cb284-82"><a href="#cb284-82" aria-hidden="true" tabindex="-1"></a>  <span class="co">#colnames(weights) &lt;- c('id', 'weights')</span></span>
<span id="cb284-83"><a href="#cb284-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">#data &lt;- merge(data0, weights, by='id')</span></span>
<span id="cb284-84"><a href="#cb284-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">#summary(lm(tau-y ~ x-1, weights=weights, data=data))</span></span>
<span id="cb284-85"><a href="#cb284-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-86"><a href="#cb284-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Or, sort weights and use vectors</span></span>
<span id="cb284-87"><a href="#cb284-87" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> weights[<span class="fu">order</span>(weights[, <span class="dv">1</span>]),<span class="dv">2</span>]</span>
<span id="cb284-88"><a href="#cb284-88" aria-hidden="true" tabindex="-1"></a>  lm.fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(delta1<span class="sc">*</span>(tau<span class="sc">-</span>y) <span class="sc">~</span> x<span class="dv">-1</span>, <span class="at">weights=</span>w)</span>
<span id="cb284-89"><a href="#cb284-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-90"><a href="#cb284-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-91"><a href="#cb284-91" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Derive SE ##</span></span>
<span id="cb284-92"><a href="#cb284-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-93"><a href="#cb284-93" aria-hidden="true" tabindex="-1"></a>  beta0 <span class="ot">&lt;-</span> lm.fit<span class="sc">$</span>coef</span>
<span id="cb284-94"><a href="#cb284-94" aria-hidden="true" tabindex="-1"></a>  error <span class="ot">&lt;-</span> tau <span class="sc">-</span> y <span class="sc">-</span> <span class="fu">as.vector</span>(x <span class="sc">%*%</span> beta0)</span>
<span id="cb284-95"><a href="#cb284-95" aria-hidden="true" tabindex="-1"></a>  score <span class="ot">&lt;-</span> x <span class="sc">*</span> w <span class="sc">*</span> error</span>
<span id="cb284-96"><a href="#cb284-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-97"><a href="#cb284-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Kappa (sandwich variance components) stratified by group</span></span>
<span id="cb284-98"><a href="#cb284-98" aria-hidden="true" tabindex="-1"></a>  kappa <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb284-99"><a href="#cb284-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-100"><a href="#cb284-100" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(aa <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(group))){</span>
<span id="cb284-101"><a href="#cb284-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb284-102"><a href="#cb284-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset the group</span></span>
<span id="cb284-103"><a href="#cb284-103" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">unique</span>(group)[aa]</span>
<span id="cb284-104"><a href="#cb284-104" aria-hidden="true" tabindex="-1"></a>    d0.a <span class="ot">&lt;-</span> d0[group<span class="sc">==</span>a]</span>
<span id="cb284-105"><a href="#cb284-105" aria-hidden="true" tabindex="-1"></a>    delta1.a <span class="ot">&lt;-</span> delta1[group<span class="sc">==</span>a]</span>
<span id="cb284-106"><a href="#cb284-106" aria-hidden="true" tabindex="-1"></a>    y.a <span class="ot">&lt;-</span> y[group<span class="sc">==</span>a]</span>
<span id="cb284-107"><a href="#cb284-107" aria-hidden="true" tabindex="-1"></a>    x.a <span class="ot">&lt;-</span> x[group<span class="sc">==</span>a,]</span>
<span id="cb284-108"><a href="#cb284-108" aria-hidden="true" tabindex="-1"></a>    n.a <span class="ot">&lt;-</span> <span class="fu">length</span>(d0.a)</span>
<span id="cb284-109"><a href="#cb284-109" aria-hidden="true" tabindex="-1"></a>    orig.id.a0 <span class="ot">&lt;-</span> orig.id.a <span class="ot">&lt;-</span> id[group<span class="sc">==</span>a]</span>
<span id="cb284-110"><a href="#cb284-110" aria-hidden="true" tabindex="-1"></a>    score.a <span class="ot">&lt;-</span> score[group<span class="sc">==</span>a,]</span>
<span id="cb284-111"><a href="#cb284-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb284-112"><a href="#cb284-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Kappa calculations for sandwich variance</span></span>
<span id="cb284-113"><a href="#cb284-113" aria-hidden="true" tabindex="-1"></a>    kappa.a <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n.a, p)</span>
<span id="cb284-114"><a href="#cb284-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb284-115"><a href="#cb284-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.a){</span>
<span id="cb284-116"><a href="#cb284-116" aria-hidden="true" tabindex="-1"></a>      kappa1 <span class="ot">&lt;-</span> score.a[i,]</span>
<span id="cb284-117"><a href="#cb284-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb284-118"><a href="#cb284-118" aria-hidden="true" tabindex="-1"></a>      kappa2 <span class="ot">&lt;-</span> <span class="fu">apply</span>(score.a[y.a<span class="sc">&gt;=</span>y.a[i],,<span class="at">drop=</span>F], <span class="dv">2</span>, sum)<span class="sc">*</span>(d0.a[i])<span class="sc">/</span><span class="fu">sum</span>(y.a<span class="sc">&gt;=</span>y.a[i])</span>
<span id="cb284-119"><a href="#cb284-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb284-120"><a href="#cb284-120" aria-hidden="true" tabindex="-1"></a>      kappa3 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, p)</span>
<span id="cb284-121"><a href="#cb284-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb284-122"><a href="#cb284-122" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n.a){</span>
<span id="cb284-123"><a href="#cb284-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(y.a[k]<span class="sc">&lt;=</span>y.a[i]){</span>
<span id="cb284-124"><a href="#cb284-124" aria-hidden="true" tabindex="-1"></a>          kappa3 <span class="ot">&lt;-</span> kappa3<span class="sc">+</span><span class="fu">apply</span>(score.a[y.a<span class="sc">&gt;=</span>y.a[k],,<span class="at">drop=</span>F], <span class="dv">2</span>, sum)<span class="sc">*</span>(d0.a[k])<span class="sc">/</span>(<span class="fu">sum</span>(y.a<span class="sc">&gt;=</span>y.a[k]))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb284-125"><a href="#cb284-125" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb284-126"><a href="#cb284-126" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb284-127"><a href="#cb284-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-128"><a href="#cb284-128" aria-hidden="true" tabindex="-1"></a>      kappa.a[i,] <span class="ot">&lt;-</span> kappa1<span class="sc">+</span>kappa2<span class="sc">-</span>kappa3</span>
<span id="cb284-129"><a href="#cb284-129" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb284-130"><a href="#cb284-130" aria-hidden="true" tabindex="-1"></a>    kappa <span class="ot">&lt;-</span> <span class="fu">rbind</span>(kappa, kappa.a)</span>
<span id="cb284-131"><a href="#cb284-131" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb284-132"><a href="#cb284-132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-133"><a href="#cb284-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transpose the kappas rbinded from each group gives pxp matrix</span></span>
<span id="cb284-134"><a href="#cb284-134" aria-hidden="true" tabindex="-1"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">t</span>(kappa) <span class="sc">%*%</span> kappa</span>
<span id="cb284-135"><a href="#cb284-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-136"><a href="#cb284-136" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">t</span>(x) <span class="sc">%*%</span> x</span>
<span id="cb284-137"><a href="#cb284-137" aria-hidden="true" tabindex="-1"></a>  varbeta <span class="ot">&lt;-</span> <span class="fu">solve</span>(A) <span class="sc">%*%</span> gamma <span class="sc">%*%</span> <span class="fu">solve</span>(A)</span>
<span id="cb284-138"><a href="#cb284-138" aria-hidden="true" tabindex="-1"></a>  se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(varbeta))</span>
<span id="cb284-139"><a href="#cb284-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-140"><a href="#cb284-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-141"><a href="#cb284-141" aria-hidden="true" tabindex="-1"></a>  <span class="co">#--- Return results ---</span></span>
<span id="cb284-142"><a href="#cb284-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-143"><a href="#cb284-143" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">beta=</span>lm.fit<span class="sc">$</span>coef, <span class="at">se=</span>se, <span class="at">cil=</span>lm.fit<span class="sc">$</span>coef<span class="sc">-</span>(<span class="fl">1.96</span><span class="sc">*</span>se), <span class="at">ciu=</span>lm.fit<span class="sc">$</span>coef<span class="sc">+</span>(<span class="fl">1.96</span><span class="sc">*</span>se), </span>
<span id="cb284-144"><a href="#cb284-144" aria-hidden="true" tabindex="-1"></a>               <span class="at">z=</span>lm.fit<span class="sc">$</span>coef<span class="sc">/</span>se, <span class="at">p=</span><span class="dv">2</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">pnorm</span>(<span class="fu">abs</span>(lm.fit<span class="sc">$</span>coef<span class="sc">/</span>se))))</span>
<span id="cb284-145"><a href="#cb284-145" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rownames(res) &lt;- c("Intercept", colnames(x[,-1])): REMOVED!</span></span>
<span id="cb284-146"><a href="#cb284-146" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-147"><a href="#cb284-147" aria-hidden="true" tabindex="-1"></a>  allres <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">res=</span>res, <span class="at">varbeta=</span>varbeta)</span>
<span id="cb284-148"><a href="#cb284-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">round</span>(res, <span class="dv">3</span>))</span>
<span id="cb284-149"><a href="#cb284-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(allres)</span>
<span id="cb284-150"><a href="#cb284-150" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(res[,<span class="dv">1</span>]) <span class="co"># ADDED</span></span>
<span id="cb284-151"><a href="#cb284-151" aria-hidden="true" tabindex="-1"></a>}  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The argument <strong>times</strong> is the time of event or censoring for all subjects. The argument <strong>event</strong> is the type of transition happening at the time <strong>times</strong> for all subjects. The arguments <strong>eio</strong> and <strong>tau</strong> are the event of interest and the threshold <span class="math inline">\(\tau\)</span>. The argument <strong>cov</strong> gives the covariates to be included in the model.</p>
<p>We will first extract the values of our covariates of interest and store them as <strong>covar46</strong>.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-148_e35872e638fdeb4ff8aa562ee359ba7b">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting the values of the covariates ESVEA, sex, age, and sbp</span></span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a>covar46 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(newchs<span class="sc">$</span>esvea, newchs<span class="sc">$</span>sex, newchs<span class="sc">$</span>age, newchs<span class="sc">$</span>sbp)</span>
<span id="cb285-3"><a href="#cb285-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(covar46) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"esvea"</span>, <span class="st">"sex"</span>, <span class="st">"age"</span>, <span class="st">"sbp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then, we will fit a linear model for the time lost due to stroke using the function <strong>rmtl.ipcw</strong>. The arguments <strong>times</strong>, <strong>event</strong>, <strong>eoi</strong>, <strong>tau</strong> and <strong>cov</strong> are set to <strong>chs_data$timestrokeordeath</strong>, <strong>fg_event</strong>, 1, 3 and **covar46, respectively.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-149_1dd545947aa3aa4a2fabb28a5b0d71f3">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a linear model for the time lost due to stroke before 3 ears</span></span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a>newchs<span class="sc">$</span>death_wo_stroke <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(newchs<span class="sc">$</span>stroke <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, newchs<span class="sc">$</span>death)</span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a>newchs<span class="sc">$</span>fg_event <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(newchs<span class="sc">$</span>death_wo_stroke <span class="sc">==</span> <span class="dv">0</span>, newchs<span class="sc">$</span>stroke, newchs<span class="sc">$</span>death_wo_stroke<span class="sc">*</span><span class="dv">2</span>)</span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-6"><a href="#cb286-6" aria-hidden="true" tabindex="-1"></a>(rmtl_stroke <span class="ot">&lt;-</span> <span class="fu">rmtl.ipcw</span>(<span class="at">times =</span> newchs<span class="sc">$</span>timestrokeordeath,<span class="at">event =</span> newchs<span class="sc">$</span>fg_event, <span class="at">eoi =</span> <span class="dv">1</span>, <span class="at">tau =</span> <span class="dv">3</span>, <span class="at">cov =</span> covar46))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         beta    se    cil   ciu      z     p
xint   -0.277 0.211 -0.691 0.137 -1.313 0.189
xesvea  0.005 0.053 -0.099 0.110  0.095 0.924
xsex    0.024 0.036 -0.046 0.094  0.666 0.506
xage    0.004 0.003 -0.001 0.010  1.532 0.126
xsbp    0.000 0.001 -0.001 0.001 -0.004 0.997</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         xint        xesvea          xsex          xage          xsbp 
-2.774303e-01  5.072473e-03  2.377510e-02  4.439468e-03 -3.000091e-06 </code></pre>
</div>
</div>
<p>Thus, we obtain the following model for the time lost before 3 years due to stroke</p>
<p><span class="math display">\[\varepsilon(3|Z) = -0.277 + 0.005 \cdot Z_1  + 0.024 \cdot Z_2  + 0.004 \cdot Z_3 - 3 \cdot 10^{-6} \cdot Z_4,\]</span></p>
<p>where <span class="math inline">\((Z_1,Z_2,Z_3,Z_4)\)</span> are ESVEA, sex, age, and systolic blood pressure.</p>
<p>We will fit a linear model to the time lost due to death without stroke by changing the value of the <strong>eio</strong> argument to 2.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-150_23dd9e5ab9fb28de82305dd9f8f1981c">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb289"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a linear model for the time lost due to death without stroke before 3 years</span></span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a>(rmtl_death <span class="ot">&lt;-</span> <span class="fu">rmtl.ipcw</span>(newchs<span class="sc">$</span>timestrokeordeath,newchs<span class="sc">$</span>fg_event, <span class="at">eoi =</span> <span class="dv">2</span>, <span class="at">tau =</span> <span class="dv">3</span>, covar46))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         beta    se    cil   ciu      z     p
xint   -0.078 0.210 -0.489 0.333 -0.371 0.711
xesvea  0.022 0.053 -0.081 0.126  0.422 0.673
xsex    0.030 0.036 -0.039 0.100  0.852 0.394
xage    0.003 0.003 -0.003 0.009  1.001 0.317
xsbp   -0.001 0.001 -0.002 0.001 -0.752 0.452</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         xint        xesvea          xsex          xage          xsbp 
-0.0777484888  0.0223008572  0.0302582070  0.0028827687 -0.0005114223 </code></pre>
</div>
</div>
<p>Thus, we obtain the following model for the time lost before 3 years due to death without stroke</p>
<p><span class="math display">\[\varepsilon(3|Z) = -0.078 + 0.022 \cdot Z_1  + 0.03 \cdot Z_2  + 0.003 \cdot Z_3 - 0.001 \cdot Z_4,\]</span> where <span class="math inline">\((Z_1,Z_2,Z_3,Z_4)\)</span> are ESVEA, sex, age, and systolic blood pressure.</p>
<p>We will finally estimate the cause-specific time lost for subjects with or without ESVEA non-parametrically as the area under the Aalen-Johansen estimates. We use the aj object from the previous exercise (where the option influence=TRUE provides SD estimates).</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-151_2ea50cc2cda610a0ede0124cda1eb0a4">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb292"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(aj,<span class="at">rmean=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(timestrokeordeath, factor(fg_event), type = "mstate") ~ 
    esvea, data = chs_data, influence = TRUE)

                n nevent      rmean  se(rmean)*
esvea=0, (s0) 579      0 2.93362840 0.015098727
esvea=1, (s0)  99      0 2.86719350 0.048735634
esvea=0, 1    579     52 0.01954915 0.007978075
esvea=1, 1     99     21 0.05767462 0.029900214
esvea=0, 2    579    178 0.04682245 0.012941548
esvea=1, 2     99     36 0.07513188 0.039606548
   *restricted mean time in state (max time = 3 )</code></pre>
</div>
</div>
</div>
<div id="tabset-51-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-51-2-tab">
<p>There is currently not an implementation of a procedure for linear models of the number of years lost due to a specific cause in SAS.</p>
</div>
</div>
</div>
</section>
<section id="exercise-4.7" class="level3">
<h3 class="anchored" data-anchor-id="exercise-4.7">Exercise 4.7</h3>
<p><em>Consider an illness-death model for the Copenhagen Holter study with states 0: Alive without AF or stroke, 1: Alive with AF and no stroke, 2: Dead or stroke, see Figures 1.3 and 1.7.</em></p>
<section id="section-4" class="level4">
<h4 class="anchored" data-anchor-id="section-4">1.</h4>
<p><em>Estimate the prevalence of AF.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-52-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-52-1" role="tab" aria-controls="tabset-52-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-52-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-52-2" role="tab" aria-controls="tabset-52-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-52-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-52-1-tab">
<p>The prevalence of AF at time <span class="math inline">\(t\)</span> can be estimated as the conditional probability of having AF at time <span class="math inline">\(t\)</span> given alive at time <span class="math inline">\(t\)</span>, i.e.&nbsp;<span class="math inline">\(\frac{Q_1(t)}{Q_0(t) + Q_1(t)}\)</span>. Here, <span class="math inline">\(Q_0\)</span> and <span class="math inline">\(Q_1\)</span> can be estimated the <em>mstate</em> package. We must first define a transition matrix, <strong>tmat</strong> for the ilness-death model and turn the data into long format using the <strong>msprep</strong> function as we did in exercise 1.2. Then, we extract the hazards for each transition using the <strong>msfit</strong> function. Finally, <span class="math inline">\(Q_0\)</span> and <span class="math inline">\(Q_1\)</span> are estimated with the <strong>probtrans</strong> function where the prediction time <strong>predt</strong> is set to 0.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-152_968c728609e3ec34c11c87be29f96b4d">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb294"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Transition matrix for the three-state illness-death model.</span></span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a>tmat <span class="ot">&lt;-</span> <span class="fu">trans.illdeath</span>()</span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Putting the data on long format, i.e. 1 row per possible transition</span></span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a>chs_data <span class="ot">&lt;-</span> chs_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">timestroke =</span> <span class="fu">ifelse</span>(stroke <span class="sc">==</span> <span class="dv">1</span>, timestroke, timedeath),</span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a>                                <span class="at">timeafib =</span> <span class="fu">ifelse</span>(afib <span class="sc">==</span> <span class="dv">1</span>, timeafib, timestroke))</span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a>long_format <span class="ot">&lt;-</span> <span class="fu">msprep</span>(<span class="at">time =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="st">"timeafib"</span>, <span class="st">"timestrokeordeath"</span>), <span class="at">status =</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="st">"afib"</span>,<span class="st">"strokeordeath"</span>), <span class="at">data =</span> chs_data, <span class="at">trans =</span> tmat)</span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-9"><a href="#cb294-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a model for each of the three transitions, 0 -&gt; 1, 0 -&gt; 2 and 1 -&gt; 2.</span></span>
<span id="cb294-10"><a href="#cb294-10" aria-hidden="true" tabindex="-1"></a>cox471 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Tstart, Tstop, status) <span class="sc">~</span> <span class="fu">strata</span>(trans), <span class="at">data =</span> long_format, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb294-11"><a href="#cb294-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-12"><a href="#cb294-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting the hazards for each transition</span></span>
<span id="cb294-13"><a href="#cb294-13" aria-hidden="true" tabindex="-1"></a>msfit <span class="ot">&lt;-</span> <span class="fu">msfit</span>(cox471, <span class="at">trans =</span> tmat)</span>
<span id="cb294-14"><a href="#cb294-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-15"><a href="#cb294-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating the state occupation probabilities; pstate1 is $Q_0$, pstate2 is $Q_1$, and pstate3 is $Q_2$.</span></span>
<span id="cb294-16"><a href="#cb294-16" aria-hidden="true" tabindex="-1"></a>probtrans <span class="ot">&lt;-</span> <span class="fu">probtrans</span>(msfit, <span class="at">predt =</span> <span class="dv">0</span>)</span>
<span id="cb294-17"><a href="#cb294-17" aria-hidden="true" tabindex="-1"></a>AaJ471 <span class="ot">&lt;-</span> probtrans[[<span class="dv">1</span>]]</span>
<span id="cb294-18"><a href="#cb294-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-19"><a href="#cb294-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating the prevalence of AF</span></span>
<span id="cb294-20"><a href="#cb294-20" aria-hidden="true" tabindex="-1"></a>AaJ471<span class="sc">$</span>prevalence <span class="ot">&lt;-</span> AaJ471<span class="sc">$</span>pstate2 <span class="sc">/</span> (AaJ471<span class="sc">$</span>pstate1 <span class="sc">+</span> AaJ471<span class="sc">$</span>pstate2)</span>
<span id="cb294-21"><a href="#cb294-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-22"><a href="#cb294-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the prevalence of AF against time</span></span>
<span id="cb294-23"><a href="#cb294-23" aria-hidden="true" tabindex="-1"></a>(fig471 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> prevalence), <span class="at">data =</span> AaJ471) <span class="sc">+</span></span>
<span id="cb294-24"><a href="#cb294-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">geom_step</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-152-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-52-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-52-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-153_05936451f6ffb1be03aa5cca21551459">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="co">* The prevalence of AF is given by Q_1 / (Q_0 + Q_1). Thus, we must first obtain estimates of Q_0 and Q_1.</span></span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a><span class="co">* We will first fill in the empty spots of timeafib and replace paths where AF happens after stroke;</span></span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a><span class="co">* We will also add an censoring variable for leaving state 0 called 'outof0'.;</span></span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'4.7.1'</span>;</span>
<span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> chs_<span class="kw">data</span>;</span>
<span id="cb295-8"><a href="#cb295-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> chs_<span class="kw">data</span>;</span>
<span id="cb295-9"><a href="#cb295-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> afib = <span class="dv">1</span> <span class="kw">and</span> timeafib &gt; timestrokeordeath <span class="kw">then</span> afib = <span class="dv">0</span>;</span>
<span id="cb295-10"><a href="#cb295-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> afib = <span class="dv">0</span> <span class="kw">then</span> timeafib = timestrokeordeath;</span>
<span id="cb295-11"><a href="#cb295-11" aria-hidden="true" tabindex="-1"></a>    outof0 = <span class="dv">0</span>;</span>
<span id="cb295-12"><a href="#cb295-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> afib = <span class="dv">1</span> <span class="kw">or</span> strokeordeath = <span class="dv">1</span> <span class="kw">then</span> outof0 = <span class="dv">1</span>;</span>
<span id="cb295-13"><a href="#cb295-13" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb295-14"><a href="#cb295-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-15"><a href="#cb295-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-16"><a href="#cb295-16" aria-hidden="true" tabindex="-1"></a><span class="co">* Then, we will fit a model for being in state 0 by using 'timeafib' as our time variable and 'outof0' as our censoring variable;</span></span>
<span id="cb295-17"><a href="#cb295-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-18"><a href="#cb295-18" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=chs_<span class="kw">data</span>; <span class="co">/* Q0(t) */</span></span>
<span id="cb295-19"><a href="#cb295-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timeafib*outof0(<span class="dv">0</span>)=;</span>
<span id="cb295-20"><a href="#cb295-20" aria-hidden="true" tabindex="-1"></a>    baseline out=q0 survival=km0;</span>
<span id="cb295-21"><a href="#cb295-21" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb295-22"><a href="#cb295-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-23"><a href="#cb295-23" aria-hidden="true" tabindex="-1"></a><span class="co">* We will also fit a model for being in state 0 or state 1 by using 'timestrokeordeath' as our timevariable and 'strokeordeath' </span></span>
<span id="cb295-24"><a href="#cb295-24" aria-hidden="true" tabindex="-1"></a><span class="co">  as our censoring variable.;</span></span>
<span id="cb295-25"><a href="#cb295-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-26"><a href="#cb295-26" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=chs_<span class="kw">data</span>; <span class="co">/* Q0(t) + Q1(t) */</span></span>
<span id="cb295-27"><a href="#cb295-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timestrokeordeath*strokeordeath(<span class="dv">0</span>)=;</span>
<span id="cb295-28"><a href="#cb295-28" aria-hidden="true" tabindex="-1"></a>    baseline out=q0andq1 survival = km01;</span>
<span id="cb295-29"><a href="#cb295-29" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb295-30"><a href="#cb295-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-31"><a href="#cb295-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-32"><a href="#cb295-32" aria-hidden="true" tabindex="-1"></a><span class="co">* We will now estimate the probability of being in state 1 as the difference between the two models specified above. We must </span></span>
<span id="cb295-33"><a href="#cb295-33" aria-hidden="true" tabindex="-1"></a><span class="co">  first merge the data frames 'q0' and 'q0andq1' by the joint 'time' variable and fill the empty cells for the survival </span></span>
<span id="cb295-34"><a href="#cb295-34" aria-hidden="true" tabindex="-1"></a><span class="co">  probabilities with the last observed value. Then, 'q1' and the prevalence 'prev' is added to the dataframe 'allrev'.;</span></span>
<span id="cb295-35"><a href="#cb295-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-36"><a href="#cb295-36" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> q0; <span class="kw">set</span> q0; <span class="fu">time</span>=timeafib<span class="kw">; run</span>;</span>
<span id="cb295-37"><a href="#cb295-37" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> q0andq1; <span class="kw">set</span> q0andq1; <span class="fu">time</span>=timestrokeordeath<span class="kw">; run</span>;</span>
<span id="cb295-38"><a href="#cb295-38" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> all; <span class="kw">merge</span> q0 q0andq1; <span class="kw">by</span> <span class="fu">time</span><span class="kw">; run</span>;</span>
<span id="cb295-39"><a href="#cb295-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-40"><a href="#cb295-40" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> allrev; </span>
<span id="cb295-41"><a href="#cb295-41" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> all;</span>
<span id="cb295-42"><a href="#cb295-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> <span class="fu">time</span>;</span>
<span id="cb295-43"><a href="#cb295-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> last1 last2;</span>
<span id="cb295-44"><a href="#cb295-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> km0=. <span class="kw">then</span> q0=last1; <span class="kw">if</span> km0 ne . <span class="kw">then</span> q0=km0; *AF-free survival, Q0; </span>
<span id="cb295-45"><a href="#cb295-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> km01=. <span class="kw">then</span> q01=last2; <span class="kw">if</span> km01 ne . <span class="kw">then</span> q01=km01; *Q0 + Q1;</span>
<span id="cb295-46"><a href="#cb295-46" aria-hidden="true" tabindex="-1"></a>    q1 = q01 - q0;</span>
<span id="cb295-47"><a href="#cb295-47" aria-hidden="true" tabindex="-1"></a>    prev = q1/q01;</span>
<span id="cb295-48"><a href="#cb295-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output</span>;</span>
<span id="cb295-49"><a href="#cb295-49" aria-hidden="true" tabindex="-1"></a>    last1=q0; last2=q01; </span>
<span id="cb295-50"><a href="#cb295-50" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb295-51"><a href="#cb295-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-52"><a href="#cb295-52" aria-hidden="true" tabindex="-1"></a><span class="co">*Finally, we plot the result;</span></span>
<span id="cb295-53"><a href="#cb295-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-54"><a href="#cb295-54" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=allrev;</span>
<span id="cb295-55"><a href="#cb295-55" aria-hidden="true" tabindex="-1"></a>    title<span class="st">'4.7.1: Prevalence of AF'</span>;</span>
<span id="cb295-56"><a href="#cb295-56" aria-hidden="true" tabindex="-1"></a>    plot prev*<span class="fu">time</span> / haxis=axis1 vaxis=axis2;</span>
<span id="cb295-57"><a href="#cb295-57" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">16</span> <span class="kw">by</span> <span class="dv">5</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb295-58"><a href="#cb295-58" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">0.12</span> <span class="kw">by</span> <span class="dv">0.02</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Prevalence of AF'</span>);</span>
<span id="cb295-59"><a href="#cb295-59" aria-hidden="true" tabindex="-1"></a>    symbol  v=none i=stepjl c=blue;</span>
<span id="cb295-60"><a href="#cb295-60" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="section-5" class="level4">
<h4 class="anchored" data-anchor-id="section-5">2.</h4>
<p><em>Estimate the expected lengths of stay in states 0 or 1 up to 3 years.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-53-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-53-1" role="tab" aria-controls="tabset-53-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-53-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-53-2" role="tab" aria-controls="tabset-53-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-53-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-53-1-tab">
<p>The expected lengths of stay in states 0 or 1 up till 3 years can be estimated using the <strong>ELOS</strong> function from the <strong>mstate</strong> package which take a <strong>probtrans</strong> object and threshold <strong>tau</strong> as input.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-154_0208252e3d76dfbc679132a2f5268844">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb296"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimating the expected length of stay in each state from state 0 before 3 years</span></span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>(ELOS472 <span class="ot">&lt;-</span> <span class="fu">ELOS</span>(probtrans, <span class="at">tau =</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           in1         in2        in3
from1 2.915131 0.008797062 0.07607227
from2 0.000000 3.000000000 0.00000000
from3 0.000000 0.000000000 3.00000000</code></pre>
</div>
</div>
<p>Thus, the expected length of stay up till 3 years is <span class="math inline">\(2.9151\)</span> in state 0 and <span class="math inline">\(0.0088\)</span> in state 1.</p>
</div>
<div id="tabset-53-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-53-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-155_6a13326b60c23fc5c1e8011cff5caa4b">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb298"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a><span class="co">* To estimate the expected length of stay in state 0 and state 1 up till 3 years we will integrate the functions for being in state </span></span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a><span class="co">  0 or 1 from 0 t0 3 years. </span></span>
<span id="cb298-3"><a href="#cb298-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-4"><a href="#cb298-4" aria-hidden="true" tabindex="-1"></a><span class="co">* We must first add the time point for 3 years to the data set 'allrev'.;</span></span>
<span id="cb298-5"><a href="#cb298-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-6"><a href="#cb298-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> end_point; <span class="fu">time</span> = <span class="dv">3</span><span class="kw">; run</span>;</span>
<span id="cb298-7"><a href="#cb298-7" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> allrev; <span class="kw">merge</span> allrev end_point; <span class="kw">by</span> <span class="fu">time</span><span class="kw">; run</span>;</span>
<span id="cb298-8"><a href="#cb298-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-9"><a href="#cb298-9" aria-hidden="true" tabindex="-1"></a><span class="co">* Then we will calculate the product of the length of each time period and the value of q0 or q1 and then sum these products to </span></span>
<span id="cb298-10"><a href="#cb298-10" aria-hidden="true" tabindex="-1"></a><span class="co">  obtain estimates of the expected length of state in state 0 or 1.;</span></span>
<span id="cb298-11"><a href="#cb298-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-12"><a href="#cb298-12" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> allrev;</span>
<span id="cb298-13"><a href="#cb298-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> allrev;</span>
<span id="cb298-14"><a href="#cb298-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> elos0 elos1;</span>
<span id="cb298-15"><a href="#cb298-15" aria-hidden="true" tabindex="-1"></a>    dq0 = <span class="fu">dif</span>(<span class="fu">time</span>)*<span class="fu">lag</span>(q0);</span>
<span id="cb298-16"><a href="#cb298-16" aria-hidden="true" tabindex="-1"></a>    dq1 = <span class="fu">dif</span>(<span class="fu">time</span>)*<span class="fu">lag</span>(q1);</span>
<span id="cb298-17"><a href="#cb298-17" aria-hidden="true" tabindex="-1"></a>    elos0 + dq0;</span>
<span id="cb298-18"><a href="#cb298-18" aria-hidden="true" tabindex="-1"></a>    elos1 + dq1;</span>
<span id="cb298-19"><a href="#cb298-19" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb298-20"><a href="#cb298-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-21"><a href="#cb298-21" aria-hidden="true" tabindex="-1"></a><span class="co">* Finally, we will print the result;</span></span>
<span id="cb298-22"><a href="#cb298-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb298-23"><a href="#cb298-23" aria-hidden="true" tabindex="-1"></a>title<span class="st">'4.7.2'</span>;</span>
<span id="cb298-24"><a href="#cb298-24" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> print<span class="kw"> data</span> = allrev;</span>
<span id="cb298-25"><a href="#cb298-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">var</span> <span class="fu">time</span> elos0 elos1;</span>
<span id="cb298-26"><a href="#cb298-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> <span class="fu">time</span> = <span class="dv">3</span>;</span>
<span id="cb298-27"><a href="#cb298-27" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="section-6" class="level4">
<h4 class="anchored" data-anchor-id="section-6">3.</h4>
<p><em>Evaluate the SD of the expected lengths of stay using the bootstrap.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-54-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-54-1" role="tab" aria-controls="tabset-54-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-54-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-54-2" role="tab" aria-controls="tabset-54-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-54-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-54-1-tab">
<p>We will use bootstrapping to estimate the SD of the expected lengths of stay in states 0 and 1. This can be done using the <strong>msboot</strong> function from the <em>mstate</em> package.</p>
<p>We must first create a function which, given a data set <strong>data</strong>, calculates the statistics of interest, in this case the expected lengths of stay in state 0 and 1. Then, the <strong>msboot</strong> function takes this function as well as the data in long format, the desired number of bootstrap replications <strong>B</strong> and the name of the <strong>id</strong> variable in the data frame as arguments.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-156_8ac2e889eba58298ee03d2510624ae0e">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb299"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting a seed for reproducibility</span></span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Function of data returning the value of the statistic to be bootstrapped</span></span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a>boot_fct473 <span class="ot">&lt;-</span> <span class="cf">function</span>(data){</span>
<span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a>  cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Tstart, Tstop, status) <span class="sc">~</span> <span class="fu">strata</span>(trans), <span class="at">data =</span> data, <span class="at">method =</span> <span class="st">"breslow"</span>)</span>
<span id="cb299-7"><a href="#cb299-7" aria-hidden="true" tabindex="-1"></a>  msfit <span class="ot">&lt;-</span>  <span class="fu">msfit</span>(cox, <span class="at">trans =</span> tmat)</span>
<span id="cb299-8"><a href="#cb299-8" aria-hidden="true" tabindex="-1"></a>  pt <span class="ot">&lt;-</span> <span class="fu">probtrans</span>(msfit, <span class="at">predt =</span> <span class="dv">0</span>, <span class="at">direction =</span> <span class="st">"forward"</span>, <span class="at">method =</span> <span class="st">"aalen"</span>)</span>
<span id="cb299-9"><a href="#cb299-9" aria-hidden="true" tabindex="-1"></a>  elos <span class="ot">&lt;-</span> <span class="fu">ELOS</span>(pt, <span class="dv">3</span>)</span>
<span id="cb299-10"><a href="#cb299-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(elos[<span class="dv">1</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])}</span>
<span id="cb299-11"><a href="#cb299-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-12"><a href="#cb299-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrapping with B = 200</span></span>
<span id="cb299-13"><a href="#cb299-13" aria-hidden="true" tabindex="-1"></a>elos_boot473 <span class="ot">&lt;-</span> <span class="fu">msboot</span>(<span class="at">theta =</span> boot_fct473, <span class="at">data =</span> long_format, <span class="at">B =</span> <span class="dv">200</span>, <span class="at">id =</span> <span class="st">"id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, the mean and standard deviation of the statistics based on the bootstrap samples can be calculated</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-157_90291fa9b2e8bd61136a798534f96a16">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean and SD obtained using bootstrapping for expected length of stay in state 0 and 1</span></span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>(<span class="fu">c</span>(<span class="fu">mean</span>(elos_boot473[<span class="dv">1</span>,]), <span class="fu">sqrt</span>(<span class="fu">var</span>(elos_boot473[<span class="dv">1</span>,]))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.91297302 0.01642631</code></pre>
</div>
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">c</span>(<span class="fu">mean</span>(elos_boot473[<span class="dv">2</span>,]), <span class="fu">sqrt</span>(<span class="fu">var</span>(elos_boot473[<span class="dv">2</span>,]))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.009175036 0.004859470</code></pre>
</div>
</div>
<p>We obtain an estimate for the standard deviation of 0.0160782 for the expected length in state 0 and 0.004976452 for the expected length in state 1 using a bootstrap with 200 replications.</p>
</div>
<div id="tabset-54-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-54-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-158_c763aa60ab9ababd98a5dd532f7cc3c7">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="co">* We will first make our bootstrap data frames. We will make 200 bootstrap samples and each bootstrap sample contains 678 rows which</span></span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a><span class="co">  are sampled with replacement from our originqal data.;</span></span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a>title<span class="st">'4.7.3'</span>;</span>
<span id="cb304-5"><a href="#cb304-5" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> boot_chs;</span>
<span id="cb304-6"><a href="#cb304-6" aria-hidden="true" tabindex="-1"></a><span class="kw">    do</span> sampnum = <span class="dv">1</span> <span class="kw">to</span> <span class="dv">200</span>; <span class="co">/* nboot=200*/</span></span>
<span id="cb304-7"><a href="#cb304-7" aria-hidden="true" tabindex="-1"></a><span class="kw">    do</span> i = <span class="dv">1</span> <span class="kw">to</span> <span class="dv">678</span>; <span class="co">/*nobs=678*/</span></span>
<span id="cb304-8"><a href="#cb304-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">x</span>=<span class="fu">round</span>(<span class="fu">ranuni</span>(<span class="dv">0</span>)*<span class="dv">678</span>); <span class="co">/*nobs=678*/</span></span>
<span id="cb304-9"><a href="#cb304-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> chs_<span class="kw">data</span></span>
<span id="cb304-10"><a href="#cb304-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">point</span>=<span class="kw">x</span>;</span>
<span id="cb304-11"><a href="#cb304-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output</span>;</span>
<span id="cb304-12"><a href="#cb304-12" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb304-13"><a href="#cb304-13" aria-hidden="true" tabindex="-1"></a><span class="kw">    end</span>;</span>
<span id="cb304-14"><a href="#cb304-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">stop</span>;</span>
<span id="cb304-15"><a href="#cb304-15" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb304-16"><a href="#cb304-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-17"><a href="#cb304-17" aria-hidden="true" tabindex="-1"></a><span class="co">* Then we will estimate the expected length of stay in state 0 before 3 years based on each of the 200 bootstrap samples;</span></span>
<span id="cb304-18"><a href="#cb304-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-19"><a href="#cb304-19" aria-hidden="true" tabindex="-1"></a><span class="co">* We will first estimate the probability of being in state 0 and the probability of being in either state 0 or state 1.;</span></span>
<span id="cb304-20"><a href="#cb304-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-21"><a href="#cb304-21" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=boot_chs noprint; <span class="co">/* Q0(t) */</span></span>
<span id="cb304-22"><a href="#cb304-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> sampnum;</span>
<span id="cb304-23"><a href="#cb304-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timeafib*outof0(<span class="dv">0</span>)=;</span>
<span id="cb304-24"><a href="#cb304-24" aria-hidden="true" tabindex="-1"></a>    baseline out=q0_boot survival=km0;</span>
<span id="cb304-25"><a href="#cb304-25" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb304-26"><a href="#cb304-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-27"><a href="#cb304-27" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=boot_chs noprint; <span class="co">/* Q0(t) + Q1(t) */</span></span>
<span id="cb304-28"><a href="#cb304-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> sampnum;</span>
<span id="cb304-29"><a href="#cb304-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timestrokeordeath*strokeordeath(<span class="dv">0</span>)=;</span>
<span id="cb304-30"><a href="#cb304-30" aria-hidden="true" tabindex="-1"></a>    baseline out=q0andq1_boot survival = km01;</span>
<span id="cb304-31"><a href="#cb304-31" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb304-32"><a href="#cb304-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-33"><a href="#cb304-33" aria-hidden="true" tabindex="-1"></a><span class="co">* Then, we will merge the two datasets by time and add the time point for 3 years to all bootstrap samples.;</span></span>
<span id="cb304-34"><a href="#cb304-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-35"><a href="#cb304-35" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> q0_boot; <span class="kw">set</span> q0_boot; <span class="fu">time</span>=timeafib<span class="kw">; run</span>;</span>
<span id="cb304-36"><a href="#cb304-36" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> q0andq1_boot; <span class="kw">set</span> q0andq1_boot; <span class="fu">time</span>=timestrokeordeath<span class="kw">; run</span>;</span>
<span id="cb304-37"><a href="#cb304-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-38"><a href="#cb304-38" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> end_point<span class="kw">; do</span> sampnum = <span class="dv">1</span> <span class="kw">to</span> <span class="dv">200</span>; <span class="fu">time</span> = <span class="dv">3</span>; <span class="kw">output; end; run</span>;</span>
<span id="cb304-39"><a href="#cb304-39" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> all_boot; <span class="kw">merge</span> q0_boot q0andq1_boot end_point; <span class="kw">by</span> sampnum <span class="fu">time</span><span class="kw">; run</span>;</span>
<span id="cb304-40"><a href="#cb304-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-41"><a href="#cb304-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-42"><a href="#cb304-42" aria-hidden="true" tabindex="-1"></a><span class="co">* Then, we will estimate q1 as the difference between the probability of being in either state 0 or state 1 and the </span></span>
<span id="cb304-43"><a href="#cb304-43" aria-hidden="true" tabindex="-1"></a><span class="co">  probability of being in state 0.;</span></span>
<span id="cb304-44"><a href="#cb304-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-45"><a href="#cb304-45" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> allrev_boot; </span>
<span id="cb304-46"><a href="#cb304-46" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> all_boot;</span>
<span id="cb304-47"><a href="#cb304-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> sampnum <span class="fu">time</span>;</span>
<span id="cb304-48"><a href="#cb304-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> last1 last2;</span>
<span id="cb304-49"><a href="#cb304-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> km0=. <span class="kw">then</span> q0=last1; <span class="kw">if</span> km0 ne . <span class="kw">then</span> q0=km0; *AF-free survival, Q0; </span>
<span id="cb304-50"><a href="#cb304-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> km01=. <span class="kw">then</span> q01=last2; <span class="kw">if</span> km01 ne . <span class="kw">then</span> q01=km01; *Q0 + Q1;</span>
<span id="cb304-51"><a href="#cb304-51" aria-hidden="true" tabindex="-1"></a>    q1 = q01 - q0;</span>
<span id="cb304-52"><a href="#cb304-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output</span>;</span>
<span id="cb304-53"><a href="#cb304-53" aria-hidden="true" tabindex="-1"></a>    last1=q0; last2=q01; </span>
<span id="cb304-54"><a href="#cb304-54" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb304-55"><a href="#cb304-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-56"><a href="#cb304-56" aria-hidden="true" tabindex="-1"></a><span class="co">* The expected length of stay in state 0 or 1 is then estimated as the sum of the products of the length of the time intervals </span></span>
<span id="cb304-57"><a href="#cb304-57" aria-hidden="true" tabindex="-1"></a><span class="co">  and the value of q0 or q1;</span></span>
<span id="cb304-58"><a href="#cb304-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-59"><a href="#cb304-59" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> allrev_boot;</span>
<span id="cb304-60"><a href="#cb304-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> allrev_boot;</span>
<span id="cb304-61"><a href="#cb304-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="fu">time</span> &gt; <span class="dv">3</span> <span class="kw">then</span> <span class="kw">delete</span>;</span>
<span id="cb304-62"><a href="#cb304-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> elos0 elos1;</span>
<span id="cb304-63"><a href="#cb304-63" aria-hidden="true" tabindex="-1"></a>    dq0 = <span class="fu">dif</span>(<span class="fu">time</span>)*<span class="fu">lag</span>(q0);</span>
<span id="cb304-64"><a href="#cb304-64" aria-hidden="true" tabindex="-1"></a>    dq1 = <span class="fu">dif</span>(<span class="fu">time</span>)*<span class="fu">lag</span>(q1);</span>
<span id="cb304-65"><a href="#cb304-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="fu">time</span> = <span class="dv">0</span> <span class="kw">then do</span>; elos0 = <span class="dv">0</span>; elos1 = <span class="dv">0</span>; dq0 = .; dq1 = .<span class="kw">; end</span>;</span>
<span id="cb304-66"><a href="#cb304-66" aria-hidden="true" tabindex="-1"></a>    elos0 + dq0;</span>
<span id="cb304-67"><a href="#cb304-67" aria-hidden="true" tabindex="-1"></a>    elos1 + dq1;</span>
<span id="cb304-68"><a href="#cb304-68" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb304-69"><a href="#cb304-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-70"><a href="#cb304-70" aria-hidden="true" tabindex="-1"></a><span class="co">* We will only keep the result for the value of the expected lengths of stay up at 3 years in the data frame 'elos_est';</span></span>
<span id="cb304-71"><a href="#cb304-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-72"><a href="#cb304-72" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> elos_est;</span>
<span id="cb304-73"><a href="#cb304-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> allrev_boot;</span>
<span id="cb304-74"><a href="#cb304-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">keep</span> <span class="fu">time</span> elos0 elos1;</span>
<span id="cb304-75"><a href="#cb304-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> <span class="fu">time</span> = <span class="dv">3</span>;</span>
<span id="cb304-76"><a href="#cb304-76" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb304-77"><a href="#cb304-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-78"><a href="#cb304-78" aria-hidden="true" tabindex="-1"></a><span class="co">* Finally, the mean and standard deviation is calculated;</span></span>
<span id="cb304-79"><a href="#cb304-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-80"><a href="#cb304-80" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> means<span class="kw"> data</span>=elos_est stddev <span class="fu">mean</span>;</span>
<span id="cb304-81"><a href="#cb304-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">var</span> elos0 elos1;</span>
<span id="cb304-82"><a href="#cb304-82" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-4.8" class="level3">
<h3 class="anchored" data-anchor-id="exercise-4.8">Exercise 4.8</h3>
<p><em>Consider the data on mortality in relation to childhood vaccinations in Guinea-Bissau, Example 1.1.2</em>.</p>
<section id="section-7" class="level4">
<h4 class="anchored" data-anchor-id="section-7">1.</h4>
<p><em>Fit a marginal hazard model for the mortality rate, adjusting for cluster (village) and including binary variables for BCG and DTP vaccination and adjusting for age at recruitment (i.e., using time since recruitment as time-variable)</em>.</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-55-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-55-1" role="tab" aria-controls="tabset-55-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-55-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-55-2" role="tab" aria-controls="tabset-55-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-55-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-55-1-tab">
<p>The data should be loaded as <strong>bissau_data</strong></p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-159_868250a796a143830e705fe64c7effe8">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb305"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>bissau_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/bissau.csv"</span>)</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>bissau_data<span class="sc">$</span>agem<span class="ot">&lt;-</span>bissau_data<span class="sc">$</span>age<span class="sc">/</span><span class="fl">30.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We then load the relevant packages</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-160_e3b8c8950a8973a200f5ad2754212f31">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co">#Data manipulations and plots</span></span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival) <span class="co">#Core survival analysis routines</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We use the <strong>coxph</strong> function to fit the marginal hazard model for the mortality rate adjusting for cluster and the variables BCG, DTP and age. We adjust for cluster by adding <strong>cluster(cluster)</strong> in the formula argument.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-161_8abdc00909bbe7c929129aa47a825234">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb307"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitting a marginal hazard model</span></span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a>fit481 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(fuptime,dead)<span class="sc">~</span> bcg <span class="sc">+</span> dtp <span class="sc">+</span> agem <span class="sc">+</span> <span class="fu">cluster</span>(cluster), <span class="at">data=</span>bissau_data)</span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit481)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(fuptime, dead) ~ bcg + dtp + agem, data = bissau_data, 
    cluster = cluster)

  n= 5274, number of events= 222 

         coef exp(coef) se(coef) robust se      z Pr(&gt;|z|)   
bcg  -0.40978   0.66380  0.16685   0.15011 -2.730  0.00634 **
dtp   0.07331   1.07606  0.10366   0.09033  0.812  0.41706   
agem  0.04006   1.04088  0.04337   0.04236  0.946  0.34422   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

     exp(coef) exp(-coef) lower .95 upper .95
bcg     0.6638     1.5065    0.4946    0.8909
dtp     1.0761     0.9293    0.9015    1.2845
agem    1.0409     0.9607    0.9580    1.1310

Concordance= 0.549  (se = 0.017 )
Likelihood ratio test= 6.7  on 3 df,   p=0.08
Wald test            = 8.68  on 3 df,   p=0.03
Score (logrank) test = 6.69  on 3 df,   p=0.08,   Robust = 7.5  p=0.06

  (Note: the likelihood ratio and score tests assume independence of
     observations within a cluster, the Wald and robust score tests do not).</code></pre>
</div>
</div>
<p>We obtain a coefficient of -0.41 for BCG, 0.073 for DTP and 0.04 for age.</p>
</div>
<div id="tabset-55-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-55-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-162_08781f5fb16de67d333823f40174053b">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="co">* We first load the data;</span></span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> import out=bissau_<span class="kw">data</span></span>
<span id="cb309-4"><a href="#cb309-4" aria-hidden="true" tabindex="-1"></a>  datafile=<span class="st">'data/bissau.csv'</span> </span>
<span id="cb309-5"><a href="#cb309-5" aria-hidden="true" tabindex="-1"></a>    dbms=csv <span class="kw">replace</span>;</span>
<span id="cb309-6"><a href="#cb309-6" aria-hidden="true" tabindex="-1"></a>    getnames=yes;</span>
<span id="cb309-7"><a href="#cb309-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb309-8"><a href="#cb309-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-9"><a href="#cb309-9" aria-hidden="true" tabindex="-1"></a><span class="co">* To make our results comparable to table 2.12 we must first convert the age variable from days to months.;</span></span>
<span id="cb309-10"><a href="#cb309-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-11"><a href="#cb309-11" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> bissau_<span class="kw">data</span>;</span>
<span id="cb309-12"><a href="#cb309-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> bissau_<span class="kw">data</span>;</span>
<span id="cb309-13"><a href="#cb309-13" aria-hidden="true" tabindex="-1"></a>    agem = age/<span class="dv">30.4</span>;</span>
<span id="cb309-14"><a href="#cb309-14" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb309-15"><a href="#cb309-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-16"><a href="#cb309-16" aria-hidden="true" tabindex="-1"></a><span class="co">/* We fit a marginal hazard model for the mortality rate adjusting for cluster and the variables BCG, DTP and age using the 'phreg'  procedure where we include 'covs(aggregate)' in the phreg statement to obtain robust SD estimates and 'cluster' in the id statement */</span></span>
<span id="cb309-17"><a href="#cb309-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-18"><a href="#cb309-18" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'4.8.1'</span>;</span>
<span id="cb309-19"><a href="#cb309-19" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=bissau_<span class="kw">data</span> covs(aggregate);</span>
<span id="cb309-20"><a href="#cb309-20" aria-hidden="true" tabindex="-1"></a>    class cluster;</span>
<span id="cb309-21"><a href="#cb309-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> fuptime*dead(<span class="dv">0</span>)= bcg dtp agem;</span>
<span id="cb309-22"><a href="#cb309-22" aria-hidden="true" tabindex="-1"></a>    id cluster;</span>
<span id="cb309-23"><a href="#cb309-23" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="section-8" class="level4">
<h4 class="anchored" data-anchor-id="section-8">2.</h4>
<p><em>Compare the results with those from the gamma frailty model (Exercise 3.12)</em>.</p>
<p>The estimates of the coefficients are almost identical with the ones obtained with the gamma frailty model. The standard deviations of the marginal hazards model are, however, a little bit smaller than the standard errors from the gamma frailty model.</p>
</section>
</section>
<section id="exercise-4.9" class="level3">
<h3 class="anchored" data-anchor-id="exercise-4.9">Exercise 4.9</h3>
<p><em>Consider the data on recurrent episodes in affective disorder, Example 1.1.5</em>.</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-56-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-56-1" role="tab" aria-controls="tabset-56-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-56-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-56-2" role="tab" aria-controls="tabset-56-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-56-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-56-1-tab">
<p>The data should be loaded as <strong>affective_data</strong></p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-163_c224227b970166552e29e74f1ac89d15">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a>affective_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/affective.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We then load the relevant packages</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-164_9a9913affc1fdfbce32b97421f91a622">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb311"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co">#Data manipulations and plots</span></span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival) <span class="co">#Core survival analysis routines</span></span>
<span id="cb311-3"><a href="#cb311-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-56-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-56-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-165_b80fa1eb23d62dd25373b4b715b18cc0">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb312"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> import out=affective_<span class="kw">data</span></span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a>    datafile=<span class="st">'data/affective.csv'</span> </span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a>    dbms=csv <span class="kw">replace</span>;</span>
<span id="cb312-4"><a href="#cb312-4" aria-hidden="true" tabindex="-1"></a>    getnames=yes;</span>
<span id="cb312-5"><a href="#cb312-5" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<section id="section-9" class="level4">
<h4 class="anchored" data-anchor-id="section-9">1.</h4>
<p><em>Estimate the mean number of episodes, <span class="math inline">\(\mu(t)\)</span>, in <span class="math inline">\([0; t]\)</span> for unipolar and bipolar patients, taking the mortality into account</em>.</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-57-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-57-1" role="tab" aria-controls="tabset-57-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-57-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-57-2" role="tab" aria-controls="tabset-57-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-57-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-57-1-tab">
<p>We will estimate the mean number of episodes, <span class="math inline">\(\mu(t)\)</span>, in <span class="math inline">\([0; t]\)</span> for unipolar and bipolar patients, taking the mortality into account by</p>
<p><span class="math display">\[\hat{\mu}(t) = \sum_{x \leq t} \hat{S}(x-)\frac{dN(x)}{Y(x)}\]</span> We must first make a data set corresponding to the setting with cycles depicted in Figure 1.5, i.e., the interval in hospital is included in the time between events.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-166_cb385562497f50775c8c7ca0eb46bc50">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb313"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating data corresponding to set up depicted in Figure 1.5</span></span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a>data491 <span class="ot">&lt;-</span> affective_data <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span> </span>
<span id="cb313-3"><a href="#cb313-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">mutate</span>(<span class="at">prev1 =</span> <span class="fu">lag</span>(start, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>),  <span class="co"># moves start one line down</span></span>
<span id="cb313-4"><a href="#cb313-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prev2 =</span> <span class="fu">lag</span>(stop, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">default =</span> <span class="dv">0</span>), <span class="co"># moves stop one line down</span></span>
<span id="cb313-5"><a href="#cb313-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prev =</span> <span class="fu">ifelse</span>(state <span class="sc">==</span> <span class="dv">1</span>, prev2, prev1)) <span class="sc">%&gt;%</span> <span class="co"># picks the displaced value of stop if hospitalized, otherwise the displaced value of start.</span></span>
<span id="cb313-6"><a href="#cb313-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">filter</span>(state <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can estimate <span class="math inline">\(\hat{S}(t)\)</span> with the <strong>survfit</strong> function from the <em>survival</em> package where we use the data set <strong>data491</strong> and death (status = 2) as the event variable.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-167_3e59f5d02189c80d35710939616a1f4a">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb314"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a><span class="co">#S(t)</span></span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a>kmfit491 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(prev, stop, status <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">~</span> <span class="fu">strata</span>(bip) <span class="sc">+</span> <span class="fu">cluster</span>(id), <span class="at">data =</span> data491)</span>
<span id="cb314-3"><a href="#cb314-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb314-4"><a href="#cb314-4" aria-hidden="true" tabindex="-1"></a><span class="co">#S(t) for unipolar patients</span></span>
<span id="cb314-5"><a href="#cb314-5" aria-hidden="true" tabindex="-1"></a>S0 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(kmfit491<span class="sc">$</span>surv[<span class="dv">1</span><span class="sc">:</span>(kmfit491<span class="sc">$</span>strata[<span class="dv">1</span>])], <span class="at">default =</span> <span class="dv">1</span>)</span>
<span id="cb314-6"><a href="#cb314-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-7"><a href="#cb314-7" aria-hidden="true" tabindex="-1"></a><span class="co">#S(t) for bipolar patients</span></span>
<span id="cb314-8"><a href="#cb314-8" aria-hidden="true" tabindex="-1"></a>S1 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(kmfit491<span class="sc">$</span>surv[(kmfit491<span class="sc">$</span>strata[<span class="dv">1</span>]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(kmfit491<span class="sc">$</span>strata[<span class="dv">1</span>] <span class="sc">+</span> kmfit491<span class="sc">$</span>strata[<span class="dv">2</span>])], <span class="at">default =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can also calculate <span class="math inline">\(\frac{dN(x)}{Y(x)}\)</span> using the <strong>survfit</strong> function where we have admission to hospital (status = 1) as event variable.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-168_0ba331544850c9c274e0af0db9175379">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb315"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a><span class="co">#A(t)</span></span>
<span id="cb315-2"><a href="#cb315-2" aria-hidden="true" tabindex="-1"></a>naafit491 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(prev, stop, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="fu">strata</span>(bip) <span class="sc">+</span> <span class="fu">cluster</span>(id), <span class="at">data =</span> data491)</span>
<span id="cb315-3"><a href="#cb315-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-4"><a href="#cb315-4" aria-hidden="true" tabindex="-1"></a><span class="co">#dA(t) for unipolar patients</span></span>
<span id="cb315-5"><a href="#cb315-5" aria-hidden="true" tabindex="-1"></a>dA0 <span class="ot">&lt;-</span> <span class="fu">diff</span>(naafit491<span class="sc">$</span>cumhaz[<span class="dv">1</span><span class="sc">:</span>naafit491<span class="sc">$</span>strata[<span class="dv">1</span>]])</span>
<span id="cb315-6"><a href="#cb315-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb315-7"><a href="#cb315-7" aria-hidden="true" tabindex="-1"></a><span class="co">#dA(t) for bipolar patients</span></span>
<span id="cb315-8"><a href="#cb315-8" aria-hidden="true" tabindex="-1"></a>dA1 <span class="ot">&lt;-</span> <span class="fu">diff</span>(naafit491<span class="sc">$</span>cumhaz[(kmfit491<span class="sc">$</span>strata[<span class="dv">1</span>]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(kmfit491<span class="sc">$</span>strata[<span class="dv">1</span>] <span class="sc">+</span> kmfit491<span class="sc">$</span>strata[<span class="dv">2</span>])])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then we can calculate the estimate of m(t) for both patient groups and plot the result</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-169_4313649bfa30cc4fda8fbd8d53331ba6">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb316"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a><span class="co">#m(t) for unipolar patients</span></span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a>mu0 <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(S0 <span class="sc">*</span> <span class="fu">c</span>(<span class="dv">0</span>, dA0))</span>
<span id="cb316-3"><a href="#cb316-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-4"><a href="#cb316-4" aria-hidden="true" tabindex="-1"></a><span class="co">#m(t) for bipolar patients</span></span>
<span id="cb316-5"><a href="#cb316-5" aria-hidden="true" tabindex="-1"></a>mu1 <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(S1 <span class="sc">*</span> <span class="fu">c</span>(<span class="dv">0</span>, dA1))</span>
<span id="cb316-6"><a href="#cb316-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-7"><a href="#cb316-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Collecting the data</span></span>
<span id="cb316-8"><a href="#cb316-8" aria-hidden="true" tabindex="-1"></a>plotdata491 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> kmfit491<span class="sc">$</span>time<span class="sc">/</span><span class="dv">12</span>, </span>
<span id="cb316-9"><a href="#cb316-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mu =</span> <span class="fu">c</span>(mu0, mu1), </span>
<span id="cb316-10"><a href="#cb316-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">disorder =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Unipolar"</span>, <span class="fu">length</span>(mu0)), </span>
<span id="cb316-11"><a href="#cb316-11" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">rep</span>(<span class="st">"Bipolar"</span>, <span class="fu">length</span>(mu1))))</span>
<span id="cb316-12"><a href="#cb316-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-13"><a href="#cb316-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the result</span></span>
<span id="cb316-14"><a href="#cb316-14" aria-hidden="true" tabindex="-1"></a>fig491 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> plotdata491) <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mu, <span class="at">color =</span> disorder)) <span class="sc">+</span> </span>
<span id="cb316-15"><a href="#cb316-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since first admission (years)"</span>) <span class="sc">+</span> </span>
<span id="cb316-16"><a href="#cb316-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Expected number of episodes"</span>) <span class="sc">+</span> </span>
<span id="cb316-17"><a href="#cb316-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb316-18"><a href="#cb316-18" aria-hidden="true" tabindex="-1"></a>fig491</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-169-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>The expected number of episodes is larger for bipolar patients at all times compared to unipolar patients.</p>
</div>
<div id="tabset-57-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-57-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-170_81ac2e0b06bf1066c61299022b744c67">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb317"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a><span class="co">* We can estimate the mean number of episodes in [0,t] for unipolar and bipolar patients, taking the mortality into account </span></span>
<span id="cb317-2"><a href="#cb317-2" aria-hidden="true" tabindex="-1"></a><span class="co">  by equation (4.13).</span></span>
<span id="cb317-3"><a href="#cb317-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-4"><a href="#cb317-4" aria-hidden="true" tabindex="-1"></a><span class="co">* We make a data set correpsonding to the setting with cycles depicted in figure 1.5, i.e. the interval in hospital is </span></span>
<span id="cb317-5"><a href="#cb317-5" aria-hidden="true" tabindex="-1"></a><span class="co">  included in the time between events.;</span></span>
<span id="cb317-6"><a href="#cb317-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-7"><a href="#cb317-7" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'4.9.1'</span>;</span>
<span id="cb317-8"><a href="#cb317-8" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> data491; </span>
<span id="cb317-9"><a href="#cb317-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> affective_<span class="kw">data</span>;</span>
<span id="cb317-10"><a href="#cb317-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> id;</span>
<span id="cb317-11"><a href="#cb317-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> prev;</span>
<span id="cb317-12"><a href="#cb317-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> first.id <span class="kw">then</span> prev=<span class="dv">0</span>; </span>
<span id="cb317-13"><a href="#cb317-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">output</span>; </span>
<span id="cb317-14"><a href="#cb317-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> state=<span class="dv">1</span> <span class="kw">then</span> prev=start; <span class="kw">if</span> state=<span class="dv">0</span> <span class="kw">then</span> prev=<span class="kw">stop</span>;</span>
<span id="cb317-15"><a href="#cb317-15" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-16"><a href="#cb317-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-17"><a href="#cb317-17" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> data491;</span>
<span id="cb317-18"><a href="#cb317-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> data491;</span>
<span id="cb317-19"><a href="#cb317-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> state = <span class="dv">0</span> <span class="kw">or</span> status = <span class="dv">2</span> <span class="kw">or</span> status = <span class="dv">3</span>;</span>
<span id="cb317-20"><a href="#cb317-20" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-21"><a href="#cb317-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-22"><a href="#cb317-22" aria-hidden="true" tabindex="-1"></a><span class="co">* Thus the entry and exit time are now 'prev' and 'stop';</span></span>
<span id="cb317-23"><a href="#cb317-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-24"><a href="#cb317-24" aria-hidden="true" tabindex="-1"></a><span class="co">* We can estimate S(X-) using the phreg procedure. Since the event of interest is death (status = 2) we include 'status(0 1 3)' as </span></span>
<span id="cb317-25"><a href="#cb317-25" aria-hidden="true" tabindex="-1"></a><span class="co">  censoring variables in the model statement. The result is saved as 'kmdata491';</span></span>
<span id="cb317-26"><a href="#cb317-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-27"><a href="#cb317-27" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=data491;</span>
<span id="cb317-28"><a href="#cb317-28" aria-hidden="true" tabindex="-1"></a>    class bip;</span>
<span id="cb317-29"><a href="#cb317-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> (prev,<span class="kw">stop</span>)*status(<span class="dv">0</span> <span class="dv">1</span> <span class="dv">3</span>)=;</span>
<span id="cb317-30"><a href="#cb317-30" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb317-31"><a href="#cb317-31" aria-hidden="true" tabindex="-1"></a>    strata bip;</span>
<span id="cb317-32"><a href="#cb317-32" aria-hidden="true" tabindex="-1"></a>    baseline out=kmdata491 survival=km;</span>
<span id="cb317-33"><a href="#cb317-33" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-34"><a href="#cb317-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-35"><a href="#cb317-35" aria-hidden="true" tabindex="-1"></a><span class="co">* Likewise, we can estimate dN(X)/Y(X) using the phreg procedure with censoring variables 'status(0 2 3)' in the model statement. The </span></span>
<span id="cb317-36"><a href="#cb317-36" aria-hidden="true" tabindex="-1"></a><span class="co">  result is saved as 'naadata491';</span></span>
<span id="cb317-37"><a href="#cb317-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-38"><a href="#cb317-38" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=data491;</span>
<span id="cb317-39"><a href="#cb317-39" aria-hidden="true" tabindex="-1"></a>    class bip;</span>
<span id="cb317-40"><a href="#cb317-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> (prev,<span class="kw">stop</span>)*status(<span class="dv">0</span> <span class="dv">2</span> <span class="dv">3</span>)=;</span>
<span id="cb317-41"><a href="#cb317-41" aria-hidden="true" tabindex="-1"></a>    id id;</span>
<span id="cb317-42"><a href="#cb317-42" aria-hidden="true" tabindex="-1"></a>    strata bip;</span>
<span id="cb317-43"><a href="#cb317-43" aria-hidden="true" tabindex="-1"></a>    baseline out=naadata491 cumhaz=naa;</span>
<span id="cb317-44"><a href="#cb317-44" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-45"><a href="#cb317-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-46"><a href="#cb317-46" aria-hidden="true" tabindex="-1"></a><span class="co">* We then create a data set for the unipolar patients and one for the bipolar patients containing the estimates of S(X-) and</span></span>
<span id="cb317-47"><a href="#cb317-47" aria-hidden="true" tabindex="-1"></a><span class="co">  dN(X)/Y(X);</span></span>
<span id="cb317-48"><a href="#cb317-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-49"><a href="#cb317-49" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> naa_uni;</span>
<span id="cb317-50"><a href="#cb317-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> naadata491;</span>
<span id="cb317-51"><a href="#cb317-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> bip = <span class="dv">0</span>;</span>
<span id="cb317-52"><a href="#cb317-52" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-53"><a href="#cb317-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-54"><a href="#cb317-54" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> km_uni; </span>
<span id="cb317-55"><a href="#cb317-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> kmdata491;</span>
<span id="cb317-56"><a href="#cb317-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> bip = <span class="dv">0</span>;</span>
<span id="cb317-57"><a href="#cb317-57" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-58"><a href="#cb317-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-59"><a href="#cb317-59" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> uni;</span>
<span id="cb317-60"><a href="#cb317-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">merge</span> naa_uni km_uni;</span>
<span id="cb317-61"><a href="#cb317-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> <span class="kw">stop</span>;</span>
<span id="cb317-62"><a href="#cb317-62" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-63"><a href="#cb317-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-64"><a href="#cb317-64" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> naa_bip;</span>
<span id="cb317-65"><a href="#cb317-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> naadata491;</span>
<span id="cb317-66"><a href="#cb317-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> bip = <span class="dv">1</span>;</span>
<span id="cb317-67"><a href="#cb317-67" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-68"><a href="#cb317-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-69"><a href="#cb317-69" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> km_bip;</span>
<span id="cb317-70"><a href="#cb317-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> kmdata491;</span>
<span id="cb317-71"><a href="#cb317-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> bip = <span class="dv">1</span>;</span>
<span id="cb317-72"><a href="#cb317-72" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-73"><a href="#cb317-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-74"><a href="#cb317-74" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> bip;</span>
<span id="cb317-75"><a href="#cb317-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">merge</span> naa_bip km_bip;</span>
<span id="cb317-76"><a href="#cb317-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">by</span> <span class="kw">stop</span>;</span>
<span id="cb317-77"><a href="#cb317-77" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-78"><a href="#cb317-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-79"><a href="#cb317-79" aria-hidden="true" tabindex="-1"></a><span class="co">* We then fill the empty cells in the data set with the previous value of S(X-) and dN(X)/Y(X);</span></span>
<span id="cb317-80"><a href="#cb317-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-81"><a href="#cb317-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-82"><a href="#cb317-82" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> uni;</span>
<span id="cb317-83"><a href="#cb317-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> uni;</span>
<span id="cb317-84"><a href="#cb317-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> _km _naa;</span>
<span id="cb317-85"><a href="#cb317-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> km ne . <span class="kw">then</span> _km = km;</span>
<span id="cb317-86"><a href="#cb317-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> naa ne . <span class="kw">then</span> _naa = naa;</span>
<span id="cb317-87"><a href="#cb317-87" aria-hidden="true" tabindex="-1"></a>    years = <span class="kw">stop</span>/<span class="dv">12</span>;</span>
<span id="cb317-88"><a href="#cb317-88" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-89"><a href="#cb317-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-90"><a href="#cb317-90" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> bip;</span>
<span id="cb317-91"><a href="#cb317-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> bip;</span>
<span id="cb317-92"><a href="#cb317-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> _km _naa;</span>
<span id="cb317-93"><a href="#cb317-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> km ne . <span class="kw">then</span> _km = km;</span>
<span id="cb317-94"><a href="#cb317-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> naa ne . <span class="kw">then</span> _naa = naa;</span>
<span id="cb317-95"><a href="#cb317-95" aria-hidden="true" tabindex="-1"></a>    years = <span class="kw">stop</span>/<span class="dv">12</span>;</span>
<span id="cb317-96"><a href="#cb317-96" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-97"><a href="#cb317-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-98"><a href="#cb317-98" aria-hidden="true" tabindex="-1"></a><span class="co">* Finally, we estimate m(t) for unipolar and bipolar patients respectively;</span></span>
<span id="cb317-99"><a href="#cb317-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-100"><a href="#cb317-100" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> uni; </span>
<span id="cb317-101"><a href="#cb317-101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> uni;</span>
<span id="cb317-102"><a href="#cb317-102" aria-hidden="true" tabindex="-1"></a>    dA = <span class="fu">dif</span>(_naa); </span>
<span id="cb317-103"><a href="#cb317-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> years = <span class="dv">0</span> <span class="kw">then</span> dA = <span class="dv">0</span>;</span>
<span id="cb317-104"><a href="#cb317-104" aria-hidden="true" tabindex="-1"></a>    dmu = _km*dA;</span>
<span id="cb317-105"><a href="#cb317-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> mu;</span>
<span id="cb317-106"><a href="#cb317-106" aria-hidden="true" tabindex="-1"></a>    mu + dmu;</span>
<span id="cb317-107"><a href="#cb317-107" aria-hidden="true" tabindex="-1"></a>    bip = <span class="dv">0</span>;</span>
<span id="cb317-108"><a href="#cb317-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">keep</span> years _naa mu bip;</span>
<span id="cb317-109"><a href="#cb317-109" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-110"><a href="#cb317-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-111"><a href="#cb317-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-112"><a href="#cb317-112" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> bip; </span>
<span id="cb317-113"><a href="#cb317-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> bip;</span>
<span id="cb317-114"><a href="#cb317-114" aria-hidden="true" tabindex="-1"></a>    dA = <span class="fu">dif</span>(_naa); </span>
<span id="cb317-115"><a href="#cb317-115" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> years = <span class="dv">0</span> <span class="kw">then</span> dA = <span class="dv">0</span>;</span>
<span id="cb317-116"><a href="#cb317-116" aria-hidden="true" tabindex="-1"></a>    dmu = _km*dA;</span>
<span id="cb317-117"><a href="#cb317-117" aria-hidden="true" tabindex="-1"></a>    <span class="kw">retain</span> mu;</span>
<span id="cb317-118"><a href="#cb317-118" aria-hidden="true" tabindex="-1"></a>    mu + dmu;</span>
<span id="cb317-119"><a href="#cb317-119" aria-hidden="true" tabindex="-1"></a>    bip = <span class="dv">1</span>;</span>
<span id="cb317-120"><a href="#cb317-120" aria-hidden="true" tabindex="-1"></a>    <span class="kw">keep</span> years _naa mu bip;</span>
<span id="cb317-121"><a href="#cb317-121" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-122"><a href="#cb317-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-123"><a href="#cb317-123" aria-hidden="true" tabindex="-1"></a><span class="co">* We merge the data sets for unipolar and bipolar patients and plot the data using the gplot procedure;</span></span>
<span id="cb317-124"><a href="#cb317-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-125"><a href="#cb317-125" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> plotdata491;</span>
<span id="cb317-126"><a href="#cb317-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> uni bip;</span>
<span id="cb317-127"><a href="#cb317-127" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-128"><a href="#cb317-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-129"><a href="#cb317-129" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'4.9.1'</span>;</span>
<span id="cb317-130"><a href="#cb317-130" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=plotdata491;</span>
<span id="cb317-131"><a href="#cb317-131" aria-hidden="true" tabindex="-1"></a>    plot mu*years=bip/ haxis=axis1 vaxis=axis2;</span>
<span id="cb317-132"><a href="#cb317-132" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">30</span> <span class="kw">by</span> <span class="dv">5</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb317-133"><a href="#cb317-133" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">10</span> <span class="kw">by</span> <span class="dv">2</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Expected number of episodes'</span>);</span>
<span id="cb317-134"><a href="#cb317-134" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=red;</span>
<span id="cb317-135"><a href="#cb317-135" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=blue;</span>
<span id="cb317-136"><a href="#cb317-136" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-137"><a href="#cb317-137" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span>
<span id="cb317-138"><a href="#cb317-138" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb317-139"><a href="#cb317-139" aria-hidden="true" tabindex="-1"></a><span class="co">* The expected number of episodes is larger for bipolar patients at all times compared to unipolar patients.;</span></span>
<span id="cb317-140"><a href="#cb317-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-141"><a href="#cb317-141" aria-hidden="true" tabindex="-1"></a><span class="co">* Less transparently, but in a way a lot easier, we can 'cheat' proc phreg to do the computations by</span></span>
<span id="cb317-142"><a href="#cb317-142" aria-hidden="true" tabindex="-1"></a><span class="co">  fitting an empty Fine-Gray model and transform the cumulative sub-distribution hazard!;</span></span>
<span id="cb317-143"><a href="#cb317-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-144"><a href="#cb317-144" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=data491;</span>
<span id="cb317-145"><a href="#cb317-145" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> <span class="kw">stop</span>*status(<span class="dv">0</span> <span class="dv">3</span>)=/entry=prev eventcode=<span class="dv">1</span>;</span>
<span id="cb317-146"><a href="#cb317-146" aria-hidden="true" tabindex="-1"></a>    strata bip;</span>
<span id="cb317-147"><a href="#cb317-147" aria-hidden="true" tabindex="-1"></a>    baseline out=mcfdata1 cif=naa1;</span>
<span id="cb317-148"><a href="#cb317-148" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-149"><a href="#cb317-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-150"><a href="#cb317-150" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> mcfdata1; <span class="kw">set</span> mcfdata1;</span>
<span id="cb317-151"><a href="#cb317-151" aria-hidden="true" tabindex="-1"></a>    cmf=-<span class="fu">log</span>(<span class="dv">1</span>-naa1);</span>
<span id="cb317-152"><a href="#cb317-152" aria-hidden="true" tabindex="-1"></a>    years=<span class="kw">stop</span>/<span class="dv">12</span>;</span>
<span id="cb317-153"><a href="#cb317-153" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-154"><a href="#cb317-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-155"><a href="#cb317-155" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=mcfdata1;</span>
<span id="cb317-156"><a href="#cb317-156" aria-hidden="true" tabindex="-1"></a>plot cmf*years=bip/haxis=axis1 vaxis=axis2;</span>
<span id="cb317-157"><a href="#cb317-157" aria-hidden="true" tabindex="-1"></a>axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">30</span> <span class="kw">by</span> <span class="dv">5</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb317-158"><a href="#cb317-158" aria-hidden="true" tabindex="-1"></a>axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">8</span> <span class="kw">by</span> <span class="dv">0.5</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Expected number of episodes'</span>);</span>
<span id="cb317-159"><a href="#cb317-159" aria-hidden="true" tabindex="-1"></a>symbol1  v=none i=stepjl c=red;</span>
<span id="cb317-160"><a href="#cb317-160" aria-hidden="true" tabindex="-1"></a>symbol2  v=none i=stepjl c=blue;</span>
<span id="cb317-161"><a href="#cb317-161" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb317-162"><a href="#cb317-162" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="section-10" class="level4">
<h4 class="anchored" data-anchor-id="section-10">2.</h4>
<p><em>Estimate, incorrectly, the same mean curves by treating death as censoring and compare with the correct curves from the first question, thereby, re-constructing the cover figure from this book (unipolar patients)</em>.</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-58-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-58-1" role="tab" aria-controls="tabset-58-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-58-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-58-2" role="tab" aria-controls="tabset-58-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-58-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-58-1-tab">
<p>We will estimate the mean number of episodes in <span class="math inline">\([0,t]\)</span> for unipolar and bipolar patients neglecting mortality with the Nelson-Aalen estimator</p>
<p><span class="math display">\[\hat{m}(t) = \sum_{x \leq t} \frac{dN(x)}{Y(x)},\]</span> where <span class="math inline">\(x\)</span> is event time.</p>
<p>This is exactly the Nelson-Aalen estimate obtained in <strong>naafit491</strong> in the previous exercise. We will save this data as <strong>plotdata492</strong></p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-171_8461cb7393bcc9311840704bb24658b4">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb318"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Collecting the data for plotting</span></span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a>plotdata492 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> naafit491<span class="sc">$</span>time<span class="sc">/</span><span class="dv">12</span>, </span>
<span id="cb318-3"><a href="#cb318-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mu =</span> naafit491<span class="sc">$</span>cumhaz, </span>
<span id="cb318-4"><a href="#cb318-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">disorder =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Unipolar"</span>, naafit491<span class="sc">$</span>strata[[<span class="dv">1</span>]]), </span>
<span id="cb318-5"><a href="#cb318-5" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">rep</span>(<span class="st">"Bipolar"</span>, naafit491<span class="sc">$</span>strata[[<span class="dv">2</span>]])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We will now plot the curves for the two estimates of the mean number of episodes for unipolar patients</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-172_75250b8422a23be9bf01e18b4f747ce6">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb319"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the estimate of the expected number of episodes for patients with unipolar disorder</span></span>
<span id="cb319-2"><a href="#cb319-2" aria-hidden="true" tabindex="-1"></a>fig492_uni <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()  <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="at">data =</span> <span class="fu">subset</span>(plotdata492, disorder <span class="sc">==</span> <span class="st">"Unipolar"</span>), <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mu, <span class="at">color =</span> <span class="st">"Not accounting for mortality"</span>)) <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="at">data =</span> <span class="fu">subset</span>(plotdata491, disorder <span class="sc">==</span> <span class="st">"Unipolar"</span>), <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mu, <span class="at">color =</span> <span class="st">"Accounting for mortality"</span>)) <span class="sc">+</span>  <span class="fu">ylab</span>(<span class="st">"Expected number of episodes"</span>) <span class="sc">+</span></span>
<span id="cb319-3"><a href="#cb319-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since first admission (years)"</span>) <span class="sc">+</span></span>
<span id="cb319-4"><a href="#cb319-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title=</span><span class="fu">element_blank</span>()) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Unipolar disorder"</span>)</span>
<span id="cb319-5"><a href="#cb319-5" aria-hidden="true" tabindex="-1"></a>fig492_uni</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-172-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>We repeat for the bipolar patients</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-173_a3e49c868f801604172930a56b33ca55">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb320"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a>fig492_bip <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="at">data =</span> <span class="fu">subset</span>(plotdata491, disorder <span class="sc">==</span> <span class="st">"Bipolar"</span>), <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mu, <span class="at">color =</span> <span class="st">"Accounting for mortality"</span>)) <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="at">data =</span> <span class="fu">subset</span>(plotdata492, disorder <span class="sc">==</span> <span class="st">"Bipolar"</span>), <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> mu, <span class="at">color =</span> <span class="st">"Not accounting for mortality"</span>)) <span class="sc">+</span>   <span class="fu">ylab</span>(<span class="st">"Expected number of episodes"</span>) <span class="sc">+</span></span>
<span id="cb320-2"><a href="#cb320-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Time since first admission (years)"</span>) <span class="sc">+</span></span>
<span id="cb320-3"><a href="#cb320-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title=</span><span class="fu">element_blank</span>()) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Bipolar disorder"</span>)</span>
<span id="cb320-4"><a href="#cb320-4" aria-hidden="true" tabindex="-1"></a>fig492_bip</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-173-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
<p>For both unipolar and bipolar patients we get larger estimates of the mean number of episodes when we do not account for mortality.</p>
</div>
<div id="tabset-58-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-58-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-174_4075ba5d6e4073dd6adb35ab5d0e4283">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb321"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="co">* We can estimate the expected number of episodes neglecting mortality by equation (4.11). This is </span></span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a><span class="co">  in fact the Nelson-Aalen estimate we saved in the data set 'naadata491';</span></span>
<span id="cb321-3"><a href="#cb321-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-4"><a href="#cb321-4" aria-hidden="true" tabindex="-1"></a><span class="co">* We use the gplot procedure to plot the two estimates of the expected number of episodes;</span></span>
<span id="cb321-5"><a href="#cb321-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-6"><a href="#cb321-6" aria-hidden="true" tabindex="-1"></a>legend1 <span class="kw">label</span> = (<span class="st">'Accounting for mortality'</span>) value = (<span class="st">'Yes'</span> <span class="st">'No'</span>);</span>
<span id="cb321-7"><a href="#cb321-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-8"><a href="#cb321-8" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'4.9.2 - unipolar'</span>;</span>
<span id="cb321-9"><a href="#cb321-9" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=uni;</span>
<span id="cb321-10"><a href="#cb321-10" aria-hidden="true" tabindex="-1"></a>    plot mu*years _naa*years/ overlay haxis=axis1 vaxis=axis2 legend =legend1;</span>
<span id="cb321-11"><a href="#cb321-11" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">30</span> <span class="kw">by</span> <span class="dv">5</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb321-12"><a href="#cb321-12" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">6</span> <span class="kw">by</span> <span class="dv">2</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Expected number of episodes'</span>);</span>
<span id="cb321-13"><a href="#cb321-13" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=red;</span>
<span id="cb321-14"><a href="#cb321-14" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=blue;</span>
<span id="cb321-15"><a href="#cb321-15" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb321-16"><a href="#cb321-16" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span>
<span id="cb321-17"><a href="#cb321-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-18"><a href="#cb321-18" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">'4.9.2 - bipolar'</span>;</span>
<span id="cb321-19"><a href="#cb321-19" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=bip;</span>
<span id="cb321-20"><a href="#cb321-20" aria-hidden="true" tabindex="-1"></a>    plot mu*years _naa*years/ overlay haxis=axis1 vaxis=axis2 legend =legend1;</span>
<span id="cb321-21"><a href="#cb321-21" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">30</span> <span class="kw">by</span> <span class="dv">5</span> minor=none <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb321-22"><a href="#cb321-22" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">10</span> <span class="kw">by</span> <span class="dv">2</span> minor=none <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Expected number of episodes'</span>);</span>
<span id="cb321-23"><a href="#cb321-23" aria-hidden="true" tabindex="-1"></a>    symbol1  v=none i=stepjl c=red;</span>
<span id="cb321-24"><a href="#cb321-24" aria-hidden="true" tabindex="-1"></a>    symbol2  v=none i=stepjl c=blue;</span>
<span id="cb321-25"><a href="#cb321-25" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb321-26"><a href="#cb321-26" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span>
<span id="cb321-27"><a href="#cb321-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-28"><a href="#cb321-28" aria-hidden="true" tabindex="-1"></a><span class="co">* For both unipolar and bipolar patients we get larger estimates of the mean number of episodes when we do not account for mortality.;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-4.10" class="level3">
<h3 class="anchored" data-anchor-id="exercise-4.10">Exercise 4.10</h3>
<p><em>Consider the data from the Copenhagen Holter study.</em></p>
<section id="section-11" class="level4">
<h4 class="anchored" data-anchor-id="section-11">1.</h4>
<p><em>Estimate the distribution, <span class="math inline">\(G(t)\)</span> of censoring.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-59-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-59-1" role="tab" aria-controls="tabset-59-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-59-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-59-2" role="tab" aria-controls="tabset-59-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-59-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-59-1-tab">
<p>We will estimate the censoring distribution <span class="math inline">\(G(t)\)</span> with the Kaplan-Meier estimator where <em>censoring</em> is the event and <em>death</em> acts as censoring.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-175_3ea286e5777f49c92422babb180f02c6">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb322"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a>km4101 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(timedeath, <span class="dv">1</span> <span class="sc">-</span> death) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> chs_data)</span>
<span id="cb322-2"><a href="#cb322-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb322-3"><a href="#cb322-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb322-4"><a href="#cb322-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the Kaplan-Meier estimate</span></span>
<span id="cb322-5"><a href="#cb322-5" aria-hidden="true" tabindex="-1"></a>(fig41 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_step</span>(<span class="fu">aes</span>(<span class="at">x =</span> km4101<span class="sc">$</span>time, <span class="at">y =</span> km4101<span class="sc">$</span>surv), <span class="at">size =</span> <span class="dv">1</span>)  <span class="sc">+</span> </span>
<span id="cb322-6"><a href="#cb322-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb322-7"><a href="#cb322-7" aria-hidden="true" tabindex="-1"></a>          <span class="fu">xlab</span>(<span class="st">"Time (years)"</span>) <span class="sc">+</span> </span>
<span id="cb322-8"><a href="#cb322-8" aria-hidden="true" tabindex="-1"></a>          <span class="fu">ylab</span>(<span class="st">"Probability of censoring"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Ch4_files/figure-html/unnamed-chunk-175-1.png" class="img-fluid" width="1122"></p>
</div>
</div>
</div>
<div id="tabset-59-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-59-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-176_4bb257d937f246312a8f56cefa3c4d71">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb323"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a><span class="co">*We will estimate the censoring distribution G(t) with the Kaplan-Meier estimator where 'censoring' is the event and 'death' acts </span></span>
<span id="cb323-2"><a href="#cb323-2" aria-hidden="true" tabindex="-1"></a><span class="co"> as censoring.;</span></span>
<span id="cb323-3"><a href="#cb323-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb323-4"><a href="#cb323-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb323-5"><a href="#cb323-5" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"4.10.1"</span>;</span>
<span id="cb323-6"><a href="#cb323-6" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=chs_<span class="kw">data</span>;</span>
<span id="cb323-7"><a href="#cb323-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timedeath*death(<span class="dv">1</span>)=;</span>
<span id="cb323-8"><a href="#cb323-8" aria-hidden="true" tabindex="-1"></a>    baseline out=survdat survival=km;</span>
<span id="cb323-9"><a href="#cb323-9" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb323-10"><a href="#cb323-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb323-11"><a href="#cb323-11" aria-hidden="true" tabindex="-1"></a><span class="co">* Then the estimates are plotted using the gplot procedure;</span></span>
<span id="cb323-12"><a href="#cb323-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb323-13"><a href="#cb323-13" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> gplot<span class="kw"> data</span>=survdat;</span>
<span id="cb323-14"><a href="#cb323-14" aria-hidden="true" tabindex="-1"></a>plot km*timedeath/haxis=axis1 vaxis=axis2;</span>
<span id="cb323-15"><a href="#cb323-15" aria-hidden="true" tabindex="-1"></a>    axis1 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">16</span> <span class="kw">by</span> <span class="dv">2</span> <span class="kw">label</span>=(<span class="st">'Years'</span>);</span>
<span id="cb323-16"><a href="#cb323-16" aria-hidden="true" tabindex="-1"></a>    axis2 <span class="kw">order</span>=<span class="dv">0</span> <span class="kw">to</span> <span class="dv">1</span> <span class="kw">by</span> <span class="dv">0.1</span> <span class="kw">label</span>=(a=<span class="dv">90</span> <span class="st">'Censoring probability'</span>);</span>
<span id="cb323-17"><a href="#cb323-17" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb323-18"><a href="#cb323-18" aria-hidden="true" tabindex="-1"></a><span class="kw">quit</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
</section>
<section id="section-12" class="level4">
<h4 class="anchored" data-anchor-id="section-12">2.</h4>
<p><em>Examine to what extent this distribution depends on the variables ESVEA, sex, age, and systolic blood pressure.</em></p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-60-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-60-1" role="tab" aria-controls="tabset-60-1" aria-selected="true">R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-60-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-60-2" role="tab" aria-controls="tabset-60-2" aria-selected="false">SAS</a></li></ul>
<div class="tab-content">
<div id="tabset-60-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-60-1-tab">
<p>To examine to what extent the censoring distribution depends on the variables ESVEA, sex, age, and systolic blood pressure, we will fit a Cox model including these covariates and where <em>censoring</em> is the event and <em>death</em> acts as censoring.</p>
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-177_e8ebfdcf05333fb8e3508d6e9fbaffff">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb324"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a>cox4102 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(timedeath, <span class="dv">1</span><span class="sc">-</span> death) <span class="sc">~</span> esvea <span class="sc">+</span> sex <span class="sc">+</span> age <span class="sc">+</span> sbp, <span class="at">data =</span> chs_data, <span class="at">ties =</span> <span class="st">"breslow"</span>)</span>
<span id="cb324-2"><a href="#cb324-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox4102)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(timedeath, 1 - death) ~ esvea + sex + age + 
    sbp, data = chs_data, ties = "breslow")

  n= 675, number of events= 416 
   (3 observations deleted due to missingness)

           coef exp(coef)  se(coef)      z Pr(&gt;|z|)   
esvea  0.439265  1.551567  0.164580  2.669  0.00761 **
sex   -0.285701  0.751487  0.120830 -2.364  0.01805 * 
age   -0.019642  0.980550  0.009230 -2.128  0.03334 * 
sbp   -0.001516  0.998485  0.002169 -0.699  0.48466   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

      exp(coef) exp(-coef) lower .95 upper .95
esvea    1.5516     0.6445    1.1238    2.1422
sex      0.7515     1.3307    0.5930    0.9523
age      0.9806     1.0198    0.9630    0.9985
sbp      0.9985     1.0015    0.9942    1.0027

Concordance= 0.562  (se = 0.017 )
Likelihood ratio test= 11.54  on 4 df,   p=0.02
Wald test            = 11.75  on 4 df,   p=0.02
Score (logrank) test = 11.8  on 4 df,   p=0.02</code></pre>
</div>
</div>
<p>The <span class="math inline">\(p\)</span>-values indicate that censoring depends on ESVEA, sex, and age but not on systolic blood pressure.</p>
</div>
<div id="tabset-60-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-60-2-tab">
<div class="cell" data-hash="Ch4_cache/html/unnamed-chunk-178_6e73178f687b2cad6290f92052055338">
<details open="">
<summary>Code show/hide</summary>
<div class="sourceCode cell-code" id="cb326"><pre class="sourceCode sas code-with-copy"><code class="sourceCode highlightsas"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a><span class="co">*To examine to what extent the censoring distribution depends on the variables ESVEA, sex, age, and systolic blood pressure we will</span></span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a><span class="co"> fit a Cox model including these covariates and where 'censoring' is the event and 'death' acts as censoring.;</span></span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a><span class="kw">title</span> <span class="st">"4.10.2"</span>;</span>
<span id="cb326-5"><a href="#cb326-5" aria-hidden="true" tabindex="-1"></a><span class="kw">proc</span> phreg<span class="kw"> data</span>=chs_<span class="kw">data</span>;</span>
<span id="cb326-6"><a href="#cb326-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">model</span> timedeath*death(<span class="dv">1</span>)=esvea sex age sbp;</span>
<span id="cb326-7"><a href="#cb326-7" aria-hidden="true" tabindex="-1"></a><span class="kw">run</span>;</span>
<span id="cb326-8"><a href="#cb326-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-9"><a href="#cb326-9" aria-hidden="true" tabindex="-1"></a><span class="co">*The p-values indicate that censoring depends strongly on ESVEA, sex, and age but not on systolic blood pressure.;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Ch3.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Intensity models</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Ch5.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Marginal models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Models for Multi-State Survival Data: Rates, Risks, and Pseudo-Values</div>   
    <div class="nav-footer-right">Built with <a href="https://quarto.org/">Quarto</a> and <a href="https://posit.co/products/open-source/rstudio/">RStudio</a></div>
  </div>
</footer>



</body></html>