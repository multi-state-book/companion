### Exercise 2.1

*Consider the data from the Copenhagen Holter study (Example 1.1.8)*.

::: panel-tabset
## R

The data should be loaded as `chs_data`:

```{r}
#| code-fold: show
chs_data <- read.csv("data/cphholter.csv")
```

Note that the time variables, `timeafib`, `timestroke` and `timedeath`, are measured in days. We will first convert them to years for easier interpretations.

```{r}
#| code-fold: show
chs_data$timeafib   <- chs_data$timeafib/365.25
chs_data$timestroke <- chs_data$timestroke/365.25
chs_data$timedeath  <- chs_data$timedeath/365.25
```

Load the relevant packages:

```{r, warning = FALSE, message=FALSE}
#| code-fold: show

library(tidyverse) #Data manipulations and plots
library(survival) #Core survival analysis routines
library(ggplot2)
theme_set(theme_bw())
```

#### 1.

*Estimate non-parametrically the cumulative hazards of death for subjects with or without ESVEA*.

The cumulative hazard can be estimated non-parametrically using the Nelson-Aalen estimator. It is implemented in the **survfit** function from the survival package. The formula argument must have a **Surv** object on the left side of '\~'. Since the event of interest is death the time variable of the **Surv** object is **timedeath** and the status indicator is **death**. The covariate(s), **esvea** in this analysis, should be on the right side of the '\~'. The cumulative hazard is then stored as the object cumhaz, and can be plotted against time.

```{r}
#| code-fold: show
# Estimating the cumulative hazards for subjects with or without ESVEA non-parametrically.
naafit211 <- survfit(formula = Surv(timedeath, death) ~ esvea, data = chs_data)

naadata211 <- data.frame(time = naafit211$time,
                         cumhaz = naafit211$cumhaz, 
                         esvea = c(rep(names(naafit211$strata)[1], naafit211$strata[1]),
                                   rep(names(naafit211$strata)[2], naafit211$strata[2])))

(fig211 <- ggplot(data = naadata211) + geom_step(aes(x = time, y = cumhaz, linetype = esvea), linewidth = 1) + 
    scale_linetype_discrete("ESVEA", labels = c("0", "1")) + 
    xlab("Time since randomization (years)") + 
    ylab("Cumulative hazard"))
```

#### 2.

*Make a non-parametric test for comparison of the two*.

The Nelson-Aalen estimate of the cumulative hazards for subjects with or without ESVEA can be compared with a logrank test which is implemented as the function **survdiff** from the survival package.

```{r}
#| code-fold: show
# Logrank test
survdiff(formula = Surv(timedeath, death) ~ esvea, data = chs_data)
```

We get a chi-square statistic of 17.7 on 1 degree of freedom and a corresponding p-value of $3 \cdot 10^{-5}$.

#### 3.

*Make a similar analysis based on a model where the hazard is assumed constant within 5-year intervals*.

To estimate the cumulative hazard under the assumption that the hazard is constant within 5-year intervals we must first split each record into sub-records with cut times at 5 and 10 years. This can be done using the **survSplit** function from the survival package. Duration of each sub-record is then stored as the column **duration**.

```{r}
#| code-fold: show

#Splitting each record into subrecords
data_pch <- survSplit(formula = Surv(timedeath, death) ~ esvea, 
          data = chs_data, 
          cut = c(5,10), #Cut points
          episode = "interval")
#Adding column with name interval
data_pch$duration <- data_pch$timedeath - data_pch$tstart #Duration of each subrecord
```

We can then estimate the hazard within each of the intervals $[0,5), [5,10), [10,15.19)$ using an occurrence/exposure rate.

For subjects without ESVEA we get the following estimates:

```{r}
#| code-fold: show
int1esvea0 <- subset(data_pch, interval == 1 & esvea == 0) #All subrecords in the interval [0,5) with ESVEA = 0
int2esvea0 <- subset(data_pch, interval == 2 & esvea == 0) #All subrecords in the interval [5,10) with ESVEA = 0
int3esvea0 <- subset(data_pch, interval == 3 & esvea == 0) #All subrecords in the interval [10,15.19) with ESVEA = 0

haz1esvea0 <- sum(int1esvea0$death)/sum(int1esvea0$duration) #Hazard estimate for the interval [0,5)
haz2esvea0 <- sum(int2esvea0$death)/sum(int2esvea0$duration) #Hazard estimate for the interval [5,10) 
haz3esvea0 <- sum(int3esvea0$death)/sum(int3esvea0$duration) #Hazard estimate for the interval [10,15.19)

#Table with hazard estimates for subjects without ESVEA
cbind(c("0-5 years","5-10 years","10+ years"), c(haz1esvea0,haz2esvea0,haz3esvea0))
```

And for the group with ESVEA we get

```{r}
#| code-fold: show
int1esvea1 <- subset(data_pch, interval == 1 & esvea == 1) #All subrecords in the interval [0,5) with ESVEA = 1
int2esvea1 <- subset(data_pch, interval ==2 & esvea == 1) #All subrecords in the interval [5,10) with ESVEA = 1
int3esvea1 <- subset(data_pch, interval ==3 & esvea == 1) #All subrecords in the interval [10,15,19) with ESVEA = 1

haz1esvea1 <- sum(int1esvea1$death)/sum(int1esvea1$duration) #Hazard estimate for the interval [0,5)
haz2esvea1 <- sum(int2esvea1$death)/sum(int2esvea1) #Hazard estimate for the interval [5,10)
haz3esvea1 <- sum(int3esvea1$death)/sum(int3esvea1$duration) #Hazard estimate for the interval [10,15)

#Table with estimates for subjects with ESVEA
cbind(c("0-5 years","5-10 years","10+ years"), c(haz1esvea1,haz2esvea1,haz3esvea1))
```

Alternatively, all estimates can be obtained at once through a Poisson regression using the **glm** function with **death** as the dependent variable, the categorical variable of the different combinations of interval and ESVEA status, **int_esvea**, as the covariate and the logarithm of **duration** as an offset. Furthermore, we must include '-1' as a 'covariate to' avoid estimating an intercept.

We get the hazards by taking the exponential of the coefficients estimated from this Poisson model.

```{r}
#| code-fold: show
# Adding a categorical covariate indicating the interval and ESVEA status for each subrecord
data_pch$int_esvea <- data_pch$interval + (data_pch$esvea*3)

#Poisson regression 
poisson213 <- glm(death ~ factor(int_esvea) - 1 + offset(log(duration)), family = poisson(), data = data_pch)
poisson_est <- as.numeric(exp(coefficients(poisson213)))

#Table with estimates
cbind(c("0-5 years, ESVEA = 0","5-10 years, ESVEA = 0","10+ years, ESVEA = 0", "0-5 years, ESVEA = 1","5-10 years, ESVEA = 1","10+ years, ESVEA = 1"), poisson_est)
```

The cumulative hazards for subjects with or without ESVEA under the piece-wise constant hazard assumption can be compared using a likelihood ratio test (LRT). This is done by fitting a model under the null hypothesis (i.e only considering the intervals $[0,5), [5,10)$ and $[10,15.19)$ but not whether subjects have ESVEA or not) and then comparing the two models using **anova** with the argument 'test = "LRT"'.

```{r}
#| code-fold: show
#Null model
poisson_null213 <- glm(death ~ factor(interval) - 1 + offset(log(duration)), family = poisson(), data = data_pch)

#Likelihood ratio test (LRT)
anova(poisson_null213,poisson213, test = "LRT")
```

We get a chi-squared statistic of 16.22 with 3 degrees of freedom and a corresponding p-value of 0.001.

The piece-wise constant cumulative hazards are plotted together with the Nelson-Aalen cumulative hazards below

```{r}
#| code-fold: show

#Data frame with time and cumulative hazard under poisson assumption for subjects without ESVEA
poisson_esvea0 <- as.data.frame(
  cbind(time = c(0,5,10,15.19), 
        cumhaz = c(0,5*poisson_est[1], 5*poisson_est[1] + 5*poisson_est[2], 5*poisson_est[1] + 5*poisson_est[2] + 5.19*poisson_est[3])))

#Data frame with time and cumulative hazard under poisson assumption for subjects with ESVEA
poisson_esvea1 <- as.data.frame(
  cbind(time = c(0,5,10,15.19), 
        cumhaz = c(0,5*poisson_est[4], 5*poisson_est[4] + 5*poisson_est[5], 5*poisson_est[4] + 5*poisson_est[5] + 5.19*poisson_est[6])))

#Plot of Nelson-Aalen together with Poisson cumulative hazard
fig211 + geom_line(data = poisson_esvea0, aes(x = time, y = cumhaz), linewidth = 1) + 
         geom_line(data = poisson_esvea1, aes(x = time, y = cumhaz), linewidth = 1, linetype = "dotted") 
#  geom_line(data =poisson_esvea1, aes(x = x, y = y), color ="#00BFC4", linewidth = 0.8)
```

## SAS
```{sas}
#| eval: false 
#| output: false
#| code-fold: show

* We first load the data;

proc import out = chs_data
    datafile = 'C:/HRfinal/holter/cphholter.csv'
	dbms= csv replace;
	getnames=yes;
run;

* We will convert the time variables ('timeafib', 'timestroke', and 'timedeath') from days to years;

data chs_data;
	set chs_data;
	timeafib = timeafib/365.25;
	timestroke = timestroke/365.25;
	timedeath = timedeath/365.25;
run;

*----------------------------------------------------------------------------------------------------------------------------------;
*---------------------------------------- EXERCISE 2.1 ----------------------------------------------------------------------------;
*----------------------------------------------------------------------------------------------------------------------------------;

*------------------------------------------- 2.1.1 --------------------------------------------------------------------------------;

* We will estimate the cumulative hazards of death for subjects with or without ESVEA non-parametrically with the Nelson-Aalen 
  estimator. This can be done with the 'phreg' procedure. Since the event of interest is death the time variable used in the model 
  statement is 'timedeath' and the censoring variable is 'death'. Furthermore, 'esvea' is specified in the strata statement to 
  obtain different estimates of the hazards for subjects with or without ESVEA. The cumulative hazard are the stored in the
  'hazdata' file created with the baseline statement;

proc phreg data=chs_data noprint; 
	model timedeath*death(0)=;
	strata esvea;
	baseline out=hazdata cumhaz=naa;
run;

* The estimates are then plotted using the gplot procedure;

title "2.1.1: Nelson-Aalen estimates for subjects with or without ESVEA";
proc gplot data=hazdata;
	plot naa*timedeath=esvea /haxis=axis1 vaxis=axis2;
	axis1 order=0 to 15.19 by 1 label=('Time (Years)');
	axis2 order=0 to 1 by 0.2 label=(a=90 'Cumulative hazard');
	symbol1 i=stepjl c=red;
	symbol2 i=stepjl c=blue;
run;

*------------------------------------------- 2.1.2 --------------------------------------------------------------------------------;

* The hazards can be compared with a log rank test which is implemented in the lifetest procedure. The relevant time variable 
  'timedeath' and censoring variable 'death' are specified in the time statement and 'esvea' is used in the strata statement.;

title "2.1.2: Log rank test comparing the hazards for the subjects with or without ESVEA";
proc lifetest data=chs_data notable plots=none; 
	time timedeath*death(0);
	strata esvea;
run; 

* We get a Chi-square statistic of 17.66 on 1 degree of freedom with a corresponding p-value <0.0001;

*------------------------------------------- 2.1.3 --------------------------------------------------------------------------------;

* To estimate the cumulative hazard under the assumption that the hazard is constant within 5-year intervals we must first split 
  each record into subrecords with cut times at 5 and 10 years. We will create a new data set 'chs_pch213' where 'cens' indicates if the
  subject died during each 5-year interval, 'risktime' is the time at risk during each 5-year interval, logrisk is the logarithm of
  the risk time and 'interval' is a categorical variable with 6 levels corresponding to the different combinations of interval and 
  ESVEA status;
  
data chs_pch213; 
	set chs_data;
	cens=(timedeath<=5)*(death = 1);
	risktime=min(5,timedeath);
	logrisk = log(risktime);
	interval=1;
	if esvea = 1 then do; interval =4; end; output;
	if timedeath>5 then do;
	cens=(timedeath<=10)*(death = 1);
	risktime=min(5,timedeath-5);
	logrisk = log(risktime);
	interval=2;
	if esvea = 1 then do; interval = 5; end; output; end;
	if timedeath>10 then do;
	cens= (death = 1); 
	risktime=timedeath-10;
	logrisk = log(risktime);
	interval=3;
	if esvea = 1 then do; interval = 6; end; output; end;
run;


* We can then estimate the hazard within each of the intervals [0,5), [5,10), [10,15.19). 
  This can be done with the sql procedure;

title "2.1.3: Estimate of the hazards for subjects with or without ESVEA under the piece-wise constant hazards assumption";
proc sql;
    select interval,
    sum(cens) as sum_death, 
    sum(risktime) as sum_risktime,
    calculated sum_death / calculated sum_risktime as hazard
    from chs_pch213
    group by interval;
quit;

* Alternatively, all estimates can be obtained at once through a Poisson regression using the genmod procedure. Since 'interval' is 
  a categorical variable it must be included in the class statement. 'cens' is included in the model statement as the dependent
  variable whilst interval is included as the only explanatory variable. Furthermore the probability distribution is specified through 
  'dist = poi' and the logarithm of the offset is included as well as the argument 'noint' which is added to obtain a model without an 
  intercept. The estimates for the hazard for each of interval and status of ESVEA are then given using the estimate statement. These 
  estimates corresponds to the exponential of the estimates from the table of the maximum likelihood parameter estimation;

proc genmod data=chs_pch213;
	class interval;
	model cens=interval / dist=poi offset=logrisk noint;
	estimate '0-5 years, ESVEA = 0' interval 1 0 0 0 0 0;
	estimate '5-10 years, ESVEA = 0' interval 0 1 0 0 0 0;
	estimate '10+ years, ESVEA = 0' interval 0 0 1 0 0 0;
	estimate '0-5 years, ESVEA = 1' interval 0 0 0 1 0 0;
	estimate '5-10 years, ESVEA = 1' interval 0 0 0 0 1 0;
	estimate '10+ years, ESVEA = 1' interval 0 0 0 0 0 1;
run;

* To investigate if the hazards differs between the two groups we must fit a Poisson model where we do not stratify by ESVEA 
  and then compare the two Poisson models using a likelihood ratio test (LRT). Thus, we repeat the procedure and first create
  a new data set 'chs_pch_null213' where no distinction is made between subjects with or without ESVEA;

data chs_pch_null213;
  set chs_pch213;
  if interval in (4,5,6) then interval = interval - 3;
run;

* Then, the Poisson model is fitted;

title "2.1.3: Estimate of the hazard under the piece-wise constant hazards assumption with no distinction between subjects with or 
       without ESVEA";
proc genmod data=chs_pch_null213;
	class interval;
	model cens=interval/dist=poi offset=logrisk noint;
	estimate '0-5 years' interval 1 0 0;
	estimate '5-10 years' interval 0 1 0;
	estimate '10+ years' interval 0 0 1;
run;

* Lastly, the two models are compared with a likelihood ratio test. This is done by comparing the max log likelihoods for the two models 
  and then calculating the p-value using the Chi-square distribution with 3 degrees of freedom. The likelihood scores are found in the 'Criteria For
  Accessing Goodness Of Fit' table;
  
title "2.1.3: Likelihood ratio test comparing the two piece-wise constant hazards models";
data p;
	chi2=1444.6862-1428.4662;
	p=1-probchi(chi2,3);
proc print;
run;

* We get a Chi-square statistics of 16.22 on 3 degrees of freedom with a corresponding p-value of 0.001
  We conclude once more that the hazards seem different for the subjects with or without ESVEA also under this model.; 
```

::: 

### Exercise 2.2

*Consider the data from the Copenhagen Holter study*.

#### 1.

*Make a version of the data set enabling an analysis of the composite endpoint of stroke or death without stroke ('stroke-free survival', i.e. define the relevant Time and Status variables), see Section 1.2.4*.

To estimate the cumulative hazards for the composite end-point of stroke or death we must first create a suitable time variable, **timestrokeordeath** and status indicator, **strokeordeath**.

```{r}
#| code-fold: show

chs_data$timestrokeordeath <- ifelse(chs_data$stroke == 1, chs_data$timestroke, chs_data$timedeath) 
chs_data$strokeordeath <- ifelse(chs_data$stroke == 1, 1, chs_data$death) 
```

#### 2.

*Estimate non-parametrically the cumulative hazards of stroke-free survival for subjects with or without ESVEA*.

We repeat the procedure from exercise 2.1.1 to obtain the Nelson-Aalen estimate of the cumulative hazards.

```{r}
#| code-fold: show

# Estimating the cumulative hazards for subjects with or without ESVEA non-parametrically
naafit222 <- survfit(formula = Surv(timestrokeordeath, strokeordeath) ~ esvea, data = chs_data)

naadata222 <- data.frame(time = naafit222$time,
                        cumhaz = naafit222$cumhaz, 
                        esvea = c(rep(names(naafit222$strata)[1], naafit222$strata[1]),
                               rep(names(naafit222$strata)[2], naafit222$strata[2])))


(fig222 <- ggplot(data = naadata222) + geom_step(aes(x = time, y = cumhaz, linetype = esvea), linewidth = 1) + 
          scale_linetype_discrete("ESVEA", labels = c("0", "1")) + 
          xlab("Time since randomization (years)") + 
          ylab("Cumulative hazard"))
```

#### 3.

*Make a non-parametric test for comparison of the two*.

The hazards are compared using a logrank test

```{r}
#| code-fold: show
# Logrank test
survdiff(Surv(timestrokeordeath, strokeordeath) ~ esvea, data = chs_data)
```

We get a chi-squared statistic of 18.6 on 1 degree of freedom and a corresponding p-value of $2 \cdot 10^{-5}$.

#### 4.

*Make a similar analysis based on a model where the hazard is assumed constant within 5-year intervals*.

We fit a Poisson model where the hazards are assumed constant within (approximate) 5-year intervals.

```{r}
#| code-fold: show
#Splitting records in 5-year intervals
data_pch <- survSplit(Surv(timestrokeordeath, strokeordeath) ~ esvea, 
          data = chs_data, 
          cut = c(5,10), 
          episode = "interval")
data_pch$duration <- data_pch$timestrokeordeath - data_pch$tstart
data_pch$int_esvea <- data_pch$interval + (data_pch$esvea*3)

#Poisson regression
poisson224 <- glm(strokeordeath ~ factor(int_esvea) - 1 + offset(log(duration)), family = poisson(), data = data_pch)
poisson_est <- as.numeric(exp(coefficients(poisson224)))

#Table with estimate of the coefficients
cbind(c("0-5 years, ESVEA = 0","5-10 years, ESVEA = 0","10+ years, ESVEA = 0", "0-5 years, ESVEA = 1","5-10 years, ESVEA = 1","10+ years, ESVEA = 1"), poisson_est)
```

The hazards are then compared using a likelihood ratio test

```{r}
#| code-fold: show

#Null model
poisson_null224 <-  glm(strokeordeath ~ factor(interval) - 1 + offset(log(duration)), family = poisson(), data = data_pch)

#LRT
anova(poisson_null224, poisson224, test = "LRT")
```

We get a chi-squared statistic of 23.72 on 3 degrees of freedom and a corresponding p-value of $2.86 \cdot 10^{-5}$.

The Poisson model is plotted together with the Nelson-Aalen estimates below

```{r}
#| code-fold: show

#Data frame with time and cumulative hazard under poisson assumption for subjects without ESVEA
poisson_esvea0 <- as.data.frame(
  cbind(time = c(0,5,10,15.19), 
        cumhaz = c(0,5*poisson_est[1], 5*poisson_est[1] + 5*poisson_est[2], 5*poisson_est[1] + 5*poisson_est[2] + 5*poisson_est[3])))
#Data frame with time and cumulative hazard under poisson assumption for subjects with ESVEA
poisson_esvea1 <- as.data.frame(
  cbind(time = c(0,5,10,15.19), 
        cumhaz = c(0,5*poisson_est[4], 5*poisson_est[4] + 5*poisson_est[5], 5*poisson_est[4] + 5*poisson_est[5] + 5*poisson_est[6])))

#Plot of Nelson-Aalen together with Poisson cumulative hazard
fig222 + geom_line(data = poisson_esvea0, aes(x = time, y = cumhaz), linewidth = 1) + 
         geom_line(data = poisson_esvea1, aes(x = time, y = cumhaz), linewidth = 1, linetype = "dotted") 
```

### Exercise 2.3

*Consider the data from the Copenhagen Holter study and the composite end-point stroke-free survival*.

#### 1.

*Fit a Cox model and estimate the hazard ratio between subjects with or without ESVEA*.

The Cox proportional hazards model is implemented as *coxph* in the **survival** package. The formula argument consists of a Surv object to the left of '\~' and the covariates to the right. We include the argument **ties = "breslow"** to obtain the Breslow estimate of the cumulative hazard.

```{r}
#| code-fold: show

cox231 <- coxph(formula = Surv(timestrokeordeath, strokeordeath) ~ esvea, data = chs_data, ties = "breslow")
summary(cox231)
```

We get a hazard ratio of 1.875, i.e. the hazard is increased by a factor 1.875 for patients with ESVEA compared to those without. We get a Wald test of 4.241 with a corresponding p-value of $2.22\cdot 10^{-5}$.

#### 2.

*Fit a Poisson model where the hazard is assumed constant within 5-year intervals and estimate the hazard ratio between subjects with or without ESVEA*.

The piece-wise constant model is fitted using **glm** as described in exercise 2.1.3.

```{r}
#| code-fold: show
# Poisson regression
poisson232 <- glm(strokeordeath ~ factor(interval) - 1 + esvea + offset(log(duration)), family = poisson(), data = data_pch)
summary(poisson232)
```

We get a coefficient of 0.6209 for the ESVEA variable. This corresponds to a hazard ratio of $\exp(0.6209) = 1.8606$. The Wald test is 4.188 with a corresponding p-value of $2.82 \cdot 10^{-5}$.

#### 3.

*Compare the results from the two models*.

The hazard ratio between subjects with or without ESVEA found using the Cox model is 1.87 while it was 1.86 assuming the Poisson model. Thus, the estimates are nearly identical.

### Exercise 2.4

*Consider the data from the Copenhagen Holter study and the composite end-point stroke-free survival*.

#### 1.

*Fit a Cox model and estimate the hazard ratio between subjects with or without ESVEA, now also adjusting for sex, age, and systolic blood pressure (sysBP)*.

We fit the Cox model as described in exercise 2.3.1. This time we also include **sex**, **age** and **sbp** as covariates.

```{r}
#| code-fold: show
# Cox model 
cox241 <- coxph(formula = Surv(timestrokeordeath, strokeordeath) ~ esvea + sex + age + sbp , ties = "breslow", data = chs_data)
summary(cox241)
```

We get a hazard ratio of 1.375 for ESVEA. The Wald test is 2.086 with a corresponding p-value of 0.0370.

#### 2.

*Fit a Poisson model where the hazard is assumed constant within 5-year intervals and estimate the hazard ratio between subjects with or without ESVEA, now also adjusting for sex, age, and sysBP*.

To obtain estimates under the piece-wise constant hazard assumption we add **sex**, **age** and **sbp** on the right hand side of '\~' both in the **survSplit** and the **glm** functions.

```{r}
#| code-fold: show
#Splitting data in 5-year intervals
data_pch <- survSplit(Surv(timestrokeordeath, strokeordeath) ~ esvea + age + sex + sbp,  
          data = chs_data, 
          cut = c(5,10), 
          episode = "interval")
data_pch$duration <- data_pch$timestrokeordeath - data_pch$tstart

#Poisson regression
poisson242 <- glm(strokeordeath ~ factor(interval) - 1 + esvea + sex + age + sbp + offset(log(duration)), family = poisson(), data = data_pch)
summary(poisson242)
```

We get a coefficient of 0.3111 for ESVEA and a hazard ratio of $\exp(0.3111) = 1.3649$. The Wald test is 2.039 and the corresponding p-value is 0.0414.

#### 3.

*Compare the results from the two models*.

Again, the hazard ratios estimated using either the Cox model or the Poisson model are comparable with a factor 1.36-1.37 increase of the hazard for subjects with ESVEA. We notice that this is smaller than the hazard ratio estimated without adjusting for sex, age, and systolic blood pressure.

### Exercise 2.5

#### 1.

*Check the Cox model from the previous exercise by examining proportional hazards between subjects with or without ESVEA and between men and women*.

To check the assumption of proportional hazards for subjects with or without ESVEA under the Cox model we fit a stratified Cox model. This can be done by adding **strata(esvea)** instead of **esvea** as a covariate in the *coxph* function. The baseline hazard can then be extracted using the function *basehaz* from the **survival** package. The argument **centered = FALSE** is added. Otherwise, the predicted cumulative hazard at the mean values of the covariates is returned.

The hazards are plotted against each other. If the proportional hazards assumption holds then the curve should be close to a straight line through (0,0) with a slope equal to the estimated hazard ratio of ESVEA.

```{r}
#| code-fold: show
#Cox model with separate hazards for subjects with or without ESVEA
cox251_esvea <- coxph(Surv(timestrokeordeath, strokeordeath) ~ strata(esvea) + sex + age + sbp, ties = "breslow", data =chs_data)
summary(cox251_esvea)
```

```{r}
#| code-fold: show
#Cumulative hazard for subjects without ESVEA
esvea0_haz <- rbind(c(0,0),subset(basehaz(cox251_esvea, centered = FALSE), strata == "esvea=0")[,1:2])
colnames(esvea0_haz) <- c("haz0", "time")

#Cumulative hazard for subjects with ESVEA
esvea1_haz <- rbind(c(0,0),subset(basehaz(cox251_esvea, centered = FALSE), strata == "esvea=1")[,1:2])
colnames(esvea1_haz) <- c("haz1", "time")

#Data frame with time column and both hazards
ph_data <- merge(esvea0_haz, esvea1_haz, all = TRUE)
ph_data <- ph_data %>% fill(haz0,haz1)

#Plotting the hazards against each other
ggplot(data = ph_data) + geom_step(aes(haz0, haz1)) + geom_abline(slope = 1.374825) + xlab("Cumulative hazard for subjects with ESVEA = 0") + ylab("Cumulative hazard for subjects with ESVEA = 1")
```

The cumulative hazard deviates a bit from the straight line. This suggests that the assumption of proportional hazards for subjects with or without ESVEA may not be reasonable.

We repeat the procedure but this time examining the proportional hazards assumption of sex.

```{r}
#| code-fold: show
#Cox model with separate hazards for male and female subjects
cox251_sex <- coxph(Surv(timestrokeordeath, strokeordeath) ~ esvea + strata(sex) + age + sbp, ties = "breslow", data =chs_data)
summary(cox251_sex)
```

```{r}
#| code-fold: show
#Cumulative hazard for females
sex0_haz <- rbind(c(0,0),subset(basehaz(cox251_sex, centered = FALSE), strata == "sex=0")[,1:2])
colnames(sex0_haz) <- c("haz0", "time")

#Cumulative hazard for males
sex1_haz <- rbind(c(0,0),subset(basehaz(cox251_sex, centered = FALSE), strata == "sex=1")[,1:2])
colnames(sex1_haz) <- c("haz1", "time")

#Data frame with time column and both hazards
ph_data <- merge(sex0_haz, sex1_haz, all = TRUE)
ph_data <- ph_data %>% fill(haz0,haz1)

#Plotting the hazards against each other
ggplot(data = ph_data) + geom_step(aes(haz0, haz1)) + geom_abline(slope = 1.781584) + xlab("Cumulative hazard for subjects with sex = 0") + ylab("Cumulative hazard for subjects with sex = 1")
```

The curve coincides nicely with the straight line. Thus, the proportional hazard assumption seems reasonable for sex.

#### 2.

*Check for linearity on the log(hazard)-scale for age and sysBP*.

We can check the linearity assumptions on the log(hazards)-scale for age and systolic blood pressure by including non-linear effects.

The linearity assumption of systolic blood pressure can be investigated by including a linear spline. We select 135 as a knot since this value is typically the cut-point for medication for hypertension.

```{r}
#| code-fold: show
#Adding covariate (systolisk - 135)*I(systolisk > 135)
chs_data$hypertension <- (chs_data$sbp - 135)*(chs_data$sbp > 135)

#Cox model with non-linear effect of systolic blood pleasure (linear spline)
cox252_sbp <- coxph(Surv(timestrokeordeath, strokeordeath) ~ esvea + sex + age + sbp + hypertension, ties = "breslow", data = chs_data)
summary(cox252_sbp)
```

We compare this non-linear model with the linear model from exercise 2.4.1 using a likelihood ratio test.

```{r}
#| code-fold: show
#LRT
anova(cox241,cox252_sbp, test = "LRT")
```

We get a chi-squared statistic of 0.6254 on 1 degree of freedom with a corresponding p-value of 0.429 when comparing the two Cox models. Including a linear spline to our model does not seem to describe data better than the model from exercise 2.4.1.

We will test the linearity assumption of age by adding a quadratic term to the Cox model.

```{r}
#| code-fold: show
#Cox model with non-linear assumption of age (quadratic term)
cox252_age <- coxph(Surv(timestrokeordeath, strokeordeath) ~ esvea + sex + age + I(age^2) + sbp, ties = "breslow", data =chs_data)
summary(cox252_age)
```

Then we compare this model to the Cox model from 2.4.1 using a likelihood ratio test.

```{r}
#| code-fold: show
#LRT
anova(cox241, cox252_age, test ="LRT")
```

We get a chi-squared statistic of 0.323 on 1 degrees of freedom and a corresponding p-value of 0.8574 when comparing the Cox models. Thus, we do not find evidence against the linearity assumption of age.

#### 3.

*Do the same for the Poisson model*.

To investigate the assumption of proportional hazards for subjects with or without ESVEA for the Poisson model we will include an interaction term between time and ESVEA. This model can then be compared with the model from exercise 2.4.1 using a likelihood ratio test.

```{r}
#| code-fold: show
#Poisson model with interaction term of time and esvea
poisson253_esvea <- glm(strokeordeath ~ factor(interval) - 1 + esvea + sex + esvea:factor(interval) + age + sbp + offset(log(duration)), family = poisson(), data = data_pch)
summary(poisson253_esvea)
```

```{r}
#| code-fold: show
#LRT
anova(poisson242, poisson253_esvea, test = "LRT")
```

We get a chi-squared statistic of 6.5411 on 2 degrees of freedom and a corresponding p-value of 0.03798. This suggests that the proportional hazard assumption is questionable for ESVEA.

We will now repeat the procedure to investigate the proportional hazards assumption for sex for the Poisson model.

```{r}
#| code-fold: show
#Poisson model with interaction term of time and sex
poisson253_sex <- glm(strokeordeath ~ factor(interval) -1 + esvea + sex + sex:factor(interval) + age + sbp + offset(log(duration)), family = poisson(), data = data_pch)
summary(poisson253_sex)
```

```{r}
#| code-fold: show
#LRT
anova(poisson242, poisson253_sex, test = "LRT")
```

We get a chi-squared statistic of 0.9083 with a corresponding p-value of 0.635. We conclude that we do not have evidence against the proportional hazards assumption for sex.

We will also check the linearity assumption of sbp by inclusion the indicator of hypertension in the Poisson model

```{r}
#| code-fold: show
#Splitting data in 5-year intervals
data_pch <- survSplit(Surv(timestrokeordeath, strokeordeath) ~ esvea + age + sex + sbp + hypertension,  
          data = chs_data, 
          cut = c(5,10), 
          episode = "interval")
data_pch$duration <- data_pch$timestrokeordeath - data_pch$tstart

#Poisson model with non-linear effect of systolic blood pleasure (linear spline)
poisson253_sbp <- glm(strokeordeath ~ factor(interval) - 1 + esvea + sex + age + sbp + hypertension + offset(log(duration)), family = poisson(), data = data_pch)
summary(poisson253_sbp)
```

```{r}
#| code-fold: show
#LRT
anova(poisson242, poisson253_sbp ,test = "LRT")
```

We get a chi-squared statistic of 0.613 on 1 degree of freedom with a corresponding p-value of 0.4337 when comparing the Poisson models.

We will test the linearity assumption of age by adding a quadratic term to the Poisson model.

```{r}
#| code-fold: show
#Poisson model with non-linear assumption of age (quadratic term)
poisson253_age <- glm(strokeordeath ~ factor(interval) - 1 + esvea + sex + age + I(age^2) + sbp + offset(log(duration)), family = poisson(), data = data_pch)
summary(poisson253_age)
```

```{r}
#| code-fold: show
#LRT
anova(poisson242, poisson253_age,test = "LRT")
```

We get a chi-squared statistic of 0.03816 on 1 degree of freedom and a corresponding p-value of 0.8451 when comparing the Poisson models. Thus, there is not evidence against the linearity assumption of age.

### Exercise 2.6

*Consider the data from the Copenhagen Holter study and focus now on the mortality rate after stroke*.

#### 1.

*Estimate non-parametrically the cumulative hazards for subjects with or without ESVEA using the time variable 'time since recruitment'*.

We first make a subset the data which only includes subjects experiencing a stroke during the study. Furthermore, we will add 0.5 day to the time of death for observations where time of stroke and time of death are the same.

```{r}
#| code-fold: show
#Subset of data. Only subjects with strokes during the period of the study
stroke_data <- subset(chs_data, stroke == 1)

#Adding 0.5 day to timedeath for subjects with ties
stroke_data$timedeath <- ifelse(stroke_data$timestroke == stroke_data$timedeath, stroke_data$timedeath + 0.5/365.25, stroke_data$timedeath)
```

Once again we use the **survfit** function from the survival package to obtain the Nelson-Aalen estimates. Since the time variable is time since recruitment we need to take delayed entry into account. Thus, both the entry time and exit time of the stroke state, **timestroke** and **timedeath**, are included in the **Surv** object.

```{r}
#| code-fold: show
naafit261 <- survfit(formula = Surv(timestroke, timedeath, death) ~ esvea, data = stroke_data)

naadata261 <- data.frame(time = naafit261$time,
                        cumhaz = naafit261$cumhaz, 
                        esvea = c(rep(names(naafit261$strata)[1], naafit261$strata[1]),
                               rep(names(naafit261$strata)[2], naafit261$strata[2])))

(fig261 <- ggplot(aes(x = time, y = cumhaz, linetype = esvea), data = naadata261) + 
          geom_step(size = 1) + 
          scale_linetype_discrete("ESVEA", labels = c("0", "1")) + 
          xlab("Time since randomization (years)") + 
          ylab("Cumulative hazard"))
```

#### 2.

*Assume proportional hazards and estimate the hazard ratio between subjects with or without ESVEA*.

Similarly, we fit the Cox model where both time of entry and exit are included in the **Surv** object.

```{r}
#| code-fold: show
#Cox model with time since recruitment as baseline
cox262 <- coxph(Surv(timestroke, timedeath, death) ~ esvea, ties = "breslow", data =stroke_data)
summary(cox262)
```

We get a hazard ratio of 1.300 for ESVEA with a Wald test of 0.853 and a corresponding p-value of 0.393. This suggests that having ESVEA does not significantly increase the rate of death after stroke when the time variable is time since recruitment.

#### 3.

*Repeat these two questions using now the time variable 'time since stroke' and compare the results*.

In the model where the time variable is time since stroke, a new variable **timesincestroke** is added to the data set and used as time variable in the **Surv** object in the formula for the Cox model.

```{r}
#| code-fold: show
#Adding time since stroke as new column to the data set
stroke_data$timesincestroke <- stroke_data$timedeath - stroke_data$timestroke
```

The cumulative hazards are then estimated non-parametrically using **survfit**.

```{r}
#| code-fold: show
naafit263 <- survfit(formula = Surv(timesincestroke, death) ~ esvea, data = stroke_data)

naadata263 <- data.frame(time = naafit263$time,
                        cumhaz = naafit263$cumhaz, 
                        esvea = c(rep(names(naafit263$strata)[1], naafit263$strata[1]),
                               rep(names(naafit263$strata)[2], naafit263$strata[2])))

(fig263 <- ggplot(aes(x = time, y = cumhaz, linetype = esvea), data = naadata263) + 
          geom_step(size = 1) + 
          scale_linetype_discrete("ESVEA", labels = c("0", "1")) + 
          xlab("Time since stroke (years)") + 
          ylab("Cumulative hazard"))
```

The hazard ratio is estimated assuming proportional hazards using the Cox model

```{r}
#| code-fold: show
cox263 <- coxph(Surv(timesincestroke, death) ~ esvea, ties = "breslow", data =stroke_data)
summary(cox263)
```

We get a hazard ratio of 1.1654 and a Wald test of 0.493 with a corresponding p-value of 0.622. This suggests that ESVEA does not change the hazard significantly when the time variable is time since stroke as well.

### Exercise 2.7

#### 1.

*Consider the data from the Copenhagen Holter study and fit Cox models for the cause-specific hazards for the outcomes stroke and death without stroke including ESVEA, sex, age, and sysBP*.

We fit a Cox model to the cause-specific hazard for the outcome stroke

```{r}
#| code-fold: show
cox27_stroke <- coxph(Surv(timestrokeordeath, stroke) ~ esvea + sex + age + sbp, ties = "breslow", data =chs_data)
summary(cox27_stroke)
```

We get a hazard ratio of 2.02 and a Wald test of 2.602 with a corresponding p-value of 0.009.

To fit a Cox model for the outcome death without stroke we must first add the variable death without stroke to our data set. Afterwards, the model can be fitted using **coxph**.

```{r}
#| code-fold: show
chs_data$death_wo_stroke <- ifelse(chs_data$stroke == 1, 0, chs_data$death)

cox27_death <- coxph(Surv(timestrokeordeath, death_wo_stroke) ~ esvea + sex + age + sbp, ties = "breslow", data =chs_data)
summary(cox27_death)
```

We get a hazard ratio of 1.17 and a Wald test of 0.857 with a corresponding p-value of 0.391.

#### 2.

*Compare with the results from Exercise 4 in Chapter 2 (first question)*.

It is seen that (male) sex and age are both significantly associated with increased cause-specific hazards whereas ESVEA and SysBP are only associated with the rate of stroke. The coefficients for the composite end-point are between those for the cause-specific hazards.

Please note that the Cox model for the composite end-point and those for the separate cause-specific hazards are mathematically incompatible.

### Exercise 2.8

*Consider the data on repeated episodes in affective disorder, Example 1.1.5*.

The data should be loaded as **affective_data**

```{r data, include = FALSE}
affective_data <- read.csv("data/affective.csv")
```

Load the relevant packages:

```{r packages, warning = FALSE, message=FALSE}
library(tidyverse) #Data manipulations and plots
library(survival) #Core survival analysis routines
library(mets)
library(ggplot2)
theme_set(theme_bw())
```

#### 1.

*Estimate non-parametrically the cumulative event intensities for unipolar and bipolar patients*.

We estimate the cumulative event intensities non-parametrically using the **survfit** function from the *survival* package. We must include the **id = id** argument since we have multiple lines from the same subject. Furthermore, we include **start** in the **surv** object of the formula argument to account for delayed entry and restrict attention to records with state=0 (out of hospital).

```{r}
#| code-fold: show
# Estimating the cumulative event intensities for unipolar and bipolar patients non-parametrically
naafit281 <- survfit(Surv(start, stop, status == 1) ~ bip,
                 data = subset(affective_data, state==0), id = id)
```

We then plot the result

```{r}
#| code-fold: show
# Collecting data in data frame
naadata281 <- data.frame(cumhaz = naafit281$cumhaz,
                        time = naafit281$time,
                        disorder = c(rep("Unipolar", naafit281$strata[[1]]),
                                  rep("Bipolar", naafit281$strata[[2]])))

# Plotting the result
fig281 <- ggplot(data = naadata281) + geom_step(aes(x = time/12, y = cumhaz, linetype = disorder), size = 1) +
  ylab("Cumulative event intensity") +
  xlab("Time since first admission (years)") +
  theme_bw() 
fig281
```

The cumulative event intensity is at all times higher for bipolar patients compared to unipolar patients.

#### 2.

*Fit an AG-type model and estimate, thereby, the ratio between intensities for unipolar and bipolar patients, adjusting for year of diagnosis*.

We can fit a very simple version of a AG model (like the one described in Section 2.4.1) using the **coxph** function from the survival package. We take delayed entry into account in the **Surv** object of the formula argument and adjust for disease type (unipolar vs bipolar) and year of diagnosis. Furthermore, we restrict the data set to the rows where patients are out of hospital (state = 0).

```{r}
#| code-fold: show
# Fitting an AG-type model
agfit282 <- coxph(Surv(start, stop, status == 1) ~ bip + year, 
                        data = subset(affective_data, state == 0), 
                        method = "breslow")
summary(agfit282)
```

Thus, we estimate hazard ratio of $\exp(0.35) = 1.4291$ of admission to hospital for being diagnosed with bipolar disorder compared to those diagnosed with unipolar disorder.

#### 3.

*Fit a PWP model and estimate, thereby, the ratio between intensities for unipolar and bipolar patients, adjusting for year of diagnosis*.

We can fit a PWP model using the **coxph** function by adding **strata(episode)** in the formula argument. We must still restrict the data to time periods where the patients are out of hospital (state = 0).

```{r}
#| code-fold: show
# Fitting a PWP model
pwpfit283 <- coxph(Surv(start, stop, status == 1) ~ strata(episode) + bip + year, 
                   data = subset(affective_data, state == 0), 
                   method = "breslow")
summary(pwpfit283)
```

We get an estimate of the hazard ratio of readmission for patients diagnosed with bipolar disorder of $\exp(0.2421) = 1.274$ compared to patients diagnosed with unipolar disorder.

#### 4.

*Compare the results from the two models*.

We get a smaller coefficient of *bip* with the PWP model than with the AG model. This is because, by taking the number of previous episodes into account (via stratification), some of the discrepancy between bipolar and unipolar patients disappears since the occurrence of repeated episodes is itself affected by the initial diagnosis.
